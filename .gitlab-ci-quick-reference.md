# GitLab CI/CD Quick Reference

## Pipeline Status

```
┌─────────┐   ┌──────────┐   ┌──────┐   ┌───────┐   ┌──────────────┐   ┌────────┐
│  Setup  │──▶│ Validate │──▶│ Test │──▶│ Build │──▶│ Quality Gate │──▶│ Deploy │
└─────────┘   └──────────┘   └──────┘   └───────┘   └──────────────┘   └────────┘
   ~3min          ~1min        ~2min      ~4min           ~1min            manual
```

## Key Jobs

| Job                          | Duration | Triggers         | Failure Impact    |
| ---------------------------- | -------- | ---------------- | ----------------- |
| `setup:dependencies`         | ~3min    | All branches/MRs | Blocks pipeline   |
| `validate:lint`              | ~30s     | All branches/MRs | Blocks pipeline   |
| `validate:typescript`        | ~45s     | All branches/MRs | Informational     |
| `test:unit`                  | ~2min    | All branches/MRs | Blocks pipeline   |
| `test:database`              | ~2min    | All branches/MRs | Informational     |
| `build:production`           | ~4min    | main/develop/MRs | Blocks pipeline   |
| `quality-gate:comprehensive` | ~1min    | main/master/MRs  | Blocks deployment |
| `deploy:staging`             | manual   | develop          | -                 |
| `deploy:production`          | manual   | main/master/tags | -                 |

## PostgreSQL 17 Configuration

```yaml
Database: whattoeatnext, alchm_kitchen
User: user
Password: password
Host: postgres (in CI)
Port: 5432
Version: PostgreSQL 17 Alpine
```

## Common Commands

### Validate Pipeline Locally

```bash
# Lint check
make lint-ci

# Type check
make check

# Run tests
make test

# Build
make build

# Quality gate
make ci-quality-gate
```

### Test Database Connection

```bash
/Library/PostgreSQL/17/bin/psql -h localhost -U user -d whattoeatnext
```

## Environment Variables

### Pre-configured (in .gitlab-ci.yml)

- `NODE_VERSION=20.18.0`
- `POSTGRES_VERSION=17`
- `DATABASE_URL=postgresql://user:password@postgres:5432/whattoeatnext`
- `NODE_ENV=test`
- `CI=true`
- `NODE_OPTIONS=--max-old-space-size=4096`

### Configure in GitLab (Optional)

- Deployment tokens
- External API keys
- Registry credentials

## Manual Deployment Triggers

### Staging (develop branch)

```
Pipeline → deploy:staging → Click "Play" button
```

### Production (main/master)

```
Pipeline → deploy:production → Click "Play" button
```

### Docker Registry

```
Pipeline → build:docker → Click "Play" button
Pipeline → deploy:docker → Click "Play" button
```

## Quality Gate Thresholds

| Metric               | Threshold    | Action on Failure |
| -------------------- | ------------ | ----------------- |
| TypeScript errors    | <100         | Block deployment  |
| Build artifacts      | Must exist   | Block deployment  |
| PostgreSQL 17        | Must connect | Block deployment  |
| Critical lint errors | 0            | Block deployment  |
| Test coverage        | Track only   | Informational     |

## Cache Locations

```
node_modules/      - Dependencies
.yarn-cache/       - Yarn cache
.next/cache/       - Next.js cache
.eslintcache       - ESLint cache
```

## Troubleshooting Quick Fixes

### Clear GitLab CI Cache

```
GitLab → CI/CD → Pipelines → Click [Clear Runner Caches]
```

### Retry Failed Job

```
Click job → Click [Retry]
```

### View Logs

```
Click job → View full logs
```

### Database Connection Issues

```yaml
# Add to script for debugging
- apt-get update && apt-get install -y postgresql-client
- psql --version
- pg_isready -h postgres -p 5432 -U user
```

## Artifacts

### Retention Periods

- Build artifacts (.next/): 7 days
- Test coverage: 7 days
- ESLint reports: Job duration
- Nightly validation: 30 days

### Download Artifacts

```
Pipeline → Job → Browse → Download
```

## Scheduled Jobs

### Nightly Validation

**Schedule**: 2:00 AM daily (recommended)
**Configure**: CI/CD → Schedules → New schedule

```
Description: Nightly Full Validation
Interval pattern: 0 2 * * *
Target branch: main
Variables: (inherit from .gitlab-ci.yml)
```

## Status Badges

### Add to README.md

```markdown
[![Pipeline Status](https://gitlab.com/<namespace>/<project>/badges/<branch>/pipeline.svg)](https://gitlab.com/<namespace>/<project>/-/pipelines)

[![Coverage](https://gitlab.com/<namespace>/<project>/badges/<branch>/coverage.svg)](https://gitlab.com/<namespace>/<project>/-/pipelines)
```

## Integration Checklist

- [ ] `.gitlab-ci.yml` pushed to repository
- [ ] GitLab Runner available (or shared runners enabled)
- [ ] CI/CD variables configured (if needed)
- [ ] Branch protection rules set
- [ ] Merge request pipelines enabled
- [ ] Deployment targets configured
- [ ] Scheduled pipelines configured
- [ ] Team notifications set up

## Performance Tips

1. **Use cache effectively** - Already configured
2. **Limit test workers** - Already set to 2
3. **Skip library checks** - Already using `--skipLibCheck`
4. **Use fast lint config** - Already using `lint:ci`
5. **Parallel jobs** - Already parallelized

## PostgreSQL 17 Features Used

- ✅ Alpine image (smaller, faster)
- ✅ Automatic database creation
- ✅ Ready-check waiting
- ✅ Trust authentication (CI only)
- ✅ Multiple database support

## Success Metrics

Track in GitLab Analytics:

- Pipeline success rate: Target >95%
- Average duration: Target <10min
- Cache hit rate: Target >80%
- Deployment frequency: Track trends

---

**Quick Links**:

- Full docs: `GITLAB_CI_SETUP.md`
- PostgreSQL setup: `POSTGRESQL_17_SETUP.md`
- Project Makefile: `make help`
