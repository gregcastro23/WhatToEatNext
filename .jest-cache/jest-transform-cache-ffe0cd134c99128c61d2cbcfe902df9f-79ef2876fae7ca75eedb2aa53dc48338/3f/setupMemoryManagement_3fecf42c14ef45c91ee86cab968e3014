1e741fd69439fa74f2b734eda04f8a44
"use strict";
/**
 * Memory Management Setup for Jest Tests
 *
 * This file configures memory management, garbage collection hints,
 * and cleanup procedures for the test environment.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.MEMORY_CONFIG = exports.performEmergencyCleanup = exports.TestMemoryMonitor = void 0;
const TestMemoryMonitor_1 = require("./utils/TestMemoryMonitor");
Object.defineProperty(exports, "TestMemoryMonitor", { enumerable: true, get: function () { return TestMemoryMonitor_1.TestMemoryMonitor; } });
// Global memory monitor instance
let globalMemoryMonitor = null;
// Memory management configuration
const MEMORY_CONFIG = {
    // Enable garbage collection hints
    enableGC: true,
    // Memory check frequency (every N tests)
    checkFrequency: 5,
    // Force cleanup after memory-intensive tests
    forceCleanupThreshold: 100,
    // Global memory limit before emergency cleanup
    emergencyCleanupThreshold: 500, // MB
};
exports.MEMORY_CONFIG = MEMORY_CONFIG;
// Test counter for periodic memory checks
let testCounter = 0;
/**
 * Initialize global memory monitoring
 */
function initializeMemoryMonitoring() {
    // Create memory monitor with CI-appropriate settings
    globalMemoryMonitor = process.env.CI
        ? TestMemoryMonitor_1.TestMemoryMonitor.createForCI()
        : TestMemoryMonitor_1.TestMemoryMonitor.createDefault();
    // Set up global test cache if not exists
    if (!global.__TEST_CACHE__) {
        global.__TEST_CACHE__ = new Map();
    }
    // Set up global test references array
    if (!global.__TEST_REFS__) {
        global.__TEST_REFS__ = [];
    }
    console.log('Memory monitoring initialized');
}
/**
 * Perform periodic memory checks
 */
function performPeriodicMemoryCheck() {
    testCounter++;
    if (testCounter % MEMORY_CONFIG.checkFrequency === 0 && globalMemoryMonitor) {
        const memoryCheck = globalMemoryMonitor.checkMemoryUsage(`periodic-check-${testCounter}`);
        if (!memoryCheck.isWithinLimits) {
            console.warn(`Memory check failed at test ${testCounter}:`, memoryCheck.errors);
            // Force cleanup if memory usage is too high
            const currentMemoryMB = memoryCheck.currentUsage.heapUsed / (1024 * 1024);
            if (currentMemoryMB > MEMORY_CONFIG.emergencyCleanupThreshold) {
                console.warn('Emergency memory cleanup triggered');
                performEmergencyCleanup();
            }
        }
    }
}
/**
 * Emergency memory cleanup procedure
 */
function performEmergencyCleanup() {
    if (globalMemoryMonitor != null) {
        globalMemoryMonitor.cleanup('emergency-cleanup');
    }
    // Clear all global caches
    if (global.__TEST_CACHE__) {
        if (typeof global.__TEST_CACHE__.clear === 'function') {
            global.__TEST_CACHE__.clear();
        }
        else {
            global.__TEST_CACHE__ = new Map();
        }
    }
    // Clear test references
    if (global.__TEST_REFS__) {
        global.__TEST_REFS__.length = 0;
    }
    // Force garbage collection if available
    if (global.gc) {
        try {
            global.gc();
            console.log('Emergency garbage collection performed');
        }
        catch (error) {
            console.warn('Failed to perform emergency garbage collection:', error);
        }
    }
    // Reset Jest modules to free memory
    if (jest && jest.resetModules) {
        jest.resetModules();
    }
}
exports.performEmergencyCleanup = performEmergencyCleanup;
/**
 * Setup memory management hooks
 */
function setupMemoryHooks() {
    // Before each test suite
    beforeAll(() => {
        if (globalMemoryMonitor != null) {
            globalMemoryMonitor.takeSnapshot('suite-start');
        }
    });
    // Before each test
    beforeEach(() => {
        performPeriodicMemoryCheck();
        // Clear mocks and reset modules for memory efficiency
        jest.clearAllMocks();
        // Take memory snapshot for memory-intensive tests
        if (globalMemoryMonitor && expect.getState().currentTestName) {
            const testName = expect.getState().currentTestName;
            if (testName && (testName.toLowerCase().includes('memory') ||
                testName.toLowerCase().includes('performance') ||
                testName.toLowerCase().includes('integration'))) {
                globalMemoryMonitor.takeSnapshot(`before-${testName}`);
            }
        }
    });
    // After each test
    afterEach(() => {
        if (globalMemoryMonitor != null) {
            const testName = expect.getState().currentTestName || 'unknown-test';
            const memoryCheck = globalMemoryMonitor.checkMemoryUsage(`after-${testName}`);
            // Force cleanup for memory-intensive tests or if memory usage is high
            const currentMemoryMB = memoryCheck.currentUsage.heapUsed / (1024 * 1024);
            if (currentMemoryMB > MEMORY_CONFIG.forceCleanupThreshold ||
                testName.toLowerCase().includes('memory') ||
                testName.toLowerCase().includes('integration')) {
                globalMemoryMonitor.cleanup(testName);
            }
            // Log warnings if memory usage is concerning
            if (memoryCheck.warnings.length > 0) {
                console.warn(`Memory warnings for test "${testName}":`, memoryCheck.warnings);
            }
        }
        // Clear any test-specific global references
        if (global.__TEST_REFS__) {
            global.__TEST_REFS__.length = 0;
        }
    });
    // After each test suite
    afterAll(() => {
        if (globalMemoryMonitor != null) {
            globalMemoryMonitor.takeSnapshot('suite-end');
            // Generate memory report for the suite
            const summary = globalMemoryMonitor.getMemorySummary();
            if (summary.totalIncrease > 50) { // 50MB threshold for reporting
                console.log('Memory usage summary for test suite:', {
                    initialMemory: `${summary.initialMemory.toFixed(2)}MB`,
                    finalMemory: `${summary.currentMemory.toFixed(2)}MB`,
                    peakMemory: `${summary.peakMemory.toFixed(2)}MB`,
                    totalIncrease: `${summary.totalIncrease.toFixed(2)}MB`,
                    duration: `${(summary.testDuration / 1000).toFixed(2)}s`
                });
            }
            // Perform final cleanup
            globalMemoryMonitor.cleanup('suite-cleanup');
        }
    });
}
/**
 * Add garbage collection hints
 */
function addGarbageCollectionHints() {
    // Add global utility for manual garbage collection
    global.forceGC = () => {
        if (global.gc) {
            try {
                global.gc();
                return true;
            }
            catch (error) {
                console.warn('Failed to force garbage collection:', error);
                return false;
            }
        }
        return false;
    };
    // Add memory monitoring utilities to global scope
    global.getMemoryUsage = () => {
        const usage = process.memoryUsage();
        return {
            heapUsed: `${(usage.heapUsed / 1024 / 1024).toFixed(2)}MB`,
            heapTotal: `${(usage.heapTotal / 1024 / 1024).toFixed(2)}MB`,
            external: `${(usage.external / 1024 / 1024).toFixed(2)}MB`,
            arrayBuffers: `${(usage.arrayBuffers / 1024 / 1024).toFixed(2)}MB`
        };
    };
    // Add cleanup utility
    global.cleanupTestMemory = () => {
        if (globalMemoryMonitor != null) {
            return globalMemoryMonitor.cleanup('manual-cleanup');
        }
        return null;
    };
}
/**
 * Configure process-level memory management
 */
function configureProcessMemory() {
    // Set Node?.js memory limits if not already set
    if (!process.env.NODE_OPTIONS?.includes('--max-old-space-size')) {
        // Set reasonable memory limit for tests (2GB)
        process.env.NODE_OPTIONS = (process.env.NODE_OPTIONS || '') + ' --max-old-space-size=2048';
    }
    // Enable garbage collection exposure if not already enabled
    if (!process.env.NODE_OPTIONS.includes('--expose-gc')) {
        process.env.NODE_OPTIONS = (process.env.NODE_OPTIONS || '') + ' --expose-gc';
    }
    // Handle process memory warnings
    process.on('warning', (warning) => {
        if (warning.name === 'MaxListenersExceededWarning' ||
            warning.message.includes('memory')) {
            console.warn('Process memory warning:', warning.message);
            // Trigger emergency cleanup on memory warnings
            if (warning.message.includes('memory') || warning.message.includes('heap')) {
                performEmergencyCleanup();
            }
        }
    });
    // Handle uncaught exceptions that might be memory-related
    process.on('uncaughtException', (error) => {
        if (error.message.includes('out of memory') ||
            error.message.includes('heap') ||
            error.name === 'RangeError') {
            console.error('Memory-related uncaught exception:', error.message);
            performEmergencyCleanup();
        }
    });
}
// Initialize memory management
try {
    initializeMemoryMonitoring();
    setupMemoryHooks();
    addGarbageCollectionHints();
    configureProcessMemory();
    console.log('Memory management setup completed successfully');
}
catch (error) {
    console.error('Failed to initialize memory management:', error);
}
exports.default = {};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vc2V0dXBNZW1vcnlNYW5hZ2VtZW50LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBRUgsaUVBQThEO0FBZ1I1RCxrR0FoUk8scUNBQWlCLE9BZ1JQO0FBOVFuQixpQ0FBaUM7QUFDakMsSUFBSSxtQkFBbUIsR0FBNkIsSUFBSSxDQUFDO0FBRXpELGtDQUFrQztBQUNsQyxNQUFNLGFBQWEsR0FBRztJQUNwQixrQ0FBa0M7SUFDbEMsUUFBUSxFQUFFLElBQUk7SUFDZCx5Q0FBeUM7SUFDekMsY0FBYyxFQUFFLENBQUM7SUFDakIsNkNBQTZDO0lBQzdDLHFCQUFxQixFQUFFLEdBQUc7SUFDMUIsK0NBQStDO0lBQy9DLHlCQUF5QixFQUFFLEdBQUcsRUFBRSxLQUFLO0NBQ3RDLENBQUM7QUFtUUEsc0NBQWE7QUFqUWYsMENBQTBDO0FBQzFDLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztBQUVwQjs7R0FFRztBQUNILFNBQVMsMEJBQTBCO0lBQ2pDLHFEQUFxRDtJQUNyRCxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDbEMsQ0FBQyxDQUFDLHFDQUFpQixDQUFDLFdBQVcsRUFBRTtRQUNqQyxDQUFDLENBQUMscUNBQWlCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFFdEMseUNBQXlDO0lBQ3pDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFO1FBQzFCLE1BQU0sQ0FBQyxjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztLQUNuQztJQUVELHNDQUFzQztJQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRTtRQUN6QixNQUFNLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztLQUMzQjtJQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMvQyxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLDBCQUEwQjtJQUNqQyxX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SSxLQUFLLFlBQVksRUFBRTtZQUMvQixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNuRSx1QkFBdUIsRUFBRSxDQUFDO1NBQzNCO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsK0JBQStCO0FBQy9CLElBQUk7SUFDRiwwQkFBMEIsRUFBRSxDQUFDO0lBQzdCLGdCQUFnQixFQUFFLENBQUM7SUFDbkIseUJBQXlCLEVBQUUsQ0FBQztJQUM1QixzQkFBc0IsRUFBRSxDQUFDO0lBRXpCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0RBQWdELENBQUMsQ0FBQztDQUMvRDtBQUFDLE9BQU8sS0FBSyxFQUFFO0lBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxLQUFLLENBQUMsQ0FBQztDQUNqRTtBQXVCRCxrQkFBZSxFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vc2V0dXBNZW1vcnlNYW5hZ2VtZW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTWVtb3J5IE1hbmFnZW1lbnQgU2V0dXAgZm9yIEplc3QgVGVzdHNcbiAqIFxuICogVGhpcyBmaWxlIGNvbmZpZ3VyZXMgbWVtb3J5IG1hbmFnZW1lbnQsIGdhcmJhZ2UgY29sbGVjdGlvbiBoaW50cyxcbiAqIGFuZCBjbGVhbnVwIHByb2NlZHVyZXMgZm9yIHRoZSB0ZXN0IGVudmlyb25tZW50LlxuICovXG5cbmltcG9ydCB7IFRlc3RNZW1vcnlNb25pdG9yIH0gZnJvbSAnLi91dGlscy9UZXN0TWVtb3J5TW9uaXRvcic7XG5cbi8vIEdsb2JhbCBtZW1vcnkgbW9uaXRvciBpbnN0YW5jZVxubGV0IGdsb2JhbE1lbW9yeU1vbml0b3I6IFRlc3RNZW1vcnlNb25pdG9yIHwgbnVsbCA9IG51bGw7XG5cbi8vIE1lbW9yeSBtYW5hZ2VtZW50IGNvbmZpZ3VyYXRpb25cbmNvbnN0IE1FTU9SWV9DT05GSUcgPSB7XG4gIC8vIEVuYWJsZSBnYXJiYWdlIGNvbGxlY3Rpb24gaGludHNcbiAgZW5hYmxlR0M6IHRydWUsXG4gIC8vIE1lbW9yeSBjaGVjayBmcmVxdWVuY3kgKGV2ZXJ5IE4gdGVzdHMpXG4gIGNoZWNrRnJlcXVlbmN5OiA1LFxuICAvLyBGb3JjZSBjbGVhbnVwIGFmdGVyIG1lbW9yeS1pbnRlbnNpdmUgdGVzdHNcbiAgZm9yY2VDbGVhbnVwVGhyZXNob2xkOiAxMDAsIC8vIE1CXG4gIC8vIEdsb2JhbCBtZW1vcnkgbGltaXQgYmVmb3JlIGVtZXJnZW5jeSBjbGVhbnVwXG4gIGVtZXJnZW5jeUNsZWFudXBUaHJlc2hvbGQ6IDUwMCwgLy8gTUJcbn07XG5cbi8vIFRlc3QgY291bnRlciBmb3IgcGVyaW9kaWMgbWVtb3J5IGNoZWNrc1xubGV0IHRlc3RDb3VudGVyID0gMDtcblxuLyoqXG4gKiBJbml0aWFsaXplIGdsb2JhbCBtZW1vcnkgbW9uaXRvcmluZ1xuICovXG5mdW5jdGlvbiBpbml0aWFsaXplTWVtb3J5TW9uaXRvcmluZygpOiB2b2lkIHtcbiAgLy8gQ3JlYXRlIG1lbW9yeSBtb25pdG9yIHdpdGggQ0ktYXBwcm9wcmlhdGUgc2V0dGluZ3NcbiAgZ2xvYmFsTWVtb3J5TW9uaXRvciA9IHByb2Nlc3MuZW52LkNJIFxuICAgID8gVGVzdE1lbW9yeU1vbml0b3IuY3JlYXRlRm9yQ0koKVxuICAgIDogVGVzdE1lbW9yeU1vbml0b3IuY3JlYXRlRGVmYXVsdCgpO1xuXG4gIC8vIFNldCB1cCBnbG9iYWwgdGVzdCBjYWNoZSBpZiBub3QgZXhpc3RzXG4gIGlmICghZ2xvYmFsLl9fVEVTVF9DQUNIRV9fKSB7XG4gICAgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fID0gbmV3IE1hcCgpO1xuICB9XG5cbiAgLy8gU2V0IHVwIGdsb2JhbCB0ZXN0IHJlZmVyZW5jZXMgYXJyYXlcbiAgaWYgKCFnbG9iYWwuX19URVNUX1JFRlNfXykge1xuICAgIGdsb2JhbC5fX1RFU1RfUkVGU19fID0gW107XG4gIH1cblxuICBjb25zb2xlLmxvZygnTWVtb3J5IG1vbml0b3JpbmcgaW5pdGlhbGl6ZWQnKTtcbn1cblxuLyoqXG4gKiBQZXJmb3JtIHBlcmlvZGljIG1lbW9yeSBjaGVja3NcbiAqL1xuZnVuY3Rpb24gcGVyZm9ybVBlcmlvZGljTWVtb3J5Q2hlY2soKTogdm9pZCB7XG4gIHRlc3RDb3VudGVyKys7XG4gIFxuICBpZiAodGVzdENvdW50ZXIgJSBNRU1PUllfQ09ORklHLmNoZWNrRnJlcXVlbmN5ID09PSAwICYmIGdsb2JhbE1lbW9yeU1vbml0b3IpIHtcbiAgICBjb25zdCBtZW1vcnlDaGVjayA9IGdsb2JhbE1lbW9yeU1vbml0b3IuY2hlY2tNZW1vcnlVc2FnZShgcGVyaW9kaWMtY2hlY2stJHt0ZXN0Q291bnRlcn1gKTtcbiAgICBcbiAgICBpZiAoIW1lbW9yeUNoZWNrLmlzV2l0aGluTGltaXRzKSB7XG4gICAgICBjb25zb2xlLndhcm4oYE1lbW9yeSBjaGVjayBmYWlsZWQgYXQgdGVzdCAke3Rlc3RDb3VudGVyfTpgLCBtZW1vcnlDaGVjay5lcnJvcnMpO1xuICAgICAgXG4gICAgICAvLyBGb3JjZSBjbGVhbnVwIGlmIG1lbW9yeSB1c2FnZSBpcyB0b28gaGlnaFxuICAgICAgY29uc3QgY3VycmVudE1lbW9yeU1CID0gbWVtb3J5Q2hlY2suY3VycmVudFVzYWdlLmhlYXBVc2VkIC8gKDEwMjQgKiAxMDI0KTtcbiAgICAgIGlmIChjdXJyZW50TWVtb3J5TUIgPiBNRU1PUllfQ09ORklHLmVtZXJnZW5jeUNsZWFudXBUaHJlc2hvbGQpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdFbWVyZ2VuY3kgbWVtb3J5IGNsZWFudXAgdHJpZ2dlcmVkJyk7XG4gICAgICAgIHBlcmZvcm1FbWVyZ2VuY3lDbGVhbnVwKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogRW1lcmdlbmN5IG1lbW9yeSBjbGVhbnVwIHByb2NlZHVyZVxuICovXG5mdW5jdGlvbiBwZXJmb3JtRW1lcmdlbmN5Q2xlYW51cCgpOiB2b2lkIHtcbiAgaWYgKGdsb2JhbE1lbW9yeU1vbml0b3IgIT0gbnVsbCkge1xuICAgIGdsb2JhbE1lbW9yeU1vbml0b3IuY2xlYW51cCgnZW1lcmdlbmN5LWNsZWFudXAnKTtcbiAgfVxuICBcbiAgLy8gQ2xlYXIgYWxsIGdsb2JhbCBjYWNoZXNcbiAgaWYgKGdsb2JhbC5fX1RFU1RfQ0FDSEVfXykge1xuICAgIGlmICh0eXBlb2YgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBnbG9iYWwuX19URVNUX0NBQ0hFX18uY2xlYXIoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fID0gbmV3IE1hcCgpO1xuICAgIH1cbiAgfVxuICBcbiAgLy8gQ2xlYXIgdGVzdCByZWZlcmVuY2VzXG4gIGlmIChnbG9iYWwuX19URVNUX1JFRlNfXykge1xuICAgIGdsb2JhbC5fX1RFU1RfUkVGU19fLmxlbmd0aCA9IDA7XG4gIH1cbiAgXG4gIC8vIEZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbiBpZiBhdmFpbGFibGVcbiAgaWYgKGdsb2JhbC5nYykge1xuICAgIHRyeSB7XG4gICAgICBnbG9iYWwuZ2MoKTtcbiAgICAgIGNvbnNvbGUubG9nKCdFbWVyZ2VuY3kgZ2FyYmFnZSBjb2xsZWN0aW9uIHBlcmZvcm1lZCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBwZXJmb3JtIGVtZXJnZW5jeSBnYXJiYWdlIGNvbGxlY3Rpb246JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuICBcbiAgLy8gUmVzZXQgSmVzdCBtb2R1bGVzIHRvIGZyZWUgbWVtb3J5XG4gIGlmIChqZXN0ICYmIGplc3QucmVzZXRNb2R1bGVzKSB7XG4gICAgamVzdC5yZXNldE1vZHVsZXMoKTtcbiAgfVxufVxuXG4vKipcbiAqIFNldHVwIG1lbW9yeSBtYW5hZ2VtZW50IGhvb2tzXG4gKi9cbmZ1bmN0aW9uIHNldHVwTWVtb3J5SG9va3MoKTogdm9pZCB7XG4gIC8vIEJlZm9yZSBlYWNoIHRlc3Qgc3VpdGVcbiAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICBpZiAoZ2xvYmFsTWVtb3J5TW9uaXRvciAhPSBudWxsKSB7XG4gICAgICBnbG9iYWxNZW1vcnlNb25pdG9yLnRha2VTbmFwc2hvdCgnc3VpdGUtc3RhcnQnKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEJlZm9yZSBlYWNoIHRlc3RcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgcGVyZm9ybVBlcmlvZGljTWVtb3J5Q2hlY2soKTtcbiAgICBcbiAgICAvLyBDbGVhciBtb2NrcyBhbmQgcmVzZXQgbW9kdWxlcyBmb3IgbWVtb3J5IGVmZmljaWVuY3lcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICBcbiAgICAvLyBUYWtlIG1lbW9yeSBzbmFwc2hvdCBmb3IgbWVtb3J5LWludGVuc2l2ZSB0ZXN0c1xuICAgIGlmIChnbG9iYWxNZW1vcnlNb25pdG9yICYmIGV4cGVjdC5nZXRTdGF0ZSgpLmN1cnJlbnRUZXN0TmFtZSkge1xuICAgICAgY29uc3QgdGVzdE5hbWUgPSBleHBlY3QuZ2V0U3RhdGUoKS5jdXJyZW50VGVzdE5hbWU7XG4gICAgICBpZiAodGVzdE5hbWUgJiYgKHRlc3ROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ21lbW9yeScpIHx8IFxuICAgICAgICAgIHRlc3ROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3BlcmZvcm1hbmNlJykgfHxcbiAgICAgICAgICB0ZXN0TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdpbnRlZ3JhdGlvbicpKSkge1xuICAgICAgICBnbG9iYWxNZW1vcnlNb25pdG9yLnRha2VTbmFwc2hvdChgYmVmb3JlLSR7dGVzdE5hbWV9YCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICAvLyBBZnRlciBlYWNoIHRlc3RcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBpZiAoZ2xvYmFsTWVtb3J5TW9uaXRvciAhPSBudWxsKSB7XG4gICAgICBjb25zdCB0ZXN0TmFtZSA9IGV4cGVjdC5nZXRTdGF0ZSgpLmN1cnJlbnRUZXN0TmFtZSB8fCAndW5rbm93bi10ZXN0JztcbiAgICAgIGNvbnN0IG1lbW9yeUNoZWNrID0gZ2xvYmFsTWVtb3J5TW9uaXRvci5jaGVja01lbW9yeVVzYWdlKGBhZnRlci0ke3Rlc3ROYW1lfWApO1xuICAgICAgXG4gICAgICAvLyBGb3JjZSBjbGVhbnVwIGZvciBtZW1vcnktaW50ZW5zaXZlIHRlc3RzIG9yIGlmIG1lbW9yeSB1c2FnZSBpcyBoaWdoXG4gICAgICBjb25zdCBjdXJyZW50TWVtb3J5TUIgPSBtZW1vcnlDaGVjay5jdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAoMTAyNCAqIDEwMjQpO1xuICAgICAgaWYgKGN1cnJlbnRNZW1vcnlNQiA+IE1FTU9SWV9DT05GSUcuZm9yY2VDbGVhbnVwVGhyZXNob2xkIHx8IFxuICAgICAgICAgIHRlc3ROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ21lbW9yeScpIHx8XG4gICAgICAgICAgdGVzdE5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaW50ZWdyYXRpb24nKSkge1xuICAgICAgICBcbiAgICAgICAgZ2xvYmFsTWVtb3J5TW9uaXRvci5jbGVhbnVwKHRlc3ROYW1lKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gTG9nIHdhcm5pbmdzIGlmIG1lbW9yeSB1c2FnZSBpcyBjb25jZXJuaW5nXG4gICAgICBpZiAobWVtb3J5Q2hlY2sud2FybmluZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYE1lbW9yeSB3YXJuaW5ncyBmb3IgdGVzdCBcIiR7dGVzdE5hbWV9XCI6YCwgbWVtb3J5Q2hlY2sud2FybmluZ3MpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBDbGVhciBhbnkgdGVzdC1zcGVjaWZpYyBnbG9iYWwgcmVmZXJlbmNlc1xuICAgIGlmIChnbG9iYWwuX19URVNUX1JFRlNfXykge1xuICAgICAgZ2xvYmFsLl9fVEVTVF9SRUZTX18ubGVuZ3RoID0gMDtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEFmdGVyIGVhY2ggdGVzdCBzdWl0ZVxuICBhZnRlckFsbCgoKSA9PiB7XG4gICAgaWYgKGdsb2JhbE1lbW9yeU1vbml0b3IgIT0gbnVsbCkge1xuICAgICAgZ2xvYmFsTWVtb3J5TW9uaXRvci50YWtlU25hcHNob3QoJ3N1aXRlLWVuZCcpO1xuICAgICAgXG4gICAgICAvLyBHZW5lcmF0ZSBtZW1vcnkgcmVwb3J0IGZvciB0aGUgc3VpdGVcbiAgICAgIGNvbnN0IHN1bW1hcnkgPSBnbG9iYWxNZW1vcnlNb25pdG9yLmdldE1lbW9yeVN1bW1hcnkoKTtcbiAgICAgIGlmIChzdW1tYXJ5LnRvdGFsSW5jcmVhc2UgPiA1MCkgeyAvLyA1ME1CIHRocmVzaG9sZCBmb3IgcmVwb3J0aW5nXG4gICAgICAgIGNvbnNvbGUubG9nKCdNZW1vcnkgdXNhZ2Ugc3VtbWFyeSBmb3IgdGVzdCBzdWl0ZTonLCB7XG4gICAgICAgICAgaW5pdGlhbE1lbW9yeTogYCR7c3VtbWFyeS5pbml0aWFsTWVtb3J5LnRvRml4ZWQoMil9TUJgLFxuICAgICAgICAgIGZpbmFsTWVtb3J5OiBgJHtzdW1tYXJ5LmN1cnJlbnRNZW1vcnkudG9GaXhlZCgyKX1NQmAsXG4gICAgICAgICAgcGVha01lbW9yeTogYCR7c3VtbWFyeS5wZWFrTWVtb3J5LnRvRml4ZWQoMil9TUJgLFxuICAgICAgICAgIHRvdGFsSW5jcmVhc2U6IGAke3N1bW1hcnkudG90YWxJbmNyZWFzZS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICAgICBkdXJhdGlvbjogYCR7KHN1bW1hcnkudGVzdER1cmF0aW9uIC8gMTAwMCkudG9GaXhlZCgyKX1zYFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gUGVyZm9ybSBmaW5hbCBjbGVhbnVwXG4gICAgICBnbG9iYWxNZW1vcnlNb25pdG9yLmNsZWFudXAoJ3N1aXRlLWNsZWFudXAnKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vKipcbiAqIEFkZCBnYXJiYWdlIGNvbGxlY3Rpb24gaGludHNcbiAqL1xuZnVuY3Rpb24gYWRkR2FyYmFnZUNvbGxlY3Rpb25IaW50cygpOiB2b2lkIHtcbiAgLy8gQWRkIGdsb2JhbCB1dGlsaXR5IGZvciBtYW51YWwgZ2FyYmFnZSBjb2xsZWN0aW9uXG4gIGdsb2JhbC5mb3JjZUdDID0gKCkgPT4ge1xuICAgIGlmIChnbG9iYWwuZ2MpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbjonLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9O1xuICBcbiAgLy8gQWRkIG1lbW9yeSBtb25pdG9yaW5nIHV0aWxpdGllcyB0byBnbG9iYWwgc2NvcGVcbiAgZ2xvYmFsLmdldE1lbW9yeVVzYWdlID0gKCkgPT4ge1xuICAgIGNvbnN0IHVzYWdlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuICAgIHJldHVybiB7XG4gICAgICBoZWFwVXNlZDogYCR7KHVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgaGVhcFRvdGFsOiBgJHsodXNhZ2UuaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgZXh0ZXJuYWw6IGAkeyh1c2FnZS5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgIGFycmF5QnVmZmVyczogYCR7KHVzYWdlLmFycmF5QnVmZmVycyAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYFxuICAgIH07XG4gIH07XG4gIFxuICAvLyBBZGQgY2xlYW51cCB1dGlsaXR5XG4gIGdsb2JhbC5jbGVhbnVwVGVzdE1lbW9yeSA9ICgpID0+IHtcbiAgICBpZiAoZ2xvYmFsTWVtb3J5TW9uaXRvciAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gZ2xvYmFsTWVtb3J5TW9uaXRvci5jbGVhbnVwKCdtYW51YWwtY2xlYW51cCcpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfTtcbn1cblxuLyoqXG4gKiBDb25maWd1cmUgcHJvY2Vzcy1sZXZlbCBtZW1vcnkgbWFuYWdlbWVudFxuICovXG5mdW5jdGlvbiBjb25maWd1cmVQcm9jZXNzTWVtb3J5KCk6IHZvaWQge1xuICAvLyBTZXQgTm9kZT8uanMgbWVtb3J5IGxpbWl0cyBpZiBub3QgYWxyZWFkeSBzZXRcbiAgaWYgKCFwcm9jZXNzLmVudi5OT0RFX09QVElPTlM/LmluY2x1ZGVzKCctLW1heC1vbGQtc3BhY2Utc2l6ZScpKSB7XG4gICAgLy8gU2V0IHJlYXNvbmFibGUgbWVtb3J5IGxpbWl0IGZvciB0ZXN0cyAoMkdCKVxuICAgIHByb2Nlc3MuZW52Lk5PREVfT1BUSU9OUyA9IChwcm9jZXNzLmVudi5OT0RFX09QVElPTlMgfHwgJycpICsgJyAtLW1heC1vbGQtc3BhY2Utc2l6ZT0yMDQ4JztcbiAgfVxuICBcbiAgLy8gRW5hYmxlIGdhcmJhZ2UgY29sbGVjdGlvbiBleHBvc3VyZSBpZiBub3QgYWxyZWFkeSBlbmFibGVkXG4gIGlmICghcHJvY2Vzcy5lbnYuTk9ERV9PUFRJT05TLmluY2x1ZGVzKCctLWV4cG9zZS1nYycpKSB7XG4gICAgcHJvY2Vzcy5lbnYuTk9ERV9PUFRJT05TID0gKHByb2Nlc3MuZW52Lk5PREVfT1BUSU9OUyB8fCAnJykgKyAnIC0tZXhwb3NlLWdjJztcbiAgfVxuICBcbiAgLy8gSGFuZGxlIHByb2Nlc3MgbWVtb3J5IHdhcm5pbmdzXG4gIHByb2Nlc3Mub24oJ3dhcm5pbmcnLCAod2FybmluZykgPT4ge1xuICAgIGlmICh3YXJuaW5nLm5hbWUgPT09ICdNYXhMaXN0ZW5lcnNFeGNlZWRlZFdhcm5pbmcnIHx8IFxuICAgICAgICB3YXJuaW5nLm1lc3NhZ2UuaW5jbHVkZXMoJ21lbW9yeScpKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ1Byb2Nlc3MgbWVtb3J5IHdhcm5pbmc6Jywgd2FybmluZy5tZXNzYWdlKTtcbiAgICAgIFxuICAgICAgLy8gVHJpZ2dlciBlbWVyZ2VuY3kgY2xlYW51cCBvbiBtZW1vcnkgd2FybmluZ3NcbiAgICAgIGlmICh3YXJuaW5nLm1lc3NhZ2UuaW5jbHVkZXMoJ21lbW9yeScpIHx8IHdhcm5pbmcubWVzc2FnZS5pbmNsdWRlcygnaGVhcCcpKSB7XG4gICAgICAgIHBlcmZvcm1FbWVyZ2VuY3lDbGVhbnVwKCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgXG4gIC8vIEhhbmRsZSB1bmNhdWdodCBleGNlcHRpb25zIHRoYXQgbWlnaHQgYmUgbWVtb3J5LXJlbGF0ZWRcbiAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyb3IpID0+IHtcbiAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnb3V0IG9mIG1lbW9yeScpIHx8IFxuICAgICAgICBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdoZWFwJykgfHxcbiAgICAgICAgZXJyb3IubmFtZSA9PT0gJ1JhbmdlRXJyb3InKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdNZW1vcnktcmVsYXRlZCB1bmNhdWdodCBleGNlcHRpb246JywgZXJyb3IubWVzc2FnZSk7XG4gICAgICBwZXJmb3JtRW1lcmdlbmN5Q2xlYW51cCgpO1xuICAgIH1cbiAgfSk7XG59XG5cbi8vIEluaXRpYWxpemUgbWVtb3J5IG1hbmFnZW1lbnRcbnRyeSB7XG4gIGluaXRpYWxpemVNZW1vcnlNb25pdG9yaW5nKCk7XG4gIHNldHVwTWVtb3J5SG9va3MoKTtcbiAgYWRkR2FyYmFnZUNvbGxlY3Rpb25IaW50cygpO1xuICBjb25maWd1cmVQcm9jZXNzTWVtb3J5KCk7XG4gIFxuICBjb25zb2xlLmxvZygnTWVtb3J5IG1hbmFnZW1lbnQgc2V0dXAgY29tcGxldGVkIHN1Y2Nlc3NmdWxseScpO1xufSBjYXRjaCAoZXJyb3IpIHtcbiAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgbWVtb3J5IG1hbmFnZW1lbnQ6JywgZXJyb3IpO1xufVxuXG4vLyBFeHBvcnQgdXRpbGl0aWVzIGZvciB1c2UgaW4gdGVzdHNcbmV4cG9ydCB7XG4gIFRlc3RNZW1vcnlNb25pdG9yLFxuICBwZXJmb3JtRW1lcmdlbmN5Q2xlYW51cCxcbiAgTUVNT1JZX0NPTkZJR1xufTtcblxuLy8gR2xvYmFsIHR5cGUgZGVjbGFyYXRpb25zXG5kZWNsYXJlIGdsb2JhbCB7XG4gIHZhciBmb3JjZUdDOiAoKSA9PiBib29sZWFuO1xuICB2YXIgZ2V0TWVtb3J5VXNhZ2U6ICgpID0+IHtcbiAgICBoZWFwVXNlZDogc3RyaW5nO1xuICAgIGhlYXBUb3RhbDogc3RyaW5nO1xuICAgIGV4dGVybmFsOiBzdHJpbmc7XG4gICAgYXJyYXlCdWZmZXJzOiBzdHJpbmc7XG4gIH07XG4gIHZhciBjbGVhbnVwVGVzdE1lbW9yeTogKCkgPT4gYW55O1xuICB2YXIgX19URVNUX0NBQ0hFX186IE1hcDxzdHJpbmcsIGFueT4gfCB7IGNsZWFyOiAoKSA9PiB2b2lkOyB9IHwgdW5kZWZpbmVkO1xuICB2YXIgX19URVNUX1JFRlNfXzogYW55W10gfCB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHt9OyJdLCJ2ZXJzaW9uIjozfQ==