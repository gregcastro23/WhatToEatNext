20f6ec8509a2c03e2c0d97bbed11c2b7
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildValidator = exports.BuildValidator = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const child_process_1 = require("child_process");
/**
 * BuildValidator class for checking and repairing build artifacts
 * Implements requirements 3.1, 3.2, 3.3, 3.4, 3.5 from test system stabilization
 */
class BuildValidator {
    constructor(buildDir = '.next', logger = console.log) {
        this.buildDir = buildDir;
        this.serverDir = path_1.default.join(buildDir, 'server');
        this.logger = logger;
        // Required manifest files for Next.js build
        this.requiredManifests = [
            'pages-manifest.json',
            'app-paths-manifest.json',
            'next-font-manifest.json',
            'middleware-manifest.json',
        ];
    }
    /**
     * Validates the build artifacts and checks for required files
     * Requirement 3.2: Implement BuildValidator class to check for required build artifacts
     */
    async validateBuild() {
        const result = {
            isValid: true,
            missingFiles: [],
            corruptedFiles: [],
            repairActions: [],
        };
        try {
            // Check if build directory exists
            if (!fs_1.default.existsSync(this.buildDir)) {
                result.isValid = false;
                result.missingFiles.push(this.buildDir);
                result.repairActions.push({
                    type: 'create',
                    target: this.buildDir,
                    description: 'Create build directory',
                });
                return result;
            }
            // Check if server directory exists
            if (!fs_1.default.existsSync(this.serverDir)) {
                result.isValid = false;
                result.missingFiles.push(this.serverDir);
                result.repairActions.push({
                    type: 'create',
                    target: this.serverDir,
                    description: 'Create server directory',
                });
            }
            // Check required manifest files
            for (const manifest of this.requiredManifests) {
                const manifestPath = path_1.default.join(this.serverDir, manifest);
                if (!fs_1.default.existsSync(manifestPath)) {
                    result.isValid = false;
                    result.missingFiles.push(manifestPath);
                    result.repairActions.push({
                        type: 'create',
                        target: manifestPath,
                        description: `Create missing manifest file: ${manifest}`,
                    });
                }
                else {
                    // Check if file is corrupted (empty or invalid JSON)
                    try {
                        const content = fs_1.default.readFileSync(manifestPath, 'utf8');
                        if (content.trim() === '') {
                            result.corruptedFiles.push(manifestPath);
                            result.repairActions.push({
                                type: 'fix',
                                target: manifestPath,
                                description: `Fix empty manifest file: ${manifest}`,
                            });
                        }
                        else if (manifest.endsWith('.json')) {
                            JSON.parse(content); // Validate JSON
                        }
                    }
                    catch (error) {
                        result.isValid = false;
                        result.corruptedFiles.push(manifestPath);
                        result.repairActions.push({
                            type: 'fix',
                            target: manifestPath,
                            description: `Fix corrupted manifest file: ${manifest}`,
                        });
                    }
                }
            }
            // Check for essential build files
            const essentialFiles = [
                'build-manifest.json',
                'app-build-manifest.json',
                'react-loadable-manifest.json',
            ];
            for (const file of essentialFiles) {
                const filePath = path_1.default.join(this.buildDir, file);
                if (!fs_1.default.existsSync(filePath)) {
                    result.isValid = false;
                    result.missingFiles.push(filePath);
                    result.repairActions.push({
                        type: 'create',
                        target: filePath,
                        description: `Create missing build file: ${file}`,
                    });
                }
            }
            this.logger(`Build validation completed. Valid: ${result.isValid}, Missing: ${result.missingFiles.length}, Corrupted: ${result.corruptedFiles.length}`);
        }
        catch (error) {
            this.logger('Build validation failed:', error);
            result.isValid = false;
        }
        return result;
    }
    /**
     * Repairs the build by creating missing manifest files with minimal content
     * Requirement 3.3: Create missing manifest files with minimal content when needed
     */
    async repairBuild() {
        const validation = await this.validateBuild();
        if (validation.isValid) {
            this.logger('Build is valid, no repairs needed');
            return;
        }
        this.logger(`Starting build repair. ${validation.repairActions.length} actions to perform.`);
        // Create directories if needed
        if (!fs_1.default.existsSync(this.buildDir)) {
            fs_1.default.mkdirSync(this.buildDir, { recursive: true });
            this.logger(`Created build directory: ${this.buildDir}`);
        }
        if (!fs_1.default.existsSync(this.serverDir)) {
            fs_1.default.mkdirSync(this.serverDir, { recursive: true });
            this.logger(`Created server directory: ${this.serverDir}`);
        }
        // Create missing manifest files with minimal content
        const manifestDefaults = this.getManifestDefaults();
        for (const action of validation.repairActions) {
            if (action.type === 'create' || action.type === 'fix') {
                const filename = path_1.default.basename(action.target);
                if (manifestDefaults[filename]) {
                    fs_1.default.writeFileSync(action.target, JSON.stringify(manifestDefaults[filename], null, 2));
                    this.logger(`${action.type === 'create' ? 'Created' : 'Fixed'} ${filename}`);
                }
            }
        }
        this.logger('Build repair completed');
    }
    /**
     * Attempts to rebuild the application with error recovery
     * Requirement 3.4: Add build error recovery and retry mechanisms
     */
    async rebuildWithRecovery(maxRetries = 3) {
        let attempt = 0;
        while (attempt < maxRetries) {
            attempt++;
            this.logger(`Build attempt ${attempt}/${maxRetries}`);
            try {
                // Clean build directory before retry
                if (attempt > 1) {
                    await this.cleanBuild();
                    await this.repairBuild();
                }
                // Attempt build
                (0, child_process_1.execSync)('yarn build', {
                    stdio: 'pipe',
                    timeout: 300000, // 5 minute timeout
                });
                // Validate build after completion
                const validation = await this.validateBuild();
                if (validation.isValid) {
                    this.logger(`Build successful on attempt ${attempt}`);
                    return true;
                }
                else {
                    this.logger(`Build completed but validation failed on attempt ${attempt}`);
                    await this.repairBuild();
                }
            }
            catch (error) {
                this.logger(`Build failed on attempt ${attempt}:`, error);
                if (attempt < maxRetries) {
                    this.logger(`Retrying build in 5 seconds...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }
        this.logger(`Build failed after ${maxRetries} attempts`);
        return false;
    }
    /**
     * Cleans the build directory
     */
    async cleanBuild() {
        try {
            if (fs_1.default.existsSync(this.buildDir)) {
                fs_1.default.rmSync(this.buildDir, { recursive: true, force: true });
                this.logger('Build directory cleaned');
            }
        }
        catch (error) {
            this.logger('Error cleaning build directory:', error);
        }
    }
    /**
     * Gets default content for manifest files
     * Requirement 3.3: Create missing manifest files with minimal content when needed
     */
    getManifestDefaults() {
        return {
            'pages-manifest.json': {},
            'app-paths-manifest.json': {},
            'next-font-manifest.json': {
                pages: {},
                app: {},
                appUsingSizeAdjust: false,
                pagesUsingSizeAdjust: false,
            },
            'middleware-manifest.json': {
                sortedMiddleware: [],
                middleware: {},
                functions: {},
                version: 2,
            },
            'build-manifest.json': {
                devFiles: [],
                ampDevFiles: [],
                polyfillFiles: [],
                lowPriorityFiles: [],
                rootMainFiles: [],
                pages: {},
                ampFirstPages: [],
            },
            'app-build-manifest.json': {
                pages: {},
            },
            'react-loadable-manifest.json': {},
        };
    }
    /**
     * Checks if Next.js configuration is properly set up
     * Requirement 3.1: Fix Next.js configuration to properly generate manifest files
     */
    validateNextConfig() {
        const result = {
            isValid: true,
            issues: [],
            recommendations: [],
        };
        try {
            // Check if next.config.js exists
            const configPaths = [
                'next.config.js',
                'next.config.mjs',
                'next.config.ts',
            ];
            const existingConfig = configPaths.find(path => fs_1.default.existsSync(path));
            if (!existingConfig) {
                result.isValid = false;
                result.issues.push('No Next.js configuration file found');
                result.recommendations.push('Create next.config.js with proper build settings');
                return result;
            }
            // Read and validate configuration
            const configContent = fs_1.default.readFileSync(existingConfig, 'utf8');
            // Check for essential configuration options
            const essentialConfigs = ['output', 'typescript', 'eslint'];
            for (const config of essentialConfigs) {
                if (!configContent.includes(config)) {
                    result.recommendations.push(`Consider adding ${config} configuration for better build stability`);
                }
            }
            // Check for build optimization settings
            if (!configContent.includes('webpack')) {
                result.recommendations.push('Consider adding webpack configuration for build optimization');
            }
            this.logger(`Next.js config validation completed. Valid: ${result.isValid}, Issues: ${result.issues.length}`);
        }
        catch (error) {
            result.isValid = false;
            result.issues.push(`Error reading Next.js configuration: ${error}`);
        }
        return result;
    }
    /**
     * Monitors build health and performance
     * Requirement 3.5: Add build error recovery and retry mechanisms
     */
    async monitorBuildHealth() {
        const report = {
            timestamp: new Date(),
            buildExists: fs_1.default.existsSync(this.buildDir),
            manifestsValid: false,
            buildSize: 0,
            lastBuildTime: null,
            issues: [],
        };
        try {
            if (report.buildExists) {
                // Calculate build size
                report.buildSize = this.calculateDirectorySize(this.buildDir);
                // Check manifest validity
                const validation = await this.validateBuild();
                report.manifestsValid = validation.isValid;
                if (!validation.isValid) {
                    report.issues.push(...validation.missingFiles.map(file => `Missing: ${file}`));
                    report.issues.push(...validation.corruptedFiles.map(file => `Corrupted: ${file}`));
                }
                // Get last build time
                const buildManifestPath = path_1.default.join(this.buildDir, 'build-manifest.json');
                if (fs_1.default.existsSync(buildManifestPath)) {
                    const stats = fs_1.default.statSync(buildManifestPath);
                    report.lastBuildTime = stats.mtime;
                }
            }
            else {
                report.issues.push('Build directory does not exist');
            }
        }
        catch (error) {
            report.issues.push(`Health check error: ${error}`);
        }
        return report;
    }
    /**
     * Calculates directory size recursively
     */
    calculateDirectorySize(dirPath) {
        let size = 0;
        try {
            const files = fs_1.default.readdirSync(dirPath);
            for (const file of files) {
                const filePath = path_1.default.join(dirPath, file);
                const stats = fs_1.default.statSync(filePath);
                if (stats.isDirectory()) {
                    size += this.calculateDirectorySize(filePath);
                }
                else {
                    size += stats.size;
                }
            }
        }
        catch (error) {
            // Ignore errors for inaccessible files
        }
        return size;
    }
}
exports.BuildValidator = BuildValidator;
// Export default instance
exports.buildValidator = new BuildValidator();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy91dGlscy9CdWlsZFZhbGlkYXRvci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLGlEQUF5QztBQUV6Qzs7O0dBR0c7QUFDSCxNQUFhLGNBQWM7SUFNekIsWUFBWSxRQUFRLEdBQUcsT0FBTyxFQUFFLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRztRQUNsRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLDRDQUE0QztRQUM1QyxJQUFJLENBQUMsaUJBQWlCLEdBQUc7WUFDdkIscUJBQXFCO1lBQ3JCLHlCQUF5QjtZQUN6Qix5QkFBeUI7WUFDekIsMEJBQTBCO1NBQzNCLENBQUM7SUFDSixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLGFBQWE7UUFDakIsTUFBTSxNQUFNLEdBQTBCO1lBQ3BDLE9BQU8sRUFBRSxJQUFJO1lBQ2IsWUFBWSxFQUFFLEVBQUU7WUFDaEIsY0FBYyxFQUFFLEVBQUU7WUFDbEIsYUFBYSxFQUFFLEVBQUU7U0FDbEIsQ0FBQztRQUVGLElBQUk7WUFDRixrQ0FBa0M7WUFDbEMsSUFBSSxDQUFDLFlBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNqQyxNQUFNLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztnQkFDdkIsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN4QyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQztvQkFDeEIsSUFBSSxFQUFFLFFBQVE7b0JBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRO29CQUNy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SUFBSSxLQUFLLEVBQUU7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUMxQyxNQUFNLEtBQUssR0FBRyxZQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUVwQyxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRTtvQkFDdkIsSUFBSSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDL0M7cUJBQU07b0JBQ0wsSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUM7aUJBQ3BCO2FBQ0Y7U0FDRjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsdUNBQXVDO1NBQ3hDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUExWkQsd0NBMFpDO0FBK0JELDBCQUEwQjtBQUNiLFFBQUEsY0FBYyxHQUFHLElBQUksY0FBYyxFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy91dGlscy9CdWlsZFZhbGlkYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuXG4vKipcbiAqIEJ1aWxkVmFsaWRhdG9yIGNsYXNzIGZvciBjaGVja2luZyBhbmQgcmVwYWlyaW5nIGJ1aWxkIGFydGlmYWN0c1xuICogSW1wbGVtZW50cyByZXF1aXJlbWVudHMgMy4xLCAzLjIsIDMuMywgMy40LCAzLjUgZnJvbSB0ZXN0IHN5c3RlbSBzdGFiaWxpemF0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBCdWlsZFZhbGlkYXRvciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgYnVpbGREaXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBzZXJ2ZXJEaXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSByZXF1aXJlZE1hbmlmZXN0czogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiAobWVzc2FnZTogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihidWlsZERpciA9ICcubmV4dCcsIGxvZ2dlciA9IGNvbnNvbGUubG9nKSB7XG4gICAgdGhpcy5idWlsZERpciA9IGJ1aWxkRGlyO1xuICAgIHRoaXMuc2VydmVyRGlyID0gcGF0aC5qb2luKGJ1aWxkRGlyLCAnc2VydmVyJyk7XG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG5cbiAgICAvLyBSZXF1aXJlZCBtYW5pZmVzdCBmaWxlcyBmb3IgTmV4dC5qcyBidWlsZFxuICAgIHRoaXMucmVxdWlyZWRNYW5pZmVzdHMgPSBbXG4gICAgICAncGFnZXMtbWFuaWZlc3QuanNvbicsXG4gICAgICAnYXBwLXBhdGhzLW1hbmlmZXN0Lmpzb24nLFxuICAgICAgJ25leHQtZm9udC1tYW5pZmVzdC5qc29uJyxcbiAgICAgICdtaWRkbGV3YXJlLW1hbmlmZXN0Lmpzb24nLFxuICAgIF07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGVzIHRoZSBidWlsZCBhcnRpZmFjdHMgYW5kIGNoZWNrcyBmb3IgcmVxdWlyZWQgZmlsZXNcbiAgICogUmVxdWlyZW1lbnQgMy4yOiBJbXBsZW1lbnQgQnVpbGRWYWxpZGF0b3IgY2xhc3MgdG8gY2hlY2sgZm9yIHJlcXVpcmVkIGJ1aWxkIGFydGlmYWN0c1xuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVCdWlsZCgpOiBQcm9taXNlPEJ1aWxkVmFsaWRhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHJlc3VsdDogQnVpbGRWYWxpZGF0aW9uUmVzdWx0ID0ge1xuICAgICAgaXNWYWxpZDogdHJ1ZSxcbiAgICAgIG1pc3NpbmdGaWxlczogW10sXG4gICAgICBjb3JydXB0ZWRGaWxlczogW10sXG4gICAgICByZXBhaXJBY3Rpb25zOiBbXSxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIGJ1aWxkIGRpcmVjdG9yeSBleGlzdHNcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLmJ1aWxkRGlyKSkge1xuICAgICAgICByZXN1bHQuaXNWYWxpZCA9IGZhbHNlO1xuICAgICAgICByZXN1bHQubWlzc2luZ0ZpbGVzLnB1c2godGhpcy5idWlsZERpcik7XG4gICAgICAgIHJlc3VsdC5yZXBhaXJBY3Rpb25zLnB1c2goe1xuICAgICAgICAgIHR5cGU6ICdjcmVhdGUnLFxuICAgICAgICAgIHRhcmdldDogdGhpcy5idWlsZERpcixcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0NyZWF0ZSBidWlsZCBkaXJlY3RvcnknLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgc2VydmVyIGRpcmVjdG9yeSBleGlzdHNcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLnNlcnZlckRpcikpIHtcbiAgICAgICAgcmVzdWx0LmlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgcmVzdWx0Lm1pc3NpbmdGaWxlcy5wdXNoKHRoaXMuc2VydmVyRGlyKTtcbiAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgdHlwZTogJ2NyZWF0ZScsXG4gICAgICAgICAgdGFyZ2V0OiB0aGlzLnNlcnZlckRpcixcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0NyZWF0ZSBzZXJ2ZXIgZGlyZWN0b3J5JyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHJlcXVpcmVkIG1hbmlmZXN0IGZpbGVzXG4gICAgICBmb3IgKGNvbnN0IG1hbmlmZXN0IG9mIHRoaXMucmVxdWlyZWRNYW5pZmVzdHMpIHtcbiAgICAgICAgY29uc3QgbWFuaWZlc3RQYXRoID0gcGF0aC5qb2luKHRoaXMuc2VydmVyRGlyLCBtYW5pZmVzdCk7XG5cbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKG1hbmlmZXN0UGF0aCkpIHtcbiAgICAgICAgICByZXN1bHQuaXNWYWxpZCA9IGZhbHNlO1xuICAgICAgICAgIHJlc3VsdC5taXNzaW5nRmlsZXMucHVzaChtYW5pZmVzdFBhdGgpO1xuICAgICAgICAgIHJlc3VsdC5yZXBhaXJBY3Rpb25zLnB1c2goe1xuICAgICAgICAgICAgdHlwZTogJ2NyZWF0ZScsXG4gICAgICAgICAgICB0YXJnZXQ6IG1hbmlmZXN0UGF0aCxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgQ3JlYXRlIG1pc3NpbmcgbWFuaWZlc3QgZmlsZTogJHttYW5pZmVzdH1gLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIENoZWNrIGlmIGZpbGUgaXMgY29ycnVwdGVkIChlbXB0eSBvciBpbnZhbGlkIEpTT04pXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMobWFuaWZlc3RQYXRoLCAndXRmOCcpO1xuICAgICAgICAgICAgaWYgKGNvbnRlbnQudHJpbSgpID09PSAnJykge1xuICAgICAgICAgICAgICByZXN1bHQuY29ycnVwdGVkRmlsZXMucHVzaChtYW5pZmVzdFBhdGgpO1xuICAgICAgICAgICAgICByZXN1bHQucmVwYWlyQWN0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnZml4JyxcbiAgICAgICAgICAgICAgICB0YXJnZXQ6IG1hbmlmZXN0UGF0aCxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYEZpeCBlbXB0eSBtYW5pZmVzdCBmaWxlOiAke21hbmlmZXN0fWAsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChtYW5pZmVzdC5lbmRzV2l0aCgnLmpzb24nKSkge1xuICAgICAgICAgICAgICBKU09OLnBhcnNlKGNvbnRlbnQpOyAvLyBWYWxpZGF0ZSBKU09OXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICByZXN1bHQuY29ycnVwdGVkRmlsZXMucHVzaChtYW5pZmVzdFBhdGgpO1xuICAgICAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgIHR5cGU6ICdmaXgnLFxuICAgICAgICAgICAgICB0YXJnZXQ6IG1hbmlmZXN0UGF0aCxcbiAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGBGaXggY29ycnVwdGVkIG1hbmlmZXN0IGZpbGU6ICR7bWFuaWZlc3R9YCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgZXNzZW50aWFsIGJ1aWxkIGZpbGVzXG4gICAgICBjb25zdCBlc3NlbnRpYWxGaWxlcyA9IFtcbiAgICAgICAgJ2J1aWxkLW1hbmlmZXN0Lmpzb24nLFxuICAgICAgICAnYXBwLWJ1aWxkLW1hbmlmZXN0Lmpzb24nLFxuICAgICAgICAncmVhY3QtbG9hZGFibGUtbWFuaWZlc3QuanNvbicsXG4gICAgICBdO1xuXG4gICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZXNzZW50aWFsRmlsZXMpIHtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4odGhpcy5idWlsZERpciwgZmlsZSk7XG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgICByZXN1bHQuaXNWYWxpZCA9IGZhbHNlO1xuICAgICAgICAgIHJlc3VsdC5taXNzaW5nRmlsZXMucHVzaChmaWxlUGF0aCk7XG4gICAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICB0eXBlOiAnY3JlYXRlJyxcbiAgICAgICAgICAgIHRhcmdldDogZmlsZVBhdGgsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYENyZWF0ZSBtaXNzaW5nIGJ1aWxkIGZpbGU6ICR7ZmlsZX1gLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyKFxuICAgICAgICBgQnVpbGQgdmFsaWRhdGlvbiBjb21wbGV0ZWQuIFZhbGlkOiAke3Jlc3VsdC5pc1ZhbGlkfSwgTWlzc2luZzogJHtyZXN1bHQubWlzc2luZ0ZpbGVzLmxlbmd0aH0sIENvcnJ1cHRlZDogJHtyZXN1bHQuY29ycnVwdGVkRmlsZXMubGVuZ3RofWBcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyKCdCdWlsZCB2YWxpZGF0aW9uIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXN1bHQuaXNWYWxpZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogUmVwYWlycyB0aGUgYnVpbGQgYnkgY3JlYXRpbmcgbWlzc2luZyBtYW5pZmVzdCBmaWxlcyB3aXRoIG1pbmltYWwgY29udGVudFxuICAgKiBSZXF1aXJlbWVudCAzLjM6IENyZWF0ZSBtaXNzaW5nIG1hbmlmZXN0IGZpbGVzIHdpdGggbWluaW1hbCBjb250ZW50IHdoZW4gbmVlZGVkXG4gICAqL1xuICBhc3luYyByZXBhaXJCdWlsZCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgdGhpcy52YWxpZGF0ZUJ1aWxkKCk7XG5cbiAgICBpZiAodmFsaWRhdGlvbi5pc1ZhbGlkKSB7XG4gICAgICB0aGlzLmxvZ2dlcignQnVpbGQgaXMgdmFsaWQsIG5vIHJlcGFpcnMgbmVlZGVkJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5sb2dnZXIoXG4gICAgICBgU3RhcnRpbmcgYnVpbGQgcmVwYWlyLiAke3ZhbGlkYXRpb24ucmVwYWlyQWN0aW9ucy5sZW5ndGh9IGFjdGlvbnMgdG8gcGVyZm9ybS5gXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSBkaXJlY3RvcmllcyBpZiBuZWVkZWRcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmModGhpcy5idWlsZERpcikpIHtcbiAgICAgIGZzLm1rZGlyU3luYyh0aGlzLmJ1aWxkRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICAgIHRoaXMubG9nZ2VyKGBDcmVhdGVkIGJ1aWxkIGRpcmVjdG9yeTogJHt0aGlzLmJ1aWxkRGlyfWApO1xuICAgIH1cblxuICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLnNlcnZlckRpcikpIHtcbiAgICAgIGZzLm1rZGlyU3luYyh0aGlzLnNlcnZlckRpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICB0aGlzLmxvZ2dlcihgQ3JlYXRlZCBzZXJ2ZXIgZGlyZWN0b3J5OiAke3RoaXMuc2VydmVyRGlyfWApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBtaXNzaW5nIG1hbmlmZXN0IGZpbGVzIHdpdGggbWluaW1hbCBjb250ZW50XG4gICAgY29uc3QgbWFuaWZlc3REZWZhdWx0cyA9IHRoaXMuZ2V0TWFuaWZlc3REZWZhdWx0cygpO1xuXG4gICAgZm9yIChjb25zdCBhY3Rpb24gb2YgdmFsaWRhdGlvbi5yZXBhaXJBY3Rpb25zKSB7XG4gICAgICBpZiAoYWN0aW9uLnR5cGUgPT09ICdjcmVhdGUnIHx8IGFjdGlvbi50eXBlID09PSAnZml4Jykge1xuICAgICAgICBjb25zdCBmaWxlbmFtZSA9IHBhdGguYmFzZW5hbWUoYWN0aW9uLnRhcmdldCk7XG5cbiAgICAgICAgaWYgKG1hbmlmZXN0RGVmYXVsdHNbZmlsZW5hbWVdKSB7XG4gICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgICAgICAgIGFjdGlvbi50YXJnZXQsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShtYW5pZmVzdERlZmF1bHRzW2ZpbGVuYW1lXSwgbnVsbCwgMilcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMubG9nZ2VyKFxuICAgICAgICAgICAgYCR7YWN0aW9uLnR5cGUgPT09ICdjcmVhdGUnID8gJ0NyZWF0ZWQnIDogJ0ZpeGVkJ30gJHtmaWxlbmFtZX1gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyKCdCdWlsZCByZXBhaXIgY29tcGxldGVkJyk7XG4gIH1cblxuICAvKipcbiAgICogQXR0ZW1wdHMgdG8gcmVidWlsZCB0aGUgYXBwbGljYXRpb24gd2l0aCBlcnJvciByZWNvdmVyeVxuICAgKiBSZXF1aXJlbWVudCAzLjQ6IEFkZCBidWlsZCBlcnJvciByZWNvdmVyeSBhbmQgcmV0cnkgbWVjaGFuaXNtc1xuICAgKi9cbiAgYXN5bmMgcmVidWlsZFdpdGhSZWNvdmVyeShtYXhSZXRyaWVzID0gMyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGxldCBhdHRlbXB0ID0gMDtcblxuICAgIHdoaWxlIChhdHRlbXB0IDwgbWF4UmV0cmllcykge1xuICAgICAgYXR0ZW1wdCsrO1xuICAgICAgdGhpcy5sb2dnZXIoYEJ1aWxkIGF0dGVtcHQgJHthdHRlbXB0fS8ke21heFJldHJpZXN9YCk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIENsZWFuIGJ1aWxkIGRpcmVjdG9yeSBiZWZvcmUgcmV0cnlcbiAgICAgICAgaWYgKGF0dGVtcHQgPiAxKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5jbGVhbkJ1aWxkKCk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5yZXBhaXJCdWlsZCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQXR0ZW1wdCBidWlsZFxuICAgICAgICBleGVjU3luYygneWFybiBidWlsZCcsIHtcbiAgICAgICAgICBzdGRpbzogJ3BpcGUnLFxuICAgICAgICAgIHRpbWVvdXQ6IDMwMDAwMCwgLy8gNSBtaW51dGUgdGltZW91dFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBWYWxpZGF0ZSBidWlsZCBhZnRlciBjb21wbGV0aW9uXG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnZhbGlkYXRlQnVpbGQoKTtcbiAgICAgICAgaWYgKHZhbGlkYXRpb24uaXNWYWxpZCkge1xuICAgICAgICAgIHRoaXMubG9nZ2VyKGBCdWlsZCBzdWNjZXNzZnVsIG9uIGF0dGVtcHQgJHthdHRlbXB0fWApO1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubG9nZ2VyKFxuICAgICAgICAgICAgYEJ1aWxkIGNvbXBsZXRlZCBidXQgdmFsaWRhdGlvbiBmYWlsZWQgb24gYXR0ZW1wdCAke2F0dGVtcHR9YFxuICAgICAgICAgICk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5yZXBhaXJCdWlsZCgpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlcihgQnVpbGQgZmFpbGVkIG9uIGF0dGVtcHQgJHthdHRlbXB0fTpgLCBlcnJvcik7XG5cbiAgICAgICAgaWYgKGF0dGVtcHQgPCBtYXhSZXRyaWVzKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIoYFJldHJ5aW5nIGJ1aWxkIGluIDUgc2Vjb25kcy4uLmApO1xuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDAwKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlcihgQnVpbGQgZmFpbGVkIGFmdGVyICR7bWF4UmV0cmllc30gYXR0ZW1wdHNgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW5zIHRoZSBidWlsZCBkaXJlY3RvcnlcbiAgICovXG4gIGFzeW5jIGNsZWFuQnVpbGQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKHRoaXMuYnVpbGREaXIpKSB7XG4gICAgICAgIGZzLnJtU3luYyh0aGlzLmJ1aWxkRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gICAgICAgIHRoaXMubG9nZ2VyKCdCdWlsZCBkaXJlY3RvcnkgY2xlYW5lZCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlcignRXJyb3IgY2xlYW5pbmcgYnVpbGQgZGlyZWN0b3J5OicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBkZWZhdWx0IGNvbnRlbnQgZm9yIG1hbmlmZXN0IGZpbGVzXG4gICAqIFJlcXVpcmVtZW50IDMuMzogQ3JlYXRlIG1pc3NpbmcgbWFuaWZlc3QgZmlsZXMgd2l0aCBtaW5pbWFsIGNvbnRlbnQgd2hlbiBuZWVkZWRcbiAgICovXG4gIHByaXZhdGUgZ2V0TWFuaWZlc3REZWZhdWx0cygpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4ge1xuICAgICAgJ3BhZ2VzLW1hbmlmZXN0Lmpzb24nOiB7fSxcbiAgICAgICdhcHAtcGF0aHMtbWFuaWZlc3QuanNvbic6IHt9LFxuICAgICAgJ25leHQtZm9udC1tYW5pZmVzdC5qc29uJzoge1xuICAgICAgICBwYWdlczoge30sXG4gICAgICAgIGFwcDoge30sXG4gICAgICAgIGFwcFVzaW5nU2l6ZUFkanVzdDogZmFsc2UsXG4gICAgICAgIHBhZ2VzVXNpbmdTaXplQWRqdXN0OiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICAnbWlkZGxld2FyZS1tYW5pZmVzdC5qc29uJzoge1xuICAgICAgICBzb3J0ZWRNaWRkbGV3YXJlOiBbXSxcbiAgICAgICAgbWlkZGxld2FyZToge30sXG4gICAgICAgIGZ1bmN0aW9uczoge30sXG4gICAgICAgIHZlcnNpb246IDIsXG4gICAgICB9LFxuICAgICAgJ2J1aWxkLW1hbmlmZXN0Lmpzb24nOiB7XG4gICAgICAgIGRldkZpbGVzOiBbXSxcbiAgICAgICAgYW1wRGV2RmlsZXM6IFtdLFxuICAgICAgICBwb2x5ZmlsbEZpbGVzOiBbXSxcbiAgICAgICAgbG93UHJpb3JpdHlGaWxlczogW10sXG4gICAgICAgIHJvb3RNYWluRmlsZXM6IFtdLFxuICAgICAgICBwYWdlczoge30sXG4gICAgICAgIGFtcEZpcnN0UGFnZXM6IFtdLFxuICAgICAgfSxcbiAgICAgICdhcHAtYnVpbGQtbWFuaWZlc3QuanNvbic6IHtcbiAgICAgICAgcGFnZXM6IHt9LFxuICAgICAgfSxcbiAgICAgICdyZWFjdC1sb2FkYWJsZS1tYW5pZmVzdC5qc29uJzoge30sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgTmV4dC5qcyBjb25maWd1cmF0aW9uIGlzIHByb3Blcmx5IHNldCB1cFxuICAgKiBSZXF1aXJlbWVudCAzLjE6IEZpeCBOZXh0LmpzIGNvbmZpZ3VyYXRpb24gdG8gcHJvcGVybHkgZ2VuZXJhdGUgbWFuaWZlc3QgZmlsZXNcbiAgICovXG4gIHZhbGlkYXRlTmV4dENvbmZpZygpOiBOZXh0Q29uZmlnVmFsaWRhdGlvblJlc3VsdCB7XG4gICAgY29uc3QgcmVzdWx0OiBOZXh0Q29uZmlnVmFsaWRhdGlvblJlc3VsdCA9IHtcbiAgICAgIGlzVmFsaWQ6IHRydWUsXG4gICAgICBpc3N1ZXM6IFtdLFxuICAgICAgcmVjb21tZW5kYXRpb25zOiBbXSxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIG5leHQuY29uZmlnLmpzIGV4aXN0c1xuICAgICAgY29uc3QgY29uZmlnUGF0aHMgPSBbXG4gICAgICAgICduZXh0LmNvbmZpZy5qcycsXG4gICAgICAgICduZXh0LmNvbmZpZy5tanMnLFxuICAgICAgICAnbmV4dC5jb25maWcudHMnLFxuICAgICAgXTtcbiAgICAgIGNvbnN0IGV4aXN0aW5nQ29uZmlnID0gY29uZmlnUGF0aHMuZmluZChwYXRoID0+IGZzLmV4aXN0c1N5bmMocGF0aCkpO1xuXG4gICAgICBpZiAoIWV4aXN0aW5nQ29uZmlnKSB7XG4gICAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgIHJlc3VsdC5pc3N1ZXMucHVzaCgnTm8gTmV4dC5qcyBjb25maWd1cmF0aW9uIGZpbGUgZm91bmQnKTtcbiAgICAgICAgcmVzdWx0LnJlY29tbWVuZGF0aW9ucy5wdXNoKFxuICAgICAgICAgICdDcmVhdGUgbmV4dC5jb25maWcuanMgd2l0aCBwcm9wZXIgYnVpbGQgc2V0dGluZ3MnXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlYWQgYW5kIHZhbGlkYXRlIGNvbmZpZ3VyYXRpb25cbiAgICAgIGNvbnN0IGNvbmZpZ0NvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoZXhpc3RpbmdDb25maWcsICd1dGY4Jyk7XG5cbiAgICAgIC8vIENoZWNrIGZvciBlc3NlbnRpYWwgY29uZmlndXJhdGlvbiBvcHRpb25zXG4gICAgICBjb25zdCBlc3NlbnRpYWxDb25maWdzID0gWydvdXRwdXQnLCAndHlwZXNjcmlwdCcsICdlc2xpbnQnXTtcblxuICAgICAgZm9yIChjb25zdCBjb25maWcgb2YgZXNzZW50aWFsQ29uZmlncykge1xuICAgICAgICBpZiAoIWNvbmZpZ0NvbnRlbnQuaW5jbHVkZXMoY29uZmlnKSkge1xuICAgICAgICAgIHJlc3VsdC5yZWNvbW1lbmRhdGlvbnMucHVzaChcbiAgICAgICAgICAgIGBDb25zaWRlciBhZGRpbmcgJHtjb25maWd9IGNvbmZpZ3VyYXRpb24gZm9yIGJldHRlciBidWlsZCBzdGFiaWxpdHlgXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgYnVpbGQgb3B0aW1pemF0aW9uIHNldHRpbmdzXG4gICAgICBpZiAoIWNvbmZpZ0NvbnRlbnQuaW5jbHVkZXMoJ3dlYnBhY2snKSkge1xuICAgICAgICByZXN1bHQucmVjb21tZW5kYXRpb25zLnB1c2goXG4gICAgICAgICAgJ0NvbnNpZGVyIGFkZGluZyB3ZWJwYWNrIGNvbmZpZ3VyYXRpb24gZm9yIGJ1aWxkIG9wdGltaXphdGlvbidcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIoXG4gICAgICAgIGBOZXh0LmpzIGNvbmZpZyB2YWxpZGF0aW9uIGNvbXBsZXRlZC4gVmFsaWQ6ICR7cmVzdWx0LmlzVmFsaWR9LCBJc3N1ZXM6ICR7cmVzdWx0Lmlzc3Vlcy5sZW5ndGh9YFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVzdWx0LmlzVmFsaWQgPSBmYWxzZTtcbiAgICAgIHJlc3VsdC5pc3N1ZXMucHVzaChgRXJyb3IgcmVhZGluZyBOZXh0LmpzIGNvbmZpZ3VyYXRpb246ICR7ZXJyb3J9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBNb25pdG9ycyBidWlsZCBoZWFsdGggYW5kIHBlcmZvcm1hbmNlXG4gICAqIFJlcXVpcmVtZW50IDMuNTogQWRkIGJ1aWxkIGVycm9yIHJlY292ZXJ5IGFuZCByZXRyeSBtZWNoYW5pc21zXG4gICAqL1xuICBhc3luYyBtb25pdG9yQnVpbGRIZWFsdGgoKTogUHJvbWlzZTxCdWlsZEhlYWx0aFJlcG9ydD4ge1xuICAgIGNvbnN0IHJlcG9ydDogQnVpbGRIZWFsdGhSZXBvcnQgPSB7XG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBidWlsZEV4aXN0czogZnMuZXhpc3RzU3luYyh0aGlzLmJ1aWxkRGlyKSxcbiAgICAgIG1hbmlmZXN0c1ZhbGlkOiBmYWxzZSxcbiAgICAgIGJ1aWxkU2l6ZTogMCxcbiAgICAgIGxhc3RCdWlsZFRpbWU6IG51bGwsXG4gICAgICBpc3N1ZXM6IFtdLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHJlcG9ydC5idWlsZEV4aXN0cykge1xuICAgICAgICAvLyBDYWxjdWxhdGUgYnVpbGQgc2l6ZVxuICAgICAgICByZXBvcnQuYnVpbGRTaXplID0gdGhpcy5jYWxjdWxhdGVEaXJlY3RvcnlTaXplKHRoaXMuYnVpbGREaXIpO1xuXG4gICAgICAgIC8vIENoZWNrIG1hbmlmZXN0IHZhbGlkaXR5XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnZhbGlkYXRlQnVpbGQoKTtcbiAgICAgICAgcmVwb3J0Lm1hbmlmZXN0c1ZhbGlkID0gdmFsaWRhdGlvbi5pc1ZhbGlkO1xuXG4gICAgICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7XG4gICAgICAgICAgcmVwb3J0Lmlzc3Vlcy5wdXNoKFxuICAgICAgICAgICAgLi4udmFsaWRhdGlvbi5taXNzaW5nRmlsZXMubWFwKGZpbGUgPT4gYE1pc3Npbmc6ICR7ZmlsZX1gKVxuICAgICAgICAgICk7XG4gICAgICAgICAgcmVwb3J0Lmlzc3Vlcy5wdXNoKFxuICAgICAgICAgICAgLi4udmFsaWRhdGlvbi5jb3JydXB0ZWRGaWxlcy5tYXAoZmlsZSA9PiBgQ29ycnVwdGVkOiAke2ZpbGV9YClcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2V0IGxhc3QgYnVpbGQgdGltZVxuICAgICAgICBjb25zdCBidWlsZE1hbmlmZXN0UGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgICB0aGlzLmJ1aWxkRGlyLFxuICAgICAgICAgICdidWlsZC1tYW5pZmVzdC5qc29uJ1xuICAgICAgICApO1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhidWlsZE1hbmlmZXN0UGF0aCkpIHtcbiAgICAgICAgICBjb25zdCBzdGF0cyA9IGZzLnN0YXRTeW5jKGJ1aWxkTWFuaWZlc3RQYXRoKTtcbiAgICAgICAgICByZXBvcnQubGFzdEJ1aWxkVGltZSA9IHN0YXRzLm10aW1lO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXBvcnQuaXNzdWVzLnB1c2goJ0J1aWxkIGRpcmVjdG9yeSBkb2VzIG5vdCBleGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXBvcnQuaXNzdWVzLnB1c2goYEhlYWx0aCBjaGVjayBlcnJvcjogJHtlcnJvcn1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVwb3J0O1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgZGlyZWN0b3J5IHNpemUgcmVjdXJzaXZlbHlcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlRGlyZWN0b3J5U2l6ZShkaXJQYXRoOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGxldCBzaXplID0gMDtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGRpclBhdGgpO1xuXG4gICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oZGlyUGF0aCwgZmlsZSk7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gZnMuc3RhdFN5bmMoZmlsZVBhdGgpO1xuXG4gICAgICAgIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgc2l6ZSArPSB0aGlzLmNhbGN1bGF0ZURpcmVjdG9yeVNpemUoZmlsZVBhdGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNpemUgKz0gc3RhdHMuc2l6ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZ25vcmUgZXJyb3JzIGZvciBpbmFjY2Vzc2libGUgZmlsZXNcbiAgICB9XG5cbiAgICByZXR1cm4gc2l6ZTtcbiAgfVxufVxuXG4vLyBUeXBlIGRlZmluaXRpb25zXG5leHBvcnQgaW50ZXJmYWNlIEJ1aWxkVmFsaWRhdGlvblJlc3VsdCB7XG4gIGlzVmFsaWQ6IGJvb2xlYW47XG4gIG1pc3NpbmdGaWxlczogc3RyaW5nW107XG4gIGNvcnJ1cHRlZEZpbGVzOiBzdHJpbmdbXTtcbiAgcmVwYWlyQWN0aW9uczogUmVwYWlyQWN0aW9uW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVwYWlyQWN0aW9uIHtcbiAgdHlwZTogJ2NyZWF0ZScgfCAnZml4JyB8ICdyZW1vdmUnO1xuICB0YXJnZXQ6IHN0cmluZztcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0Q29uZmlnVmFsaWRhdGlvblJlc3VsdCB7XG4gIGlzVmFsaWQ6IGJvb2xlYW47XG4gIGlzc3Vlczogc3RyaW5nW107XG4gIHJlY29tbWVuZGF0aW9uczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVpbGRIZWFsdGhSZXBvcnQge1xuICB0aW1lc3RhbXA6IERhdGU7XG4gIGJ1aWxkRXhpc3RzOiBib29sZWFuO1xuICBtYW5pZmVzdHNWYWxpZDogYm9vbGVhbjtcbiAgYnVpbGRTaXplOiBudW1iZXI7XG4gIGxhc3RCdWlsZFRpbWU6IERhdGUgfCBudWxsO1xuICBpc3N1ZXM6IHN0cmluZ1tdO1xufVxuXG4vLyBFeHBvcnQgZGVmYXVsdCBpbnN0YW5jZVxuZXhwb3J0IGNvbnN0IGJ1aWxkVmFsaWRhdG9yID0gbmV3IEJ1aWxkVmFsaWRhdG9yKCk7XG4iXSwidmVyc2lvbiI6M30=