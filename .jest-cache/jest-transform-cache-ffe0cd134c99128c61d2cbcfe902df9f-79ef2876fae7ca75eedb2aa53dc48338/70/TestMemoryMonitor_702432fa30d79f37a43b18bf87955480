a0cb97cb133f308bac947852137e44dc
"use strict";
/**
 * Test Memory Monitor Utility
 *
 * Provides memory monitoring and management capabilities for test environments.
 * Used in comprehensive validation testing to ensure memory usage stays within limits.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestMemoryMonitor = void 0;
class TestMemoryMonitor {
    snapshots = [];
    startTime;
    memoryLimits;
    constructor(limits) {
        this.startTime = Date.now();
        this.memoryLimits = {
            heapUsed: 200 * 1024 * 1024,
            heapTotal: 300 * 1024 * 1024,
            external: 50 * 1024 * 1024,
            rss: 400 * 1024 * 1024,
            ...limits
        };
    }
    /**
     * Create a memory monitor with default settings
     */
    static createDefault() {
        return new TestMemoryMonitor();
    }
    /**
     * Create a memory monitor with CI-appropriate settings (more restrictive)
     */
    static createForCI() {
        return new TestMemoryMonitor({
            heapUsed: 150 * 1024 * 1024,
            heapTotal: 200 * 1024 * 1024,
            external: 30 * 1024 * 1024,
            rss: 250 * 1024 * 1024, // 250MB
        });
    }
    /**
     * Take a memory snapshot at a specific point in time
     */
    takeSnapshot(testName) {
        const usage = process.memoryUsage();
        const snapshot = {
            timestamp: new Date(),
            testName,
            heapUsed: usage.heapUsed,
            heapTotal: usage.heapTotal,
            external: usage.external,
            arrayBuffers: usage.arrayBuffers,
            rss: usage.rss
        };
        this.snapshots.push(snapshot);
        return snapshot;
    }
    /**
     * Get current memory usage
     */
    getCurrentMemoryUsage() {
        return process.memoryUsage();
    }
    /**
     * Check if current memory usage is within limits
     */
    checkMemoryUsage(_testName) {
        const currentUsage = this.getCurrentMemoryUsage();
        const warnings = [];
        const errors = [];
        // Check against limits
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed * 0.8) {
            warnings.push(`Heap usage approaching limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed) {
            errors.push(`Heap usage exceeded limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapTotal > this.memoryLimits.heapTotal) {
            errors.push(`Heap total exceeded limit: ${(currentUsage.heapTotal / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapTotal / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.external > this.memoryLimits.external) {
            errors.push(`External memory exceeded limit: ${(currentUsage.external / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.external / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.rss > this.memoryLimits.rss) {
            errors.push(`RSS exceeded limit: ${(currentUsage.rss / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.rss / 1024 / 1024).toFixed(2)}MB`);
        }
        return {
            isWithinLimits: errors.length === 0,
            currentUsage,
            warnings,
            errors
        };
    }
    /**
     * Get memory usage summary since monitoring started
     */
    getMemorySummary() {
        if (this.snapshots.length === 0) {
            const current = this.getCurrentMemoryUsage();
            return {
                initialMemory: current.heapUsed / 1024 / 1024,
                currentMemory: current.heapUsed / 1024 / 1024,
                peakMemory: current.heapUsed / 1024 / 1024,
                totalIncrease: 0,
                testDuration: Date.now() - this.startTime
            };
        }
        const initialSnapshot = this.snapshots[0];
        const currentUsage = this.getCurrentMemoryUsage();
        const peakMemory = Math.max(...this.snapshots.map(s => s.heapUsed), currentUsage.heapUsed);
        return {
            initialMemory: initialSnapshot.heapUsed / 1024 / 1024,
            currentMemory: currentUsage.heapUsed / 1024 / 1024,
            peakMemory: peakMemory / 1024 / 1024,
            totalIncrease: (currentUsage.heapUsed - initialSnapshot.heapUsed) / 1024 / 1024,
            testDuration: Date.now() - this.startTime
        };
    }
    /**
     * Get memory usage trend analysis
     */
    getMemoryTrend() {
        if (this.snapshots.length < 3) {
            return {
                isIncreasing: false,
                averageIncrease: 0,
                concerningTrend: false
            };
        }
        const recentSnapshots = this.snapshots.slice(-5); // Last 5 snapshots
        const increases = [];
        for (let i = 1; i < recentSnapshots.length; i++) {
            const increase = recentSnapshots[i].heapUsed - recentSnapshots[i - 1].heapUsed;
            increases.push(increase);
        }
        const averageIncrease = increases.reduce((sum, inc) => sum + inc, 0) / increases.length;
        const isIncreasing = averageIncrease > 0;
        const concerningTrend = averageIncrease > 10 * 1024 * 1024; // More than 10MB average increase
        return {
            isIncreasing,
            averageIncrease: averageIncrease / 1024 / 1024,
            concerningTrend
        };
    }
    /**
     * Perform memory cleanup and optimization
     */
    cleanup(testName) {
        const beforeCleanup = this.getCurrentMemoryUsage();
        const actions = [];
        try {
            // Clear any test-specific caches
            if (global.__TEST_CACHE__) {
                if (typeof global.__TEST_CACHE__.clear === 'function') {
                    global.__TEST_CACHE__.clear();
                    actions.push('Cleared test cache');
                }
            }
            // Clear test references
            if (global.__TEST_REFS__) {
                global.__TEST_REFS__.length = 0;
                actions.push('Cleared test references');
            }
            // Force garbage collection if available
            if (global.gc) {
                global.gc();
                actions.push('Forced garbage collection');
            }
            // Clear Jest mocks and modules
            if (jest) {
                jest.clearAllMocks();
                actions.push('Cleared Jest mocks');
                if (jest.resetModules) {
                    jest.resetModules();
                    actions.push('Reset Jest modules');
                }
            }
            const afterCleanup = this.getCurrentMemoryUsage();
            const freedMemory = (beforeCleanup.heapUsed - afterCleanup.heapUsed) / 1024 / 1024;
            // Take snapshot after cleanup
            this.takeSnapshot(`${testName}-cleanup`);
            return {
                success: true,
                freedMemory: `${freedMemory.toFixed(2)}MB`,
                actions
            };
        }
        catch (error) {
            console.error('Memory cleanup failed:', error);
            return {
                success: false,
                freedMemory: '0MB',
                actions: [...actions, `Cleanup failed: ${error.message}`]
            };
        }
    }
    /**
     * Get detailed memory report
     */
    getDetailedReport() {
        const summary = this.getMemorySummary();
        const trend = this.getMemoryTrend();
        const recommendations = [];
        // Generate recommendations based on analysis
        if (summary.totalIncrease > 50) {
            recommendations.push('Consider reducing test complexity or adding more cleanup');
        }
        if (trend.concerningTrend) {
            recommendations.push('Memory usage is increasing rapidly - investigate memory leaks');
        }
        if (summary.peakMemory > 150) {
            recommendations.push('Peak memory usage is high - consider splitting tests');
        }
        if (this.snapshots.length > 100) {
            recommendations.push('Many snapshots taken - consider reducing monitoring frequency');
        }
        return {
            summary,
            trend,
            snapshots: this.snapshots,
            recommendations
        };
    }
    /**
     * Reset monitoring state
     */
    reset() {
        this.snapshots = [];
        this.startTime = Date.now();
    }
    /**
     * Export memory data for analysis
     */
    exportData() {
        return {
            metadata: {
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Date.now() - this.startTime,
                snapshotCount: this.snapshots.length
            },
            snapshots: this.snapshots,
            summary: this.getMemorySummary()
        };
    }
}
exports.TestMemoryMonitor = TestMemoryMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvVGVzdE1lbW9yeU1vbml0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUEyQkgsTUFBYSxpQkFBaUI7SUFDcEIsU0FBUyxHQUFxQixFQUFFLENBQUM7SUFDakMsU0FBUyxDQUFTO0lBQ2xCLFlBQVksQ0FLbEI7SUFFRixZQUFZLE1BQW1EO1FBQzdELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsUUFBUSxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMzQixTQUFTLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzVCLFFBQVEsRUFBRSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDMUIsR0FBRyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUN0QixHQUFHLE1BQU07U0FDVixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGFBQWE7UUFDbEIsT0FBTyxJQUFJLGlCQUFpQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVc7UUFDaEIsT0FBTyxJQUFJLGlCQUFpQixDQUFDO1lBQzNCLFFBQVEsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDM0IsU0FBUyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUM1QixRQUFRLEVBQUUsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzFCLEdBQUcsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUksRUFBUyxRQUFRO1NBQ3hDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxRQUFnQjtRQUMzQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENB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QUcsR0FBRyxFQUFFO1lBQzVCLGVBQWUsQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztTQUM5RTtRQUVELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQy9CLGVBQWUsQ0FBQyxJQUFJLENBQUMsK0RBQStELENBQUMsQ0FBQztTQUN2RjtRQUVELE9BQU87WUFDTCxPQUFPO1lBQ1AsS0FBSztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixlQUFlO1NBQ2hCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsVUFBVTtRQVVSLE9BQU87WUFDTCxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUztnQkFDckMsYUFBYSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTTthQUNyQztZQUNELFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1NBQ2pDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1U0QsOENBNFNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvX190ZXN0c19fL3V0aWxzL1Rlc3RNZW1vcnlNb25pdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdCBNZW1vcnkgTW9uaXRvciBVdGlsaXR5XG4gKiBcbiAqIFByb3ZpZGVzIG1lbW9yeSBtb25pdG9yaW5nIGFuZCBtYW5hZ2VtZW50IGNhcGFiaWxpdGllcyBmb3IgdGVzdCBlbnZpcm9ubWVudHMuXG4gKiBVc2VkIGluIGNvbXByZWhlbnNpdmUgdmFsaWRhdGlvbiB0ZXN0aW5nIHRvIGVuc3VyZSBtZW1vcnkgdXNhZ2Ugc3RheXMgd2l0aGluIGxpbWl0cy5cbiAqL1xuXG5pbnRlcmZhY2UgTWVtb3J5U25hcHNob3Qge1xuICB0aW1lc3RhbXA6IERhdGU7XG4gIHRlc3ROYW1lOiBzdHJpbmc7XG4gIGhlYXBVc2VkOiBudW1iZXI7XG4gIGhlYXBUb3RhbDogbnVtYmVyO1xuICBleHRlcm5hbDogbnVtYmVyO1xuICBhcnJheUJ1ZmZlcnM6IG51bWJlcjtcbiAgcnNzOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBNZW1vcnlDaGVjayB7XG4gIGlzV2l0aGluTGltaXRzOiBib29sZWFuO1xuICBjdXJyZW50VXNhZ2U6IE5vZGVKUy5NZW1vcnlVc2FnZTtcbiAgd2FybmluZ3M6IHN0cmluZ1tdO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgTWVtb3J5U3VtbWFyeSB7XG4gIGluaXRpYWxNZW1vcnk6IG51bWJlcjtcbiAgY3VycmVudE1lbW9yeTogbnVtYmVyO1xuICBwZWFrTWVtb3J5OiBudW1iZXI7XG4gIHRvdGFsSW5jcmVhc2U6IG51bWJlcjtcbiAgdGVzdER1cmF0aW9uOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBUZXN0TWVtb3J5TW9uaXRvciB7XG4gIHByaXZhdGUgc25hcHNob3RzOiBNZW1vcnlTbmFwc2hvdFtdID0gW107XG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XG4gIHByaXZhdGUgbWVtb3J5TGltaXRzOiB7XG4gICAgaGVhcFVzZWQ6IG51bWJlcjtcbiAgICBoZWFwVG90YWw6IG51bWJlcjtcbiAgICBleHRlcm5hbDogbnVtYmVyO1xuICAgIHJzczogbnVtYmVyO1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKGxpbWl0cz86IFBhcnRpYWw8VGVzdE1lbW9yeU1vbml0b3JbJ21lbW9yeUxpbWl0cyddPikge1xuICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1lbW9yeUxpbWl0cyA9IHtcbiAgICAgIGhlYXBVc2VkOiAyMDAgKiAxMDI0ICogMTAyNCwgICAvLyAyMDBNQlxuICAgICAgaGVhcFRvdGFsOiAzMDAgKiAxMDI0ICogMTAyNCwgIC8vIDMwME1CXG4gICAgICBleHRlcm5hbDogNTAgKiAxMDI0ICogMTAyNCwgICAgLy8gNTBNQlxuICAgICAgcnNzOiA0MDAgKiAxMDI0ICogMTAyNCwgICAgICAgIC8vIDQwME1CXG4gICAgICAuLi5saW1pdHNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG1lbW9yeSBtb25pdG9yIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZURlZmF1bHQoKTogVGVzdE1lbW9yeU1vbml0b3Ige1xuICAgIHJldHVybiBuZXcgVGVzdE1lbW9yeU1vbml0b3IoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBtZW1vcnkgbW9uaXRvciB3aXRoIENJLWFwcHJvcHJpYXRlIHNldHRpbmdzIChtb3JlIHJlc3RyaWN0aXZlKVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZUZvckNJKCk6IFRlc3RNZW1vcnlNb25pdG9yIHtcbiAgICByZXR1cm4gbmV3IFRlc3RNZW1vcnlNb25pdG9yKHtcbiAgICAgIGhlYXBVc2VkOiAxNTAgKiAxMDI0ICogMTAyNCwgICAvLyAxNTBNQlxuICAgICAgaGVhcFRvdGFsOiAyMDAgKiAxMDI0ICogMTAyNCwgIC8vIDIwME1CXG4gICAgICBleHRlcm5hbDogMzAgKiAxMDI0ICogMTAyNCwgICAgLy8gMzBNQlxuICAgICAgcnNzOiAyNTAgKiAxMDI0ICogMTAyNCwgICAgICAgIC8vIDI1ME1CXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVGFrZSBhIG1lbW9yeSBzbmFwc2hvdCBhdCBhIHNwZWNpZmljIHBvaW50IGluIHRpbWVcbiAgICovXG4gIHRha2VTbmFwc2hvdCh0ZXN0TmFtZTogc3RyaW5nKTogTWVtb3J5U25hcHNob3Qge1xuICAgIGNvbnN0IHVzYWdlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IHNuYXBzaG90OiBNZW1vcnlTbmFwc2hvdCA9IHtcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHRlc3ROYW1lLFxuICAgICAgaGVhcFVzZWQ6IHVzYWdlLmhlYXBVc2VkLFxuICAgICAgaGVhcFRvdGFsOiB1c2FnZS5oZWFwVG90YWwsXG4gICAgICBleHRlcm5hbDogdXNhZ2UuZXh0ZXJuYWwsXG4gICAgICBhcnJheUJ1ZmZlcnM6IHVzYWdlLmFycmF5QnVmZmVycyxcbiAgICAgIHJzczogdXNhZ2UucnNzXG4gICAgfTtcblxuICAgIHRoaXMuc25hcHNob3RzLnB1c2goc25hcHNob3QpO1xuICAgIHJldHVybiBzbmFwc2hvdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBtZW1vcnkgdXNhZ2VcbiAgICovXG4gIGdldEN1cnJlbnRNZW1vcnlVc2FnZSgpOiBOb2RlSlMuTWVtb3J5VXNhZ2Uge1xuICAgIHJldHVybiBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgY3VycmVudCBtZW1vcnkgdXNhZ2UgaXMgd2l0aGluIGxpbWl0c1xuICAgKi9cbiAgY2hlY2tNZW1vcnlVc2FnZShfdGVzdE5hbWU6IHN0cmluZyk6IE1lbW9yeUNoZWNrIHtcbiAgICBjb25zdCBjdXJyZW50VXNhZ2UgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IHdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIENoZWNrIGFnYWluc3QgbGltaXRzXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5oZWFwVXNlZCA+IHRoaXMubWVtb3J5TGltaXRzLmhlYXBVc2VkICogMC44KSB7XG4gICAgICB3YXJuaW5ncy5wdXNoKGBIZWFwIHVzYWdlIGFwcHJvYWNoaW5nIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UuaGVhcFVzZWQgPiB0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVXNlZCkge1xuICAgICAgZXJyb3JzLnB1c2goYEhlYXAgdXNhZ2UgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UuaGVhcFRvdGFsID4gdGhpcy5tZW1vcnlMaW1pdHMuaGVhcFRvdGFsKSB7XG4gICAgICBlcnJvcnMucHVzaChgSGVhcCB0b3RhbCBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLmhlYXBUb3RhbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMuaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgKTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudFVzYWdlLmV4dGVybmFsID4gdGhpcy5tZW1vcnlMaW1pdHMuZXh0ZXJuYWwpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBFeHRlcm5hbCBtZW1vcnkgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMuZXh0ZXJuYWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UucnNzID4gdGhpcy5tZW1vcnlMaW1pdHMucnNzKSB7XG4gICAgICBlcnJvcnMucHVzaChgUlNTIGV4Y2VlZGVkIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UucnNzIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5yc3MgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc1dpdGhpbkxpbWl0czogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIGN1cnJlbnRVc2FnZSxcbiAgICAgIHdhcm5pbmdzLFxuICAgICAgZXJyb3JzXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbWVtb3J5IHVzYWdlIHN1bW1hcnkgc2luY2UgbW9uaXRvcmluZyBzdGFydGVkXG4gICAqL1xuICBnZXRNZW1vcnlTdW1tYXJ5KCk6IE1lbW9yeVN1bW1hcnkge1xuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaW5pdGlhbE1lbW9yeTogY3VycmVudC5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgICBjdXJyZW50TWVtb3J5OiBjdXJyZW50LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICAgIHBlYWtNZW1vcnk6IGN1cnJlbnQuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgICAgdG90YWxJbmNyZWFzZTogMCxcbiAgICAgICAgdGVzdER1cmF0aW9uOiBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWVcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgaW5pdGlhbFNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdHNbMF07XG4gICAgY29uc3QgY3VycmVudFVzYWdlID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICBjb25zdCBwZWFrTWVtb3J5ID0gTWF0aC5tYXgoLi4udGhpcy5zbmFwc2hvdHMubWFwKHMgPT4gcy5oZWFwVXNlZCksIGN1cnJlbnRVc2FnZS5oZWFwVXNlZCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaW5pdGlhbE1lbW9yeTogaW5pdGlhbFNuYXBzaG90LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICBjdXJyZW50TWVtb3J5OiBjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgIHBlYWtNZW1vcnk6IHBlYWtNZW1vcnkgLyAxMDI0IC8gMTAyNCxcbiAgICAgIHRvdGFsSW5jcmVhc2U6IChjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLSBpbml0aWFsU25hcHNob3QuaGVhcFVzZWQpIC8gMTAyNCAvIDEwMjQsXG4gICAgICB0ZXN0RHVyYXRpb246IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1lbW9yeSB1c2FnZSB0cmVuZCBhbmFseXNpc1xuICAgKi9cbiAgZ2V0TWVtb3J5VHJlbmQoKToge1xuICAgIGlzSW5jcmVhc2luZzogYm9vbGVhbjtcbiAgICBhdmVyYWdlSW5jcmVhc2U6IG51bWJlcjtcbiAgICBjb25jZXJuaW5nVHJlbmQ6IGJvb2xlYW47XG4gIH0ge1xuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPCAzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0luY3JlYXNpbmc6IGZhbHNlLFxuICAgICAgICBhdmVyYWdlSW5jcmVhc2U6IDAsXG4gICAgICAgIGNvbmNlcm5pbmdUcmVuZDogZmFsc2VcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcmVjZW50U25hcHNob3RzID0gdGhpcy5zbmFwc2hvdHMuc2xpY2UoLTUpOyAvLyBMYXN0IDUgc25hcHNob3RzXG4gICAgY29uc3QgaW5jcmVhc2VzOiBudW1iZXJbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCByZWNlbnRTbmFwc2hvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGluY3JlYXNlID0gcmVjZW50U25hcHNob3RzW2ldLmhlYXBVc2VkIC0gcmVjZW50U25hcHNob3RzW2kgLSAxXS5oZWFwVXNlZDtcbiAgICAgIGluY3JlYXNlcy5wdXNoKGluY3JlYXNlKTtcbiAgICB9XG5cbiAgICBjb25zdCBhdmVyYWdlSW5jcmVhc2UgPSBpbmNyZWFzZXMucmVkdWNlKChzdW0sIGluYykgPT4gc3VtICsgaW5jLCAwKSAvIGluY3JlYXNlcy5sZW5ndGg7XG4gICAgY29uc3QgaXNJbmNyZWFzaW5nID0gYXZlcmFnZUluY3JlYXNlID4gMDtcbiAgICBjb25zdCBjb25jZXJuaW5nVHJlbmQgPSBhdmVyYWdlSW5jcmVhc2UgPiAxMCAqIDEwMjQgKiAxMDI0OyAvLyBNb3JlIHRoYW4gMTBNQiBhdmVyYWdlIGluY3JlYXNlXG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNJbmNyZWFzaW5nLFxuICAgICAgYXZlcmFnZUluY3JlYXNlOiBhdmVyYWdlSW5jcmVhc2UgLyAxMDI0IC8gMTAyNCwgLy8gQ29udmVydCB0byBNQlxuICAgICAgY29uY2VybmluZ1RyZW5kXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIG1lbW9yeSBjbGVhbnVwIGFuZCBvcHRpbWl6YXRpb25cbiAgICovXG4gIGNsZWFudXAodGVzdE5hbWU6IHN0cmluZyk6IHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIGZyZWVkTWVtb3J5OiBzdHJpbmc7XG4gICAgYWN0aW9uczogc3RyaW5nW107XG4gIH0ge1xuICAgIGNvbnN0IGJlZm9yZUNsZWFudXAgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IGFjdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2xlYXIgYW55IHRlc3Qtc3BlY2lmaWMgY2FjaGVzXG4gICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9DQUNIRV9fKSB7XG4gICAgICAgIGlmICh0eXBlb2YgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyKCk7XG4gICAgICAgICAgYWN0aW9ucy5wdXNoKCdDbGVhcmVkIHRlc3QgY2FjaGUnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciB0ZXN0IHJlZmVyZW5jZXNcbiAgICAgIGlmIChnbG9iYWwuX19URVNUX1JFRlNfXykge1xuICAgICAgICBnbG9iYWwuX19URVNUX1JFRlNfXy5sZW5ndGggPSAwO1xuICAgICAgICBhY3Rpb25zLnB1c2goJ0NsZWFyZWQgdGVzdCByZWZlcmVuY2VzJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbiBpZiBhdmFpbGFibGVcbiAgICAgIGlmIChnbG9iYWwuZ2MpIHtcbiAgICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgICAgIGFjdGlvbnMucHVzaCgnRm9yY2VkIGdhcmJhZ2UgY29sbGVjdGlvbicpO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciBKZXN0IG1vY2tzIGFuZCBtb2R1bGVzXG4gICAgICBpZiAoamVzdCkge1xuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICAgICAgYWN0aW9ucy5wdXNoKCdDbGVhcmVkIEplc3QgbW9ja3MnKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChqZXN0LnJlc2V0TW9kdWxlcykge1xuICAgICAgICAgIGplc3QucmVzZXRNb2R1bGVzKCk7XG4gICAgICAgICAgYWN0aW9ucy5wdXNoKCdSZXNldCBKZXN0IG1vZHVsZXMnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBhZnRlckNsZWFudXAgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgICAgY29uc3QgZnJlZWRNZW1vcnkgPSAoYmVmb3JlQ2xlYW51cC5oZWFwVXNlZCAtIGFmdGVyQ2xlYW51cC5oZWFwVXNlZCkgLyAxMDI0IC8gMTAyNDtcblxuICAgICAgLy8gVGFrZSBzbmFwc2hvdCBhZnRlciBjbGVhbnVwXG4gICAgICB0aGlzLnRha2VTbmFwc2hvdChgJHt0ZXN0TmFtZX0tY2xlYW51cGApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBmcmVlZE1lbW9yeTogYCR7ZnJlZWRNZW1vcnkudG9GaXhlZCgyKX1NQmAsXG4gICAgICAgIGFjdGlvbnNcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ01lbW9yeSBjbGVhbnVwIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZnJlZWRNZW1vcnk6ICcwTUInLFxuICAgICAgICBhY3Rpb25zOiBbLi4uYWN0aW9ucywgYENsZWFudXAgZmFpbGVkOiAkeyhlcnJvciBhcyBFcnJvcikubWVzc2FnZX1gXVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRldGFpbGVkIG1lbW9yeSByZXBvcnRcbiAgICovXG4gIGdldERldGFpbGVkUmVwb3J0KCk6IHtcbiAgICBzdW1tYXJ5OiBNZW1vcnlTdW1tYXJ5O1xuICAgIHRyZW5kOiBSZXR1cm5UeXBlPFRlc3RNZW1vcnlNb25pdG9yWydnZXRNZW1vcnlUcmVuZCddPjtcbiAgICBzbmFwc2hvdHM6IE1lbW9yeVNuYXBzaG90W107XG4gICAgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXTtcbiAgfSB7XG4gICAgY29uc3Qgc3VtbWFyeSA9IHRoaXMuZ2V0TWVtb3J5U3VtbWFyeSgpO1xuICAgIGNvbnN0IHRyZW5kID0gdGhpcy5nZXRNZW1vcnlUcmVuZCgpO1xuICAgIGNvbnN0IHJlY29tbWVuZGF0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIEdlbmVyYXRlIHJlY29tbWVuZGF0aW9ucyBiYXNlZCBvbiBhbmFseXNpc1xuICAgIGlmIChzdW1tYXJ5LnRvdGFsSW5jcmVhc2UgPiA1MCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ0NvbnNpZGVyIHJlZHVjaW5nIHRlc3QgY29tcGxleGl0eSBvciBhZGRpbmcgbW9yZSBjbGVhbnVwJyk7XG4gICAgfVxuXG4gICAgaWYgKHRyZW5kLmNvbmNlcm5pbmdUcmVuZCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ01lbW9yeSB1c2FnZSBpcyBpbmNyZWFzaW5nIHJhcGlkbHkgLSBpbnZlc3RpZ2F0ZSBtZW1vcnkgbGVha3MnKTtcbiAgICB9XG5cbiAgICBpZiAoc3VtbWFyeS5wZWFrTWVtb3J5ID4gMTUwKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnUGVhayBtZW1vcnkgdXNhZ2UgaXMgaGlnaCAtIGNvbnNpZGVyIHNwbGl0dGluZyB0ZXN0cycpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPiAxMDApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdNYW55IHNuYXBzaG90cyB0YWtlbiAtIGNvbnNpZGVyIHJlZHVjaW5nIG1vbml0b3JpbmcgZnJlcXVlbmN5Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1bW1hcnksXG4gICAgICB0cmVuZCxcbiAgICAgIHNuYXBzaG90czogdGhpcy5zbmFwc2hvdHMsXG4gICAgICByZWNvbW1lbmRhdGlvbnNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IG1vbml0b3Jpbmcgc3RhdGVcbiAgICovXG4gIHJlc2V0KCk6IHZvaWQge1xuICAgIHRoaXMuc25hcHNob3RzID0gW107XG4gICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCBtZW1vcnkgZGF0YSBmb3IgYW5hbHlzaXNcbiAgICovXG4gIGV4cG9ydERhdGEoKToge1xuICAgIG1ldGFkYXRhOiB7XG4gICAgICBzdGFydFRpbWU6IG51bWJlcjtcbiAgICAgIGVuZFRpbWU6IG51bWJlcjtcbiAgICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gICAgICBzbmFwc2hvdENvdW50OiBudW1iZXI7XG4gICAgfTtcbiAgICBzbmFwc2hvdHM6IE1lbW9yeVNuYXBzaG90W107XG4gICAgc3VtbWFyeTogTWVtb3J5U3VtbWFyeTtcbiAgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHN0YXJ0VGltZTogdGhpcy5zdGFydFRpbWUsXG4gICAgICAgIGVuZFRpbWU6IERhdGUubm93KCksXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWUsXG4gICAgICAgIHNuYXBzaG90Q291bnQ6IHRoaXMuc25hcHNob3RzLmxlbmd0aFxuICAgICAgfSxcbiAgICAgIHNuYXBzaG90czogdGhpcy5zbmFwc2hvdHMsXG4gICAgICBzdW1tYXJ5OiB0aGlzLmdldE1lbW9yeVN1bW1hcnkoKVxuICAgIH07XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=