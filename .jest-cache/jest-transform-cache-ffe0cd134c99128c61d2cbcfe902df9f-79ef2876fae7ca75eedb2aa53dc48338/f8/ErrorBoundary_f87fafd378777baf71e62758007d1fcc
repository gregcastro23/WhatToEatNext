e7070f6f836756935f9a0fb8545ab29c
"use strict";
'use client';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AsyncErrorBoundary = exports.useErrorHandler = exports.withErrorBoundary = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const logger_1 = require("@/utils/logger");
// Default fallback component with user-friendly error messages
const DefaultErrorFallback = (0, react_1.memo)(function DefaultErrorFallback({ error, errorInfo, onRetry, retryCount, maxRetries = 3 }) {
    const isDevelopment = process.env.NODE_ENV === 'development';
    return ((0, jsx_runtime_1.jsxs)("div", { className: "bg-red-50 border border-red-200 rounded-lg p-6 m-4", children: [(0, jsx_runtime_1.jsxs)("div", { className: "flex items-center space-x-2 mb-4", children: [(0, jsx_runtime_1.jsx)("div", { className: "flex-shrink-0", children: (0, jsx_runtime_1.jsx)("svg", { className: "h-5 w-5 text-red-400", viewBox: "0 0 20 20", fill: "currentColor", children: (0, jsx_runtime_1.jsx)("path", { fillRule: "evenodd", d: "M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z", clipRule: "evenodd" }) }) }), (0, jsx_runtime_1.jsx)("h3", { className: "text-lg font-medium text-red-800", children: "Something went wrong" })] }), (0, jsx_runtime_1.jsxs)("div", { className: "mb-4", children: [(0, jsx_runtime_1.jsx)("p", { className: "text-red-700 mb-2", children: "We encountered an unexpected error. This has been logged and we're working to fix it." }), isDevelopment && ((0, jsx_runtime_1.jsxs)("details", { className: "mt-4", children: [(0, jsx_runtime_1.jsx)("summary", { className: "cursor-pointer text-red-600 font-medium mb-2", children: "Technical Details (Development Mode)" }), (0, jsx_runtime_1.jsxs)("div", { className: "bg-red-100 p-3 rounded border text-sm font-mono", children: [(0, jsx_runtime_1.jsxs)("div", { className: "mb-2", children: [(0, jsx_runtime_1.jsx)("strong", { children: "Error:" }), " ", error.message] }), (0, jsx_runtime_1.jsxs)("div", { className: "mb-2", children: [(0, jsx_runtime_1.jsx)("strong", { children: "Stack:" }), (0, jsx_runtime_1.jsx)("pre", { className: "whitespace-pre-wrap text-xs mt-1", children: error.stack })] }), errorInfo.componentStack && ((0, jsx_runtime_1.jsxs)("div", { children: [(0, jsx_runtime_1.jsx)("strong", { children: "Component Stack:" }), (0, jsx_runtime_1.jsx)("pre", { className: "whitespace-pre-wrap text-xs mt-1", children: errorInfo.componentStack })] }))] })] }))] }), (0, jsx_runtime_1.jsxs)("div", { className: "flex items-center space-x-3", children: [retryCount < maxRetries && ((0, jsx_runtime_1.jsxs)("button", { onClick: onRetry, className: "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2", children: ["Try Again (", maxRetries - retryCount, " attempts left)"] })), (0, jsx_runtime_1.jsx)("button", { onClick: () => window.location.reload(), className: "bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2", children: "Reload Page" }), retryCount >= maxRetries && ((0, jsx_runtime_1.jsx)("p", { className: "text-red-600 text-sm", children: "Maximum retry attempts reached. Please reload the page or contact support." }))] })] }));
});
class ErrorBoundary extends react_1.Component {
    constructor(props) {
        super(props);
        this.resetTimeoutId = null;
        this.resetErrorBoundary = () => {
            if (this.resetTimeoutId) {
                clearTimeout(this.resetTimeoutId);
            }
            this.setState(prevState => ({
                hasError: false,
                error: null,
                errorInfo: null,
                errorId: '',
                retryCount: prevState.retryCount + 1,
                lastResetKeys: this.props.resetKeys
            }));
        };
        this.handleRetry = () => {
            // Add a small delay before retrying to prevent rapid retry loops
            this.resetTimeoutId = window.setTimeout(() => {
                this.resetErrorBoundary();
            }, 100);
        };
        this.state = {
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: 0,
            lastResetKeys: props.resetKeys
        };
    }
    static getDerivedStateFromError(error) {
        // Generate unique error ID for tracking
        const errorId = `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        return {
            hasError: true,
            error,
            errorId
        };
    }
    componentDidCatch(error, errorInfo) {
        // Log error details
        logger_1.logger.error('ErrorBoundary caught an error:', {
            error: error.message,
            stack: error.stack,
            componentStack: errorInfo.componentStack,
            errorId: this.state.errorId,
            retryCount: this.state.retryCount
        });
        // Update state with error info
        this.setState({
            errorInfo
        });
        // Call custom error handler if provided
        if (this.props.onError) {
            this.props.onError(error, errorInfo);
        }
        // Report to external error tracking service if available
        if (typeof window !== 'undefined' && window.reportError) {
            window.reportError(error, {
                componentStack: errorInfo.componentStack,
                errorId: this.state.errorId
            });
        }
    }
    componentDidUpdate(prevProps) {
        const { resetKeys, resetOnPropsChange } = this.props;
        const { hasError, lastResetKeys } = this.state;
        // Reset error state if resetKeys have changed
        if (hasError && resetKeys && lastResetKeys) {
            const hasResetKeyChanged = resetKeys.some((key, index) => key !== lastResetKeys[index]);
            if (hasResetKeyChanged) {
                this.resetErrorBoundary();
            }
        }
        // Reset error state if resetOnPropsChange is true and props have changed
        if (hasError && resetOnPropsChange && prevProps !== this.props) {
            this.resetErrorBoundary();
        }
    }
    componentWillUnmount() {
        if (this.resetTimeoutId) {
            clearTimeout(this.resetTimeoutId);
        }
    }
    render() {
        const { hasError, error, errorInfo, retryCount } = this.state;
        const { children, fallback, isolate } = this.props;
        if (hasError && error && errorInfo) {
            // Use custom fallback if provided
            if (fallback) {
                return fallback(error, errorInfo);
            }
            // Use default fallback
            return ((0, jsx_runtime_1.jsx)(DefaultErrorFallback, { error: error, errorInfo: errorInfo, onRetry: this.handleRetry, retryCount: retryCount }));
        }
        // If isolate is true, wrap children in an additional error boundary
        if (isolate) {
            return ((0, jsx_runtime_1.jsx)("div", { className: "error-boundary-isolation", children: children }));
        }
        return children;
    }
}
exports.default = ErrorBoundary;
// Higher-order component for easy error boundary wrapping
function withErrorBoundary(Component, errorBoundaryProps) {
    const WrappedComponent = (props) => ((0, jsx_runtime_1.jsx)(ErrorBoundary, { ...errorBoundaryProps, children: (0, jsx_runtime_1.jsx)(Component, { ...props }) }));
    WrappedComponent.displayName = `withErrorBoundary(${Component.displayName || Component.name})`;
    return WrappedComponent;
}
exports.withErrorBoundary = withErrorBoundary;
// Hook for programmatic error reporting
function useErrorHandler() {
    const reportError = react_1.default.useCallback((error, context) => {
        logger_1.logger.error('Manual error report:', {
            error: error.message,
            stack: error.stack,
            context,
            timestamp: new Date().toISOString()
        });
        // Report to external service if available
        if (typeof window !== 'undefined' && window.reportError) {
            window.reportError(error, context);
        }
    }, []);
    return { reportError };
}
exports.useErrorHandler = useErrorHandler;
// Async error boundary for handling promise rejections
class AsyncErrorBoundary extends react_1.Component {
    constructor(props) {
        super(props);
        this.handleUnhandledRejection = (event) => {
            const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));
            this.setState({
                hasError: true,
                error,
                errorInfo: { componentStack: 'Async Error (Promise Rejection)' },
                errorId: `async_error_${Date.now()}`
            });
            logger_1.logger.error('Unhandled promise rejection:', {
                error: error.message,
                stack: error.stack,
                reason: event.reason
            });
            // Prevent the default browser behavior
            event.preventDefault();
        };
        this.state = {
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: 0
        };
    }
    componentDidMount() {
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', this.handleUnhandledRejection);
    }
    componentWillUnmount() {
        window.removeEventListener('unhandledrejection', this.handleUnhandledRejection);
    }
    render() {
        // Use the same rendering logic as ErrorBoundary
        const { hasError, error, errorInfo } = this.state;
        const { children, fallback } = this.props;
        if (hasError && error && errorInfo) {
            if (fallback) {
                return fallback(error, errorInfo);
            }
            return ((0, jsx_runtime_1.jsx)(DefaultErrorFallback, { error: error, errorInfo: errorInfo, onRetry: () => this.setState({ hasError: false, error: null, errorInfo: null }), retryCount: this.state.retryCount }));
        }
        return children;
    }
}
exports.AsyncErrorBoundary = AsyncErrorBoundary;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9jb21wb25lbnRzL2Vycm9yLWJvdW5kYXJpZXMvRXJyb3JCb3VuZGFyeS50c3giLCJtYXBwaW5ncyI6IjtBQUFBLFlBQVksQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRWIsK0NBQXFFO0FBQ3JFLDJDQUF3QztBQW9CeEMsK0RBQStEO0FBQy9ELE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxZQUFJLEVBQUMsU0FBUyxvQkFBb0IsQ0FBQyxFQUM5RCxLQUFLLEVBQ0wsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsVUFBVSxHQUFHLENBQUMsRUFPZjtJQUNDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsQ0FBQztJQUU3RCxPQUFPLENBQ0wsaUNBQUssU0FBUyxFQUFDLG9EQUFvRCxhQUNqRSxpQ0FBSyxTQUFTLEVBQUMsa0NBQWtDLGFBQy9DLGdDQUFLLFNBQVMsRUFBQyxlQUFlLFlBQzVCLGdDQUFLLFNBQVMsRUFBQyxzQkFBc0IsRUFBQyxPQUFPLEVBQUMsV0FBVyxFQUFDLElBQUksRUFBQyxjQUFjLFlBQzNFLGlDQUFNLFFBQVEsRUFBQyxTQUFTLEVBQUMsQ0FBQyxFQUFDLHlOQUF5TixFQUFDLFFBQVEsRUFBQyxTQUFTLEdBQUcsR0FDdFEsR0FDRixFQUNOLCtCQUFJLFNBQVMsRUFBQyxrQ0FBa0MscUNBRTNDLElBQ0QsRUFFTixpQ0FBSyxTQUFTLEVBQUMsTUFBTSxhQUNuQiw4QkFBRyxTQUFTLEVBQUMsbUJBQW1CLHNHQUU1QixFQUVILGFBQWEsSUFBSSxDQUNoQixxQ0FBUyxTQUFTLEVBQUMsTUFBTSxhQUN2QixvQ0FBUyxTQUFTLEVBQUMsOENBQThDLHFEQUV2RCxFQUNWLGlDQUFLLFNBQVMsRUFBQyxpREFBaUQsYUFDOUQsaUNBQUssU0FBUyxFQUFDLE1BQU0sYUFDbkIsd0RBQXVCLE9BQUUsS0FBSyxDQUFDLE9BQU8sSUFDbEMsRUFD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QUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFMUMsSUFBSSxRQUFRLElBQUksS0FBSyxJQUFJLFNBQVMsRUFBRTtZQUNsQyxJQUFJLFFBQVEsRUFBRTtnQkFDWixPQUFPLFFBQVEsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDbkM7WUFFRCxPQUFPLENBQ0wsdUJBQUMsb0JBQW9CLElBQ25CLEtBQUssRUFBRSxLQUFLLEVBQ1osU0FBUyxFQUFFLFNBQVMsRUFDcEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQy9FLFVBQVUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FDakMsQ0FDSCxDQUFDO1NBQ0g7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0NBQ0Y7QUFsRUQsZ0RBa0VDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvY29tcG9uZW50cy9lcnJvci1ib3VuZGFyaWVzL0Vycm9yQm91bmRhcnkudHN4Il0sInNvdXJjZXNDb250ZW50IjpbIid1c2UgY2xpZW50JztcblxuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCwgRXJyb3JJbmZvLCBSZWFjdE5vZGUsIG1lbW8gfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAL3V0aWxzL2xvZ2dlcic7XG5cbmludGVyZmFjZSBFcnJvckJvdW5kYXJ5UHJvcHMge1xuICBjaGlsZHJlbjogUmVhY3ROb2RlO1xuICBmYWxsYmFjaz86IChlcnJvcjogRXJyb3IsIGVycm9ySW5mbzogRXJyb3JJbmZvKSA9PiBSZWFjdE5vZGU7XG4gIG9uRXJyb3I/OiAoZXJyb3I6IEVycm9yLCBlcnJvckluZm86IEVycm9ySW5mbykgPT4gdm9pZDtcbiAgcmVzZXRPblByb3BzQ2hhbmdlPzogYm9vbGVhbjtcbiAgcmVzZXRLZXlzPzogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPjtcbiAgaXNvbGF0ZT86IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBFcnJvckJvdW5kYXJ5U3RhdGUge1xuICBoYXNFcnJvcjogYm9vbGVhbjtcbiAgZXJyb3I6IEVycm9yIHwgbnVsbDtcbiAgZXJyb3JJbmZvOiBFcnJvckluZm8gfCBudWxsO1xuICBlcnJvcklkOiBzdHJpbmc7XG4gIHJldHJ5Q291bnQ6IG51bWJlcjtcbiAgbGFzdFJlc2V0S2V5cz86IEFycmF5PHN0cmluZyB8IG51bWJlcj47XG59XG5cbi8vIERlZmF1bHQgZmFsbGJhY2sgY29tcG9uZW50IHdpdGggdXNlci1mcmllbmRseSBlcnJvciBtZXNzYWdlc1xuY29uc3QgRGVmYXVsdEVycm9yRmFsbGJhY2sgPSBtZW1vKGZ1bmN0aW9uIERlZmF1bHRFcnJvckZhbGxiYWNrKHsgXG4gIGVycm9yLCBcbiAgZXJyb3JJbmZvLCBcbiAgb25SZXRyeSwgXG4gIHJldHJ5Q291bnQsXG4gIG1heFJldHJpZXMgPSAzIFxufToge1xuICBlcnJvcjogRXJyb3I7XG4gIGVycm9ySW5mbzogRXJyb3JJbmZvO1xuICBvblJldHJ5OiAoKSA9PiB2b2lkO1xuICByZXRyeUNvdW50OiBudW1iZXI7XG4gIG1heFJldHJpZXM/OiBudW1iZXI7XG59KSB7XG4gIGNvbnN0IGlzRGV2ZWxvcG1lbnQgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JztcbiAgXG4gIHJldHVybiAoXG4gICAgPGRpdiBjbGFzc05hbWU9XCJiZy1yZWQtNTAgYm9yZGVyIGJvcmRlci1yZWQtMjAwIHJvdW5kZWQtbGcgcC02IG0tNFwiPlxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGl0ZW1zLWNlbnRlciBzcGFjZS14LTIgbWItNFwiPlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXgtc2hyaW5rLTBcIj5cbiAgICAgICAgICA8c3ZnIGNsYXNzTmFtZT1cImgtNSB3LTUgdGV4dC1yZWQtNDAwXCIgdmlld0JveD1cIjAgMCAyMCAyMFwiIGZpbGw9XCJjdXJyZW50Q29sb3JcIj5cbiAgICAgICAgICAgIDxwYXRoIGZpbGxSdWxlPVwiZXZlbm9kZFwiIGQ9XCJNMTAgMThhOCA4IDAgMTAwLTE2IDggOCAwIDAwMCAxNnpNOC43MDcgNy4yOTNhMSAxIDAgMDAtMS40MTQgMS40MTRMOC41ODYgMTBsLTEuMjkzIDEuMjkzYTEgMSAwIDEwMS40MTQgMS40MTRMMTAgMTEuNDE0bDEuMjkzIDEuMjkzYTEgMSAwIDAwMS40MTQtMS40MTRMMTEuNDE0IDEwbDEuMjkzLTEuMjkzYTEgMSAwIDAwLTEuNDE0LTEuNDE0TDEwIDguNTg2IDguNzA3IDcuMjkzelwiIGNsaXBSdWxlPVwiZXZlbm9kZFwiIC8+XG4gICAgICAgICAgPC9zdmc+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8aDMgY2xhc3NOYW1lPVwidGV4dC1sZyBmb250LW1lZGl1bSB0ZXh0LXJlZC04MDBcIj5cbiAgICAgICAgICBTb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgICAgICA8L2gzPlxuICAgICAgPC9kaXY+XG4gICAgICBcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwibWItNFwiPlxuICAgICAgICA8cCBjbGFzc05hbWU9XCJ0ZXh0LXJlZC03MDAgbWItMlwiPlxuICAgICAgICAgIFdlIGVuY291bnRlcmVkIGFuIHVuZXhwZWN0ZWQgZXJyb3IuIFRoaXMgaGFzIGJlZW4gbG9nZ2VkIGFuZCB3ZSdyZSB3b3JraW5nIHRvIGZpeCBpdC5cbiAgICAgICAgPC9wPlxuICAgICAgICBcbiAgICAgICAge2lzRGV2ZWxvcG1lbnQgJiYgKFxuICAgICAgICAgIDxkZXRhaWxzIGNsYXNzTmFtZT1cIm10LTRcIj5cbiAgICAgICAgICAgIDxzdW1tYXJ5IGNsYXNzTmFtZT1cImN1cnNvci1wb2ludGVyIHRleHQtcmVkLTYwMCBmb250LW1lZGl1bSBtYi0yXCI+XG4gICAgICAgICAgICAgIFRlY2huaWNhbCBEZXRhaWxzIChEZXZlbG9wbWVudCBNb2RlKVxuICAgICAgICAgICAgPC9zdW1tYXJ5PlxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJiZy1yZWQtMTAwIHAtMyByb3VuZGVkIGJvcmRlciB0ZXh0LXNtIGZvbnQtbW9ub1wiPlxuICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm1iLTJcIj5cbiAgICAgICAgICAgICAgICA8c3Ryb25nPkVycm9yOjwvc3Ryb25nPiB7ZXJyb3IubWVzc2FnZX1cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibWItMlwiPlxuICAgICAgICAgICAgICAgIDxzdHJvbmc+U3RhY2s6PC9zdHJvbmc+XG4gICAgICAgICAgICAgICAgPHByZSBjbGFzc05hbWU9XCJ3aGl0ZXNwYWNlLXByZS13cmFwIHRleHQteHMgbXQtMVwiPlxuICAgICAgICAgICAgICAgICAge2Vycm9yLnN0YWNrfVxuICAgICAgICAgICAgICAgIDwvcHJlPlxuICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAge2Vycm9ySW5mby5jb21wb25lbnRTdGFjayAmJiAoXG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgIDxzdHJvbmc+Q29tcG9uZW50IFN0YWNrOjwvc3Ryb25nPlxuICAgICAgICAgICAgICAgICAgPHByZSBjbGFzc05hbWU9XCJ3aGl0ZXNwYWNlLXByZS13cmFwIHRleHQteHMgbXQtMVwiPlxuICAgICAgICAgICAgICAgICAgICB7ZXJyb3JJbmZvLmNvbXBvbmVudFN0YWNrfVxuICAgICAgICAgICAgICAgICAgPC9wcmU+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L2RldGFpbHM+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICAgIFxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGl0ZW1zLWNlbnRlciBzcGFjZS14LTNcIj5cbiAgICAgICAge3JldHJ5Q291bnQgPCBtYXhSZXRyaWVzICYmIChcbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBvbkNsaWNrPXtvblJldHJ5fVxuICAgICAgICAgICAgY2xhc3NOYW1lPVwiYmctcmVkLTYwMCB0ZXh0LXdoaXRlIHB4LTQgcHktMiByb3VuZGVkIGhvdmVyOmJnLXJlZC03MDAgdHJhbnNpdGlvbi1jb2xvcnMgZm9jdXM6b3V0bGluZS1ub25lIGZvY3VzOnJpbmctMiBmb2N1czpyaW5nLXJlZC01MDAgZm9jdXM6cmluZy1vZmZzZXQtMlwiXG4gICAgICAgICAgPlxuICAgICAgICAgICAgVHJ5IEFnYWluICh7bWF4UmV0cmllcyAtIHJldHJ5Q291bnR9IGF0dGVtcHRzIGxlZnQpXG4gICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICl9XG4gICAgICAgIFxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgb25DbGljaz17KCkgPT4gd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpfVxuICAgICAgICAgIGNsYXNzTmFtZT1cImJnLWdyYXktNjAwIHRleHQtd2hpdGUgcHgtNCBweS0yIHJvdW5kZWQgaG92ZXI6YmctZ3JheS03MDAgdHJhbnNpdGlvbi1jb2xvcnMgZm9jdXM6b3V0bGluZS1ub25lIGZvY3VzOnJpbmctMiBmb2N1czpyaW5nLWdyYXktNTAwIGZvY3VzOnJpbmctb2Zmc2V0LTJcIlxuICAgICAgICA+XG4gICAgICAgICAgUmVsb2FkIFBhZ2VcbiAgICAgICAgPC9idXR0b24+XG4gICAgICAgIFxuICAgICAgICB7cmV0cnlDb3VudCA+PSBtYXhSZXRyaWVzICYmIChcbiAgICAgICAgICA8cCBjbGFzc05hbWU9XCJ0ZXh0LXJlZC02MDAgdGV4dC1zbVwiPlxuICAgICAgICAgICAgTWF4aW11bSByZXRyeSBhdHRlbXB0cyByZWFjaGVkLiBQbGVhc2UgcmVsb2FkIHRoZSBwYWdlIG9yIGNvbnRhY3Qgc3VwcG9ydC5cbiAgICAgICAgICA8L3A+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgKTtcbn0pO1xuXG5jbGFzcyBFcnJvckJvdW5kYXJ5IGV4dGVuZHMgQ29tcG9uZW50PEVycm9yQm91bmRhcnlQcm9wcywgRXJyb3JCb3VuZGFyeVN0YXRlPiB7XG4gIHByaXZhdGUgcmVzZXRUaW1lb3V0SWQ6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBFcnJvckJvdW5kYXJ5UHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgIGVycm9yOiBudWxsLFxuICAgICAgZXJyb3JJbmZvOiBudWxsLFxuICAgICAgZXJyb3JJZDogJycsXG4gICAgICByZXRyeUNvdW50OiAwLFxuICAgICAgbGFzdFJlc2V0S2V5czogcHJvcHMucmVzZXRLZXlzXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3I6IEVycm9yKTogUGFydGlhbDxFcnJvckJvdW5kYXJ5U3RhdGU+IHtcbiAgICAvLyBHZW5lcmF0ZSB1bmlxdWUgZXJyb3IgSUQgZm9yIHRyYWNraW5nXG4gICAgY29uc3QgZXJyb3JJZCA9IGBlcnJvcl8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIGhhc0Vycm9yOiB0cnVlLFxuICAgICAgZXJyb3IsXG4gICAgICBlcnJvcklkXG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudERpZENhdGNoKGVycm9yOiBFcnJvciwgZXJyb3JJbmZvOiBFcnJvckluZm8pIHtcbiAgICAvLyBMb2cgZXJyb3IgZGV0YWlsc1xuICAgIGxvZ2dlci5lcnJvcignRXJyb3JCb3VuZGFyeSBjYXVnaHQgYW4gZXJyb3I6Jywge1xuICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICBjb21wb25lbnRTdGFjazogZXJyb3JJbmZvLmNvbXBvbmVudFN0YWNrLFxuICAgICAgZXJyb3JJZDogdGhpcy5zdGF0ZS5lcnJvcklkLFxuICAgICAgcmV0cnlDb3VudDogdGhpcy5zdGF0ZS5yZXRyeUNvdW50XG4gICAgfSk7XG5cbiAgICAvLyBVcGRhdGUgc3RhdGUgd2l0aCBlcnJvciBpbmZvXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBlcnJvckluZm9cbiAgICB9KTtcblxuICAgIC8vIENhbGwgY3VzdG9tIGVycm9yIGhhbmRsZXIgaWYgcHJvdmlkZWRcbiAgICBpZiAodGhpcy5wcm9wcy5vbkVycm9yKSB7XG4gICAgICB0aGlzLnByb3BzLm9uRXJyb3IoZXJyb3IsIGVycm9ySW5mbyk7XG4gICAgfVxuXG4gICAgLy8gUmVwb3J0IHRvIGV4dGVybmFsIGVycm9yIHRyYWNraW5nIHNlcnZpY2UgaWYgYXZhaWxhYmxlXG4gICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICh3aW5kb3cgYXMgYW55KS5yZXBvcnRFcnJvcikge1xuICAgICAgKHdpbmRvdyBhcyBhbnkpLnJlcG9ydEVycm9yKGVycm9yLCB7XG4gICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8uY29tcG9uZW50U3RhY2ssXG4gICAgICAgIGVycm9ySWQ6IHRoaXMuc3RhdGUuZXJyb3JJZFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wczogRXJyb3JCb3VuZGFyeVByb3BzKSB7XG4gICAgY29uc3QgeyByZXNldEtleXMsIHJlc2V0T25Qcm9wc0NoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGhhc0Vycm9yLCBsYXN0UmVzZXRLZXlzIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgLy8gUmVzZXQgZXJyb3Igc3RhdGUgaWYgcmVzZXRLZXlzIGhhdmUgY2hhbmdlZFxuICAgIGlmIChoYXNFcnJvciAmJiByZXNldEtleXMgJiYgbGFzdFJlc2V0S2V5cykge1xuICAgICAgY29uc3QgaGFzUmVzZXRLZXlDaGFuZ2VkID0gcmVzZXRLZXlzLnNvbWUoKGtleSwgaW5kZXgpID0+IFxuICAgICAgICBrZXkgIT09IGxhc3RSZXNldEtleXNbaW5kZXhdXG4gICAgICApO1xuXG4gICAgICBpZiAoaGFzUmVzZXRLZXlDaGFuZ2VkKSB7XG4gICAgICAgIHRoaXMucmVzZXRFcnJvckJvdW5kYXJ5KCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gUmVzZXQgZXJyb3Igc3RhdGUgaWYgcmVzZXRPblByb3BzQ2hhbmdlIGlzIHRydWUgYW5kIHByb3BzIGhhdmUgY2hhbmdlZFxuICAgIGlmIChoYXNFcnJvciAmJiByZXNldE9uUHJvcHNDaGFuZ2UgJiYgcHJldlByb3BzICE9PSB0aGlzLnByb3BzKSB7XG4gICAgICB0aGlzLnJlc2V0RXJyb3JCb3VuZGFyeSgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGlmICh0aGlzLnJlc2V0VGltZW91dElkKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5yZXNldFRpbWVvdXRJZCk7XG4gICAgfVxuICB9XG5cbiAgcmVzZXRFcnJvckJvdW5kYXJ5ID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnJlc2V0VGltZW91dElkKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5yZXNldFRpbWVvdXRJZCk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRTdGF0ZShwcmV2U3RhdGUgPT4gKHtcbiAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgIGVycm9yOiBudWxsLFxuICAgICAgZXJyb3JJbmZvOiBudWxsLFxuICAgICAgZXJyb3JJZDogJycsXG4gICAgICByZXRyeUNvdW50OiBwcmV2U3RhdGUucmV0cnlDb3VudCArIDEsXG4gICAgICBsYXN0UmVzZXRLZXlzOiB0aGlzLnByb3BzLnJlc2V0S2V5c1xuICAgIH0pKTtcbiAgfTtcblxuICBoYW5kbGVSZXRyeSA9ICgpID0+IHtcbiAgICAvLyBBZGQgYSBzbWFsbCBkZWxheSBiZWZvcmUgcmV0cnlpbmcgdG8gcHJldmVudCByYXBpZCByZXRyeSBsb29wc1xuICAgIHRoaXMucmVzZXRUaW1lb3V0SWQgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnJlc2V0RXJyb3JCb3VuZGFyeSgpO1xuICAgIH0sIDEwMCk7XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgaGFzRXJyb3IsIGVycm9yLCBlcnJvckluZm8sIHJldHJ5Q291bnQgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgeyBjaGlsZHJlbiwgZmFsbGJhY2ssIGlzb2xhdGUgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoaGFzRXJyb3IgJiYgZXJyb3IgJiYgZXJyb3JJbmZvKSB7XG4gICAgICAvLyBVc2UgY3VzdG9tIGZhbGxiYWNrIGlmIHByb3ZpZGVkXG4gICAgICBpZiAoZmFsbGJhY2spIHtcbiAgICAgICAgcmV0dXJuIGZhbGxiYWNrKGVycm9yLCBlcnJvckluZm8pO1xuICAgICAgfVxuXG4gICAgICAvLyBVc2UgZGVmYXVsdCBmYWxsYmFja1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPERlZmF1bHRFcnJvckZhbGxiYWNrXG4gICAgICAgICAgZXJyb3I9e2Vycm9yfVxuICAgICAgICAgIGVycm9ySW5mbz17ZXJyb3JJbmZvfVxuICAgICAgICAgIG9uUmV0cnk9e3RoaXMuaGFuZGxlUmV0cnl9XG4gICAgICAgICAgcmV0cnlDb3VudD17cmV0cnlDb3VudH1cbiAgICAgICAgLz5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSWYgaXNvbGF0ZSBpcyB0cnVlLCB3cmFwIGNoaWxkcmVuIGluIGFuIGFkZGl0aW9uYWwgZXJyb3IgYm91bmRhcnlcbiAgICBpZiAoaXNvbGF0ZSkge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJlcnJvci1ib3VuZGFyeS1pc29sYXRpb25cIj5cbiAgICAgICAgICB7Y2hpbGRyZW59XG4gICAgICAgIDwvZGl2PlxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hpbGRyZW47XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRXJyb3JCb3VuZGFyeTtcblxuLy8gSGlnaGVyLW9yZGVyIGNvbXBvbmVudCBmb3IgZWFzeSBlcnJvciBib3VuZGFyeSB3cmFwcGluZ1xuZXhwb3J0IGZ1bmN0aW9uIHdpdGhFcnJvckJvdW5kYXJ5PFAgZXh0ZW5kcyBvYmplY3Q+KFxuICBDb21wb25lbnQ6IFJlYWN0LkNvbXBvbmVudFR5cGU8UD4sXG4gIGVycm9yQm91bmRhcnlQcm9wcz86IE9taXQ8RXJyb3JCb3VuZGFyeVByb3BzLCAnY2hpbGRyZW4nPlxuKSB7XG4gIGNvbnN0IFdyYXBwZWRDb21wb25lbnQgPSAocHJvcHM6IFApID0+IChcbiAgICA8RXJyb3JCb3VuZGFyeSB7Li4uZXJyb3JCb3VuZGFyeVByb3BzfT5cbiAgICAgIDxDb21wb25lbnQgey4uLnByb3BzfSAvPlxuICAgIDwvRXJyb3JCb3VuZGFyeT5cbiAgKTtcblxuICBXcmFwcGVkQ29tcG9uZW50LmRpc3BsYXlOYW1lID0gYHdpdGhFcnJvckJvdW5kYXJ5KCR7Q29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lfSlgO1xuICBcbiAgcmV0dXJuIFdyYXBwZWRDb21wb25lbnQ7XG59XG5cbi8vIEhvb2sgZm9yIHByb2dyYW1tYXRpYyBlcnJvciByZXBvcnRpbmdcbmV4cG9ydCBmdW5jdGlvbiB1c2VFcnJvckhhbmRsZXIoKSB7XG4gIGNvbnN0IHJlcG9ydEVycm9yID0gUmVhY3QudXNlQ2FsbGJhY2soKGVycm9yOiBFcnJvciwgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIGFueT4pID0+IHtcbiAgICBsb2dnZXIuZXJyb3IoJ01hbnVhbCBlcnJvciByZXBvcnQ6Jywge1xuICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICBjb250ZXh0LFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcblxuICAgIC8vIFJlcG9ydCB0byBleHRlcm5hbCBzZXJ2aWNlIGlmIGF2YWlsYWJsZVxuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAod2luZG93IGFzIGFueSkucmVwb3J0RXJyb3IpIHtcbiAgICAgICh3aW5kb3cgYXMgYW55KS5yZXBvcnRFcnJvcihlcnJvciwgY29udGV4dCk7XG4gICAgfVxuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHsgcmVwb3J0RXJyb3IgfTtcbn1cblxuLy8gQXN5bmMgZXJyb3IgYm91bmRhcnkgZm9yIGhhbmRsaW5nIHByb21pc2UgcmVqZWN0aW9uc1xuZXhwb3J0IGNsYXNzIEFzeW5jRXJyb3JCb3VuZGFyeSBleHRlbmRzIENvbXBvbmVudDxcbiAgRXJyb3JCb3VuZGFyeVByb3BzLFxuICBFcnJvckJvdW5kYXJ5U3RhdGVcbj4ge1xuICBjb25zdHJ1Y3Rvcihwcm9wczogRXJyb3JCb3VuZGFyeVByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBoYXNFcnJvcjogZmFsc2UsXG4gICAgICBlcnJvcjogbnVsbCxcbiAgICAgIGVycm9ySW5mbzogbnVsbCxcbiAgICAgIGVycm9ySWQ6ICcnLFxuICAgICAgcmV0cnlDb3VudDogMFxuICAgIH07XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAvLyBIYW5kbGUgdW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uc1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd1bmhhbmRsZWRyZWplY3Rpb24nLCB0aGlzLmhhbmRsZVVuaGFuZGxlZFJlamVjdGlvbik7XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigndW5oYW5kbGVkcmVqZWN0aW9uJywgdGhpcy5oYW5kbGVVbmhhbmRsZWRSZWplY3Rpb24pO1xuICB9XG5cbiAgaGFuZGxlVW5oYW5kbGVkUmVqZWN0aW9uID0gKGV2ZW50OiBQcm9taXNlUmVqZWN0aW9uRXZlbnQpID0+IHtcbiAgICBjb25zdCBlcnJvciA9IGV2ZW50LnJlYXNvbiBpbnN0YW5jZW9mIEVycm9yID8gZXZlbnQucmVhc29uIDogbmV3IEVycm9yKFN0cmluZyhldmVudC5yZWFzb24pKTtcbiAgICBcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGhhc0Vycm9yOiB0cnVlLFxuICAgICAgZXJyb3IsXG4gICAgICBlcnJvckluZm86IHsgY29tcG9uZW50U3RhY2s6ICdBc3luYyBFcnJvciAoUHJvbWlzZSBSZWplY3Rpb24pJyB9IGFzIEVycm9ySW5mbyxcbiAgICAgIGVycm9ySWQ6IGBhc3luY19lcnJvcl8ke0RhdGUubm93KCl9YFxuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmVycm9yKCdVbmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb246Jywge1xuICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICByZWFzb246IGV2ZW50LnJlYXNvblxuICAgIH0pO1xuXG4gICAgLy8gUHJldmVudCB0aGUgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgLy8gVXNlIHRoZSBzYW1lIHJlbmRlcmluZyBsb2dpYyBhcyBFcnJvckJvdW5kYXJ5XG4gICAgY29uc3QgeyBoYXNFcnJvciwgZXJyb3IsIGVycm9ySW5mbyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB7IGNoaWxkcmVuLCBmYWxsYmFjayB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmIChoYXNFcnJvciAmJiBlcnJvciAmJiBlcnJvckluZm8pIHtcbiAgICAgIGlmIChmYWxsYmFjaykge1xuICAgICAgICByZXR1cm4gZmFsbGJhY2soZXJyb3IsIGVycm9ySW5mbyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxEZWZhdWx0RXJyb3JGYWxsYmFja1xuICAgICAgICAgIGVycm9yPXtlcnJvcn1cbiAgICAgICAgICBlcnJvckluZm89e2Vycm9ySW5mb31cbiAgICAgICAgICBvblJldHJ5PXsoKSA9PiB0aGlzLnNldFN0YXRlKHsgaGFzRXJyb3I6IGZhbHNlLCBlcnJvcjogbnVsbCwgZXJyb3JJbmZvOiBudWxsIH0pfVxuICAgICAgICAgIHJldHJ5Q291bnQ9e3RoaXMuc3RhdGUucmV0cnlDb3VudH1cbiAgICAgICAgLz5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNoaWxkcmVuO1xuICB9XG59Il0sInZlcnNpb24iOjN9