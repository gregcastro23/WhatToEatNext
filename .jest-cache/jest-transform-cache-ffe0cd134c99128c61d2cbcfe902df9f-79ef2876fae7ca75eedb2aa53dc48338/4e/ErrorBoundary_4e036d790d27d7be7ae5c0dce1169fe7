811491388e6b4f02b212286f2c81d353
"use strict";
'use client';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AsyncErrorBoundary = exports.useErrorHandler = exports.withErrorBoundary = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const logger_1 = require("@/utils/logger");
// Default fallback component with user-friendly error messages
const DefaultErrorFallback = (0, react_1.memo)(function DefaultErrorFallback({ error, errorInfo, onRetry, retryCount, maxRetries = 3 }) {
    const isDevelopment = process.env.NODE_ENV === 'development';
    return ((0, jsx_runtime_1.jsxs)("div", { className: "bg-red-50 border border-red-200 rounded-lg p-6 m-4", children: [(0, jsx_runtime_1.jsxs)("div", { className: "flex items-center space-x-2 mb-4", children: [(0, jsx_runtime_1.jsx)("div", { className: "flex-shrink-0", children: (0, jsx_runtime_1.jsx)("svg", { className: "h-5 w-5 text-red-400", viewBox: "0 0 20 20", fill: "currentColor", children: (0, jsx_runtime_1.jsx)("path", { fillRule: "evenodd", d: "M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z", clipRule: "evenodd" }) }) }), (0, jsx_runtime_1.jsx)("h3", { className: "text-lg font-medium text-red-800", children: "Something went wrong" })] }), (0, jsx_runtime_1.jsxs)("div", { className: "mb-4", children: [(0, jsx_runtime_1.jsx)("p", { className: "text-red-700 mb-2", children: "We encountered an unexpected error. This has been logged and we're working to fix it." }), isDevelopment && ((0, jsx_runtime_1.jsxs)("details", { className: "mt-4", children: [(0, jsx_runtime_1.jsx)("summary", { className: "cursor-pointer text-red-600 font-medium mb-2", children: "Technical Details (Development Mode)" }), (0, jsx_runtime_1.jsxs)("div", { className: "bg-red-100 p-3 rounded border text-sm font-mono", children: [(0, jsx_runtime_1.jsxs)("div", { className: "mb-2", children: [(0, jsx_runtime_1.jsx)("strong", { children: "Error:" }), " ", error.message] }), (0, jsx_runtime_1.jsxs)("div", { className: "mb-2", children: [(0, jsx_runtime_1.jsx)("strong", { children: "Stack:" }), (0, jsx_runtime_1.jsx)("pre", { className: "whitespace-pre-wrap text-xs mt-1", children: error.stack })] }), errorInfo.componentStack && ((0, jsx_runtime_1.jsxs)("div", { children: [(0, jsx_runtime_1.jsx)("strong", { children: "Component Stack:" }), (0, jsx_runtime_1.jsx)("pre", { className: "whitespace-pre-wrap text-xs mt-1", children: errorInfo.componentStack })] }))] })] }))] }), (0, jsx_runtime_1.jsxs)("div", { className: "flex items-center space-x-3", children: [retryCount < maxRetries && ((0, jsx_runtime_1.jsxs)("button", { onClick: onRetry, className: "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2", children: ["Try Again (", maxRetries - retryCount, " attempts left)"] })), (0, jsx_runtime_1.jsx)("button", { onClick: () => window.location.reload(), className: "bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2", children: "Reload Page" }), retryCount >= maxRetries && ((0, jsx_runtime_1.jsx)("p", { className: "text-red-600 text-sm", children: "Maximum retry attempts reached. Please reload the page or contact support." }))] })] }));
});
class ErrorBoundary extends react_1.Component {
    resetTimeoutId = null;
    constructor(props) {
        super(props);
        this.state = {
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: 0,
            lastResetKeys: props.resetKeys
        };
    }
    static getDerivedStateFromError(error) {
        // Generate unique error ID for tracking
        const errorId = `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        return {
            hasError: true,
            error,
            errorId
        };
    }
    componentDidCatch(error, errorInfo) {
        // Log error details
        logger_1.logger.error('ErrorBoundary caught an error:', {
            error: error.message,
            stack: error.stack,
            componentStack: errorInfo.componentStack,
            errorId: this.state.errorId,
            retryCount: this.state.retryCount
        });
        // Update state with error info
        this.setState({
            errorInfo
        });
        // Call custom error handler if provided
        if (this.props.onError) {
            this.props.onError(error, errorInfo);
        }
        // Report to external error tracking service if available
        if (typeof window !== 'undefined' && window.reportError) {
            window.reportError?.(error, {
                componentStack: errorInfo.componentStack,
                errorId: this.state.errorId
            });
        }
    }
    componentDidUpdate(prevProps) {
        const { resetKeys, resetOnPropsChange } = this.props;
        const { hasError, lastResetKeys } = this.state;
        // Reset error state if resetKeys have changed
        if (hasError && resetKeys && lastResetKeys) {
            const hasResetKeyChanged = resetKeys.some((key, index) => key !== lastResetKeys[index]);
            if (hasResetKeyChanged) {
                this.resetErrorBoundary();
            }
        }
        // Reset error state if resetOnPropsChange is true and props have changed
        if (hasError && resetOnPropsChange && prevProps !== this.props) {
            this.resetErrorBoundary();
        }
    }
    componentWillUnmount() {
        if (this.resetTimeoutId) {
            clearTimeout(this.resetTimeoutId);
        }
    }
    resetErrorBoundary = () => {
        if (this.resetTimeoutId) {
            clearTimeout(this.resetTimeoutId);
        }
        this.setState(prevState => ({
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: prevState.retryCount + 1,
            lastResetKeys: this.props.resetKeys
        }));
    };
    handleRetry = () => {
        // Add a small delay before retrying to prevent rapid retry loops
        this.resetTimeoutId = window.setTimeout(() => {
            this.resetErrorBoundary();
        }, 100);
    };
    render() {
        const { hasError, error, errorInfo, retryCount } = this.state;
        const { children, fallback, isolate } = this.props;
        if (hasError && error && errorInfo) {
            // Use custom fallback if provided
            if (fallback) {
                return fallback(error, errorInfo);
            }
            // Use default fallback
            return ((0, jsx_runtime_1.jsx)(DefaultErrorFallback, { error: error, errorInfo: errorInfo, onRetry: this.handleRetry, retryCount: retryCount }));
        }
        // If isolate is true, wrap children in an additional error boundary
        if (isolate) {
            return ((0, jsx_runtime_1.jsx)("div", { className: "error-boundary-isolation", children: children }));
        }
        return children;
    }
}
exports.default = ErrorBoundary;
// Higher-order component for easy error boundary wrapping
function withErrorBoundary(Component, errorBoundaryProps) {
    const WrappedComponent = (props) => ((0, jsx_runtime_1.jsx)(ErrorBoundary, { ...errorBoundaryProps, children: (0, jsx_runtime_1.jsx)(Component, { ...props }) }));
    WrappedComponent.displayName = `withErrorBoundary(${Component.displayName || Component.name})`;
    return WrappedComponent;
}
exports.withErrorBoundary = withErrorBoundary;
// Hook for programmatic error reporting
function useErrorHandler() {
    const reportError = react_1.default.useCallback((error, context) => {
        logger_1.logger.error('Manual error report:', {
            error: error.message,
            stack: error.stack,
            context,
            timestamp: new Date().toISOString()
        });
        // Report to external service if available
        if (typeof window !== 'undefined' && window.reportError) {
            window.reportError?.(error, context);
        }
    }, []);
    return { reportError };
}
exports.useErrorHandler = useErrorHandler;
// Async error boundary for handling promise rejections
class AsyncErrorBoundary extends react_1.Component {
    constructor(props) {
        super(props);
        this.state = {
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: 0
        };
    }
    componentDidMount() {
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', this.handleUnhandledRejection);
    }
    componentWillUnmount() {
        window.removeEventListener('unhandledrejection', this.handleUnhandledRejection);
    }
    handleUnhandledRejection = (event) => {
        const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));
        this.setState({
            hasError: true,
            error,
            errorInfo: { componentStack: 'Async Error (Promise Rejection)' },
            errorId: `async_error_${Date.now()}`
        });
        logger_1.logger.error('Unhandled promise rejection:', {
            error: error.message,
            stack: error.stack,
            reason: event.reason
        });
        // Prevent the default browser behavior
        event.preventDefault();
    };
    render() {
        // Use the same rendering logic as ErrorBoundary
        const { hasError, error, errorInfo } = this.state;
        const { children, fallback } = this.props;
        if (hasError && error && errorInfo) {
            if (fallback) {
                return fallback(error, errorInfo);
            }
            return ((0, jsx_runtime_1.jsx)(DefaultErrorFallback, { error: error, errorInfo: errorInfo, onRetry: () => this.setState({ hasError: false, error: null, errorInfo: null }), retryCount: this.state.retryCount }));
        }
        return children;
    }
}
exports.AsyncErrorBoundary = AsyncErrorBoundary;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9jb21wb25lbnRzL2Vycm9yLWJvdW5kYXJpZXMvRXJyb3JCb3VuZGFyeS50c3giLCJtYXBwaW5ncyI6IjtBQUFBLFlBQVksQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRWIsK0NBQXFFO0FBRXJFLDJDQUF3QztBQW9CeEMsK0RBQStEO0FBQy9ELE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxZQUFJLEVBQUMsU0FBUyxvQkFBb0IsQ0FBQyxFQUM5RCxLQUFLLEVBQ0wsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsVUFBVSxHQUFHLENBQUMsRUFPZjtJQUNDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsQ0FBQztJQUU3RCxPQUFPLENBQ0wsaUNBQUssU0FBUyxFQUFDLG9EQUFvRCxhQUNqRSxpQ0FBSyxTQUFTLEVBQUMsa0NBQWtDLGFBQy9DLGdDQUFLLFNBQVMsRUFBQyxlQUFlLFlBQzVCLGdDQUFLLFNBQVMsRUFBQyxzQkFBc0IsRUFBQyxPQUFPLEVBQUMsV0FBVyxFQUFDLElBQUksRUFBQyxjQUFjLFlBQzNFLGlDQUFNLFFBQVEsRUFBQyxTQUFTLEVBQUMsQ0FBQyxFQUFDLHlOQUF5TixFQUFDLFFBQVEsRUFBQyxTQUFTLEdBQUcsR0FDdFEsR0FDRixFQUNOLCtCQUFJLFNBQVMsRUFBQyxrQ0FBa0MscUNBRTNDLElBQ0QsRUFFTixpQ0FBSyxTQUFTLEVBQUMsTUFBTSxhQUNuQiw4QkFBRyxTQUFTLEVBQUMsbUJBQW1CLHNHQUU1QixFQUVILGFBQWEsSUFBSSxDQUNoQixxQ0FBUyxTQUFTLEVBQUMsTUFBTSxhQUN2QixvQ0FBUyxTQUFTLEVBQUMsOENBQThDLHFEQUV2RCxFQUNWLGlDQUFLLFNBQVMsRUFBQyxpREFBaUQsYUFDOUQsaUNBQUssU0FBUyxFQUFDLE1BQU0sYUFDbkIsd0RBQXVCLE9BQUUsS0FBSyxDQUFDLE9BQU8sSUFDbEMsRUFD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QUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFMUMsSUFBSSxRQUFRLElBQUksS0FBSyxJQUFJLFNBQVMsRUFBRTtZQUNsQyxJQUFJLFFBQVEsRUFBRTtnQkFDWixPQUFPLFFBQVEsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDbkM7WUFFRCxPQUFPLENBQ0wsdUJBQUMsb0JBQW9CLElBQ25CLEtBQUssRUFBRSxLQUFLLEVBQ1osU0FBUyxFQUFFLFNBQVMsRUFDcEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQy9FLFVBQVUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FDakMsQ0FDSCxDQUFDO1NBQ0g7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0NBQ0Y7QUFsRUQsZ0RBa0VDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvY29tcG9uZW50cy9lcnJvci1ib3VuZGFyaWVzL0Vycm9yQm91bmRhcnkudHN4Il0sInNvdXJjZXNDb250ZW50IjpbIid1c2UgY2xpZW50JztcblxuaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCwgRXJyb3JJbmZvLCBSZWFjdE5vZGUsIG1lbW8gfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ0AvdXRpbHMvbG9nZ2VyJztcblxuaW50ZXJmYWNlIEVycm9yQm91bmRhcnlQcm9wcyB7XG4gIGNoaWxkcmVuOiBSZWFjdE5vZGU7XG4gIGZhbGxiYWNrPzogKGVycm9yOiBFcnJvciwgZXJyb3JJbmZvOiBFcnJvckluZm8pID0+IFJlYWN0Tm9kZTtcbiAgb25FcnJvcj86IChlcnJvcjogRXJyb3IsIGVycm9ySW5mbzogRXJyb3JJbmZvKSA9PiB2b2lkO1xuICByZXNldE9uUHJvcHNDaGFuZ2U/OiBib29sZWFuO1xuICByZXNldEtleXM/OiBBcnJheTxzdHJpbmcgfCBudW1iZXI+O1xuICBpc29sYXRlPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIEVycm9yQm91bmRhcnlTdGF0ZSB7XG4gIGhhc0Vycm9yOiBib29sZWFuO1xuICBlcnJvcjogRXJyb3IgfCBudWxsO1xuICBlcnJvckluZm86IEVycm9ySW5mbyB8IG51bGw7XG4gIGVycm9ySWQ6IHN0cmluZztcbiAgcmV0cnlDb3VudDogbnVtYmVyO1xuICBsYXN0UmVzZXRLZXlzPzogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPjtcbn1cblxuLy8gRGVmYXVsdCBmYWxsYmFjayBjb21wb25lbnQgd2l0aCB1c2VyLWZyaWVuZGx5IGVycm9yIG1lc3NhZ2VzXG5jb25zdCBEZWZhdWx0RXJyb3JGYWxsYmFjayA9IG1lbW8oZnVuY3Rpb24gRGVmYXVsdEVycm9yRmFsbGJhY2soe1xuICBlcnJvcixcbiAgZXJyb3JJbmZvLFxuICBvblJldHJ5LFxuICByZXRyeUNvdW50LFxuICBtYXhSZXRyaWVzID0gM1xufToge1xuICBlcnJvcjogRXJyb3I7XG4gIGVycm9ySW5mbzogRXJyb3JJbmZvO1xuICBvblJldHJ5OiAoKSA9PiB2b2lkO1xuICByZXRyeUNvdW50OiBudW1iZXI7XG4gIG1heFJldHJpZXM/OiBudW1iZXI7XG59KSB7XG4gIGNvbnN0IGlzRGV2ZWxvcG1lbnQgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JztcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPVwiYmctcmVkLTUwIGJvcmRlciBib3JkZXItcmVkLTIwMCByb3VuZGVkLWxnIHAtNiBtLTRcIj5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmxleCBpdGVtcy1jZW50ZXIgc3BhY2UteC0yIG1iLTRcIj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4LXNocmluay0wXCI+XG4gICAgICAgICAgPHN2ZyBjbGFzc05hbWU9XCJoLTUgdy01IHRleHQtcmVkLTQwMFwiIHZpZXdCb3g9XCIwIDAgMjAgMjBcIiBmaWxsPVwiY3VycmVudENvbG9yXCI+XG4gICAgICAgICAgICA8cGF0aCBmaWxsUnVsZT1cImV2ZW5vZGRcIiBkPVwiTTEwIDE4YTggOCAwIDEwMC0xNiA4IDggMCAwMDAgMTZ6TTguNzA3IDcuMjkzYTEgMSAwIDAwLTEuNDE0IDEuNDE0TDguNTg2IDEwbC0xLjI5MyAxLjI5M2ExIDEgMCAxMDEuNDE0IDEuNDE0TDEwIDExLjQxNGwxLjI5MyAxLjI5M2ExIDEgMCAwMDEuNDE0LTEuNDE0TDExLjQxNCAxMGwxLjI5My0xLjI5M2ExIDEgMCAwMC0xLjQxNC0xLjQxNEwxMCA4LjU4NiA4LjcwNyA3LjI5M3pcIiBjbGlwUnVsZT1cImV2ZW5vZGRcIiAvPlxuICAgICAgICAgIDwvc3ZnPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPGgzIGNsYXNzTmFtZT1cInRleHQtbGcgZm9udC1tZWRpdW0gdGV4dC1yZWQtODAwXCI+XG4gICAgICAgICAgU29tZXRoaW5nIHdlbnQgd3JvbmdcbiAgICAgICAgPC9oMz5cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cIm1iLTRcIj5cbiAgICAgICAgPHAgY2xhc3NOYW1lPVwidGV4dC1yZWQtNzAwIG1iLTJcIj5cbiAgICAgICAgICBXZSBlbmNvdW50ZXJlZCBhbiB1bmV4cGVjdGVkIGVycm9yLiBUaGlzIGhhcyBiZWVuIGxvZ2dlZCBhbmQgd2UncmUgd29ya2luZyB0byBmaXggaXQuXG4gICAgICAgIDwvcD5cblxuICAgICAgICB7aXNEZXZlbG9wbWVudCAmJiAoXG4gICAgICAgICAgPGRldGFpbHMgY2xhc3NOYW1lPVwibXQtNFwiPlxuICAgICAgICAgICAgPHN1bW1hcnkgY2xhc3NOYW1lPVwiY3Vyc29yLXBvaW50ZXIgdGV4dC1yZWQtNjAwIGZvbnQtbWVkaXVtIG1iLTJcIj5cbiAgICAgICAgICAgICAgVGVjaG5pY2FsIERldGFpbHMgKERldmVsb3BtZW50IE1vZGUpXG4gICAgICAgICAgICA8L3N1bW1hcnk+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImJnLXJlZC0xMDAgcC0zIHJvdW5kZWQgYm9yZGVyIHRleHQtc20gZm9udC1tb25vXCI+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibWItMlwiPlxuICAgICAgICAgICAgICAgIDxzdHJvbmc+RXJyb3I6PC9zdHJvbmc+IHtlcnJvci5tZXNzYWdlfVxuICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJtYi0yXCI+XG4gICAgICAgICAgICAgICAgPHN0cm9uZz5TdGFjazo8L3N0cm9uZz5cbiAgICAgICAgICAgICAgICA8cHJlIGNsYXNzTmFtZT1cIndoaXRlc3BhY2UtcHJlLXdyYXAgdGV4dC14cyBtdC0xXCI+XG4gICAgICAgICAgICAgICAgICB7ZXJyb3Iuc3RhY2t9XG4gICAgICAgICAgICAgICAgPC9wcmU+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICB7ZXJyb3JJbmZvLmNvbXBvbmVudFN0YWNrICYmIChcbiAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgPHN0cm9uZz5Db21wb25lbnQgU3RhY2s6PC9zdHJvbmc+XG4gICAgICAgICAgICAgICAgICA8cHJlIGNsYXNzTmFtZT1cIndoaXRlc3BhY2UtcHJlLXdyYXAgdGV4dC14cyBtdC0xXCI+XG4gICAgICAgICAgICAgICAgICAgIHtlcnJvckluZm8uY29tcG9uZW50U3RhY2t9XG4gICAgICAgICAgICAgICAgICA8L3ByZT5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvZGV0YWlscz5cbiAgICAgICAgKX1cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXggaXRlbXMtY2VudGVyIHNwYWNlLXgtM1wiPlxuICAgICAgICB7cmV0cnlDb3VudCA8IG1heFJldHJpZXMgJiYgKFxuICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgIG9uQ2xpY2s9e29uUmV0cnl9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJiZy1yZWQtNjAwIHRleHQtd2hpdGUgcHgtNCBweS0yIHJvdW5kZWQgaG92ZXI6YmctcmVkLTcwMCB0cmFuc2l0aW9uLWNvbG9ycyBmb2N1czpvdXRsaW5lLW5vbmUgZm9jdXM6cmluZy0yIGZvY3VzOnJpbmctcmVkLTUwMCBmb2N1czpyaW5nLW9mZnNldC0yXCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICBUcnkgQWdhaW4gKHttYXhSZXRyaWVzIC0gcmV0cnlDb3VudH0gYXR0ZW1wdHMgbGVmdClcbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgKX1cblxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgb25DbGljaz17KCkgPT4gd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpfVxuICAgICAgICAgIGNsYXNzTmFtZT1cImJnLWdyYXktNjAwIHRleHQtd2hpdGUgcHgtNCBweS0yIHJvdW5kZWQgaG92ZXI6YmctZ3JheS03MDAgdHJhbnNpdGlvbi1jb2xvcnMgZm9jdXM6b3V0bGluZS1ub25lIGZvY3VzOnJpbmctMiBmb2N1czpyaW5nLWdyYXktNTAwIGZvY3VzOnJpbmctb2Zmc2V0LTJcIlxuICAgICAgICA+XG4gICAgICAgICAgUmVsb2FkIFBhZ2VcbiAgICAgICAgPC9idXR0b24+XG5cbiAgICAgICAge3JldHJ5Q291bnQgPj0gbWF4UmV0cmllcyAmJiAoXG4gICAgICAgICAgPHAgY2xhc3NOYW1lPVwidGV4dC1yZWQtNjAwIHRleHQtc21cIj5cbiAgICAgICAgICAgIE1heGltdW0gcmV0cnkgYXR0ZW1wdHMgcmVhY2hlZC4gUGxlYXNlIHJlbG9hZCB0aGUgcGFnZSBvciBjb250YWN0IHN1cHBvcnQuXG4gICAgICAgICAgPC9wPlxuICAgICAgICApfVxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICk7XG59KTtcblxuY2xhc3MgRXJyb3JCb3VuZGFyeSBleHRlbmRzIENvbXBvbmVudDxFcnJvckJvdW5kYXJ5UHJvcHMsIEVycm9yQm91bmRhcnlTdGF0ZT4ge1xuICBwcml2YXRlIHJlc2V0VGltZW91dElkOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogRXJyb3JCb3VuZGFyeVByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgIGVycm9yOiBudWxsLFxuICAgICAgZXJyb3JJbmZvOiBudWxsLFxuICAgICAgZXJyb3JJZDogJycsXG4gICAgICByZXRyeUNvdW50OiAwLFxuICAgICAgbGFzdFJlc2V0S2V5czogcHJvcHMucmVzZXRLZXlzXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3I6IEVycm9yKTogUGFydGlhbDxFcnJvckJvdW5kYXJ5U3RhdGU+IHtcbiAgICAvLyBHZW5lcmF0ZSB1bmlxdWUgZXJyb3IgSUQgZm9yIHRyYWNraW5nXG4gICAgY29uc3QgZXJyb3JJZCA9IGBlcnJvcl8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaGFzRXJyb3I6IHRydWUsXG4gICAgICBlcnJvcixcbiAgICAgIGVycm9ySWRcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50RGlkQ2F0Y2goZXJyb3I6IEVycm9yLCBlcnJvckluZm86IEVycm9ySW5mbykge1xuICAgIC8vIExvZyBlcnJvciBkZXRhaWxzXG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvckJvdW5kYXJ5IGNhdWdodCBhbiBlcnJvcjonLCB7XG4gICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8uY29tcG9uZW50U3RhY2ssXG4gICAgICBlcnJvcklkOiB0aGlzLnN0YXRlLmVycm9ySWQsXG4gICAgICByZXRyeUNvdW50OiB0aGlzLnN0YXRlLnJldHJ5Q291bnRcbiAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSBzdGF0ZSB3aXRoIGVycm9yIGluZm9cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGVycm9ySW5mb1xuICAgIH0pO1xuXG4gICAgLy8gQ2FsbCBjdXN0b20gZXJyb3IgaGFuZGxlciBpZiBwcm92aWRlZFxuICAgIGlmICh0aGlzLnByb3BzLm9uRXJyb3IpIHtcbiAgICAgIHRoaXMucHJvcHMub25FcnJvcihlcnJvciwgZXJyb3JJbmZvKTtcbiAgICB9XG5cbiAgICAvLyBSZXBvcnQgdG8gZXh0ZXJuYWwgZXJyb3IgdHJhY2tpbmcgc2VydmljZSBpZiBhdmFpbGFibGVcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHdpbmRvdyBhcyB1bmtub3duIGFzIHsgcmVwb3J0RXJyb3I/OiAoZTogRXJyb3IsIGluZm8/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gdm9pZCB9KS5yZXBvcnRFcnJvcikge1xuICAgICAgKHdpbmRvdyBhcyB1bmtub3duIGFzIHsgcmVwb3J0RXJyb3I/OiAoZTogRXJyb3IsIGluZm8/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gdm9pZCB9KS5yZXBvcnRFcnJvcj8uKGVycm9yLCB7XG4gICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8uY29tcG9uZW50U3RhY2ssXG4gICAgICAgIGVycm9ySWQ6IHRoaXMuc3RhdGUuZXJyb3JJZFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wczogRXJyb3JCb3VuZGFyeVByb3BzKSB7XG4gICAgY29uc3QgeyByZXNldEtleXMsIHJlc2V0T25Qcm9wc0NoYW5nZSB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGhhc0Vycm9yLCBsYXN0UmVzZXRLZXlzIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgLy8gUmVzZXQgZXJyb3Igc3RhdGUgaWYgcmVzZXRLZXlzIGhhdmUgY2hhbmdlZFxuICAgIGlmIChoYXNFcnJvciAmJiByZXNldEtleXMgJiYgbGFzdFJlc2V0S2V5cykge1xuICAgICAgY29uc3QgaGFzUmVzZXRLZXlDaGFuZ2VkID0gcmVzZXRLZXlzLnNvbWUoKGtleSwgaW5kZXgpID0+XG4gICAgICAgIGtleSAhPT0gbGFzdFJlc2V0S2V5c1tpbmRleF1cbiAgICAgICk7XG5cbiAgICAgIGlmIChoYXNSZXNldEtleUNoYW5nZWQpIHtcbiAgICAgICAgdGhpcy5yZXNldEVycm9yQm91bmRhcnkoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBSZXNldCBlcnJvciBzdGF0ZSBpZiByZXNldE9uUHJvcHNDaGFuZ2UgaXMgdHJ1ZSBhbmQgcHJvcHMgaGF2ZSBjaGFuZ2VkXG4gICAgaWYgKGhhc0Vycm9yICYmIHJlc2V0T25Qcm9wc0NoYW5nZSAmJiBwcmV2UHJvcHMgIT09IHRoaXMucHJvcHMpIHtcbiAgICAgIHRoaXMucmVzZXRFcnJvckJvdW5kYXJ5KCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMucmVzZXRUaW1lb3V0SWQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJlc2V0VGltZW91dElkKTtcbiAgICB9XG4gIH1cblxuICByZXNldEVycm9yQm91bmRhcnkgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMucmVzZXRUaW1lb3V0SWQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJlc2V0VGltZW91dElkKTtcbiAgICB9XG5cbiAgICB0aGlzLnNldFN0YXRlKHByZXZTdGF0ZSA9PiAoe1xuICAgICAgaGFzRXJyb3I6IGZhbHNlLFxuICAgICAgZXJyb3I6IG51bGwsXG4gICAgICBlcnJvckluZm86IG51bGwsXG4gICAgICBlcnJvcklkOiAnJyxcbiAgICAgIHJldHJ5Q291bnQ6IHByZXZTdGF0ZS5yZXRyeUNvdW50ICsgMSxcbiAgICAgIGxhc3RSZXNldEtleXM6IHRoaXMucHJvcHMucmVzZXRLZXlzXG4gICAgfSkpO1xuICB9O1xuXG4gIGhhbmRsZVJldHJ5ID0gKCkgPT4ge1xuICAgIC8vIEFkZCBhIHNtYWxsIGRlbGF5IGJlZm9yZSByZXRyeWluZyB0byBwcmV2ZW50IHJhcGlkIHJldHJ5IGxvb3BzXG4gICAgdGhpcy5yZXNldFRpbWVvdXRJZCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMucmVzZXRFcnJvckJvdW5kYXJ5KCk7XG4gICAgfSwgMTAwKTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBoYXNFcnJvciwgZXJyb3IsIGVycm9ySW5mbywgcmV0cnlDb3VudCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB7IGNoaWxkcmVuLCBmYWxsYmFjaywgaXNvbGF0ZSB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmIChoYXNFcnJvciAmJiBlcnJvciAmJiBlcnJvckluZm8pIHtcbiAgICAgIC8vIFVzZSBjdXN0b20gZmFsbGJhY2sgaWYgcHJvdmlkZWRcbiAgICAgIGlmIChmYWxsYmFjaykge1xuICAgICAgICByZXR1cm4gZmFsbGJhY2soZXJyb3IsIGVycm9ySW5mbyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBkZWZhdWx0IGZhbGxiYWNrXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8RGVmYXVsdEVycm9yRmFsbGJhY2tcbiAgICAgICAgICBlcnJvcj17ZXJyb3J9XG4gICAgICAgICAgZXJyb3JJbmZvPXtlcnJvckluZm99XG4gICAgICAgICAgb25SZXRyeT17dGhpcy5oYW5kbGVSZXRyeX1cbiAgICAgICAgICByZXRyeUNvdW50PXtyZXRyeUNvdW50fVxuICAgICAgICAvPlxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBJZiBpc29sYXRlIGlzIHRydWUsIHdyYXAgY2hpbGRyZW4gaW4gYW4gYWRkaXRpb25hbCBlcnJvciBib3VuZGFyeVxuICAgIGlmIChpc29sYXRlKSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImVycm9yLWJvdW5kYXJ5LWlzb2xhdGlvblwiPlxuICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBjaGlsZHJlbjtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFcnJvckJvdW5kYXJ5O1xuXG4vLyBIaWdoZXItb3JkZXIgY29tcG9uZW50IGZvciBlYXN5IGVycm9yIGJvdW5kYXJ5IHdyYXBwaW5nXG5leHBvcnQgZnVuY3Rpb24gd2l0aEVycm9yQm91bmRhcnk8UCBleHRlbmRzIG9iamVjdD4oXG4gIENvbXBvbmVudDogUmVhY3QuQ29tcG9uZW50VHlwZTxQPixcbiAgZXJyb3JCb3VuZGFyeVByb3BzPzogT21pdDxFcnJvckJvdW5kYXJ5UHJvcHMsICdjaGlsZHJlbic+XG4pIHtcbiAgY29uc3QgV3JhcHBlZENvbXBvbmVudCA9IChwcm9wczogUCkgPT4gKFxuICAgIDxFcnJvckJvdW5kYXJ5IHsuLi5lcnJvckJvdW5kYXJ5UHJvcHN9PlxuICAgICAgPENvbXBvbmVudCB7Li4ucHJvcHN9IC8+XG4gICAgPC9FcnJvckJvdW5kYXJ5PlxuICApO1xuXG4gIFdyYXBwZWRDb21wb25lbnQuZGlzcGxheU5hbWUgPSBgd2l0aEVycm9yQm91bmRhcnkoJHtDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWV9KWA7XG5cbiAgcmV0dXJuIFdyYXBwZWRDb21wb25lbnQ7XG59XG5cbi8vIEhvb2sgZm9yIHByb2dyYW1tYXRpYyBlcnJvciByZXBvcnRpbmdcbmV4cG9ydCBmdW5jdGlvbiB1c2VFcnJvckhhbmRsZXIoKSB7XG4gIGNvbnN0IHJlcG9ydEVycm9yID0gUmVhY3QudXNlQ2FsbGJhY2soKGVycm9yOiBFcnJvciwgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB7XG4gICAgbG9nZ2VyLmVycm9yKCdNYW51YWwgZXJyb3IgcmVwb3J0OicsIHtcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgY29udGV4dCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgfSk7XG5cbiAgICAvLyBSZXBvcnQgdG8gZXh0ZXJuYWwgc2VydmljZSBpZiBhdmFpbGFibGVcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHdpbmRvdyBhcyB1bmtub3duIGFzIHsgcmVwb3J0RXJyb3I/OiAoZTogRXJyb3IsIGluZm8/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gdm9pZCB9KS5yZXBvcnRFcnJvcikge1xuICAgICAgKHdpbmRvdyBhcyB1bmtub3duIGFzIHsgcmVwb3J0RXJyb3I/OiAoZTogRXJyb3IsIGluZm8/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4gdm9pZCB9KS5yZXBvcnRFcnJvcj8uKGVycm9yLCBjb250ZXh0KTtcbiAgICB9XG4gIH0sIFtdKTtcblxuICByZXR1cm4geyByZXBvcnRFcnJvciB9O1xufVxuXG4vLyBBc3luYyBlcnJvciBib3VuZGFyeSBmb3IgaGFuZGxpbmcgcHJvbWlzZSByZWplY3Rpb25zXG5leHBvcnQgY2xhc3MgQXN5bmNFcnJvckJvdW5kYXJ5IGV4dGVuZHMgQ29tcG9uZW50PFxuICBFcnJvckJvdW5kYXJ5UHJvcHMsXG4gIEVycm9yQm91bmRhcnlTdGF0ZVxuPiB7XG4gIGNvbnN0cnVjdG9yKHByb3BzOiBFcnJvckJvdW5kYXJ5UHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgIGVycm9yOiBudWxsLFxuICAgICAgZXJyb3JJbmZvOiBudWxsLFxuICAgICAgZXJyb3JJZDogJycsXG4gICAgICByZXRyeUNvdW50OiAwXG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIC8vIEhhbmRsZSB1bmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb25zXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3VuaGFuZGxlZHJlamVjdGlvbicsIHRoaXMuaGFuZGxlVW5oYW5kbGVkUmVqZWN0aW9uKTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd1bmhhbmRsZWRyZWplY3Rpb24nLCB0aGlzLmhhbmRsZVVuaGFuZGxlZFJlamVjdGlvbik7XG4gIH1cblxuICBoYW5kbGVVbmhhbmRsZWRSZWplY3Rpb24gPSAoZXZlbnQ6IFByb21pc2VSZWplY3Rpb25FdmVudCkgPT4ge1xuICAgIGNvbnN0IGVycm9yID0gZXZlbnQucmVhc29uIGluc3RhbmNlb2YgRXJyb3IgPyBldmVudC5yZWFzb24gOiBuZXcgRXJyb3IoU3RyaW5nKGV2ZW50LnJlYXNvbikpO1xuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBoYXNFcnJvcjogdHJ1ZSxcbiAgICAgIGVycm9yLFxuICAgICAgZXJyb3JJbmZvOiB7IGNvbXBvbmVudFN0YWNrOiAnQXN5bmMgRXJyb3IgKFByb21pc2UgUmVqZWN0aW9uKScgfSBhcyBFcnJvckluZm8sXG4gICAgICBlcnJvcklkOiBgYXN5bmNfZXJyb3JfJHtEYXRlLm5vdygpfWBcbiAgICB9KTtcblxuICAgIGxvZ2dlci5lcnJvcignVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOicsIHtcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgcmVhc29uOiBldmVudC5yZWFzb25cbiAgICB9KTtcblxuICAgIC8vIFByZXZlbnQgdGhlIGRlZmF1bHQgYnJvd3NlciBiZWhhdmlvclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIC8vIFVzZSB0aGUgc2FtZSByZW5kZXJpbmcgbG9naWMgYXMgRXJyb3JCb3VuZGFyeVxuICAgIGNvbnN0IHsgaGFzRXJyb3IsIGVycm9yLCBlcnJvckluZm8gfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgeyBjaGlsZHJlbiwgZmFsbGJhY2sgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoaGFzRXJyb3IgJiYgZXJyb3IgJiYgZXJyb3JJbmZvKSB7XG4gICAgICBpZiAoZmFsbGJhY2spIHtcbiAgICAgICAgcmV0dXJuIGZhbGxiYWNrKGVycm9yLCBlcnJvckluZm8pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8RGVmYXVsdEVycm9yRmFsbGJhY2tcbiAgICAgICAgICBlcnJvcj17ZXJyb3J9XG4gICAgICAgICAgZXJyb3JJbmZvPXtlcnJvckluZm99XG4gICAgICAgICAgb25SZXRyeT17KCkgPT4gdGhpcy5zZXRTdGF0ZSh7IGhhc0Vycm9yOiBmYWxzZSwgZXJyb3I6IG51bGwsIGVycm9ySW5mbzogbnVsbCB9KX1cbiAgICAgICAgICByZXRyeUNvdW50PXt0aGlzLnN0YXRlLnJldHJ5Q291bnR9XG4gICAgICAgIC8+XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBjaGlsZHJlbjtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9