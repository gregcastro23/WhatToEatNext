1d4887d5b01c6327783979c8c1afc14e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateElementalEnergies = exports.ElementalCalculator = void 0;
const elements_1 = require("@/types/elements");
const elementalConstants_1 = require("@/constants/elementalConstants");
/**
 * ElementalCalculator class for managing and calculating elemental state
 */
class ElementalCalculator {
    constructor() {
        this.currentBalance = elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES;
        this.initialized = false;
    }
    static getInstance() {
        if (!ElementalCalculator.instance) {
            ElementalCalculator.instance = new ElementalCalculator();
        }
        return ElementalCalculator.instance;
    }
    static initialize() {
        const instance = ElementalCalculator.getInstance();
        instance.currentBalance = { ...elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES };
        instance.initialized = true;
    }
    static getCurrentElementalState() {
        const instance = ElementalCalculator.getInstance();
        if (!instance.initialized) {
            ElementalCalculator.initialize();
        }
        return instance.currentBalance;
    }
    /**
     * Calculate the seasonal effectiveness of a recipe
     * @param recipe The recipe to evaluate
     * @param season The current season
     * @returns A score from 0-100 representing the effectiveness
     */
    static calculateSeasonalEffectiveness(recipe, season) {
        const recipeData = recipe;
        if (!(recipeData === null || recipeData === void 0 ? void 0 : recipeData.elementalProperties))
            return 0;
        const seasonalModifiers = this.getSeasonalModifiers(season);
        let score = 0;
        // Calculate base seasonal alignment
        Object.entries(recipeData.elementalProperties).forEach(([element, value]) => {
            const modifier = seasonalModifiers[element] || 0;
            score += value * modifier * 100;
        });
        // Apply seasonal bonuses/penalties
        if (recipeData.season) {
            const seasons = Array.isArray(recipeData.season)
                ? recipeData.season
                : [recipeData.season];
            if (seasons
                .map((s) => s.toLowerCase())
                .includes(season.toLowerCase())) {
                score += 20;
            }
        }
        return Math.max(0, Math.min(100, Math.round(score)));
    }
    /**
     * Get elemental modifiers for a specific season
     */
    static getSeasonalModifiers(season) {
        const baseModifiers = { ...elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES };
        // Normalize season to lowercase for consistency with type definition
        const seasonLower = season.toLowerCase();
        switch (seasonLower) {
            case 'spring':
                baseModifiers.Air = 0.4;
                baseModifiers.Fire = 0.3;
                baseModifiers.Water = 0.2;
                baseModifiers.Earth = 0.1;
                break;
            case 'summer':
                baseModifiers.Fire = 0.4;
                baseModifiers.Air = 0.3;
                baseModifiers.Earth = 0.2;
                baseModifiers.Water = 0.1;
                break;
            case 'autumn':
            case 'fall':
                baseModifiers.Earth = 0.4;
                baseModifiers.Air = 0.3;
                baseModifiers.Water = 0.2;
                baseModifiers.Fire = 0.1;
                break;
            case 'winter':
                baseModifiers.Water = 0.4;
                baseModifiers.Earth = 0.3;
                baseModifiers.Fire = 0.2;
                baseModifiers.Air = 0.1;
                break;
            case 'all':
                // Balanced for 'all' season
                baseModifiers.Fire = 0.25;
                baseModifiers.Water = 0.25;
                baseModifiers.Earth = 0.25;
                baseModifiers.Air = 0.25;
                break;
            default:
                // Balanced for unknown seasons
                baseModifiers.Fire = 0.25;
                baseModifiers.Water = 0.25;
                baseModifiers.Earth = 0.25;
                baseModifiers.Air = 0.25;
        }
        return baseModifiers;
    }
    /**
     * Calculate harmony score for given elemental properties
     * @param properties Elemental properties to evaluate
     * @returns Harmony score between 0 and 1
     */
    static calculateHarmony(properties) {
        if (!properties)
            return 0;
        // Check if properties are balanced
        const values = Object.values(properties);
        const average = values.reduce((sum, val) => sum + val, 0) / values.length;
        // Calculate variance from the ideal (perfect balance would be 0 variance)
        const variance = values.reduce((sum, val) => sum + Math.pow(val - average, 2), 0) /
            values.length;
        // Convert variance to harmony score (0-1)
        return Math.max(0, Math.min(1, 1 - Math.sqrt(variance)));
    }
    /**
     * Calculate elemental state based on provided properties and conditions
     * @param baseProperties Base elemental properties
     * @param phase Optional phase/condition
     * @param time Optional time factor
     * @returns Enhanced elemental properties with additional information
     */
    calculateElementalState(baseProperties, phase = 'default', time = 'neutral') {
        // Start with the base properties
        const properties = { ...baseProperties };
        // Create default seasonal influence
        const seasonalInfluence = {
            Fire: 0.25,
            Water: 0.25,
            Earth: 0.25,
            Air: 0.25
        };
        // Apply time-based modifiers
        if (time === 'day') {
            properties.Fire = properties.Fire * 1.1;
            properties.Air = properties.Air * 1.05;
        }
        else if (time === 'night') {
            properties.Water = properties.Water * 1.1;
            properties.Earth = properties.Earth * 1.05;
        }
        // Normalize the properties to ensure they still sum to 1
        const total = Object.values(properties).reduce((sum, val) => sum + val, 0);
        if (total > 0) {
            Object.keys(properties).forEach((key) => {
                properties[key] = properties[key] / total;
                // Update seasonal influence based on the normalized properties
                seasonalInfluence[key] = properties[key] * 1.5;
            });
        }
        return {
            properties,
            seasonalInfluence
        };
    }
}
exports.ElementalCalculator = ElementalCalculator;
/**
 * Gets the planetary influencers for a specific element
 * @param planetaryPositions The current planetary positions
 * @param elementType The element type to get influencers for
 * @returns Array of planetary influencers
 */
function getPlanetaryInfluencers(planetaryPositions, elementType) {
    // Define which planets influence which elements - Pattern JJ-1: ElementType System Unification
    const elementInfluencers = {
        Fire: ['sun', 'mars', 'jupiter'],
        Water: ['moon', 'venus', 'neptune'],
        Earth: ['venus', 'saturn', 'pluto'],
        Air: ['mercury', 'uranus', 'jupiter'],
        // Added extended elements mapped to core planetary influences
        Metal: ['venus', 'saturn', 'mercury'],
        Wood: ['sun', 'mars', 'jupiter'],
        Void: ['mercury', 'uranus', 'neptune'] // Space, potential, emptiness - maps to Air/Water qualities
    };
    // Get the potential influencers for this element
    const potentialInfluencers = elementInfluencers[elementType] || [];
    // Return only the planets that are actually present in the positions data
    return potentialInfluencers.filter((planet) => planetaryPositions[planet] &&
        typeof planetaryPositions[planet] === 'object');
}
/**
 * Calculates the elemental energies based on planetary positions
 *
 * @param planetaryPositions The current positions of planets
 * @param isDaytime Whether it's daytime or nighttime
 * @returns Array of elemental energies
 */
function calculateElementalEnergies(planetaryPositions, isDaytime = true) {
    if (!planetaryPositions || Object.keys(planetaryPositions).length === 0) {
        // console.warn('No planetary positions provided for elemental calculation');
        return getDefaultElementalEnergies();
    }
    // Initialize energy values for each element
    const energyValues = {
        Fire: 0,
        Water: 0,
        Earth: 0,
        Air: 0,
        // Pattern JJ-1: ElementType System Unification - Add extended elements with base element mapping
        Metal: 0,
        Wood: 0,
        Void: 0 // Maps to Air-like properties
    };
    // Define planetary influences (weights)
    const planetWeights = {
        sun: 0.25,
        moon: 0.2,
        mercury: 0.1,
        venus: 0.1,
        mars: 0.1,
        jupiter: 0.1,
        saturn: 0.1,
        uranus: 0.05,
        neptune: 0.05,
        pluto: 0.05
    };
    // Calculate element values based on planetary positions
    let totalWeight = 0;
    for (const [planet, position] of Object.entries(planetaryPositions)) {
        const weight = planetWeights[planet.toLowerCase()] || 0.05;
        // Skip if position doesn't have a sign
        const positionData = position;
        if (!(positionData === null || positionData === void 0 ? void 0 : positionData.sign))
            continue;
        // Convert the sign to lowercase to ensure matching
        const sign = positionData.sign.toLowerCase();
        const element = elements_1.signElementMap[sign];
        if (element) {
            energyValues[element] += weight;
            totalWeight += weight;
        }
    }
    // Apply day/night modifiers
    if (isDaytime) {
        energyValues.Fire *= 1.2;
        energyValues.Air *= 1.1;
    }
    else {
        energyValues.Water *= 1.2;
        energyValues.Earth *= 1.1;
    }
    // Normalize values to ensure they sum to 1
    if (totalWeight > 0) {
        const sum = Object.values(energyValues).reduce((acc, value) => acc + value, 0);
        for (const element of Object.keys(energyValues)) {
            energyValues[element] = sum > 0 ? energyValues[element] / sum : 0;
        }
    }
    // Create ElementalEnergy objects
    const energies = Object.entries(energyValues)
        .filter(([_, strength]) => strength > 0)
        .map(([type, strength]) => ({
        type: type,
        strength,
        influence: getPlanetaryInfluencers(planetaryPositions, type)
    }));
    return energies;
}
exports.calculateElementalEnergies = calculateElementalEnergies;
/**
 * Returns default elemental energies when no data is available
 */
function getDefaultElementalEnergies() {
    return [
        { type: 'Fire', strength: 0.25, influence: [] },
        { type: 'Water', strength: 0.25, influence: [] },
        { type: 'Earth', strength: 0.25, influence: [] },
        { type: 'Air', strength: 0.25, influence: [] },
    ];
}
// Process a zodiac sign and its relevant position to update energy values
function _processZodiacInfluence(sign, weight, energyValues) {
    const element = elements_1.signElementMap[sign];
    if (element) {
        energyValues[element] += weight;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9jYWxjdWxhdGlvbnMvZWxlbWVudGFsY2FsY3VsYXRpb25zLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLCtDQUFnRjtBQUNoRix1RUFBOEU7QUFhOUU7O0dBRUc7QUFDSCxNQUFhLG1CQUFtQjtJQUs5QjtRQUhRLG1CQUFjLEdBQXdCLGlEQUE0QixDQUFDO1FBQ25FLGdCQUFXLEdBQUcsS0FBSyxDQUFDO0lBRUwsQ0FBQztJQUV4QixNQUFNLENBQUMsV0FBVztRQUNoQixJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFO1lBQ2pDLG1CQUFtQixDQUFDLFFBQVEsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7U0FDMUQ7UUFDRCxPQUFPLG1CQUFtQixDQUFDLFFBQVEsQ0FBQztJQUN0QyxDQUFDO0lBRUQsTUFBTSxDQUFDLFVBQVU7UUFDZixNQUFNLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuRCxRQUFRLENBQUMsY0FBYyxHQUFHLEVBQUUsR0FBRyxpREFBNEIsRUFBRSxDQUFDO1FBQzlELFFBQVEsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzlCLENBQUM7SUFFRCxNQUFNLENBQUMsd0JBQXdCO1FBQzdCLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFO1lBQ3pCLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ2xDO1FBQ0QsT0FBTyxRQUFRLENBQUMsY0FBYyxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILE1BQU0sQ0FBQyw4QkFBOEIsQ0FDbkMsTUFBZSxFQUNmLE1BQWM7UUFFZCxNQUFNLFVBQVUsR0FBRyxNQUFhLENBQUM7UUFDakMsSUFBSSxDQUFDLENBQUEsVUFBVSxhQUFWLFVBQVUsdUJBQVYsVUFBVSxDQUFFLG1CQUFtQixDQUFBO1lBQUUs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L1doYXRUb0VhdE5leHQvc3JjL2NhbGN1bGF0aW9ucy9lbGVtZW50YWxjYWxjdWxhdGlvbnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWxlbWVudGFsRW5lcmd5LCBFbGVtZW50VHlwZSwgc2lnbkVsZW1lbnRNYXAgfSBmcm9tICdAL3R5cGVzL2VsZW1lbnRzJztcbmltcG9ydCB7IERFRkFVTFRfRUxFTUVOVEFMX1BST1BFUlRJRVMgfSBmcm9tICdAL2NvbnN0YW50cy9lbGVtZW50YWxDb25zdGFudHMnO1xuaW1wb3J0IHR5cGUge1xuICBTZWFzb259IGZyb20gJ0AvdHlwZXMvYWxjaGVteSc7XG5cbi8vIERlZmluZSB0aGUgdHlwZXMgbmVlZGVkIGZvciBFbGVtZW50YWxDYWxjdWxhdG9yXG5pbnRlcmZhY2UgRWxlbWVudGFsUHJvcGVydGllcyB7XG4gIEZpcmU6IG51bWJlcjtcbiAgV2F0ZXI6IG51bWJlcjtcbiAgRWFydGg6IG51bWJlcjtcbiAgQWlyOiBudW1iZXI7XG4gIFtrZXk6IHN0cmluZ106IG51bWJlcjsgLy8gQWxsb3cgaW5kZXhpbmcgd2l0aCBzdHJpbmdcbn1cblxuLyoqXG4gKiBFbGVtZW50YWxDYWxjdWxhdG9yIGNsYXNzIGZvciBtYW5hZ2luZyBhbmQgY2FsY3VsYXRpbmcgZWxlbWVudGFsIHN0YXRlXG4gKi9cbmV4cG9ydCBjbGFzcyBFbGVtZW50YWxDYWxjdWxhdG9yIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IEVsZW1lbnRhbENhbGN1bGF0b3I7XG4gIHByaXZhdGUgY3VycmVudEJhbGFuY2U6IEVsZW1lbnRhbFByb3BlcnRpZXMgPSBERUZBVUxUX0VMRU1FTlRBTF9QUk9QRVJUSUVTO1xuICBwcml2YXRlIGluaXRpYWxpemVkID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHt9XG5cbiAgc3RhdGljIGdldEluc3RhbmNlKCk6IEVsZW1lbnRhbENhbGN1bGF0b3Ige1xuICAgIGlmICghRWxlbWVudGFsQ2FsY3VsYXRvci5pbnN0YW5jZSkge1xuICAgICAgRWxlbWVudGFsQ2FsY3VsYXRvci5pbnN0YW5jZSA9IG5ldyBFbGVtZW50YWxDYWxjdWxhdG9yKCk7XG4gICAgfVxuICAgIHJldHVybiBFbGVtZW50YWxDYWxjdWxhdG9yLmluc3RhbmNlO1xuICB9XG5cbiAgc3RhdGljIGluaXRpYWxpemUoKTogdm9pZCB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSBFbGVtZW50YWxDYWxjdWxhdG9yLmdldEluc3RhbmNlKCk7XG4gICAgaW5zdGFuY2UuY3VycmVudEJhbGFuY2UgPSB7IC4uLkRFRkFVTFRfRUxFTUVOVEFMX1BST1BFUlRJRVMgfTtcbiAgICBpbnN0YW5jZS5pbml0aWFsaXplZCA9IHRydWU7XG4gIH1cblxuICBzdGF0aWMgZ2V0Q3VycmVudEVsZW1lbnRhbFN0YXRlKCk6IEVsZW1lbnRhbFByb3BlcnRpZXMge1xuICAgIGNvbnN0IGluc3RhbmNlID0gRWxlbWVudGFsQ2FsY3VsYXRvci5nZXRJbnN0YW5jZSgpO1xuICAgIGlmICghaW5zdGFuY2UuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIEVsZW1lbnRhbENhbGN1bGF0b3IuaW5pdGlhbGl6ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2UuY3VycmVudEJhbGFuY2U7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIHRoZSBzZWFzb25hbCBlZmZlY3RpdmVuZXNzIG9mIGEgcmVjaXBlXG4gICAqIEBwYXJhbSByZWNpcGUgVGhlIHJlY2lwZSB0byBldmFsdWF0ZVxuICAgKiBAcGFyYW0gc2Vhc29uIFRoZSBjdXJyZW50IHNlYXNvblxuICAgKiBAcmV0dXJucyBBIHNjb3JlIGZyb20gMC0xMDAgcmVwcmVzZW50aW5nIHRoZSBlZmZlY3RpdmVuZXNzXG4gICAqL1xuICBzdGF0aWMgY2FsY3VsYXRlU2Vhc29uYWxFZmZlY3RpdmVuZXNzKFxuICAgIHJlY2lwZTogdW5rbm93bixcbiAgICBzZWFzb246IHN0cmluZ1xuICApOiBudW1iZXIge1xuICAgIGNvbnN0IHJlY2lwZURhdGEgPSByZWNpcGUgYXMgYW55O1xuICAgIGlmICghcmVjaXBlRGF0YT8uZWxlbWVudGFsUHJvcGVydGllcykgcmV0dXJuIDA7XG5cbiAgICBjb25zdCBzZWFzb25hbE1vZGlmaWVycyA9IHRoaXMuZ2V0U2Vhc29uYWxNb2RpZmllcnMoc2Vhc29uIGFzIFNlYXNvbik7XG4gICAgbGV0IHNjb3JlID0gMDtcblxuICAgIC8vIENhbGN1bGF0ZSBiYXNlIHNlYXNvbmFsIGFsaWdubWVudFxuICAgIE9iamVjdC5lbnRyaWVzKHJlY2lwZURhdGEuZWxlbWVudGFsUHJvcGVydGllcykuZm9yRWFjaCgoW2VsZW1lbnQsIHZhbHVlXSkgPT4ge1xuICAgICAgY29uc3QgbW9kaWZpZXIgPVxuICAgICAgICBzZWFzb25hbE1vZGlmaWVyc1tlbGVtZW50IGFzIGtleW9mIEVsZW1lbnRhbFByb3BlcnRpZXNdIHx8IDA7XG4gICAgICBzY29yZSArPSAodmFsdWUgYXMgbnVtYmVyKSAqIG1vZGlmaWVyICogMTAwO1xuICAgIH0pO1xuXG4gICAgLy8gQXBwbHkgc2Vhc29uYWwgYm9udXNlcy9wZW5hbHRpZXNcbiAgICBpZiAocmVjaXBlRGF0YS5zZWFzb24pIHtcbiAgICAgIGNvbnN0IHNlYXNvbnMgPSBBcnJheS5pc0FycmF5KHJlY2lwZURhdGEuc2Vhc29uKVxuICAgICAgICA/IHJlY2lwZURhdGEuc2Vhc29uXG4gICAgICAgIDogW3JlY2lwZURhdGEuc2Vhc29uXTtcbiAgICAgIGlmIChcbiAgICAgICAgc2Vhc29uc1xuICAgICAgICAgIC5tYXAoKHM6IHN0cmluZykgPT4gcy50b0xvd2VyQ2FzZSgpKVxuICAgICAgICAgIC5pbmNsdWRlcyhzZWFzb24udG9Mb3dlckNhc2UoKSlcbiAgICAgICkge1xuICAgICAgICBzY29yZSArPSAyMDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAwLCBNYXRoLnJvdW5kKHNjb3JlKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBlbGVtZW50YWwgbW9kaWZpZXJzIGZvciBhIHNwZWNpZmljIHNlYXNvblxuICAgKi9cbiAgc3RhdGljIGdldFNlYXNvbmFsTW9kaWZpZXJzKHNlYXNvbjogU2Vhc29uKTogRWxlbWVudGFsUHJvcGVydGllcyB7XG4gICAgY29uc3QgYmFzZU1vZGlmaWVycyA9IHsgLi4uREVGQVVMVF9FTEVNRU5UQUxfUFJPUEVSVElFUyB9O1xuXG4gICAgLy8gTm9ybWFsaXplIHNlYXNvbiB0byBsb3dlcmNhc2UgZm9yIGNvbnNpc3RlbmN5IHdpdGggdHlwZSBkZWZpbml0aW9uXG4gICAgY29uc3Qgc2Vhc29uTG93ZXIgPSBzZWFzb24udG9Mb3dlckNhc2UoKSBhcyBTZWFzb247XG5cbiAgICBzd2l0Y2ggKHNlYXNvbkxvd2VyKSB7XG4gICAgICBjYXNlICdzcHJpbmcnOlxuICAgICAgICBiYXNlTW9kaWZpZXJzLkFpciA9IDAuNDtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5GaXJlID0gMC4zO1xuICAgICAgICBiYXNlTW9kaWZpZXJzLldhdGVyID0gMC4yO1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkVhcnRoID0gMC4xO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3N1bW1lcic6XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRmlyZSA9IDAuNDtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5BaXIgPSAwLjM7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRWFydGggPSAwLjI7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuV2F0ZXIgPSAwLjE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnYXV0dW1uJzpcbiAgICAgIGNhc2UgJ2ZhbGwnOlxuICAgICAgICBiYXNlTW9kaWZpZXJzLkVhcnRoID0gMC40O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkFpciA9IDAuMztcbiAgICAgICAgYmFzZU1vZGlmaWVycy5XYXRlciA9IDAuMjtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5GaXJlID0gMC4xO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3dpbnRlcic6XG4gICAgICAgIGJhc2VNb2RpZmllcnMuV2F0ZXIgPSAwLjQ7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRWFydGggPSAwLjM7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRmlyZSA9IDAuMjtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5BaXIgPSAwLjE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnYWxsJzpcbiAgICAgICAgLy8gQmFsYW5jZWQgZm9yICdhbGwnIHNlYXNvblxuICAgICAgICBiYXNlTW9kaWZpZXJzLkZpcmUgPSAwLjI1O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLldhdGVyID0gMC4yNTtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5FYXJ0aCA9IDAuMjU7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuQWlyID0gMC4yNTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICAvLyBCYWxhbmNlZCBmb3IgdW5rbm93biBzZWFzb25zXG4gICAgICAgIGJhc2VNb2RpZmllcnMuRmlyZSA9IDAuMjU7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuV2F0ZXIgPSAwLjI1O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkVhcnRoID0gMC4yNTtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5BaXIgPSAwLjI1O1xuICAgIH1cblxuICAgIHJldHVybiBiYXNlTW9kaWZpZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBoYXJtb255IHNjb3JlIGZvciBnaXZlbiBlbGVtZW50YWwgcHJvcGVydGllc1xuICAgKiBAcGFyYW0gcHJvcGVydGllcyBFbGVtZW50YWwgcHJvcGVydGllcyB0byBldmFsdWF0ZVxuICAgKiBAcmV0dXJucyBIYXJtb255IHNjb3JlIGJldHdlZW4gMCBhbmQgMVxuICAgKi9cbiAgc3RhdGljIGNhbGN1bGF0ZUhhcm1vbnkocHJvcGVydGllczogRWxlbWVudGFsUHJvcGVydGllcyk6IG51bWJlciB7XG4gICAgaWYgKCFwcm9wZXJ0aWVzKSByZXR1cm4gMDtcblxuICAgIC8vIENoZWNrIGlmIHByb3BlcnRpZXMgYXJlIGJhbGFuY2VkXG4gICAgY29uc3QgdmFsdWVzID0gT2JqZWN0LnZhbHVlcyhwcm9wZXJ0aWVzKTtcbiAgICBjb25zdCBhdmVyYWdlID0gdmFsdWVzLnJlZHVjZSgoc3VtLCB2YWwpID0+IHN1bSArIHZhbCwgMCkgLyB2YWx1ZXMubGVuZ3RoO1xuXG4gICAgLy8gQ2FsY3VsYXRlIHZhcmlhbmNlIGZyb20gdGhlIGlkZWFsIChwZXJmZWN0IGJhbGFuY2Ugd291bGQgYmUgMCB2YXJpYW5jZSlcbiAgICBjb25zdCB2YXJpYW5jZSA9XG4gICAgICB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gYXZlcmFnZSwgMiksIDApIC9cbiAgICAgIHZhbHVlcy5sZW5ndGg7XG5cbiAgICAvLyBDb252ZXJ0IHZhcmlhbmNlIHRvIGhhcm1vbnkgc2NvcmUgKDAtMSlcbiAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgMSAtIE1hdGguc3FydCh2YXJpYW5jZSkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgZWxlbWVudGFsIHN0YXRlIGJhc2VkIG9uIHByb3ZpZGVkIHByb3BlcnRpZXMgYW5kIGNvbmRpdGlvbnNcbiAgICogQHBhcmFtIGJhc2VQcm9wZXJ0aWVzIEJhc2UgZWxlbWVudGFsIHByb3BlcnRpZXNcbiAgICogQHBhcmFtIHBoYXNlIE9wdGlvbmFsIHBoYXNlL2NvbmRpdGlvblxuICAgKiBAcGFyYW0gdGltZSBPcHRpb25hbCB0aW1lIGZhY3RvclxuICAgKiBAcmV0dXJucyBFbmhhbmNlZCBlbGVtZW50YWwgcHJvcGVydGllcyB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbiAgICovXG4gIGNhbGN1bGF0ZUVsZW1lbnRhbFN0YXRlKFxuICAgIGJhc2VQcm9wZXJ0aWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzLFxuICAgIHBoYXNlID0gJ2RlZmF1bHQnLFxuICAgIHRpbWUgPSAnbmV1dHJhbCdcbiAgKToge1xuICAgIHByb3BlcnRpZXM6IEVsZW1lbnRhbFByb3BlcnRpZXM7XG4gICAgc2Vhc29uYWxJbmZsdWVuY2U6IEVsZW1lbnRhbFByb3BlcnRpZXM7XG4gIH0ge1xuICAgIC8vIFN0YXJ0IHdpdGggdGhlIGJhc2UgcHJvcGVydGllc1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7IC4uLmJhc2VQcm9wZXJ0aWVzIH07XG5cbiAgICAvLyBDcmVhdGUgZGVmYXVsdCBzZWFzb25hbCBpbmZsdWVuY2VcbiAgICBjb25zdCBzZWFzb25hbEluZmx1ZW5jZTogRWxlbWVudGFsUHJvcGVydGllcyA9IHtcbiAgICAgIEZpcmU6IDAuMjUsXG4gICAgICBXYXRlcjogMC4yNSxcbiAgICAgIEVhcnRoOiAwLjI1LFxuICAgICAgQWlyOiAwLjI1fTtcblxuICAgIC8vIEFwcGx5IHRpbWUtYmFzZWQgbW9kaWZpZXJzXG4gICAgaWYgKHRpbWUgPT09ICdkYXknKSB7XG4gICAgICBwcm9wZXJ0aWVzLkZpcmUgPSBwcm9wZXJ0aWVzLkZpcmUgKiAxLjE7XG4gICAgICBwcm9wZXJ0aWVzLkFpciA9IHByb3BlcnRpZXMuQWlyICogMS4wNTtcbiAgICB9IGVsc2UgaWYgKHRpbWUgPT09ICduaWdodCcpIHtcbiAgICAgIHByb3BlcnRpZXMuV2F0ZXIgPSBwcm9wZXJ0aWVzLldhdGVyICogMS4xO1xuICAgICAgcHJvcGVydGllcy5FYXJ0aCA9IHByb3BlcnRpZXMuRWFydGggKiAxLjA1O1xuICAgIH1cblxuICAgIC8vIE5vcm1hbGl6ZSB0aGUgcHJvcGVydGllcyB0byBlbnN1cmUgdGhleSBzdGlsbCBzdW0gdG8gMVxuICAgIGNvbnN0IHRvdGFsID0gT2JqZWN0LnZhbHVlcyhwcm9wZXJ0aWVzKS5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyB2YWwsIDApO1xuXG4gICAgaWYgKHRvdGFsID4gMCkge1xuICAgICAgT2JqZWN0LmtleXMocHJvcGVydGllcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIHByb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XSAvIHRvdGFsO1xuXG4gICAgICAgIC8vIFVwZGF0ZSBzZWFzb25hbCBpbmZsdWVuY2UgYmFzZWQgb24gdGhlIG5vcm1hbGl6ZWQgcHJvcGVydGllc1xuICAgICAgICBzZWFzb25hbEluZmx1ZW5jZVtrZXldID0gcHJvcGVydGllc1trZXldICogMS41O1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHByb3BlcnRpZXMsXG4gICAgICBzZWFzb25hbEluZmx1ZW5jZX07XG4gIH1cbn1cblxuLyoqXG4gKiBHZXRzIHRoZSBwbGFuZXRhcnkgaW5mbHVlbmNlcnMgZm9yIGEgc3BlY2lmaWMgZWxlbWVudFxuICogQHBhcmFtIHBsYW5ldGFyeVBvc2l0aW9ucyBUaGUgY3VycmVudCBwbGFuZXRhcnkgcG9zaXRpb25zXG4gKiBAcGFyYW0gZWxlbWVudFR5cGUgVGhlIGVsZW1lbnQgdHlwZSB0byBnZXQgaW5mbHVlbmNlcnMgZm9yXG4gKiBAcmV0dXJucyBBcnJheSBvZiBwbGFuZXRhcnkgaW5mbHVlbmNlcnNcbiAqL1xuZnVuY3Rpb24gZ2V0UGxhbmV0YXJ5SW5mbHVlbmNlcnMoXG4gIHBsYW5ldGFyeVBvc2l0aW9uczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGVsZW1lbnRUeXBlOiBFbGVtZW50VHlwZVxuKTogc3RyaW5nW10ge1xuICAvLyBEZWZpbmUgd2hpY2ggcGxhbmV0cyBpbmZsdWVuY2Ugd2hpY2ggZWxlbWVudHMgLSBQYXR0ZXJuIEpKLTE6IEVsZW1lbnRUeXBlIFN5c3RlbSBVbmlmaWNhdGlvblxuICBjb25zdCBlbGVtZW50SW5mbHVlbmNlcnM6IFJlY29yZDxFbGVtZW50VHlwZSwgc3RyaW5nW10+ID0ge1xuICAgIEZpcmU6IFsnc3VuJywgJ21hcnMnLCAnanVwaXRlciddLFxuICAgIFdhdGVyOiBbJ21vb24nLCAndmVudXMnLCAnbmVwdHVuZSddLFxuICAgIEVhcnRoOiBbJ3ZlbnVzJywgJ3NhdHVybicsICdwbHV0byddLFxuICAgIEFpcjogWydtZXJjdXJ5JywgJ3VyYW51cycsICdqdXBpdGVyJ10sXG4gICAgLy8gQWRkZWQgZXh0ZW5kZWQgZWxlbWVudHMgbWFwcGVkIHRvIGNvcmUgcGxhbmV0YXJ5IGluZmx1ZW5jZXNcbiAgICBNZXRhbDogWyd2ZW51cycsICdzYXR1cm4nLCAnbWVyY3VyeSddLCAvLyBTdHJ1Y3R1cmUsIGNsYXJpdHksIHByZWNpc2lvbiAtIG1hcHMgdG8gRWFydGgvQWlyIHF1YWxpdGllc1xuICAgIFdvb2Q6IFsnc3VuJywgJ21hcnMnLCAnanVwaXRlciddLCAgICAgIC8vIEdyb3d0aCwgZmxleGliaWxpdHksIGV4cGFuc2lvbiAtIG1hcHMgdG8gRmlyZSBxdWFsaXRpZXMgIFxuICAgIFZvaWQ6IFsnbWVyY3VyeScsICd1cmFudXMnLCAnbmVwdHVuZSddIC8vIFNwYWNlLCBwb3RlbnRpYWwsIGVtcHRpbmVzcyAtIG1hcHMgdG8gQWlyL1dhdGVyIHF1YWxpdGllc1xuICB9O1xuXG4gIC8vIEdldCB0aGUgcG90ZW50aWFsIGluZmx1ZW5jZXJzIGZvciB0aGlzIGVsZW1lbnRcbiAgY29uc3QgcG90ZW50aWFsSW5mbHVlbmNlcnMgPSBlbGVtZW50SW5mbHVlbmNlcnNbZWxlbWVudFR5cGVdIHx8IFtdO1xuXG4gIC8vIFJldHVybiBvbmx5IHRoZSBwbGFuZXRzIHRoYXQgYXJlIGFjdHVhbGx5IHByZXNlbnQgaW4gdGhlIHBvc2l0aW9ucyBkYXRhXG4gIHJldHVybiBwb3RlbnRpYWxJbmZsdWVuY2Vycy5maWx0ZXIoXG4gICAgKHBsYW5ldCkgPT5cbiAgICAgIHBsYW5ldGFyeVBvc2l0aW9uc1twbGFuZXRdICYmXG4gICAgICB0eXBlb2YgcGxhbmV0YXJ5UG9zaXRpb25zW3BsYW5ldF0gPT09ICdvYmplY3QnXG4gICk7XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlcyB0aGUgZWxlbWVudGFsIGVuZXJnaWVzIGJhc2VkIG9uIHBsYW5ldGFyeSBwb3NpdGlvbnNcbiAqXG4gKiBAcGFyYW0gcGxhbmV0YXJ5UG9zaXRpb25zIFRoZSBjdXJyZW50IHBvc2l0aW9ucyBvZiBwbGFuZXRzXG4gKiBAcGFyYW0gaXNEYXl0aW1lIFdoZXRoZXIgaXQncyBkYXl0aW1lIG9yIG5pZ2h0dGltZVxuICogQHJldHVybnMgQXJyYXkgb2YgZWxlbWVudGFsIGVuZXJnaWVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVFbGVtZW50YWxFbmVyZ2llcyhcbiAgcGxhbmV0YXJ5UG9zaXRpb25zOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgaXNEYXl0aW1lID0gdHJ1ZVxuKTogRWxlbWVudGFsRW5lcmd5W10ge1xuICBpZiAoIXBsYW5ldGFyeVBvc2l0aW9ucyB8fCBPYmplY3Qua2V5cyhwbGFuZXRhcnlQb3NpdGlvbnMpLmxlbmd0aCA9PT0gMCkge1xuICAgIC8vIGNvbnNvbGUud2FybignTm8gcGxhbmV0YXJ5IHBvc2l0aW9ucyBwcm92aWRlZCBmb3IgZWxlbWVudGFsIGNhbGN1bGF0aW9uJyk7XG4gICAgcmV0dXJuIGdldERlZmF1bHRFbGVtZW50YWxFbmVyZ2llcygpO1xuICB9XG5cbiAgLy8gSW5pdGlhbGl6ZSBlbmVyZ3kgdmFsdWVzIGZvciBlYWNoIGVsZW1lbnRcbiAgY29uc3QgZW5lcmd5VmFsdWVzOiBSZWNvcmQ8RWxlbWVudFR5cGUsIG51bWJlcj4gPSB7XG4gICAgRmlyZTogMCxcbiAgICBXYXRlcjogMCxcbiAgICBFYXJ0aDogMCxcbiAgICBBaXI6IDAsXG4gICAgLy8gUGF0dGVybiBKSi0xOiBFbGVtZW50VHlwZSBTeXN0ZW0gVW5pZmljYXRpb24gLSBBZGQgZXh0ZW5kZWQgZWxlbWVudHMgd2l0aCBiYXNlIGVsZW1lbnQgbWFwcGluZ1xuICAgIE1ldGFsOiAwLCAvLyBNYXBzIHRvIEVhcnRoLWxpa2UgcHJvcGVydGllc1xuICAgIFdvb2Q6IDAsICAvLyBNYXBzIHRvIEZpcmUtbGlrZSBwcm9wZXJ0aWVzXG4gICAgVm9pZDogMCAgIC8vIE1hcHMgdG8gQWlyLWxpa2UgcHJvcGVydGllc1xuICB9O1xuXG4gIC8vIERlZmluZSBwbGFuZXRhcnkgaW5mbHVlbmNlcyAod2VpZ2h0cylcbiAgY29uc3QgcGxhbmV0V2VpZ2h0czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHtcbiAgICBzdW46IDAuMjUsXG4gICAgbW9vbjogMC4yLFxuICAgIG1lcmN1cnk6IDAuMSxcbiAgICB2ZW51czogMC4xLFxuICAgIG1hcnM6IDAuMSxcbiAgICBqdXBpdGVyOiAwLjEsXG4gICAgc2F0dXJuOiAwLjEsXG4gICAgdXJhbnVzOiAwLjA1LFxuICAgIG5lcHR1bmU6IDAuMDUsXG4gICAgcGx1dG86IDAuMDV9O1xuXG4gIC8vIENhbGN1bGF0ZSBlbGVtZW50IHZhbHVlcyBiYXNlZCBvbiBwbGFuZXRhcnkgcG9zaXRpb25zXG4gIGxldCB0b3RhbFdlaWdodCA9IDA7XG5cbiAgZm9yIChjb25zdCBbcGxhbmV0LCBwb3NpdGlvbl0gb2YgT2JqZWN0LmVudHJpZXMocGxhbmV0YXJ5UG9zaXRpb25zKSkge1xuICAgIGNvbnN0IHdlaWdodCA9IHBsYW5ldFdlaWdodHNbcGxhbmV0LnRvTG93ZXJDYXNlKCldIHx8IDAuMDU7XG5cbiAgICAvLyBTa2lwIGlmIHBvc2l0aW9uIGRvZXNuJ3QgaGF2ZSBhIHNpZ25cbiAgICBjb25zdCBwb3NpdGlvbkRhdGEgPSBwb3NpdGlvbiBhcyBhbnk7XG4gICAgaWYgKCFwb3NpdGlvbkRhdGE/LnNpZ24pIGNvbnRpbnVlO1xuXG4gICAgLy8gQ29udmVydCB0aGUgc2lnbiB0byBsb3dlcmNhc2UgdG8gZW5zdXJlIG1hdGNoaW5nXG4gICAgY29uc3Qgc2lnbiA9IHBvc2l0aW9uRGF0YS5zaWduLnRvTG93ZXJDYXNlKCk7XG4gICAgY29uc3QgZWxlbWVudCA9IHNpZ25FbGVtZW50TWFwW3NpZ25dO1xuXG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGVuZXJneVZhbHVlc1tlbGVtZW50XSArPSB3ZWlnaHQ7XG4gICAgICB0b3RhbFdlaWdodCArPSB3ZWlnaHQ7XG4gICAgfVxuICB9XG5cbiAgLy8gQXBwbHkgZGF5L25pZ2h0IG1vZGlmaWVyc1xuICBpZiAoaXNEYXl0aW1lKSB7XG4gICAgZW5lcmd5VmFsdWVzLkZpcmUgKj0gMS4yO1xuICAgIGVuZXJneVZhbHVlcy5BaXIgKj0gMS4xO1xuICB9IGVsc2Uge1xuICAgIGVuZXJneVZhbHVlcy5XYXRlciAqPSAxLjI7XG4gICAgZW5lcmd5VmFsdWVzLkVhcnRoICo9IDEuMTtcbiAgfVxuXG4gIC8vIE5vcm1hbGl6ZSB2YWx1ZXMgdG8gZW5zdXJlIHRoZXkgc3VtIHRvIDFcbiAgaWYgKHRvdGFsV2VpZ2h0ID4gMCkge1xuICAgIGNvbnN0IHN1bSA9IE9iamVjdC52YWx1ZXMoZW5lcmd5VmFsdWVzKS5yZWR1Y2UoXG4gICAgICAoYWNjLCB2YWx1ZSkgPT4gYWNjICsgdmFsdWUsXG4gICAgICAwXG4gICAgKTtcblxuICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBPYmplY3Qua2V5cyhlbmVyZ3lWYWx1ZXMpIGFzIEVsZW1lbnRUeXBlW10pIHtcbiAgICAgIGVuZXJneVZhbHVlc1tlbGVtZW50XSA9IHN1bSA+IDAgPyBlbmVyZ3lWYWx1ZXNbZWxlbWVudF0gLyBzdW0gOiAwO1xuICAgIH1cbiAgfVxuXG4gIC8vIENyZWF0ZSBFbGVtZW50YWxFbmVyZ3kgb2JqZWN0c1xuICBjb25zdCBlbmVyZ2llczogRWxlbWVudGFsRW5lcmd5W10gPSBPYmplY3QuZW50cmllcyhlbmVyZ3lWYWx1ZXMpXG4gICAgLmZpbHRlcigoW18sIHN0cmVuZ3RoXSkgPT4gc3RyZW5ndGggPiAwKVxuICAgIC5tYXAoKFt0eXBlLCBzdHJlbmd0aF0pID0+ICh7XG4gICAgICB0eXBlOiB0eXBlIGFzIEVsZW1lbnRUeXBlLFxuICAgICAgc3RyZW5ndGgsXG4gICAgICBpbmZsdWVuY2U6IGdldFBsYW5ldGFyeUluZmx1ZW5jZXJzKFxuICAgICAgICBwbGFuZXRhcnlQb3NpdGlvbnMsXG4gICAgICAgIHR5cGUgYXMgRWxlbWVudFR5cGVcbiAgICAgICl9KSk7XG5cbiAgcmV0dXJuIGVuZXJnaWVzO1xufVxuXG4vKipcbiAqIFJldHVybnMgZGVmYXVsdCBlbGVtZW50YWwgZW5lcmdpZXMgd2hlbiBubyBkYXRhIGlzIGF2YWlsYWJsZVxuICovXG5mdW5jdGlvbiBnZXREZWZhdWx0RWxlbWVudGFsRW5lcmdpZXMoKTogRWxlbWVudGFsRW5lcmd5W10ge1xuICByZXR1cm4gW1xuICAgIHsgdHlwZTogJ0ZpcmUnLCBzdHJlbmd0aDogMC4yNSwgaW5mbHVlbmNlOiBbXSB9LFxuICAgIHsgdHlwZTogJ1dhdGVyJywgc3RyZW5ndGg6IDAuMjUsIGluZmx1ZW5jZTogW10gfSxcbiAgICB7IHR5cGU6ICdFYXJ0aCcsIHN0cmVuZ3RoOiAwLjI1LCBpbmZsdWVuY2U6IFtdIH0sXG4gICAgeyB0eXBlOiAnQWlyJywgc3RyZW5ndGg6IDAuMjUsIGluZmx1ZW5jZTogW10gfSxcbiAgXTtcbn1cblxuLy8gUHJvY2VzcyBhIHpvZGlhYyBzaWduIGFuZCBpdHMgcmVsZXZhbnQgcG9zaXRpb24gdG8gdXBkYXRlIGVuZXJneSB2YWx1ZXNcbmZ1bmN0aW9uIF9wcm9jZXNzWm9kaWFjSW5mbHVlbmNlKHNpZ246IHN0cmluZywgd2VpZ2h0OiBudW1iZXIsIGVuZXJneVZhbHVlczogRWxlbWVudGFsUHJvcGVydGllcyk6IHZvaWQge1xuICBjb25zdCBlbGVtZW50ID0gc2lnbkVsZW1lbnRNYXBbc2lnbl07XG5cbiAgaWYgKGVsZW1lbnQpIHtcbiAgICBlbmVyZ3lWYWx1ZXNbZWxlbWVudF0gKz0gd2VpZ2h0O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=