3d62afff29f998003293a27a93a5f7e9
"use strict";
'use client';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AlchemicalProvider = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const logger_1 = require("@/utils/logger");
const safeAstrology = __importStar(require("@/utils/safeAstrology"));
const context_1 = require("./context");
const reducer_1 = require("./reducer");
// Create a component-specific logger
const logger = (0, logger_1.createLogger)('AlchemicalProvider');
// Function to do a deep equality check
function deepEqual(obj1, obj2) {
    if (obj1 === obj2)
        return true;
    if (obj1 == null || obj2 == null)
        return false;
    if (typeof obj1 !== 'object' || typeof obj2 !== 'object')
        return false;
    const keys1 = Object.keys(obj1);
    const keys2 = Object.keys(obj2);
    if (keys1.length !== keys2.length)
        return false;
    for (const key of keys1) {
        if (!keys2.includes(key))
            return false;
        if (!deepEqual(obj1[key], obj2[key]))
            return false;
    }
    return true;
}
// Calculate active planets based on dignity and other factors
const calculateActivePlanets = (positions) => {
    if (!positions)
        return [];
    // Basic implementation just returns the major planets
    const activePlanets = [];
    try {
        // Add main planets (using capitalized names to match proven working implementation)
        const mainPlanets = ['Sun', 'Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];
        mainPlanets.forEach(planet => {
            if (positions[planet]) {
                activePlanets.push(planet);
            }
        });
        // Always include luminaries (Sun and Moon) as they're constantly active
        if (!activePlanets.includes('Sun'))
            activePlanets.push('Sun');
        if (!activePlanets.includes('Moon'))
            activePlanets.push('Moon');
    }
    catch (error) {
        logger.error('Error calculating active planets:', error);
        // Return at least the sun and moon as fallback (capitalized)
        return ['Sun', 'Moon'];
    }
    return activePlanets;
};
// Safe type conversion function to replace 'as any' casts
const convertToCalculationFormat = (positions) => {
    const converted = {};
    Object.entries(positions).forEach(([planet, position]) => {
        if (position && typeof position === 'object') {
            converted[planet] = {
                sign: position.sign,
                degree: position.degree,
                isRetrograde: position.isRetrograde,
                // Preserve any additional properties safely
                ...position
            };
        }
    });
    return converted;
};
// Export the provider component
const AlchemicalProvider = ({ children }) => {
    const [state, dispatch] = (0, react_1.useReducer)(reducer_1.alchemicalReducer, context_1.defaultState);
    const [planetaryPositions, setPlanetaryPositions] = (0, react_1.useState)({});
    const [isDaytime, setIsDaytime] = (0, react_1.useState)(true);
    const [isInitialized, setIsInitialized] = (0, react_1.useState)(false);
    // Initialize data once on mount
    (0, react_1.useEffect)(() => {
        if (!isInitialized) {
            logger.debug(`AlchemicalProvider initializing`);
            setIsInitialized(true);
            refreshPlanetaryPositions(); // Initial fetch of planetary positions
        }
    }, [isInitialized]);
    // Synchronize alchemical values between state and astrologicalState
    (0, react_1.useEffect)(() => {
        // Check if astrologicalState exists and has alchemicalValues
        if (state.astrologicalState.alchemicalValues) {
            // If the values differ, update the main state alchemicalValues
            if (!deepEqual(state.alchemicalValues, state.astrologicalState.alchemicalValues)) {
                logger.debug('Synchronizing alchemical values from astrologicalState to root state');
                dispatch({
                    type: 'SET_ALCHEMICAL_VALUES',
                    payload: (state.astrologicalState.alchemicalValues && Object.keys(state.astrologicalState.alchemicalValues).length === 4)
                        ? state.astrologicalState.alchemicalValues
                        : { Spirit: 0.25, Essence: 0.25, Matter: 0.25, Substance: 0.25 }
                });
            }
        }
        else if (state.astrologicalState) {
            // If astrologicalState exists but doesn't have alchemicalValues, add them from root state
            const updatedAstroState = {
                ...state.astrologicalState,
                alchemicalValues: (state.alchemicalValues && Object.keys(state.alchemicalValues).length === 4)
                    ? state.alchemicalValues
                    : { Spirit: 0.25, Essence: 0.25, Matter: 0.25, Substance: 0.25 }
            };
            dispatch({
                type: 'SET_ASTROLOGICAL_STATE',
                payload: updatedAstroState
            });
        }
    }, [state.astrologicalState]);
    const updatePlanetaryPositions = (0, react_1.useCallback)((positions) => {
        // Only update if positions are different using deep equality
        setPlanetaryPositions(prev => {
            // Skip update if positions are identical to prevent re-renders
            if (deepEqual(prev, positions)) {
                logger.debug('Skipping identical planetary positions update');
                return prev;
            }
            logger.info('Updating planetary positions', {
                sun: positions.Sun.sign,
                moon: positions.Moon.sign,
                timestamp: new Date().toISOString()
            });
            return positions;
        });
    }, []);
    const refreshPlanetaryPositions = (0, react_1.useCallback)(async () => {
        try {
            logger.debug('Refreshing planetary positions...');
            // Use reliable hardcoded positions
            const positions = safeAstrology.getReliablePlanetaryPositions();
            // Normalize keys to capitalized format for consistency with proven working implementation
            const normalizedPositions = {};
            Object.entries(positions).forEach(([key, data]) => {
                if (!data || typeof data !== 'object')
                    return;
                const planet = key.charAt(0).toUpperCase() + key.slice(1).toLowerCase();
                normalizedPositions[planet] = {
                    sign: data.sign?.toLowerCase() || 'unknown',
                    degree: typeof data.degree === 'number' ? data.degree : 0,
                    exactLongitude: typeof data.exactLongitude === 'number' ? data.exactLongitude : 0,
                    isRetrograde: !!data.isRetrograde
                };
            });
            updatePlanetaryPositions(normalizedPositions);
            // Import calculation utilities
            const { calculateElementalValues, calculatePlanetaryAlchemicalValues, calculateElementalBalance } = await Promise.resolve().then(() => __importStar(require('@/utils/alchemicalCalculations')));
            // Calculate elemental and alchemical values using type-safe conversion
            const compatiblePositions = convertToCalculationFormat(normalizedPositions);
            const elementalValues = calculateElementalValues(compatiblePositions);
            const planetaryValues = calculatePlanetaryAlchemicalValues(compatiblePositions);
            const elementalBalance = calculateElementalBalance(compatiblePositions);
            // Combine elemental and planetary influences (weighted average)
            const combinedAlchemicalValues = {
                Spirit: (elementalValues.Spirit * 0.5) + (planetaryValues.Spirit * 0.5),
                Essence: (elementalValues.Essence * 0.5) + (planetaryValues.Essence * 0.5),
                Matter: (elementalValues.Matter * 0.5) + (planetaryValues.Matter * 0.5),
                Substance: (elementalValues.Substance * 0.5) + (planetaryValues.Substance * 0.5)
            };
            // Normalize alchemical values to ensure they sum to approximately 1
            const total = combinedAlchemicalValues.Spirit + combinedAlchemicalValues.Essence +
                combinedAlchemicalValues.Matter + combinedAlchemicalValues.Substance;
            const normalizedAlchemicalValues = {
                Spirit: combinedAlchemicalValues.Spirit / total,
                Essence: combinedAlchemicalValues.Essence / total,
                Matter: combinedAlchemicalValues.Matter / total,
                Substance: combinedAlchemicalValues.Substance / total
            };
            logger.debug('Calculated alchemical values:', normalizedAlchemicalValues);
            // Update state with calculated values
            const activePlanets = calculateActivePlanets(normalizedPositions);
            const sunSign = normalizedPositions.Sun.sign || 'aries';
            const moonSign = normalizedPositions.Moon.sign || 'taurus';
            // First update the alchemical values at the root of the state
            dispatch({
                type: 'SET_ALCHEMICAL_VALUES',
                payload: normalizedAlchemicalValues
            });
            // Update elemental state
            dispatch({
                type: 'SET_ELEMENTAL_STATE',
                payload: elementalBalance
            });
            // Sync with ElementalCalculator
            try {
                const { ElementalCalculator } = await Promise.resolve().then(() => __importStar(require('@/services/ElementalCalculator')));
                ElementalCalculator.updateElementalState(elementalBalance);
            }
            catch (error) {
                logger.error('Error syncing ElementalCalculator state:', error);
            }
            // Then update the astrological state with the same values
            const astrologicalState = {
                sunSign,
                moonSign,
                lunarPhase: safeAstrology.getLunarPhaseName(safeAstrology.calculateLunarPhase()),
                timeOfDay: getTimeOfDay(),
                isDaytime,
                planetaryHour: 'sun',
                zodiacSign: sunSign,
                activePlanets,
                activeAspects: [],
                dominantElement: 'Fire',
                calculationError: false,
                alchemicalValues: normalizedAlchemicalValues,
                currentZodiac: sunSign,
                moonPhase: safeAstrology.getLunarPhaseName(safeAstrology.calculateLunarPhase())
            };
            dispatch({
                type: 'SET_ASTROLOGICAL_STATE',
                payload: astrologicalState
            });
            return normalizedPositions;
        }
        catch (error) {
            logger.error('Error refreshing planetary positions:', error);
            dispatch({
                type: 'SET_ERROR',
                payload: { message: 'Failed to refresh planetary positions' }
            });
            // Pattern JJ-2: AlchemicalState Interface Completion - Return proper structure instead of empty object
            return {
                Sun: { sign: 'aries', degree: 0, exactLongitude: 0, isRetrograde: false },
                Moon: { sign: 'taurus', degree: 0, exactLongitude: 0, isRetrograde: false }
            };
        }
    }, [isDaytime, updatePlanetaryPositions]);
    const getTimeOfDay = () => {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12)
            return 'morning';
        if (hour >= 12 && hour < 17)
            return 'afternoon';
        if (hour >= 17 && hour < 21)
            return 'evening';
        return 'night';
    };
    const setDaytime = (0, react_1.useCallback)((value) => {
        setIsDaytime(value);
        logger.debug(`Setting isDaytime to ${value}`);
        // Refresh planetary positions on daytime change
        if (isInitialized) {
            refreshPlanetaryPositions();
        }
    }, [isInitialized, refreshPlanetaryPositions]);
    const updateState = (0, react_1.useCallback)((updatedState) => {
        dispatch({
            type: 'UPDATE_STATE',
            payload: updatedState
        });
    }, []);
    return ((0, jsx_runtime_1.jsx)(context_1.AlchemicalContext.Provider, { value: {
            state,
            dispatch,
            planetaryPositions: planetaryPositions,
            isDaytime,
            updatePlanetaryPositions: updatePlanetaryPositions,
            refreshPlanetaryPositions: refreshPlanetaryPositions,
            setDaytime,
            updateState
        }, children: children }));
};
exports.AlchemicalProvider = AlchemicalProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9jb250ZXh0cy9BbGNoZW1pY2FsQ29udGV4dC9wcm92aWRlci50c3giLCJtYXBwaW5ncyI6IjtBQUFBLFlBQVksQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRWIsK0NBQTRFO0FBRTVFLDJDQUE4QztBQUM5QyxxRUFBdUQ7QUFFdkQsdUNBQTREO0FBQzVELHVDQUE4QztBQWU5QyxxQ0FBcUM7QUFDckMsTUFBTSxNQUFNLEdBQUcsSUFBQSxxQkFBWSxFQUFDLG9CQUFvQixDQUFDLENBQUM7QUFFbEQsdUNBQXVDO0FBQ3ZDLFNBQVMsU0FBUyxDQUFJLElBQU8sRUFBRSxJQUFPO0lBQ3BDLElBQUksSUFBSSxLQUFLLElBQUk7UUFBRSxPQUFPLElBQUksQ0FBQztJQUMvQixJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUk7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUMvQyxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFFdkUsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFjLENBQUMsQ0FBQztJQUMxQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQWMsQ0FBQyxDQUFDO0lBRTFDLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUMsTUFBTTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBRWhELEtBQUssTUFBTSxHQUFHLElBQUksS0FBSyxFQUFFO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxTQUFTLENBQUUsSUFBZ0MsQ0FBQyxHQUFHLENBQUMsRUFBRyxJQUFnQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUM7S0FDOUc7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QVcsQ0FBQztRQUNoRCxJQUFJLElBQUksSUFBSSxFQUFFLElBQUksSUFBSSxHQUFHLEVBQUU7WUFBRSxPQUFPLFNBQVMsQ0FBQztRQUM5QyxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDLENBQUM7SUFFRixNQUFNLFVBQVUsR0FBRyxJQUFBLG1CQUFXLEVBQUMsQ0FBQyxLQUFjLEVBQUUsRUFBRTtRQUNoRCxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEIsTUFBTSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM5QyxnREFBZ0Q7UUFDaEQsSUFBSSxhQUFhLEVBQUU7WUFDakIseUJBQXlCLEVBQUUsQ0FBQztTQUM3QjtJQUNILENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7SUFFL0MsTUFBTSxXQUFXLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsWUFBc0MsRUFBRSxFQUFFO1FBQ3pFLFFBQVEsQ0FBQztZQUNQLElBQUksRUFBRSxjQUFjO1lBQ3BCLE9BQU8sRUFBRSxZQUFZO1NBQ3RCLENBQUMsQ0FBQztJQUNMLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUVQLE9BQU8sQ0FDTCx1QkFBQywyQkFBaUIsQ0FBQyxRQUFRLElBQ3pCLEtBQUssRUFBRTtZQUNMLEtBQUs7WUFDTCxRQUFRO1lBQ1Isa0JBQWtCLEVBQUUsa0JBQTZDO1lBQ2pFLFNBQVM7WUFDVCx3QkFBd0IsRUFBRSx3QkFBd0U7WUFDbEcseUJBQXlCLEVBQUUseUJBQW1FO1lBQzlGLFVBQVU7WUFDVixXQUFXO1NBQ1osWUFFQSxRQUFRLEdBQ2tCLENBQzlCLENBQUM7QUFDSixDQUFDLENBQUM7QUEvTlcsUUFBQSxrQkFBa0Isc0JBK043QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL2NvbnRleHRzL0FsY2hlbWljYWxDb250ZXh0L3Byb3ZpZGVyLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGNsaWVudCc7XG5cbmltcG9ydCBSZWFjdCwgeyB1c2VSZWR1Y2VyLCB1c2VTdGF0ZSwgdXNlQ2FsbGJhY2ssIHVzZUVmZmVjdCB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyIH0gZnJvbSAnQC91dGlscy9sb2dnZXInO1xuaW1wb3J0ICogYXMgc2FmZUFzdHJvbG9neSBmcm9tICdAL3V0aWxzL3NhZmVBc3Ryb2xvZ3knO1xuXG5pbXBvcnQgeyBBbGNoZW1pY2FsQ29udGV4dCwgZGVmYXVsdFN0YXRlIH0gZnJvbSAnLi9jb250ZXh0JztcbmltcG9ydCB7IGFsY2hlbWljYWxSZWR1Y2VyIH0gZnJvbSAnLi9yZWR1Y2VyJztcbmltcG9ydCB7IFBsYW5ldGFyeVBvc2l0aW9uc1R5cGUsIEFzdHJvbG9naWNhbFN0YXRlLCBBbGNoZW1pY2FsU3RhdGUgfSBmcm9tICcuL3R5cGVzJztcblxuLy8gUGhhc2UgNTogVHlwZS1zYWZlIGNvbnZlcnNpb24gaW50ZXJmYWNlcyBmb3IgYWxjaGVtaWNhbCBjYWxjdWxhdGlvbnNcbmludGVyZmFjZSBDYWxjdWxhdGlvbkNvbXBhdGlibGVQb3NpdGlvbiB7XG4gIHNpZ24/OiBzdHJpbmc7XG4gIGRlZ3JlZT86IG51bWJlcjtcbiAgaXNSZXRyb2dyYWRlPzogYm9vbGVhbjtcbiAgW2tleTogc3RyaW5nXTogdW5rbm93bjtcbn1cblxuaW50ZXJmYWNlIENhbGN1bGF0aW9uQ29tcGF0aWJsZVBvc2l0aW9ucyB7XG4gIFtrZXk6IHN0cmluZ106IENhbGN1bGF0aW9uQ29tcGF0aWJsZVBvc2l0aW9uO1xufVxuXG4vLyBDcmVhdGUgYSBjb21wb25lbnQtc3BlY2lmaWMgbG9nZ2VyXG5jb25zdCBsb2dnZXIgPSBjcmVhdGVMb2dnZXIoJ0FsY2hlbWljYWxQcm92aWRlcicpO1xuXG4vLyBGdW5jdGlvbiB0byBkbyBhIGRlZXAgZXF1YWxpdHkgY2hlY2tcbmZ1bmN0aW9uIGRlZXBFcXVhbDxUPihvYmoxOiBULCBvYmoyOiBUKTogYm9vbGVhbiB7XG4gIGlmIChvYmoxID09PSBvYmoyKSByZXR1cm4gdHJ1ZTtcbiAgaWYgKG9iajEgPT0gbnVsbCB8fCBvYmoyID09IG51bGwpIHJldHVybiBmYWxzZTtcbiAgaWYgKHR5cGVvZiBvYmoxICE9PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqMiAhPT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTtcbiAgXG4gIGNvbnN0IGtleXMxID0gT2JqZWN0LmtleXMob2JqMSBhcyBvYmplY3QpO1xuICBjb25zdCBrZXlzMiA9IE9iamVjdC5rZXlzKG9iajIgYXMgb2JqZWN0KTtcbiAgXG4gIGlmIChrZXlzMS5sZW5ndGggIT09IGtleXMyLmxlbmd0aCkgcmV0dXJuIGZhbHNlO1xuICBcbiAgZm9yIChjb25zdCBrZXkgb2Yga2V5czEpIHtcbiAgICBpZiAoIWtleXMyLmluY2x1ZGVzKGtleSkpIHJldHVybiBmYWxzZTtcbiAgICBpZiAoIWRlZXBFcXVhbCgob2JqMSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilba2V5XSwgKG9iajIgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pW2tleV0pKSByZXR1cm4gZmFsc2U7XG4gIH1cbiAgXG4gIHJldHVybiB0cnVlO1xufVxuXG4vLyBDYWxjdWxhdGUgYWN0aXZlIHBsYW5ldHMgYmFzZWQgb24gZGlnbml0eSBhbmQgb3RoZXIgZmFjdG9yc1xuY29uc3QgY2FsY3VsYXRlQWN0aXZlUGxhbmV0cyA9IChwb3NpdGlvbnM6IFBsYW5ldGFyeVBvc2l0aW9uc1R5cGUpOiBzdHJpbmdbXSA9PiB7XG4gIGlmICghcG9zaXRpb25zKSByZXR1cm4gW107XG4gIFxuICAvLyBCYXNpYyBpbXBsZW1lbnRhdGlvbiBqdXN0IHJldHVybnMgdGhlIG1ham9yIHBsYW5ldHNcbiAgY29uc3QgYWN0aXZlUGxhbmV0czogc3RyaW5nW10gPSBbXTtcbiAgXG4gIHRyeSB7XG4gICAgLy8gQWRkIG1haW4gcGxhbmV0cyAodXNpbmcgY2FwaXRhbGl6ZWQgbmFtZXMgdG8gbWF0Y2ggcHJvdmVuIHdvcmtpbmcgaW1wbGVtZW50YXRpb24pXG4gICAgY29uc3QgbWFpblBsYW5ldHMgPSBbJ1N1bicsICdNb29uJywgJ01lcmN1cnknLCAnVmVudXMnLCAnTWFycycsICdKdXBpdGVyJywgJ1NhdHVybiddO1xuICAgIG1haW5QbGFuZXRzLmZvckVhY2gocGxhbmV0ID0+IHtcbiAgICAgIGlmIChwb3NpdGlvbnNbcGxhbmV0XSkge1xuICAgICAgICBhY3RpdmVQbGFuZXRzLnB1c2gocGxhbmV0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICAvLyBBbHdheXMgaW5jbHVkZSBsdW1pbmFyaWVzIChTdW4gYW5kIE1vb24pIGFzIHRoZXkncmUgY29uc3RhbnRseSBhY3RpdmVcbiAgICBpZiAoIWFjdGl2ZVBsYW5ldHMuaW5jbHVkZXMoJ1N1bicpKSBhY3RpdmVQbGFuZXRzLnB1c2goJ1N1bicpO1xuICAgIGlmICghYWN0aXZlUGxhbmV0cy5pbmNsdWRlcygnTW9vbicpKSBhY3RpdmVQbGFuZXRzLnB1c2goJ01vb24nKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNhbGN1bGF0aW5nIGFjdGl2ZSBwbGFuZXRzOicsIGVycm9yKTtcbiAgICAvLyBSZXR1cm4gYXQgbGVhc3QgdGhlIHN1biBhbmQgbW9vbiBhcyBmYWxsYmFjayAoY2FwaXRhbGl6ZWQpXG4gICAgcmV0dXJuIFsnU3VuJywgJ01vb24nXTtcbiAgfVxuICBcbiAgcmV0dXJuIGFjdGl2ZVBsYW5ldHM7XG59O1xuXG4vLyBTYWZlIHR5cGUgY29udmVyc2lvbiBmdW5jdGlvbiB0byByZXBsYWNlICdhcyBhbnknIGNhc3RzXG5jb25zdCBjb252ZXJ0VG9DYWxjdWxhdGlvbkZvcm1hdCA9IChwb3NpdGlvbnM6IFBsYW5ldGFyeVBvc2l0aW9uc1R5cGUpOiBDYWxjdWxhdGlvbkNvbXBhdGlibGVQb3NpdGlvbnMgPT4ge1xuICBjb25zdCBjb252ZXJ0ZWQ6IENhbGN1bGF0aW9uQ29tcGF0aWJsZVBvc2l0aW9ucyA9IHt9O1xuICBcbiAgT2JqZWN0LmVudHJpZXMocG9zaXRpb25zKS5mb3JFYWNoKChbcGxhbmV0LCBwb3NpdGlvbl0pID0+IHtcbiAgICBpZiAocG9zaXRpb24gJiYgdHlwZW9mIHBvc2l0aW9uID09PSAnb2JqZWN0Jykge1xuICAgICAgY29udmVydGVkW3BsYW5ldF0gPSB7XG4gICAgICAgIHNpZ246IHBvc2l0aW9uLnNpZ24sXG4gICAgICAgIGRlZ3JlZTogcG9zaXRpb24uZGVncmVlLFxuICAgICAgICBpc1JldHJvZ3JhZGU6IHBvc2l0aW9uLmlzUmV0cm9ncmFkZSxcbiAgICAgICAgLy8gUHJlc2VydmUgYW55IGFkZGl0aW9uYWwgcHJvcGVydGllcyBzYWZlbHlcbiAgICAgICAgLi4ucG9zaXRpb25cbiAgICAgIH07XG4gICAgfVxuICB9KTtcbiAgXG4gIHJldHVybiBjb252ZXJ0ZWQ7XG59O1xuXG4vLyBFeHBvcnQgdGhlIHByb3ZpZGVyIGNvbXBvbmVudFxuZXhwb3J0IGNvbnN0IEFsY2hlbWljYWxQcm92aWRlcjogUmVhY3QuRkM8e2NoaWxkcmVuOiBSZWFjdC5SZWFjdE5vZGV9PiA9ICh7IGNoaWxkcmVuIH0pID0+IHtcbiAgY29uc3QgW3N0YXRlLCBkaXNwYXRjaF0gPSB1c2VSZWR1Y2VyKGFsY2hlbWljYWxSZWR1Y2VyLCBkZWZhdWx0U3RhdGUpO1xuICBjb25zdCBbcGxhbmV0YXJ5UG9zaXRpb25zLCBzZXRQbGFuZXRhcnlQb3NpdGlvbnNdID0gdXNlU3RhdGU8UGxhbmV0YXJ5UG9zaXRpb25zVHlwZT4oe30pO1xuICBjb25zdCBbaXNEYXl0aW1lLCBzZXRJc0RheXRpbWVdID0gdXNlU3RhdGUodHJ1ZSk7XG4gIGNvbnN0IFtpc0luaXRpYWxpemVkLCBzZXRJc0luaXRpYWxpemVkXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICAvLyBJbml0aWFsaXplIGRhdGEgb25jZSBvbiBtb3VudFxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmICghaXNJbml0aWFsaXplZCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBBbGNoZW1pY2FsUHJvdmlkZXIgaW5pdGlhbGl6aW5nYCk7XG4gICAgICBzZXRJc0luaXRpYWxpemVkKHRydWUpO1xuICAgICAgcmVmcmVzaFBsYW5ldGFyeVBvc2l0aW9ucygpOyAvLyBJbml0aWFsIGZldGNoIG9mIHBsYW5ldGFyeSBwb3NpdGlvbnNcbiAgICB9XG4gIH0sIFtpc0luaXRpYWxpemVkXSk7XG5cbiAgLy8gU3luY2hyb25pemUgYWxjaGVtaWNhbCB2YWx1ZXMgYmV0d2VlbiBzdGF0ZSBhbmQgYXN0cm9sb2dpY2FsU3RhdGVcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICAvLyBDaGVjayBpZiBhc3Ryb2xvZ2ljYWxTdGF0ZSBleGlzdHMgYW5kIGhhcyBhbGNoZW1pY2FsVmFsdWVzXG4gICAgaWYgKHN0YXRlLmFzdHJvbG9naWNhbFN0YXRlLmFsY2hlbWljYWxWYWx1ZXMpIHtcbiAgICAgIC8vIElmIHRoZSB2YWx1ZXMgZGlmZmVyLCB1cGRhdGUgdGhlIG1haW4gc3RhdGUgYWxjaGVtaWNhbFZhbHVlc1xuICAgICAgaWYgKCFkZWVwRXF1YWwoc3RhdGUuYWxjaGVtaWNhbFZhbHVlcywgc3RhdGUuYXN0cm9sb2dpY2FsU3RhdGUuYWxjaGVtaWNhbFZhbHVlcykpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdTeW5jaHJvbml6aW5nIGFsY2hlbWljYWwgdmFsdWVzIGZyb20gYXN0cm9sb2dpY2FsU3RhdGUgdG8gcm9vdCBzdGF0ZScpO1xuICAgICAgICBkaXNwYXRjaCh7XG4gICAgICAgICAgdHlwZTogJ1NFVF9BTENIRU1JQ0FMX1ZBTFVFUycsXG4gICAgICAgICAgcGF5bG9hZDogKHN0YXRlLmFzdHJvbG9naWNhbFN0YXRlLmFsY2hlbWljYWxWYWx1ZXMgJiYgT2JqZWN0LmtleXMoc3RhdGUuYXN0cm9sb2dpY2FsU3RhdGUuYWxjaGVtaWNhbFZhbHVlcykubGVuZ3RoID09PSA0KVxuICAgICAgICAgICAgPyBzdGF0ZS5hc3Ryb2xvZ2ljYWxTdGF0ZS5hbGNoZW1pY2FsVmFsdWVzIGFzIHsgU3Bpcml0OiBudW1iZXI7IEVzc2VuY2U6IG51bWJlcjsgTWF0dGVyOiBudW1iZXI7IFN1YnN0YW5jZTogbnVtYmVyIH1cbiAgICAgICAgICAgIDogeyBTcGlyaXQ6IDAuMjUsIEVzc2VuY2U6IDAuMjUsIE1hdHRlcjogMC4yNSwgU3Vic3RhbmNlOiAwLjI1IH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChzdGF0ZS5hc3Ryb2xvZ2ljYWxTdGF0ZSkge1xuICAgICAgLy8gSWYgYXN0cm9sb2dpY2FsU3RhdGUgZXhpc3RzIGJ1dCBkb2Vzbid0IGhhdmUgYWxjaGVtaWNhbFZhbHVlcywgYWRkIHRoZW0gZnJvbSByb290IHN0YXRlXG4gICAgICBjb25zdCB1cGRhdGVkQXN0cm9TdGF0ZSA9IHtcbiAgICAgICAgLi4uc3RhdGUuYXN0cm9sb2dpY2FsU3RhdGUsXG4gICAgICAgIGFsY2hlbWljYWxWYWx1ZXM6IChzdGF0ZS5hbGNoZW1pY2FsVmFsdWVzICYmIE9iamVjdC5rZXlzKHN0YXRlLmFsY2hlbWljYWxWYWx1ZXMpLmxlbmd0aCA9PT0gNClcbiAgICAgICAgICA/IHN0YXRlLmFsY2hlbWljYWxWYWx1ZXNcbiAgICAgICAgICA6IHsgU3Bpcml0OiAwLjI1LCBFc3NlbmNlOiAwLjI1LCBNYXR0ZXI6IDAuMjUsIFN1YnN0YW5jZTogMC4yNSB9XG4gICAgICB9O1xuICAgICAgXG4gICAgICBkaXNwYXRjaCh7XG4gICAgICAgIHR5cGU6ICdTRVRfQVNUUk9MT0dJQ0FMX1NUQVRFJyxcbiAgICAgICAgcGF5bG9hZDogdXBkYXRlZEFzdHJvU3RhdGVcbiAgICAgIH0pO1xuICAgIH1cbiAgfSwgW3N0YXRlLmFzdHJvbG9naWNhbFN0YXRlXSk7XG5cbiAgY29uc3QgdXBkYXRlUGxhbmV0YXJ5UG9zaXRpb25zID0gdXNlQ2FsbGJhY2soKHBvc2l0aW9uczogUGxhbmV0YXJ5UG9zaXRpb25zVHlwZSkgPT4ge1xuICAgIC8vIE9ubHkgdXBkYXRlIGlmIHBvc2l0aW9ucyBhcmUgZGlmZmVyZW50IHVzaW5nIGRlZXAgZXF1YWxpdHlcbiAgICBzZXRQbGFuZXRhcnlQb3NpdGlvbnMocHJldiA9PiB7XG4gICAgICAvLyBTa2lwIHVwZGF0ZSBpZiBwb3NpdGlvbnMgYXJlIGlkZW50aWNhbCB0byBwcmV2ZW50IHJlLXJlbmRlcnNcbiAgICAgIGlmIChkZWVwRXF1YWwocHJldiwgcG9zaXRpb25zKSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ1NraXBwaW5nIGlkZW50aWNhbCBwbGFuZXRhcnkgcG9zaXRpb25zIHVwZGF0ZScpO1xuICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgbG9nZ2VyLmluZm8oJ1VwZGF0aW5nIHBsYW5ldGFyeSBwb3NpdGlvbnMnLCB7XG4gICAgICAgIHN1bjogcG9zaXRpb25zLlN1bi5zaWduLFxuICAgICAgICBtb29uOiBwb3NpdGlvbnMuTW9vbi5zaWduLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcG9zaXRpb25zO1xuICAgIH0pO1xuICB9LCBbXSk7XG5cbiAgY29uc3QgcmVmcmVzaFBsYW5ldGFyeVBvc2l0aW9ucyA9IHVzZUNhbGxiYWNrKGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdSZWZyZXNoaW5nIHBsYW5ldGFyeSBwb3NpdGlvbnMuLi4nKTtcbiAgICAgIFxuICAgICAgLy8gVXNlIHJlbGlhYmxlIGhhcmRjb2RlZCBwb3NpdGlvbnNcbiAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNhZmVBc3Ryb2xvZ3kuZ2V0UmVsaWFibGVQbGFuZXRhcnlQb3NpdGlvbnMoKTtcbiAgICAgIFxuICAgICAgLy8gTm9ybWFsaXplIGtleXMgdG8gY2FwaXRhbGl6ZWQgZm9ybWF0IGZvciBjb25zaXN0ZW5jeSB3aXRoIHByb3ZlbiB3b3JraW5nIGltcGxlbWVudGF0aW9uXG4gICAgICBjb25zdCBub3JtYWxpemVkUG9zaXRpb25zOiBQbGFuZXRhcnlQb3NpdGlvbnNUeXBlID0ge307XG4gICAgICBPYmplY3QuZW50cmllcyhwb3NpdGlvbnMpLmZvckVhY2goKFtrZXksIGRhdGFdKSA9PiB7XG4gICAgICAgIGlmICghZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gJ29iamVjdCcpIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHBsYW5ldCA9IGtleS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSgxKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBub3JtYWxpemVkUG9zaXRpb25zW3BsYW5ldF0gPSB7XG4gICAgICAgICAgc2lnbjogZGF0YS5zaWduPy50b0xvd2VyQ2FzZSgpIHx8ICd1bmtub3duJyxcbiAgICAgICAgICBkZWdyZWU6IHR5cGVvZiBkYXRhLmRlZ3JlZSA9PT0gJ251bWJlcicgPyBkYXRhLmRlZ3JlZSA6IDAsXG4gICAgICAgICAgZXhhY3RMb25naXR1ZGU6IHR5cGVvZiBkYXRhLmV4YWN0TG9uZ2l0dWRlID09PSAnbnVtYmVyJyA/IGRhdGEuZXhhY3RMb25naXR1ZGUgOiAwLFxuICAgICAgICAgIGlzUmV0cm9ncmFkZTogISFkYXRhLmlzUmV0cm9ncmFkZVxuICAgICAgICB9O1xuICAgICAgfSk7XG5cbiAgICAgIHVwZGF0ZVBsYW5ldGFyeVBvc2l0aW9ucyhub3JtYWxpemVkUG9zaXRpb25zKTtcbiAgICAgIFxuICAgICAgLy8gSW1wb3J0IGNhbGN1bGF0aW9uIHV0aWxpdGllc1xuICAgICAgY29uc3QgeyBcbiAgICAgICAgY2FsY3VsYXRlRWxlbWVudGFsVmFsdWVzLCBcbiAgICAgICAgY2FsY3VsYXRlUGxhbmV0YXJ5QWxjaGVtaWNhbFZhbHVlcywgXG4gICAgICAgIGNhbGN1bGF0ZUVsZW1lbnRhbEJhbGFuY2UgXG4gICAgICB9ID0gYXdhaXQgaW1wb3J0KCdAL3V0aWxzL2FsY2hlbWljYWxDYWxjdWxhdGlvbnMnKTtcbiAgICAgIFxuICAgICAgLy8gQ2FsY3VsYXRlIGVsZW1lbnRhbCBhbmQgYWxjaGVtaWNhbCB2YWx1ZXMgdXNpbmcgdHlwZS1zYWZlIGNvbnZlcnNpb25cbiAgICAgIGNvbnN0IGNvbXBhdGlibGVQb3NpdGlvbnMgPSBjb252ZXJ0VG9DYWxjdWxhdGlvbkZvcm1hdChub3JtYWxpemVkUG9zaXRpb25zKTtcbiAgICAgIGNvbnN0IGVsZW1lbnRhbFZhbHVlcyA9IGNhbGN1bGF0ZUVsZW1lbnRhbFZhbHVlcyhjb21wYXRpYmxlUG9zaXRpb25zKTtcbiAgICAgIGNvbnN0IHBsYW5ldGFyeVZhbHVlcyA9IGNhbGN1bGF0ZVBsYW5ldGFyeUFsY2hlbWljYWxWYWx1ZXMoY29tcGF0aWJsZVBvc2l0aW9ucyk7XG4gICAgICBjb25zdCBlbGVtZW50YWxCYWxhbmNlID0gY2FsY3VsYXRlRWxlbWVudGFsQmFsYW5jZShjb21wYXRpYmxlUG9zaXRpb25zKTtcbiAgICAgIFxuICAgICAgLy8gQ29tYmluZSBlbGVtZW50YWwgYW5kIHBsYW5ldGFyeSBpbmZsdWVuY2VzICh3ZWlnaHRlZCBhdmVyYWdlKVxuICAgICAgY29uc3QgY29tYmluZWRBbGNoZW1pY2FsVmFsdWVzID0ge1xuICAgICAgICBTcGlyaXQ6IChlbGVtZW50YWxWYWx1ZXMuU3Bpcml0ICogMC41KSArIChwbGFuZXRhcnlWYWx1ZXMuU3Bpcml0ICogMC41KSxcbiAgICAgICAgRXNzZW5jZTogKGVsZW1lbnRhbFZhbHVlcy5Fc3NlbmNlICogMC41KSArIChwbGFuZXRhcnlWYWx1ZXMuRXNzZW5jZSAqIDAuNSksXG4gICAgICAgIE1hdHRlcjogKGVsZW1lbnRhbFZhbHVlcy5NYXR0ZXIgKiAwLjUpICsgKHBsYW5ldGFyeVZhbHVlcy5NYXR0ZXIgKiAwLjUpLFxuICAgICAgICBTdWJzdGFuY2U6IChlbGVtZW50YWxWYWx1ZXMuU3Vic3RhbmNlICogMC41KSArIChwbGFuZXRhcnlWYWx1ZXMuU3Vic3RhbmNlICogMC41KVxuICAgICAgfTtcbiAgICAgIFxuICAgICAgLy8gTm9ybWFsaXplIGFsY2hlbWljYWwgdmFsdWVzIHRvIGVuc3VyZSB0aGV5IHN1bSB0byBhcHByb3hpbWF0ZWx5IDFcbiAgICAgIGNvbnN0IHRvdGFsID0gY29tYmluZWRBbGNoZW1pY2FsVmFsdWVzLlNwaXJpdCArIGNvbWJpbmVkQWxjaGVtaWNhbFZhbHVlcy5Fc3NlbmNlICsgXG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkQWxjaGVtaWNhbFZhbHVlcy5NYXR0ZXIgKyBjb21iaW5lZEFsY2hlbWljYWxWYWx1ZXMuU3Vic3RhbmNlO1xuICAgICAgXG4gICAgICBjb25zdCBub3JtYWxpemVkQWxjaGVtaWNhbFZhbHVlcyA9IHtcbiAgICAgICAgU3Bpcml0OiBjb21iaW5lZEFsY2hlbWljYWxWYWx1ZXMuU3Bpcml0IC8gdG90YWwsXG4gICAgICAgIEVzc2VuY2U6IGNvbWJpbmVkQWxjaGVtaWNhbFZhbHVlcy5Fc3NlbmNlIC8gdG90YWwsXG4gICAgICAgIE1hdHRlcjogY29tYmluZWRBbGNoZW1pY2FsVmFsdWVzLk1hdHRlciAvIHRvdGFsLFxuICAgICAgICBTdWJzdGFuY2U6IGNvbWJpbmVkQWxjaGVtaWNhbFZhbHVlcy5TdWJzdGFuY2UgLyB0b3RhbFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgbG9nZ2VyLmRlYnVnKCdDYWxjdWxhdGVkIGFsY2hlbWljYWwgdmFsdWVzOicsIG5vcm1hbGl6ZWRBbGNoZW1pY2FsVmFsdWVzKTtcbiAgICAgIFxuICAgICAgLy8gVXBkYXRlIHN0YXRlIHdpdGggY2FsY3VsYXRlZCB2YWx1ZXNcbiAgICAgIGNvbnN0IGFjdGl2ZVBsYW5ldHMgPSBjYWxjdWxhdGVBY3RpdmVQbGFuZXRzKG5vcm1hbGl6ZWRQb3NpdGlvbnMpO1xuICAgICAgY29uc3Qgc3VuU2lnbiA9IG5vcm1hbGl6ZWRQb3NpdGlvbnMuU3VuLnNpZ24gfHwgJ2FyaWVzJztcbiAgICAgIGNvbnN0IG1vb25TaWduID0gbm9ybWFsaXplZFBvc2l0aW9ucy5Nb29uLnNpZ24gfHwgJ3RhdXJ1cyc7XG4gICAgICBcbiAgICAgIC8vIEZpcnN0IHVwZGF0ZSB0aGUgYWxjaGVtaWNhbCB2YWx1ZXMgYXQgdGhlIHJvb3Qgb2YgdGhlIHN0YXRlXG4gICAgICBkaXNwYXRjaCh7XG4gICAgICAgIHR5cGU6ICdTRVRfQUxDSEVNSUNBTF9WQUxVRVMnLFxuICAgICAgICBwYXlsb2FkOiBub3JtYWxpemVkQWxjaGVtaWNhbFZhbHVlc1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIC8vIFVwZGF0ZSBlbGVtZW50YWwgc3RhdGVcbiAgICAgIGRpc3BhdGNoKHtcbiAgICAgICAgdHlwZTogJ1NFVF9FTEVNRU5UQUxfU1RBVEUnLFxuICAgICAgICBwYXlsb2FkOiBlbGVtZW50YWxCYWxhbmNlXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgLy8gU3luYyB3aXRoIEVsZW1lbnRhbENhbGN1bGF0b3JcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgRWxlbWVudGFsQ2FsY3VsYXRvciB9ID0gYXdhaXQgaW1wb3J0KCdAL3NlcnZpY2VzL0VsZW1lbnRhbENhbGN1bGF0b3InKTtcbiAgICAgICAgRWxlbWVudGFsQ2FsY3VsYXRvci51cGRhdGVFbGVtZW50YWxTdGF0ZShlbGVtZW50YWxCYWxhbmNlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignRXJyb3Igc3luY2luZyBFbGVtZW50YWxDYWxjdWxhdG9yIHN0YXRlOicsIGVycm9yKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gVGhlbiB1cGRhdGUgdGhlIGFzdHJvbG9naWNhbCBzdGF0ZSB3aXRoIHRoZSBzYW1lIHZhbHVlc1xuICAgICAgY29uc3QgYXN0cm9sb2dpY2FsU3RhdGU6IEFzdHJvbG9naWNhbFN0YXRlID0ge1xuICAgICAgICBzdW5TaWduLFxuICAgICAgICBtb29uU2lnbixcbiAgICAgICAgbHVuYXJQaGFzZTogc2FmZUFzdHJvbG9neS5nZXRMdW5hclBoYXNlTmFtZShzYWZlQXN0cm9sb2d5LmNhbGN1bGF0ZUx1bmFyUGhhc2UoKSksIC8vIENhbGN1bGF0ZSBhY3R1YWwgbHVuYXIgcGhhc2VcbiAgICAgICAgdGltZU9mRGF5OiBnZXRUaW1lT2ZEYXkoKSxcbiAgICAgICAgaXNEYXl0aW1lLFxuICAgICAgICBwbGFuZXRhcnlIb3VyOiAnc3VuJywgLy8gVGhpcyB3b3VsZCBiZSBjYWxjdWxhdGVkXG4gICAgICAgIHpvZGlhY1NpZ246IHN1blNpZ24sXG4gICAgICAgIGFjdGl2ZVBsYW5ldHMsXG4gICAgICAgIGFjdGl2ZUFzcGVjdHM6IFtdLFxuICAgICAgICBkb21pbmFudEVsZW1lbnQ6ICdGaXJlJyxcbiAgICAgICAgY2FsY3VsYXRpb25FcnJvcjogZmFsc2UsXG4gICAgICAgIGFsY2hlbWljYWxWYWx1ZXM6IG5vcm1hbGl6ZWRBbGNoZW1pY2FsVmFsdWVzLFxuICAgICAgICBjdXJyZW50Wm9kaWFjOiBzdW5TaWduLFxuICAgICAgICBtb29uUGhhc2U6IHNhZmVBc3Ryb2xvZ3kuZ2V0THVuYXJQaGFzZU5hbWUoc2FmZUFzdHJvbG9neS5jYWxjdWxhdGVMdW5hclBoYXNlKCkpXG4gICAgICB9O1xuICAgICAgXG4gICAgICBkaXNwYXRjaCh7XG4gICAgICAgIHR5cGU6ICdTRVRfQVNUUk9MT0dJQ0FMX1NUQVRFJyxcbiAgICAgICAgcGF5bG9hZDogYXN0cm9sb2dpY2FsU3RhdGVcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICByZXR1cm4gbm9ybWFsaXplZFBvc2l0aW9ucztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciByZWZyZXNoaW5nIHBsYW5ldGFyeSBwb3NpdGlvbnM6JywgZXJyb3IpO1xuICAgICAgZGlzcGF0Y2goe1xuICAgICAgICB0eXBlOiAnU0VUX0VSUk9SJyxcbiAgICAgICAgcGF5bG9hZDogeyBtZXNzYWdlOiAnRmFpbGVkIHRvIHJlZnJlc2ggcGxhbmV0YXJ5IHBvc2l0aW9ucycgfVxuICAgICAgfSk7XG4gICAgICAvLyBQYXR0ZXJuIEpKLTI6IEFsY2hlbWljYWxTdGF0ZSBJbnRlcmZhY2UgQ29tcGxldGlvbiAtIFJldHVybiBwcm9wZXIgc3RydWN0dXJlIGluc3RlYWQgb2YgZW1wdHkgb2JqZWN0XG4gICAgICByZXR1cm4ge1xuICAgICAgICBTdW46IHsgc2lnbjogJ2FyaWVzJywgZGVncmVlOiAwLCBleGFjdExvbmdpdHVkZTogMCwgaXNSZXRyb2dyYWRlOiBmYWxzZSB9LFxuICAgICAgICBNb29uOiB7IHNpZ246ICd0YXVydXMnLCBkZWdyZWU6IDAsIGV4YWN0TG9uZ2l0dWRlOiAwLCBpc1JldHJvZ3JhZGU6IGZhbHNlIH1cbiAgICAgIH07XG4gICAgfVxuICB9LCBbaXNEYXl0aW1lLCB1cGRhdGVQbGFuZXRhcnlQb3NpdGlvbnNdKTtcblxuICBjb25zdCBnZXRUaW1lT2ZEYXkgPSAoKSA9PiB7XG4gICAgY29uc3QgaG91ciA9IG5ldyBEYXRlKCkuZ2V0SG91cnMoKTtcbiAgICBpZiAoaG91ciA+PSA1ICYmIGhvdXIgPCAxMikgcmV0dXJuICdtb3JuaW5nJztcbiAgICBpZiAoaG91ciA+PSAxMiAmJiBob3VyIDwgMTcpIHJldHVybiAnYWZ0ZXJub29uJztcbiAgICBpZiAoaG91ciA+PSAxNyAmJiBob3VyIDwgMjEpIHJldHVybiAnZXZlbmluZyc7XG4gICAgcmV0dXJuICduaWdodCc7XG4gIH07XG5cbiAgY29uc3Qgc2V0RGF5dGltZSA9IHVzZUNhbGxiYWNrKCh2YWx1ZTogYm9vbGVhbikgPT4ge1xuICAgIHNldElzRGF5dGltZSh2YWx1ZSk7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGlzRGF5dGltZSB0byAke3ZhbHVlfWApO1xuICAgIC8vIFJlZnJlc2ggcGxhbmV0YXJ5IHBvc2l0aW9ucyBvbiBkYXl0aW1lIGNoYW5nZVxuICAgIGlmIChpc0luaXRpYWxpemVkKSB7XG4gICAgICByZWZyZXNoUGxhbmV0YXJ5UG9zaXRpb25zKCk7XG4gICAgfVxuICB9LCBbaXNJbml0aWFsaXplZCwgcmVmcmVzaFBsYW5ldGFyeVBvc2l0aW9uc10pO1xuXG4gIGNvbnN0IHVwZGF0ZVN0YXRlID0gdXNlQ2FsbGJhY2soKHVwZGF0ZWRTdGF0ZTogUGFydGlhbDxBbGNoZW1pY2FsU3RhdGU+KSA9PiB7XG4gICAgZGlzcGF0Y2goe1xuICAgICAgdHlwZTogJ1VQREFURV9TVEFURScsXG4gICAgICBwYXlsb2FkOiB1cGRhdGVkU3RhdGVcbiAgICB9KTtcbiAgfSwgW10pO1xuXG4gIHJldHVybiAoXG4gICAgPEFsY2hlbWljYWxDb250ZXh0LlByb3ZpZGVyIFxuICAgICAgdmFsdWU9e3sgXG4gICAgICAgIHN0YXRlLCBcbiAgICAgICAgZGlzcGF0Y2gsIFxuICAgICAgICBwbGFuZXRhcnlQb3NpdGlvbnM6IHBsYW5ldGFyeVBvc2l0aW9ucyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgICAgICAgaXNEYXl0aW1lLCBcbiAgICAgICAgdXBkYXRlUGxhbmV0YXJ5UG9zaXRpb25zOiB1cGRhdGVQbGFuZXRhcnlQb3NpdGlvbnMgYXMgKHBvc2l0aW9uczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pID0+IHZvaWQsXG4gICAgICAgIHJlZnJlc2hQbGFuZXRhcnlQb3NpdGlvbnM6IHJlZnJlc2hQbGFuZXRhcnlQb3NpdGlvbnMgYXMgKCkgPT4gUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj4sXG4gICAgICAgIHNldERheXRpbWUsXG4gICAgICAgIHVwZGF0ZVN0YXRlXG4gICAgICB9fVxuICAgID5cbiAgICAgIHtjaGlsZHJlbn1cbiAgICA8L0FsY2hlbWljYWxDb250ZXh0LlByb3ZpZGVyPlxuICApO1xufTsgIl0sInZlcnNpb24iOjN9