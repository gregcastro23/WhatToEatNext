2d414e033f8a4f1dcbed7fb611fc23d2
"use strict";
/**
 * Agent Hooks for Automated Quality Assurance
 *
 * This module provides React hooks that integrate with Kiro's agent hook system
 * for automatic planetary data validation, ingredient consistency checking,
 * and campaign trigger management.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.useAgentHookConfiguration = exports.useQualityMetricsHook = exports.useBuildQualityMonitoringHook = exports.useTypeScriptCampaignHook = exports.useIngredientConsistencyHook = exports.usePlanetaryDataValidationHook = exports.useAgentHooks = void 0;
const react_1 = require("react");
const automatedQualityAssurance_1 = require("@/utils/automatedQualityAssurance");
const logger_1 = require("@/utils/logger");
/**
 * Main agent hook for automated quality assurance integration
 */
function useAgentHooks(config = {}) {
    const defaultConfig = {
        enablePlanetaryValidation: true,
        enableIngredientValidation: true,
        enableCampaignTriggers: true,
        enablePerformanceMonitoring: true,
        validationInterval: 5, // 5 minutes
    };
    const finalConfig = { ...defaultConfig, ...config };
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [hookState, setHookState] = (0, react_1.useState)({
        isActive: false,
        lastValidation: 0,
        validationResults: {},
        campaignTriggers: [],
        qualityMetrics: qa.getQualityMetrics(),
    });
    const intervalRef = (0, react_1.useRef)(null);
    // Start agent hooks
    const startAgentHooks = (0, react_1.useCallback)(() => {
        if (hookState.isActive)
            return;
        setHookState(prev => ({ ...prev, isActive: true }));
        // Set up validation interval
        intervalRef.current = setInterval(async () => {
            try {
                const results = {};
                // Planetary data validation
                if (finalConfig.enablePlanetaryValidation) {
                    const planetaryResult = await qa.validatePlanetaryData();
                    results.planetary = planetaryResult;
                    if (!planetaryResult.isValid) {
                        logger_1.logger.warn('Planetary data validation failed:', planetaryResult.issues);
                    }
                }
                // TypeScript error threshold check
                if (finalConfig.enableCampaignTriggers) {
                    const trigger = await qa.checkTypeScriptErrorThreshold();
                    if (trigger === null || trigger === void 0 ? void 0 : trigger.triggered) {
                        logger_1.logger.warn('TypeScript campaign trigger activated:', trigger);
                    }
                }
                // Update state
                setHookState(prev => ({
                    ...prev,
                    lastValidation: Date.now(),
                    validationResults: { ...prev.validationResults, ...results },
                    campaignTriggers: qa.getActiveCampaignTriggers(),
                    qualityMetrics: qa.getQualityMetrics(),
                }));
                logger_1.logger.debug('Agent hooks validation cycle completed');
            }
            catch (error) {
                logger_1.logger.error('Error in agent hooks validation cycle:', error);
            }
        }, finalConfig.validationInterval * 60 * 1000);
        logger_1.logger.info('Agent hooks started with config:', finalConfig);
    }, [finalConfig, hookState.isActive, qa]);
    // Stop agent hooks
    const stopAgentHooks = (0, react_1.useCallback)(() => {
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        setHookState(prev => ({ ...prev, isActive: false }));
        logger_1.logger.info('Agent hooks stopped');
    }, []);
    // Manual validation trigger
    const triggerValidation = (0, react_1.useCallback)(async (type) => {
        try {
            const results = {};
            if (!type || type === 'all' || type === 'planetary') {
                results.planetary = await qa.validatePlanetaryData();
            }
            if (!type || type === 'all' || type === 'typescript') {
                const trigger = await qa.checkTypeScriptErrorThreshold();
                if (trigger) {
                    setHookState(prev => ({
                        ...prev,
                        campaignTriggers: [...prev.campaignTriggers, trigger],
                    }));
                }
            }
            setHookState(prev => ({
                ...prev,
                lastValidation: Date.now(),
                validationResults: { ...prev.validationResults, ...results },
                qualityMetrics: qa.getQualityMetrics(),
            }));
            logger_1.logger.debug('Manual validation triggered:', { type, results });
            return results;
        }
        catch (error) {
            logger_1.logger.error('Error in manual validation:', error);
            throw error;
        }
    }, [qa]);
    // Cleanup on unmount
    (0, react_1.useEffect)(() => {
        return () => {
            stopAgentHooks();
        };
    }, [stopAgentHooks]);
    return {
        hookState,
        startAgentHooks,
        stopAgentHooks,
        triggerValidation,
        isActive: hookState.isActive,
    };
}
exports.useAgentHooks = useAgentHooks;
/**
 * Agent hook specifically for planetary data validation
 */
function usePlanetaryDataValidationHook(autoStart = true) {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [validationResult, setValidationResult] = (0, react_1.useState)(null);
    const [isValidating, setIsValidating] = (0, react_1.useState)(false);
    const validatePlanetaryData = (0, react_1.useCallback)(async (date) => {
        setIsValidating(true);
        try {
            const result = await qa.validatePlanetaryData(date);
            setValidationResult(result);
            if (!result.isValid) {
                logger_1.logger.warn('Planetary data validation hook detected issues:', result.issues);
                // Dispatch event for external systems
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('planetary-validation-failed', {
                        detail: result,
                    }));
                }
            }
            return result;
        }
        catch (error) {
            logger_1.logger.error('Error in planetary data validation hook:', error);
            throw error;
        }
        finally {
            setIsValidating(false);
        }
    }, [qa]);
    // Auto-start validation
    (0, react_1.useEffect)(() => {
        if (autoStart) {
            validatePlanetaryData();
        }
    }, [autoStart, validatePlanetaryData]);
    return {
        validationResult,
        isValidating,
        validatePlanetaryData,
        isValid: (_a = validationResult === null || validationResult === void 0 ? void 0 : validationResult.isValid) !== null && _a !== void 0 ? _a : null,
    };
}
exports.usePlanetaryDataValidationHook = usePlanetaryDataValidationHook;
/**
 * Agent hook for ingredient consistency checking
 */
function useIngredientConsistencyHook() {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [validationResult, setValidationResult] = (0, react_1.useState)(null);
    const [isValidating, setIsValidating] = (0, react_1.useState)(false);
    const validateIngredients = (0, react_1.useCallback)(async (ingredients) => {
        if (ingredients.length === 0) {
            return null;
        }
        setIsValidating(true);
        try {
            const result = qa.validateIngredientConsistency(ingredients);
            setValidationResult(result);
            if (!result.isValid) {
                logger_1.logger.warn('Ingredient consistency validation detected issues:', result.issues);
                // Dispatch event for external systems
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('ingredient-validation-failed', {
                        detail: { result, ingredients },
                    }));
                }
            }
            return result;
        }
        catch (error) {
            logger_1.logger.error('Error in ingredient consistency validation:', error);
            throw error;
        }
        finally {
            setIsValidating(false);
        }
    }, [qa]);
    return {
        validationResult,
        isValidating,
        validateIngredients,
        isValid: (_a = validationResult === null || validationResult === void 0 ? void 0 : validationResult.isValid) !== null && _a !== void 0 ? _a : null,
    };
}
exports.useIngredientConsistencyHook = useIngredientConsistencyHook;
/**
 * Agent hook for TypeScript campaign triggers
 */
function useTypeScriptCampaignHook(autoCheck = true) {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [campaignTrigger, setCampaignTrigger] = (0, react_1.useState)(null);
    const [isChecking, setIsChecking] = (0, react_1.useState)(false);
    const checkErrorThreshold = (0, react_1.useCallback)(async () => {
        setIsChecking(true);
        try {
            const trigger = await qa.checkTypeScriptErrorThreshold();
            setCampaignTrigger(trigger);
            if (trigger === null || trigger === void 0 ? void 0 : trigger.triggered) {
                logger_1.logger.warn('TypeScript campaign trigger activated:', trigger);
                // Dispatch event for campaign system integration
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('typescript-campaign-trigger', {
                        detail: trigger,
                    }));
                }
            }
            return trigger;
        }
        catch (error) {
            logger_1.logger.error('Error checking TypeScript error threshold:', error);
            throw error;
        }
        finally {
            setIsChecking(false);
        }
    }, [qa]);
    // Auto-check on mount and periodically
    (0, react_1.useEffect)(() => {
        if (autoCheck) {
            checkErrorThreshold();
            // Check every 10 minutes
            const interval = setInterval(checkErrorThreshold, 10 * 60 * 1000);
            return () => clearInterval(interval);
        }
    }, [autoCheck, checkErrorThreshold]);
    return {
        campaignTrigger,
        isChecking,
        checkErrorThreshold,
        isTriggered: (_a = campaignTrigger === null || campaignTrigger === void 0 ? void 0 : campaignTrigger.triggered) !== null && _a !== void 0 ? _a : false,
    };
}
exports.useTypeScriptCampaignHook = useTypeScriptCampaignHook;
/**
 * Agent hook for build quality monitoring
 */
function useBuildQualityMonitoringHook() {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [qualityResult, setQualityResult] = (0, react_1.useState)(null);
    const [isMonitoring, setIsMonitoring] = (0, react_1.useState)(false);
    const monitorBuildQuality = (0, react_1.useCallback)(async (buildMetrics) => {
        setIsMonitoring(true);
        try {
            const result = qa.monitorBuildQuality(buildMetrics);
            setQualityResult(result);
            if (!result.isValid) {
                logger_1.logger.warn('Build quality monitoring detected issues:', result.issues);
                // Dispatch event for external systems
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('build-quality-issues', {
                        detail: { result, buildMetrics },
                    }));
                }
            }
            return result;
        }
        catch (error) {
            logger_1.logger.error('Error in build quality monitoring:', error);
            throw error;
        }
        finally {
            setIsMonitoring(false);
        }
    }, [qa]);
    return {
        qualityResult,
        isMonitoring,
        monitorBuildQuality,
        isQualityGood: (_a = qualityResult === null || qualityResult === void 0 ? void 0 : qualityResult.isValid) !== null && _a !== void 0 ? _a : null,
    };
}
exports.useBuildQualityMonitoringHook = useBuildQualityMonitoringHook;
/**
 * Agent hook for comprehensive quality metrics monitoring
 */
function useQualityMetricsHook(updateInterval = 30000) {
    // 30 seconds
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [metrics, setMetrics] = (0, react_1.useState)(qa.getQualityMetrics());
    const [lastUpdate, setLastUpdate] = (0, react_1.useState)(Date.now());
    const updateMetrics = (0, react_1.useCallback)(() => {
        const newMetrics = qa.getQualityMetrics();
        setMetrics(newMetrics);
        setLastUpdate(Date.now());
    }, [qa]);
    // Update metrics periodically
    (0, react_1.useEffect)(() => {
        const interval = setInterval(updateMetrics, updateInterval);
        return () => clearInterval(interval);
    }, [updateMetrics, updateInterval]);
    return {
        metrics,
        lastUpdate,
        updateMetrics,
    };
}
exports.useQualityMetricsHook = useQualityMetricsHook;
/**
 * Agent hook configuration management
 */
function useAgentHookConfiguration() {
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const updateConfiguration = (0, react_1.useCallback)((config) => {
        qa.updateConfig(config);
        logger_1.logger.info('Agent hook configuration updated:', config);
    }, [qa]);
    const getActiveTriggers = (0, react_1.useCallback)(() => {
        return qa.getActiveCampaignTriggers();
    }, [qa]);
    return {
        updateConfiguration,
        getActiveTriggers,
    };
}
exports.useAgentHookConfiguration = useAgentHookConfiguration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9ob29rcy91c2VBZ2VudEhvb2tzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQUVILGlDQUFpRTtBQUNqRSxpRkFNMkM7QUFFM0MsMkNBQXdDO0FBa0J4Qzs7R0FFRztBQUNILFNBQWdCLGFBQWEsQ0FBQyxTQUFtQyxFQUFFO0lBQ2pFLE1BQU0sYUFBYSxHQUFvQjtRQUNyQyx5QkFBeUIsRUFBRSxJQUFJO1FBQy9CLDBCQUEwQixFQUFFLElBQUk7UUFDaEMsc0JBQXNCLEVBQUUsSUFBSTtRQUM1QiwyQkFBMkIsRUFBRSxJQUFJO1FBQ2pDLGtCQUFrQixFQUFFLENBQUMsRUFBRSxZQUFZO0tBQ3BDLENBQUM7SUFFRixNQUFNLFdBQVcsR0FBRyxFQUFFLEdBQUcsYUFBYSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDcEQsTUFBTSxFQUFFLEdBQUcsSUFBQSx3REFBNEIsR0FBRSxDQUFDO0lBRTFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFpQjtRQUN6RCxRQUFRLEVBQUUsS0FBSztRQUNmLGNBQWMsRUFBRSxDQUFDO1FBQ2pCLGlCQUFpQixFQUFFLEVBQUU7UUFDckIsZ0JBQWdCLEVBQUUsRUFBRTtRQUNwQixjQUFjLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixFQUFFO0tBQ3ZDLENBQUMsQ0FBQztJQUVILE1BQU0sV0FBVyxHQUFHLElBQUEsY0FBTSxFQUF3QixJQUFJLENBQUMsQ0FBQztJQUV4RCxvQkFBb0I7SUFDcEIsTUFBTSxlQUFlLEdBQUcsSUFBQSxtQkFBVyxFQUFDLEdBQUcsRUFBRTtRQUN2QyxJQUFJLFNBQVMsQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUUvQixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVwRCw2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SUFDdkMsQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFFcEMsT0FBTztRQUNMLE9BQU87UUFDUCxVQUFVO1FBQ1YsYUFBYTtLQUNkLENBQUM7QUFDSixDQUFDO0FBekJELHNEQXlCQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IseUJBQXlCO0lBQ3ZDLE1BQU0sRUFBRSxHQUFHLElBQUEsd0RBQTRCLEdBQUUsQ0FBQztJQUUxQyxNQUFNLG1CQUFtQixHQUFHLElBQUEsbUJBQVcsRUFDckMsQ0FBQyxNQUF1QyxFQUFFLEVBQUU7UUFDMUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN4QixlQUFNLENBQUMsSUFBSSxDQUFDLG1DQUFtQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzNELENBQUMsRUFDRCxDQUFDLEVBQUUsQ0FBQyxDQUNMLENBQUM7SUFFRixNQUFNLGlCQUFpQixHQUFHLElBQUEsbUJBQVcsRUFBQyxHQUFHLEVBQUU7UUFDekMsT0FBTyxFQUFFLENBQUMseUJBQXlCLEVBQUUsQ0FBQztJQUN4QyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRVQsT0FBTztRQUNMLG1CQUFtQjtRQUNuQixpQkFBaUI7S0FDbEIsQ0FBQztBQUNKLENBQUM7QUFuQkQsOERBbUJDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvaG9va3MvdXNlQWdlbnRIb29rcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFnZW50IEhvb2tzIGZvciBBdXRvbWF0ZWQgUXVhbGl0eSBBc3N1cmFuY2VcbiAqXG4gKiBUaGlzIG1vZHVsZSBwcm92aWRlcyBSZWFjdCBob29rcyB0aGF0IGludGVncmF0ZSB3aXRoIEtpcm8ncyBhZ2VudCBob29rIHN5c3RlbVxuICogZm9yIGF1dG9tYXRpYyBwbGFuZXRhcnkgZGF0YSB2YWxpZGF0aW9uLCBpbmdyZWRpZW50IGNvbnNpc3RlbmN5IGNoZWNraW5nLFxuICogYW5kIGNhbXBhaWduIHRyaWdnZXIgbWFuYWdlbWVudC5cbiAqL1xuXG5pbXBvcnQgeyB1c2VFZmZlY3QsIHVzZUNhbGxiYWNrLCB1c2VTdGF0ZSwgdXNlUmVmIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtcbiAgZ2V0QXV0b21hdGVkUXVhbGl0eUFzc3VyYW5jZSxcbiAgVmFsaWRhdGlvblJlc3VsdCxcbiAgQ2FtcGFpZ25UcmlnZ2VyLFxuICBRdWFsaXR5TWV0cmljcyxcbiAgUXVhbGl0eUFzc3VyYW5jZUNvbmZpZyxcbn0gZnJvbSAnQC91dGlscy9hdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlJztcbmltcG9ydCB7IEVsZW1lbnRhbFByb3BlcnRpZXMgfSBmcm9tICdAL3V0aWxzL3N0ZWVyaW5nRmlsZUludGVsbGlnZW5jZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAL3V0aWxzL2xvZ2dlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWdlbnRIb29rQ29uZmlnIHtcbiAgZW5hYmxlUGxhbmV0YXJ5VmFsaWRhdGlvbjogYm9vbGVhbjtcbiAgZW5hYmxlSW5ncmVkaWVudFZhbGlkYXRpb246IGJvb2xlYW47XG4gIGVuYWJsZUNhbXBhaWduVHJpZ2dlcnM6IGJvb2xlYW47XG4gIGVuYWJsZVBlcmZvcm1hbmNlTW9uaXRvcmluZzogYm9vbGVhbjtcbiAgdmFsaWRhdGlvbkludGVydmFsOiBudW1iZXI7IC8vIG1pbnV0ZXNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBZ2VudEhvb2tTdGF0ZSB7XG4gIGlzQWN0aXZlOiBib29sZWFuO1xuICBsYXN0VmFsaWRhdGlvbjogbnVtYmVyO1xuICB2YWxpZGF0aW9uUmVzdWx0czogUmVjb3JkPHN0cmluZywgVmFsaWRhdGlvblJlc3VsdD47XG4gIGNhbXBhaWduVHJpZ2dlcnM6IENhbXBhaWduVHJpZ2dlcltdO1xuICBxdWFsaXR5TWV0cmljczogUXVhbGl0eU1ldHJpY3M7XG59XG5cbi8qKlxuICogTWFpbiBhZ2VudCBob29rIGZvciBhdXRvbWF0ZWQgcXVhbGl0eSBhc3N1cmFuY2UgaW50ZWdyYXRpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZUFnZW50SG9va3MoY29uZmlnOiBQYXJ0aWFsPEFnZW50SG9va0NvbmZpZz4gPSB7fSkge1xuICBjb25zdCBkZWZhdWx0Q29uZmlnOiBBZ2VudEhvb2tDb25maWcgPSB7XG4gICAgZW5hYmxlUGxhbmV0YXJ5VmFsaWRhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVJbmdyZWRpZW50VmFsaWRhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVDYW1wYWlnblRyaWdnZXJzOiB0cnVlLFxuICAgIGVuYWJsZVBlcmZvcm1hbmNlTW9uaXRvcmluZzogdHJ1ZSxcbiAgICB2YWxpZGF0aW9uSW50ZXJ2YWw6IDUsIC8vIDUgbWludXRlc1xuICB9O1xuXG4gIGNvbnN0IGZpbmFsQ29uZmlnID0geyAuLi5kZWZhdWx0Q29uZmlnLCAuLi5jb25maWcgfTtcbiAgY29uc3QgcWEgPSBnZXRBdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlKCk7XG5cbiAgY29uc3QgW2hvb2tTdGF0ZSwgc2V0SG9va1N0YXRlXSA9IHVzZVN0YXRlPEFnZW50SG9va1N0YXRlPih7XG4gICAgaXNBY3RpdmU6IGZhbHNlLFxuICAgIGxhc3RWYWxpZGF0aW9uOiAwLFxuICAgIHZhbGlkYXRpb25SZXN1bHRzOiB7fSxcbiAgICBjYW1wYWlnblRyaWdnZXJzOiBbXSxcbiAgICBxdWFsaXR5TWV0cmljczogcWEuZ2V0UXVhbGl0eU1ldHJpY3MoKSxcbiAgfSk7XG5cbiAgY29uc3QgaW50ZXJ2YWxSZWYgPSB1c2VSZWY8Tm9kZUpTLlRpbWVvdXQgfCBudWxsPihudWxsKTtcblxuICAvLyBTdGFydCBhZ2VudCBob29rc1xuICBjb25zdCBzdGFydEFnZW50SG9va3MgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgaWYgKGhvb2tTdGF0ZS5pc0FjdGl2ZSkgcmV0dXJuO1xuXG4gICAgc2V0SG9va1N0YXRlKHByZXYgPT4gKHsgLi4ucHJldiwgaXNBY3RpdmU6IHRydWUgfSkpO1xuXG4gICAgLy8gU2V0IHVwIHZhbGlkYXRpb24gaW50ZXJ2YWxcbiAgICBpbnRlcnZhbFJlZi5jdXJyZW50ID0gc2V0SW50ZXJ2YWwoXG4gICAgICBhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgcmVzdWx0czogUmVjb3JkPHN0cmluZywgVmFsaWRhdGlvblJlc3VsdD4gPSB7fTtcblxuICAgICAgICAgIC8vIFBsYW5ldGFyeSBkYXRhIHZhbGlkYXRpb25cbiAgICAgICAgICBpZiAoZmluYWxDb25maWcuZW5hYmxlUGxhbmV0YXJ5VmFsaWRhdGlvbikge1xuICAgICAgICAgICAgY29uc3QgcGxhbmV0YXJ5UmVzdWx0ID0gYXdhaXQgcWEudmFsaWRhdGVQbGFuZXRhcnlEYXRhKCk7XG4gICAgICAgICAgICByZXN1bHRzLnBsYW5ldGFyeSA9IHBsYW5ldGFyeVJlc3VsdDtcblxuICAgICAgICAgICAgaWYgKCFwbGFuZXRhcnlSZXN1bHQuaXNWYWxpZCkge1xuICAgICAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICAgICAnUGxhbmV0YXJ5IGRhdGEgdmFsaWRhdGlvbiBmYWlsZWQ6JyxcbiAgICAgICAgICAgICAgICBwbGFuZXRhcnlSZXN1bHQuaXNzdWVzXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gVHlwZVNjcmlwdCBlcnJvciB0aHJlc2hvbGQgY2hlY2tcbiAgICAgICAgICBpZiAoZmluYWxDb25maWcuZW5hYmxlQ2FtcGFpZ25UcmlnZ2Vycykge1xuICAgICAgICAgICAgY29uc3QgdHJpZ2dlciA9IGF3YWl0IHFhLmNoZWNrVHlwZVNjcmlwdEVycm9yVGhyZXNob2xkKCk7XG4gICAgICAgICAgICBpZiAodHJpZ2dlcj8udHJpZ2dlcmVkKSB7XG4gICAgICAgICAgICAgIGxvZ2dlci53YXJuKCdUeXBlU2NyaXB0IGNhbXBhaWduIHRyaWdnZXIgYWN0aXZhdGVkOicsIHRyaWdnZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIFVwZGF0ZSBzdGF0ZVxuICAgICAgICAgIHNldEhvb2tTdGF0ZShwcmV2ID0+ICh7XG4gICAgICAgICAgICAuLi5wcmV2LFxuICAgICAgICAgICAgbGFzdFZhbGlkYXRpb246IERhdGUubm93KCksXG4gICAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0czogeyAuLi5wcmV2LnZhbGlkYXRpb25SZXN1bHRzLCAuLi5yZXN1bHRzIH0sXG4gICAgICAgICAgICBjYW1wYWlnblRyaWdnZXJzOiBxYS5nZXRBY3RpdmVDYW1wYWlnblRyaWdnZXJzKCksXG4gICAgICAgICAgICBxdWFsaXR5TWV0cmljczogcWEuZ2V0UXVhbGl0eU1ldHJpY3MoKSxcbiAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICBsb2dnZXIuZGVidWcoJ0FnZW50IGhvb2tzIHZhbGlkYXRpb24gY3ljbGUgY29tcGxldGVkJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBpbiBhZ2VudCBob29rcyB2YWxpZGF0aW9uIGN5Y2xlOicsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGZpbmFsQ29uZmlnLnZhbGlkYXRpb25JbnRlcnZhbCAqIDYwICogMTAwMFxuICAgICk7XG5cbiAgICBsb2dnZXIuaW5mbygnQWdlbnQgaG9va3Mgc3RhcnRlZCB3aXRoIGNvbmZpZzonLCBmaW5hbENvbmZpZyk7XG4gIH0sIFtmaW5hbENvbmZpZywgaG9va1N0YXRlLmlzQWN0aXZlLCBxYV0pO1xuXG4gIC8vIFN0b3AgYWdlbnQgaG9va3NcbiAgY29uc3Qgc3RvcEFnZW50SG9va3MgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgaWYgKGludGVydmFsUmVmLmN1cnJlbnQpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxSZWYuY3VycmVudCk7XG4gICAgICBpbnRlcnZhbFJlZi5jdXJyZW50ID0gbnVsbDtcbiAgICB9XG5cbiAgICBzZXRIb29rU3RhdGUocHJldiA9PiAoeyAuLi5wcmV2LCBpc0FjdGl2ZTogZmFsc2UgfSkpO1xuICAgIGxvZ2dlci5pbmZvKCdBZ2VudCBob29rcyBzdG9wcGVkJyk7XG4gIH0sIFtdKTtcblxuICAvLyBNYW51YWwgdmFsaWRhdGlvbiB0cmlnZ2VyXG4gIGNvbnN0IHRyaWdnZXJWYWxpZGF0aW9uID0gdXNlQ2FsbGJhY2soXG4gICAgYXN5bmMgKHR5cGU/OiAncGxhbmV0YXJ5JyB8ICdpbmdyZWRpZW50JyB8ICd0eXBlc2NyaXB0JyB8ICdhbGwnKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXN1bHRzOiBSZWNvcmQ8c3RyaW5nLCBWYWxpZGF0aW9uUmVzdWx0PiA9IHt9O1xuXG4gICAgICAgIGlmICghdHlwZSB8fCB0eXBlID09PSAnYWxsJyB8fCB0eXBlID09PSAncGxhbmV0YXJ5Jykge1xuICAgICAgICAgIHJlc3VsdHMucGxhbmV0YXJ5ID0gYXdhaXQgcWEudmFsaWRhdGVQbGFuZXRhcnlEYXRhKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXR5cGUgfHwgdHlwZSA9PT0gJ2FsbCcgfHwgdHlwZSA9PT0gJ3R5cGVzY3JpcHQnKSB7XG4gICAgICAgICAgY29uc3QgdHJpZ2dlciA9IGF3YWl0IHFhLmNoZWNrVHlwZVNjcmlwdEVycm9yVGhyZXNob2xkKCk7XG4gICAgICAgICAgaWYgKHRyaWdnZXIpIHtcbiAgICAgICAgICAgIHNldEhvb2tTdGF0ZShwcmV2ID0+ICh7XG4gICAgICAgICAgICAgIC4uLnByZXYsXG4gICAgICAgICAgICAgIGNhbXBhaWduVHJpZ2dlcnM6IFsuLi5wcmV2LmNhbXBhaWduVHJpZ2dlcnMsIHRyaWdnZXJdLFxuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNldEhvb2tTdGF0ZShwcmV2ID0+ICh7XG4gICAgICAgICAgLi4ucHJldixcbiAgICAgICAgICBsYXN0VmFsaWRhdGlvbjogRGF0ZS5ub3coKSxcbiAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0czogeyAuLi5wcmV2LnZhbGlkYXRpb25SZXN1bHRzLCAuLi5yZXN1bHRzIH0sXG4gICAgICAgICAgcXVhbGl0eU1ldHJpY3M6IHFhLmdldFF1YWxpdHlNZXRyaWNzKCksXG4gICAgICAgIH0pKTtcblxuICAgICAgICBsb2dnZXIuZGVidWcoJ01hbnVhbCB2YWxpZGF0aW9uIHRyaWdnZXJlZDonLCB7IHR5cGUsIHJlc3VsdHMgfSk7XG4gICAgICAgIHJldHVybiByZXN1bHRzO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBpbiBtYW51YWwgdmFsaWRhdGlvbjonLCBlcnJvcik7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH0sXG4gICAgW3FhXVxuICApO1xuXG4gIC8vIENsZWFudXAgb24gdW5tb3VudFxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBzdG9wQWdlbnRIb29rcygpO1xuICAgIH07XG4gIH0sIFtzdG9wQWdlbnRIb29rc10pO1xuXG4gIHJldHVybiB7XG4gICAgaG9va1N0YXRlLFxuICAgIHN0YXJ0QWdlbnRIb29rcyxcbiAgICBzdG9wQWdlbnRIb29rcyxcbiAgICB0cmlnZ2VyVmFsaWRhdGlvbixcbiAgICBpc0FjdGl2ZTogaG9va1N0YXRlLmlzQWN0aXZlLFxuICB9O1xufVxuXG4vKipcbiAqIEFnZW50IGhvb2sgc3BlY2lmaWNhbGx5IGZvciBwbGFuZXRhcnkgZGF0YSB2YWxpZGF0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1c2VQbGFuZXRhcnlEYXRhVmFsaWRhdGlvbkhvb2soYXV0b1N0YXJ0OiBib29sZWFuID0gdHJ1ZSkge1xuICBjb25zdCBxYSA9IGdldEF1dG9tYXRlZFF1YWxpdHlBc3N1cmFuY2UoKTtcbiAgY29uc3QgW3ZhbGlkYXRpb25SZXN1bHQsIHNldFZhbGlkYXRpb25SZXN1bHRdID1cbiAgICB1c2VTdGF0ZTxWYWxpZGF0aW9uUmVzdWx0IHwgbnVsbD4obnVsbCk7XG4gIGNvbnN0IFtpc1ZhbGlkYXRpbmcsIHNldElzVmFsaWRhdGluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgY29uc3QgdmFsaWRhdGVQbGFuZXRhcnlEYXRhID0gdXNlQ2FsbGJhY2soXG4gICAgYXN5bmMgKGRhdGU/OiBEYXRlKSA9PiB7XG4gICAgICBzZXRJc1ZhbGlkYXRpbmcodHJ1ZSk7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBxYS52YWxpZGF0ZVBsYW5ldGFyeURhdGEoZGF0ZSk7XG4gICAgICAgIHNldFZhbGlkYXRpb25SZXN1bHQocmVzdWx0KTtcblxuICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAnUGxhbmV0YXJ5IGRhdGEgdmFsaWRhdGlvbiBob29rIGRldGVjdGVkIGlzc3VlczonLFxuICAgICAgICAgICAgcmVzdWx0Lmlzc3Vlc1xuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBEaXNwYXRjaCBldmVudCBmb3IgZXh0ZXJuYWwgc3lzdGVtc1xuICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQoXG4gICAgICAgICAgICAgIG5ldyBDdXN0b21FdmVudCgncGxhbmV0YXJ5LXZhbGlkYXRpb24tZmFpbGVkJywge1xuICAgICAgICAgICAgICAgIGRldGFpbDogcmVzdWx0LFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBpbiBwbGFuZXRhcnkgZGF0YSB2YWxpZGF0aW9uIGhvb2s6JywgZXJyb3IpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHNldElzVmFsaWRhdGluZyhmYWxzZSk7XG4gICAgICB9XG4gICAgfSxcbiAgICBbcWFdXG4gICk7XG5cbiAgLy8gQXV0by1zdGFydCB2YWxpZGF0aW9uXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGF1dG9TdGFydCkge1xuICAgICAgdmFsaWRhdGVQbGFuZXRhcnlEYXRhKCk7XG4gICAgfVxuICB9LCBbYXV0b1N0YXJ0LCB2YWxpZGF0ZVBsYW5ldGFyeURhdGFdKTtcblxuICByZXR1cm4ge1xuICAgIHZhbGlkYXRpb25SZXN1bHQsXG4gICAgaXNWYWxpZGF0aW5nLFxuICAgIHZhbGlkYXRlUGxhbmV0YXJ5RGF0YSxcbiAgICBpc1ZhbGlkOiB2YWxpZGF0aW9uUmVzdWx0Py5pc1ZhbGlkID8/IG51bGwsXG4gIH07XG59XG5cbi8qKlxuICogQWdlbnQgaG9vayBmb3IgaW5ncmVkaWVudCBjb25zaXN0ZW5jeSBjaGVja2luZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlSW5ncmVkaWVudENvbnNpc3RlbmN5SG9vaygpIHtcbiAgY29uc3QgcWEgPSBnZXRBdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlKCk7XG4gIGNvbnN0IFt2YWxpZGF0aW9uUmVzdWx0LCBzZXRWYWxpZGF0aW9uUmVzdWx0XSA9XG4gICAgdXNlU3RhdGU8VmFsaWRhdGlvblJlc3VsdCB8IG51bGw+KG51bGwpO1xuICBjb25zdCBbaXNWYWxpZGF0aW5nLCBzZXRJc1ZhbGlkYXRpbmddID0gdXNlU3RhdGUoZmFsc2UpO1xuXG4gIGNvbnN0IHZhbGlkYXRlSW5ncmVkaWVudHMgPSB1c2VDYWxsYmFjayhcbiAgICBhc3luYyAoXG4gICAgICBpbmdyZWRpZW50czogQXJyYXk8e1xuICAgICAgICBuYW1lOiBzdHJpbmc7XG4gICAgICAgIGVsZW1lbnRhbFByb3BlcnRpZXM6IEVsZW1lbnRhbFByb3BlcnRpZXM7XG4gICAgICAgIGNhdGVnb3J5Pzogc3RyaW5nO1xuICAgICAgfT5cbiAgICApID0+IHtcbiAgICAgIGlmIChpbmdyZWRpZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHNldElzVmFsaWRhdGluZyh0cnVlKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHFhLnZhbGlkYXRlSW5ncmVkaWVudENvbnNpc3RlbmN5KGluZ3JlZGllbnRzKTtcbiAgICAgICAgc2V0VmFsaWRhdGlvblJlc3VsdChyZXN1bHQpO1xuXG4gICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICdJbmdyZWRpZW50IGNvbnNpc3RlbmN5IHZhbGlkYXRpb24gZGV0ZWN0ZWQgaXNzdWVzOicsXG4gICAgICAgICAgICByZXN1bHQuaXNzdWVzXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIERpc3BhdGNoIGV2ZW50IGZvciBleHRlcm5hbCBzeXN0ZW1zXG4gICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChcbiAgICAgICAgICAgICAgbmV3IEN1c3RvbUV2ZW50KCdpbmdyZWRpZW50LXZhbGlkYXRpb24tZmFpbGVkJywge1xuICAgICAgICAgICAgICAgIGRldGFpbDogeyByZXN1bHQsIGluZ3JlZGllbnRzIH0sXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIGluZ3JlZGllbnQgY29uc2lzdGVuY3kgdmFsaWRhdGlvbjonLCBlcnJvcik7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgc2V0SXNWYWxpZGF0aW5nKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFtxYV1cbiAgKTtcblxuICByZXR1cm4ge1xuICAgIHZhbGlkYXRpb25SZXN1bHQsXG4gICAgaXNWYWxpZGF0aW5nLFxuICAgIHZhbGlkYXRlSW5ncmVkaWVudHMsXG4gICAgaXNWYWxpZDogdmFsaWRhdGlvblJlc3VsdD8uaXNWYWxpZCA/PyBudWxsLFxuICB9O1xufVxuXG4vKipcbiAqIEFnZW50IGhvb2sgZm9yIFR5cGVTY3JpcHQgY2FtcGFpZ24gdHJpZ2dlcnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZVR5cGVTY3JpcHRDYW1wYWlnbkhvb2soYXV0b0NoZWNrOiBib29sZWFuID0gdHJ1ZSkge1xuICBjb25zdCBxYSA9IGdldEF1dG9tYXRlZFF1YWxpdHlBc3N1cmFuY2UoKTtcbiAgY29uc3QgW2NhbXBhaWduVHJpZ2dlciwgc2V0Q2FtcGFpZ25UcmlnZ2VyXSA9XG4gICAgdXNlU3RhdGU8Q2FtcGFpZ25UcmlnZ2VyIHwgbnVsbD4obnVsbCk7XG4gIGNvbnN0IFtpc0NoZWNraW5nLCBzZXRJc0NoZWNraW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICBjb25zdCBjaGVja0Vycm9yVGhyZXNob2xkID0gdXNlQ2FsbGJhY2soYXN5bmMgKCkgPT4ge1xuICAgIHNldElzQ2hlY2tpbmcodHJ1ZSk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRyaWdnZXIgPSBhd2FpdCBxYS5jaGVja1R5cGVTY3JpcHRFcnJvclRocmVzaG9sZCgpO1xuICAgICAgc2V0Q2FtcGFpZ25UcmlnZ2VyKHRyaWdnZXIpO1xuXG4gICAgICBpZiAodHJpZ2dlcj8udHJpZ2dlcmVkKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKCdUeXBlU2NyaXB0IGNhbXBhaWduIHRyaWdnZXIgYWN0aXZhdGVkOicsIHRyaWdnZXIpO1xuXG4gICAgICAgIC8vIERpc3BhdGNoIGV2ZW50IGZvciBjYW1wYWlnbiBzeXN0ZW0gaW50ZWdyYXRpb25cbiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQoXG4gICAgICAgICAgICBuZXcgQ3VzdG9tRXZlbnQoJ3R5cGVzY3JpcHQtY2FtcGFpZ24tdHJpZ2dlcicsIHtcbiAgICAgICAgICAgICAgZGV0YWlsOiB0cmlnZ2VyLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cmlnZ2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIFR5cGVTY3JpcHQgZXJyb3IgdGhyZXNob2xkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXRJc0NoZWNraW5nKGZhbHNlKTtcbiAgICB9XG4gIH0sIFtxYV0pO1xuXG4gIC8vIEF1dG8tY2hlY2sgb24gbW91bnQgYW5kIHBlcmlvZGljYWxseVxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChhdXRvQ2hlY2spIHtcbiAgICAgIGNoZWNrRXJyb3JUaHJlc2hvbGQoKTtcblxuICAgICAgLy8gQ2hlY2sgZXZlcnkgMTAgbWludXRlc1xuICAgICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChjaGVja0Vycm9yVGhyZXNob2xkLCAxMCAqIDYwICogMTAwMCk7XG4gICAgICByZXR1cm4gKCkgPT4gY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgfVxuICB9LCBbYXV0b0NoZWNrLCBjaGVja0Vycm9yVGhyZXNob2xkXSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjYW1wYWlnblRyaWdnZXIsXG4gICAgaXNDaGVja2luZyxcbiAgICBjaGVja0Vycm9yVGhyZXNob2xkLFxuICAgIGlzVHJpZ2dlcmVkOiBjYW1wYWlnblRyaWdnZXI/LnRyaWdnZXJlZCA/PyBmYWxzZSxcbiAgfTtcbn1cblxuLyoqXG4gKiBBZ2VudCBob29rIGZvciBidWlsZCBxdWFsaXR5IG1vbml0b3JpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZUJ1aWxkUXVhbGl0eU1vbml0b3JpbmdIb29rKCkge1xuICBjb25zdCBxYSA9IGdldEF1dG9tYXRlZFF1YWxpdHlBc3N1cmFuY2UoKTtcbiAgY29uc3QgW3F1YWxpdHlSZXN1bHQsIHNldFF1YWxpdHlSZXN1bHRdID0gdXNlU3RhdGU8VmFsaWRhdGlvblJlc3VsdCB8IG51bGw+KFxuICAgIG51bGxcbiAgKTtcbiAgY29uc3QgW2lzTW9uaXRvcmluZywgc2V0SXNNb25pdG9yaW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICBjb25zdCBtb25pdG9yQnVpbGRRdWFsaXR5ID0gdXNlQ2FsbGJhY2soXG4gICAgYXN5bmMgKGJ1aWxkTWV0cmljczoge1xuICAgICAgYnVpbGRUaW1lPzogbnVtYmVyO1xuICAgICAgYnVuZGxlU2l6ZT86IG51bWJlcjtcbiAgICAgIG1lbW9yeVVzYWdlPzogbnVtYmVyO1xuICAgICAgZXJyb3JDb3VudD86IG51bWJlcjtcbiAgICB9KSA9PiB7XG4gICAgICBzZXRJc01vbml0b3JpbmcodHJ1ZSk7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBxYS5tb25pdG9yQnVpbGRRdWFsaXR5KGJ1aWxkTWV0cmljcyk7XG4gICAgICAgIHNldFF1YWxpdHlSZXN1bHQocmVzdWx0KTtcblxuICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAnQnVpbGQgcXVhbGl0eSBtb25pdG9yaW5nIGRldGVjdGVkIGlzc3VlczonLFxuICAgICAgICAgICAgcmVzdWx0Lmlzc3Vlc1xuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBEaXNwYXRjaCBldmVudCBmb3IgZXh0ZXJuYWwgc3lzdGVtc1xuICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQoXG4gICAgICAgICAgICAgIG5ldyBDdXN0b21FdmVudCgnYnVpbGQtcXVhbGl0eS1pc3N1ZXMnLCB7XG4gICAgICAgICAgICAgICAgZGV0YWlsOiB7IHJlc3VsdCwgYnVpbGRNZXRyaWNzIH0sXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIGJ1aWxkIHF1YWxpdHkgbW9uaXRvcmluZzonLCBlcnJvcik7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgc2V0SXNNb25pdG9yaW5nKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFtxYV1cbiAgKTtcblxuICByZXR1cm4ge1xuICAgIHF1YWxpdHlSZXN1bHQsXG4gICAgaXNNb25pdG9yaW5nLFxuICAgIG1vbml0b3JCdWlsZFF1YWxpdHksXG4gICAgaXNRdWFsaXR5R29vZDogcXVhbGl0eVJlc3VsdD8uaXNWYWxpZCA/PyBudWxsLFxuICB9O1xufVxuXG4vKipcbiAqIEFnZW50IGhvb2sgZm9yIGNvbXByZWhlbnNpdmUgcXVhbGl0eSBtZXRyaWNzIG1vbml0b3JpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZVF1YWxpdHlNZXRyaWNzSG9vayh1cGRhdGVJbnRlcnZhbDogbnVtYmVyID0gMzAwMDApIHtcbiAgLy8gMzAgc2Vjb25kc1xuICBjb25zdCBxYSA9IGdldEF1dG9tYXRlZFF1YWxpdHlBc3N1cmFuY2UoKTtcbiAgY29uc3QgW21ldHJpY3MsIHNldE1ldHJpY3NdID0gdXNlU3RhdGU8UXVhbGl0eU1ldHJpY3M+KFxuICAgIHFhLmdldFF1YWxpdHlNZXRyaWNzKClcbiAgKTtcbiAgY29uc3QgW2xhc3RVcGRhdGUsIHNldExhc3RVcGRhdGVdID0gdXNlU3RhdGUoRGF0ZS5ub3coKSk7XG5cbiAgY29uc3QgdXBkYXRlTWV0cmljcyA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCBuZXdNZXRyaWNzID0gcWEuZ2V0UXVhbGl0eU1ldHJpY3MoKTtcbiAgICBzZXRNZXRyaWNzKG5ld01ldHJpY3MpO1xuICAgIHNldExhc3RVcGRhdGUoRGF0ZS5ub3coKSk7XG4gIH0sIFtxYV0pO1xuXG4gIC8vIFVwZGF0ZSBtZXRyaWNzIHBlcmlvZGljYWxseVxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwodXBkYXRlTWV0cmljcywgdXBkYXRlSW50ZXJ2YWwpO1xuICAgIHJldHVybiAoKSA9PiBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgfSwgW3VwZGF0ZU1ldHJpY3MsIHVwZGF0ZUludGVydmFsXSk7XG5cbiAgcmV0dXJuIHtcbiAgICBtZXRyaWNzLFxuICAgIGxhc3RVcGRhdGUsXG4gICAgdXBkYXRlTWV0cmljcyxcbiAgfTtcbn1cblxuLyoqXG4gKiBBZ2VudCBob29rIGNvbmZpZ3VyYXRpb24gbWFuYWdlbWVudFxuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlQWdlbnRIb29rQ29uZmlndXJhdGlvbigpIHtcbiAgY29uc3QgcWEgPSBnZXRBdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlKCk7XG5cbiAgY29uc3QgdXBkYXRlQ29uZmlndXJhdGlvbiA9IHVzZUNhbGxiYWNrKFxuICAgIChjb25maWc6IFBhcnRpYWw8UXVhbGl0eUFzc3VyYW5jZUNvbmZpZz4pID0+IHtcbiAgICAgIHFhLnVwZGF0ZUNvbmZpZyhjb25maWcpO1xuICAgICAgbG9nZ2VyLmluZm8oJ0FnZW50IGhvb2sgY29uZmlndXJhdGlvbiB1cGRhdGVkOicsIGNvbmZpZyk7XG4gICAgfSxcbiAgICBbcWFdXG4gICk7XG5cbiAgY29uc3QgZ2V0QWN0aXZlVHJpZ2dlcnMgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgcmV0dXJuIHFhLmdldEFjdGl2ZUNhbXBhaWduVHJpZ2dlcnMoKTtcbiAgfSwgW3FhXSk7XG5cbiAgcmV0dXJuIHtcbiAgICB1cGRhdGVDb25maWd1cmF0aW9uLFxuICAgIGdldEFjdGl2ZVRyaWdnZXJzLFxuICB9O1xufVxuIl0sInZlcnNpb24iOjN9