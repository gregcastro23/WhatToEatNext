984fc8c811c2098e71df01efa1144621
"use strict";
'use client';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AsyncErrorBoundary = exports.useErrorHandler = exports.withErrorBoundary = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const logger_1 = require("@/utils/logger");
// Default fallback component with user-friendly error messages
const DefaultErrorFallback = (0, react_1.memo)(function DefaultErrorFallback({ error, errorInfo, onRetry, retryCount, maxRetries = 3, }) {
    const isDevelopment = process.env.NODE_ENV === 'development';
    return ((0, jsx_runtime_1.jsxs)("div", { className: 'bg-red-50 border border-red-200 rounded-lg p-6 m-4', children: [(0, jsx_runtime_1.jsxs)("div", { className: 'flex items-center space-x-2 mb-4', children: [(0, jsx_runtime_1.jsx)("div", { className: 'flex-shrink-0', children: (0, jsx_runtime_1.jsx)("svg", { className: 'h-5 w-5 text-red-400', viewBox: '0 0 20 20', fill: 'currentColor', children: (0, jsx_runtime_1.jsx)("path", { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z', clipRule: 'evenodd' }) }) }), (0, jsx_runtime_1.jsx)("h3", { className: 'text-lg font-medium text-red-800', children: "Something went wrong" })] }), (0, jsx_runtime_1.jsxs)("div", { className: 'mb-4', children: [(0, jsx_runtime_1.jsx)("p", { className: 'text-red-700 mb-2', children: "We encountered an unexpected error. This has been logged and we're working to fix it." }), isDevelopment && ((0, jsx_runtime_1.jsxs)("details", { className: 'mt-4', children: [(0, jsx_runtime_1.jsx)("summary", { className: 'cursor-pointer text-red-600 font-medium mb-2', children: "Technical Details (Development Mode)" }), (0, jsx_runtime_1.jsxs)("div", { className: 'bg-red-100 p-3 rounded border text-sm font-mono', children: [(0, jsx_runtime_1.jsxs)("div", { className: 'mb-2', children: [(0, jsx_runtime_1.jsx)("strong", { children: "Error:" }), " ", error.message] }), (0, jsx_runtime_1.jsxs)("div", { className: 'mb-2', children: [(0, jsx_runtime_1.jsx)("strong", { children: "Stack:" }), (0, jsx_runtime_1.jsx)("pre", { className: 'whitespace-pre-wrap text-xs mt-1', children: error.stack })] }), errorInfo.componentStack && ((0, jsx_runtime_1.jsxs)("div", { children: [(0, jsx_runtime_1.jsx)("strong", { children: "Component Stack:" }), (0, jsx_runtime_1.jsx)("pre", { className: 'whitespace-pre-wrap text-xs mt-1', children: errorInfo.componentStack })] }))] })] }))] }), (0, jsx_runtime_1.jsxs)("div", { className: 'flex items-center space-x-3', children: [retryCount < maxRetries && ((0, jsx_runtime_1.jsxs)("button", { onClick: onRetry, className: 'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2', children: ["Try Again (", maxRetries - retryCount, " attempts left)"] })), (0, jsx_runtime_1.jsx)("button", { onClick: () => window.location.reload(), className: 'bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2', children: "Reload Page" }), retryCount >= maxRetries && ((0, jsx_runtime_1.jsx)("p", { className: 'text-red-600 text-sm', children: "Maximum retry attempts reached. Please reload the page or contact support." }))] })] }));
});
class ErrorBoundary extends react_1.Component {
    constructor(props) {
        super(props);
        this.resetTimeoutId = null;
        this.resetErrorBoundary = () => {
            if (this.resetTimeoutId) {
                clearTimeout(this.resetTimeoutId);
            }
            this.setState(prevState => ({
                hasError: false,
                error: null,
                errorInfo: null,
                errorId: '',
                retryCount: prevState.retryCount + 1,
                lastResetKeys: this.props.resetKeys,
            }));
        };
        this.handleRetry = () => {
            // Add a small delay before retrying to prevent rapid retry loops
            this.resetTimeoutId = window.setTimeout(() => {
                this.resetErrorBoundary();
            }, 100);
        };
        this.state = {
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: 0,
            lastResetKeys: props.resetKeys,
        };
    }
    static getDerivedStateFromError(error) {
        // Generate unique error ID for tracking
        const errorId = `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        return {
            hasError: true,
            error,
            errorId,
        };
    }
    componentDidCatch(error, errorInfo) {
        // Log error details
        logger_1.logger.error('ErrorBoundary caught an error:', {
            error: error.message,
            stack: error.stack,
            componentStack: errorInfo.componentStack,
            errorId: this.state.errorId,
            retryCount: this.state.retryCount,
        });
        // Update state with error info
        this.setState({
            errorInfo,
        });
        // Call custom error handler if provided
        if (this.props.onError) {
            this.props.onError(error, errorInfo);
        }
        // Report to external error tracking service if available
        if (typeof window !== 'undefined' && window.reportError) {
            window.reportError(error, {
                componentStack: errorInfo.componentStack,
                errorId: this.state.errorId,
            });
        }
    }
    componentDidUpdate(prevProps) {
        const { resetKeys, resetOnPropsChange } = this.props;
        const { hasError, lastResetKeys } = this.state;
        // Reset error state if resetKeys have changed
        if (hasError && resetKeys && lastResetKeys) {
            const hasResetKeyChanged = resetKeys.some((key, index) => key !== lastResetKeys[index]);
            if (hasResetKeyChanged) {
                this.resetErrorBoundary();
            }
        }
        // Reset error state if resetOnPropsChange is true and props have changed
        if (hasError && resetOnPropsChange && prevProps !== this.props) {
            this.resetErrorBoundary();
        }
    }
    componentWillUnmount() {
        if (this.resetTimeoutId) {
            clearTimeout(this.resetTimeoutId);
        }
    }
    render() {
        const { hasError, error, errorInfo, retryCount } = this.state;
        const { children, fallback, isolate } = this.props;
        if (hasError && error && errorInfo) {
            // Use custom fallback if provided
            if (fallback) {
                return fallback(error, errorInfo);
            }
            // Use default fallback
            return ((0, jsx_runtime_1.jsx)(DefaultErrorFallback, { error: error, errorInfo: errorInfo, onRetry: this.handleRetry, retryCount: retryCount }));
        }
        // If isolate is true, wrap children in an additional error boundary
        if (isolate) {
            return (0, jsx_runtime_1.jsx)("div", { className: 'error-boundary-isolation', children: children });
        }
        return children;
    }
}
exports.default = ErrorBoundary;
// Higher-order component for easy error boundary wrapping
function withErrorBoundary(Component, errorBoundaryProps) {
    const WrappedComponent = (props) => ((0, jsx_runtime_1.jsx)(ErrorBoundary, { ...errorBoundaryProps, children: (0, jsx_runtime_1.jsx)(Component, { ...props }) }));
    WrappedComponent.displayName = `withErrorBoundary(${Component.displayName || Component.name})`;
    return WrappedComponent;
}
exports.withErrorBoundary = withErrorBoundary;
// Hook for programmatic error reporting
function useErrorHandler() {
    const reportError = react_1.default.useCallback((error, context) => {
        logger_1.logger.error('Manual error report:', {
            error: error.message,
            stack: error.stack,
            context,
            timestamp: new Date().toISOString(),
        });
        // Report to external service if available
        if (typeof window !== 'undefined' && window.reportError) {
            window.reportError(error, context);
        }
    }, []);
    return { reportError };
}
exports.useErrorHandler = useErrorHandler;
// Async error boundary for handling promise rejections
class AsyncErrorBoundary extends react_1.Component {
    constructor(props) {
        super(props);
        this.handleUnhandledRejection = (event) => {
            const error = event.reason instanceof Error
                ? event.reason
                : new Error(String(event.reason));
            this.setState({
                hasError: true,
                error,
                errorInfo: {
                    componentStack: 'Async Error (Promise Rejection)',
                },
                errorId: `async_error_${Date.now()}`,
            });
            logger_1.logger.error('Unhandled promise rejection:', {
                error: error.message,
                stack: error.stack,
                reason: event.reason,
            });
            // Prevent the default browser behavior
            event.preventDefault();
        };
        this.state = {
            hasError: false,
            error: null,
            errorInfo: null,
            errorId: '',
            retryCount: 0,
        };
    }
    componentDidMount() {
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', this.handleUnhandledRejection);
    }
    componentWillUnmount() {
        window.removeEventListener('unhandledrejection', this.handleUnhandledRejection);
    }
    render() {
        // Use the same rendering logic as ErrorBoundary
        const { hasError, error, errorInfo } = this.state;
        const { children, fallback } = this.props;
        if (hasError && error && errorInfo) {
            if (fallback) {
                return fallback(error, errorInfo);
            }
            return ((0, jsx_runtime_1.jsx)(DefaultErrorFallback, { error: error, errorInfo: errorInfo, onRetry: () => this.setState({ hasError: false, error: null, errorInfo: null }), retryCount: this.state.retryCount }));
        }
        return children;
    }
}
exports.AsyncErrorBoundary = AsyncErrorBoundary;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9jb21wb25lbnRzL2Vycm9yLWJvdW5kYXJpZXMvRXJyb3JCb3VuZGFyeS50c3giLCJtYXBwaW5ncyI6IjtBQUFBLFlBQVksQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRWIsK0NBQXFFO0FBQ3JFLDJDQUF3QztBQW9CeEMsK0RBQStEO0FBQy9ELE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxZQUFJLEVBQUMsU0FBUyxvQkFBb0IsQ0FBQyxFQUM5RCxLQUFLLEVBQ0wsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsVUFBVSxHQUFHLENBQUMsR0FPZjtJQUNDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsQ0FBQztJQUU3RCxPQUFPLENBQ0wsaUNBQUssU0FBUyxFQUFDLG9EQUFvRCxhQUNqRSxpQ0FBSyxTQUFTLEVBQUMsa0NBQWtDLGFBQy9DLGdDQUFLLFNBQVMsRUFBQyxlQUFlLFlBQzVCLGdDQUNFLFNBQVMsRUFBQyxzQkFBc0IsRUFDaEMsT0FBTyxFQUFDLFdBQVcsRUFDbkIsSUFBSSxFQUFDLGNBQWMsWUFFbkIsaUNBQ0UsUUFBUSxFQUFDLFNBQVMsRUFDbEIsQ0FBQyxFQUFDLHlOQUF5TixFQUMzTixRQUFRLEVBQUMsU0FBUyxHQUNsQixHQUNFLEdBQ0YsRUFDTiwrQkFBSSxTQUFTLEVBQUMsa0NBQWtDLHFDQUUzQyxJQUNELEVBRU4saUNBQUssU0FBUyxFQUFDLE1BQU0sYUFDbkIsOEJBQUcsU0FBUyxFQUFDLG1CQUFtQixzR0FHNUIsRUFFSCxhQUFhLElBQUksQ0FDaEIscUNBQVMsU0FBUyxFQUFDLE1BQU0sYUFDdkIsb0NBQVMsU0FBUyxFQUFDLDhDQUE4QyxxREFFdkQsRUFDVixpQ0FBSyxTQUFTLEVBQUMsaURBQWlELGFBQzlELGlDQUFLLFNBQVMsRUFBQyxNQUFNLGFBQ25CLHdEQUF1QixPQUFFLEtBQUssQ0FBQyxPQUFPLElBQ2xD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TSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRTFDLElBQUksUUFBUSxJQUFJLEtBQUssSUFBSSxTQUFTLEVBQUU7WUFDbEMsSUFBSSxRQUFRLEVBQUU7Z0JBQ1osT0FBTyxRQUFRLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ25DO1lBRUQsT0FBTyxDQUNMLHVCQUFDLG9CQUFvQixJQUNuQixLQUFLLEVBQUUsS0FBSyxFQUNaLFNBQVMsRUFBRSxTQUFTLEVBQ3BCLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FDWixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUVsRSxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQ2pDLENBQ0gsQ0FBQztTQUNIO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGO0FBL0VELGdEQStFQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL2NvbXBvbmVudHMvZXJyb3ItYm91bmRhcmllcy9FcnJvckJvdW5kYXJ5LnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGNsaWVudCc7XG5cbmltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQsIEVycm9ySW5mbywgUmVhY3ROb2RlLCBtZW1vIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnQC91dGlscy9sb2dnZXInO1xuXG5pbnRlcmZhY2UgRXJyb3JCb3VuZGFyeVByb3BzIHtcbiAgY2hpbGRyZW46IFJlYWN0Tm9kZTtcbiAgZmFsbGJhY2s/OiAoZXJyb3I6IEVycm9yLCBlcnJvckluZm86IEVycm9ySW5mbykgPT4gUmVhY3ROb2RlO1xuICBvbkVycm9yPzogKGVycm9yOiBFcnJvciwgZXJyb3JJbmZvOiBFcnJvckluZm8pID0+IHZvaWQ7XG4gIHJlc2V0T25Qcm9wc0NoYW5nZT86IGJvb2xlYW47XG4gIHJlc2V0S2V5cz86IEFycmF5PHN0cmluZyB8IG51bWJlcj47XG4gIGlzb2xhdGU/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgRXJyb3JCb3VuZGFyeVN0YXRlIHtcbiAgaGFzRXJyb3I6IGJvb2xlYW47XG4gIGVycm9yOiBFcnJvciB8IG51bGw7XG4gIGVycm9ySW5mbzogRXJyb3JJbmZvIHwgbnVsbDtcbiAgZXJyb3JJZDogc3RyaW5nO1xuICByZXRyeUNvdW50OiBudW1iZXI7XG4gIGxhc3RSZXNldEtleXM/OiBBcnJheTxzdHJpbmcgfCBudW1iZXI+O1xufVxuXG4vLyBEZWZhdWx0IGZhbGxiYWNrIGNvbXBvbmVudCB3aXRoIHVzZXItZnJpZW5kbHkgZXJyb3IgbWVzc2FnZXNcbmNvbnN0IERlZmF1bHRFcnJvckZhbGxiYWNrID0gbWVtbyhmdW5jdGlvbiBEZWZhdWx0RXJyb3JGYWxsYmFjayh7XG4gIGVycm9yLFxuICBlcnJvckluZm8sXG4gIG9uUmV0cnksXG4gIHJldHJ5Q291bnQsXG4gIG1heFJldHJpZXMgPSAzLFxufToge1xuICBlcnJvcjogRXJyb3I7XG4gIGVycm9ySW5mbzogRXJyb3JJbmZvO1xuICBvblJldHJ5OiAoKSA9PiB2b2lkO1xuICByZXRyeUNvdW50OiBudW1iZXI7XG4gIG1heFJldHJpZXM/OiBudW1iZXI7XG59KSB7XG4gIGNvbnN0IGlzRGV2ZWxvcG1lbnQgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JztcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPSdiZy1yZWQtNTAgYm9yZGVyIGJvcmRlci1yZWQtMjAwIHJvdW5kZWQtbGcgcC02IG0tNCc+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT0nZmxleCBpdGVtcy1jZW50ZXIgc3BhY2UteC0yIG1iLTQnPlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nZmxleC1zaHJpbmstMCc+XG4gICAgICAgICAgPHN2Z1xuICAgICAgICAgICAgY2xhc3NOYW1lPSdoLTUgdy01IHRleHQtcmVkLTQwMCdcbiAgICAgICAgICAgIHZpZXdCb3g9JzAgMCAyMCAyMCdcbiAgICAgICAgICAgIGZpbGw9J2N1cnJlbnRDb2xvcidcbiAgICAgICAgICA+XG4gICAgICAgICAgICA8cGF0aFxuICAgICAgICAgICAgICBmaWxsUnVsZT0nZXZlbm9kZCdcbiAgICAgICAgICAgICAgZD0nTTEwIDE4YTggOCAwIDEwMC0xNiA4IDggMCAwMDAgMTZ6TTguNzA3IDcuMjkzYTEgMSAwIDAwLTEuNDE0IDEuNDE0TDguNTg2IDEwbC0xLjI5MyAxLjI5M2ExIDEgMCAxMDEuNDE0IDEuNDE0TDEwIDExLjQxNGwxLjI5MyAxLjI5M2ExIDEgMCAwMDEuNDE0LTEuNDE0TDExLjQxNCAxMGwxLjI5My0xLjI5M2ExIDEgMCAwMC0xLjQxNC0xLjQxNEwxMCA4LjU4NiA4LjcwNyA3LjI5M3onXG4gICAgICAgICAgICAgIGNsaXBSdWxlPSdldmVub2RkJ1xuICAgICAgICAgICAgLz5cbiAgICAgICAgICA8L3N2Zz5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxoMyBjbGFzc05hbWU9J3RleHQtbGcgZm9udC1tZWRpdW0gdGV4dC1yZWQtODAwJz5cbiAgICAgICAgICBTb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgICAgICA8L2gzPlxuICAgICAgPC9kaXY+XG5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPSdtYi00Jz5cbiAgICAgICAgPHAgY2xhc3NOYW1lPSd0ZXh0LXJlZC03MDAgbWItMic+XG4gICAgICAgICAgV2UgZW5jb3VudGVyZWQgYW4gdW5leHBlY3RlZCBlcnJvci4gVGhpcyBoYXMgYmVlbiBsb2dnZWQgYW5kIHdlJ3JlXG4gICAgICAgICAgd29ya2luZyB0byBmaXggaXQuXG4gICAgICAgIDwvcD5cblxuICAgICAgICB7aXNEZXZlbG9wbWVudCAmJiAoXG4gICAgICAgICAgPGRldGFpbHMgY2xhc3NOYW1lPSdtdC00Jz5cbiAgICAgICAgICAgIDxzdW1tYXJ5IGNsYXNzTmFtZT0nY3Vyc29yLXBvaW50ZXIgdGV4dC1yZWQtNjAwIGZvbnQtbWVkaXVtIG1iLTInPlxuICAgICAgICAgICAgICBUZWNobmljYWwgRGV0YWlscyAoRGV2ZWxvcG1lbnQgTW9kZSlcbiAgICAgICAgICAgIDwvc3VtbWFyeT5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdiZy1yZWQtMTAwIHAtMyByb3VuZGVkIGJvcmRlciB0ZXh0LXNtIGZvbnQtbW9ubyc+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdtYi0yJz5cbiAgICAgICAgICAgICAgICA8c3Ryb25nPkVycm9yOjwvc3Ryb25nPiB7ZXJyb3IubWVzc2FnZX1cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdtYi0yJz5cbiAgICAgICAgICAgICAgICA8c3Ryb25nPlN0YWNrOjwvc3Ryb25nPlxuICAgICAgICAgICAgICAgIDxwcmUgY2xhc3NOYW1lPSd3aGl0ZXNwYWNlLXByZS13cmFwIHRleHQteHMgbXQtMSc+XG4gICAgICAgICAgICAgICAgICB7ZXJyb3Iuc3RhY2t9XG4gICAgICAgICAgICAgICAgPC9wcmU+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICB7ZXJyb3JJbmZvLmNvbXBvbmVudFN0YWNrICYmIChcbiAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgPHN0cm9uZz5Db21wb25lbnQgU3RhY2s6PC9zdHJvbmc+XG4gICAgICAgICAgICAgICAgICA8cHJlIGNsYXNzTmFtZT0nd2hpdGVzcGFjZS1wcmUtd3JhcCB0ZXh0LXhzIG10LTEnPlxuICAgICAgICAgICAgICAgICAgICB7ZXJyb3JJbmZvLmNvbXBvbmVudFN0YWNrfVxuICAgICAgICAgICAgICAgICAgPC9wcmU+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L2RldGFpbHM+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cblxuICAgICAgPGRpdiBjbGFzc05hbWU9J2ZsZXggaXRlbXMtY2VudGVyIHNwYWNlLXgtMyc+XG4gICAgICAgIHtyZXRyeUNvdW50IDwgbWF4UmV0cmllcyAmJiAoXG4gICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgb25DbGljaz17b25SZXRyeX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT0nYmctcmVkLTYwMCB0ZXh0LXdoaXRlIHB4LTQgcHktMiByb3VuZGVkIGhvdmVyOmJnLXJlZC03MDAgdHJhbnNpdGlvbi1jb2xvcnMgZm9jdXM6b3V0bGluZS1ub25lIGZvY3VzOnJpbmctMiBmb2N1czpyaW5nLXJlZC01MDAgZm9jdXM6cmluZy1vZmZzZXQtMidcbiAgICAgICAgICA+XG4gICAgICAgICAgICBUcnkgQWdhaW4gKHttYXhSZXRyaWVzIC0gcmV0cnlDb3VudH0gYXR0ZW1wdHMgbGVmdClcbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgKX1cblxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgb25DbGljaz17KCkgPT4gd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpfVxuICAgICAgICAgIGNsYXNzTmFtZT0nYmctZ3JheS02MDAgdGV4dC13aGl0ZSBweC00IHB5LTIgcm91bmRlZCBob3ZlcjpiZy1ncmF5LTcwMCB0cmFuc2l0aW9uLWNvbG9ycyBmb2N1czpvdXRsaW5lLW5vbmUgZm9jdXM6cmluZy0yIGZvY3VzOnJpbmctZ3JheS01MDAgZm9jdXM6cmluZy1vZmZzZXQtMidcbiAgICAgICAgPlxuICAgICAgICAgIFJlbG9hZCBQYWdlXG4gICAgICAgIDwvYnV0dG9uPlxuXG4gICAgICAgIHtyZXRyeUNvdW50ID49IG1heFJldHJpZXMgJiYgKFxuICAgICAgICAgIDxwIGNsYXNzTmFtZT0ndGV4dC1yZWQtNjAwIHRleHQtc20nPlxuICAgICAgICAgICAgTWF4aW11bSByZXRyeSBhdHRlbXB0cyByZWFjaGVkLiBQbGVhc2UgcmVsb2FkIHRoZSBwYWdlIG9yIGNvbnRhY3RcbiAgICAgICAgICAgIHN1cHBvcnQuXG4gICAgICAgICAgPC9wPlxuICAgICAgICApfVxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICk7XG59KTtcblxuY2xhc3MgRXJyb3JCb3VuZGFyeSBleHRlbmRzIENvbXBvbmVudDxFcnJvckJvdW5kYXJ5UHJvcHMsIEVycm9yQm91bmRhcnlTdGF0ZT4ge1xuICBwcml2YXRlIHJlc2V0VGltZW91dElkOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogRXJyb3JCb3VuZGFyeVByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgIGVycm9yOiBudWxsLFxuICAgICAgZXJyb3JJbmZvOiBudWxsLFxuICAgICAgZXJyb3JJZDogJycsXG4gICAgICByZXRyeUNvdW50OiAwLFxuICAgICAgbGFzdFJlc2V0S2V5czogcHJvcHMucmVzZXRLZXlzLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yOiBFcnJvcik6IFBhcnRpYWw8RXJyb3JCb3VuZGFyeVN0YXRlPiB7XG4gICAgLy8gR2VuZXJhdGUgdW5pcXVlIGVycm9yIElEIGZvciB0cmFja2luZ1xuICAgIGNvbnN0IGVycm9ySWQgPSBgZXJyb3JfJHtEYXRlLm5vdygpfV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGhhc0Vycm9yOiB0cnVlLFxuICAgICAgZXJyb3IsXG4gICAgICBlcnJvcklkLFxuICAgIH07XG4gIH1cblxuICBjb21wb25lbnREaWRDYXRjaChlcnJvcjogRXJyb3IsIGVycm9ySW5mbzogRXJyb3JJbmZvKSB7XG4gICAgLy8gTG9nIGVycm9yIGRldGFpbHNcbiAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yQm91bmRhcnkgY2F1Z2h0IGFuIGVycm9yOicsIHtcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgY29tcG9uZW50U3RhY2s6IGVycm9ySW5mby5jb21wb25lbnRTdGFjayxcbiAgICAgIGVycm9ySWQ6IHRoaXMuc3RhdGUuZXJyb3JJZCxcbiAgICAgIHJldHJ5Q291bnQ6IHRoaXMuc3RhdGUucmV0cnlDb3VudCxcbiAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSBzdGF0ZSB3aXRoIGVycm9yIGluZm9cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGVycm9ySW5mbyxcbiAgICB9KTtcblxuICAgIC8vIENhbGwgY3VzdG9tIGVycm9yIGhhbmRsZXIgaWYgcHJvdmlkZWRcbiAgICBpZiAodGhpcy5wcm9wcy5vbkVycm9yKSB7XG4gICAgICB0aGlzLnByb3BzLm9uRXJyb3IoZXJyb3IsIGVycm9ySW5mbyk7XG4gICAgfVxuXG4gICAgLy8gUmVwb3J0IHRvIGV4dGVybmFsIGVycm9yIHRyYWNraW5nIHNlcnZpY2UgaWYgYXZhaWxhYmxlXG4gICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICh3aW5kb3cgYXMgYW55KS5yZXBvcnRFcnJvcikge1xuICAgICAgKHdpbmRvdyBhcyBhbnkpLnJlcG9ydEVycm9yKGVycm9yLCB7XG4gICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8uY29tcG9uZW50U3RhY2ssXG4gICAgICAgIGVycm9ySWQ6IHRoaXMuc3RhdGUuZXJyb3JJZCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHM6IEVycm9yQm91bmRhcnlQcm9wcykge1xuICAgIGNvbnN0IHsgcmVzZXRLZXlzLCByZXNldE9uUHJvcHNDaGFuZ2UgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBoYXNFcnJvciwgbGFzdFJlc2V0S2V5cyB9ID0gdGhpcy5zdGF0ZTtcblxuICAgIC8vIFJlc2V0IGVycm9yIHN0YXRlIGlmIHJlc2V0S2V5cyBoYXZlIGNoYW5nZWRcbiAgICBpZiAoaGFzRXJyb3IgJiYgcmVzZXRLZXlzICYmIGxhc3RSZXNldEtleXMpIHtcbiAgICAgIGNvbnN0IGhhc1Jlc2V0S2V5Q2hhbmdlZCA9IHJlc2V0S2V5cy5zb21lKFxuICAgICAgICAoa2V5LCBpbmRleCkgPT4ga2V5ICE9PSBsYXN0UmVzZXRLZXlzW2luZGV4XVxuICAgICAgKTtcblxuICAgICAgaWYgKGhhc1Jlc2V0S2V5Q2hhbmdlZCkge1xuICAgICAgICB0aGlzLnJlc2V0RXJyb3JCb3VuZGFyeSgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJlc2V0IGVycm9yIHN0YXRlIGlmIHJlc2V0T25Qcm9wc0NoYW5nZSBpcyB0cnVlIGFuZCBwcm9wcyBoYXZlIGNoYW5nZWRcbiAgICBpZiAoaGFzRXJyb3IgJiYgcmVzZXRPblByb3BzQ2hhbmdlICYmIHByZXZQcm9wcyAhPT0gdGhpcy5wcm9wcykge1xuICAgICAgdGhpcy5yZXNldEVycm9yQm91bmRhcnkoKTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICBpZiAodGhpcy5yZXNldFRpbWVvdXRJZCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMucmVzZXRUaW1lb3V0SWQpO1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0RXJyb3JCb3VuZGFyeSA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5yZXNldFRpbWVvdXRJZCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMucmVzZXRUaW1lb3V0SWQpO1xuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUocHJldlN0YXRlID0+ICh7XG4gICAgICBoYXNFcnJvcjogZmFsc2UsXG4gICAgICBlcnJvcjogbnVsbCxcbiAgICAgIGVycm9ySW5mbzogbnVsbCxcbiAgICAgIGVycm9ySWQ6ICcnLFxuICAgICAgcmV0cnlDb3VudDogcHJldlN0YXRlLnJldHJ5Q291bnQgKyAxLFxuICAgICAgbGFzdFJlc2V0S2V5czogdGhpcy5wcm9wcy5yZXNldEtleXMsXG4gICAgfSkpO1xuICB9O1xuXG4gIGhhbmRsZVJldHJ5ID0gKCkgPT4ge1xuICAgIC8vIEFkZCBhIHNtYWxsIGRlbGF5IGJlZm9yZSByZXRyeWluZyB0byBwcmV2ZW50IHJhcGlkIHJldHJ5IGxvb3BzXG4gICAgdGhpcy5yZXNldFRpbWVvdXRJZCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMucmVzZXRFcnJvckJvdW5kYXJ5KCk7XG4gICAgfSwgMTAwKTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBoYXNFcnJvciwgZXJyb3IsIGVycm9ySW5mbywgcmV0cnlDb3VudCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB7IGNoaWxkcmVuLCBmYWxsYmFjaywgaXNvbGF0ZSB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmIChoYXNFcnJvciAmJiBlcnJvciAmJiBlcnJvckluZm8pIHtcbiAgICAgIC8vIFVzZSBjdXN0b20gZmFsbGJhY2sgaWYgcHJvdmlkZWRcbiAgICAgIGlmIChmYWxsYmFjaykge1xuICAgICAgICByZXR1cm4gZmFsbGJhY2soZXJyb3IsIGVycm9ySW5mbyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBkZWZhdWx0IGZhbGxiYWNrXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8RGVmYXVsdEVycm9yRmFsbGJhY2tcbiAgICAgICAgICBlcnJvcj17ZXJyb3J9XG4gICAgICAgICAgZXJyb3JJbmZvPXtlcnJvckluZm99XG4gICAgICAgICAgb25SZXRyeT17dGhpcy5oYW5kbGVSZXRyeX1cbiAgICAgICAgICByZXRyeUNvdW50PXtyZXRyeUNvdW50fVxuICAgICAgICAvPlxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBJZiBpc29sYXRlIGlzIHRydWUsIHdyYXAgY2hpbGRyZW4gaW4gYW4gYWRkaXRpb25hbCBlcnJvciBib3VuZGFyeVxuICAgIGlmIChpc29sYXRlKSB7XG4gICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9J2Vycm9yLWJvdW5kYXJ5LWlzb2xhdGlvbic+e2NoaWxkcmVufTwvZGl2PjtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hpbGRyZW47XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRXJyb3JCb3VuZGFyeTtcblxuLy8gSGlnaGVyLW9yZGVyIGNvbXBvbmVudCBmb3IgZWFzeSBlcnJvciBib3VuZGFyeSB3cmFwcGluZ1xuZXhwb3J0IGZ1bmN0aW9uIHdpdGhFcnJvckJvdW5kYXJ5PFAgZXh0ZW5kcyBvYmplY3Q+KFxuICBDb21wb25lbnQ6IFJlYWN0LkNvbXBvbmVudFR5cGU8UD4sXG4gIGVycm9yQm91bmRhcnlQcm9wcz86IE9taXQ8RXJyb3JCb3VuZGFyeVByb3BzLCAnY2hpbGRyZW4nPlxuKSB7XG4gIGNvbnN0IFdyYXBwZWRDb21wb25lbnQgPSAocHJvcHM6IFApID0+IChcbiAgICA8RXJyb3JCb3VuZGFyeSB7Li4uZXJyb3JCb3VuZGFyeVByb3BzfT5cbiAgICAgIDxDb21wb25lbnQgey4uLnByb3BzfSAvPlxuICAgIDwvRXJyb3JCb3VuZGFyeT5cbiAgKTtcblxuICBXcmFwcGVkQ29tcG9uZW50LmRpc3BsYXlOYW1lID0gYHdpdGhFcnJvckJvdW5kYXJ5KCR7Q29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lfSlgO1xuXG4gIHJldHVybiBXcmFwcGVkQ29tcG9uZW50O1xufVxuXG4vLyBIb29rIGZvciBwcm9ncmFtbWF0aWMgZXJyb3IgcmVwb3J0aW5nXG5leHBvcnQgZnVuY3Rpb24gdXNlRXJyb3JIYW5kbGVyKCkge1xuICBjb25zdCByZXBvcnRFcnJvciA9IFJlYWN0LnVzZUNhbGxiYWNrKFxuICAgIChlcnJvcjogRXJyb3IsIGNvbnRleHQ/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ01hbnVhbCBlcnJvciByZXBvcnQ6Jywge1xuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgICBjb250ZXh0LFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBSZXBvcnQgdG8gZXh0ZXJuYWwgc2VydmljZSBpZiBhdmFpbGFibGVcbiAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAod2luZG93IGFzIGFueSkucmVwb3J0RXJyb3IpIHtcbiAgICAgICAgKHdpbmRvdyBhcyBhbnkpLnJlcG9ydEVycm9yKGVycm9yLCBjb250ZXh0KTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFtdXG4gICk7XG5cbiAgcmV0dXJuIHsgcmVwb3J0RXJyb3IgfTtcbn1cblxuLy8gQXN5bmMgZXJyb3IgYm91bmRhcnkgZm9yIGhhbmRsaW5nIHByb21pc2UgcmVqZWN0aW9uc1xuZXhwb3J0IGNsYXNzIEFzeW5jRXJyb3JCb3VuZGFyeSBleHRlbmRzIENvbXBvbmVudDxcbiAgRXJyb3JCb3VuZGFyeVByb3BzLFxuICBFcnJvckJvdW5kYXJ5U3RhdGVcbj4ge1xuICBjb25zdHJ1Y3Rvcihwcm9wczogRXJyb3JCb3VuZGFyeVByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBoYXNFcnJvcjogZmFsc2UsXG4gICAgICBlcnJvcjogbnVsbCxcbiAgICAgIGVycm9ySW5mbzogbnVsbCxcbiAgICAgIGVycm9ySWQ6ICcnLFxuICAgICAgcmV0cnlDb3VudDogMCxcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgLy8gSGFuZGxlIHVuaGFuZGxlZCBwcm9taXNlIHJlamVjdGlvbnNcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICd1bmhhbmRsZWRyZWplY3Rpb24nLFxuICAgICAgdGhpcy5oYW5kbGVVbmhhbmRsZWRSZWplY3Rpb25cbiAgICApO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAndW5oYW5kbGVkcmVqZWN0aW9uJyxcbiAgICAgIHRoaXMuaGFuZGxlVW5oYW5kbGVkUmVqZWN0aW9uXG4gICAgKTtcbiAgfVxuXG4gIGhhbmRsZVVuaGFuZGxlZFJlamVjdGlvbiA9IChldmVudDogUHJvbWlzZVJlamVjdGlvbkV2ZW50KSA9PiB7XG4gICAgY29uc3QgZXJyb3IgPVxuICAgICAgZXZlbnQucmVhc29uIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgPyBldmVudC5yZWFzb25cbiAgICAgICAgOiBuZXcgRXJyb3IoU3RyaW5nKGV2ZW50LnJlYXNvbikpO1xuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBoYXNFcnJvcjogdHJ1ZSxcbiAgICAgIGVycm9yLFxuICAgICAgZXJyb3JJbmZvOiB7XG4gICAgICAgIGNvbXBvbmVudFN0YWNrOiAnQXN5bmMgRXJyb3IgKFByb21pc2UgUmVqZWN0aW9uKScsXG4gICAgICB9IGFzIEVycm9ySW5mbyxcbiAgICAgIGVycm9ySWQ6IGBhc3luY19lcnJvcl8ke0RhdGUubm93KCl9YCxcbiAgICB9KTtcblxuICAgIGxvZ2dlci5lcnJvcignVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOicsIHtcbiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgcmVhc29uOiBldmVudC5yZWFzb24sXG4gICAgfSk7XG5cbiAgICAvLyBQcmV2ZW50IHRoZSBkZWZhdWx0IGJyb3dzZXIgYmVoYXZpb3JcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICB9O1xuXG4gIHJlbmRlcigpIHtcbiAgICAvLyBVc2UgdGhlIHNhbWUgcmVuZGVyaW5nIGxvZ2ljIGFzIEVycm9yQm91bmRhcnlcbiAgICBjb25zdCB7IGhhc0Vycm9yLCBlcnJvciwgZXJyb3JJbmZvIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHsgY2hpbGRyZW4sIGZhbGxiYWNrIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKGhhc0Vycm9yICYmIGVycm9yICYmIGVycm9ySW5mbykge1xuICAgICAgaWYgKGZhbGxiYWNrKSB7XG4gICAgICAgIHJldHVybiBmYWxsYmFjayhlcnJvciwgZXJyb3JJbmZvKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIChcbiAgICAgICAgPERlZmF1bHRFcnJvckZhbGxiYWNrXG4gICAgICAgICAgZXJyb3I9e2Vycm9yfVxuICAgICAgICAgIGVycm9ySW5mbz17ZXJyb3JJbmZvfVxuICAgICAgICAgIG9uUmV0cnk9eygpID0+XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgaGFzRXJyb3I6IGZhbHNlLCBlcnJvcjogbnVsbCwgZXJyb3JJbmZvOiBudWxsIH0pXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHJ5Q291bnQ9e3RoaXMuc3RhdGUucmV0cnlDb3VudH1cbiAgICAgICAgLz5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNoaWxkcmVuO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=