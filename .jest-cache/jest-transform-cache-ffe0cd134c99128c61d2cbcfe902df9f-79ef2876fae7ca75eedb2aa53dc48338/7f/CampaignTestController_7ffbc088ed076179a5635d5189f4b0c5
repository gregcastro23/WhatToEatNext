b268a56b602386e330f5df9b5f942ae8
"use strict";
/**
 * Campaign Test Controller
 *
 * Provides campaign pause/resume functionality specifically designed for test isolation.
 * Ensures that campaign operations don't interfere with test execution.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.campaignTestController = exports.CampaignTestController = void 0;
const campaign_1 = require("../../types/campaign");
const CampaignSystemMocks_1 = require("../mocks/CampaignSystemMocks");
const TestSafeProgressTracker_1 = require("./TestSafeProgressTracker");
/**
 * Campaign Test Controller manages campaign system state during test execution
 * to ensure proper isolation and prevent interference between tests.
 */
class CampaignTestController {
    static instance = null;
    testState;
    isolationConfig;
    testSafeTracker = null;
    mockInstances;
    originalEnvVars = {};
    activeTestName = null;
    constructor() {
        this.testState = {
            isPaused: false,
            isIsolated: false,
            pausedAt: null,
            resumedAt: null,
            testName: null,
            originalState: null
        };
        this.isolationConfig = {
            pauseProgressTracking: true,
            preventBuildExecution: true,
            preventGitOperations: true,
            enableMemoryMonitoring: true,
            isolateFileSystem: false,
            mockExternalAPIs: true
        };
        this.mockInstances = {
            controller: null,
            tracker: null,
            safety: null
        };
        this.setupTestEnvironment();
    }
    static getInstance() {
        if (!CampaignTestController.instance) {
            CampaignTestController.instance = new CampaignTestController();
        }
        return CampaignTestController.instance;
    }
    /**
     * Initialize campaign test environment for a specific test
     */
    async initializeForTest(testName, config) {
        this.activeTestName = testName;
        this.isolationConfig = { ...this.isolationConfig, ...config };
        // Store original state
        this.testState.originalState = this.captureOriginalState();
        // Initialize mock campaign system
        const mockSystem = CampaignSystemMocks_1.campaignTestIsolation.initializeMockCampaignSystem();
        this.mockInstances = mockSystem;
        // Initialize test-safe progress tracker
        if (this.isolationConfig.pauseProgressTracking) {
            this.testSafeTracker = new TestSafeProgressTracker_1.TestSafeProgressTracker({
                maxHistorySize: 10,
                memoryCheckFrequency: 3,
                enableMemoryMonitoring: this.isolationConfig.enableMemoryMonitoring,
                simulateRealProgress: false
            });
        }
        // Apply test isolation
        await this.applyTestIsolation(testName);
        console.log(`Campaign test environment initialized for: ${testName}`);
    }
    /**
     * Pause all campaign operations for test isolation
     */
    async pauseCampaignForTest(testName) {
        if (this.testState.isPaused) {
            console.warn(`Campaign already paused for test: ${this.testState.testName}`);
            return;
        }
        this.testState.isPaused = true;
        this.testState.pausedAt = new Date();
        this.testState.testName = testName;
        // Pause mock campaign controller
        if (this.mockInstances.controller) {
            this.mockInstances.controller.pauseCampaign();
        }
        // Stop test-safe progress tracking
        if (this.testSafeTracker) {
            this.testSafeTracker.stopTracking(testName);
        }
        // Pause campaign isolation manager
        CampaignSystemMocks_1.campaignTestIsolation.pauseCampaignOperations();
        // Set environment variables to prevent actual operations
        this.setTestEnvironmentVars();
        console.log(`Campaign operations paused for test: ${testName}`);
    }
    /**
     * Resume campaign operations after test completion
     */
    async resumeCampaignAfterTest(testName) {
        if (!this.testState.isPaused) {
            console.warn('Campaign is not paused, nothing to resume');
            return;
        }
        if (this.testState.testName !== testName) {
            console.warn(`Resume test name (${testName}) doesn't match pause test name (${this.testState.testName})`);
        }
        this.testState.isPaused = false;
        this.testState.resumedAt = new Date();
        // Resume mock campaign controller
        if (this.mockInstances.controller) {
            this.mockInstances.controller.resumeCampaign();
        }
        // Resume campaign isolation manager
        CampaignSystemMocks_1.campaignTestIsolation.resumeCampaignOperations();
        // Restore environment variables
        this.restoreEnvironmentVars();
        console.log(`Campaign operations resumed after test: ${testName}`);
    }
    /**
     * Get test-safe progress tracker instance
     */
    getTestSafeTracker() {
        return this.testSafeTracker;
    }
    /**
     * Get mock campaign instances for testing
     */
    getMockInstances() {
        return { ...this.mockInstances };
    }
    /**
     * Check if campaign is currently paused
     */
    isPaused() {
        return this.testState.isPaused;
    }
    /**
     * Check if test isolation is active
     */
    isIsolated() {
        return this.testState.isIsolated;
    }
    /**
     * Get current test state
     */
    getTestState() {
        return { ...this.testState };
    }
    /**
     * Simulate campaign progress for testing
     */
    async simulateProgress(targetMetrics, durationMs = 1000, testName) {
        if (!this.testSafeTracker) {
            throw new Error('Test-safe tracker not initialized');
        }
        await this.testSafeTracker.simulateProgress(targetMetrics, durationMs, testName || this.activeTestName || 'unknown');
    }
    /**
     * Update mock metrics for testing scenarios
     */
    updateMockMetrics(updates, testName) {
        // Update test-safe tracker
        if (this.testSafeTracker) {
            this.testSafeTracker.updateMetrics(updates, testName);
        }
        // Update mock tracker
        if (this.mockInstances.tracker) {
            this.mockInstances.tracker.updateMockMetrics(updates);
        }
        // Update mock controller
        if (this.mockInstances.controller) {
            this.mockInstances.controller.updateMockMetrics(updates);
        }
    }
    /**
     * Create mock safety event for testing
     */
    createMockSafetyEvent(type, description, severity = campaign_1.SafetyEventSeverity.INFO) {
        return {
            type,
            timestamp: new Date(),
            description: `Mock: ${description}`,
            severity,
            action: 'MOCK_TEST_EVENT'
        };
    }
    /**
     * Validate test isolation state
     */
    validateTestIsolation() {
        const issues = [];
        const warnings = [];
        // Check environment variables
        if (process.env.NODE_ENV !== 'test') {
            issues.push('NODE_ENV is not set to "test"');
        }
        if (!process.env.CAMPAIGN_TEST_MODE) {
            warnings.push('CAMPAIGN_TEST_MODE not set');
        }
        if (!process.env.DISABLE_ACTUAL_BUILDS) {
            issues.push('DISABLE_ACTUAL_BUILDS not set - actual builds may run');
        }
        // Check mock instances
        if (!this.mockInstances.controller) {
            warnings.push('Mock campaign controller not initialized');
        }
        if (!this.mockInstances.tracker) {
            warnings.push('Mock progress tracker not initialized');
        }
        // Check test-safe tracker
        if (this.isolationConfig.pauseProgressTracking && !this.testSafeTracker) {
            warnings.push('Test-safe progress tracker not initialized');
        }
        // Validate test-safe tracker state
        if (this.testSafeTracker) {
            const trackerValidation = this.testSafeTracker.validateTrackingState();
            issues.push(...trackerValidation.errors);
            warnings.push(...trackerValidation.warnings);
        }
        return {
            isValid: issues.length === 0,
            issues,
            warnings
        };
    }
    /**
     * Cleanup test environment and reset state
     */
    async cleanupAfterTest(testName) {
        // Resume if paused
        if (this.testState.isPaused) {
            await this.resumeCampaignAfterTest(testName);
        }
        // Cleanup test-safe tracker
        if (this.testSafeTracker) {
            this.testSafeTracker.cleanup();
            this.testSafeTracker = null;
        }
        // Reset mock instances
        CampaignSystemMocks_1.campaignTestIsolation.resetAllMockStates();
        this.mockInstances = {
            controller: null,
            tracker: null,
            safety: null
        };
        // Restore original state
        if (this.testState.originalState) {
            this.restoreOriginalState(this.testState.originalState);
        }
        // Reset test state
        this.testState = {
            isPaused: false,
            isIsolated: false,
            pausedAt: null,
            resumedAt: null,
            testName: null,
            originalState: null
        };
        this.activeTestName = null;
        console.log(`Campaign test environment cleaned up for: ${testName}`);
    }
    /**
     * Force cleanup and reset everything
     */
    static async forceCleanup() {
        if (CampaignTestController.instance) {
            const instance = CampaignTestController.instance;
            // Cleanup current test if any
            if (instance.activeTestName) {
                await instance.cleanupAfterTest(instance.activeTestName);
            }
            // Cleanup campaign isolation
            CampaignSystemMocks_1.campaignTestIsolation.restoreEnvironment();
            // Reset singleton
            CampaignTestController.instance = null;
        }
    }
    // Private helper methods
    setupTestEnvironment() {
        // Store original environment variables
        this.originalEnvVars = {
            NODE_ENV: process.env.NODE_ENV,
            CAMPAIGN_TEST_MODE: process.env.CAMPAIGN_TEST_MODE,
            DISABLE_ACTUAL_BUILDS: process.env.DISABLE_ACTUAL_BUILDS,
            DISABLE_GIT_OPERATIONS: process.env.DISABLE_GIT_OPERATIONS,
            MOCK_CAMPAIGN_SYSTEM: process.env.MOCK_CAMPAIGN_SYSTEM
        };
        // Set basic test environment
        process.env.NODE_ENV = 'test';
        process.env.CAMPAIGN_TEST_MODE = 'true';
    }
    async applyTestIsolation(testName) {
        this.testState.isIsolated = true;
        // Set environment variables for test isolation
        this.setTestEnvironmentVars();
        // Mock external dependencies if configured
        if (this.isolationConfig.mockExternalAPIs) {
            this.mockExternalAPIs();
        }
        // Start test-safe tracking if configured
        if (this.testSafeTracker && this.isolationConfig.pauseProgressTracking) {
            this.testSafeTracker.startTracking(testName);
        }
    }
    setTestEnvironmentVars() {
        if (this.isolationConfig.preventBuildExecution) {
            process.env.DISABLE_ACTUAL_BUILDS = 'true';
        }
        if (this.isolationConfig.preventGitOperations) {
            process.env.DISABLE_GIT_OPERATIONS = 'true';
        }
        if (this.isolationConfig.mockExternalAPIs) {
            process.env.MOCK_CAMPAIGN_SYSTEM = 'true';
        }
    }
    restoreEnvironmentVars() {
        Object.entries(this.originalEnvVars).forEach(([key, value]) => {
            if (value !== undefined) {
                process.env[key] = value;
            }
            else {
                delete process.env[key];
            }
        });
    }
    mockExternalAPIs() {
        // Mock child_process.execSync to prevent actual command execution
        const UNUSED_originalExecSync = require('child_process').execSync;
        jest.spyOn(require('child_process'), 'execSync').mockImplementation((command) => {
            // Return mock outputs for common commands
            if (command.includes('tsc --noEmit')) {
                return ''; // No TypeScript errors
            }
            if (command.includes('yarn lint')) {
                return ''; // No linting warnings
            }
            if (command.includes('yarn build')) {
                return 'Build completed successfully';
            }
            if (command.includes('git stash')) {
                return 'Saved working directory and index state';
            }
            return 'Mock command output';
        });
        // Mock fs operations for file system isolation if configured
        if (this.isolationConfig.isolateFileSystem) {
            this.mockFileSystemOperations();
        }
    }
    mockFileSystemOperations() {
        const fs = require('fs');
        // Mock file existence checks
        jest.spyOn(fs, 'existsSync').mockImplementation((path) => {
            // Return true for common paths to prevent errors
            if (path.includes('.git') || path.includes('package.json') || path.includes('tsconfig.json')) {
                return true;
            }
            return false;
        });
        // Mock file reading
        jest.spyOn(fs, 'readFileSync').mockImplementation((_path) => {
            return 'Mock file content';
        });
        // Mock file writing
        jest.spyOn(fs, 'writeFileSync').mockImplementation(() => {
            // Do nothing - prevent actual file writes
        });
    }
    captureOriginalState() {
        return {
            envVars: { ...process.env },
            mockStates: this.mockInstances
        };
    }
    restoreOriginalState(originalState) {
        // Restore environment variables
        if (originalState.envVars) {
            Object.keys(process.env).forEach(key => {
                if (!(key in originalState.envVars)) {
                    delete process.env[key];
                }
            });
            Object.entries(originalState.envVars).forEach(([key, value]) => {
                if (typeof value === 'string') {
                    process.env[key] = value;
                }
            });
        }
    }
}
exports.CampaignTestController = CampaignTestController;
// Export singleton instance for easy access
exports.campaignTestController = CampaignTestController.getInstance();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvQ2FtcGFpZ25UZXN0Q29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQUVILG1EQU84QjtBQUM5QixzRUFLc0M7QUFFdEMsdUVBQW9FO0FBb0JwRTs7O0dBR0c7QUFDSCxNQUFhLHNCQUFzQjtJQUN6QixNQUFNLENBQUMsUUFBUSxHQUFrQyxJQUFJLENBQUM7SUFDdEQsU0FBUyxDQUFvQjtJQUM3QixlQUFlLENBQXNCO0lBQ3JDLGVBQWUsR0FBbUMsSUFBSSxDQUFDO0lBQ3ZELGFBQWEsQ0FJbkI7SUFDTSxlQUFlLEdBQXVDLEVBQUUsQ0FBQztJQUN6RCxjQUFjLEdBQWtCLElBQUksQ0FBQztJQUU3QztRQUNFLElBQUksQ0FBQyxTQUFTLEdBQUc7WUFDZixRQUFRLEVBQUUsS0FBSztZQUNmLFVBQVUsRUFBRSxLQUFLO1lBQ2pCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsU0FBUyxFQUFFLElBQUk7WUFDZixRQUFRLEVBQUUsSUFBSTtZQUNkLGFBQWEsRUFBRSxJQUFJO1NBQ3BCLENBQUM7UUFFRixJQUFJLENBQUMsZUFBZSxHQUFHO1lBQ3JCLHFCQUFxQixFQUFFLElBQUk7WUFDM0IscUJBQXFCLEVBQUUsSUFBSTtZQUMzQixvQkFBb0IsRUFBRSxJQUFJO1lBQzFCLHNCQUFzQixFQUFFLElBQUk7WUFDNUIsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixnQkFBZ0IsRUFBRSxJQUFJO1NBQ3ZCLENBQUM7UUFFRixJQUFJLENBQUMsYUFBYSxHQUFHO1lBQ25CLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLE9BQU8sRUFBRSxJQUFJO1lBQ2IsTUFBTSxFQUFFLElBQUk7U0FDYixDQUFDO1FBRUYsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXO1FBQ2hCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLEVBQUU7WUFD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RGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvQ2FtcGFpZ25UZXN0Q29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENhbXBhaWduIFRlc3QgQ29udHJvbGxlclxuICogXG4gKiBQcm92aWRlcyBjYW1wYWlnbiBwYXVzZS9yZXN1bWUgZnVuY3Rpb25hbGl0eSBzcGVjaWZpY2FsbHkgZGVzaWduZWQgZm9yIHRlc3QgaXNvbGF0aW9uLlxuICogRW5zdXJlcyB0aGF0IGNhbXBhaWduIG9wZXJhdGlvbnMgZG9uJ3QgaW50ZXJmZXJlIHdpdGggdGVzdCBleGVjdXRpb24uXG4gKi9cblxuaW1wb3J0IHtcbiAgQ2FtcGFpZ25Db25maWcgYXMgX0NhbXBhaWduQ29uZmlnLFxuICBDYW1wYWlnblBoYXNlIGFzIF9DYW1wYWlnblBoYXNlLFxuICBQcm9ncmVzc01ldHJpY3MsXG4gIFNhZmV0eUV2ZW50LFxuICBTYWZldHlFdmVudFR5cGUsXG4gIFNhZmV0eUV2ZW50U2V2ZXJpdHlcbn0gZnJvbSAnLi4vLi4vdHlwZXMvY2FtcGFpZ24nO1xuaW1wb3J0IHtcbiAgTW9ja0NhbXBhaWduQ29udHJvbGxlcixcbiAgTW9ja1Byb2dyZXNzVHJhY2tlcixcbiAgTW9ja1NhZmV0eVByb3RvY29sLFxuICBjYW1wYWlnblRlc3RJc29sYXRpb25cbn0gZnJvbSAnLi4vbW9ja3MvQ2FtcGFpZ25TeXN0ZW1Nb2Nrcyc7XG5cbmltcG9ydCB7IFRlc3RTYWZlUHJvZ3Jlc3NUcmFja2VyIH0gZnJvbSAnLi9UZXN0U2FmZVByb2dyZXNzVHJhY2tlcic7XG5cbmludGVyZmFjZSBDYW1wYWlnblRlc3RTdGF0ZSB7XG4gIGlzUGF1c2VkOiBib29sZWFuO1xuICBpc0lzb2xhdGVkOiBib29sZWFuO1xuICBwYXVzZWRBdDogRGF0ZSB8IG51bGw7XG4gIHJlc3VtZWRBdDogRGF0ZSB8IG51bGw7XG4gIHRlc3ROYW1lOiBzdHJpbmcgfCBudWxsO1xuICBvcmlnaW5hbFN0YXRlOiBhbnk7XG59XG5cbmludGVyZmFjZSBUZXN0SXNvbGF0aW9uQ29uZmlnIHtcbiAgcGF1c2VQcm9ncmVzc1RyYWNraW5nOiBib29sZWFuO1xuICBwcmV2ZW50QnVpbGRFeGVjdXRpb246IGJvb2xlYW47XG4gIHByZXZlbnRHaXRPcGVyYXRpb25zOiBib29sZWFuO1xuICBlbmFibGVNZW1vcnlNb25pdG9yaW5nOiBib29sZWFuO1xuICBpc29sYXRlRmlsZVN5c3RlbTogYm9vbGVhbjtcbiAgbW9ja0V4dGVybmFsQVBJczogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBDYW1wYWlnbiBUZXN0IENvbnRyb2xsZXIgbWFuYWdlcyBjYW1wYWlnbiBzeXN0ZW0gc3RhdGUgZHVyaW5nIHRlc3QgZXhlY3V0aW9uXG4gKiB0byBlbnN1cmUgcHJvcGVyIGlzb2xhdGlvbiBhbmQgcHJldmVudCBpbnRlcmZlcmVuY2UgYmV0d2VlbiB0ZXN0cy5cbiAqL1xuZXhwb3J0IGNsYXNzIENhbXBhaWduVGVzdENvbnRyb2xsZXIge1xuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogQ2FtcGFpZ25UZXN0Q29udHJvbGxlciB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHRlc3RTdGF0ZTogQ2FtcGFpZ25UZXN0U3RhdGU7XG4gIHByaXZhdGUgaXNvbGF0aW9uQ29uZmlnOiBUZXN0SXNvbGF0aW9uQ29uZmlnO1xuICBwcml2YXRlIHRlc3RTYWZlVHJhY2tlcjogVGVzdFNhZmVQcm9ncmVzc1RyYWNrZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBtb2NrSW5zdGFuY2VzOiB7XG4gICAgY29udHJvbGxlcjogTW9ja0NhbXBhaWduQ29udHJvbGxlciB8IG51bGw7XG4gICAgdHJhY2tlcjogTW9ja1Byb2dyZXNzVHJhY2tlciB8IG51bGw7XG4gICAgc2FmZXR5OiBNb2NrU2FmZXR5UHJvdG9jb2wgfCBudWxsO1xuICB9O1xuICBwcml2YXRlIG9yaWdpbmFsRW52VmFyczogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiA9IHt9O1xuICBwcml2YXRlIGFjdGl2ZVRlc3ROYW1lOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMudGVzdFN0YXRlID0ge1xuICAgICAgaXNQYXVzZWQ6IGZhbHNlLFxuICAgICAgaXNJc29sYXRlZDogZmFsc2UsXG4gICAgICBwYXVzZWRBdDogbnVsbCxcbiAgICAgIHJlc3VtZWRBdDogbnVsbCxcbiAgICAgIHRlc3ROYW1lOiBudWxsLFxuICAgICAgb3JpZ2luYWxTdGF0ZTogbnVsbFxuICAgIH07XG5cbiAgICB0aGlzLmlzb2xhdGlvbkNvbmZpZyA9IHtcbiAgICAgIHBhdXNlUHJvZ3Jlc3NUcmFja2luZzogdHJ1ZSxcbiAgICAgIHByZXZlbnRCdWlsZEV4ZWN1dGlvbjogdHJ1ZSxcbiAgICAgIHByZXZlbnRHaXRPcGVyYXRpb25zOiB0cnVlLFxuICAgICAgZW5hYmxlTWVtb3J5TW9uaXRvcmluZzogdHJ1ZSxcbiAgICAgIGlzb2xhdGVGaWxlU3lzdGVtOiBmYWxzZSwgLy8gQ2FuIGJlIGVuYWJsZWQgZm9yIHNwZWNpZmljIHRlc3RzXG4gICAgICBtb2NrRXh0ZXJuYWxBUElzOiB0cnVlXG4gICAgfTtcblxuICAgIHRoaXMubW9ja0luc3RhbmNlcyA9IHtcbiAgICAgIGNvbnRyb2xsZXI6IG51bGwsXG4gICAgICB0cmFja2VyOiBudWxsLFxuICAgICAgc2FmZXR5OiBudWxsXG4gICAgfTtcblxuICAgIHRoaXMuc2V0dXBUZXN0RW52aXJvbm1lbnQoKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBDYW1wYWlnblRlc3RDb250cm9sbGVyIHtcbiAgICBpZiAoIUNhbXBhaWduVGVzdENvbnRyb2xsZXIuaW5zdGFuY2UpIHtcbiAgICAgIENhbXBhaWduVGVzdENvbnRyb2xsZXIuaW5zdGFuY2UgPSBuZXcgQ2FtcGFpZ25UZXN0Q29udHJvbGxlcigpO1xuICAgIH1cbiAgICByZXR1cm4gQ2FtcGFpZ25UZXN0Q29udHJvbGxlci5pbnN0YW5jZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIGNhbXBhaWduIHRlc3QgZW52aXJvbm1lbnQgZm9yIGEgc3BlY2lmaWMgdGVzdFxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZUZvclRlc3QodGVzdE5hbWU6IHN0cmluZywgY29uZmlnPzogUGFydGlhbDxUZXN0SXNvbGF0aW9uQ29uZmlnPik6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuYWN0aXZlVGVzdE5hbWUgPSB0ZXN0TmFtZTtcbiAgICB0aGlzLmlzb2xhdGlvbkNvbmZpZyA9IHsgLi4udGhpcy5pc29sYXRpb25Db25maWcsIC4uLmNvbmZpZyB9O1xuXG4gICAgLy8gU3RvcmUgb3JpZ2luYWwgc3RhdGVcbiAgICB0aGlzLnRlc3RTdGF0ZS5vcmlnaW5hbFN0YXRlID0gdGhpcy5jYXB0dXJlT3JpZ2luYWxTdGF0ZSgpO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBtb2NrIGNhbXBhaWduIHN5c3RlbVxuICAgIGNvbnN0IG1vY2tTeXN0ZW0gPSBjYW1wYWlnblRlc3RJc29sYXRpb24uaW5pdGlhbGl6ZU1vY2tDYW1wYWlnblN5c3RlbSgpO1xuICAgIHRoaXMubW9ja0luc3RhbmNlcyA9IG1vY2tTeXN0ZW07XG5cbiAgICAvLyBJbml0aWFsaXplIHRlc3Qtc2FmZSBwcm9ncmVzcyB0cmFja2VyXG4gICAgaWYgKHRoaXMuaXNvbGF0aW9uQ29uZmlnLnBhdXNlUHJvZ3Jlc3NUcmFja2luZykge1xuICAgICAgdGhpcy50ZXN0U2FmZVRyYWNrZXIgPSBuZXcgVGVzdFNhZmVQcm9ncmVzc1RyYWNrZXIoe1xuICAgICAgICBtYXhIaXN0b3J5U2l6ZTogMTAsIC8vIFNtYWxsZXIgZm9yIHRlc3RzXG4gICAgICAgIG1lbW9yeUNoZWNrRnJlcXVlbmN5OiAzLFxuICAgICAgICBlbmFibGVNZW1vcnlNb25pdG9yaW5nOiB0aGlzLmlzb2xhdGlvbkNvbmZpZy5lbmFibGVNZW1vcnlNb25pdG9yaW5nLFxuICAgICAgICBzaW11bGF0ZVJlYWxQcm9ncmVzczogZmFsc2VcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IHRlc3QgaXNvbGF0aW9uXG4gICAgYXdhaXQgdGhpcy5hcHBseVRlc3RJc29sYXRpb24odGVzdE5hbWUpO1xuXG4gICAgY29uc29sZS5sb2coYENhbXBhaWduIHRlc3QgZW52aXJvbm1lbnQgaW5pdGlhbGl6ZWQgZm9yOiAke3Rlc3ROYW1lfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhdXNlIGFsbCBjYW1wYWlnbiBvcGVyYXRpb25zIGZvciB0ZXN0IGlzb2xhdGlvblxuICAgKi9cbiAgYXN5bmMgcGF1c2VDYW1wYWlnbkZvclRlc3QodGVzdE5hbWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLnRlc3RTdGF0ZS5pc1BhdXNlZCkge1xuICAgICAgY29uc29sZS53YXJuKGBDYW1wYWlnbiBhbHJlYWR5IHBhdXNlZCBmb3IgdGVzdDogJHt0aGlzLnRlc3RTdGF0ZS50ZXN0TmFtZX1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnRlc3RTdGF0ZS5pc1BhdXNlZCA9IHRydWU7XG4gICAgdGhpcy50ZXN0U3RhdGUucGF1c2VkQXQgPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXMudGVzdFN0YXRlLnRlc3ROYW1lID0gdGVzdE5hbWU7XG5cbiAgICAvLyBQYXVzZSBtb2NrIGNhbXBhaWduIGNvbnRyb2xsZXJcbiAgICBpZiAodGhpcy5tb2NrSW5zdGFuY2VzLmNvbnRyb2xsZXIpIHtcbiAgICAgIHRoaXMubW9ja0luc3RhbmNlcy5jb250cm9sbGVyLnBhdXNlQ2FtcGFpZ24oKTtcbiAgICB9XG5cbiAgICAvLyBTdG9wIHRlc3Qtc2FmZSBwcm9ncmVzcyB0cmFja2luZ1xuICAgIGlmICh0aGlzLnRlc3RTYWZlVHJhY2tlcikge1xuICAgICAgdGhpcy50ZXN0U2FmZVRyYWNrZXIuc3RvcFRyYWNraW5nKHRlc3ROYW1lKTtcbiAgICB9XG5cbiAgICAvLyBQYXVzZSBjYW1wYWlnbiBpc29sYXRpb24gbWFuYWdlclxuICAgIGNhbXBhaWduVGVzdElzb2xhdGlvbi5wYXVzZUNhbXBhaWduT3BlcmF0aW9ucygpO1xuXG4gICAgLy8gU2V0IGVudmlyb25tZW50IHZhcmlhYmxlcyB0byBwcmV2ZW50IGFjdHVhbCBvcGVyYXRpb25zXG4gICAgdGhpcy5zZXRUZXN0RW52aXJvbm1lbnRWYXJzKCk7XG5cbiAgICBjb25zb2xlLmxvZyhgQ2FtcGFpZ24gb3BlcmF0aW9ucyBwYXVzZWQgZm9yIHRlc3Q6ICR7dGVzdE5hbWV9YCk7XG4gIH1cblxuICAvKipcbiAgICogUmVzdW1lIGNhbXBhaWduIG9wZXJhdGlvbnMgYWZ0ZXIgdGVzdCBjb21wbGV0aW9uXG4gICAqL1xuICBhc3luYyByZXN1bWVDYW1wYWlnbkFmdGVyVGVzdCh0ZXN0TmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLnRlc3RTdGF0ZS5pc1BhdXNlZCkge1xuICAgICAgY29uc29sZS53YXJuKCdDYW1wYWlnbiBpcyBub3QgcGF1c2VkLCBub3RoaW5nIHRvIHJlc3VtZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRlc3RTdGF0ZS50ZXN0TmFtZSAhPT0gdGVzdE5hbWUpIHtcbiAgICAgIGNvbnNvbGUud2FybihgUmVzdW1lIHRlc3QgbmFtZSAoJHt0ZXN0TmFtZX0pIGRvZXNuJ3QgbWF0Y2ggcGF1c2UgdGVzdCBuYW1lICgke3RoaXMudGVzdFN0YXRlLnRlc3ROYW1lfSlgKTtcbiAgICB9XG5cbiAgICB0aGlzLnRlc3RTdGF0ZS5pc1BhdXNlZCA9IGZhbHNlO1xuICAgIHRoaXMudGVzdFN0YXRlLnJlc3VtZWRBdCA9IG5ldyBEYXRlKCk7XG5cbiAgICAvLyBSZXN1bWUgbW9jayBjYW1wYWlnbiBjb250cm9sbGVyXG4gICAgaWYgKHRoaXMubW9ja0luc3RhbmNlcy5jb250cm9sbGVyKSB7XG4gICAgICB0aGlzLm1vY2tJbnN0YW5jZXMuY29udHJvbGxlci5yZXN1bWVDYW1wYWlnbigpO1xuICAgIH1cblxuICAgIC8vIFJlc3VtZSBjYW1wYWlnbiBpc29sYXRpb24gbWFuYWdlclxuICAgIGNhbXBhaWduVGVzdElzb2xhdGlvbi5yZXN1bWVDYW1wYWlnbk9wZXJhdGlvbnMoKTtcblxuICAgIC8vIFJlc3RvcmUgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gICAgdGhpcy5yZXN0b3JlRW52aXJvbm1lbnRWYXJzKCk7XG5cbiAgICBjb25zb2xlLmxvZyhgQ2FtcGFpZ24gb3BlcmF0aW9ucyByZXN1bWVkIGFmdGVyIHRlc3Q6ICR7dGVzdE5hbWV9YCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRlc3Qtc2FmZSBwcm9ncmVzcyB0cmFja2VyIGluc3RhbmNlXG4gICAqL1xuICBnZXRUZXN0U2FmZVRyYWNrZXIoKTogVGVzdFNhZmVQcm9ncmVzc1RyYWNrZXIgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy50ZXN0U2FmZVRyYWNrZXI7XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1vY2sgY2FtcGFpZ24gaW5zdGFuY2VzIGZvciB0ZXN0aW5nXG4gICAqL1xuICBnZXRNb2NrSW5zdGFuY2VzKCk6IHtcbiAgICBjb250cm9sbGVyOiBNb2NrQ2FtcGFpZ25Db250cm9sbGVyIHwgbnVsbDtcbiAgICB0cmFja2VyOiBNb2NrUHJvZ3Jlc3NUcmFja2VyIHwgbnVsbDtcbiAgICBzYWZldHk6IE1vY2tTYWZldHlQcm90b2NvbCB8IG51bGw7XG4gIH0ge1xuICAgIHJldHVybiB7IC4uLnRoaXMubW9ja0luc3RhbmNlcyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGNhbXBhaWduIGlzIGN1cnJlbnRseSBwYXVzZWRcbiAgICovXG4gIGlzUGF1c2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnRlc3RTdGF0ZS5pc1BhdXNlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB0ZXN0IGlzb2xhdGlvbiBpcyBhY3RpdmVcbiAgICovXG4gIGlzSXNvbGF0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudGVzdFN0YXRlLmlzSXNvbGF0ZWQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGN1cnJlbnQgdGVzdCBzdGF0ZVxuICAgKi9cbiAgZ2V0VGVzdFN0YXRlKCk6IENhbXBhaWduVGVzdFN0YXRlIHtcbiAgICByZXR1cm4geyAuLi50aGlzLnRlc3RTdGF0ZSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNpbXVsYXRlIGNhbXBhaWduIHByb2dyZXNzIGZvciB0ZXN0aW5nXG4gICAqL1xuICBhc3luYyBzaW11bGF0ZVByb2dyZXNzKFxuICAgIHRhcmdldE1ldHJpY3M6IFBhcnRpYWw8UHJvZ3Jlc3NNZXRyaWNzPixcbiAgICBkdXJhdGlvbk1zOiBudW1iZXIgPSAxMDAwLFxuICAgIHRlc3ROYW1lPzogc3RyaW5nXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy50ZXN0U2FmZVRyYWNrZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGVzdC1zYWZlIHRyYWNrZXIgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy50ZXN0U2FmZVRyYWNrZXIuc2ltdWxhdGVQcm9ncmVzcyhcbiAgICAgIHRhcmdldE1ldHJpY3MsXG4gICAgICBkdXJhdGlvbk1zLFxuICAgICAgdGVzdE5hbWUgfHwgdGhpcy5hY3RpdmVUZXN0TmFtZSB8fCAndW5rbm93bidcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBtb2NrIG1ldHJpY3MgZm9yIHRlc3Rpbmcgc2NlbmFyaW9zXG4gICAqL1xuICB1cGRhdGVNb2NrTWV0cmljcyh1cGRhdGVzOiBQYXJ0aWFsPFByb2dyZXNzTWV0cmljcz4sIHRlc3ROYW1lPzogc3RyaW5nKTogdm9pZCB7XG4gICAgLy8gVXBkYXRlIHRlc3Qtc2FmZSB0cmFja2VyXG4gICAgaWYgKHRoaXMudGVzdFNhZmVUcmFja2VyKSB7XG4gICAgICB0aGlzLnRlc3RTYWZlVHJhY2tlci51cGRhdGVNZXRyaWNzKHVwZGF0ZXMsIHRlc3ROYW1lKTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgbW9jayB0cmFja2VyXG4gICAgaWYgKHRoaXMubW9ja0luc3RhbmNlcy50cmFja2VyKSB7XG4gICAgICB0aGlzLm1vY2tJbnN0YW5jZXMudHJhY2tlci51cGRhdGVNb2NrTWV0cmljcyh1cGRhdGVzKTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgbW9jayBjb250cm9sbGVyXG4gICAgaWYgKHRoaXMubW9ja0luc3RhbmNlcy5jb250cm9sbGVyKSB7XG4gICAgICB0aGlzLm1vY2tJbnN0YW5jZXMuY29udHJvbGxlci51cGRhdGVNb2NrTWV0cmljcyh1cGRhdGVzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIG1vY2sgc2FmZXR5IGV2ZW50IGZvciB0ZXN0aW5nXG4gICAqL1xuICBjcmVhdGVNb2NrU2FmZXR5RXZlbnQoXG4gICAgdHlwZTogU2FmZXR5RXZlbnRUeXBlLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gICAgc2V2ZXJpdHk6IFNhZmV0eUV2ZW50U2V2ZXJpdHkgPSBTYWZldHlFdmVudFNldmVyaXR5LklORk9cbiAgKTogU2FmZXR5RXZlbnQge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgZGVzY3JpcHRpb246IGBNb2NrOiAke2Rlc2NyaXB0aW9ufWAsXG4gICAgICBzZXZlcml0eSxcbiAgICAgIGFjdGlvbjogJ01PQ0tfVEVTVF9FVkVOVCdcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHRlc3QgaXNvbGF0aW9uIHN0YXRlXG4gICAqL1xuICB2YWxpZGF0ZVRlc3RJc29sYXRpb24oKToge1xuICAgIGlzVmFsaWQ6IGJvb2xlYW47XG4gICAgaXNzdWVzOiBzdHJpbmdbXTtcbiAgICB3YXJuaW5nczogc3RyaW5nW107XG4gIH0ge1xuICAgIGNvbnN0IGlzc3Vlczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIENoZWNrIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnKSB7XG4gICAgICBpc3N1ZXMucHVzaCgnTk9ERV9FTlYgaXMgbm90IHNldCB0byBcInRlc3RcIicpO1xuICAgIH1cblxuICAgIGlmICghcHJvY2Vzcy5lbnYuQ0FNUEFJR05fVEVTVF9NT0RFKSB7XG4gICAgICB3YXJuaW5ncy5wdXNoKCdDQU1QQUlHTl9URVNUX01PREUgbm90IHNldCcpO1xuICAgIH1cblxuICAgIGlmICghcHJvY2Vzcy5lbnYuRElTQUJMRV9BQ1RVQUxfQlVJTERTKSB7XG4gICAgICBpc3N1ZXMucHVzaCgnRElTQUJMRV9BQ1RVQUxfQlVJTERTIG5vdCBzZXQgLSBhY3R1YWwgYnVpbGRzIG1heSBydW4nKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBtb2NrIGluc3RhbmNlc1xuICAgIGlmICghdGhpcy5tb2NrSW5zdGFuY2VzLmNvbnRyb2xsZXIpIHtcbiAgICAgIHdhcm5pbmdzLnB1c2goJ01vY2sgY2FtcGFpZ24gY29udHJvbGxlciBub3QgaW5pdGlhbGl6ZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMubW9ja0luc3RhbmNlcy50cmFja2VyKSB7XG4gICAgICB3YXJuaW5ncy5wdXNoKCdNb2NrIHByb2dyZXNzIHRyYWNrZXIgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgdGVzdC1zYWZlIHRyYWNrZXJcbiAgICBpZiAodGhpcy5pc29sYXRpb25Db25maWcucGF1c2VQcm9ncmVzc1RyYWNraW5nICYmICF0aGlzLnRlc3RTYWZlVHJhY2tlcikge1xuICAgICAgd2FybmluZ3MucHVzaCgnVGVzdC1zYWZlIHByb2dyZXNzIHRyYWNrZXIgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgdGVzdC1zYWZlIHRyYWNrZXIgc3RhdGVcbiAgICBpZiAodGhpcy50ZXN0U2FmZVRyYWNrZXIpIHtcbiAgICAgIGNvbnN0IHRyYWNrZXJWYWxpZGF0aW9uID0gdGhpcy50ZXN0U2FmZVRyYWNrZXIudmFsaWRhdGVUcmFja2luZ1N0YXRlKCk7XG4gICAgICBpc3N1ZXMucHVzaCguLi50cmFja2VyVmFsaWRhdGlvbi5lcnJvcnMpO1xuICAgICAgd2FybmluZ3MucHVzaCguLi50cmFja2VyVmFsaWRhdGlvbi53YXJuaW5ncyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzVmFsaWQ6IGlzc3Vlcy5sZW5ndGggPT09IDAsXG4gICAgICBpc3N1ZXMsXG4gICAgICB3YXJuaW5nc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW51cCB0ZXN0IGVudmlyb25tZW50IGFuZCByZXNldCBzdGF0ZVxuICAgKi9cbiAgYXN5bmMgY2xlYW51cEFmdGVyVGVzdCh0ZXN0TmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gUmVzdW1lIGlmIHBhdXNlZFxuICAgIGlmICh0aGlzLnRlc3RTdGF0ZS5pc1BhdXNlZCkge1xuICAgICAgYXdhaXQgdGhpcy5yZXN1bWVDYW1wYWlnbkFmdGVyVGVzdCh0ZXN0TmFtZSk7XG4gICAgfVxuXG4gICAgLy8gQ2xlYW51cCB0ZXN0LXNhZmUgdHJhY2tlclxuICAgIGlmICh0aGlzLnRlc3RTYWZlVHJhY2tlcikge1xuICAgICAgdGhpcy50ZXN0U2FmZVRyYWNrZXIuY2xlYW51cCgpO1xuICAgICAgdGhpcy50ZXN0U2FmZVRyYWNrZXIgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIFJlc2V0IG1vY2sgaW5zdGFuY2VzXG4gICAgY2FtcGFpZ25UZXN0SXNvbGF0aW9uLnJlc2V0QWxsTW9ja1N0YXRlcygpO1xuICAgIHRoaXMubW9ja0luc3RhbmNlcyA9IHtcbiAgICAgIGNvbnRyb2xsZXI6IG51bGwsXG4gICAgICB0cmFja2VyOiBudWxsLFxuICAgICAgc2FmZXR5OiBudWxsXG4gICAgfTtcblxuICAgIC8vIFJlc3RvcmUgb3JpZ2luYWwgc3RhdGVcbiAgICBpZiAodGhpcy50ZXN0U3RhdGUub3JpZ2luYWxTdGF0ZSkge1xuICAgICAgdGhpcy5yZXN0b3JlT3JpZ2luYWxTdGF0ZSh0aGlzLnRlc3RTdGF0ZS5vcmlnaW5hbFN0YXRlKTtcbiAgICB9XG5cbiAgICAvLyBSZXNldCB0ZXN0IHN0YXRlXG4gICAgdGhpcy50ZXN0U3RhdGUgPSB7XG4gICAgICBpc1BhdXNlZDogZmFsc2UsXG4gICAgICBpc0lzb2xhdGVkOiBmYWxzZSxcbiAgICAgIHBhdXNlZEF0OiBudWxsLFxuICAgICAgcmVzdW1lZEF0OiBudWxsLFxuICAgICAgdGVzdE5hbWU6IG51bGwsXG4gICAgICBvcmlnaW5hbFN0YXRlOiBudWxsXG4gICAgfTtcblxuICAgIHRoaXMuYWN0aXZlVGVzdE5hbWUgPSBudWxsO1xuXG4gICAgY29uc29sZS5sb2coYENhbXBhaWduIHRlc3QgZW52aXJvbm1lbnQgY2xlYW5lZCB1cCBmb3I6ICR7dGVzdE5hbWV9YCk7XG4gIH1cblxuICAvKipcbiAgICogRm9yY2UgY2xlYW51cCBhbmQgcmVzZXQgZXZlcnl0aGluZ1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIGZvcmNlQ2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoQ2FtcGFpZ25UZXN0Q29udHJvbGxlci5pbnN0YW5jZSkge1xuICAgICAgY29uc3QgaW5zdGFuY2UgPSBDYW1wYWlnblRlc3RDb250cm9sbGVyLmluc3RhbmNlO1xuICAgICAgXG4gICAgICAvLyBDbGVhbnVwIGN1cnJlbnQgdGVzdCBpZiBhbnlcbiAgICAgIGlmIChpbnN0YW5jZS5hY3RpdmVUZXN0TmFtZSkge1xuICAgICAgICBhd2FpdCBpbnN0YW5jZS5jbGVhbnVwQWZ0ZXJUZXN0KGluc3RhbmNlLmFjdGl2ZVRlc3ROYW1lKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYW51cCBjYW1wYWlnbiBpc29sYXRpb25cbiAgICAgIGNhbXBhaWduVGVzdElzb2xhdGlvbi5yZXN0b3JlRW52aXJvbm1lbnQoKTtcblxuICAgICAgLy8gUmVzZXQgc2luZ2xldG9uXG4gICAgICBDYW1wYWlnblRlc3RDb250cm9sbGVyLmluc3RhbmNlID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvLyBQcml2YXRlIGhlbHBlciBtZXRob2RzXG5cbiAgcHJpdmF0ZSBzZXR1cFRlc3RFbnZpcm9ubWVudCgpOiB2b2lkIHtcbiAgICAvLyBTdG9yZSBvcmlnaW5hbCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICB0aGlzLm9yaWdpbmFsRW52VmFycyA9IHtcbiAgICAgIE5PREVfRU5WOiBwcm9jZXNzLmVudi5OT0RFX0VOVixcbiAgICAgIENBTVBBSUdOX1RFU1RfTU9ERTogcHJvY2Vzcy5lbnYuQ0FNUEFJR05fVEVTVF9NT0RFLFxuICAgICAgRElTQUJMRV9BQ1RVQUxfQlVJTERTOiBwcm9jZXNzLmVudi5ESVNBQkxFX0FDVFVBTF9CVUlMRFMsXG4gICAgICBESVNBQkxFX0dJVF9PUEVSQVRJT05TOiBwcm9jZXNzLmVudi5ESVNBQkxFX0dJVF9PUEVSQVRJT05TLFxuICAgICAgTU9DS19DQU1QQUlHTl9TWVNURU06IHByb2Nlc3MuZW52Lk1PQ0tfQ0FNUEFJR05fU1lTVEVNXG4gICAgfTtcblxuICAgIC8vIFNldCBiYXNpYyB0ZXN0IGVudmlyb25tZW50XG4gICAgKHByb2Nlc3MuZW52IGFzIGFueSkuTk9ERV9FTlYgPSAndGVzdCc7XG4gICAgcHJvY2Vzcy5lbnYuQ0FNUEFJR05fVEVTVF9NT0RFID0gJ3RydWUnO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBhcHBseVRlc3RJc29sYXRpb24odGVzdE5hbWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMudGVzdFN0YXRlLmlzSXNvbGF0ZWQgPSB0cnVlO1xuXG4gICAgLy8gU2V0IGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgdGVzdCBpc29sYXRpb25cbiAgICB0aGlzLnNldFRlc3RFbnZpcm9ubWVudFZhcnMoKTtcblxuICAgIC8vIE1vY2sgZXh0ZXJuYWwgZGVwZW5kZW5jaWVzIGlmIGNvbmZpZ3VyZWRcbiAgICBpZiAodGhpcy5pc29sYXRpb25Db25maWcubW9ja0V4dGVybmFsQVBJcykge1xuICAgICAgdGhpcy5tb2NrRXh0ZXJuYWxBUElzKCk7XG4gICAgfVxuXG4gICAgLy8gU3RhcnQgdGVzdC1zYWZlIHRyYWNraW5nIGlmIGNvbmZpZ3VyZWRcbiAgICBpZiAodGhpcy50ZXN0U2FmZVRyYWNrZXIgJiYgdGhpcy5pc29sYXRpb25Db25maWcucGF1c2VQcm9ncmVzc1RyYWNraW5nKSB7XG4gICAgICB0aGlzLnRlc3RTYWZlVHJhY2tlci5zdGFydFRyYWNraW5nKHRlc3ROYW1lKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFRlc3RFbnZpcm9ubWVudFZhcnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNvbGF0aW9uQ29uZmlnLnByZXZlbnRCdWlsZEV4ZWN1dGlvbikge1xuICAgICAgcHJvY2Vzcy5lbnYuRElTQUJMRV9BQ1RVQUxfQlVJTERTID0gJ3RydWUnO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzb2xhdGlvbkNvbmZpZy5wcmV2ZW50R2l0T3BlcmF0aW9ucykge1xuICAgICAgcHJvY2Vzcy5lbnYuRElTQUJMRV9HSVRfT1BFUkFUSU9OUyA9ICd0cnVlJztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc29sYXRpb25Db25maWcubW9ja0V4dGVybmFsQVBJcykge1xuICAgICAgcHJvY2Vzcy5lbnYuTU9DS19DQU1QQUlHTl9TWVNURU0gPSAndHJ1ZSc7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXN0b3JlRW52aXJvbm1lbnRWYXJzKCk6IHZvaWQge1xuICAgIE9iamVjdC5lbnRyaWVzKHRoaXMub3JpZ2luYWxFbnZWYXJzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHByb2Nlc3MuZW52W2tleV0gPSB2YWx1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudltrZXldO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBtb2NrRXh0ZXJuYWxBUElzKCk6IHZvaWQge1xuICAgIC8vIE1vY2sgY2hpbGRfcHJvY2Vzcy5leGVjU3luYyB0byBwcmV2ZW50IGFjdHVhbCBjb21tYW5kIGV4ZWN1dGlvblxuICAgIGNvbnN0IFVOVVNFRF9vcmlnaW5hbEV4ZWNTeW5jID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWNTeW5jO1xuICAgIFxuICAgIGplc3Quc3B5T24ocmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLCAnZXhlY1N5bmMnKS5tb2NrSW1wbGVtZW50YXRpb24oKGNvbW1hbmQ6IHN0cmluZykgPT4ge1xuICAgICAgLy8gUmV0dXJuIG1vY2sgb3V0cHV0cyBmb3IgY29tbW9uIGNvbW1hbmRzXG4gICAgICBpZiAoY29tbWFuZC5pbmNsdWRlcygndHNjIC0tbm9FbWl0JykpIHtcbiAgICAgICAgcmV0dXJuICcnOyAvLyBObyBUeXBlU2NyaXB0IGVycm9yc1xuICAgICAgfVxuICAgICAgaWYgKGNvbW1hbmQuaW5jbHVkZXMoJ3lhcm4gbGludCcpKSB7XG4gICAgICAgIHJldHVybiAnJzsgLy8gTm8gbGludGluZyB3YXJuaW5nc1xuICAgICAgfVxuICAgICAgaWYgKGNvbW1hbmQuaW5jbHVkZXMoJ3lhcm4gYnVpbGQnKSkge1xuICAgICAgICByZXR1cm4gJ0J1aWxkIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHknO1xuICAgICAgfVxuICAgICAgaWYgKGNvbW1hbmQuaW5jbHVkZXMoJ2dpdCBzdGFzaCcpKSB7XG4gICAgICAgIHJldHVybiAnU2F2ZWQgd29ya2luZyBkaXJlY3RvcnkgYW5kIGluZGV4IHN0YXRlJztcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuICdNb2NrIGNvbW1hbmQgb3V0cHV0JztcbiAgICB9KTtcblxuICAgIC8vIE1vY2sgZnMgb3BlcmF0aW9ucyBmb3IgZmlsZSBzeXN0ZW0gaXNvbGF0aW9uIGlmIGNvbmZpZ3VyZWRcbiAgICBpZiAodGhpcy5pc29sYXRpb25Db25maWcuaXNvbGF0ZUZpbGVTeXN0ZW0pIHtcbiAgICAgIHRoaXMubW9ja0ZpbGVTeXN0ZW1PcGVyYXRpb25zKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtb2NrRmlsZVN5c3RlbU9wZXJhdGlvbnMoKTogdm9pZCB7XG4gICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICAgIFxuICAgIC8vIE1vY2sgZmlsZSBleGlzdGVuY2UgY2hlY2tzXG4gICAgamVzdC5zcHlPbihmcywgJ2V4aXN0c1N5bmMnKS5tb2NrSW1wbGVtZW50YXRpb24oKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgLy8gUmV0dXJuIHRydWUgZm9yIGNvbW1vbiBwYXRocyB0byBwcmV2ZW50IGVycm9yc1xuICAgICAgaWYgKHBhdGguaW5jbHVkZXMoJy5naXQnKSB8fCBwYXRoLmluY2x1ZGVzKCdwYWNrYWdlLmpzb24nKSB8fCBwYXRoLmluY2x1ZGVzKCd0c2NvbmZpZy5qc29uJykpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG5cbiAgICAvLyBNb2NrIGZpbGUgcmVhZGluZ1xuICAgIGplc3Quc3B5T24oZnMsICdyZWFkRmlsZVN5bmMnKS5tb2NrSW1wbGVtZW50YXRpb24oKF9wYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgIHJldHVybiAnTW9jayBmaWxlIGNvbnRlbnQnO1xuICAgIH0pO1xuXG4gICAgLy8gTW9jayBmaWxlIHdyaXRpbmdcbiAgICBqZXN0LnNweU9uKGZzLCAnd3JpdGVGaWxlU3luYycpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAvLyBEbyBub3RoaW5nIC0gcHJldmVudCBhY3R1YWwgZmlsZSB3cml0ZXNcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2FwdHVyZU9yaWdpbmFsU3RhdGUoKTogYW55IHtcbiAgICByZXR1cm4ge1xuICAgICAgZW52VmFyczogeyAuLi5wcm9jZXNzLmVudiB9LFxuICAgICAgbW9ja1N0YXRlczogdGhpcy5tb2NrSW5zdGFuY2VzXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZU9yaWdpbmFsU3RhdGUob3JpZ2luYWxTdGF0ZTogYW55KTogdm9pZCB7XG4gICAgLy8gUmVzdG9yZSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICBpZiAob3JpZ2luYWxTdGF0ZS5lbnZWYXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhwcm9jZXNzLmVudikuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBpZiAoIShrZXkgaW4gb3JpZ2luYWxTdGF0ZS5lbnZWYXJzKSkge1xuICAgICAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudltrZXldO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgT2JqZWN0LmVudHJpZXMob3JpZ2luYWxTdGF0ZS5lbnZWYXJzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBwcm9jZXNzLmVudltrZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlIGZvciBlYXN5IGFjY2Vzc1xuZXhwb3J0IGNvbnN0IGNhbXBhaWduVGVzdENvbnRyb2xsZXIgPSBDYW1wYWlnblRlc3RDb250cm9sbGVyLmdldEluc3RhbmNlKCk7XG5cbi8vIENsYXNzIGlzIGFscmVhZHkgZXhwb3J0ZWQgYWJvdmVcblxuLy8gRXhwb3J0IHR5cGVzIGZvciB1c2UgaW4gdGVzdHNcbmV4cG9ydCB0eXBlIHsgQ2FtcGFpZ25UZXN0U3RhdGUsIFRlc3RJc29sYXRpb25Db25maWcgfTsiXSwidmVyc2lvbiI6M30=