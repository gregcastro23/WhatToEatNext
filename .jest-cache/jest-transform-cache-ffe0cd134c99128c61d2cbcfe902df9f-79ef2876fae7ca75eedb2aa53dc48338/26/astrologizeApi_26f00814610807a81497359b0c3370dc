746784723b5788936f335cdbcf8ab8c2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCurrentChart = exports.testAstrologizeApi = exports.getPlanetaryPositionsForDateTime = exports.getCurrentPlanetaryPositions = exports.fetchPlanetaryPositions = void 0;
const apiCircuitBreaker_1 = require("@/utils/apiCircuitBreaker");
// Use local API endpoint instead of external
const LOCAL_ASTROLOGIZE_API_URL = '/api/astrologize';
// Default location (New York City)
const DEFAULT_LOCATION = {
    latitude: 40.7498,
    longitude: -73.7976
};
/**
 * Get current date/time/location for astrology API
 */
function getCurrentDateTimeLocation(customLocation) {
    var _a, _b;
    const now = new Date();
    return {
        year: now.getFullYear(),
        month: now.getMonth() + 1,
        date: now.getDate(),
        hour: now.getHours(),
        minute: now.getMinutes(),
        latitude: (_a = customLocation === null || customLocation === void 0 ? void 0 : customLocation.latitude) !== null && _a !== void 0 ? _a : DEFAULT_LOCATION.latitude,
        longitude: (_b = customLocation === null || customLocation === void 0 ? void 0 : customLocation.longitude) !== null && _b !== void 0 ? _b : DEFAULT_LOCATION.longitude,
        zodiacSystem: 'tropical' // Default to tropical zodiac
    };
}
/**
 * Convert sign name from API to our format
 */
function normalizeSignName(signName) {
    const signMap = {
        'aries': 'aries',
        'taurus': 'taurus',
        'gemini': 'gemini',
        'cancer': 'cancer',
        'leo': 'leo',
        'virgo': 'virgo',
        'libra': 'libra',
        'scorpio': 'scorpio',
        'sagittarius': 'sagittarius',
        'capricorn': 'capricorn',
        'aquarius': 'aquarius',
        'pisces': 'pisces'
    };
    const normalized = signName === null || signName === void 0 ? void 0 : signName.toLowerCase();
    return signMap[normalized] || 'aries';
}
/**
 * Calculate exact longitude from decimal degrees
 */
function calculateExactLongitude(decimalDegrees) {
    // Normalize to 0-360 range
    return ((decimalDegrees % 360) + 360) % 360;
}
/**
 * Call the local astrologize API to get planetary positions with circuit breaker
 */
async function fetchPlanetaryPositions(customDateTime) {
    const fallbackPositions = () => {
        console.log('Using fallback planetary positions due to API failure');
        return {
            Sun: { sign: 'gemini', degree: 13, minute: 54, exactLongitude: 73.9, isRetrograde: false },
            moon: { sign: 'virgo', degree: 26, minute: 31, exactLongitude: 176.52, isRetrograde: false },
            Mercury: { sign: 'gemini', degree: 20, minute: 11, exactLongitude: 80.18, isRetrograde: false },
            Venus: { sign: 'aries', degree: 28, minute: 6, exactLongitude: 28.1, isRetrograde: false },
            Mars: { sign: 'leo', degree: 22, minute: 48, exactLongitude: 142.8, isRetrograde: false },
            Jupiter: { sign: 'gemini', degree: 28, minute: 44, exactLongitude: 88.73, isRetrograde: false },
            Saturn: { sign: 'aries', degree: 0, minute: 41, exactLongitude: 0.68, isRetrograde: false },
            Uranus: { sign: 'taurus', degree: 28, minute: 17, exactLongitude: 58.28, isRetrograde: false },
            Neptune: { sign: 'aries', degree: 1, minute: 55, exactLongitude: 1.92, isRetrograde: false },
            Pluto: { sign: 'aquarius', degree: 3, minute: 36, exactLongitude: 303.6, isRetrograde: true },
            Ascendant: { sign: 'aries', degree: 16, minute: 16, exactLongitude: 16.27, isRetrograde: false }
        };
    };
    return apiCircuitBreaker_1.astrologizeApiCircuitBreaker.call(async () => {
        var _a;
        // Get current date/time or use provided values
        const defaultDateTime = getCurrentDateTimeLocation();
        const requestData = {
            ...defaultDateTime,
            ...customDateTime
        };
        console.log('Calling local astrologize API with:', requestData);
        // Determine if we should use GET or POST
        const isCurrentTime = !customDateTime || Object.keys(customDateTime).length === 0;
        let response;
        if (isCurrentTime) {
            // Use GET for current time with query parameters
            const params = new URLSearchParams();
            if (requestData.latitude)
                params.append('latitude', requestData.latitude.toString());
            if (requestData.longitude)
                params.append('longitude', requestData.longitude.toString());
            if (requestData.zodiacSystem)
                params.append('zodiacSystem', requestData.zodiacSystem);
            const url = `${LOCAL_ASTROLOGIZE_API_URL}?${params.toString()}`;
            response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                signal: AbortSignal.timeout(5000) // 5 second timeout for faster fallback
            });
        }
        else {
            // Use POST for custom date/time
            response = await fetch(LOCAL_ASTROLOGIZE_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData),
                signal: AbortSignal.timeout(5000) // 5 second timeout for faster fallback
            });
        }
        if (!response.ok) {
            throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        // Extract planetary positions from the new API structure
        const celestialBodies = data === null || data === void 0 ? void 0 : data._celestialBodies;
        if (!celestialBodies) {
            throw new Error('Invalid API response structure');
        }
        const positions = {};
        // Process each planet from the celestial bodies
        const planetMap = {
            sun: 'Sun',
            moon: 'Moon',
            mercury: 'Mercury',
            venus: 'Venus',
            mars: 'Mars',
            jupiter: 'Jupiter',
            saturn: 'Saturn',
            uranus: 'Uranus',
            neptune: 'Neptune',
            pluto: 'Pluto'
        };
        Object.entries(planetMap).forEach(([apiKey, planetName]) => {
            const planetData = celestialBodies[apiKey];
            if (planetData) {
                const sign = normalizeSignName(planetData.Sign.key);
                const decimalDegrees = planetData.ChartPosition.Ecliptic.DecimalDegrees;
                const arcDegrees = planetData.ChartPosition.Ecliptic.ArcDegrees;
                positions[planetName] = {
                    sign,
                    degree: arcDegrees.degrees,
                    minute: arcDegrees.minutes,
                    exactLongitude: calculateExactLongitude(decimalDegrees),
                    isRetrograde: planetData.isRetrograde || false
                };
            }
        });
        // For now, calculate Ascendant from the response if available
        // This should be extracted from the actual API response in future updates
        positions['Ascendant'] = {
            sign: 'aries',
            degree: 16,
            minute: 16,
            exactLongitude: 16.27,
            isRetrograde: false
        };
        console.log('Successfully fetched planetary positions from local API:', Object.keys(positions));
        console.log('ðŸŒŸ Using', ((_a = data.birth_info) === null || _a === void 0 ? void 0 : _a.ayanamsa) || 'TROPICAL', 'zodiac system');
        return positions;
    }, fallbackPositions);
}
exports.fetchPlanetaryPositions = fetchPlanetaryPositions;
/**
 * Get planetary positions for the current moment
 */
async function getCurrentPlanetaryPositions(location, zodiacSystem = 'tropical') {
    return await fetchPlanetaryPositions({
        ...location,
        zodiacSystem
    });
}
exports.getCurrentPlanetaryPositions = getCurrentPlanetaryPositions;
/**
 * Get planetary positions for a specific date/time
 */
async function getPlanetaryPositionsForDateTime(date, location, zodiacSystem = 'tropical') {
    return await fetchPlanetaryPositions({
        year: date.getFullYear(),
        month: date.getMonth() + 1,
        date: date.getDate(),
        hour: date.getHours(),
        minute: date.getMinutes(),
        zodiacSystem,
        ...location
    });
}
exports.getPlanetaryPositionsForDateTime = getPlanetaryPositionsForDateTime;
/**
 * Test the astrologize API connection
 */
async function testAstrologizeApi() {
    try {
        const positions = await fetchPlanetaryPositions();
        return Object.keys(positions || {}).length > 0;
    }
    catch (error) {
        console.error('Astrologize API test failed:', error);
        return false;
    }
}
exports.testAstrologizeApi = testAstrologizeApi;
/**
 * Get current chart data (alias for getCurrentPlanetaryPositions)
 */
async function getCurrentChart(location, zodiacSystem = 'tropical') {
    return await getCurrentPlanetaryPositions(location, zodiacSystem);
}
exports.getCurrentChart = getCurrentChart;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9zZXJ2aWNlcy9hc3Ryb2xvZ2l6ZUFwaS50cyIsIm1hcHBpbmdzIjoiOzs7QUFHQSxpRUFBeUU7QUFFekUsNkNBQTZDO0FBQzdDLE1BQU0seUJBQXlCLEdBQUcsa0JBQWtCLENBQUM7QUErRHJELG1DQUFtQztBQUNuQyxNQUFNLGdCQUFnQixHQUFHO0lBQ3ZCLFFBQVEsRUFBRSxPQUFPO0lBQ2pCLFNBQVMsRUFBRSxDQUFDLE9BQU87Q0FDcEIsQ0FBQztBQUVGOztHQUVHO0FBQ0gsU0FBUywwQkFBMEIsQ0FBQyxjQUF3RDs7SUFDMUYsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN2QixPQUFPO1FBQ0wsSUFBSSxFQUFFLEdBQUcsQ0FBQyxXQUFXLEVBQUU7UUFDdkIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDO1FBQ3pCLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxFQUFFO1FBQ25CLElBQUksRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFO1FBQ3BCLE1BQU0sRUFBRSxHQUFHLENBQUMsVUFBVSxFQUFFO1FBQ3hCLFFBQVEsRUFBRSxNQUFBLGNBQWMsYUFBZCxjQUFjLHVCQUFkLGNBQWMsQ0FBRSxRQUFRLG1DQUFJLGdCQUFnQixDQUFDLFFBQVE7UUFDL0QsU0FBUyxFQUFFLE1BQUEsY0FBYyxhQUFkLGNBQWMsdUJBQWQsY0FBYyxDQUFFLFNBQVMsbUNBQUksZ0JBQWdCLENBQUMsU0FBUztRQUNsRSxZQUFZLEVBQUUsVUFBbUIsQ0FBQyw2QkFBNkI7S0FDaEUsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsaUJBQWlCLENBQUMsUUFBZ0I7SUFDekMsTUFBTSxPQUFPLEdBQWtDO1FBQzdDLE9BQU8sRUFBRSxPQUFPO1FBQ2hCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLEtBQUssRUFBRSxLQUFLO1FBQ1osT0FBTyxFQUFFLE9BQU87UUFDaEIsT0FBTyxFQUFFLE9BQU87UUFDaEIsU0FBUyxFQUFFLFNBQVM7UUFDcEIsYUFBYSxFQUFFLGFBQWE7UUFDNUIsV0FBVyxFQUFFLFdBQVc7UUFDeEIsVUFBVSxFQUFFLFVBQVU7UUFDdEIsUUFBUSxFQUFFLFFBQVE7S0FDbkIsQ0FBQztJQUVGLE1BQU0sVUFBVSxHQUFHLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxXQUFXLEVBQWdCLENBQUM7SUFDekQsT0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksT0FBTyxDQUFDO0FBQ3hDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsdUJBQXVCLENBQUMsY0FBc0I7SUFDckQsMkJBQTJCO0lBQzNCLE9BQU8sQ0FBQyxDQUFDLGNBQWMsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDOUMsQ0FBQztBQUVEOztHQUVHO0FBQ0ksS0FBSyxVQUFVLHVCQUF1QixDQUMzQyxjQUFpRDtJQUdqRCxNQUFNLGlCQUFpQixHQUFHLEdBQW1DLEVBQUU7UUFDN0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1FBQ3JFLE9BQU87WUFDTCxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUU7WUFDMUYsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFO1lBQzVGLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRTtZQUMvRixLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUU7WUFDMUYsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFO1lBQ3pGLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRTtZQUMvRixNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUU7WUFDM0YsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFO1lBQzlGLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRTtZQUM1RixLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUU7WUFDN0YsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFF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Q0FBQyxDQUFDO0tBQ2hEO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JELE9BQU8sS0FBSyxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBUkQsZ0RBUUM7QUFFRDs7R0FFRztBQUNJLEtBQUssVUFBVSxlQUFlLENBQ25DLFFBQWtELEVBQ2xELGVBQXdDLFVBQVU7SUFFbEQsT0FBTyxNQUFNLDRCQUE0QixDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNwRSxDQUFDO0FBTEQsMENBS0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9zZXJ2aWNlcy9hc3Ryb2xvZ2l6ZUFwaS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQbGFuZXRQb3NpdGlvbiB9IGZyb20gJ0AvdXRpbHMvYXN0cm9sb2d5VXRpbHMnO1xuaW1wb3J0IHR5cGUgeyBab2RpYWNTaWduIH0gZnJvbSAnQC90eXBlcy9hbGNoZW15JztcbmltcG9ydCB7IFBsYW5ldGFyeVBvc2l0aW9uIH0gZnJvbSBcIkAvdHlwZXMvY2VsZXN0aWFsXCI7XG5pbXBvcnQgeyBhc3Ryb2xvZ2l6ZUFwaUNpcmN1aXRCcmVha2VyIH0gZnJvbSAnQC91dGlscy9hcGlDaXJjdWl0QnJlYWtlcic7XG5cbi8vIFVzZSBsb2NhbCBBUEkgZW5kcG9pbnQgaW5zdGVhZCBvZiBleHRlcm5hbFxuY29uc3QgTE9DQUxfQVNUUk9MT0dJWkVfQVBJX1VSTCA9ICcvYXBpL2FzdHJvbG9naXplJztcblxuLy8gSW50ZXJmYWNlIGZvciB0aGUgbG9jYWwgQVBJIHJlcXVlc3RcbmludGVyZmFjZSBMb2NhbEFzdHJvbG9naXplUmVxdWVzdCB7XG4gIHllYXI/OiBudW1iZXI7XG4gIG1vbnRoPzogbnVtYmVyOyAgLy8gMS1pbmRleGVkIGZvciB1c2VyIGlucHV0IChKYW51YXJ5ID0gMSwgRmVicnVhcnkgPSAyLCBldGMuKVxuICBkYXRlPzogbnVtYmVyO1xuICBob3VyPzogbnVtYmVyO1xuICBtaW51dGU/OiBudW1iZXI7XG4gIGxhdGl0dWRlPzogbnVtYmVyO1xuICBsb25naXR1ZGU/OiBudW1iZXI7XG4gIHpvZGlhY1N5c3RlbT86ICd0cm9waWNhbCcgfCAnc2lkZXJlYWwnOyAvLyBBZGQgem9kaWFjIHN5c3RlbSBzdXBwb3J0XG59XG5cbi8vIEludGVyZmFjZSBmb3IgcGxhbmV0YXJ5IGRhdGEgZnJvbSB0aGUgQVBJXG5pbnRlcmZhY2UgQXN0cm9sb2dpemVQbGFuZXREYXRhIHtcbiAga2V5OiBzdHJpbmc7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIFNpZ246IHtcbiAgICBrZXk6IHN0cmluZztcbiAgICB6b2RpYWM6IHN0cmluZztcbiAgICBsYWJlbDogc3RyaW5nO1xuICB9O1xuICBDaGFydFBvc2l0aW9uOiB7XG4gICAgRWNsaXB0aWM6IHtcbiAgICAgIERlY2ltYWxEZWdyZWVzOiBudW1iZXI7XG4gICAgICBBcmNEZWdyZWVzOiB7XG4gICAgICAgIGRlZ3JlZXM6IG51bWJlcjtcbiAgICAgICAgbWludXRlczogbnVtYmVyO1xuICAgICAgICBzZWNvbmRzOiBudW1iZXI7XG4gICAgICB9O1xuICAgIH07XG4gIH07XG4gIGlzUmV0cm9ncmFkZTogYm9vbGVhbjtcbn1cblxuLy8gSW50ZXJmYWNlIGZvciB0aGUgQVBJIHJlc3BvbnNlICh1cGRhdGVkIHRvIG1hdGNoIGFjdHVhbCBhc3Ryb2xvZ2l6ZSBBUEkgc3RydWN0dXJlKVxuaW50ZXJmYWNlIEFzdHJvbG9naXplUmVzcG9uc2Uge1xuICBfY2VsZXN0aWFsQm9kaWVzOiB7XG4gICAgYWxsOiBBc3Ryb2xvZ2l6ZVBsYW5ldERhdGFbXTtcbiAgICBzdW46IEFzdHJvbG9naXplUGxhbmV0RGF0YTtcbiAgICBtb29uOiBBc3Ryb2xvZ2l6ZVBsYW5ldERhdGE7XG4gICAgbWVyY3VyeTogQXN0cm9sb2dpemVQbGFuZXREYXRhO1xuICAgIHZlbnVzOiBBc3Ryb2xvZ2l6ZVBsYW5ldERhdGE7XG4gICAgbWFyczogQXN0cm9sb2dpemVQbGFuZXREYXRhO1xuICAgIGp1cGl0ZXI6IEFzdHJvbG9naXplUGxhbmV0RGF0YTtcbiAgICBzYXR1cm46IEFzdHJvbG9naXplUGxhbmV0RGF0YTtcbiAgICB1cmFudXM6IEFzdHJvbG9naXplUGxhbmV0RGF0YTtcbiAgICBuZXB0dW5lOiBBc3Ryb2xvZ2l6ZVBsYW5ldERhdGE7XG4gICAgcGx1dG86IEFzdHJvbG9naXplUGxhbmV0RGF0YTtcbiAgfTtcbiAgYmlydGhfaW5mbzoge1xuICAgIHllYXI6IG51bWJlcjtcbiAgICBtb250aDogbnVtYmVyO1xuICAgIGRhdGU6IG51bWJlcjtcbiAgICBob3VyOiBudW1iZXI7XG4gICAgbWludXRlOiBudW1iZXI7XG4gICAgbGF0aXR1ZGU6IG51bWJlcjtcbiAgICBsb25naXR1ZGU6IG51bWJlcjtcbiAgICBheWFuYW1zYTogc3RyaW5nO1xuICB9O1xufVxuXG4vLyBEZWZhdWx0IGxvY2F0aW9uIChOZXcgWW9yayBDaXR5KVxuY29uc3QgREVGQVVMVF9MT0NBVElPTiA9IHtcbiAgbGF0aXR1ZGU6IDQwLjc0OTgsXG4gIGxvbmdpdHVkZTogLTczLjc5NzZcbn07XG5cbi8qKlxuICogR2V0IGN1cnJlbnQgZGF0ZS90aW1lL2xvY2F0aW9uIGZvciBhc3Ryb2xvZ3kgQVBJXG4gKi9cbmZ1bmN0aW9uIGdldEN1cnJlbnREYXRlVGltZUxvY2F0aW9uKGN1c3RvbUxvY2F0aW9uPzogeyBsYXRpdHVkZTogbnVtYmVyOyBsb25naXR1ZGU6IG51bWJlciB9KSB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gIHJldHVybiB7XG4gICAgeWVhcjogbm93LmdldEZ1bGxZZWFyKCksXG4gICAgbW9udGg6IG5vdy5nZXRNb250aCgpICsgMSwgLy8gQ29udmVydCB0byAxLWluZGV4ZWQgZm9yIGxvY2FsIEFQSVxuICAgIGRhdGU6IG5vdy5nZXREYXRlKCksXG4gICAgaG91cjogbm93LmdldEhvdXJzKCksXG4gICAgbWludXRlOiBub3cuZ2V0TWludXRlcygpLFxuICAgIGxhdGl0dWRlOiBjdXN0b21Mb2NhdGlvbj8ubGF0aXR1ZGUgPz8gREVGQVVMVF9MT0NBVElPTi5sYXRpdHVkZSxcbiAgICBsb25naXR1ZGU6IGN1c3RvbUxvY2F0aW9uPy5sb25naXR1ZGUgPz8gREVGQVVMVF9MT0NBVElPTi5sb25naXR1ZGUsXG4gICAgem9kaWFjU3lzdGVtOiAndHJvcGljYWwnIGFzIGNvbnN0IC8vIERlZmF1bHQgdG8gdHJvcGljYWwgem9kaWFjXG4gIH07XG59XG5cbi8qKlxuICogQ29udmVydCBzaWduIG5hbWUgZnJvbSBBUEkgdG8gb3VyIGZvcm1hdFxuICovXG5mdW5jdGlvbiBub3JtYWxpemVTaWduTmFtZShzaWduTmFtZTogc3RyaW5nKTogWm9kaWFjU2lnbiB7XG4gIGNvbnN0IHNpZ25NYXA6IHsgW2tleTogc3RyaW5nXTogWm9kaWFjU2lnbiB9ID0ge1xuICAgICdhcmllcyc6ICdhcmllcycsXG4gICAgJ3RhdXJ1cyc6ICd0YXVydXMnLCBcbiAgICAnZ2VtaW5pJzogJ2dlbWluaScsXG4gICAgJ2NhbmNlcic6ICdjYW5jZXInLFxuICAgICdsZW8nOiAnbGVvJyxcbiAgICAndmlyZ28nOiAndmlyZ28nLFxuICAgICdsaWJyYSc6ICdsaWJyYScsXG4gICAgJ3Njb3JwaW8nOiAnc2NvcnBpbycsXG4gICAgJ3NhZ2l0dGFyaXVzJzogJ3NhZ2l0dGFyaXVzJyxcbiAgICAnY2Fwcmljb3JuJzogJ2NhcHJpY29ybicsXG4gICAgJ2FxdWFyaXVzJzogJ2FxdWFyaXVzJyxcbiAgICAncGlzY2VzJzogJ3Bpc2NlcydcbiAgfTtcbiAgXG4gIGNvbnN0IG5vcm1hbGl6ZWQgPSBzaWduTmFtZT8udG9Mb3dlckNhc2UoKSBhcyBab2RpYWNTaWduO1xuICByZXR1cm4gc2lnbk1hcFtub3JtYWxpemVkXSB8fCAnYXJpZXMnO1xufVxuXG4vKipcbiAqIENhbGN1bGF0ZSBleGFjdCBsb25naXR1ZGUgZnJvbSBkZWNpbWFsIGRlZ3JlZXNcbiAqL1xuZnVuY3Rpb24gY2FsY3VsYXRlRXhhY3RMb25naXR1ZGUoZGVjaW1hbERlZ3JlZXM6IG51bWJlcik6IG51bWJlciB7XG4gIC8vIE5vcm1hbGl6ZSB0byAwLTM2MCByYW5nZVxuICByZXR1cm4gKChkZWNpbWFsRGVncmVlcyAlIDM2MCkgKyAzNjApICUgMzYwO1xufVxuXG4vKipcbiAqIENhbGwgdGhlIGxvY2FsIGFzdHJvbG9naXplIEFQSSB0byBnZXQgcGxhbmV0YXJ5IHBvc2l0aW9ucyB3aXRoIGNpcmN1aXQgYnJlYWtlclxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2hQbGFuZXRhcnlQb3NpdGlvbnMoXG4gIGN1c3RvbURhdGVUaW1lPzogUGFydGlhbDxMb2NhbEFzdHJvbG9naXplUmVxdWVzdD5cbik6IFByb21pc2U8UmVjb3JkPHN0cmluZywgUGxhbmV0UG9zaXRpb24+PiB7XG4gIFxuICBjb25zdCBmYWxsYmFja1Bvc2l0aW9ucyA9ICgpOiBSZWNvcmQ8c3RyaW5nLCBQbGFuZXRQb3NpdGlvbj4gPT4ge1xuICAgIGNvbnNvbGUubG9nKCdVc2luZyBmYWxsYmFjayBwbGFuZXRhcnkgcG9zaXRpb25zIGR1ZSB0byBBUEkgZmFpbHVyZScpO1xuICAgIHJldHVybiB7XG4gICAgICBTdW46IHsgc2lnbjogJ2dlbWluaScsIGRlZ3JlZTogMTMsIG1pbnV0ZTogNTQsIGV4YWN0TG9uZ2l0dWRlOiA3My45LCBpc1JldHJvZ3JhZGU6IGZhbHNlIH0sXG4gICAgICBtb29uOiB7IHNpZ246ICd2aXJnbycsIGRlZ3JlZTogMjYsIG1pbnV0ZTogMzEsIGV4YWN0TG9uZ2l0dWRlOiAxNzYuNTIsIGlzUmV0cm9ncmFkZTogZmFsc2UgfSxcbiAgICAgIE1lcmN1cnk6IHsgc2lnbjogJ2dlbWluaScsIGRlZ3JlZTogMjAsIG1pbnV0ZTogMTEsIGV4YWN0TG9uZ2l0dWRlOiA4MC4xOCwgaXNSZXRyb2dyYWRlOiBmYWxzZSB9LFxuICAgICAgVmVudXM6IHsgc2lnbjogJ2FyaWVzJywgZGVncmVlOiAyOCwgbWludXRlOiA2LCBleGFjdExvbmdpdHVkZTogMjguMSwgaXNSZXRyb2dyYWRlOiBmYWxzZSB9LFxuICAgICAgTWFyczogeyBzaWduOiAnbGVvJywgZGVncmVlOiAyMiwgbWludXRlOiA0OCwgZXhhY3RMb25naXR1ZGU6IDE0Mi44LCBpc1JldHJvZ3JhZGU6IGZhbHNlIH0sXG4gICAgICBKdXBpdGVyOiB7IHNpZ246ICdnZW1pbmknLCBkZWdyZWU6IDI4LCBtaW51dGU6IDQ0LCBleGFjdExvbmdpdHVkZTogODguNzMsIGlzUmV0cm9ncmFkZTogZmFsc2UgfSxcbiAgICAgIFNhdHVybjogeyBzaWduOiAnYXJpZXMnLCBkZWdyZWU6IDAsIG1pbnV0ZTogNDEsIGV4YWN0TG9uZ2l0dWRlOiAwLjY4LCBpc1JldHJvZ3JhZGU6IGZhbHNlIH0sXG4gICAgICBVcmFudXM6IHsgc2lnbjogJ3RhdXJ1cycsIGRlZ3JlZTogMjgsIG1pbnV0ZTogMTcsIGV4YWN0TG9uZ2l0dWRlOiA1OC4yOCwgaXNSZXRyb2dyYWRlOiBmYWxzZSB9LFxuICAgICAgTmVwdHVuZTogeyBzaWduOiAnYXJpZXMnLCBkZWdyZWU6IDEsIG1pbnV0ZTogNTUsIGV4YWN0TG9uZ2l0dWRlOiAxLjkyLCBpc1JldHJvZ3JhZGU6IGZhbHNlIH0sXG4gICAgICBQbHV0bzogeyBzaWduOiAnYXF1YXJpdXMnLCBkZWdyZWU6IDMsIG1pbnV0ZTogMzYsIGV4YWN0TG9uZ2l0dWRlOiAzMDMuNiwgaXNSZXRyb2dyYWRlOiB0cnVlIH0sXG4gICAgICBBc2NlbmRhbnQ6IHsgc2lnbjogJ2FyaWVzJywgZGVncmVlOiAxNiwgbWludXRlOiAxNiwgZXhhY3RMb25naXR1ZGU6IDE2LjI3LCBpc1JldHJvZ3JhZGU6IGZhbHNlIH1cbiAgICB9O1xuICB9O1xuXG4gIHJldHVybiBhc3Ryb2xvZ2l6ZUFwaUNpcmN1aXRCcmVha2VyLmNhbGwoYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdldCBjdXJyZW50IGRhdGUvdGltZSBvciB1c2UgcHJvdmlkZWQgdmFsdWVzXG4gICAgY29uc3QgZGVmYXVsdERhdGVUaW1lID0gZ2V0Q3VycmVudERhdGVUaW1lTG9jYXRpb24oKTtcbiAgICBjb25zdCByZXF1ZXN0RGF0YTogTG9jYWxBc3Ryb2xvZ2l6ZVJlcXVlc3QgPSB7XG4gICAgICAuLi5kZWZhdWx0RGF0ZVRpbWUsXG4gICAgICAuLi5jdXN0b21EYXRlVGltZVxuICAgIH07XG5cbiAgICBjb25zb2xlLmxvZygnQ2FsbGluZyBsb2NhbCBhc3Ryb2xvZ2l6ZSBBUEkgd2l0aDonLCByZXF1ZXN0RGF0YSk7XG5cbiAgICAvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHVzZSBHRVQgb3IgUE9TVFxuICAgIGNvbnN0IGlzQ3VycmVudFRpbWUgPSAhY3VzdG9tRGF0ZVRpbWUgfHwgT2JqZWN0LmtleXMoY3VzdG9tRGF0ZVRpbWUpLmxlbmd0aCA9PT0gMDtcbiAgICBcbiAgICBsZXQgcmVzcG9uc2U6IFJlc3BvbnNlO1xuICAgIFxuICAgIGlmIChpc0N1cnJlbnRUaW1lKSB7XG4gICAgICAvLyBVc2UgR0VUIGZvciBjdXJyZW50IHRpbWUgd2l0aCBxdWVyeSBwYXJhbWV0ZXJzXG4gICAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XG4gICAgICBpZiAocmVxdWVzdERhdGEubGF0aXR1ZGUpIHBhcmFtcy5hcHBlbmQoJ2xhdGl0dWRlJywgcmVxdWVzdERhdGEubGF0aXR1ZGUudG9TdHJpbmcoKSk7XG4gICAgICBpZiAocmVxdWVzdERhdGEubG9uZ2l0dWRlKSBwYXJhbXMuYXBwZW5kKCdsb25naXR1ZGUnLCByZXF1ZXN0RGF0YS5sb25naXR1ZGUudG9TdHJpbmcoKSk7XG4gICAgICBpZiAocmVxdWVzdERhdGEuem9kaWFjU3lzdGVtKSBwYXJhbXMuYXBwZW5kKCd6b2RpYWNTeXN0ZW0nLCByZXF1ZXN0RGF0YS56b2RpYWNTeXN0ZW0pO1xuICAgICAgXG4gICAgICBjb25zdCB1cmwgPSBgJHtMT0NBTF9BU1RST0xPR0laRV9BUElfVVJMfT8ke3BhcmFtcy50b1N0cmluZygpfWA7XG4gICAgICByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICB9LFxuICAgICAgICBzaWduYWw6IEFib3J0U2lnbmFsLnRpbWVvdXQoNTAwMCkgLy8gNSBzZWNvbmQgdGltZW91dCBmb3IgZmFzdGVyIGZhbGxiYWNrXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVXNlIFBPU1QgZm9yIGN1c3RvbSBkYXRlL3RpbWVcbiAgICAgIHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goTE9DQUxfQVNUUk9MT0dJWkVfQVBJX1VSTCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdERhdGEpLFxuICAgICAgICBzaWduYWw6IEFib3J0U2lnbmFsLnRpbWVvdXQoNTAwMCkgLy8gNSBzZWNvbmQgdGltZW91dCBmb3IgZmFzdGVyIGZhbGxiYWNrXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFQSSByZXF1ZXN0IGZhaWxlZDogJHtyZXNwb25zZS5zdGF0dXN9ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRhOiBBc3Ryb2xvZ2l6ZVJlc3BvbnNlID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgIFxuICAgIC8vIEV4dHJhY3QgcGxhbmV0YXJ5IHBvc2l0aW9ucyBmcm9tIHRoZSBuZXcgQVBJIHN0cnVjdHVyZVxuICAgIGNvbnN0IGNlbGVzdGlhbEJvZGllcyA9IGRhdGE/Ll9jZWxlc3RpYWxCb2RpZXM7XG4gICAgXG4gICAgaWYgKCFjZWxlc3RpYWxCb2RpZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBBUEkgcmVzcG9uc2Ugc3RydWN0dXJlJyk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IHBvc2l0aW9uczogeyBba2V5OiBzdHJpbmddOiBQbGFuZXRQb3NpdGlvbiB9ID0ge307XG5cbiAgICAvLyBQcm9jZXNzIGVhY2ggcGxhbmV0IGZyb20gdGhlIGNlbGVzdGlhbCBib2RpZXNcbiAgICBjb25zdCBwbGFuZXRNYXAgPSB7XG4gICAgICBzdW46ICdTdW4nLFxuICAgICAgbW9vbjogJ01vb24nLCBcbiAgICAgIG1lcmN1cnk6ICdNZXJjdXJ5JyxcbiAgICAgIHZlbnVzOiAnVmVudXMnLFxuICAgICAgbWFyczogJ01hcnMnLFxuICAgICAganVwaXRlcjogJ0p1cGl0ZXInLFxuICAgICAgc2F0dXJuOiAnU2F0dXJuJyxcbiAgICAgIHVyYW51czogJ1VyYW51cycsXG4gICAgICBuZXB0dW5lOiAnTmVwdHVuZScsXG4gICAgICBwbHV0bzogJ1BsdXRvJ1xuICAgIH07XG5cbiAgICBPYmplY3QuZW50cmllcyhwbGFuZXRNYXApLmZvckVhY2goKFthcGlLZXksIHBsYW5ldE5hbWVdKSA9PiB7XG4gICAgICBjb25zdCBwbGFuZXREYXRhID0gY2VsZXN0aWFsQm9kaWVzW2FwaUtleSBhcyBrZXlvZiB0eXBlb2YgcGxhbmV0TWFwXTtcbiAgICAgIGlmIChwbGFuZXREYXRhKSB7XG4gICAgICAgIGNvbnN0IHNpZ24gPSBub3JtYWxpemVTaWduTmFtZShwbGFuZXREYXRhLlNpZ24ua2V5KTtcbiAgICAgICAgY29uc3QgZGVjaW1hbERlZ3JlZXMgPSBwbGFuZXREYXRhLkNoYXJ0UG9zaXRpb24uRWNsaXB0aWMuRGVjaW1hbERlZ3JlZXM7XG4gICAgICAgIGNvbnN0IGFyY0RlZ3JlZXMgPSBwbGFuZXREYXRhLkNoYXJ0UG9zaXRpb24uRWNsaXB0aWMuQXJjRGVncmVlcztcbiAgICAgICAgXG4gICAgICAgIHBvc2l0aW9uc1twbGFuZXROYW1lXSA9IHtcbiAgICAgICAgICBzaWduLFxuICAgICAgICAgIGRlZ3JlZTogYXJjRGVncmVlcy5kZWdyZWVzLFxuICAgICAgICAgIG1pbnV0ZTogYXJjRGVncmVlcy5taW51dGVzLFxuICAgICAgICAgIGV4YWN0TG9uZ2l0dWRlOiBjYWxjdWxhdGVFeGFjdExvbmdpdHVkZShkZWNpbWFsRGVncmVlcyksXG4gICAgICAgICAgaXNSZXRyb2dyYWRlOiBwbGFuZXREYXRhLmlzUmV0cm9ncmFkZSB8fCBmYWxzZVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gRm9yIG5vdywgY2FsY3VsYXRlIEFzY2VuZGFudCBmcm9tIHRoZSByZXNwb25zZSBpZiBhdmFpbGFibGVcbiAgICAvLyBUaGlzIHNob3VsZCBiZSBleHRyYWN0ZWQgZnJvbSB0aGUgYWN0dWFsIEFQSSByZXNwb25zZSBpbiBmdXR1cmUgdXBkYXRlc1xuICAgIHBvc2l0aW9uc1snQXNjZW5kYW50J10gPSB7XG4gICAgICBzaWduOiAnYXJpZXMnLFxuICAgICAgZGVncmVlOiAxNixcbiAgICAgIG1pbnV0ZTogMTYsXG4gICAgICBleGFjdExvbmdpdHVkZTogMTYuMjcsXG4gICAgICBpc1JldHJvZ3JhZGU6IGZhbHNlXG4gICAgfTtcblxuICAgIGNvbnNvbGUubG9nKCdTdWNjZXNzZnVsbHkgZmV0Y2hlZCBwbGFuZXRhcnkgcG9zaXRpb25zIGZyb20gbG9jYWwgQVBJOicsIE9iamVjdC5rZXlzKHBvc2l0aW9ucykpO1xuICAgIGNvbnNvbGUubG9nKCfwn4yfIFVzaW5nJywgZGF0YS5iaXJ0aF9pbmZvPy5heWFuYW1zYSB8fCAnVFJPUElDQUwnLCAnem9kaWFjIHN5c3RlbScpO1xuICAgIHJldHVybiBwb3NpdGlvbnM7XG5cbiAgfSwgZmFsbGJhY2tQb3NpdGlvbnMpO1xufVxuXG4vKipcbiAqIEdldCBwbGFuZXRhcnkgcG9zaXRpb25zIGZvciB0aGUgY3VycmVudCBtb21lbnRcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEN1cnJlbnRQbGFuZXRhcnlQb3NpdGlvbnMoXG4gIGxvY2F0aW9uPzogeyBsYXRpdHVkZTogbnVtYmVyOyBsb25naXR1ZGU6IG51bWJlciB9LFxuICB6b2RpYWNTeXN0ZW06ICd0cm9waWNhbCcgfCAnc2lkZXJlYWwnID0gJ3Ryb3BpY2FsJ1xuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBQbGFuZXRQb3NpdGlvbj4+IHtcbiAgcmV0dXJuIGF3YWl0IGZldGNoUGxhbmV0YXJ5UG9zaXRpb25zKHtcbiAgICAuLi5sb2NhdGlvbixcbiAgICB6b2RpYWNTeXN0ZW1cbiAgfSk7XG59XG5cbi8qKlxuICogR2V0IHBsYW5ldGFyeSBwb3NpdGlvbnMgZm9yIGEgc3BlY2lmaWMgZGF0ZS90aW1lXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQbGFuZXRhcnlQb3NpdGlvbnNGb3JEYXRlVGltZShcbiAgZGF0ZTogRGF0ZSxcbiAgbG9jYXRpb24/OiB7IGxhdGl0dWRlOiBudW1iZXI7IGxvbmdpdHVkZTogbnVtYmVyIH0sXG4gIHpvZGlhY1N5c3RlbTogJ3Ryb3BpY2FsJyB8ICdzaWRlcmVhbCcgPSAndHJvcGljYWwnXG4pOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIFBsYW5ldFBvc2l0aW9uPj4ge1xuICByZXR1cm4gYXdhaXQgZmV0Y2hQbGFuZXRhcnlQb3NpdGlvbnMoe1xuICAgIHllYXI6IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICBtb250aDogZGF0ZS5nZXRNb250aCgpICsgMSwgLy8gQ29udmVydCB0byAxLWluZGV4ZWQgZm9yIGxvY2FsIEFQSVxuICAgIGRhdGU6IGRhdGUuZ2V0RGF0ZSgpLFxuICAgIGhvdXI6IGRhdGUuZ2V0SG91cnMoKSxcbiAgICBtaW51dGU6IGRhdGUuZ2V0TWludXRlcygpLFxuICAgIHpvZGlhY1N5c3RlbSxcbiAgICAuLi5sb2NhdGlvblxuICB9KTtcbn1cblxuLyoqXG4gKiBUZXN0IHRoZSBhc3Ryb2xvZ2l6ZSBBUEkgY29ubmVjdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdGVzdEFzdHJvbG9naXplQXBpKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF3YWl0IGZldGNoUGxhbmV0YXJ5UG9zaXRpb25zKCk7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHBvc2l0aW9ucyB8fCB7fSkubGVuZ3RoID4gMDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdBc3Ryb2xvZ2l6ZSBBUEkgdGVzdCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBjdXJyZW50IGNoYXJ0IGRhdGEgKGFsaWFzIGZvciBnZXRDdXJyZW50UGxhbmV0YXJ5UG9zaXRpb25zKVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q3VycmVudENoYXJ0KFxuICBsb2NhdGlvbj86IHsgbGF0aXR1ZGU6IG51bWJlcjsgbG9uZ2l0dWRlOiBudW1iZXIgfSxcbiAgem9kaWFjU3lzdGVtOiAndHJvcGljYWwnIHwgJ3NpZGVyZWFsJyA9ICd0cm9waWNhbCdcbik6IFByb21pc2U8UmVjb3JkPHN0cmluZywgUGxhbmV0UG9zaXRpb24+PiB7XG4gIHJldHVybiBhd2FpdCBnZXRDdXJyZW50UGxhbmV0YXJ5UG9zaXRpb25zKGxvY2F0aW9uLCB6b2RpYWNTeXN0ZW0pO1xufSAiXSwidmVyc2lvbiI6M30=