e0a1aa44c97f39c6b213eec176c1fce5
"use strict";
// src/__tests__/utils/quantityScaling-integration.test.ts
// Integration tests for Phase 3: Quantity-Aware Recipe Recommendations
Object.defineProperty(exports, "__esModule", { value: true });
// Mock the recipe data service
jest.mock('@/services/recipeData', () => ({
    recipeDataService: {
        getAllRecipes: jest.fn(() => Promise.resolve([
            {
                id: 'test-recipe-1',
                title: 'Garlic Butter Pasta',
                ingredients: [
                    { name: 'garlic', amount: 3, unit: 'cloves' },
                    { name: 'butter', amount: 100, unit: 'g' },
                    { name: 'pasta', amount: 200, unit: 'g' }
                ],
                cookingMethods: ['boil', 'sautÃ©'],
                cuisine: 'Italian',
                elementalState: { Fire: 0.4, Water: 0.3, Earth: 0.2, Air: 0.1 }
            },
            {
                id: 'test-recipe-2',
                title: 'Spicy Stir Fry',
                ingredients: [
                    { name: 'ginger', amount: 2, unit: 'tbsp' },
                    { name: 'soy sauce', amount: 50, unit: 'ml' },
                    { name: 'chicken', amount: 300, unit: 'g' }
                ],
                cookingMethods: ['stir fry'],
                cuisine: 'Asian',
                elementalState: { Fire: 0.6, Water: 0.1, Earth: 0.2, Air: 0.1 }
            }
        ]))
    }
}));
const IngredientService_1 = require("@/services/IngredientService");
const UnifiedRecommendationService_1 = require("@/services/UnifiedRecommendationService");
describe('Phase 3: Quantity-Aware Recipe Recommendations', () => {
    let ingredientService;
    let recommendationService;
    beforeEach(() => {
        ingredientService = IngredientService_1.IngredientService.getInstance();
        recommendationService = UnifiedRecommendationService_1.UnifiedRecommendationService.getInstance();
        jest.clearAllMocks();
    });
    describe('IngredientService Quantity-Aware Methods', () => {
        test('getScaledIngredientProperties returns valid scaled properties', () => {
            const result = ingredientService.getScaledIngredientProperties('garlic', 6, 'cloves');
            expect(result).toBeDefined();
            if (result) {
                expect(result.base).toBeDefined();
                expect(result.scaled).toBeDefined();
                expect(result.quantity).toBe(6);
                expect(result.unit).toBe('cloves');
                expect(result.factor).toBeGreaterThan(0.1);
                expect(result.factor).toBeLessThan(2.0);
            }
        });
        test('calculateQuantityImpact scales elemental properties correctly', () => {
            const mockIngredient = {
                name: 'test garlic',
                elementalProperties: { Fire: 0.3, Water: 0.2, Earth: 0.4, Air: 0.1 }
            };
            const result = ingredientService.calculateQuantityImpact(mockIngredient, 10, 'cloves');
            expect(result).toBeDefined();
            if (result) {
                // Check that sum is approximately 1.0 (harmony enforcement)
                const sum = result.Fire + result.Water + result.Earth + result.Air;
                expect(sum).toBeCloseTo(1.0, 1);
            }
        });
        test('batchScaleIngredients processes multiple ingredients efficiently', () => {
            const batchData = [
                { ingredientId: 'garlic', quantity: 3, unit: 'cloves' },
                { ingredientId: 'butter', quantity: 100, unit: 'g' },
                { ingredientId: 'ginger', quantity: 2, unit: 'tbsp' }
            ];
            const results = ingredientService.batchScaleIngredients(batchData);
            expect(results).toHaveLength(3);
            results.forEach(result => {
                expect(result).toBeDefined();
            });
        });
        test('calculateQuantityAwareCompatibility uses scaled properties', () => {
            const score = ingredientService.calculateQuantityAwareCompatibility('garlic', 3, 'cloves', 'butter', 100, 'g');
            expect(typeof score).toBe('number');
            expect(score).toBeGreaterThanOrEqual(0);
            expect(score).toBeLessThanOrEqual(1);
        });
    });
    describe('UnifiedRecommendationService Quantity-Aware Methods', () => {
        test('getQuantityAwareRecipeRecommendations considers ingredient quantities', async () => {
            const criteria = {
                elementalProperties: { Fire: 0.4, Water: 0.3, Earth: 0.2, Air: 0.1 },
                useQuantityScaling: true,
                ingredientQuantities: [
                    { ingredient: 'garlic', quantity: 3, unit: 'cloves' },
                    { ingredient: 'butter', quantity: 100, unit: 'g' }
                ],
                limit: 5
            };
            const result = await recommendationService.getQuantityAwareRecipeRecommendations(criteria);
            expect(result).toBeDefined();
            expect(result.items).toBeDefined();
            expect(result.scores).toBeDefined();
            expect(result.context.quantityAware).toBe(true);
        });
        test('getQuantityAwareIngredientRecommendations uses target quantity scaling', async () => {
            const criteria = {
                elementalProperties: { Fire: 0.5, Water: 0.2, Earth: 0.2, Air: 0.1 },
                useQuantityScaling: true,
                targetQuantity: 200,
                targetUnit: 'g',
                categories: ['vegetables'],
                limit: 3
            };
            const result = await recommendationService.getQuantityAwareIngredientRecommendations(criteria);
            expect(result).toBeDefined();
            expect(result.items).toBeDefined();
            expect(result.scores).toBeDefined();
            expect(result.context.quantityAware).toBe(true);
        });
        test('kinetics bonus affects cooking method scoring', async () => {
            const criteria = {
                elementalProperties: { Fire: 0.6, Water: 0.1, Earth: 0.2, Air: 0.1 },
                useQuantityScaling: true,
                ingredientQuantities: [
                    { ingredient: 'ginger', quantity: 2, unit: 'tbsp' },
                    { ingredient: 'chicken', quantity: 300, unit: 'g' }
                ],
                cookingMethod: 'stir fry',
                limit: 5
            };
            const result = await recommendationService.getQuantityAwareRecipeRecommendations(criteria);
            expect(result).toBeDefined();
            // The spicy stir fry recipe should score higher due to cooking method + kinetics match
            const spicyRecipeScore = result.scores['test-recipe-2'];
            expect(spicyRecipeScore).toBeDefined();
            expect(spicyRecipeScore).toBeGreaterThan(0);
        });
    });
    describe('Quantity Scaling Validation', () => {
        test('elemental harmony is maintained in scaled properties', () => {
            const result = ingredientService.getScaledIngredientProperties('garlic', 10, 'cloves');
            if (result) {
                const scaled = result.scaled;
                const sum = scaled.Fire + scaled.Water + scaled.Earth + scaled.Air;
                expect(sum).toBeCloseTo(1.0, 1);
                // Each element should be between 0 and 1
                Object.values(scaled).forEach(value => {
                    expect(value).toBeGreaterThanOrEqual(0);
                    expect(value).toBeLessThanOrEqual(1);
                });
            }
        });
        test('scaling factor is within expected bounds', () => {
            const smallQuantity = ingredientService.getScaledIngredientProperties('garlic', 1, 'cloves');
            const largeQuantity = ingredientService.getScaledIngredientProperties('garlic', 20, 'cloves');
            if (smallQuantity && largeQuantity) {
                expect(smallQuantity.factor).toBeGreaterThan(0.1);
                expect(smallQuantity.factor).toBeLessThan(2.0);
                expect(largeQuantity.factor).toBeGreaterThan(0.1);
                expect(largeQuantity.factor).toBeLessThan(2.0);
            }
        });
        test('kinetics impact is calculated for thermodynamic ingredients', () => {
            const result = ingredientService.getScaledIngredientProperties('garlic', 5, 'cloves');
            if (result && result.kineticsImpact) {
                const { forceAdjustment, thermalShift } = result.kineticsImpact;
                expect(typeof forceAdjustment).toBe('number');
                expect(typeof thermalShift).toBe('number');
                expect(Math.abs(forceAdjustment)).toBeLessThan(10);
                expect(Math.abs(thermalShift)).toBeLessThan(5);
            }
        });
    });
    describe('Performance Validation', () => {
        test('batch processing is efficient', () => {
            const batchData = Array.from({ length: 10 }, (_, i) => ({
                ingredientId: 'garlic',
                quantity: 3 + i,
                unit: 'cloves'
            }));
            const startTime = Date.now();
            const results = ingredientService.batchScaleIngredients(batchData);
            const endTime = Date.now();
            expect(results).toHaveLength(10);
            expect(endTime - startTime).toBeLessThan(100); // Should complete in < 100ms
        });
        test('recommendation service handles quantity data efficiently', async () => {
            const criteria = {
                elementalProperties: { Fire: 0.4, Water: 0.3, Earth: 0.2, Air: 0.1 },
                useQuantityScaling: true,
                ingredientQuantities: Array.from({ length: 5 }, (_, i) => ({
                    ingredient: `ingredient-${i}`,
                    quantity: 100 + i * 50,
                    unit: 'g'
                })),
                limit: 3
            };
            const startTime = Date.now();
            const result = await recommendationService.getQuantityAwareRecipeRecommendations(criteria);
            const endTime = Date.now();
            expect(result).toBeDefined();
            expect(endTime - startTime).toBeLessThan(200); // Should complete in < 200ms
        });
    });
    describe('Backward Compatibility', () => {
        test('standard recommendations still work without quantity scaling', async () => {
            const criteria = {
                elementalProperties: { Fire: 0.4, Water: 0.3, Earth: 0.2, Air: 0.1 },
                limit: 5
            };
            const result = await recommendationService.getRecommendedRecipes(criteria);
            expect(result).toBeDefined();
            expect(result.items).toBeDefined();
            expect(result.context.quantityAware).toBeUndefined();
        });
        test('ingredient service methods work without quantity parameters', () => {
            const ingredient = ingredientService.getIngredientByName('garlic');
            expect(ingredient).toBeDefined();
            const compatibility = ingredientService.calculateIngredientCompatibility('garlic', 'butter');
            expect(compatibility.score).toBeDefined();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvcXVhbnRpdHlTY2FsaW5nLWludGVncmF0aW9uLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBLDBEQUEwRDtBQUMxRCx1RUFBdUU7O0FBUXZFLCtCQUErQjtBQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEMsaUJBQWlCLEVBQUU7UUFDakIsYUFBYSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUMzQztnQkFDRSxFQUFFLEVBQUUsZUFBZTtnQkFDbkIsS0FBSyxFQUFFLHFCQUFxQjtnQkFDNUIsV0FBVyxFQUFFO29CQUNYLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7b0JBQzdDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7b0JBQzFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7aUJBQzFDO2dCQUNELGNBQWMsRUFBRSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUM7Z0JBQ2pDLE9BQU8sRUFBRSxTQUFTO2dCQUNsQixjQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO2FBQ3REO1lBQ1g7Z0JBQ0UsRUFBRSxFQUFFLGVBQWU7Z0JBQ25CLEtBQUssRUFBRSxnQkFBZ0I7Z0JBQ3ZCLFdBQVcsRUFBRTtvQkFDWCxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO29CQUMzQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO29CQUM3QyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFO2lCQUM1QztnQkFDRCxjQUFjLEVBQUUsQ0FBQyxVQUFVLENBQUM7Z0JBQzVCLE9BQU8sRUFBRSxPQUFPO2dCQUNoQixjQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO2FBQ3REO1NBQ1osQ0FBQyxDQUFDO0tBQ0o7Q0FDRixDQUFDLENBQUMsQ0FBQztBQXBDSixvRUFBaUU7QUFDakUsMEZBQXVGO0FBcUN2RixRQUFRLENBQUMsZ0RBQWdELEVBQUUsR0FBRyxFQUFFO0lBQzlELElBQUksaUJBQW9DLENBQUM7SUFDekMsSUFBSSxxQkFBbUQsQ0FBQztJQUV4RCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsaUJBQWlCLEdBQUcscUNBQWlCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDcEQscUJBQXFCLEdBQUcsMkRBQTRCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLDBDQUEwQyxFQUFFLEdBQUcsRUFBRTtRQUN4RCxJQUFJLENBQUMsK0RBQStELEVBQUUsR0FBRyxFQUFFO1lBQ3pFLE1BQU0sTUFBTSxHQUFHLGlCQUFpQixDQUFDLDZCQUE2QixDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFdEYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzdCLElBQUksTUFBTSxFQUFFO2dCQUNWLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ2xDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3BDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNoQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzNDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3pDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsK0RBQStELEVBQUUsR0FBRyxFQUFFO1lBQ3pFLE1BQU0sY0FBYyxHQUFHO2dCQUNyQixJQUFJLEVBQUUsYUFBYTtnQkFDbkIsbUJBQW1CLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO2FBQ3JFLENBQUM7WUFFRixNQUFNLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQyx1QkFBdUIsQ0FBQyxjQUFjLEVBQUUsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRXZGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM3QixJQUFJLE1BQU0sRUFBRTtnQkFDViw0REFBNEQ7Z0JBQzVELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7Z0JBQ25FLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ2pDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsa0VBQWtFLEVBQUUsR0FBRyxFQUFFO1lBQzVFLE1BQU0sU0FBUyxHQUFHO2dCQUNoQixFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO2dCQUN2RCxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFO2dCQUNwRCxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO2FBQ3RELENBQUM7WUFFRixNQUFNLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVuRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMvQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLDREQUE0RCxFQUFFLEdBQUcsRUFBRTtZQUN0RSxNQUFNLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxtQ0FBbUMsQ0FDakUsUUFBUSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQ3JCLFFBQVEsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUNuQixDQUFDO1lBRUYsTUFBTSxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxxREFBcUQsRUFBRSxHQUFHLEVBQUU7UUFDbkUsSUFBSSxDQUFDLHVFQUF1RSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3ZGLE1BQU0sUUFBUSxHQUFHO2dCQUNmLG1CQUFtQixFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtnQkFDcEUsa0JBQWtCLEVBQUUsSUFBSTtnQkFDeEIsb0JBQW9CLEVBQUU7b0JBQ3BCLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7b0JBQ3JELEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7aUJBQ25EO2dCQUNELEtBQUssRUFBRSxDQUFDO2FBQ1QsQ0FBQztZQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0scUJBQXFCLENBQUMscUNBQXFDLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFM0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNwQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsd0VBQXdFLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDeEYsTUFBTSxRQUFRLEdBQUc7Z0JBQ2YsbUJBQW1CLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO2dCQUNwRSxrQkFBa0IsRUFBRSxJQUFJO2dCQUN4QixjQUFjLEVBQUUsR0FBRztnQkFDbkIsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsVUFBVSxFQUFFLENBQUMsWUFBWSxDQUFDO2dCQUMxQixLQUFLLEVBQUUsQ0FBQzthQUNULENBQUM7WUFFRixNQUFNLE1BQU0sR0FBRyxNQUFNLHFCQUFxQixDQUFDLHlDQUF5QyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRS9GLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM3QixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ25DLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDcEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLCtDQUErQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQy9ELE1BQU0sUUFBUSxHQUFHO2dCQUNmLG1CQUFtQixFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtnQkFDcEUsa0JBQWtCLEVBQUUsSUFBSTtnQkFDeEIsb0JBQW9CLEVBQUU7b0JBQ3BCLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7b0JBQ25ELEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7aUJBQ3BEO2dCQUNELGFBQWEsRUFBRSxVQUFVO2dCQUN6QixLQUFLLEVBQUUsQ0FBQzthQUNULENBQUM7WUFFRixNQUFNLE1BQU0sR0FBRyxNQUFNLHFCQUFxQixDQUFDLHFDQUFxQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM3Qix1RkFBdUY7WUFDdkYsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3hELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLDZCQUE2QixFQUFFLEdBQUcsRUFBRTtRQUMzQyxJQUFJLENBQUMsc0RBQXNELEVBQUUsR0FBRyxFQUFFO1lBQ2hFLE1BQU0sTUFBTSxHQUFHLGlCQUFpQixDQUFDLDZCQUE2QixDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFdkYsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztnQkFDN0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztnQkFDbkUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBRWhDLHlDQUF5QztnQkFDekMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2QyxDQUFDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFO1lBQ3BELE1BQU0sYUFBYSxHQUFHLGlCQUFpQixDQUFDLDZCQUE2QixDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDN0YsTUFBTSxhQUFhLEdBQUcsaUJBQWlCLENBQUMsNkJBQTZCLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUU5RixJQUFJLGFBQWEsSUFBSSxhQUFhLEVBQUU7Z0JBQ2xDLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNsRCxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0MsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2xELE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ2hEO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsNkRBQTZELEVBQUUsR0FBRyxFQUFFO1lBQ3ZFLE1BQU0sTUFBTSxHQUFHLGlCQUFpQixDQUFDLDZCQUE2QixDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFdEYsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLGNBQWMsRUFBRTtnQkFDbkMsTUFBTSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDO2dCQUNoRSxNQUFNLENBQUMsT0FBTyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzlDLE1BQU0sQ0FBQyxPQUFPLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDM0MsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25ELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2hEO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7UUFDdEMsSUFBSSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtZQUN6QyxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDdEQsWUFBWSxFQUFFLFFBQVE7Z0JBQ3RCLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQztnQkFDZixJQUFJLEVBQUUsUUFBUTthQUNmLENBQUMsQ0FBQyxDQUFDO1lBRUosTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzdCLE1BQU0sT0FBTyxHQUFHLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ25FLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUUzQixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsNkJBQTZCO1FBQzlFLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLDBEQUEwRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzFFLE1BQU0sUUFBUSxHQUFHO2dCQUNmLG1CQUFtQixFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtnQkFDcEUsa0JBQWtCLEVBQUUsSUFBSTtnQkFDeEIsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQ3pELFVBQVUsRUFBRSxjQUFjLENBQUMsRUFBRTtvQkFDN0IsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsRUFBRTtvQkFDdEIsSUFBSSxFQUFFLEdBQUc7aUJBQ1YsQ0FBQyxDQUFDO2dCQUNILEtBQUssRUFBRSxDQUFDO2FBQ1QsQ0FBQztZQUVGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM3QixNQUFNLE1BQU0sR0FBRyxNQUFNLHFCQUFxQixDQUFDLHFDQUFxQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNGLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUUzQixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDN0IsTUFBTSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyw2QkFBNkI7UUFDOUUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7UUFDdEMsSUFBSSxDQUFDLDhEQUE4RCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzlFLE1BQU0sUUFBUSxHQUFHO2dCQUNmLG1CQUFtQixFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtnQkFDcEUsS0FBSyxFQUFFLENBQUM7YUFDVCxDQUFDO1lBRUYsTUFBTSxNQUFNLEdBQUcsTUFBTSxxQkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUUzRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyw2REFBNkQsRUFBRSxHQUFHLEVBQUU7WUFDdkUsTUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBRWpDLE1BQU0sYUFBYSxHQUFHLGlCQUFpQixDQUFDLGdDQUFnQyxDQUN0RSxRQUFRLEVBQ1IsUUFBUSxDQUNULENBQUM7WUFDRixNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL19fdGVzdHNfXy91dGlscy9xdWFudGl0eVNjYWxpbmctaW50ZWdyYXRpb24udGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvX190ZXN0c19fL3V0aWxzL3F1YW50aXR5U2NhbGluZy1pbnRlZ3JhdGlvbi50ZXN0LnRzXG4vLyBJbnRlZ3JhdGlvbiB0ZXN0cyBmb3IgUGhhc2UgMzogUXVhbnRpdHktQXdhcmUgUmVjaXBlIFJlY29tbWVuZGF0aW9uc1xuXG5pbXBvcnQgeyBJbmdyZWRpZW50U2VydmljZSB9IGZyb20gJ0Avc2VydmljZXMvSW5ncmVkaWVudFNlcnZpY2UnO1xuaW1wb3J0IHsgVW5pZmllZFJlY29tbWVuZGF0aW9uU2VydmljZSB9IGZyb20gJ0Avc2VydmljZXMvVW5pZmllZFJlY29tbWVuZGF0aW9uU2VydmljZSc7XG5pbXBvcnQgeyBFbGVtZW50YWxQcm9wZXJ0aWVzLCBUaGVybW9keW5hbWljTWV0cmljcyB9IGZyb20gJ0AvdHlwZXMvYWxjaGVteSc7XG5pbXBvcnQgeyBSZWNpcGUgfSBmcm9tICdAL3R5cGVzL3JlY2lwZSc7XG5pbXBvcnQgeyBJbmdyZWRpZW50IH0gZnJvbSAnQC90eXBlcy9pbmdyZWRpZW50JztcblxuLy8gTW9jayB0aGUgcmVjaXBlIGRhdGEgc2VydmljZVxuamVzdC5tb2NrKCdAL3NlcnZpY2VzL3JlY2lwZURhdGEnLCAoKSA9PiAoe1xuICByZWNpcGVEYXRhU2VydmljZToge1xuICAgIGdldEFsbFJlY2lwZXM6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKFtcbiAgICAgIHtcbiAgICAgICAgaWQ6ICd0ZXN0LXJlY2lwZS0xJyxcbiAgICAgICAgdGl0bGU6ICdHYXJsaWMgQnV0dGVyIFBhc3RhJyxcbiAgICAgICAgaW5ncmVkaWVudHM6IFtcbiAgICAgICAgICB7IG5hbWU6ICdnYXJsaWMnLCBhbW91bnQ6IDMsIHVuaXQ6ICdjbG92ZXMnIH0sXG4gICAgICAgICAgeyBuYW1lOiAnYnV0dGVyJywgYW1vdW50OiAxMDAsIHVuaXQ6ICdnJyB9LFxuICAgICAgICAgIHsgbmFtZTogJ3Bhc3RhJywgYW1vdW50OiAyMDAsIHVuaXQ6ICdnJyB9XG4gICAgICAgIF0sXG4gICAgICAgIGNvb2tpbmdNZXRob2RzOiBbJ2JvaWwnLCAnc2F1dMOpJ10sXG4gICAgICAgIGN1aXNpbmU6ICdJdGFsaWFuJyxcbiAgICAgICAgZWxlbWVudGFsU3RhdGU6IHsgRmlyZTogMC40LCBXYXRlcjogMC4zLCBFYXJ0aDogMC4yLCBBaXI6IDAuMSB9XG4gICAgICB9IGFzIFJlY2lwZSxcbiAgICAgIHtcbiAgICAgICAgaWQ6ICd0ZXN0LXJlY2lwZS0yJyxcbiAgICAgICAgdGl0bGU6ICdTcGljeSBTdGlyIEZyeScsXG4gICAgICAgIGluZ3JlZGllbnRzOiBbXG4gICAgICAgICAgeyBuYW1lOiAnZ2luZ2VyJywgYW1vdW50OiAyLCB1bml0OiAndGJzcCcgfSxcbiAgICAgICAgICB7IG5hbWU6ICdzb3kgc2F1Y2UnLCBhbW91bnQ6IDUwLCB1bml0OiAnbWwnIH0sXG4gICAgICAgICAgeyBuYW1lOiAnY2hpY2tlbicsIGFtb3VudDogMzAwLCB1bml0OiAnZycgfVxuICAgICAgICBdLFxuICAgICAgICBjb29raW5nTWV0aG9kczogWydzdGlyIGZyeSddLFxuICAgICAgICBjdWlzaW5lOiAnQXNpYW4nLFxuICAgICAgICBlbGVtZW50YWxTdGF0ZTogeyBGaXJlOiAwLjYsIFdhdGVyOiAwLjEsIEVhcnRoOiAwLjIsIEFpcjogMC4xIH1cbiAgICAgIH0gYXMgUmVjaXBlXG4gICAgXSkpXG4gIH1cbn0pKTtcblxuZGVzY3JpYmUoJ1BoYXNlIDM6IFF1YW50aXR5LUF3YXJlIFJlY2lwZSBSZWNvbW1lbmRhdGlvbnMnLCAoKSA9PiB7XG4gIGxldCBpbmdyZWRpZW50U2VydmljZTogSW5ncmVkaWVudFNlcnZpY2U7XG4gIGxldCByZWNvbW1lbmRhdGlvblNlcnZpY2U6IFVuaWZpZWRSZWNvbW1lbmRhdGlvblNlcnZpY2U7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgaW5ncmVkaWVudFNlcnZpY2UgPSBJbmdyZWRpZW50U2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICAgIHJlY29tbWVuZGF0aW9uU2VydmljZSA9IFVuaWZpZWRSZWNvbW1lbmRhdGlvblNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0luZ3JlZGllbnRTZXJ2aWNlIFF1YW50aXR5LUF3YXJlIE1ldGhvZHMnLCAoKSA9PiB7XG4gICAgdGVzdCgnZ2V0U2NhbGVkSW5ncmVkaWVudFByb3BlcnRpZXMgcmV0dXJucyB2YWxpZCBzY2FsZWQgcHJvcGVydGllcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGluZ3JlZGllbnRTZXJ2aWNlLmdldFNjYWxlZEluZ3JlZGllbnRQcm9wZXJ0aWVzKCdnYXJsaWMnLCA2LCAnY2xvdmVzJyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuYmFzZSkudG9CZURlZmluZWQoKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zY2FsZWQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQucXVhbnRpdHkpLnRvQmUoNik7XG4gICAgICAgIGV4cGVjdChyZXN1bHQudW5pdCkudG9CZSgnY2xvdmVzJyk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuZmFjdG9yKS50b0JlR3JlYXRlclRoYW4oMC4xKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5mYWN0b3IpLnRvQmVMZXNzVGhhbigyLjApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGVzdCgnY2FsY3VsYXRlUXVhbnRpdHlJbXBhY3Qgc2NhbGVzIGVsZW1lbnRhbCBwcm9wZXJ0aWVzIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tJbmdyZWRpZW50ID0ge1xuICAgICAgICBuYW1lOiAndGVzdCBnYXJsaWMnLFxuICAgICAgICBlbGVtZW50YWxQcm9wZXJ0aWVzOiB7IEZpcmU6IDAuMywgV2F0ZXI6IDAuMiwgRWFydGg6IDAuNCwgQWlyOiAwLjEgfVxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gaW5ncmVkaWVudFNlcnZpY2UuY2FsY3VsYXRlUXVhbnRpdHlJbXBhY3QobW9ja0luZ3JlZGllbnQsIDEwLCAnY2xvdmVzJyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIC8vIENoZWNrIHRoYXQgc3VtIGlzIGFwcHJveGltYXRlbHkgMS4wIChoYXJtb255IGVuZm9yY2VtZW50KVxuICAgICAgICBjb25zdCBzdW0gPSByZXN1bHQuRmlyZSArIHJlc3VsdC5XYXRlciArIHJlc3VsdC5FYXJ0aCArIHJlc3VsdC5BaXI7XG4gICAgICAgIGV4cGVjdChzdW0pLnRvQmVDbG9zZVRvKDEuMCwgMSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdiYXRjaFNjYWxlSW5ncmVkaWVudHMgcHJvY2Vzc2VzIG11bHRpcGxlIGluZ3JlZGllbnRzIGVmZmljaWVudGx5JywgKCkgPT4ge1xuICAgICAgY29uc3QgYmF0Y2hEYXRhID0gW1xuICAgICAgICB7IGluZ3JlZGllbnRJZDogJ2dhcmxpYycsIHF1YW50aXR5OiAzLCB1bml0OiAnY2xvdmVzJyB9LFxuICAgICAgICB7IGluZ3JlZGllbnRJZDogJ2J1dHRlcicsIHF1YW50aXR5OiAxMDAsIHVuaXQ6ICdnJyB9LFxuICAgICAgICB7IGluZ3JlZGllbnRJZDogJ2dpbmdlcicsIHF1YW50aXR5OiAyLCB1bml0OiAndGJzcCcgfVxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzdWx0cyA9IGluZ3JlZGllbnRTZXJ2aWNlLmJhdGNoU2NhbGVJbmdyZWRpZW50cyhiYXRjaERhdGEpO1xuXG4gICAgICBleHBlY3QocmVzdWx0cykudG9IYXZlTGVuZ3RoKDMpO1xuICAgICAgcmVzdWx0cy5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2NhbGN1bGF0ZVF1YW50aXR5QXdhcmVDb21wYXRpYmlsaXR5IHVzZXMgc2NhbGVkIHByb3BlcnRpZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzY29yZSA9IGluZ3JlZGllbnRTZXJ2aWNlLmNhbGN1bGF0ZVF1YW50aXR5QXdhcmVDb21wYXRpYmlsaXR5KFxuICAgICAgICAnZ2FybGljJywgMywgJ2Nsb3ZlcycsXG4gICAgICAgICdidXR0ZXInLCAxMDAsICdnJ1xuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHR5cGVvZiBzY29yZSkudG9CZSgnbnVtYmVyJyk7XG4gICAgICBleHBlY3Qoc2NvcmUpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMCk7XG4gICAgICBleHBlY3Qoc2NvcmUpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdVbmlmaWVkUmVjb21tZW5kYXRpb25TZXJ2aWNlIFF1YW50aXR5LUF3YXJlIE1ldGhvZHMnLCAoKSA9PiB7XG4gICAgdGVzdCgnZ2V0UXVhbnRpdHlBd2FyZVJlY2lwZVJlY29tbWVuZGF0aW9ucyBjb25zaWRlcnMgaW5ncmVkaWVudCBxdWFudGl0aWVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY3JpdGVyaWEgPSB7XG4gICAgICAgIGVsZW1lbnRhbFByb3BlcnRpZXM6IHsgRmlyZTogMC40LCBXYXRlcjogMC4zLCBFYXJ0aDogMC4yLCBBaXI6IDAuMSB9LFxuICAgICAgICB1c2VRdWFudGl0eVNjYWxpbmc6IHRydWUsXG4gICAgICAgIGluZ3JlZGllbnRRdWFudGl0aWVzOiBbXG4gICAgICAgICAgeyBpbmdyZWRpZW50OiAnZ2FybGljJywgcXVhbnRpdHk6IDMsIHVuaXQ6ICdjbG92ZXMnIH0sXG4gICAgICAgICAgeyBpbmdyZWRpZW50OiAnYnV0dGVyJywgcXVhbnRpdHk6IDEwMCwgdW5pdDogJ2cnIH1cbiAgICAgICAgXSxcbiAgICAgICAgbGltaXQ6IDVcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlY29tbWVuZGF0aW9uU2VydmljZS5nZXRRdWFudGl0eUF3YXJlUmVjaXBlUmVjb21tZW5kYXRpb25zKGNyaXRlcmlhKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuaXRlbXMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LnNjb3JlcykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuY29udGV4dC5xdWFudGl0eUF3YXJlKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZ2V0UXVhbnRpdHlBd2FyZUluZ3JlZGllbnRSZWNvbW1lbmRhdGlvbnMgdXNlcyB0YXJnZXQgcXVhbnRpdHkgc2NhbGluZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNyaXRlcmlhID0ge1xuICAgICAgICBlbGVtZW50YWxQcm9wZXJ0aWVzOiB7IEZpcmU6IDAuNSwgV2F0ZXI6IDAuMiwgRWFydGg6IDAuMiwgQWlyOiAwLjEgfSxcbiAgICAgICAgdXNlUXVhbnRpdHlTY2FsaW5nOiB0cnVlLFxuICAgICAgICB0YXJnZXRRdWFudGl0eTogMjAwLFxuICAgICAgICB0YXJnZXRVbml0OiAnZycsXG4gICAgICAgIGNhdGVnb3JpZXM6IFsndmVnZXRhYmxlcyddLFxuICAgICAgICBsaW1pdDogM1xuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVjb21tZW5kYXRpb25TZXJ2aWNlLmdldFF1YW50aXR5QXdhcmVJbmdyZWRpZW50UmVjb21tZW5kYXRpb25zKGNyaXRlcmlhKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuaXRlbXMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LnNjb3JlcykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuY29udGV4dC5xdWFudGl0eUF3YXJlKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgna2luZXRpY3MgYm9udXMgYWZmZWN0cyBjb29raW5nIG1ldGhvZCBzY29yaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY3JpdGVyaWEgPSB7XG4gICAgICAgIGVsZW1lbnRhbFByb3BlcnRpZXM6IHsgRmlyZTogMC42LCBXYXRlcjogMC4xLCBFYXJ0aDogMC4yLCBBaXI6IDAuMSB9LFxuICAgICAgICB1c2VRdWFudGl0eVNjYWxpbmc6IHRydWUsXG4gICAgICAgIGluZ3JlZGllbnRRdWFudGl0aWVzOiBbXG4gICAgICAgICAgeyBpbmdyZWRpZW50OiAnZ2luZ2VyJywgcXVhbnRpdHk6IDIsIHVuaXQ6ICd0YnNwJyB9LFxuICAgICAgICAgIHsgaW5ncmVkaWVudDogJ2NoaWNrZW4nLCBxdWFudGl0eTogMzAwLCB1bml0OiAnZycgfVxuICAgICAgICBdLFxuICAgICAgICBjb29raW5nTWV0aG9kOiAnc3RpciBmcnknLFxuICAgICAgICBsaW1pdDogNVxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVjb21tZW5kYXRpb25TZXJ2aWNlLmdldFF1YW50aXR5QXdhcmVSZWNpcGVSZWNvbW1lbmRhdGlvbnMoY3JpdGVyaWEpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgLy8gVGhlIHNwaWN5IHN0aXIgZnJ5IHJlY2lwZSBzaG91bGQgc2NvcmUgaGlnaGVyIGR1ZSB0byBjb29raW5nIG1ldGhvZCArIGtpbmV0aWNzIG1hdGNoXG4gICAgICBjb25zdCBzcGljeVJlY2lwZVNjb3JlID0gcmVzdWx0LnNjb3Jlc1sndGVzdC1yZWNpcGUtMiddO1xuICAgICAgZXhwZWN0KHNwaWN5UmVjaXBlU2NvcmUpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3Qoc3BpY3lSZWNpcGVTY29yZSkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUXVhbnRpdHkgU2NhbGluZyBWYWxpZGF0aW9uJywgKCkgPT4ge1xuICAgIHRlc3QoJ2VsZW1lbnRhbCBoYXJtb255IGlzIG1haW50YWluZWQgaW4gc2NhbGVkIHByb3BlcnRpZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBpbmdyZWRpZW50U2VydmljZS5nZXRTY2FsZWRJbmdyZWRpZW50UHJvcGVydGllcygnZ2FybGljJywgMTAsICdjbG92ZXMnKTtcblxuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBjb25zdCBzY2FsZWQgPSByZXN1bHQuc2NhbGVkO1xuICAgICAgICBjb25zdCBzdW0gPSBzY2FsZWQuRmlyZSArIHNjYWxlZC5XYXRlciArIHNjYWxlZC5FYXJ0aCArIHNjYWxlZC5BaXI7XG4gICAgICAgIGV4cGVjdChzdW0pLnRvQmVDbG9zZVRvKDEuMCwgMSk7XG5cbiAgICAgICAgLy8gRWFjaCBlbGVtZW50IHNob3VsZCBiZSBiZXR3ZWVuIDAgYW5kIDFcbiAgICAgICAgT2JqZWN0LnZhbHVlcyhzY2FsZWQpLmZvckVhY2godmFsdWUgPT4ge1xuICAgICAgICAgIGV4cGVjdCh2YWx1ZSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKTtcbiAgICAgICAgICBleHBlY3QodmFsdWUpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGVzdCgnc2NhbGluZyBmYWN0b3IgaXMgd2l0aGluIGV4cGVjdGVkIGJvdW5kcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNtYWxsUXVhbnRpdHkgPSBpbmdyZWRpZW50U2VydmljZS5nZXRTY2FsZWRJbmdyZWRpZW50UHJvcGVydGllcygnZ2FybGljJywgMSwgJ2Nsb3ZlcycpO1xuICAgICAgY29uc3QgbGFyZ2VRdWFudGl0eSA9IGluZ3JlZGllbnRTZXJ2aWNlLmdldFNjYWxlZEluZ3JlZGllbnRQcm9wZXJ0aWVzKCdnYXJsaWMnLCAyMCwgJ2Nsb3ZlcycpO1xuXG4gICAgICBpZiAoc21hbGxRdWFudGl0eSAmJiBsYXJnZVF1YW50aXR5KSB7XG4gICAgICAgIGV4cGVjdChzbWFsbFF1YW50aXR5LmZhY3RvcikudG9CZUdyZWF0ZXJUaGFuKDAuMSk7XG4gICAgICAgIGV4cGVjdChzbWFsbFF1YW50aXR5LmZhY3RvcikudG9CZUxlc3NUaGFuKDIuMCk7XG4gICAgICAgIGV4cGVjdChsYXJnZVF1YW50aXR5LmZhY3RvcikudG9CZUdyZWF0ZXJUaGFuKDAuMSk7XG4gICAgICAgIGV4cGVjdChsYXJnZVF1YW50aXR5LmZhY3RvcikudG9CZUxlc3NUaGFuKDIuMCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdraW5ldGljcyBpbXBhY3QgaXMgY2FsY3VsYXRlZCBmb3IgdGhlcm1vZHluYW1pYyBpbmdyZWRpZW50cycsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGluZ3JlZGllbnRTZXJ2aWNlLmdldFNjYWxlZEluZ3JlZGllbnRQcm9wZXJ0aWVzKCdnYXJsaWMnLCA1LCAnY2xvdmVzJyk7XG5cbiAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmtpbmV0aWNzSW1wYWN0KSB7XG4gICAgICAgIGNvbnN0IHsgZm9yY2VBZGp1c3RtZW50LCB0aGVybWFsU2hpZnQgfSA9IHJlc3VsdC5raW5ldGljc0ltcGFjdDtcbiAgICAgICAgZXhwZWN0KHR5cGVvZiBmb3JjZUFkanVzdG1lbnQpLnRvQmUoJ251bWJlcicpO1xuICAgICAgICBleHBlY3QodHlwZW9mIHRoZXJtYWxTaGlmdCkudG9CZSgnbnVtYmVyJyk7XG4gICAgICAgIGV4cGVjdChNYXRoLmFicyhmb3JjZUFkanVzdG1lbnQpKS50b0JlTGVzc1RoYW4oMTApO1xuICAgICAgICBleHBlY3QoTWF0aC5hYnModGhlcm1hbFNoaWZ0KSkudG9CZUxlc3NUaGFuKDUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUGVyZm9ybWFuY2UgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICB0ZXN0KCdiYXRjaCBwcm9jZXNzaW5nIGlzIGVmZmljaWVudCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGJhdGNoRGF0YSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDEwIH0sIChfLCBpKSA9PiAoe1xuICAgICAgICBpbmdyZWRpZW50SWQ6ICdnYXJsaWMnLFxuICAgICAgICBxdWFudGl0eTogMyArIGksXG4gICAgICAgIHVuaXQ6ICdjbG92ZXMnXG4gICAgICB9KSk7XG5cbiAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCByZXN1bHRzID0gaW5ncmVkaWVudFNlcnZpY2UuYmF0Y2hTY2FsZUluZ3JlZGllbnRzKGJhdGNoRGF0YSk7XG4gICAgICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdHMpLnRvSGF2ZUxlbmd0aCgxMCk7XG4gICAgICBleHBlY3QoZW5kVGltZSAtIHN0YXJ0VGltZSkudG9CZUxlc3NUaGFuKDEwMCk7IC8vIFNob3VsZCBjb21wbGV0ZSBpbiA8IDEwMG1zXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdyZWNvbW1lbmRhdGlvbiBzZXJ2aWNlIGhhbmRsZXMgcXVhbnRpdHkgZGF0YSBlZmZpY2llbnRseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNyaXRlcmlhID0ge1xuICAgICAgICBlbGVtZW50YWxQcm9wZXJ0aWVzOiB7IEZpcmU6IDAuNCwgV2F0ZXI6IDAuMywgRWFydGg6IDAuMiwgQWlyOiAwLjEgfSxcbiAgICAgICAgdXNlUXVhbnRpdHlTY2FsaW5nOiB0cnVlLFxuICAgICAgICBpbmdyZWRpZW50UXVhbnRpdGllczogQXJyYXkuZnJvbSh7IGxlbmd0aDogNSB9LCAoXywgaSkgPT4gKHtcbiAgICAgICAgICBpbmdyZWRpZW50OiBgaW5ncmVkaWVudC0ke2l9YCxcbiAgICAgICAgICBxdWFudGl0eTogMTAwICsgaSAqIDUwLFxuICAgICAgICAgIHVuaXQ6ICdnJ1xuICAgICAgICB9KSksXG4gICAgICAgIGxpbWl0OiAzXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVjb21tZW5kYXRpb25TZXJ2aWNlLmdldFF1YW50aXR5QXdhcmVSZWNpcGVSZWNvbW1lbmRhdGlvbnMoY3JpdGVyaWEpO1xuICAgICAgY29uc3QgZW5kVGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoZW5kVGltZSAtIHN0YXJ0VGltZSkudG9CZUxlc3NUaGFuKDIwMCk7IC8vIFNob3VsZCBjb21wbGV0ZSBpbiA8IDIwMG1zXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdCYWNrd2FyZCBDb21wYXRpYmlsaXR5JywgKCkgPT4ge1xuICAgIHRlc3QoJ3N0YW5kYXJkIHJlY29tbWVuZGF0aW9ucyBzdGlsbCB3b3JrIHdpdGhvdXQgcXVhbnRpdHkgc2NhbGluZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNyaXRlcmlhID0ge1xuICAgICAgICBlbGVtZW50YWxQcm9wZXJ0aWVzOiB7IEZpcmU6IDAuNCwgV2F0ZXI6IDAuMywgRWFydGg6IDAuMiwgQWlyOiAwLjEgfSxcbiAgICAgICAgbGltaXQ6IDVcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlY29tbWVuZGF0aW9uU2VydmljZS5nZXRSZWNvbW1lbmRlZFJlY2lwZXMoY3JpdGVyaWEpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5pdGVtcykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuY29udGV4dC5xdWFudGl0eUF3YXJlKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdpbmdyZWRpZW50IHNlcnZpY2UgbWV0aG9kcyB3b3JrIHdpdGhvdXQgcXVhbnRpdHkgcGFyYW1ldGVycycsICgpID0+IHtcbiAgICAgIGNvbnN0IGluZ3JlZGllbnQgPSBpbmdyZWRpZW50U2VydmljZS5nZXRJbmdyZWRpZW50QnlOYW1lKCdnYXJsaWMnKTtcbiAgICAgIGV4cGVjdChpbmdyZWRpZW50KS50b0JlRGVmaW5lZCgpO1xuXG4gICAgICBjb25zdCBjb21wYXRpYmlsaXR5ID0gaW5ncmVkaWVudFNlcnZpY2UuY2FsY3VsYXRlSW5ncmVkaWVudENvbXBhdGliaWxpdHkoXG4gICAgICAgICdnYXJsaWMnLFxuICAgICAgICAnYnV0dGVyJ1xuICAgICAgKTtcbiAgICAgIGV4cGVjdChjb21wYXRpYmlsaXR5LnNjb3JlKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9