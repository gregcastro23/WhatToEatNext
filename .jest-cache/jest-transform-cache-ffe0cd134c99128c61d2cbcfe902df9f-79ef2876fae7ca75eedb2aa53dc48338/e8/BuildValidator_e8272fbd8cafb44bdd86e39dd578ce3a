bbcc859bfecc0bbc1d5401e310718912
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildValidator = exports.BuildValidator = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const child_process_1 = require("child_process");
/**
 * BuildValidator class for checking and repairing build artifacts
 * Implements requirements 3.1, 3.2, 3.3, 3.4, 3.5 from test system stabilization
 */
class BuildValidator {
    constructor(buildDir = '.next', logger = console.log) {
        this.buildDir = buildDir;
        this.serverDir = path_1.default.join(buildDir, 'server');
        this.logger = logger;
        // Required manifest files for Next.js build
        this.requiredManifests = [
            'pages-manifest.json',
            'app-paths-manifest.json',
            'next-font-manifest.json',
            'middleware-manifest.json'
        ];
    }
    /**
     * Validates the build artifacts and checks for required files
     * Requirement 3.2: Implement BuildValidator class to check for required build artifacts
     */
    async validateBuild() {
        const result = {
            isValid: true,
            missingFiles: [],
            corruptedFiles: [],
            repairActions: []
        };
        try {
            // Check if build directory exists
            if (!fs_1.default.existsSync(this.buildDir)) {
                result.isValid = false;
                result.missingFiles.push(this.buildDir);
                result.repairActions.push({
                    type: 'create',
                    target: this.buildDir,
                    description: 'Create build directory'
                });
                return result;
            }
            // Check if server directory exists
            if (!fs_1.default.existsSync(this.serverDir)) {
                result.isValid = false;
                result.missingFiles.push(this.serverDir);
                result.repairActions.push({
                    type: 'create',
                    target: this.serverDir,
                    description: 'Create server directory'
                });
            }
            // Check required manifest files
            for (const manifest of this.requiredManifests) {
                const manifestPath = path_1.default.join(this.serverDir, manifest);
                if (!fs_1.default.existsSync(manifestPath)) {
                    result.isValid = false;
                    result.missingFiles.push(manifestPath);
                    result.repairActions.push({
                        type: 'create',
                        target: manifestPath,
                        description: `Create missing manifest file: ${manifest}`
                    });
                }
                else {
                    // Check if file is corrupted (empty or invalid JSON)
                    try {
                        const content = fs_1.default.readFileSync(manifestPath, 'utf8');
                        if (content.trim() === '') {
                            result.corruptedFiles.push(manifestPath);
                            result.repairActions.push({
                                type: 'fix',
                                target: manifestPath,
                                description: `Fix empty manifest file: ${manifest}`
                            });
                        }
                        else if (manifest.endsWith('.json')) {
                            JSON.parse(content); // Validate JSON
                        }
                    }
                    catch (error) {
                        result.isValid = false;
                        result.corruptedFiles.push(manifestPath);
                        result.repairActions.push({
                            type: 'fix',
                            target: manifestPath,
                            description: `Fix corrupted manifest file: ${manifest}`
                        });
                    }
                }
            }
            // Check for essential build files
            const essentialFiles = [
                'build-manifest.json',
                'app-build-manifest.json',
                'react-loadable-manifest.json'
            ];
            for (const file of essentialFiles) {
                const filePath = path_1.default.join(this.buildDir, file);
                if (!fs_1.default.existsSync(filePath)) {
                    result.isValid = false;
                    result.missingFiles.push(filePath);
                    result.repairActions.push({
                        type: 'create',
                        target: filePath,
                        description: `Create missing build file: ${file}`
                    });
                }
            }
            this.logger(`Build validation completed. Valid: ${result.isValid}, Missing: ${result.missingFiles.length}, Corrupted: ${result.corruptedFiles.length}`);
        }
        catch (error) {
            this.logger('Build validation failed:', error);
            result.isValid = false;
        }
        return result;
    }
    /**
     * Repairs the build by creating missing manifest files with minimal content
     * Requirement 3.3: Create missing manifest files with minimal content when needed
     */
    async repairBuild() {
        const validation = await this.validateBuild();
        if (validation.isValid) {
            this.logger('Build is valid, no repairs needed');
            return;
        }
        this.logger(`Starting build repair. ${validation.repairActions.length} actions to perform.`);
        // Create directories if needed
        if (!fs_1.default.existsSync(this.buildDir)) {
            fs_1.default.mkdirSync(this.buildDir, { recursive: true });
            this.logger(`Created build directory: ${this.buildDir}`);
        }
        if (!fs_1.default.existsSync(this.serverDir)) {
            fs_1.default.mkdirSync(this.serverDir, { recursive: true });
            this.logger(`Created server directory: ${this.serverDir}`);
        }
        // Create missing manifest files with minimal content
        const manifestDefaults = this.getManifestDefaults();
        for (const action of validation.repairActions) {
            if (action.type === 'create' || action.type === 'fix') {
                const filename = path_1.default.basename(action.target);
                if (manifestDefaults[filename]) {
                    fs_1.default.writeFileSync(action.target, JSON.stringify(manifestDefaults[filename], null, 2));
                    this.logger(`${action.type === 'create' ? 'Created' : 'Fixed'} ${filename}`);
                }
            }
        }
        this.logger('Build repair completed');
    }
    /**
     * Attempts to rebuild the application with error recovery
     * Requirement 3.4: Add build error recovery and retry mechanisms
     */
    async rebuildWithRecovery(maxRetries = 3) {
        let attempt = 0;
        while (attempt < maxRetries) {
            attempt++;
            this.logger(`Build attempt ${attempt}/${maxRetries}`);
            try {
                // Clean build directory before retry
                if (attempt > 1) {
                    await this.cleanBuild();
                    await this.repairBuild();
                }
                // Attempt build
                (0, child_process_1.execSync)('yarn build', {
                    stdio: 'pipe',
                    timeout: 300000 // 5 minute timeout
                });
                // Validate build after completion
                const validation = await this.validateBuild();
                if (validation.isValid) {
                    this.logger(`Build successful on attempt ${attempt}`);
                    return true;
                }
                else {
                    this.logger(`Build completed but validation failed on attempt ${attempt}`);
                    await this.repairBuild();
                }
            }
            catch (error) {
                this.logger(`Build failed on attempt ${attempt}:`, error);
                if (attempt < maxRetries) {
                    this.logger(`Retrying build in 5 seconds...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }
        this.logger(`Build failed after ${maxRetries} attempts`);
        return false;
    }
    /**
     * Cleans the build directory
     */
    async cleanBuild() {
        try {
            if (fs_1.default.existsSync(this.buildDir)) {
                fs_1.default.rmSync(this.buildDir, { recursive: true, force: true });
                this.logger('Build directory cleaned');
            }
        }
        catch (error) {
            this.logger('Error cleaning build directory:', error);
        }
    }
    /**
     * Gets default content for manifest files
     * Requirement 3.3: Create missing manifest files with minimal content when needed
     */
    getManifestDefaults() {
        return {
            'pages-manifest.json': {},
            'app-paths-manifest.json': {},
            'next-font-manifest.json': {
                pages: {},
                app: {},
                appUsingSizeAdjust: false,
                pagesUsingSizeAdjust: false
            },
            'middleware-manifest.json': {
                sortedMiddleware: [],
                middleware: {},
                functions: {},
                version: 2
            },
            'build-manifest.json': {
                devFiles: [],
                ampDevFiles: [],
                polyfillFiles: [],
                lowPriorityFiles: [],
                rootMainFiles: [],
                pages: {},
                ampFirstPages: []
            },
            'app-build-manifest.json': {
                pages: {}
            },
            'react-loadable-manifest.json': {}
        };
    }
    /**
     * Checks if Next.js configuration is properly set up
     * Requirement 3.1: Fix Next.js configuration to properly generate manifest files
     */
    validateNextConfig() {
        const result = {
            isValid: true,
            issues: [],
            recommendations: []
        };
        try {
            // Check if next.config.js exists
            const configPaths = ['next.config.js', 'next.config.mjs', 'next.config.ts'];
            const existingConfig = configPaths.find(path => fs_1.default.existsSync(path));
            if (!existingConfig) {
                result.isValid = false;
                result.issues.push('No Next.js configuration file found');
                result.recommendations.push('Create next.config.js with proper build settings');
                return result;
            }
            // Read and validate configuration
            const configContent = fs_1.default.readFileSync(existingConfig, 'utf8');
            // Check for essential configuration options
            const essentialConfigs = [
                'output',
                'typescript',
                'eslint'
            ];
            for (const config of essentialConfigs) {
                if (!configContent.includes(config)) {
                    result.recommendations.push(`Consider adding ${config} configuration for better build stability`);
                }
            }
            // Check for build optimization settings
            if (!configContent.includes('webpack')) {
                result.recommendations.push('Consider adding webpack configuration for build optimization');
            }
            this.logger(`Next.js config validation completed. Valid: ${result.isValid}, Issues: ${result.issues.length}`);
        }
        catch (error) {
            result.isValid = false;
            result.issues.push(`Error reading Next.js configuration: ${error}`);
        }
        return result;
    }
    /**
     * Monitors build health and performance
     * Requirement 3.5: Add build error recovery and retry mechanisms
     */
    async monitorBuildHealth() {
        const report = {
            timestamp: new Date(),
            buildExists: fs_1.default.existsSync(this.buildDir),
            manifestsValid: false,
            buildSize: 0,
            lastBuildTime: null,
            issues: []
        };
        try {
            if (report.buildExists) {
                // Calculate build size
                report.buildSize = this.calculateDirectorySize(this.buildDir);
                // Check manifest validity
                const validation = await this.validateBuild();
                report.manifestsValid = validation.isValid;
                if (!validation.isValid) {
                    report.issues.push(...validation.missingFiles.map(file => `Missing: ${file}`));
                    report.issues.push(...validation.corruptedFiles.map(file => `Corrupted: ${file}`));
                }
                // Get last build time
                const buildManifestPath = path_1.default.join(this.buildDir, 'build-manifest.json');
                if (fs_1.default.existsSync(buildManifestPath)) {
                    const stats = fs_1.default.statSync(buildManifestPath);
                    report.lastBuildTime = stats.mtime;
                }
            }
            else {
                report.issues.push('Build directory does not exist');
            }
        }
        catch (error) {
            report.issues.push(`Health check error: ${error}`);
        }
        return report;
    }
    /**
     * Calculates directory size recursively
     */
    calculateDirectorySize(dirPath) {
        let size = 0;
        try {
            const files = fs_1.default.readdirSync(dirPath);
            for (const file of files) {
                const filePath = path_1.default.join(dirPath, file);
                const stats = fs_1.default.statSync(filePath);
                if (stats.isDirectory()) {
                    size += this.calculateDirectorySize(filePath);
                }
                else {
                    size += stats.size;
                }
            }
        }
        catch (error) {
            // Ignore errors for inaccessible files
        }
        return size;
    }
}
exports.BuildValidator = BuildValidator;
// Export default instance
exports.buildValidator = new BuildValidator();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy91dGlscy9CdWlsZFZhbGlkYXRvci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLGlEQUF5QztBQUV6Qzs7O0dBR0c7QUFDSCxNQUFhLGNBQWM7SUFNekIsWUFBWSxRQUFRLEdBQUcsT0FBTyxFQUFFLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRztRQUNsRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLDRDQUE0QztRQUM1QyxJQUFJLENBQUMsaUJBQWlCLEdBQUc7WUFDdkIscUJBQXFCO1lBQ3JCLHlCQUF5QjtZQUN6Qix5QkFBeUI7WUFDekIsMEJBQTBCO1NBQzNCLENBQUM7SUFDSixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLGFBQWE7UUFDakIsTUFBTSxNQUFNLEdBQTBCO1lBQ3BDLE9BQU8sRUFBRSxJQUFJO1lBQ2IsWUFBWSxFQUFFLEVBQUU7WUFDaEIsY0FBYyxFQUFFLEVBQUU7WUFDbEIsYUFBYSxFQUFFLEVBQUU7U0FDbEIsQ0FBQztRQUVGLElBQUk7WUFDRixrQ0FBa0M7WUFDbEMsSUFBSSxDQUFDLFlBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNqQyxNQUFNLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztnQkFDdkIsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN4QyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQztvQkFDeEIsSUFBSSxFQUFFLFFBQVE7b0JBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRO29CQUNy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LEVBQUU7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUMxQyxNQUFNLEtBQUssR0FBRyxZQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUVwQyxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRTtvQkFDdkIsSUFBSSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDL0M7cUJBQU07b0JBQ0wsSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUM7aUJBQ3BCO2FBQ0Y7U0FDRjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsdUNBQXVDO1NBQ3hDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUFwWUQsd0NBb1lDO0FBK0JELDBCQUEwQjtBQUNiLFFBQUEsY0FBYyxHQUFHLElBQUksY0FBYyxFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy91dGlscy9CdWlsZFZhbGlkYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuXG4vKipcbiAqIEJ1aWxkVmFsaWRhdG9yIGNsYXNzIGZvciBjaGVja2luZyBhbmQgcmVwYWlyaW5nIGJ1aWxkIGFydGlmYWN0c1xuICogSW1wbGVtZW50cyByZXF1aXJlbWVudHMgMy4xLCAzLjIsIDMuMywgMy40LCAzLjUgZnJvbSB0ZXN0IHN5c3RlbSBzdGFiaWxpemF0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBCdWlsZFZhbGlkYXRvciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgYnVpbGREaXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBzZXJ2ZXJEaXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSByZXF1aXJlZE1hbmlmZXN0czogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiAobWVzc2FnZTogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihidWlsZERpciA9ICcubmV4dCcsIGxvZ2dlciA9IGNvbnNvbGUubG9nKSB7XG4gICAgdGhpcy5idWlsZERpciA9IGJ1aWxkRGlyO1xuICAgIHRoaXMuc2VydmVyRGlyID0gcGF0aC5qb2luKGJ1aWxkRGlyLCAnc2VydmVyJyk7XG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG4gICAgXG4gICAgLy8gUmVxdWlyZWQgbWFuaWZlc3QgZmlsZXMgZm9yIE5leHQuanMgYnVpbGRcbiAgICB0aGlzLnJlcXVpcmVkTWFuaWZlc3RzID0gW1xuICAgICAgJ3BhZ2VzLW1hbmlmZXN0Lmpzb24nLFxuICAgICAgJ2FwcC1wYXRocy1tYW5pZmVzdC5qc29uJyxcbiAgICAgICduZXh0LWZvbnQtbWFuaWZlc3QuanNvbicsXG4gICAgICAnbWlkZGxld2FyZS1tYW5pZmVzdC5qc29uJ1xuICAgIF07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGVzIHRoZSBidWlsZCBhcnRpZmFjdHMgYW5kIGNoZWNrcyBmb3IgcmVxdWlyZWQgZmlsZXNcbiAgICogUmVxdWlyZW1lbnQgMy4yOiBJbXBsZW1lbnQgQnVpbGRWYWxpZGF0b3IgY2xhc3MgdG8gY2hlY2sgZm9yIHJlcXVpcmVkIGJ1aWxkIGFydGlmYWN0c1xuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVCdWlsZCgpOiBQcm9taXNlPEJ1aWxkVmFsaWRhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHJlc3VsdDogQnVpbGRWYWxpZGF0aW9uUmVzdWx0ID0ge1xuICAgICAgaXNWYWxpZDogdHJ1ZSxcbiAgICAgIG1pc3NpbmdGaWxlczogW10sXG4gICAgICBjb3JydXB0ZWRGaWxlczogW10sXG4gICAgICByZXBhaXJBY3Rpb25zOiBbXVxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgYnVpbGQgZGlyZWN0b3J5IGV4aXN0c1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHRoaXMuYnVpbGREaXIpKSB7XG4gICAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgIHJlc3VsdC5taXNzaW5nRmlsZXMucHVzaCh0aGlzLmJ1aWxkRGlyKTtcbiAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgdHlwZTogJ2NyZWF0ZScsXG4gICAgICAgICAgdGFyZ2V0OiB0aGlzLmJ1aWxkRGlyLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnQ3JlYXRlIGJ1aWxkIGRpcmVjdG9yeSdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIHNlcnZlciBkaXJlY3RvcnkgZXhpc3RzXG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmModGhpcy5zZXJ2ZXJEaXIpKSB7XG4gICAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgIHJlc3VsdC5taXNzaW5nRmlsZXMucHVzaCh0aGlzLnNlcnZlckRpcik7XG4gICAgICAgIHJlc3VsdC5yZXBhaXJBY3Rpb25zLnB1c2goe1xuICAgICAgICAgIHR5cGU6ICdjcmVhdGUnLFxuICAgICAgICAgIHRhcmdldDogdGhpcy5zZXJ2ZXJEaXIsXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdDcmVhdGUgc2VydmVyIGRpcmVjdG9yeSdcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHJlcXVpcmVkIG1hbmlmZXN0IGZpbGVzXG4gICAgICBmb3IgKGNvbnN0IG1hbmlmZXN0IG9mIHRoaXMucmVxdWlyZWRNYW5pZmVzdHMpIHtcbiAgICAgICAgY29uc3QgbWFuaWZlc3RQYXRoID0gcGF0aC5qb2luKHRoaXMuc2VydmVyRGlyLCBtYW5pZmVzdCk7XG4gICAgICAgIFxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMobWFuaWZlc3RQYXRoKSkge1xuICAgICAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgcmVzdWx0Lm1pc3NpbmdGaWxlcy5wdXNoKG1hbmlmZXN0UGF0aCk7XG4gICAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICB0eXBlOiAnY3JlYXRlJyxcbiAgICAgICAgICAgIHRhcmdldDogbWFuaWZlc3RQYXRoLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBDcmVhdGUgbWlzc2luZyBtYW5pZmVzdCBmaWxlOiAke21hbmlmZXN0fWBcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBDaGVjayBpZiBmaWxlIGlzIGNvcnJ1cHRlZCAoZW1wdHkgb3IgaW52YWxpZCBKU09OKVxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKG1hbmlmZXN0UGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgICAgIGlmIChjb250ZW50LnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgcmVzdWx0LmNvcnJ1cHRlZEZpbGVzLnB1c2gobWFuaWZlc3RQYXRoKTtcbiAgICAgICAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgdHlwZTogJ2ZpeCcsXG4gICAgICAgICAgICAgICAgdGFyZ2V0OiBtYW5pZmVzdFBhdGgsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGBGaXggZW1wdHkgbWFuaWZlc3QgZmlsZTogJHttYW5pZmVzdH1gXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChtYW5pZmVzdC5lbmRzV2l0aCgnLmpzb24nKSkge1xuICAgICAgICAgICAgICBKU09OLnBhcnNlKGNvbnRlbnQpOyAvLyBWYWxpZGF0ZSBKU09OXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICByZXN1bHQuY29ycnVwdGVkRmlsZXMucHVzaChtYW5pZmVzdFBhdGgpO1xuICAgICAgICAgICAgcmVzdWx0LnJlcGFpckFjdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgIHR5cGU6ICdmaXgnLFxuICAgICAgICAgICAgICB0YXJnZXQ6IG1hbmlmZXN0UGF0aCxcbiAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGBGaXggY29ycnVwdGVkIG1hbmlmZXN0IGZpbGU6ICR7bWFuaWZlc3R9YFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBlc3NlbnRpYWwgYnVpbGQgZmlsZXNcbiAgICAgIGNvbnN0IGVzc2VudGlhbEZpbGVzID0gW1xuICAgICAgICAnYnVpbGQtbWFuaWZlc3QuanNvbicsXG4gICAgICAgICdhcHAtYnVpbGQtbWFuaWZlc3QuanNvbicsXG4gICAgICAgICdyZWFjdC1sb2FkYWJsZS1tYW5pZmVzdC5qc29uJ1xuICAgICAgXTtcblxuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGVzc2VudGlhbEZpbGVzKSB7XG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKHRoaXMuYnVpbGREaXIsIGZpbGUpO1xuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgcmVzdWx0LmlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICByZXN1bHQubWlzc2luZ0ZpbGVzLnB1c2goZmlsZVBhdGgpO1xuICAgICAgICAgIHJlc3VsdC5yZXBhaXJBY3Rpb25zLnB1c2goe1xuICAgICAgICAgICAgdHlwZTogJ2NyZWF0ZScsXG4gICAgICAgICAgICB0YXJnZXQ6IGZpbGVQYXRoLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBDcmVhdGUgbWlzc2luZyBidWlsZCBmaWxlOiAke2ZpbGV9YFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyKGBCdWlsZCB2YWxpZGF0aW9uIGNvbXBsZXRlZC4gVmFsaWQ6ICR7cmVzdWx0LmlzVmFsaWR9LCBNaXNzaW5nOiAke3Jlc3VsdC5taXNzaW5nRmlsZXMubGVuZ3RofSwgQ29ycnVwdGVkOiAke3Jlc3VsdC5jb3JydXB0ZWRGaWxlcy5sZW5ndGh9YCk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIoJ0J1aWxkIHZhbGlkYXRpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJlc3VsdC5pc1ZhbGlkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXBhaXJzIHRoZSBidWlsZCBieSBjcmVhdGluZyBtaXNzaW5nIG1hbmlmZXN0IGZpbGVzIHdpdGggbWluaW1hbCBjb250ZW50XG4gICAqIFJlcXVpcmVtZW50IDMuMzogQ3JlYXRlIG1pc3NpbmcgbWFuaWZlc3QgZmlsZXMgd2l0aCBtaW5pbWFsIGNvbnRlbnQgd2hlbiBuZWVkZWRcbiAgICovXG4gIGFzeW5jIHJlcGFpckJ1aWxkKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnZhbGlkYXRlQnVpbGQoKTtcbiAgICBcbiAgICBpZiAodmFsaWRhdGlvbi5pc1ZhbGlkKSB7XG4gICAgICB0aGlzLmxvZ2dlcignQnVpbGQgaXMgdmFsaWQsIG5vIHJlcGFpcnMgbmVlZGVkJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5sb2dnZXIoYFN0YXJ0aW5nIGJ1aWxkIHJlcGFpci4gJHt2YWxpZGF0aW9uLnJlcGFpckFjdGlvbnMubGVuZ3RofSBhY3Rpb25zIHRvIHBlcmZvcm0uYCk7XG5cbiAgICAvLyBDcmVhdGUgZGlyZWN0b3JpZXMgaWYgbmVlZGVkXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHRoaXMuYnVpbGREaXIpKSB7XG4gICAgICBmcy5ta2RpclN5bmModGhpcy5idWlsZERpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICB0aGlzLmxvZ2dlcihgQ3JlYXRlZCBidWlsZCBkaXJlY3Rvcnk6ICR7dGhpcy5idWlsZERpcn1gKTtcbiAgICB9XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmModGhpcy5zZXJ2ZXJEaXIpKSB7XG4gICAgICBmcy5ta2RpclN5bmModGhpcy5zZXJ2ZXJEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgdGhpcy5sb2dnZXIoYENyZWF0ZWQgc2VydmVyIGRpcmVjdG9yeTogJHt0aGlzLnNlcnZlckRpcn1gKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgbWlzc2luZyBtYW5pZmVzdCBmaWxlcyB3aXRoIG1pbmltYWwgY29udGVudFxuICAgIGNvbnN0IG1hbmlmZXN0RGVmYXVsdHMgPSB0aGlzLmdldE1hbmlmZXN0RGVmYXVsdHMoKTtcblxuICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIHZhbGlkYXRpb24ucmVwYWlyQWN0aW9ucykge1xuICAgICAgaWYgKGFjdGlvbi50eXBlID09PSAnY3JlYXRlJyB8fCBhY3Rpb24udHlwZSA9PT0gJ2ZpeCcpIHtcbiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGFjdGlvbi50YXJnZXQpO1xuICAgICAgICBcbiAgICAgICAgaWYgKG1hbmlmZXN0RGVmYXVsdHNbZmlsZW5hbWVdKSB7XG4gICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhhY3Rpb24udGFyZ2V0LCBKU09OLnN0cmluZ2lmeShtYW5pZmVzdERlZmF1bHRzW2ZpbGVuYW1lXSwgbnVsbCwgMikpO1xuICAgICAgICAgIHRoaXMubG9nZ2VyKGAke2FjdGlvbi50eXBlID09PSAnY3JlYXRlJyA/ICdDcmVhdGVkJyA6ICdGaXhlZCd9ICR7ZmlsZW5hbWV9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlcignQnVpbGQgcmVwYWlyIGNvbXBsZXRlZCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0dGVtcHRzIHRvIHJlYnVpbGQgdGhlIGFwcGxpY2F0aW9uIHdpdGggZXJyb3IgcmVjb3ZlcnlcbiAgICogUmVxdWlyZW1lbnQgMy40OiBBZGQgYnVpbGQgZXJyb3IgcmVjb3ZlcnkgYW5kIHJldHJ5IG1lY2hhbmlzbXNcbiAgICovXG4gIGFzeW5jIHJlYnVpbGRXaXRoUmVjb3ZlcnkobWF4UmV0cmllcyA9IDMpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsZXQgYXR0ZW1wdCA9IDA7XG4gICAgXG4gICAgd2hpbGUgKGF0dGVtcHQgPCBtYXhSZXRyaWVzKSB7XG4gICAgICBhdHRlbXB0Kys7XG4gICAgICB0aGlzLmxvZ2dlcihgQnVpbGQgYXR0ZW1wdCAke2F0dGVtcHR9LyR7bWF4UmV0cmllc31gKTtcbiAgICAgIFxuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gQ2xlYW4gYnVpbGQgZGlyZWN0b3J5IGJlZm9yZSByZXRyeVxuICAgICAgICBpZiAoYXR0ZW1wdCA+IDEpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmNsZWFuQnVpbGQoKTtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlcGFpckJ1aWxkKCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBdHRlbXB0IGJ1aWxkXG4gICAgICAgIGV4ZWNTeW5jKCd5YXJuIGJ1aWxkJywgeyBcbiAgICAgICAgICBzdGRpbzogJ3BpcGUnLFxuICAgICAgICAgIHRpbWVvdXQ6IDMwMDAwMCAvLyA1IG1pbnV0ZSB0aW1lb3V0XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gVmFsaWRhdGUgYnVpbGQgYWZ0ZXIgY29tcGxldGlvblxuICAgICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgdGhpcy52YWxpZGF0ZUJ1aWxkKCk7XG4gICAgICAgIGlmICh2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlcihgQnVpbGQgc3VjY2Vzc2Z1bCBvbiBhdHRlbXB0ICR7YXR0ZW1wdH1gKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlcihgQnVpbGQgY29tcGxldGVkIGJ1dCB2YWxpZGF0aW9uIGZhaWxlZCBvbiBhdHRlbXB0ICR7YXR0ZW1wdH1gKTtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlcGFpckJ1aWxkKCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlcihgQnVpbGQgZmFpbGVkIG9uIGF0dGVtcHQgJHthdHRlbXB0fTpgLCBlcnJvcik7XG4gICAgICAgIFxuICAgICAgICBpZiAoYXR0ZW1wdCA8IG1heFJldHJpZXMpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlcihgUmV0cnlpbmcgYnVpbGQgaW4gNSBzZWNvbmRzLi4uYCk7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICB0aGlzLmxvZ2dlcihgQnVpbGQgZmFpbGVkIGFmdGVyICR7bWF4UmV0cmllc30gYXR0ZW1wdHNgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW5zIHRoZSBidWlsZCBkaXJlY3RvcnlcbiAgICovXG4gIGFzeW5jIGNsZWFuQnVpbGQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKHRoaXMuYnVpbGREaXIpKSB7XG4gICAgICAgIGZzLnJtU3luYyh0aGlzLmJ1aWxkRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gICAgICAgIHRoaXMubG9nZ2VyKCdCdWlsZCBkaXJlY3RvcnkgY2xlYW5lZCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlcignRXJyb3IgY2xlYW5pbmcgYnVpbGQgZGlyZWN0b3J5OicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBkZWZhdWx0IGNvbnRlbnQgZm9yIG1hbmlmZXN0IGZpbGVzXG4gICAqIFJlcXVpcmVtZW50IDMuMzogQ3JlYXRlIG1pc3NpbmcgbWFuaWZlc3QgZmlsZXMgd2l0aCBtaW5pbWFsIGNvbnRlbnQgd2hlbiBuZWVkZWRcbiAgICovXG4gIHByaXZhdGUgZ2V0TWFuaWZlc3REZWZhdWx0cygpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4ge1xuICAgICAgJ3BhZ2VzLW1hbmlmZXN0Lmpzb24nOiB7fSxcbiAgICAgICdhcHAtcGF0aHMtbWFuaWZlc3QuanNvbic6IHt9LFxuICAgICAgJ25leHQtZm9udC1tYW5pZmVzdC5qc29uJzoge1xuICAgICAgICBwYWdlczoge30sXG4gICAgICAgIGFwcDoge30sXG4gICAgICAgIGFwcFVzaW5nU2l6ZUFkanVzdDogZmFsc2UsXG4gICAgICAgIHBhZ2VzVXNpbmdTaXplQWRqdXN0OiBmYWxzZVxuICAgICAgfSxcbiAgICAgICdtaWRkbGV3YXJlLW1hbmlmZXN0Lmpzb24nOiB7XG4gICAgICAgIHNvcnRlZE1pZGRsZXdhcmU6IFtdLFxuICAgICAgICBtaWRkbGV3YXJlOiB7fSxcbiAgICAgICAgZnVuY3Rpb25zOiB7fSxcbiAgICAgICAgdmVyc2lvbjogMlxuICAgICAgfSxcbiAgICAgICdidWlsZC1tYW5pZmVzdC5qc29uJzoge1xuICAgICAgICBkZXZGaWxlczogW10sXG4gICAgICAgIGFtcERldkZpbGVzOiBbXSxcbiAgICAgICAgcG9seWZpbGxGaWxlczogW10sXG4gICAgICAgIGxvd1ByaW9yaXR5RmlsZXM6IFtdLFxuICAgICAgICByb290TWFpbkZpbGVzOiBbXSxcbiAgICAgICAgcGFnZXM6IHt9LFxuICAgICAgICBhbXBGaXJzdFBhZ2VzOiBbXVxuICAgICAgfSxcbiAgICAgICdhcHAtYnVpbGQtbWFuaWZlc3QuanNvbic6IHtcbiAgICAgICAgcGFnZXM6IHt9XG4gICAgICB9LFxuICAgICAgJ3JlYWN0LWxvYWRhYmxlLW1hbmlmZXN0Lmpzb24nOiB7fVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIE5leHQuanMgY29uZmlndXJhdGlvbiBpcyBwcm9wZXJseSBzZXQgdXBcbiAgICogUmVxdWlyZW1lbnQgMy4xOiBGaXggTmV4dC5qcyBjb25maWd1cmF0aW9uIHRvIHByb3Blcmx5IGdlbmVyYXRlIG1hbmlmZXN0IGZpbGVzXG4gICAqL1xuICB2YWxpZGF0ZU5leHRDb25maWcoKTogTmV4dENvbmZpZ1ZhbGlkYXRpb25SZXN1bHQge1xuICAgIGNvbnN0IHJlc3VsdDogTmV4dENvbmZpZ1ZhbGlkYXRpb25SZXN1bHQgPSB7XG4gICAgICBpc1ZhbGlkOiB0cnVlLFxuICAgICAgaXNzdWVzOiBbXSxcbiAgICAgIHJlY29tbWVuZGF0aW9uczogW11cbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIG5leHQuY29uZmlnLmpzIGV4aXN0c1xuICAgICAgY29uc3QgY29uZmlnUGF0aHMgPSBbJ25leHQuY29uZmlnLmpzJywgJ25leHQuY29uZmlnLm1qcycsICduZXh0LmNvbmZpZy50cyddO1xuICAgICAgY29uc3QgZXhpc3RpbmdDb25maWcgPSBjb25maWdQYXRocy5maW5kKHBhdGggPT4gZnMuZXhpc3RzU3luYyhwYXRoKSk7XG4gICAgICBcbiAgICAgIGlmICghZXhpc3RpbmdDb25maWcpIHtcbiAgICAgICAgcmVzdWx0LmlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgcmVzdWx0Lmlzc3Vlcy5wdXNoKCdObyBOZXh0LmpzIGNvbmZpZ3VyYXRpb24gZmlsZSBmb3VuZCcpO1xuICAgICAgICByZXN1bHQucmVjb21tZW5kYXRpb25zLnB1c2goJ0NyZWF0ZSBuZXh0LmNvbmZpZy5qcyB3aXRoIHByb3BlciBidWlsZCBzZXR0aW5ncycpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuXG4gICAgICAvLyBSZWFkIGFuZCB2YWxpZGF0ZSBjb25maWd1cmF0aW9uXG4gICAgICBjb25zdCBjb25maWdDb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGV4aXN0aW5nQ29uZmlnLCAndXRmOCcpO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBmb3IgZXNzZW50aWFsIGNvbmZpZ3VyYXRpb24gb3B0aW9uc1xuICAgICAgY29uc3QgZXNzZW50aWFsQ29uZmlncyA9IFtcbiAgICAgICAgJ291dHB1dCcsXG4gICAgICAgICd0eXBlc2NyaXB0JyxcbiAgICAgICAgJ2VzbGludCdcbiAgICAgIF07XG5cbiAgICAgIGZvciAoY29uc3QgY29uZmlnIG9mIGVzc2VudGlhbENvbmZpZ3MpIHtcbiAgICAgICAgaWYgKCFjb25maWdDb250ZW50LmluY2x1ZGVzKGNvbmZpZykpIHtcbiAgICAgICAgICByZXN1bHQucmVjb21tZW5kYXRpb25zLnB1c2goYENvbnNpZGVyIGFkZGluZyAke2NvbmZpZ30gY29uZmlndXJhdGlvbiBmb3IgYmV0dGVyIGJ1aWxkIHN0YWJpbGl0eWApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBidWlsZCBvcHRpbWl6YXRpb24gc2V0dGluZ3NcbiAgICAgIGlmICghY29uZmlnQ29udGVudC5pbmNsdWRlcygnd2VicGFjaycpKSB7XG4gICAgICAgIHJlc3VsdC5yZWNvbW1lbmRhdGlvbnMucHVzaCgnQ29uc2lkZXIgYWRkaW5nIHdlYnBhY2sgY29uZmlndXJhdGlvbiBmb3IgYnVpbGQgb3B0aW1pemF0aW9uJyk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyKGBOZXh0LmpzIGNvbmZpZyB2YWxpZGF0aW9uIGNvbXBsZXRlZC4gVmFsaWQ6ICR7cmVzdWx0LmlzVmFsaWR9LCBJc3N1ZXM6ICR7cmVzdWx0Lmlzc3Vlcy5sZW5ndGh9YCk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVzdWx0LmlzVmFsaWQgPSBmYWxzZTtcbiAgICAgIHJlc3VsdC5pc3N1ZXMucHVzaChgRXJyb3IgcmVhZGluZyBOZXh0LmpzIGNvbmZpZ3VyYXRpb246ICR7ZXJyb3J9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBNb25pdG9ycyBidWlsZCBoZWFsdGggYW5kIHBlcmZvcm1hbmNlXG4gICAqIFJlcXVpcmVtZW50IDMuNTogQWRkIGJ1aWxkIGVycm9yIHJlY292ZXJ5IGFuZCByZXRyeSBtZWNoYW5pc21zXG4gICAqL1xuICBhc3luYyBtb25pdG9yQnVpbGRIZWFsdGgoKTogUHJvbWlzZTxCdWlsZEhlYWx0aFJlcG9ydD4ge1xuICAgIGNvbnN0IHJlcG9ydDogQnVpbGRIZWFsdGhSZXBvcnQgPSB7XG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBidWlsZEV4aXN0czogZnMuZXhpc3RzU3luYyh0aGlzLmJ1aWxkRGlyKSxcbiAgICAgIG1hbmlmZXN0c1ZhbGlkOiBmYWxzZSxcbiAgICAgIGJ1aWxkU2l6ZTogMCxcbiAgICAgIGxhc3RCdWlsZFRpbWU6IG51bGwsXG4gICAgICBpc3N1ZXM6IFtdXG4gICAgfTtcblxuICAgIHRyeSB7XG4gICAgICBpZiAocmVwb3J0LmJ1aWxkRXhpc3RzKSB7XG4gICAgICAgIC8vIENhbGN1bGF0ZSBidWlsZCBzaXplXG4gICAgICAgIHJlcG9ydC5idWlsZFNpemUgPSB0aGlzLmNhbGN1bGF0ZURpcmVjdG9yeVNpemUodGhpcy5idWlsZERpcik7XG4gICAgICAgIFxuICAgICAgICAvLyBDaGVjayBtYW5pZmVzdCB2YWxpZGl0eVxuICAgICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgdGhpcy52YWxpZGF0ZUJ1aWxkKCk7XG4gICAgICAgIHJlcG9ydC5tYW5pZmVzdHNWYWxpZCA9IHZhbGlkYXRpb24uaXNWYWxpZDtcbiAgICAgICAgXG4gICAgICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7XG4gICAgICAgICAgcmVwb3J0Lmlzc3Vlcy5wdXNoKC4uLnZhbGlkYXRpb24ubWlzc2luZ0ZpbGVzLm1hcChmaWxlID0+IGBNaXNzaW5nOiAke2ZpbGV9YCkpO1xuICAgICAgICAgIHJlcG9ydC5pc3N1ZXMucHVzaCguLi52YWxpZGF0aW9uLmNvcnJ1cHRlZEZpbGVzLm1hcChmaWxlID0+IGBDb3JydXB0ZWQ6ICR7ZmlsZX1gKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZXQgbGFzdCBidWlsZCB0aW1lXG4gICAgICAgIGNvbnN0IGJ1aWxkTWFuaWZlc3RQYXRoID0gcGF0aC5qb2luKHRoaXMuYnVpbGREaXIsICdidWlsZC1tYW5pZmVzdC5qc29uJyk7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGJ1aWxkTWFuaWZlc3RQYXRoKSkge1xuICAgICAgICAgIGNvbnN0IHN0YXRzID0gZnMuc3RhdFN5bmMoYnVpbGRNYW5pZmVzdFBhdGgpO1xuICAgICAgICAgIHJlcG9ydC5sYXN0QnVpbGRUaW1lID0gc3RhdHMubXRpbWU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcG9ydC5pc3N1ZXMucHVzaCgnQnVpbGQgZGlyZWN0b3J5IGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgICB9XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVwb3J0Lmlzc3Vlcy5wdXNoKGBIZWFsdGggY2hlY2sgZXJyb3I6ICR7ZXJyb3J9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcG9ydDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGVzIGRpcmVjdG9yeSBzaXplIHJlY3Vyc2l2ZWx5XG4gICAqL1xuICBwcml2YXRlIGNhbGN1bGF0ZURpcmVjdG9yeVNpemUoZGlyUGF0aDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBsZXQgc2l6ZSA9IDA7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmMoZGlyUGF0aCk7XG4gICAgICBcbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihkaXJQYXRoLCBmaWxlKTtcbiAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5zdGF0U3luYyhmaWxlUGF0aCk7XG4gICAgICAgIFxuICAgICAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgIHNpemUgKz0gdGhpcy5jYWxjdWxhdGVEaXJlY3RvcnlTaXplKGZpbGVQYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzaXplICs9IHN0YXRzLnNpemU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWdub3JlIGVycm9ycyBmb3IgaW5hY2Nlc3NpYmxlIGZpbGVzXG4gICAgfVxuICAgIFxuICAgIHJldHVybiBzaXplO1xuICB9XG59XG5cbi8vIFR5cGUgZGVmaW5pdGlvbnNcbmV4cG9ydCBpbnRlcmZhY2UgQnVpbGRWYWxpZGF0aW9uUmVzdWx0IHtcbiAgaXNWYWxpZDogYm9vbGVhbjtcbiAgbWlzc2luZ0ZpbGVzOiBzdHJpbmdbXTtcbiAgY29ycnVwdGVkRmlsZXM6IHN0cmluZ1tdO1xuICByZXBhaXJBY3Rpb25zOiBSZXBhaXJBY3Rpb25bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZXBhaXJBY3Rpb24ge1xuICB0eXBlOiAnY3JlYXRlJyB8ICdmaXgnIHwgJ3JlbW92ZSc7XG4gIHRhcmdldDogc3RyaW5nO1xuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRDb25maWdWYWxpZGF0aW9uUmVzdWx0IHtcbiAgaXNWYWxpZDogYm9vbGVhbjtcbiAgaXNzdWVzOiBzdHJpbmdbXTtcbiAgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCdWlsZEhlYWx0aFJlcG9ydCB7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgYnVpbGRFeGlzdHM6IGJvb2xlYW47XG4gIG1hbmlmZXN0c1ZhbGlkOiBib29sZWFuO1xuICBidWlsZFNpemU6IG51bWJlcjtcbiAgbGFzdEJ1aWxkVGltZTogRGF0ZSB8IG51bGw7XG4gIGlzc3Vlczogc3RyaW5nW107XG59XG5cbi8vIEV4cG9ydCBkZWZhdWx0IGluc3RhbmNlXG5leHBvcnQgY29uc3QgYnVpbGRWYWxpZGF0b3IgPSBuZXcgQnVpbGRWYWxpZGF0b3IoKTsiXSwidmVyc2lvbiI6M30=