56c8ff343878521620eab22d6d2494d2
"use strict";
/**
 * Test Utilities for Enhanced Error Handling and Timeout Management
 *
 * Provides utilities for test suite optimization and stabilization
 * including proper error handling, timeout management, and result validation.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.MEMORY_LIMITS = exports.TEST_TIMEOUTS = exports.TestUtils = void 0;
const child_process_1 = require("child_process");
class TestUtils {
    static DEFAULT_TIMEOUT = 30000; // 30 seconds
    static DEFAULT_RETRIES = 2;
    static MEMORY_CHECK_INTERVAL = 100; // ms
    /**
     * Execute a command with enhanced error handling and timeout management
     */
    static async executeWithRetry(command, options = {}) {
        const { timeout = this.DEFAULT_TIMEOUT, retries = this.DEFAULT_RETRIES, expectedErrors = [], memoryLimit = 4096 * 1024 * 1024 // 4GB in bytes
         } = options;
        let lastError;
        let retryCount = 0;
        const startTime = Date.now();
        let peakMemoryUsage = 0;
        // Start memory monitoring
        const memoryMonitor = setInterval(() => {
            const currentMemory = process.memoryUsage().heapUsed;
            peakMemoryUsage = Math.max(peakMemoryUsage, currentMemory);
            if (currentMemory > memoryLimit) {
                console.warn(`Memory usage exceeded limit: ${currentMemory / 1024 / 1024}MB`);
            }
        }, this.MEMORY_CHECK_INTERVAL);
        try {
            for (let attempt = 0; attempt <= retries; attempt++) {
                retryCount = attempt;
                try {
                    const output = (0, child_process_1.execSync)(command, {
                        stdio: 'pipe',
                        timeout,
                        encoding: 'utf8',
                        env: { ...process.env, NODE_OPTIONS: '--max-old-space-size=4096' }
                    });
                    return {
                        success: true,
                        output,
                        executionTime: Date.now() - startTime,
                        memoryUsed: peakMemoryUsage,
                        retryCount
                    };
                }
                catch (error) {
                    lastError = error;
                    // Check if this is an expected error
                    const isExpectedError = expectedErrors.some(expectedError => lastError?.message.includes(expectedError));
                    if (isExpectedError) {
                        return {
                            success: true,
                            error: lastError,
                            executionTime: Date.now() - startTime,
                            memoryUsed: peakMemoryUsage,
                            retryCount
                        };
                    }
                    // If not the last attempt, wait before retrying
                    if (attempt < retries) {
                        await this.delay(1000 * (attempt + 1)); // Exponential backoff
                    }
                }
            }
            return {
                success: false,
                error: lastError,
                executionTime: Date.now() - startTime,
                memoryUsed: peakMemoryUsage,
                retryCount
            };
        }
        finally {
            clearInterval(memoryMonitor);
        }
    }
    /**
     * Validate test results with comprehensive checking
     */
    static validateTestResult(result, expectations) {
        const issues = [];
        // Check execution time
        if (expectations.maxExecutionTime && result.executionTime > expectations.maxExecutionTime) {
            issues.push(`Execution time ${result.executionTime}ms exceeded limit ${expectations.maxExecutionTime}ms`);
        }
        // Check memory usage
        if (expectations.maxMemoryUsage && result.memoryUsed > expectations.maxMemoryUsage) {
            issues.push(`Memory usage ${result.memoryUsed / 1024 / 1024}MB exceeded limit ${expectations.maxMemoryUsage / 1024 / 1024}MB`);
        }
        // Check success expectation
        if (expectations.shouldSucceed !== undefined && result.success !== expectations.shouldSucceed) {
            issues.push(`Expected success: ${expectations.shouldSucceed}, got: ${result.success}`);
        }
        // Check expected output
        if (expectations.expectedOutput && result.output) {
            const missingOutput = expectations.expectedOutput.filter(expected => !result.output?.includes(expected));
            if (missingOutput.length > 0) {
                issues.push(`Missing expected output: ${missingOutput.join(', ')}`);
            }
        }
        return {
            isValid: issues.length === 0,
            issues
        };
    }
    /**
     * Create a timeout-safe test wrapper
     */
    static withTimeout(testFunction, timeoutMs, testName) {
        return new Promise((resolve, reject) => {
            const timeoutId = setTimeout(() => {
                reject(new Error(`Test "${testName}" timed out after ${timeoutMs}ms`));
            }, timeoutMs);
            testFunction()
                .then(result => {
                clearTimeout(timeoutId);
                resolve(result);
            })
                .catch(error => {
                clearTimeout(timeoutId);
                reject(error);
            });
        });
    }
    /**
     * Monitor real-time test execution with proper cleanup
     */
    static async monitorRealTimeTest(testFunction, options = {}) {
        const { maxDuration = 60000, // 1 minute
        memoryThreshold = 2048 * 1024 * 1024, // 2GB
        cleanupFunction } = options;
        const startTime = Date.now();
        const metrics = {
            startTime,
            endTime: 0,
            duration: 0,
            peakMemory: 0,
            averageMemory: 0,
            memoryReadings: []
        };
        const issues = [];
        // Memory monitoring
        const memoryMonitor = setInterval(() => {
            const currentMemory = process.memoryUsage().heapUsed;
            metrics.memoryReadings.push(currentMemory);
            metrics.peakMemory = Math.max(metrics.peakMemory, currentMemory);
            if (currentMemory > memoryThreshold) {
                issues.push(`Memory threshold exceeded: ${currentMemory / 1024 / 1024}MB`);
            }
        }, 100);
        // Duration monitoring
        const durationMonitor = setTimeout(() => {
            issues.push(`Test exceeded maximum duration: ${maxDuration}ms`);
        }, maxDuration);
        try {
            await testFunction();
            metrics.endTime = Date.now();
            metrics.duration = metrics.endTime - metrics.startTime;
            metrics.averageMemory = metrics.memoryReadings.reduce((a, b) => a + b, 0) / metrics.memoryReadings.length;
            return {
                success: issues.length === 0,
                metrics,
                issues
            };
        }
        catch (error) {
            issues.push(`Test execution failed: ${error}`);
            return {
                success: false,
                metrics,
                issues
            };
        }
        finally {
            clearInterval(memoryMonitor);
            clearTimeout(durationMonitor);
            if (cleanupFunction) {
                try {
                    cleanupFunction();
                }
                catch (cleanupError) {
                    issues.push(`Cleanup failed: ${cleanupError}`);
                }
            }
        }
    }
    /**
     * Validate test consistency across multiple runs
     */
    static async validateConsistency(testFunction, runs = 3, tolerancePercent = 20) {
        const results = [];
        for (let i = 0; i < runs; i++) {
            try {
                const result = await testFunction();
                results.push(result);
            }
            catch (error) {
                results.push({ error: error.message });
            }
        }
        // Calculate variance for numeric results
        const numericResults = results.filter(r => typeof r === 'number');
        let variance = 0;
        if (numericResults.length > 1) {
            const mean = numericResults.reduce((a, b) => a + b, 0) / numericResults.length;
            const squaredDiffs = numericResults.map(x => Math.pow(x - mean, 2));
            variance = Math.sqrt(squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length);
            variance = (variance / mean) * 100; // Convert to percentage
        }
        return {
            isConsistent: variance <= tolerancePercent,
            results,
            variance
        };
    }
    /**
     * Utility function for delays
     */
    static delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    /**
     * Clean up test resources and force garbage collection
     */
    static cleanupTestResources() {
        // Force garbage collection if available
        if (global.gc) {
            global.gc();
        }
        // Clear any global test caches
        if (global.__TEST_CACHE__) {
            global.__TEST_CACHE__.clear();
        }
        // Reset process memory warnings
        process.removeAllListeners('warning');
    }
    /**
     * Create a test isolation wrapper
     */
    static isolateTest(testFunction, testName) {
        return async () => {
            const initialMemory = process.memoryUsage().heapUsed;
            try {
                const result = await testFunction();
                return result;
            }
            finally {
                // Cleanup after test
                this.cleanupTestResources();
                const finalMemory = process.memoryUsage().heapUsed;
                const memoryDiff = finalMemory - initialMemory;
                if (memoryDiff > 100 * 1024 * 1024) { // 100MB threshold
                    console.warn(`Test "${testName}" used ${memoryDiff / 1024 / 1024}MB of memory`);
                }
            }
        };
    }
}
exports.TestUtils = TestUtils;
/**
 * Test timeout constants for different test types
 */
exports.TEST_TIMEOUTS = {
    unit: 5000,
    integration: 15000,
    performance: 30000,
    memory: 20000,
    realtime: 10000 // 10 seconds for real-time monitoring tests
};
/**
 * Memory limits for different test scenarios
 */
exports.MEMORY_LIMITS = {
    unit: 256 * 1024 * 1024,
    integration: 512 * 1024 * 1024,
    performance: 1024 * 1024 * 1024,
    stress: 2048 * 1024 * 1024 // 2GB for stress tests
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvVGVzdFV0aWxzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBRUgsaURBQXlDO0FBa0J6QyxNQUFhLFNBQVM7SUFDWixNQUFNLENBQVUsZUFBZSxHQUFHLEtBQUssQ0FBQyxDQUFDLGFBQWE7SUFDdEQsTUFBTSxDQUFVLGVBQWUsR0FBRyxDQUFDLENBQUM7SUFDcEMsTUFBTSxDQUFVLHFCQUFxQixHQUFHLEdBQUcsQ0FBQyxDQUFDLEtBQUs7SUFFMUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUMzQixPQUFlLEVBQ2YsVUFBZ0MsRUFBRTtRQUVsQyxNQUFNLEVBQ0osT0FBTyxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQzlCLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxFQUM5QixjQUFjLEdBQUcsRUFBRSxFQUNuQixXQUFXLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZTtVQUNqRCxHQUFHLE9BQU8sQ0FBQztRQUVaLElBQUksU0FBNEIsQ0FBQztRQUNqQyxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDbkIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzdCLElBQUksZUFBZSxHQUFHLENBQUMsQ0FBQztRQUV4QiwwQkFBMEI7UUFDMUIsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUNyQyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDO1lBQ3JELGVBQWUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUUzRCxJQUFJLGFBQWEsR0FBRyxXQUFXLEVBQUU7Z0JBQy9CLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLGFBQWEsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJ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QUFvQixFQUFFLENBQUM7Z0JBRTVCLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBQ25ELE1BQU0sVUFBVSxHQUFHLFdBQVcsR0FBRyxhQUFhLENBQUM7Z0JBRS9DLElBQUksVUFBVSxHQUFHLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSSxFQUFFLEVBQUUsa0JBQWtCO29CQUN0RCxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsUUFBUSxVQUFVLFVBQVUsR0FBRyxJQUFJLEdBQUcsSUFBSSxjQUFjLENBQUMsQ0FBQztpQkFDakY7YUFDRjtRQUNILENBQUMsQ0FBQztJQUNKLENBQUM7O0FBcFVILDhCQXFVQztBQUVEOztHQUVHO0FBQ1UsUUFBQSxhQUFhLEdBQUc7SUFDM0IsSUFBSSxFQUFFLElBQUk7SUFDVixXQUFXLEVBQUUsS0FBSztJQUNsQixXQUFXLEVBQUUsS0FBSztJQUNsQixNQUFNLEVBQUUsS0FBSztJQUNiLFFBQVEsRUFBRSxLQUFLLENBQUksNENBQTRDO0NBQ2hFLENBQUM7QUFFRjs7R0FFRztBQUNVLFFBQUEsYUFBYSxHQUFHO0lBQzNCLElBQUksRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUk7SUFDdkIsV0FBVyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtJQUM5QixXQUFXLEVBQUUsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJO0lBQy9CLE1BQU0sRUFBRSxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBSyx1QkFBdUI7Q0FDdkQsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL19fdGVzdHNfXy91dGlscy9UZXN0VXRpbHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUZXN0IFV0aWxpdGllcyBmb3IgRW5oYW5jZWQgRXJyb3IgSGFuZGxpbmcgYW5kIFRpbWVvdXQgTWFuYWdlbWVudFxuICpcbiAqIFByb3ZpZGVzIHV0aWxpdGllcyBmb3IgdGVzdCBzdWl0ZSBvcHRpbWl6YXRpb24gYW5kIHN0YWJpbGl6YXRpb25cbiAqIGluY2x1ZGluZyBwcm9wZXIgZXJyb3IgaGFuZGxpbmcsIHRpbWVvdXQgbWFuYWdlbWVudCwgYW5kIHJlc3VsdCB2YWxpZGF0aW9uLlxuICovXG5cbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGVzdEV4ZWN1dGlvbk9wdGlvbnMge1xuICB0aW1lb3V0PzogbnVtYmVyO1xuICByZXRyaWVzPzogbnVtYmVyO1xuICBleHBlY3RlZEVycm9ycz86IHN0cmluZ1tdO1xuICBtZW1vcnlMaW1pdD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUZXN0UmVzdWx0IHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgb3V0cHV0Pzogc3RyaW5nO1xuICBlcnJvcj86IEVycm9yO1xuICBleGVjdXRpb25UaW1lOiBudW1iZXI7XG4gIG1lbW9yeVVzZWQ6IG51bWJlcjtcbiAgcmV0cnlDb3VudDogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgVGVzdFV0aWxzIHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9USU1FT1VUID0gMzAwMDA7IC8vIDMwIHNlY29uZHNcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9SRVRSSUVTID0gMjtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgTUVNT1JZX0NIRUNLX0lOVEVSVkFMID0gMTAwOyAvLyBtc1xuXG4gIC8qKlxuICAgKiBFeGVjdXRlIGEgY29tbWFuZCB3aXRoIGVuaGFuY2VkIGVycm9yIGhhbmRsaW5nIGFuZCB0aW1lb3V0IG1hbmFnZW1lbnRcbiAgICovXG4gIHN0YXRpYyBhc3luYyBleGVjdXRlV2l0aFJldHJ5KFxuICAgIGNvbW1hbmQ6IHN0cmluZyxcbiAgICBvcHRpb25zOiBUZXN0RXhlY3V0aW9uT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8VGVzdFJlc3VsdD4ge1xuICAgIGNvbnN0IHtcbiAgICAgIHRpbWVvdXQgPSB0aGlzLkRFRkFVTFRfVElNRU9VVCxcbiAgICAgIHJldHJpZXMgPSB0aGlzLkRFRkFVTFRfUkVUUklFUyxcbiAgICAgIGV4cGVjdGVkRXJyb3JzID0gW10sXG4gICAgICBtZW1vcnlMaW1pdCA9IDQwOTYgKiAxMDI0ICogMTAyNCAvLyA0R0IgaW4gYnl0ZXNcbiAgICB9ID0gb3B0aW9ucztcblxuICAgIGxldCBsYXN0RXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkO1xuICAgIGxldCByZXRyeUNvdW50ID0gMDtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGxldCBwZWFrTWVtb3J5VXNhZ2UgPSAwO1xuXG4gICAgLy8gU3RhcnQgbWVtb3J5IG1vbml0b3JpbmdcbiAgICBjb25zdCBtZW1vcnlNb25pdG9yID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgY29uc3QgY3VycmVudE1lbW9yeSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZDtcbiAgICAgIHBlYWtNZW1vcnlVc2FnZSA9IE1hdGgubWF4KHBlYWtNZW1vcnlVc2FnZSwgY3VycmVudE1lbW9yeSk7XG5cbiAgICAgIGlmIChjdXJyZW50TWVtb3J5ID4gbWVtb3J5TGltaXQpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBNZW1vcnkgdXNhZ2UgZXhjZWVkZWQgbGltaXQ6ICR7Y3VycmVudE1lbW9yeSAvIDEwMjQgLyAxMDI0fU1CYCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5NRU1PUllfQ0hFQ0tfSU5URVJWQUwpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDw9IHJldHJpZXM7IGF0dGVtcHQrKykge1xuICAgICAgICByZXRyeUNvdW50ID0gYXR0ZW1wdDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IG91dHB1dCA9IGV4ZWNTeW5jKGNvbW1hbmQsIHtcbiAgICAgICAgICAgIHN0ZGlvOiAncGlwZScsXG4gICAgICAgICAgICB0aW1lb3V0LFxuICAgICAgICAgICAgZW5jb2Rpbmc6ICd1dGY4JyxcbiAgICAgICAgICAgIGVudjogeyAuLi5wcm9jZXNzLmVudiwgTk9ERV9PUFRJT05TOiAnLS1tYXgtb2xkLXNwYWNlLXNpemU9NDA5NicgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBvdXRwdXQsXG4gICAgICAgICAgICBleGVjdXRpb25UaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgICAgbWVtb3J5VXNlZDogcGVha01lbW9yeVVzYWdlLFxuICAgICAgICAgICAgcmV0cnlDb3VudFxuICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgbGFzdEVycm9yID0gZXJyb3IgYXMgRXJyb3I7XG5cbiAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGFuIGV4cGVjdGVkIGVycm9yXG4gICAgICAgICAgY29uc3QgaXNFeHBlY3RlZEVycm9yID0gZXhwZWN0ZWRFcnJvcnMuc29tZShleHBlY3RlZEVycm9yID0+XG4gICAgICAgICAgICBsYXN0RXJyb3I/Lm1lc3NhZ2UuaW5jbHVkZXMoZXhwZWN0ZWRFcnJvcilcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKGlzRXhwZWN0ZWRFcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgICAgZXJyb3I6IGxhc3RFcnJvcixcbiAgICAgICAgICAgICAgZXhlY3V0aW9uVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgICAgICAgbWVtb3J5VXNlZDogcGVha01lbW9yeVVzYWdlLFxuICAgICAgICAgICAgICByZXRyeUNvdW50XG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIElmIG5vdCB0aGUgbGFzdCBhdHRlbXB0LCB3YWl0IGJlZm9yZSByZXRyeWluZ1xuICAgICAgICAgIGlmIChhdHRlbXB0IDwgcmV0cmllcykge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZWxheSgxMDAwICogKGF0dGVtcHQgKyAxKSk7IC8vIEV4cG9uZW50aWFsIGJhY2tvZmZcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBsYXN0RXJyb3IsXG4gICAgICAgIGV4ZWN1dGlvblRpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIG1lbW9yeVVzZWQ6IHBlYWtNZW1vcnlVc2FnZSxcbiAgICAgICAgcmV0cnlDb3VudFxuICAgICAgfTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgY2xlYXJJbnRlcnZhbChtZW1vcnlNb25pdG9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgdGVzdCByZXN1bHRzIHdpdGggY29tcHJlaGVuc2l2ZSBjaGVja2luZ1xuICAgKi9cbiAgc3RhdGljIHZhbGlkYXRlVGVzdFJlc3VsdChcbiAgICByZXN1bHQ6IFRlc3RSZXN1bHQsXG4gICAgZXhwZWN0YXRpb25zOiB7XG4gICAgICBtYXhFeGVjdXRpb25UaW1lPzogbnVtYmVyO1xuICAgICAgbWF4TWVtb3J5VXNhZ2U/OiBudW1iZXI7XG4gICAgICBzaG91bGRTdWNjZWVkPzogYm9vbGVhbjtcbiAgICAgIGV4cGVjdGVkT3V0cHV0Pzogc3RyaW5nW107XG4gICAgfVxuICApOiB7IGlzVmFsaWQ6IGJvb2xlYW47IGlzc3Vlczogc3RyaW5nW10gfSB7XG4gICAgY29uc3QgaXNzdWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgZXhlY3V0aW9uIHRpbWVcbiAgICBpZiAoZXhwZWN0YXRpb25zLm1heEV4ZWN1dGlvblRpbWUgJiYgcmVzdWx0LmV4ZWN1dGlvblRpbWUgPiBleHBlY3RhdGlvbnMubWF4RXhlY3V0aW9uVGltZSkge1xuICAgICAgaXNzdWVzLnB1c2goYEV4ZWN1dGlvbiB0aW1lICR7cmVzdWx0LmV4ZWN1dGlvblRpbWV9bXMgZXhjZWVkZWQgbGltaXQgJHtleHBlY3RhdGlvbnMubWF4RXhlY3V0aW9uVGltZX1tc2ApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIG1lbW9yeSB1c2FnZVxuICAgIGlmIChleHBlY3RhdGlvbnMubWF4TWVtb3J5VXNhZ2UgJiYgcmVzdWx0Lm1lbW9yeVVzZWQgPiBleHBlY3RhdGlvbnMubWF4TWVtb3J5VXNhZ2UpIHtcbiAgICAgIGlzc3Vlcy5wdXNoKGBNZW1vcnkgdXNhZ2UgJHtyZXN1bHQubWVtb3J5VXNlZCAvIDEwMjQgLyAxMDI0fU1CIGV4Y2VlZGVkIGxpbWl0ICR7ZXhwZWN0YXRpb25zLm1heE1lbW9yeVVzYWdlIC8gMTAyNCAvIDEwMjR9TUJgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBzdWNjZXNzIGV4cGVjdGF0aW9uXG4gICAgaWYgKGV4cGVjdGF0aW9ucy5zaG91bGRTdWNjZWVkICE9PSB1bmRlZmluZWQgJiYgcmVzdWx0LnN1Y2Nlc3MgIT09IGV4cGVjdGF0aW9ucy5zaG91bGRTdWNjZWVkKSB7XG4gICAgICBpc3N1ZXMucHVzaChgRXhwZWN0ZWQgc3VjY2VzczogJHtleHBlY3RhdGlvbnMuc2hvdWxkU3VjY2VlZH0sIGdvdDogJHtyZXN1bHQuc3VjY2Vzc31gKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBleHBlY3RlZCBvdXRwdXRcbiAgICBpZiAoZXhwZWN0YXRpb25zLmV4cGVjdGVkT3V0cHV0ICYmIHJlc3VsdC5vdXRwdXQpIHtcbiAgICAgIGNvbnN0IG1pc3NpbmdPdXRwdXQgPSBleHBlY3RhdGlvbnMuZXhwZWN0ZWRPdXRwdXQuZmlsdGVyKGV4cGVjdGVkID0+XG4gICAgICAgICFyZXN1bHQub3V0cHV0Py5pbmNsdWRlcyhleHBlY3RlZClcbiAgICAgICk7XG4gICAgICBpZiAobWlzc2luZ091dHB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGlzc3Vlcy5wdXNoKGBNaXNzaW5nIGV4cGVjdGVkIG91dHB1dDogJHttaXNzaW5nT3V0cHV0LmpvaW4oJywgJyl9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzVmFsaWQ6IGlzc3Vlcy5sZW5ndGggPT09IDAsXG4gICAgICBpc3N1ZXNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIHRpbWVvdXQtc2FmZSB0ZXN0IHdyYXBwZXJcbiAgICovXG4gIHN0YXRpYyB3aXRoVGltZW91dDxUPihcbiAgICB0ZXN0RnVuY3Rpb246ICgpID0+IFByb21pc2U8VD4sXG4gICAgdGltZW91dE1zOiBudW1iZXIsXG4gICAgdGVzdE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPFQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFRlc3QgXCIke3Rlc3ROYW1lfVwiIHRpbWVkIG91dCBhZnRlciAke3RpbWVvdXRNc31tc2ApKTtcbiAgICAgIH0sIHRpbWVvdXRNcyk7XG5cbiAgICAgIHRlc3RGdW5jdGlvbigpXG4gICAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIE1vbml0b3IgcmVhbC10aW1lIHRlc3QgZXhlY3V0aW9uIHdpdGggcHJvcGVyIGNsZWFudXBcbiAgICovXG4gIHN0YXRpYyBhc3luYyBtb25pdG9yUmVhbFRpbWVUZXN0KFxuICAgIHRlc3RGdW5jdGlvbjogKCkgPT4gUHJvbWlzZTx2b2lkPixcbiAgICBvcHRpb25zOiB7XG4gICAgICBtYXhEdXJhdGlvbj86IG51bWJlcjtcbiAgICAgIG1lbW9yeVRocmVzaG9sZD86IG51bWJlcjtcbiAgICAgIGNsZWFudXBGdW5jdGlvbj86ICgpID0+IHZvaWQ7XG4gICAgfSA9IHt9XG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBtZXRyaWNzOiBhbnk7IGlzc3Vlczogc3RyaW5nW10gfT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIG1heER1cmF0aW9uID0gNjAwMDAsIC8vIDEgbWludXRlXG4gICAgICBtZW1vcnlUaHJlc2hvbGQgPSAyMDQ4ICogMTAyNCAqIDEwMjQsIC8vIDJHQlxuICAgICAgY2xlYW51cEZ1bmN0aW9uXG4gICAgfSA9IG9wdGlvbnM7XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IG1ldHJpY3MgPSB7XG4gICAgICBzdGFydFRpbWUsXG4gICAgICBlbmRUaW1lOiAwLFxuICAgICAgZHVyYXRpb246IDAsXG4gICAgICBwZWFrTWVtb3J5OiAwLFxuICAgICAgYXZlcmFnZU1lbW9yeTogMCxcbiAgICAgIG1lbW9yeVJlYWRpbmdzOiBbXSBhcyBudW1iZXJbXVxuICAgIH07XG4gICAgY29uc3QgaXNzdWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gTWVtb3J5IG1vbml0b3JpbmdcbiAgICBjb25zdCBtZW1vcnlNb25pdG9yID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgY29uc3QgY3VycmVudE1lbW9yeSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZDtcbiAgICAgIG1ldHJpY3MubWVtb3J5UmVhZGluZ3MucHVzaChjdXJyZW50TWVtb3J5KTtcbiAgICAgIG1ldHJpY3MucGVha01lbW9yeSA9IE1hdGgubWF4KG1ldHJpY3MucGVha01lbW9yeSwgY3VycmVudE1lbW9yeSk7XG5cbiAgICAgIGlmIChjdXJyZW50TWVtb3J5ID4gbWVtb3J5VGhyZXNob2xkKSB7XG4gICAgICAgIGlzc3Vlcy5wdXNoKGBNZW1vcnkgdGhyZXNob2xkIGV4Y2VlZGVkOiAke2N1cnJlbnRNZW1vcnkgLyAxMDI0IC8gMTAyNH1NQmApO1xuICAgICAgfVxuICAgIH0sIDEwMCk7XG5cbiAgICAvLyBEdXJhdGlvbiBtb25pdG9yaW5nXG4gICAgY29uc3QgZHVyYXRpb25Nb25pdG9yID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpc3N1ZXMucHVzaChgVGVzdCBleGNlZWRlZCBtYXhpbXVtIGR1cmF0aW9uOiAke21heER1cmF0aW9ufW1zYCk7XG4gICAgfSwgbWF4RHVyYXRpb24pO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRlc3RGdW5jdGlvbigpO1xuXG4gICAgICBtZXRyaWNzLmVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgbWV0cmljcy5kdXJhdGlvbiA9IG1ldHJpY3MuZW5kVGltZSAtIG1ldHJpY3Muc3RhcnRUaW1lO1xuICAgICAgbWV0cmljcy5hdmVyYWdlTWVtb3J5ID0gbWV0cmljcy5tZW1vcnlSZWFkaW5ncy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG1ldHJpY3MubWVtb3J5UmVhZGluZ3MubGVuZ3RoO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBpc3N1ZXMubGVuZ3RoID09PSAwLFxuICAgICAgICBtZXRyaWNzLFxuICAgICAgICBpc3N1ZXNcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlzc3Vlcy5wdXNoKGBUZXN0IGV4ZWN1dGlvbiBmYWlsZWQ6ICR7ZXJyb3J9YCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWV0cmljcyxcbiAgICAgICAgaXNzdWVzXG4gICAgICB9O1xuICAgIH0gZmluYWxseSB7XG4gICAgICBjbGVhckludGVydmFsKG1lbW9yeU1vbml0b3IpO1xuICAgICAgY2xlYXJUaW1lb3V0KGR1cmF0aW9uTW9uaXRvcik7XG5cbiAgICAgIGlmIChjbGVhbnVwRnVuY3Rpb24pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjbGVhbnVwRnVuY3Rpb24oKTtcbiAgICAgICAgfSBjYXRjaCAoY2xlYW51cEVycm9yKSB7XG4gICAgICAgICAgaXNzdWVzLnB1c2goYENsZWFudXAgZmFpbGVkOiAke2NsZWFudXBFcnJvcn1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSB0ZXN0IGNvbnNpc3RlbmN5IGFjcm9zcyBtdWx0aXBsZSBydW5zXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgdmFsaWRhdGVDb25zaXN0ZW5jeShcbiAgICB0ZXN0RnVuY3Rpb246ICgpID0+IFByb21pc2U8YW55PixcbiAgICBydW5zOiBudW1iZXIgPSAzLFxuICAgIHRvbGVyYW5jZVBlcmNlbnQ6IG51bWJlciA9IDIwXG4gICk6IFByb21pc2U8eyBpc0NvbnNpc3RlbnQ6IGJvb2xlYW47IHJlc3VsdHM6IGFueVtdOyB2YXJpYW5jZTogbnVtYmVyIH0+IHtcbiAgICBjb25zdCByZXN1bHRzOiBhbnlbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBydW5zOyBpKyspIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRlc3RGdW5jdGlvbigpO1xuICAgICAgICByZXN1bHRzLnB1c2gocmVzdWx0KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlc3VsdHMucHVzaCh7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSB2YXJpYW5jZSBmb3IgbnVtZXJpYyByZXN1bHRzXG4gICAgY29uc3QgbnVtZXJpY1Jlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHR5cGVvZiByID09PSAnbnVtYmVyJyk7XG4gICAgbGV0IHZhcmlhbmNlID0gMDtcblxuICAgIGlmIChudW1lcmljUmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICBjb25zdCBtZWFuID0gbnVtZXJpY1Jlc3VsdHMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBudW1lcmljUmVzdWx0cy5sZW5ndGg7XG4gICAgICBjb25zdCBzcXVhcmVkRGlmZnMgPSBudW1lcmljUmVzdWx0cy5tYXAoeCA9PiBNYXRoLnBvdyh4IC0gbWVhbiwgMikpO1xuICAgICAgdmFyaWFuY2UgPSBNYXRoLnNxcnQoc3F1YXJlZERpZmZzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gc3F1YXJlZERpZmZzLmxlbmd0aCk7XG4gICAgICB2YXJpYW5jZSA9ICh2YXJpYW5jZSAvIG1lYW4pICogMTAwOyAvLyBDb252ZXJ0IHRvIHBlcmNlbnRhZ2VcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNDb25zaXN0ZW50OiB2YXJpYW5jZSA8PSB0b2xlcmFuY2VQZXJjZW50LFxuICAgICAgcmVzdWx0cyxcbiAgICAgIHZhcmlhbmNlXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciBkZWxheXNcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGRlbGF5KG1zOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4gdXAgdGVzdCByZXNvdXJjZXMgYW5kIGZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvblxuICAgKi9cbiAgc3RhdGljIGNsZWFudXBUZXN0UmVzb3VyY2VzKCk6IHZvaWQge1xuICAgIC8vIEZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbiBpZiBhdmFpbGFibGVcbiAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICBnbG9iYWwuZ2MoKTtcbiAgICB9XG5cbiAgICAvLyBDbGVhciBhbnkgZ2xvYmFsIHRlc3QgY2FjaGVzXG4gICAgaWYgKChnbG9iYWwgYXMgYW55KS5fX1RFU1RfQ0FDSEVfXykge1xuICAgICAgKGdsb2JhbCBhcyBhbnkpLl9fVEVTVF9DQUNIRV9fLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgLy8gUmVzZXQgcHJvY2VzcyBtZW1vcnkgd2FybmluZ3NcbiAgICBwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycygnd2FybmluZycpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIHRlc3QgaXNvbGF0aW9uIHdyYXBwZXJcbiAgICovXG4gIHN0YXRpYyBpc29sYXRlVGVzdDxUPihcbiAgICB0ZXN0RnVuY3Rpb246ICgpID0+IFByb21pc2U8VD4sXG4gICAgdGVzdE5hbWU6IHN0cmluZ1xuICApOiAoKSA9PiBQcm9taXNlPFQ+IHtcbiAgICByZXR1cm4gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW5pdGlhbE1lbW9yeSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZDtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGVzdEZ1bmN0aW9uKCk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICAvLyBDbGVhbnVwIGFmdGVyIHRlc3RcbiAgICAgICAgdGhpcy5jbGVhbnVwVGVzdFJlc291cmNlcygpO1xuXG4gICAgICAgIGNvbnN0IGZpbmFsTWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgICAgICBjb25zdCBtZW1vcnlEaWZmID0gZmluYWxNZW1vcnkgLSBpbml0aWFsTWVtb3J5O1xuXG4gICAgICAgIGlmIChtZW1vcnlEaWZmID4gMTAwICogMTAyNCAqIDEwMjQpIHsgLy8gMTAwTUIgdGhyZXNob2xkXG4gICAgICAgICAgY29uc29sZS53YXJuKGBUZXN0IFwiJHt0ZXN0TmFtZX1cIiB1c2VkICR7bWVtb3J5RGlmZiAvIDEwMjQgLyAxMDI0fU1CIG9mIG1lbW9yeWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIFRlc3QgdGltZW91dCBjb25zdGFudHMgZm9yIGRpZmZlcmVudCB0ZXN0IHR5cGVzXG4gKi9cbmV4cG9ydCBjb25zdCBURVNUX1RJTUVPVVRTID0ge1xuICB1bml0OiA1MDAwLCAgICAgICAgLy8gNSBzZWNvbmRzIGZvciB1bml0IHRlc3RzXG4gIGludGVncmF0aW9uOiAxNTAwMCwgLy8gMTUgc2Vjb25kcyBmb3IgaW50ZWdyYXRpb24gdGVzdHMgKHJlZHVjZWQgZnJvbSAzMHMpXG4gIHBlcmZvcm1hbmNlOiAzMDAwMCwgLy8gMzAgc2Vjb25kcyBmb3IgcGVyZm9ybWFuY2UgdGVzdHNcbiAgbWVtb3J5OiAyMDAwMCwgICAgIC8vIDIwIHNlY29uZHMgZm9yIG1lbW9yeSB0ZXN0c1xuICByZWFsdGltZTogMTAwMDAgICAgLy8gMTAgc2Vjb25kcyBmb3IgcmVhbC10aW1lIG1vbml0b3JpbmcgdGVzdHNcbn07XG5cbi8qKlxuICogTWVtb3J5IGxpbWl0cyBmb3IgZGlmZmVyZW50IHRlc3Qgc2NlbmFyaW9zXG4gKi9cbmV4cG9ydCBjb25zdCBNRU1PUllfTElNSVRTID0ge1xuICB1bml0OiAyNTYgKiAxMDI0ICogMTAyNCwgICAgICAvLyAyNTZNQiBmb3IgdW5pdCB0ZXN0c1xuICBpbnRlZ3JhdGlvbjogNTEyICogMTAyNCAqIDEwMjQsIC8vIDUxMk1CIGZvciBpbnRlZ3JhdGlvbiB0ZXN0c1xuICBwZXJmb3JtYW5jZTogMTAyNCAqIDEwMjQgKiAxMDI0LCAvLyAxR0IgZm9yIHBlcmZvcm1hbmNlIHRlc3RzXG4gIHN0cmVzczogMjA0OCAqIDEwMjQgKiAxMDI0ICAgICAvLyAyR0IgZm9yIHN0cmVzcyB0ZXN0c1xufTtcbiJdLCJ2ZXJzaW9uIjozfQ==