a80e48e3035b41c83efabc4afdae0db3
"use strict";
/**
 * Transit Date Validation Utilities
 *
 * Provides validation functions for planetary transit dates
 * to ensure accuracy in astrological calculations.
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSIT_CONSTANTS = exports.validatePlanetaryPosition = exports.loadPlanetTransitDates = exports.validateAllTransitDates = exports.validateRetrogradePhase = exports.getCurrentTransitSign = exports.validateTransitDate = void 0;
const logger_1 = require("@/utils/logger");
/**
 * Validate a single transit date against current date
 */
function validateTransitDate(planet, date, sign, transitDates) {
    try {
        if (!transitDates || !transitDates[sign]) {
            logger_1.logger.warn(`No transit data found for ${planet} in ${sign}`);
            return false;
        }
        const transit = transitDates[sign];
        if (!transit.Start || !transit.End) {
            logger_1.logger.warn(`Invalid transit data for ${planet} in ${sign}: missing Start or End date`);
            return false;
        }
        const startDate = new Date(transit.Start);
        const endDate = new Date(transit.End);
        // Validate date format
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            logger_1.logger.error(`Invalid date format in transit data for ${planet} in ${sign}`);
            return false;
        }
        // Check if current date falls within transit period
        const isValid = date >= startDate && date <= endDate;
        if (!isValid) {
            logger_1.logger.debug(`Date ${date.toISOString().split('T')[0]} is outside transit period for ${planet} in ${sign} (${transit.Start} to ${transit.End})`);
        }
        return isValid;
    }
    catch (error) {
        logger_1.logger.error(`Error validating transit date for ${planet}:`, error);
        return false;
    }
}
exports.validateTransitDate = validateTransitDate;
/**
 * Get current valid sign for a planet based on transit dates
 */
function getCurrentTransitSign(planet, date, transitDates) {
    try {
        const signs = Object.keys(transitDates).filter(key => key !== 'RetrogradePhases');
        for (const sign of signs) {
            if (validateTransitDate(planet, date, sign, transitDates)) {
                return sign;
            }
        }
        logger_1.logger.warn(`No valid transit sign found for ${planet} on ${date.toISOString().split('T')[0]}`);
        return null;
    }
    catch (error) {
        logger_1.logger.error(`Error getting current transit sign for ${planet}:`, error);
        return null;
    }
}
exports.getCurrentTransitSign = getCurrentTransitSign;
/**
 * Validate retrograde phase dates
 */
function validateRetrogradePhase(planet, date, transitDates) {
    try {
        if (!transitDates.RetrogradePhases) {
            return { isRetrograde: false };
        }
        const phases = Object.entries(transitDates.RetrogradePhases);
        for (const [phaseName, phaseData] of phases) {
            if (!phaseData.Start || !phaseData.End) {
                continue;
            }
            const startDate = new Date(phaseData.Start);
            const endDate = new Date(phaseData.End);
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                logger_1.logger.warn(`Invalid retrograde phase dates for ${planet} phase ${phaseName}`);
                continue;
            }
            if (date >= startDate && date <= endDate) {
                return { isRetrograde: true, phase: phaseName };
            }
        }
        return { isRetrograde: false };
    }
    catch (error) {
        logger_1.logger.error(`Error validating retrograde phase for ${planet}:`, error);
        return { isRetrograde: false };
    }
}
exports.validateRetrogradePhase = validateRetrogradePhase;
/**
 * Validate all transit dates for consistency
 */
function validateAllTransitDates(transitDates) {
    const errors = [];
    const warnings = [];
    try {
        const signs = Object.keys(transitDates).filter(key => key !== 'RetrogradePhases');
        // Check each sign's transit dates
        for (const sign of signs) {
            const transit = transitDates[sign];
            if (!transit.Start || !transit.End) {
                errors.push(`Missing Start or End date for sign ${sign}`);
                continue;
            }
            const startDate = new Date(transit.Start);
            const endDate = new Date(transit.Start);
            if (isNaN(startDate.getTime())) {
                errors.push(`Invalid Start date format for sign ${sign}: ${transit.Start}`);
            }
            if (isNaN(endDate.getTime())) {
                errors.push(`Invalid End date format for sign ${sign}: ${transit.End}`);
            }
            if (startDate >= endDate) {
                errors.push(`Start date must be before End date for sign ${sign}`);
            }
        }
        // Check for gaps or overlaps between signs
        const sortedTransits = signs
            .map(sign => ({
            sign,
            start: new Date(transitDates[sign].Start),
            end: new Date(transitDates[sign].End)
        }))
            .filter(t => !isNaN(t.start.getTime()) && !isNaN(t.end.getTime()))
            .sort((a, b) => a.start.getTime() - b.start.getTime());
        for (let i = 0; i < sortedTransits.length - 1; i++) {
            const current = sortedTransits[i];
            const next = sortedTransits[i + 1];
            // Check for gaps
            const daysBetween = (next.start.getTime() - current.end.getTime()) / (1000 * 60 * 60 * 24);
            if (daysBetween > 1) {
                warnings.push(`Gap of ${Math.round(daysBetween)} days between ${current.sign} and ${next.sign}`);
            }
            // Check for overlaps
            if (current.end > next.start) {
                warnings.push(`Overlap between ${current.sign} and ${next.sign}`);
            }
        }
        // Validate retrograde phases if present
        if (transitDates.RetrogradePhases) {
            const phases = Object.entries(transitDates.RetrogradePhases);
            for (const [phaseName, phaseData] of phases) {
                if (!phaseData.Start || !phaseData.End) {
                    warnings.push(`Missing Start or End date for retrograde phase ${phaseName}`);
                    continue;
                }
                const startDate = new Date(phaseData.Start);
                const endDate = new Date(phaseData.End);
                if (isNaN(startDate.getTime())) {
                    errors.push(`Invalid Start date format for retrograde phase ${phaseName}: ${phaseData.Start}`);
                }
                if (isNaN(endDate.getTime())) {
                    errors.push(`Invalid End date format for retrograde phase ${phaseName}: ${phaseData.End}`);
                }
                if (startDate >= endDate) {
                    errors.push(`Start date must be before End date for retrograde phase ${phaseName}`);
                }
            }
        }
        return {
            isValid: errors.length === 0,
            errors,
            warnings
        };
    }
    catch (error) {
        errors.push(`Validation error: ${error instanceof Error ? error.message : 'Unknown error'}`);
        return {
            isValid: false,
            errors,
            warnings
        };
    }
}
exports.validateAllTransitDates = validateAllTransitDates;
/**
 * Load and validate planet transit dates from data files
 */
async function loadPlanetTransitDates(planetName) {
    try {
        // Dynamic import to load planet data
        const planetModule = await Promise.resolve(`${`@/data/planets/${planetName.toLowerCase()}`}`).then(s => __importStar(require(s)));
        const planetData = planetModule.default;
        if (!planetData?.PlanetSpecific?.TransitDates) {
            logger_1.logger.warn(`No transit dates found for planet ${planetName}`);
            return null;
        }
        const transitDates = planetData.PlanetSpecific.TransitDates;
        const validation = validateAllTransitDates(transitDates);
        if (!validation.isValid) {
            logger_1.logger.error(`Invalid transit dates for ${planetName}:`, validation.errors);
            return null;
        }
        if (validation.warnings.length > 0) {
            logger_1.logger.warn(`Transit date warnings for ${planetName}:`, validation.warnings);
        }
        return transitDates;
    }
    catch (error) {
        logger_1.logger.error(`Error loading transit dates for ${planetName}:`, error);
        return null;
    }
}
exports.loadPlanetTransitDates = loadPlanetTransitDates;
/**
 * Validate planetary position against transit dates
 */
async function validatePlanetaryPosition(planetName, position, date = new Date()) {
    try {
        const transitDates = await loadPlanetTransitDates(planetName);
        if (!transitDates) {
            logger_1.logger.warn(`Cannot validate position for ${planetName}: no transit data available`);
            return false;
        }
        const isValid = validateTransitDate(planetName, date, position.sign, transitDates);
        if (!isValid) {
            logger_1.logger.warn(`Position validation failed for ${planetName}: ${position.sign} at ${position.degree}Â° on ${date.toISOString().split('T')[0]}`);
        }
        return isValid;
    }
    catch (error) {
        logger_1.logger.error(`Error validating planetary position for ${planetName}:`, error);
        return false;
    }
}
exports.validatePlanetaryPosition = validatePlanetaryPosition;
/**
 * Constants for transit validation
 */
exports.TRANSIT_CONSTANTS = {
    VALID_SIGNS: [
        'aries', 'taurus', 'gemini', 'cancer', 'leo', 'virgo',
        'libra', 'scorpio', 'sagittarius', 'capricorn', 'aquarius', 'pisces'
    ],
    DEGREES_PER_SIGN: 30,
    MAX_LONGITUDE: 360,
    DATE_FORMAT: 'YYYY-MM-DD',
    RETROGRADE_PLANETS: ['mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto'],
    ALWAYS_DIRECT: ['sun', 'moon'],
    ALWAYS_RETROGRADE: ['northNode', 'southNode']
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy91dGlscy9hc3Ryb2xvZ3kvdHJhbnNpdFZhbGlkYXRpb24udHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILDJDQUF3QztBQXFCeEM7O0dBRUc7QUFDSCxTQUFnQixtQkFBbUIsQ0FDakMsTUFBYyxFQUNkLElBQVUsRUFDVixJQUFZLEVBQ1osWUFBZ0M7SUFFaEMsSUFBSTtRQUNGLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEMsZUFBTSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsTUFBTSxPQUFPLElBQUksRUFBRSxDQUFDLENBQUM7WUFDOUQsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUU7WUFDbEMsZUFBTSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsTUFBTSxPQUFPLElBQUksNkJBQTZCLENBQUMsQ0FBQztZQUN4RixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFDLE1BQU0sT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV0Qyx1QkFBdUI7UUFDdkIsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFO1lBQzFELGVBQU0sQ0FBQyxLQUFLLENBQUMsMkNBQTJDLE1BQU0sT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzdFLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxv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TmV4dC9zcmMvdXRpbHMvYXN0cm9sb2d5L3RyYW5zaXRWYWxpZGF0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVHJhbnNpdCBEYXRlIFZhbGlkYXRpb24gVXRpbGl0aWVzXG4gKiBcbiAqIFByb3ZpZGVzIHZhbGlkYXRpb24gZnVuY3Rpb25zIGZvciBwbGFuZXRhcnkgdHJhbnNpdCBkYXRlc1xuICogdG8gZW5zdXJlIGFjY3VyYWN5IGluIGFzdHJvbG9naWNhbCBjYWxjdWxhdGlvbnMuXG4gKi9cblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnQC91dGlscy9sb2dnZXInO1xuXG4vKipcbiAqIFRyYW5zaXQgZGF0ZSBzdHJ1Y3R1cmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBUcmFuc2l0RGF0ZSB7XG4gIFN0YXJ0OiBzdHJpbmc7XG4gIEVuZDogc3RyaW5nO1xuICBQZWFrPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIFRyYW5zaXQgZGF0ZXMgc3RydWN0dXJlIGZvciBhIHBsYW5ldFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFBsYW5ldFRyYW5zaXREYXRlcyB7XG4gIFtzaWduOiBzdHJpbmddOiBUcmFuc2l0RGF0ZTtcbiAgUmV0cm9ncmFkZVBoYXNlcz86IHtcbiAgICBbcGhhc2U6IHN0cmluZ106IFRyYW5zaXREYXRlO1xuICB9O1xufVxuXG4vKipcbiAqIFZhbGlkYXRlIGEgc2luZ2xlIHRyYW5zaXQgZGF0ZSBhZ2FpbnN0IGN1cnJlbnQgZGF0ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVUcmFuc2l0RGF0ZShcbiAgcGxhbmV0OiBzdHJpbmcsXG4gIGRhdGU6IERhdGUsXG4gIHNpZ246IHN0cmluZyxcbiAgdHJhbnNpdERhdGVzOiBQbGFuZXRUcmFuc2l0RGF0ZXNcbik6IGJvb2xlYW4ge1xuICB0cnkge1xuICAgIGlmICghdHJhbnNpdERhdGVzIHx8ICF0cmFuc2l0RGF0ZXNbc2lnbl0pIHtcbiAgICAgIGxvZ2dlci53YXJuKGBObyB0cmFuc2l0IGRhdGEgZm91bmQgZm9yICR7cGxhbmV0fSBpbiAke3NpZ259YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgdHJhbnNpdCA9IHRyYW5zaXREYXRlc1tzaWduXTtcbiAgICBpZiAoIXRyYW5zaXQuU3RhcnQgfHwgIXRyYW5zaXQuRW5kKSB7XG4gICAgICBsb2dnZXIud2FybihgSW52YWxpZCB0cmFuc2l0IGRhdGEgZm9yICR7cGxhbmV0fSBpbiAke3NpZ259OiBtaXNzaW5nIFN0YXJ0IG9yIEVuZCBkYXRlYCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUodHJhbnNpdC5TdGFydCk7XG4gICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKHRyYW5zaXQuRW5kKTtcbiAgICBcbiAgICAvLyBWYWxpZGF0ZSBkYXRlIGZvcm1hdFxuICAgIGlmIChpc05hTihzdGFydERhdGUuZ2V0VGltZSgpKSB8fCBpc05hTihlbmREYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgSW52YWxpZCBkYXRlIGZvcm1hdCBpbiB0cmFuc2l0IGRhdGEgZm9yICR7cGxhbmV0fSBpbiAke3NpZ259YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgY3VycmVudCBkYXRlIGZhbGxzIHdpdGhpbiB0cmFuc2l0IHBlcmlvZFxuICAgIGNvbnN0IGlzVmFsaWQgPSBkYXRlID49IHN0YXJ0RGF0ZSAmJiBkYXRlIDw9IGVuZERhdGU7XG4gICAgXG4gICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYERhdGUgJHtkYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXX0gaXMgb3V0c2lkZSB0cmFuc2l0IHBlcmlvZCBmb3IgJHtwbGFuZXR9IGluICR7c2lnbn0gKCR7dHJhbnNpdC5TdGFydH0gdG8gJHt0cmFuc2l0LkVuZH0pYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlzVmFsaWQ7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBFcnJvciB2YWxpZGF0aW5nIHRyYW5zaXQgZGF0ZSBmb3IgJHtwbGFuZXR9OmAsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgY3VycmVudCB2YWxpZCBzaWduIGZvciBhIHBsYW5ldCBiYXNlZCBvbiB0cmFuc2l0IGRhdGVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDdXJyZW50VHJhbnNpdFNpZ24oXG4gIHBsYW5ldDogc3RyaW5nLFxuICBkYXRlOiBEYXRlLFxuICB0cmFuc2l0RGF0ZXM6IFBsYW5ldFRyYW5zaXREYXRlc1xuKTogc3RyaW5nIHwgbnVsbCB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc2lnbnMgPSBPYmplY3Qua2V5cyh0cmFuc2l0RGF0ZXMpLmZpbHRlcihrZXkgPT4ga2V5ICE9PSAnUmV0cm9ncmFkZVBoYXNlcycpO1xuICAgIFxuICAgIGZvciAoY29uc3Qgc2lnbiBvZiBzaWducykge1xuICAgICAgaWYgKHZhbGlkYXRlVHJhbnNpdERhdGUocGxhbmV0LCBkYXRlLCBzaWduLCB0cmFuc2l0RGF0ZXMpKSB7XG4gICAgICAgIHJldHVybiBzaWduO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBsb2dnZXIud2FybihgTm8gdmFsaWQgdHJhbnNpdCBzaWduIGZvdW5kIGZvciAke3BsYW5ldH0gb24gJHtkYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXX1gKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoYEVycm9yIGdldHRpbmcgY3VycmVudCB0cmFuc2l0IHNpZ24gZm9yICR7cGxhbmV0fTpgLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSByZXRyb2dyYWRlIHBoYXNlIGRhdGVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVJldHJvZ3JhZGVQaGFzZShcbiAgcGxhbmV0OiBzdHJpbmcsXG4gIGRhdGU6IERhdGUsXG4gIHRyYW5zaXREYXRlczogUGxhbmV0VHJhbnNpdERhdGVzXG4pOiB7IGlzUmV0cm9ncmFkZTogYm9vbGVhbjsgcGhhc2U/OiBzdHJpbmcgfSB7XG4gIHRyeSB7XG4gICAgaWYgKCF0cmFuc2l0RGF0ZXMuUmV0cm9ncmFkZVBoYXNlcykge1xuICAgICAgcmV0dXJuIHsgaXNSZXRyb2dyYWRlOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIGNvbnN0IHBoYXNlcyA9IE9iamVjdC5lbnRyaWVzKHRyYW5zaXREYXRlcy5SZXRyb2dyYWRlUGhhc2VzKTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IFtwaGFzZU5hbWUsIHBoYXNlRGF0YV0gb2YgcGhhc2VzKSB7XG4gICAgICBpZiAoIXBoYXNlRGF0YS5TdGFydCB8fCAhcGhhc2VEYXRhLkVuZCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUocGhhc2VEYXRhLlN0YXJ0KTtcbiAgICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShwaGFzZURhdGEuRW5kKTtcbiAgICAgIFxuICAgICAgaWYgKGlzTmFOKHN0YXJ0RGF0ZS5nZXRUaW1lKCkpIHx8IGlzTmFOKGVuZERhdGUuZ2V0VGltZSgpKSkge1xuICAgICAgICBsb2dnZXIud2FybihgSW52YWxpZCByZXRyb2dyYWRlIHBoYXNlIGRhdGVzIGZvciAke3BsYW5ldH0gcGhhc2UgJHtwaGFzZU5hbWV9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGF0ZSA+PSBzdGFydERhdGUgJiYgZGF0ZSA8PSBlbmREYXRlKSB7XG4gICAgICAgIHJldHVybiB7IGlzUmV0cm9ncmFkZTogdHJ1ZSwgcGhhc2U6IHBoYXNlTmFtZSB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IGlzUmV0cm9ncmFkZTogZmFsc2UgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoYEVycm9yIHZhbGlkYXRpbmcgcmV0cm9ncmFkZSBwaGFzZSBmb3IgJHtwbGFuZXR9OmAsIGVycm9yKTtcbiAgICByZXR1cm4geyBpc1JldHJvZ3JhZGU6IGZhbHNlIH07XG4gIH1cbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBhbGwgdHJhbnNpdCBkYXRlcyBmb3IgY29uc2lzdGVuY3lcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlQWxsVHJhbnNpdERhdGVzKHRyYW5zaXREYXRlczogUGxhbmV0VHJhbnNpdERhdGVzKToge1xuICBpc1ZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xuICB3YXJuaW5nczogc3RyaW5nW107XG59IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcblxuICB0cnkge1xuICAgIGNvbnN0IHNpZ25zID0gT2JqZWN0LmtleXModHJhbnNpdERhdGVzKS5maWx0ZXIoa2V5ID0+IGtleSAhPT0gJ1JldHJvZ3JhZGVQaGFzZXMnKTtcbiAgICBcbiAgICAvLyBDaGVjayBlYWNoIHNpZ24ncyB0cmFuc2l0IGRhdGVzXG4gICAgZm9yIChjb25zdCBzaWduIG9mIHNpZ25zKSB7XG4gICAgICBjb25zdCB0cmFuc2l0ID0gdHJhbnNpdERhdGVzW3NpZ25dO1xuICAgICAgXG4gICAgICBpZiAoIXRyYW5zaXQuU3RhcnQgfHwgIXRyYW5zaXQuRW5kKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGBNaXNzaW5nIFN0YXJ0IG9yIEVuZCBkYXRlIGZvciBzaWduICR7c2lnbn1gKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHRyYW5zaXQuU3RhcnQpO1xuICAgICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKHRyYW5zaXQuU3RhcnQpO1xuICAgICAgXG4gICAgICBpZiAoaXNOYU4oc3RhcnREYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYEludmFsaWQgU3RhcnQgZGF0ZSBmb3JtYXQgZm9yIHNpZ24gJHtzaWdufTogJHt0cmFuc2l0LlN0YXJ0fWApO1xuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoaXNOYU4oZW5kRGF0ZS5nZXRUaW1lKCkpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGBJbnZhbGlkIEVuZCBkYXRlIGZvcm1hdCBmb3Igc2lnbiAke3NpZ259OiAke3RyYW5zaXQuRW5kfWApO1xuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoc3RhcnREYXRlID49IGVuZERhdGUpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYFN0YXJ0IGRhdGUgbXVzdCBiZSBiZWZvcmUgRW5kIGRhdGUgZm9yIHNpZ24gJHtzaWdufWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBnYXBzIG9yIG92ZXJsYXBzIGJldHdlZW4gc2lnbnNcbiAgICBjb25zdCBzb3J0ZWRUcmFuc2l0cyA9IHNpZ25zXG4gICAgICAubWFwKHNpZ24gPT4gKHtcbiAgICAgICAgc2lnbixcbiAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKHRyYW5zaXREYXRlc1tzaWduXS5TdGFydCksXG4gICAgICAgIGVuZDogbmV3IERhdGUodHJhbnNpdERhdGVzW3NpZ25dLkVuZClcbiAgICAgIH0pKVxuICAgICAgLmZpbHRlcih0ID0+ICFpc05hTih0LnN0YXJ0LmdldFRpbWUoKSkgJiYgIWlzTmFOKHQuZW5kLmdldFRpbWUoKSkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYS5zdGFydC5nZXRUaW1lKCkgLSBiLnN0YXJ0LmdldFRpbWUoKSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRlZFRyYW5zaXRzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgY29uc3QgY3VycmVudCA9IHNvcnRlZFRyYW5zaXRzW2ldO1xuICAgICAgY29uc3QgbmV4dCA9IHNvcnRlZFRyYW5zaXRzW2kgKyAxXTtcbiAgICAgIFxuICAgICAgLy8gQ2hlY2sgZm9yIGdhcHNcbiAgICAgIGNvbnN0IGRheXNCZXR3ZWVuID0gKG5leHQuc3RhcnQuZ2V0VGltZSgpIC0gY3VycmVudC5lbmQuZ2V0VGltZSgpKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgICAgIGlmIChkYXlzQmV0d2VlbiA+IDEpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChgR2FwIG9mICR7TWF0aC5yb3VuZChkYXlzQmV0d2Vlbil9IGRheXMgYmV0d2VlbiAke2N1cnJlbnQuc2lnbn0gYW5kICR7bmV4dC5zaWdufWApO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDaGVjayBmb3Igb3ZlcmxhcHNcbiAgICAgIGlmIChjdXJyZW50LmVuZCA+IG5leHQuc3RhcnQpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaChgT3ZlcmxhcCBiZXR3ZWVuICR7Y3VycmVudC5zaWdufSBhbmQgJHtuZXh0LnNpZ259YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcmV0cm9ncmFkZSBwaGFzZXMgaWYgcHJlc2VudFxuICAgIGlmICh0cmFuc2l0RGF0ZXMuUmV0cm9ncmFkZVBoYXNlcykge1xuICAgICAgY29uc3QgcGhhc2VzID0gT2JqZWN0LmVudHJpZXModHJhbnNpdERhdGVzLlJldHJvZ3JhZGVQaGFzZXMpO1xuICAgICAgXG4gICAgICBmb3IgKGNvbnN0IFtwaGFzZU5hbWUsIHBoYXNlRGF0YV0gb2YgcGhhc2VzKSB7XG4gICAgICAgIGlmICghcGhhc2VEYXRhLlN0YXJ0IHx8ICFwaGFzZURhdGEuRW5kKSB7XG4gICAgICAgICAgd2FybmluZ3MucHVzaChgTWlzc2luZyBTdGFydCBvciBFbmQgZGF0ZSBmb3IgcmV0cm9ncmFkZSBwaGFzZSAke3BoYXNlTmFtZX1gKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHBoYXNlRGF0YS5TdGFydCk7XG4gICAgICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShwaGFzZURhdGEuRW5kKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChpc05hTihzdGFydERhdGUuZ2V0VGltZSgpKSkge1xuICAgICAgICAgIGVycm9ycy5wdXNoKGBJbnZhbGlkIFN0YXJ0IGRhdGUgZm9ybWF0IGZvciByZXRyb2dyYWRlIHBoYXNlICR7cGhhc2VOYW1lfTogJHtwaGFzZURhdGEuU3RhcnR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChpc05hTihlbmREYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaChgSW52YWxpZCBFbmQgZGF0ZSBmb3JtYXQgZm9yIHJldHJvZ3JhZGUgcGhhc2UgJHtwaGFzZU5hbWV9OiAke3BoYXNlRGF0YS5FbmR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChzdGFydERhdGUgPj0gZW5kRGF0ZSkge1xuICAgICAgICAgIGVycm9ycy5wdXNoKGBTdGFydCBkYXRlIG11c3QgYmUgYmVmb3JlIEVuZCBkYXRlIGZvciByZXRyb2dyYWRlIHBoYXNlICR7cGhhc2VOYW1lfWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzVmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsXG4gICAgICBlcnJvcnMsXG4gICAgICB3YXJuaW5nc1xuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgZXJyb3JzLnB1c2goYFZhbGlkYXRpb24gZXJyb3I6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgZXJyb3JzLFxuICAgICAgd2FybmluZ3NcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICogTG9hZCBhbmQgdmFsaWRhdGUgcGxhbmV0IHRyYW5zaXQgZGF0ZXMgZnJvbSBkYXRhIGZpbGVzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUGxhbmV0VHJhbnNpdERhdGVzKHBsYW5ldE5hbWU6IHN0cmluZyk6IFByb21pc2U8UGxhbmV0VHJhbnNpdERhdGVzIHwgbnVsbD4ge1xuICB0cnkge1xuICAgIC8vIER5bmFtaWMgaW1wb3J0IHRvIGxvYWQgcGxhbmV0IGRhdGFcbiAgICBjb25zdCBwbGFuZXRNb2R1bGUgPSBhd2FpdCBpbXBvcnQoYEAvZGF0YS9wbGFuZXRzLyR7cGxhbmV0TmFtZS50b0xvd2VyQ2FzZSgpfWApO1xuICAgIGNvbnN0IHBsYW5ldERhdGEgPSBwbGFuZXRNb2R1bGUuZGVmYXVsdDtcbiAgICBcbiAgICBpZiAoIXBsYW5ldERhdGE/LlBsYW5ldFNwZWNpZmljPy5UcmFuc2l0RGF0ZXMpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBObyB0cmFuc2l0IGRhdGVzIGZvdW5kIGZvciBwbGFuZXQgJHtwbGFuZXROYW1lfWApO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgdHJhbnNpdERhdGVzID0gcGxhbmV0RGF0YS5QbGFuZXRTcGVjaWZpYy5UcmFuc2l0RGF0ZXM7XG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHZhbGlkYXRlQWxsVHJhbnNpdERhdGVzKHRyYW5zaXREYXRlcyk7XG4gICAgXG4gICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgSW52YWxpZCB0cmFuc2l0IGRhdGVzIGZvciAke3BsYW5ldE5hbWV9OmAsIHZhbGlkYXRpb24uZXJyb3JzKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGlmICh2YWxpZGF0aW9uLndhcm5pbmdzLmxlbmd0aCA+IDApIHtcbiAgICAgIGxvZ2dlci53YXJuKGBUcmFuc2l0IGRhdGUgd2FybmluZ3MgZm9yICR7cGxhbmV0TmFtZX06YCwgdmFsaWRhdGlvbi53YXJuaW5ncyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRyYW5zaXREYXRlcztcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoYEVycm9yIGxvYWRpbmcgdHJhbnNpdCBkYXRlcyBmb3IgJHtwbGFuZXROYW1lfTpgLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBwbGFuZXRhcnkgcG9zaXRpb24gYWdhaW5zdCB0cmFuc2l0IGRhdGVzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVBsYW5ldGFyeVBvc2l0aW9uKFxuICBwbGFuZXROYW1lOiBzdHJpbmcsXG4gIHBvc2l0aW9uOiB7IHNpZ246IHN0cmluZzsgZGVncmVlOiBudW1iZXI7IGV4YWN0TG9uZ2l0dWRlOiBudW1iZXIgfSxcbiAgZGF0ZTogRGF0ZSA9IG5ldyBEYXRlKClcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGNvbnN0IHRyYW5zaXREYXRlcyA9IGF3YWl0IGxvYWRQbGFuZXRUcmFuc2l0RGF0ZXMocGxhbmV0TmFtZSk7XG4gICAgXG4gICAgaWYgKCF0cmFuc2l0RGF0ZXMpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBDYW5ub3QgdmFsaWRhdGUgcG9zaXRpb24gZm9yICR7cGxhbmV0TmFtZX06IG5vIHRyYW5zaXQgZGF0YSBhdmFpbGFibGVgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVUcmFuc2l0RGF0ZShwbGFuZXROYW1lLCBkYXRlLCBwb3NpdGlvbi5zaWduLCB0cmFuc2l0RGF0ZXMpO1xuICAgIFxuICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgbG9nZ2VyLndhcm4oYFBvc2l0aW9uIHZhbGlkYXRpb24gZmFpbGVkIGZvciAke3BsYW5ldE5hbWV9OiAke3Bvc2l0aW9uLnNpZ259IGF0ICR7cG9zaXRpb24uZGVncmVlfcKwIG9uICR7ZGF0ZS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF19YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGlzVmFsaWQ7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBFcnJvciB2YWxpZGF0aW5nIHBsYW5ldGFyeSBwb3NpdGlvbiBmb3IgJHtwbGFuZXROYW1lfTpgLCBlcnJvcik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbi8qKlxuICogQ29uc3RhbnRzIGZvciB0cmFuc2l0IHZhbGlkYXRpb25cbiAqL1xuZXhwb3J0IGNvbnN0IFRSQU5TSVRfQ09OU1RBTlRTID0ge1xuICBWQUxJRF9TSUdOUzogW1xuICAgICdhcmllcycsICd0YXVydXMnLCAnZ2VtaW5pJywgJ2NhbmNlcicsICdsZW8nLCAndmlyZ28nLFxuICAgICdsaWJyYScsICdzY29ycGlvJywgJ3NhZ2l0dGFyaXVzJywgJ2NhcHJpY29ybicsICdhcXVhcml1cycsICdwaXNjZXMnXG4gIF0sXG4gIERFR1JFRVNfUEVSX1NJR046IDMwLFxuICBNQVhfTE9OR0lUVURFOiAzNjAsXG4gIERBVEVfRk9STUFUOiAnWVlZWS1NTS1ERCcsXG4gIFJFVFJPR1JBREVfUExBTkVUUzogWydtZXJjdXJ5JywgJ3ZlbnVzJywgJ21hcnMnLCAnanVwaXRlcicsICdzYXR1cm4nLCAndXJhbnVzJywgJ25lcHR1bmUnLCAncGx1dG8nXSxcbiAgQUxXQVlTX0RJUkVDVDogWydzdW4nLCAnbW9vbiddLFxuICBBTFdBWVNfUkVUUk9HUkFERTogWydub3J0aE5vZGUnLCAnc291dGhOb2RlJ11cbn0gYXMgY29uc3Q7Il0sInZlcnNpb24iOjN9