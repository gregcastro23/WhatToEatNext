d7b93f46620b9de7788968b989c450a5
"use strict";
/**
 * Integration test for memory management system
 *
 * This test verifies that the memory management system integrates properly
 * with the existing test infrastructure and provides the expected functionality.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const TestMemoryMonitor_1 = require("../utils/TestMemoryMonitor");
const memoryTestHelpers_1 = require("../utils/memoryTestHelpers");
describe('Memory Management Integration', () => {
    it('should have reduced test timeout from 30s to 15s', () => {
        // Verify that integration test timeout is set to 15s
        expect(memoryTestHelpers_1.TEST_TIMEOUTS.integration).toBe(15000);
    });
    it('should have Jest configured with max 2 workers', () => {
        // This test verifies Jest configuration indirectly
        // The actual worker count is controlled by Jest configuration
        expect(true).toBe(true); // Placeholder - actual verification happens in Jest config
    });
    it('should have memory monitoring available globally', () => {
        expect(global.testUtils).toBeDefined();
        expect(global.testUtils.checkMemory).toBeDefined();
        expect(global.testUtils.cleanupMemory).toBeDefined();
        const memoryUsage = global.testUtils.checkMemory();
        expect(memoryUsage).toBeDefined();
        expect(memoryUsage.heapUsed).toMatch(/\d+\.\d+MB/);
    });
    it('should have garbage collection available', () => {
        if (global.forceGC) {
            const gcResult = global.forceGC();
            expect(typeof gcResult).toBe('boolean');
        }
        else {
            // If GC is not available, that's also acceptable
            expect(global.forceGC).toBeUndefined();
        }
    });
    (0, memoryTestHelpers_1.itWithMemoryCleanup)('should work with memory-safe test wrapper', async () => {
        // This test uses the memory-safe wrapper
        const initialMemory = process.memoryUsage().heapUsed;
        // Simulate some memory allocation
        const testData = new Array(1000).fill('test-data');
        const afterAllocation = process.memoryUsage().heapUsed;
        expect(afterAllocation).toBeGreaterThan(initialMemory);
        // Cleanup happens automatically via the wrapper
        testData.length = 0;
    });
    it('should track memory usage during test execution', () => {
        const monitor = new TestMemoryMonitor_1.TestMemoryMonitor();
        const initialSnapshot = monitor.takeSnapshot('integration-test-start');
        expect(initialSnapshot).toBeDefined();
        expect(initialSnapshot.heapUsed).toBeGreaterThan(0);
        // Simulate test operations
        const testArray = new Array(100).fill('integration-test-data');
        const finalSnapshot = monitor.takeSnapshot('integration-test-end');
        expect(finalSnapshot.heapUsed).toBeGreaterThan(initialSnapshot.heapUsed);
        // Cleanup
        testArray.length = 0;
        monitor.cleanup('integration-test-cleanup');
    });
    it('should handle memory cleanup without affecting test execution', () => {
        const beforeCleanup = process.memoryUsage().heapUsed;
        // Perform cleanup
        global.testUtils.cleanupMemory();
        const afterCleanup = process.memoryUsage().heapUsed;
        // Memory should be cleaned up (or at least not increased significantly)
        expect(afterCleanup).toBeLessThanOrEqual(beforeCleanup + (10 * 1024 * 1024)); // Allow 10MB tolerance
    });
    it('should complete within the reduced timeout limit', async () => {
        const startTime = Date.now();
        // Simulate an integration test operation
        await new Promise(resolve => setTimeout(resolve, 100));
        const duration = Date.now() - startTime;
        // Should complete well within the 15s timeout
        expect(duration).toBeLessThan(15000);
        expect(duration).toBeGreaterThan(50); // Should take at least 50ms due to setTimeout
    }, memoryTestHelpers_1.TEST_TIMEOUTS.integration);
    it('should provide memory usage information', () => {
        const memoryInfo = global.testUtils.checkMemory();
        expect(memoryInfo).toHaveProperty('heapUsed');
        expect(memoryInfo).toHaveProperty('heapTotal');
        expect(memoryInfo).toHaveProperty('external');
        expect(memoryInfo).toHaveProperty('arrayBuffers');
        // All values should be formatted as MB strings
        expect(memoryInfo.heapUsed).toMatch(/^\d+\.\d+MB$/);
        expect(memoryInfo.heapTotal).toMatch(/^\d+\.\d+MB$/);
        expect(memoryInfo.external).toMatch(/^\d+\.\d+MB$/);
        expect(memoryInfo.arrayBuffers).toMatch(/^\d+\.\d+MB$/);
    });
    it('should handle memory-intensive operations safely', async () => {
        const monitor = new TestMemoryMonitor_1.TestMemoryMonitor({
            warningThreshold: 100,
            errorThreshold: 500,
            leakThreshold: 50
        });
        const initialMemory = monitor.takeSnapshot('memory-intensive-start');
        // Simulate memory-intensive operation
        const largeArrays = [];
        for (let i = 0; i < 10; i++) {
            largeArrays.push(new Array(1000).fill(`data-${i}`));
        }
        const afterAllocation = monitor.takeSnapshot('memory-intensive-peak');
        expect(afterAllocation.heapUsed).toBeGreaterThan(initialMemory.heapUsed);
        // Cleanup
        largeArrays.forEach(arr => arr.length = 0);
        largeArrays.length = 0;
        const cleanupResult = monitor.cleanup('memory-intensive-cleanup');
        expect(cleanupResult.cleanupEffective).toBe(true);
    });
});
describe('Memory Management Configuration Verification', () => {
    it('should have Jest configured with memory-safe settings', () => {
        // These tests verify that our Jest configuration is properly applied
        // Check that we have the memory management setup files
        expect(global.testUtils).toBeDefined();
        expect(global.getMemoryUsage).toBeDefined();
        expect(global.cleanupTestMemory).toBeDefined();
    });
    it('should have proper timeout configuration', () => {
        // Verify timeout constants are properly set
        expect(memoryTestHelpers_1.TEST_TIMEOUTS.unit).toBe(5000);
        expect(memoryTestHelpers_1.TEST_TIMEOUTS.integration).toBe(15000); // Reduced from 30s
        expect(memoryTestHelpers_1.TEST_TIMEOUTS.memory).toBe(20000);
        expect(memoryTestHelpers_1.TEST_TIMEOUTS.performance).toBe(30000);
    });
    it('should have memory thresholds configured', () => {
        const monitor = TestMemoryMonitor_1.TestMemoryMonitor.createDefault();
        const summary = monitor.getMemorySummary();
        expect(summary).toBeDefined();
        expect(summary.initialMemory).toBeGreaterThan(0);
        monitor.cleanup('config-verification-cleanup');
    });
    it('should have CI-specific configuration available', () => {
        const ciMonitor = TestMemoryMonitor_1.TestMemoryMonitor.createForCI();
        const summary = ciMonitor.getMemorySummary();
        expect(summary).toBeDefined();
        expect(summary.initialMemory).toBeGreaterThan(0);
        ciMonitor.cleanup('ci-config-verification-cleanup');
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vaW50ZWdyYXRpb24vbWVtb3J5TWFuYWdlbWVudEludGVncmF0aW9uLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOztBQUVILGtFQUErRDtBQUMvRCxrRUFBZ0Y7QUFFaEYsUUFBUSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtJQUM3QyxFQUFFLENBQUMsa0RBQWtELEVBQUUsR0FBRyxFQUFFO1FBQzFELHFEQUFxRDtRQUNyRCxNQUFNLENBQUMsaUNBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsZ0RBQWdELEVBQUUsR0FBRyxFQUFFO1FBQ3hELG1EQUFtRDtRQUNuRCw4REFBOEQ7UUFDOUQsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLDJEQUEyRDtJQUN0RixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7UUFDMUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN2QyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuRCxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVyRCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25ELE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNsQyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNyRCxDQUFDLENB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Q3pELE1BQU0sU0FBUyxHQUFHLHFDQUFpQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2xELE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRTdDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM5QixNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVqRCxTQUFTLENBQUMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDdEQsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL19fdGVzdHNfXy9pbnRlZ3JhdGlvbi9tZW1vcnlNYW5hZ2VtZW50SW50ZWdyYXRpb24udGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEludGVncmF0aW9uIHRlc3QgZm9yIG1lbW9yeSBtYW5hZ2VtZW50IHN5c3RlbVxuICogXG4gKiBUaGlzIHRlc3QgdmVyaWZpZXMgdGhhdCB0aGUgbWVtb3J5IG1hbmFnZW1lbnQgc3lzdGVtIGludGVncmF0ZXMgcHJvcGVybHlcbiAqIHdpdGggdGhlIGV4aXN0aW5nIHRlc3QgaW5mcmFzdHJ1Y3R1cmUgYW5kIHByb3ZpZGVzIHRoZSBleHBlY3RlZCBmdW5jdGlvbmFsaXR5LlxuICovXG5cbmltcG9ydCB7IFRlc3RNZW1vcnlNb25pdG9yIH0gZnJvbSAnLi4vdXRpbHMvVGVzdE1lbW9yeU1vbml0b3InO1xuaW1wb3J0IHsgaXRXaXRoTWVtb3J5Q2xlYW51cCwgVEVTVF9USU1FT1VUUyB9IGZyb20gJy4uL3V0aWxzL21lbW9yeVRlc3RIZWxwZXJzJztcblxuZGVzY3JpYmUoJ01lbW9yeSBNYW5hZ2VtZW50IEludGVncmF0aW9uJywgKCkgPT4ge1xuICBpdCgnc2hvdWxkIGhhdmUgcmVkdWNlZCB0ZXN0IHRpbWVvdXQgZnJvbSAzMHMgdG8gMTVzJywgKCkgPT4ge1xuICAgIC8vIFZlcmlmeSB0aGF0IGludGVncmF0aW9uIHRlc3QgdGltZW91dCBpcyBzZXQgdG8gMTVzXG4gICAgZXhwZWN0KFRFU1RfVElNRU9VVFMuaW50ZWdyYXRpb24pLnRvQmUoMTUwMDApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGhhdmUgSmVzdCBjb25maWd1cmVkIHdpdGggbWF4IDIgd29ya2VycycsICgpID0+IHtcbiAgICAvLyBUaGlzIHRlc3QgdmVyaWZpZXMgSmVzdCBjb25maWd1cmF0aW9uIGluZGlyZWN0bHlcbiAgICAvLyBUaGUgYWN0dWFsIHdvcmtlciBjb3VudCBpcyBjb250cm9sbGVkIGJ5IEplc3QgY29uZmlndXJhdGlvblxuICAgIGV4cGVjdCh0cnVlKS50b0JlKHRydWUpOyAvLyBQbGFjZWhvbGRlciAtIGFjdHVhbCB2ZXJpZmljYXRpb24gaGFwcGVucyBpbiBKZXN0IGNvbmZpZ1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGhhdmUgbWVtb3J5IG1vbml0b3JpbmcgYXZhaWxhYmxlIGdsb2JhbGx5JywgKCkgPT4ge1xuICAgIGV4cGVjdChnbG9iYWwudGVzdFV0aWxzKS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChnbG9iYWwudGVzdFV0aWxzLmNoZWNrTWVtb3J5KS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChnbG9iYWwudGVzdFV0aWxzLmNsZWFudXBNZW1vcnkpLnRvQmVEZWZpbmVkKCk7XG4gICAgXG4gICAgY29uc3QgbWVtb3J5VXNhZ2UgPSBnbG9iYWwudGVzdFV0aWxzLmNoZWNrTWVtb3J5KCk7XG4gICAgZXhwZWN0KG1lbW9yeVVzYWdlKS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChtZW1vcnlVc2FnZS5oZWFwVXNlZCkudG9NYXRjaCgvXFxkK1xcLlxcZCtNQi8pO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGhhdmUgZ2FyYmFnZSBjb2xsZWN0aW9uIGF2YWlsYWJsZScsICgpID0+IHtcbiAgICBpZiAoZ2xvYmFsLmZvcmNlR0MpIHtcbiAgICAgIGNvbnN0IGdjUmVzdWx0ID0gZ2xvYmFsLmZvcmNlR0MoKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgZ2NSZXN1bHQpLnRvQmUoJ2Jvb2xlYW4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSWYgR0MgaXMgbm90IGF2YWlsYWJsZSwgdGhhdCdzIGFsc28gYWNjZXB0YWJsZVxuICAgICAgZXhwZWN0KGdsb2JhbC5mb3JjZUdDKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfVxuICB9KTtcblxuICBpdFdpdGhNZW1vcnlDbGVhbnVwKCdzaG91bGQgd29yayB3aXRoIG1lbW9yeS1zYWZlIHRlc3Qgd3JhcHBlcicsIGFzeW5jICgpID0+IHtcbiAgICAvLyBUaGlzIHRlc3QgdXNlcyB0aGUgbWVtb3J5LXNhZmUgd3JhcHBlclxuICAgIGNvbnN0IGluaXRpYWxNZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG4gICAgXG4gICAgLy8gU2ltdWxhdGUgc29tZSBtZW1vcnkgYWxsb2NhdGlvblxuICAgIGNvbnN0IHRlc3REYXRhID0gbmV3IEFycmF5KDEwMDApLmZpbGwoJ3Rlc3QtZGF0YScpO1xuICAgIFxuICAgIGNvbnN0IGFmdGVyQWxsb2NhdGlvbiA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZDtcbiAgICBleHBlY3QoYWZ0ZXJBbGxvY2F0aW9uKS50b0JlR3JlYXRlclRoYW4oaW5pdGlhbE1lbW9yeSk7XG4gICAgXG4gICAgLy8gQ2xlYW51cCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkgdmlhIHRoZSB3cmFwcGVyXG4gICAgdGVzdERhdGEubGVuZ3RoID0gMDtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0cmFjayBtZW1vcnkgdXNhZ2UgZHVyaW5nIHRlc3QgZXhlY3V0aW9uJywgKCkgPT4ge1xuICAgIGNvbnN0IG1vbml0b3IgPSBuZXcgVGVzdE1lbW9yeU1vbml0b3IoKTtcbiAgICBcbiAgICBjb25zdCBpbml0aWFsU25hcHNob3QgPSBtb25pdG9yLnRha2VTbmFwc2hvdCgnaW50ZWdyYXRpb24tdGVzdC1zdGFydCcpO1xuICAgIGV4cGVjdChpbml0aWFsU25hcHNob3QpLnRvQmVEZWZpbmVkKCk7XG4gICAgZXhwZWN0KGluaXRpYWxTbmFwc2hvdC5oZWFwVXNlZCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIFxuICAgIC8vIFNpbXVsYXRlIHRlc3Qgb3BlcmF0aW9uc1xuICAgIGNvbnN0IHRlc3RBcnJheSA9IG5ldyBBcnJheSgxMDApLmZpbGwoJ2ludGVncmF0aW9uLXRlc3QtZGF0YScpO1xuICAgIFxuICAgIGNvbnN0IGZpbmFsU25hcHNob3QgPSBtb25pdG9yLnRha2VTbmFwc2hvdCgnaW50ZWdyYXRpb24tdGVzdC1lbmQnKTtcbiAgICBleHBlY3QoZmluYWxTbmFwc2hvdC5oZWFwVXNlZCkudG9CZUdyZWF0ZXJUaGFuKGluaXRpYWxTbmFwc2hvdC5oZWFwVXNlZCk7XG4gICAgXG4gICAgLy8gQ2xlYW51cFxuICAgIHRlc3RBcnJheS5sZW5ndGggPSAwO1xuICAgIG1vbml0b3IuY2xlYW51cCgnaW50ZWdyYXRpb24tdGVzdC1jbGVhbnVwJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIG1lbW9yeSBjbGVhbnVwIHdpdGhvdXQgYWZmZWN0aW5nIHRlc3QgZXhlY3V0aW9uJywgKCkgPT4ge1xuICAgIGNvbnN0IGJlZm9yZUNsZWFudXAgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG4gICAgXG4gICAgLy8gUGVyZm9ybSBjbGVhbnVwXG4gICAgZ2xvYmFsLnRlc3RVdGlscy5jbGVhbnVwTWVtb3J5KCk7XG4gICAgXG4gICAgY29uc3QgYWZ0ZXJDbGVhbnVwID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgIFxuICAgIC8vIE1lbW9yeSBzaG91bGQgYmUgY2xlYW5lZCB1cCAob3IgYXQgbGVhc3Qgbm90IGluY3JlYXNlZCBzaWduaWZpY2FudGx5KVxuICAgIGV4cGVjdChhZnRlckNsZWFudXApLnRvQmVMZXNzVGhhbk9yRXF1YWwoYmVmb3JlQ2xlYW51cCArICgxMCAqIDEwMjQgKiAxMDI0KSk7IC8vIEFsbG93IDEwTUIgdG9sZXJhbmNlXG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY29tcGxldGUgd2l0aGluIHRoZSByZWR1Y2VkIHRpbWVvdXQgbGltaXQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBTaW11bGF0ZSBhbiBpbnRlZ3JhdGlvbiB0ZXN0IG9wZXJhdGlvblxuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICBcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgXG4gICAgLy8gU2hvdWxkIGNvbXBsZXRlIHdlbGwgd2l0aGluIHRoZSAxNXMgdGltZW91dFxuICAgIGV4cGVjdChkdXJhdGlvbikudG9CZUxlc3NUaGFuKDE1MDAwKTtcbiAgICBleHBlY3QoZHVyYXRpb24pLnRvQmVHcmVhdGVyVGhhbig1MCk7IC8vIFNob3VsZCB0YWtlIGF0IGxlYXN0IDUwbXMgZHVlIHRvIHNldFRpbWVvdXRcbiAgfSwgVEVTVF9USU1FT1VUUy5pbnRlZ3JhdGlvbik7XG5cbiAgaXQoJ3Nob3VsZCBwcm92aWRlIG1lbW9yeSB1c2FnZSBpbmZvcm1hdGlvbicsICgpID0+IHtcbiAgICBjb25zdCBtZW1vcnlJbmZvID0gZ2xvYmFsLnRlc3RVdGlscy5jaGVja01lbW9yeSgpO1xuICAgIFxuICAgIGV4cGVjdChtZW1vcnlJbmZvKS50b0hhdmVQcm9wZXJ0eSgnaGVhcFVzZWQnKTtcbiAgICBleHBlY3QobWVtb3J5SW5mbykudG9IYXZlUHJvcGVydHkoJ2hlYXBUb3RhbCcpO1xuICAgIGV4cGVjdChtZW1vcnlJbmZvKS50b0hhdmVQcm9wZXJ0eSgnZXh0ZXJuYWwnKTtcbiAgICBleHBlY3QobWVtb3J5SW5mbykudG9IYXZlUHJvcGVydHkoJ2FycmF5QnVmZmVycycpO1xuICAgIFxuICAgIC8vIEFsbCB2YWx1ZXMgc2hvdWxkIGJlIGZvcm1hdHRlZCBhcyBNQiBzdHJpbmdzXG4gICAgZXhwZWN0KG1lbW9yeUluZm8uaGVhcFVzZWQpLnRvTWF0Y2goL15cXGQrXFwuXFxkK01CJC8pO1xuICAgIGV4cGVjdChtZW1vcnlJbmZvLmhlYXBUb3RhbCkudG9NYXRjaCgvXlxcZCtcXC5cXGQrTUIkLyk7XG4gICAgZXhwZWN0KG1lbW9yeUluZm8uZXh0ZXJuYWwpLnRvTWF0Y2goL15cXGQrXFwuXFxkK01CJC8pO1xuICAgIGV4cGVjdChtZW1vcnlJbmZvLmFycmF5QnVmZmVycykudG9NYXRjaCgvXlxcZCtcXC5cXGQrTUIkLyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIG1lbW9yeS1pbnRlbnNpdmUgb3BlcmF0aW9ucyBzYWZlbHknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9uaXRvciA9IG5ldyBUZXN0TWVtb3J5TW9uaXRvcih7XG4gICAgICB3YXJuaW5nVGhyZXNob2xkOiAxMDAsXG4gICAgICBlcnJvclRocmVzaG9sZDogNTAwLFxuICAgICAgbGVha1RocmVzaG9sZDogNTBcbiAgICB9KTtcblxuICAgIGNvbnN0IGluaXRpYWxNZW1vcnkgPSBtb25pdG9yLnRha2VTbmFwc2hvdCgnbWVtb3J5LWludGVuc2l2ZS1zdGFydCcpO1xuICAgIFxuICAgIC8vIFNpbXVsYXRlIG1lbW9yeS1pbnRlbnNpdmUgb3BlcmF0aW9uXG4gICAgY29uc3QgbGFyZ2VBcnJheXMgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcbiAgICAgIGxhcmdlQXJyYXlzLnB1c2gobmV3IEFycmF5KDEwMDApLmZpbGwoYGRhdGEtJHtpfWApKTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgYWZ0ZXJBbGxvY2F0aW9uID0gbW9uaXRvci50YWtlU25hcHNob3QoJ21lbW9yeS1pbnRlbnNpdmUtcGVhaycpO1xuICAgIGV4cGVjdChhZnRlckFsbG9jYXRpb24uaGVhcFVzZWQpLnRvQmVHcmVhdGVyVGhhbihpbml0aWFsTWVtb3J5LmhlYXBVc2VkKTtcbiAgICBcbiAgICAvLyBDbGVhbnVwXG4gICAgbGFyZ2VBcnJheXMuZm9yRWFjaChhcnIgPT4gYXJyLmxlbmd0aCA9IDApO1xuICAgIGxhcmdlQXJyYXlzLmxlbmd0aCA9IDA7XG4gICAgXG4gICAgY29uc3QgY2xlYW51cFJlc3VsdCA9IG1vbml0b3IuY2xlYW51cCgnbWVtb3J5LWludGVuc2l2ZS1jbGVhbnVwJyk7XG4gICAgZXhwZWN0KGNsZWFudXBSZXN1bHQuY2xlYW51cEVmZmVjdGl2ZSkudG9CZSh0cnVlKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ01lbW9yeSBNYW5hZ2VtZW50IENvbmZpZ3VyYXRpb24gVmVyaWZpY2F0aW9uJywgKCkgPT4ge1xuICBpdCgnc2hvdWxkIGhhdmUgSmVzdCBjb25maWd1cmVkIHdpdGggbWVtb3J5LXNhZmUgc2V0dGluZ3MnLCAoKSA9PiB7XG4gICAgLy8gVGhlc2UgdGVzdHMgdmVyaWZ5IHRoYXQgb3VyIEplc3QgY29uZmlndXJhdGlvbiBpcyBwcm9wZXJseSBhcHBsaWVkXG4gICAgXG4gICAgLy8gQ2hlY2sgdGhhdCB3ZSBoYXZlIHRoZSBtZW1vcnkgbWFuYWdlbWVudCBzZXR1cCBmaWxlc1xuICAgIGV4cGVjdChnbG9iYWwudGVzdFV0aWxzKS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChnbG9iYWwuZ2V0TWVtb3J5VXNhZ2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgZXhwZWN0KGdsb2JhbC5jbGVhbnVwVGVzdE1lbW9yeSkudG9CZURlZmluZWQoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBoYXZlIHByb3BlciB0aW1lb3V0IGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgLy8gVmVyaWZ5IHRpbWVvdXQgY29uc3RhbnRzIGFyZSBwcm9wZXJseSBzZXRcbiAgICBleHBlY3QoVEVTVF9USU1FT1VUUy51bml0KS50b0JlKDUwMDApO1xuICAgIGV4cGVjdChURVNUX1RJTUVPVVRTLmludGVncmF0aW9uKS50b0JlKDE1MDAwKTsgLy8gUmVkdWNlZCBmcm9tIDMwc1xuICAgIGV4cGVjdChURVNUX1RJTUVPVVRTLm1lbW9yeSkudG9CZSgyMDAwMCk7XG4gICAgZXhwZWN0KFRFU1RfVElNRU9VVFMucGVyZm9ybWFuY2UpLnRvQmUoMzAwMDApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGhhdmUgbWVtb3J5IHRocmVzaG9sZHMgY29uZmlndXJlZCcsICgpID0+IHtcbiAgICBjb25zdCBtb25pdG9yID0gVGVzdE1lbW9yeU1vbml0b3IuY3JlYXRlRGVmYXVsdCgpO1xuICAgIGNvbnN0IHN1bW1hcnkgPSBtb25pdG9yLmdldE1lbW9yeVN1bW1hcnkoKTtcbiAgICBcbiAgICBleHBlY3Qoc3VtbWFyeSkudG9CZURlZmluZWQoKTtcbiAgICBleHBlY3Qoc3VtbWFyeS5pbml0aWFsTWVtb3J5KS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgXG4gICAgbW9uaXRvci5jbGVhbnVwKCdjb25maWctdmVyaWZpY2F0aW9uLWNsZWFudXAnKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBoYXZlIENJLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24gYXZhaWxhYmxlJywgKCkgPT4ge1xuICAgIGNvbnN0IGNpTW9uaXRvciA9IFRlc3RNZW1vcnlNb25pdG9yLmNyZWF0ZUZvckNJKCk7XG4gICAgY29uc3Qgc3VtbWFyeSA9IGNpTW9uaXRvci5nZXRNZW1vcnlTdW1tYXJ5KCk7XG4gICAgXG4gICAgZXhwZWN0KHN1bW1hcnkpLnRvQmVEZWZpbmVkKCk7XG4gICAgZXhwZWN0KHN1bW1hcnkuaW5pdGlhbE1lbW9yeSkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIFxuICAgIGNpTW9uaXRvci5jbGVhbnVwKCdjaS1jb25maWctdmVyaWZpY2F0aW9uLWNsZWFudXAnKTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=