a0ce86bc8f5e4c9ec844d1c8a2717987
"use strict";
/**
 * Agent Hooks for Automated Quality Assurance
 *
 * This module provides React hooks that integrate with Kiro's agent hook system
 * for automatic planetary data validation, ingredient consistency checking,
 * and campaign trigger management.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.useAgentHookConfiguration = exports.useQualityMetricsHook = exports.useBuildQualityMonitoringHook = exports.useTypeScriptCampaignHook = exports.useIngredientConsistencyHook = exports.usePlanetaryDataValidationHook = exports.useAgentHooks = void 0;
const react_1 = require("react");
const automatedQualityAssurance_1 = require("@/utils/automatedQualityAssurance");
const logger_1 = require("@/utils/logger");
/**
 * Main agent hook for automated quality assurance integration
 */
function useAgentHooks(config = {}) {
    const defaultConfig = {
        enablePlanetaryValidation: true,
        enableIngredientValidation: true,
        enableCampaignTriggers: true,
        enablePerformanceMonitoring: true,
        validationInterval: 5 // 5 minutes
    };
    const finalConfig = { ...defaultConfig, ...config };
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [hookState, setHookState] = (0, react_1.useState)({
        isActive: false,
        lastValidation: 0,
        validationResults: {},
        campaignTriggers: [],
        qualityMetrics: qa.getQualityMetrics()
    });
    const intervalRef = (0, react_1.useRef)(null);
    // Start agent hooks
    const startAgentHooks = (0, react_1.useCallback)(() => {
        if (hookState.isActive)
            return;
        setHookState(prev => ({ ...prev, isActive: true }));
        // Set up validation interval
        intervalRef.current = setInterval(async () => {
            try {
                const results = {};
                // Planetary data validation
                if (finalConfig.enablePlanetaryValidation) {
                    const planetaryResult = await qa.validatePlanetaryData();
                    results.planetary = planetaryResult;
                    if (!planetaryResult.isValid) {
                        logger_1.logger.warn('Planetary data validation failed:', planetaryResult.issues);
                    }
                }
                // TypeScript error threshold check
                if (finalConfig.enableCampaignTriggers) {
                    const trigger = await qa.checkTypeScriptErrorThreshold();
                    if (trigger === null || trigger === void 0 ? void 0 : trigger.triggered) {
                        logger_1.logger.warn('TypeScript campaign trigger activated:', trigger);
                    }
                }
                // Update state
                setHookState(prev => ({
                    ...prev,
                    lastValidation: Date.now(),
                    validationResults: { ...prev.validationResults, ...results },
                    campaignTriggers: qa.getActiveCampaignTriggers(),
                    qualityMetrics: qa.getQualityMetrics()
                }));
                logger_1.logger.debug('Agent hooks validation cycle completed');
            }
            catch (error) {
                logger_1.logger.error('Error in agent hooks validation cycle:', error);
            }
        }, finalConfig.validationInterval * 60 * 1000);
        logger_1.logger.info('Agent hooks started with config:', finalConfig);
    }, [finalConfig, hookState.isActive, qa]);
    // Stop agent hooks
    const stopAgentHooks = (0, react_1.useCallback)(() => {
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        setHookState(prev => ({ ...prev, isActive: false }));
        logger_1.logger.info('Agent hooks stopped');
    }, []);
    // Manual validation trigger
    const triggerValidation = (0, react_1.useCallback)(async (type) => {
        try {
            const results = {};
            if (!type || type === 'all' || type === 'planetary') {
                results.planetary = await qa.validatePlanetaryData();
            }
            if (!type || type === 'all' || type === 'typescript') {
                const trigger = await qa.checkTypeScriptErrorThreshold();
                if (trigger) {
                    setHookState(prev => ({
                        ...prev,
                        campaignTriggers: [...prev.campaignTriggers, trigger]
                    }));
                }
            }
            setHookState(prev => ({
                ...prev,
                lastValidation: Date.now(),
                validationResults: { ...prev.validationResults, ...results },
                qualityMetrics: qa.getQualityMetrics()
            }));
            logger_1.logger.debug('Manual validation triggered:', { type, results });
            return results;
        }
        catch (error) {
            logger_1.logger.error('Error in manual validation:', error);
            throw error;
        }
    }, [qa]);
    // Cleanup on unmount
    (0, react_1.useEffect)(() => {
        return () => {
            stopAgentHooks();
        };
    }, [stopAgentHooks]);
    return {
        hookState,
        startAgentHooks,
        stopAgentHooks,
        triggerValidation,
        isActive: hookState.isActive
    };
}
exports.useAgentHooks = useAgentHooks;
/**
 * Agent hook specifically for planetary data validation
 */
function usePlanetaryDataValidationHook(autoStart = true) {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [validationResult, setValidationResult] = (0, react_1.useState)(null);
    const [isValidating, setIsValidating] = (0, react_1.useState)(false);
    const validatePlanetaryData = (0, react_1.useCallback)(async (date) => {
        setIsValidating(true);
        try {
            const result = await qa.validatePlanetaryData(date);
            setValidationResult(result);
            if (!result.isValid) {
                logger_1.logger.warn('Planetary data validation hook detected issues:', result.issues);
                // Dispatch event for external systems
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('planetary-validation-failed', {
                        detail: result
                    }));
                }
            }
            return result;
        }
        catch (error) {
            logger_1.logger.error('Error in planetary data validation hook:', error);
            throw error;
        }
        finally {
            setIsValidating(false);
        }
    }, [qa]);
    // Auto-start validation
    (0, react_1.useEffect)(() => {
        if (autoStart) {
            validatePlanetaryData();
        }
    }, [autoStart, validatePlanetaryData]);
    return {
        validationResult,
        isValidating,
        validatePlanetaryData,
        isValid: (_a = validationResult === null || validationResult === void 0 ? void 0 : validationResult.isValid) !== null && _a !== void 0 ? _a : null
    };
}
exports.usePlanetaryDataValidationHook = usePlanetaryDataValidationHook;
/**
 * Agent hook for ingredient consistency checking
 */
function useIngredientConsistencyHook() {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [validationResult, setValidationResult] = (0, react_1.useState)(null);
    const [isValidating, setIsValidating] = (0, react_1.useState)(false);
    const validateIngredients = (0, react_1.useCallback)(async (ingredients) => {
        if (ingredients.length === 0) {
            return null;
        }
        setIsValidating(true);
        try {
            const result = qa.validateIngredientConsistency(ingredients);
            setValidationResult(result);
            if (!result.isValid) {
                logger_1.logger.warn('Ingredient consistency validation detected issues:', result.issues);
                // Dispatch event for external systems
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('ingredient-validation-failed', {
                        detail: { result, ingredients }
                    }));
                }
            }
            return result;
        }
        catch (error) {
            logger_1.logger.error('Error in ingredient consistency validation:', error);
            throw error;
        }
        finally {
            setIsValidating(false);
        }
    }, [qa]);
    return {
        validationResult,
        isValidating,
        validateIngredients,
        isValid: (_a = validationResult === null || validationResult === void 0 ? void 0 : validationResult.isValid) !== null && _a !== void 0 ? _a : null
    };
}
exports.useIngredientConsistencyHook = useIngredientConsistencyHook;
/**
 * Agent hook for TypeScript campaign triggers
 */
function useTypeScriptCampaignHook(autoCheck = true) {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [campaignTrigger, setCampaignTrigger] = (0, react_1.useState)(null);
    const [isChecking, setIsChecking] = (0, react_1.useState)(false);
    const checkErrorThreshold = (0, react_1.useCallback)(async () => {
        setIsChecking(true);
        try {
            const trigger = await qa.checkTypeScriptErrorThreshold();
            setCampaignTrigger(trigger);
            if (trigger === null || trigger === void 0 ? void 0 : trigger.triggered) {
                logger_1.logger.warn('TypeScript campaign trigger activated:', trigger);
                // Dispatch event for campaign system integration
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('typescript-campaign-trigger', {
                        detail: trigger
                    }));
                }
            }
            return trigger;
        }
        catch (error) {
            logger_1.logger.error('Error checking TypeScript error threshold:', error);
            throw error;
        }
        finally {
            setIsChecking(false);
        }
    }, [qa]);
    // Auto-check on mount and periodically
    (0, react_1.useEffect)(() => {
        if (autoCheck) {
            checkErrorThreshold();
            // Check every 10 minutes
            const interval = setInterval(checkErrorThreshold, 10 * 60 * 1000);
            return () => clearInterval(interval);
        }
    }, [autoCheck, checkErrorThreshold]);
    return {
        campaignTrigger,
        isChecking,
        checkErrorThreshold,
        isTriggered: (_a = campaignTrigger === null || campaignTrigger === void 0 ? void 0 : campaignTrigger.triggered) !== null && _a !== void 0 ? _a : false
    };
}
exports.useTypeScriptCampaignHook = useTypeScriptCampaignHook;
/**
 * Agent hook for build quality monitoring
 */
function useBuildQualityMonitoringHook() {
    var _a;
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [qualityResult, setQualityResult] = (0, react_1.useState)(null);
    const [isMonitoring, setIsMonitoring] = (0, react_1.useState)(false);
    const monitorBuildQuality = (0, react_1.useCallback)(async (buildMetrics) => {
        setIsMonitoring(true);
        try {
            const result = qa.monitorBuildQuality(buildMetrics);
            setQualityResult(result);
            if (!result.isValid) {
                logger_1.logger.warn('Build quality monitoring detected issues:', result.issues);
                // Dispatch event for external systems
                if (typeof window !== 'undefined') {
                    window.dispatchEvent(new CustomEvent('build-quality-issues', {
                        detail: { result, buildMetrics }
                    }));
                }
            }
            return result;
        }
        catch (error) {
            logger_1.logger.error('Error in build quality monitoring:', error);
            throw error;
        }
        finally {
            setIsMonitoring(false);
        }
    }, [qa]);
    return {
        qualityResult,
        isMonitoring,
        monitorBuildQuality,
        isQualityGood: (_a = qualityResult === null || qualityResult === void 0 ? void 0 : qualityResult.isValid) !== null && _a !== void 0 ? _a : null
    };
}
exports.useBuildQualityMonitoringHook = useBuildQualityMonitoringHook;
/**
 * Agent hook for comprehensive quality metrics monitoring
 */
function useQualityMetricsHook(updateInterval = 30000) {
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const [metrics, setMetrics] = (0, react_1.useState)(qa.getQualityMetrics());
    const [lastUpdate, setLastUpdate] = (0, react_1.useState)(Date.now());
    const updateMetrics = (0, react_1.useCallback)(() => {
        const newMetrics = qa.getQualityMetrics();
        setMetrics(newMetrics);
        setLastUpdate(Date.now());
    }, [qa]);
    // Update metrics periodically
    (0, react_1.useEffect)(() => {
        const interval = setInterval(updateMetrics, updateInterval);
        return () => clearInterval(interval);
    }, [updateMetrics, updateInterval]);
    return {
        metrics,
        lastUpdate,
        updateMetrics
    };
}
exports.useQualityMetricsHook = useQualityMetricsHook;
/**
 * Agent hook configuration management
 */
function useAgentHookConfiguration() {
    const qa = (0, automatedQualityAssurance_1.getAutomatedQualityAssurance)();
    const updateConfiguration = (0, react_1.useCallback)((config) => {
        qa.updateConfig(config);
        logger_1.logger.info('Agent hook configuration updated:', config);
    }, [qa]);
    const getActiveTriggers = (0, react_1.useCallback)(() => {
        return qa.getActiveCampaignTriggers();
    }, [qa]);
    return {
        updateConfiguration,
        getActiveTriggers
    };
}
exports.useAgentHookConfiguration = useAgentHookConfiguration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9ob29rcy91c2VBZ2VudEhvb2tzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQUVILGlDQUFpRTtBQUNqRSxpRkFNMkM7QUFFM0MsMkNBQXdDO0FBa0J4Qzs7R0FFRztBQUNILFNBQWdCLGFBQWEsQ0FBQyxTQUFtQyxFQUFFO0lBQ2pFLE1BQU0sYUFBYSxHQUFvQjtRQUNyQyx5QkFBeUIsRUFBRSxJQUFJO1FBQy9CLDBCQUEwQixFQUFFLElBQUk7UUFDaEMsc0JBQXNCLEVBQUUsSUFBSTtRQUM1QiwyQkFBMkIsRUFBRSxJQUFJO1FBQ2pDLGtCQUFrQixFQUFFLENBQUMsQ0FBQyxZQUFZO0tBQ25DLENBQUM7SUFFRixNQUFNLFdBQVcsR0FBRyxFQUFFLEdBQUcsYUFBYSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDcEQsTUFBTSxFQUFFLEdBQUcsSUFBQSx3REFBNEIsR0FBRSxDQUFDO0lBRTFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFpQjtRQUN6RCxRQUFRLEVBQUUsS0FBSztRQUNmLGNBQWMsRUFBRSxDQUFDO1FBQ2pCLGlCQUFpQixFQUFFLEVBQUU7UUFDckIsZ0JBQWdCLEVBQUUsRUFBRTtRQUNwQixjQUFjLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixFQUFFO0tBQ3ZDLENBQUMsQ0FBQztJQUVILE1BQU0sV0FBVyxHQUFHLElBQUEsY0FBTSxFQUF3QixJQUFJLENBQUMsQ0FBQztJQUV4RCxvQkFBb0I7SUFDcEIsTUFBTSxlQUFlLEdBQUcsSUFBQSxtQkFBVyxFQUFDLEdBQUcsRUFBRTtRQUN2QyxJQUFJLFNBQVMsQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUUvQixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVwRCw2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QyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUVwQyxPQUFPO1FBQ0wsT0FBTztRQUNQLFVBQVU7UUFDVixhQUFhO0tBQ2QsQ0FBQztBQUNKLENBQUM7QUF0QkQsc0RBc0JDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQix5QkFBeUI7SUFDdkMsTUFBTSxFQUFFLEdBQUcsSUFBQSx3REFBNEIsR0FBRSxDQUFDO0lBRTFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsTUFBdUMsRUFBRSxFQUFFO1FBQ2xGLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEIsZUFBTSxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMzRCxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRVQsTUFBTSxpQkFBaUIsR0FBRyxJQUFBLG1CQUFXLEVBQUMsR0FBRyxFQUFFO1FBQ3pDLE9BQU8sRUFBRSxDQUFDLHlCQUF5QixFQUFFLENBQUM7SUFDeEMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVULE9BQU87UUFDTCxtQkFBbUI7UUFDbkIsaUJBQWlCO0tBQ2xCLENBQUM7QUFDSixDQUFDO0FBaEJELDhEQWdCQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL2hvb2tzL3VzZUFnZW50SG9va3MudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBZ2VudCBIb29rcyBmb3IgQXV0b21hdGVkIFF1YWxpdHkgQXNzdXJhbmNlXG4gKiBcbiAqIFRoaXMgbW9kdWxlIHByb3ZpZGVzIFJlYWN0IGhvb2tzIHRoYXQgaW50ZWdyYXRlIHdpdGggS2lybydzIGFnZW50IGhvb2sgc3lzdGVtXG4gKiBmb3IgYXV0b21hdGljIHBsYW5ldGFyeSBkYXRhIHZhbGlkYXRpb24sIGluZ3JlZGllbnQgY29uc2lzdGVuY3kgY2hlY2tpbmcsXG4gKiBhbmQgY2FtcGFpZ24gdHJpZ2dlciBtYW5hZ2VtZW50LlxuICovXG5cbmltcG9ydCB7IHVzZUVmZmVjdCwgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlLCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBcbiAgZ2V0QXV0b21hdGVkUXVhbGl0eUFzc3VyYW5jZSwgXG4gIFZhbGlkYXRpb25SZXN1bHQsIFxuICBDYW1wYWlnblRyaWdnZXIsIFxuICBRdWFsaXR5TWV0cmljcyxcbiAgUXVhbGl0eUFzc3VyYW5jZUNvbmZpZyBcbn0gZnJvbSAnQC91dGlscy9hdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlJztcbmltcG9ydCB7IEVsZW1lbnRhbFByb3BlcnRpZXMgfSBmcm9tICdAL3V0aWxzL3N0ZWVyaW5nRmlsZUludGVsbGlnZW5jZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAL3V0aWxzL2xvZ2dlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWdlbnRIb29rQ29uZmlnIHtcbiAgZW5hYmxlUGxhbmV0YXJ5VmFsaWRhdGlvbjogYm9vbGVhbjtcbiAgZW5hYmxlSW5ncmVkaWVudFZhbGlkYXRpb246IGJvb2xlYW47XG4gIGVuYWJsZUNhbXBhaWduVHJpZ2dlcnM6IGJvb2xlYW47XG4gIGVuYWJsZVBlcmZvcm1hbmNlTW9uaXRvcmluZzogYm9vbGVhbjtcbiAgdmFsaWRhdGlvbkludGVydmFsOiBudW1iZXI7IC8vIG1pbnV0ZXNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBZ2VudEhvb2tTdGF0ZSB7XG4gIGlzQWN0aXZlOiBib29sZWFuO1xuICBsYXN0VmFsaWRhdGlvbjogbnVtYmVyO1xuICB2YWxpZGF0aW9uUmVzdWx0czogUmVjb3JkPHN0cmluZywgVmFsaWRhdGlvblJlc3VsdD47XG4gIGNhbXBhaWduVHJpZ2dlcnM6IENhbXBhaWduVHJpZ2dlcltdO1xuICBxdWFsaXR5TWV0cmljczogUXVhbGl0eU1ldHJpY3M7XG59XG5cbi8qKlxuICogTWFpbiBhZ2VudCBob29rIGZvciBhdXRvbWF0ZWQgcXVhbGl0eSBhc3N1cmFuY2UgaW50ZWdyYXRpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZUFnZW50SG9va3MoY29uZmlnOiBQYXJ0aWFsPEFnZW50SG9va0NvbmZpZz4gPSB7fSkge1xuICBjb25zdCBkZWZhdWx0Q29uZmlnOiBBZ2VudEhvb2tDb25maWcgPSB7XG4gICAgZW5hYmxlUGxhbmV0YXJ5VmFsaWRhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVJbmdyZWRpZW50VmFsaWRhdGlvbjogdHJ1ZSxcbiAgICBlbmFibGVDYW1wYWlnblRyaWdnZXJzOiB0cnVlLFxuICAgIGVuYWJsZVBlcmZvcm1hbmNlTW9uaXRvcmluZzogdHJ1ZSxcbiAgICB2YWxpZGF0aW9uSW50ZXJ2YWw6IDUgLy8gNSBtaW51dGVzXG4gIH07XG5cbiAgY29uc3QgZmluYWxDb25maWcgPSB7IC4uLmRlZmF1bHRDb25maWcsIC4uLmNvbmZpZyB9O1xuICBjb25zdCBxYSA9IGdldEF1dG9tYXRlZFF1YWxpdHlBc3N1cmFuY2UoKTtcbiAgXG4gIGNvbnN0IFtob29rU3RhdGUsIHNldEhvb2tTdGF0ZV0gPSB1c2VTdGF0ZTxBZ2VudEhvb2tTdGF0ZT4oe1xuICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICBsYXN0VmFsaWRhdGlvbjogMCxcbiAgICB2YWxpZGF0aW9uUmVzdWx0czoge30sXG4gICAgY2FtcGFpZ25UcmlnZ2VyczogW10sXG4gICAgcXVhbGl0eU1ldHJpY3M6IHFhLmdldFF1YWxpdHlNZXRyaWNzKClcbiAgfSk7XG5cbiAgY29uc3QgaW50ZXJ2YWxSZWYgPSB1c2VSZWY8Tm9kZUpTLlRpbWVvdXQgfCBudWxsPihudWxsKTtcblxuICAvLyBTdGFydCBhZ2VudCBob29rc1xuICBjb25zdCBzdGFydEFnZW50SG9va3MgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgaWYgKGhvb2tTdGF0ZS5pc0FjdGl2ZSkgcmV0dXJuO1xuXG4gICAgc2V0SG9va1N0YXRlKHByZXYgPT4gKHsgLi4ucHJldiwgaXNBY3RpdmU6IHRydWUgfSkpO1xuICAgIFxuICAgIC8vIFNldCB1cCB2YWxpZGF0aW9uIGludGVydmFsXG4gICAgaW50ZXJ2YWxSZWYuY3VycmVudCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdHM6IFJlY29yZDxzdHJpbmcsIFZhbGlkYXRpb25SZXN1bHQ+ID0ge307XG4gICAgICAgIFxuICAgICAgICAvLyBQbGFuZXRhcnkgZGF0YSB2YWxpZGF0aW9uXG4gICAgICAgIGlmIChmaW5hbENvbmZpZy5lbmFibGVQbGFuZXRhcnlWYWxpZGF0aW9uKSB7XG4gICAgICAgICAgY29uc3QgcGxhbmV0YXJ5UmVzdWx0ID0gYXdhaXQgcWEudmFsaWRhdGVQbGFuZXRhcnlEYXRhKCk7XG4gICAgICAgICAgcmVzdWx0cy5wbGFuZXRhcnkgPSBwbGFuZXRhcnlSZXN1bHQ7XG4gICAgICAgICAgXG4gICAgICAgICAgaWYgKCFwbGFuZXRhcnlSZXN1bHQuaXNWYWxpZCkge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ1BsYW5ldGFyeSBkYXRhIHZhbGlkYXRpb24gZmFpbGVkOicsIHBsYW5ldGFyeVJlc3VsdC5pc3N1ZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFR5cGVTY3JpcHQgZXJyb3IgdGhyZXNob2xkIGNoZWNrXG4gICAgICAgIGlmIChmaW5hbENvbmZpZy5lbmFibGVDYW1wYWlnblRyaWdnZXJzKSB7XG4gICAgICAgICAgY29uc3QgdHJpZ2dlciA9IGF3YWl0IHFhLmNoZWNrVHlwZVNjcmlwdEVycm9yVGhyZXNob2xkKCk7XG4gICAgICAgICAgaWYgKHRyaWdnZXI/LnRyaWdnZXJlZCkge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ1R5cGVTY3JpcHQgY2FtcGFpZ24gdHJpZ2dlciBhY3RpdmF0ZWQ6JywgdHJpZ2dlcik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVXBkYXRlIHN0YXRlXG4gICAgICAgIHNldEhvb2tTdGF0ZShwcmV2ID0+ICh7XG4gICAgICAgICAgLi4ucHJldixcbiAgICAgICAgICBsYXN0VmFsaWRhdGlvbjogRGF0ZS5ub3coKSxcbiAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0czogeyAuLi5wcmV2LnZhbGlkYXRpb25SZXN1bHRzLCAuLi5yZXN1bHRzIH0sXG4gICAgICAgICAgY2FtcGFpZ25UcmlnZ2VyczogcWEuZ2V0QWN0aXZlQ2FtcGFpZ25UcmlnZ2VycygpLFxuICAgICAgICAgIHF1YWxpdHlNZXRyaWNzOiBxYS5nZXRRdWFsaXR5TWV0cmljcygpXG4gICAgICAgIH0pKTtcblxuICAgICAgICBsb2dnZXIuZGVidWcoJ0FnZW50IGhvb2tzIHZhbGlkYXRpb24gY3ljbGUgY29tcGxldGVkJyk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIGFnZW50IGhvb2tzIHZhbGlkYXRpb24gY3ljbGU6JywgZXJyb3IpO1xuICAgICAgfVxuICAgIH0sIGZpbmFsQ29uZmlnLnZhbGlkYXRpb25JbnRlcnZhbCAqIDYwICogMTAwMCk7XG5cbiAgICBsb2dnZXIuaW5mbygnQWdlbnQgaG9va3Mgc3RhcnRlZCB3aXRoIGNvbmZpZzonLCBmaW5hbENvbmZpZyk7XG4gIH0sIFtmaW5hbENvbmZpZywgaG9va1N0YXRlLmlzQWN0aXZlLCBxYV0pO1xuXG4gIC8vIFN0b3AgYWdlbnQgaG9va3NcbiAgY29uc3Qgc3RvcEFnZW50SG9va3MgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgaWYgKGludGVydmFsUmVmLmN1cnJlbnQpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxSZWYuY3VycmVudCk7XG4gICAgICBpbnRlcnZhbFJlZi5jdXJyZW50ID0gbnVsbDtcbiAgICB9XG4gICAgXG4gICAgc2V0SG9va1N0YXRlKHByZXYgPT4gKHsgLi4ucHJldiwgaXNBY3RpdmU6IGZhbHNlIH0pKTtcbiAgICBsb2dnZXIuaW5mbygnQWdlbnQgaG9va3Mgc3RvcHBlZCcpO1xuICB9LCBbXSk7XG5cbiAgLy8gTWFudWFsIHZhbGlkYXRpb24gdHJpZ2dlclxuICBjb25zdCB0cmlnZ2VyVmFsaWRhdGlvbiA9IHVzZUNhbGxiYWNrKGFzeW5jICh0eXBlPzogJ3BsYW5ldGFyeScgfCAnaW5ncmVkaWVudCcgfCAndHlwZXNjcmlwdCcgfCAnYWxsJykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHRzOiBSZWNvcmQ8c3RyaW5nLCBWYWxpZGF0aW9uUmVzdWx0PiA9IHt9O1xuICAgICAgXG4gICAgICBpZiAoIXR5cGUgfHwgdHlwZSA9PT0gJ2FsbCcgfHwgdHlwZSA9PT0gJ3BsYW5ldGFyeScpIHtcbiAgICAgICAgcmVzdWx0cy5wbGFuZXRhcnkgPSBhd2FpdCBxYS52YWxpZGF0ZVBsYW5ldGFyeURhdGEoKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaWYgKCF0eXBlIHx8IHR5cGUgPT09ICdhbGwnIHx8IHR5cGUgPT09ICd0eXBlc2NyaXB0Jykge1xuICAgICAgICBjb25zdCB0cmlnZ2VyID0gYXdhaXQgcWEuY2hlY2tUeXBlU2NyaXB0RXJyb3JUaHJlc2hvbGQoKTtcbiAgICAgICAgaWYgKHRyaWdnZXIpIHtcbiAgICAgICAgICBzZXRIb29rU3RhdGUocHJldiA9PiAoe1xuICAgICAgICAgICAgLi4ucHJldixcbiAgICAgICAgICAgIGNhbXBhaWduVHJpZ2dlcnM6IFsuLi5wcmV2LmNhbXBhaWduVHJpZ2dlcnMsIHRyaWdnZXJdXG4gICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHNldEhvb2tTdGF0ZShwcmV2ID0+ICh7XG4gICAgICAgIC4uLnByZXYsXG4gICAgICAgIGxhc3RWYWxpZGF0aW9uOiBEYXRlLm5vdygpLFxuICAgICAgICB2YWxpZGF0aW9uUmVzdWx0czogeyAuLi5wcmV2LnZhbGlkYXRpb25SZXN1bHRzLCAuLi5yZXN1bHRzIH0sXG4gICAgICAgIHF1YWxpdHlNZXRyaWNzOiBxYS5nZXRRdWFsaXR5TWV0cmljcygpXG4gICAgICB9KSk7XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZygnTWFudWFsIHZhbGlkYXRpb24gdHJpZ2dlcmVkOicsIHsgdHlwZSwgcmVzdWx0cyB9KTtcbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIG1hbnVhbCB2YWxpZGF0aW9uOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfSwgW3FhXSk7XG5cbiAgLy8gQ2xlYW51cCBvbiB1bm1vdW50XG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHN0b3BBZ2VudEhvb2tzKCk7XG4gICAgfTtcbiAgfSwgW3N0b3BBZ2VudEhvb2tzXSk7XG5cbiAgcmV0dXJuIHtcbiAgICBob29rU3RhdGUsXG4gICAgc3RhcnRBZ2VudEhvb2tzLFxuICAgIHN0b3BBZ2VudEhvb2tzLFxuICAgIHRyaWdnZXJWYWxpZGF0aW9uLFxuICAgIGlzQWN0aXZlOiBob29rU3RhdGUuaXNBY3RpdmVcbiAgfTtcbn1cblxuLyoqXG4gKiBBZ2VudCBob29rIHNwZWNpZmljYWxseSBmb3IgcGxhbmV0YXJ5IGRhdGEgdmFsaWRhdGlvblxuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlUGxhbmV0YXJ5RGF0YVZhbGlkYXRpb25Ib29rKGF1dG9TdGFydDogYm9vbGVhbiA9IHRydWUpIHtcbiAgY29uc3QgcWEgPSBnZXRBdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlKCk7XG4gIGNvbnN0IFt2YWxpZGF0aW9uUmVzdWx0LCBzZXRWYWxpZGF0aW9uUmVzdWx0XSA9IHVzZVN0YXRlPFZhbGlkYXRpb25SZXN1bHQgfCBudWxsPihudWxsKTtcbiAgY29uc3QgW2lzVmFsaWRhdGluZywgc2V0SXNWYWxpZGF0aW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICBjb25zdCB2YWxpZGF0ZVBsYW5ldGFyeURhdGEgPSB1c2VDYWxsYmFjayhhc3luYyAoZGF0ZT86IERhdGUpID0+IHtcbiAgICBzZXRJc1ZhbGlkYXRpbmcodHJ1ZSk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHFhLnZhbGlkYXRlUGxhbmV0YXJ5RGF0YShkYXRlKTtcbiAgICAgIHNldFZhbGlkYXRpb25SZXN1bHQocmVzdWx0KTtcbiAgICAgIFxuICAgICAgaWYgKCFyZXN1bHQuaXNWYWxpZCkge1xuICAgICAgICBsb2dnZXIud2FybignUGxhbmV0YXJ5IGRhdGEgdmFsaWRhdGlvbiBob29rIGRldGVjdGVkIGlzc3VlczonLCByZXN1bHQuaXNzdWVzKTtcbiAgICAgICAgXG4gICAgICAgIC8vIERpc3BhdGNoIGV2ZW50IGZvciBleHRlcm5hbCBzeXN0ZW1zXG4gICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgncGxhbmV0YXJ5LXZhbGlkYXRpb24tZmFpbGVkJywge1xuICAgICAgICAgICAgZGV0YWlsOiByZXN1bHRcbiAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBpbiBwbGFuZXRhcnkgZGF0YSB2YWxpZGF0aW9uIGhvb2s6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNldElzVmFsaWRhdGluZyhmYWxzZSk7XG4gICAgfVxuICB9LCBbcWFdKTtcblxuICAvLyBBdXRvLXN0YXJ0IHZhbGlkYXRpb25cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoYXV0b1N0YXJ0KSB7XG4gICAgICB2YWxpZGF0ZVBsYW5ldGFyeURhdGEoKTtcbiAgICB9XG4gIH0sIFthdXRvU3RhcnQsIHZhbGlkYXRlUGxhbmV0YXJ5RGF0YV0pO1xuXG4gIHJldHVybiB7XG4gICAgdmFsaWRhdGlvblJlc3VsdCxcbiAgICBpc1ZhbGlkYXRpbmcsXG4gICAgdmFsaWRhdGVQbGFuZXRhcnlEYXRhLFxuICAgIGlzVmFsaWQ6IHZhbGlkYXRpb25SZXN1bHQ/LmlzVmFsaWQgPz8gbnVsbFxuICB9O1xufVxuXG4vKipcbiAqIEFnZW50IGhvb2sgZm9yIGluZ3JlZGllbnQgY29uc2lzdGVuY3kgY2hlY2tpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZUluZ3JlZGllbnRDb25zaXN0ZW5jeUhvb2soKSB7XG4gIGNvbnN0IHFhID0gZ2V0QXV0b21hdGVkUXVhbGl0eUFzc3VyYW5jZSgpO1xuICBjb25zdCBbdmFsaWRhdGlvblJlc3VsdCwgc2V0VmFsaWRhdGlvblJlc3VsdF0gPSB1c2VTdGF0ZTxWYWxpZGF0aW9uUmVzdWx0IHwgbnVsbD4obnVsbCk7XG4gIGNvbnN0IFtpc1ZhbGlkYXRpbmcsIHNldElzVmFsaWRhdGluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgY29uc3QgdmFsaWRhdGVJbmdyZWRpZW50cyA9IHVzZUNhbGxiYWNrKGFzeW5jIChpbmdyZWRpZW50czogQXJyYXk8e1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBlbGVtZW50YWxQcm9wZXJ0aWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgIGNhdGVnb3J5Pzogc3RyaW5nO1xuICB9PikgPT4ge1xuICAgIGlmIChpbmdyZWRpZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHNldElzVmFsaWRhdGluZyh0cnVlKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gcWEudmFsaWRhdGVJbmdyZWRpZW50Q29uc2lzdGVuY3koaW5ncmVkaWVudHMpO1xuICAgICAgc2V0VmFsaWRhdGlvblJlc3VsdChyZXN1bHQpO1xuICAgICAgXG4gICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKCdJbmdyZWRpZW50IGNvbnNpc3RlbmN5IHZhbGlkYXRpb24gZGV0ZWN0ZWQgaXNzdWVzOicsIHJlc3VsdC5pc3N1ZXMpO1xuICAgICAgICBcbiAgICAgICAgLy8gRGlzcGF0Y2ggZXZlbnQgZm9yIGV4dGVybmFsIHN5c3RlbXNcbiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdpbmdyZWRpZW50LXZhbGlkYXRpb24tZmFpbGVkJywge1xuICAgICAgICAgICAgZGV0YWlsOiB7IHJlc3VsdCwgaW5ncmVkaWVudHMgfVxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGluIGluZ3JlZGllbnQgY29uc2lzdGVuY3kgdmFsaWRhdGlvbjonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2V0SXNWYWxpZGF0aW5nKGZhbHNlKTtcbiAgICB9XG4gIH0sIFtxYV0pO1xuXG4gIHJldHVybiB7XG4gICAgdmFsaWRhdGlvblJlc3VsdCxcbiAgICBpc1ZhbGlkYXRpbmcsXG4gICAgdmFsaWRhdGVJbmdyZWRpZW50cyxcbiAgICBpc1ZhbGlkOiB2YWxpZGF0aW9uUmVzdWx0Py5pc1ZhbGlkID8/IG51bGxcbiAgfTtcbn1cblxuLyoqXG4gKiBBZ2VudCBob29rIGZvciBUeXBlU2NyaXB0IGNhbXBhaWduIHRyaWdnZXJzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB1c2VUeXBlU2NyaXB0Q2FtcGFpZ25Ib29rKGF1dG9DaGVjazogYm9vbGVhbiA9IHRydWUpIHtcbiAgY29uc3QgcWEgPSBnZXRBdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlKCk7XG4gIGNvbnN0IFtjYW1wYWlnblRyaWdnZXIsIHNldENhbXBhaWduVHJpZ2dlcl0gPSB1c2VTdGF0ZTxDYW1wYWlnblRyaWdnZXIgfCBudWxsPihudWxsKTtcbiAgY29uc3QgW2lzQ2hlY2tpbmcsIHNldElzQ2hlY2tpbmddID0gdXNlU3RhdGUoZmFsc2UpO1xuXG4gIGNvbnN0IGNoZWNrRXJyb3JUaHJlc2hvbGQgPSB1c2VDYWxsYmFjayhhc3luYyAoKSA9PiB7XG4gICAgc2V0SXNDaGVja2luZyh0cnVlKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdHJpZ2dlciA9IGF3YWl0IHFhLmNoZWNrVHlwZVNjcmlwdEVycm9yVGhyZXNob2xkKCk7XG4gICAgICBzZXRDYW1wYWlnblRyaWdnZXIodHJpZ2dlcik7XG4gICAgICBcbiAgICAgIGlmICh0cmlnZ2VyPy50cmlnZ2VyZWQpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ1R5cGVTY3JpcHQgY2FtcGFpZ24gdHJpZ2dlciBhY3RpdmF0ZWQ6JywgdHJpZ2dlcik7XG4gICAgICAgIFxuICAgICAgICAvLyBEaXNwYXRjaCBldmVudCBmb3IgY2FtcGFpZ24gc3lzdGVtIGludGVncmF0aW9uXG4gICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgndHlwZXNjcmlwdC1jYW1wYWlnbi10cmlnZ2VyJywge1xuICAgICAgICAgICAgZGV0YWlsOiB0cmlnZ2VyXG4gICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiB0cmlnZ2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIFR5cGVTY3JpcHQgZXJyb3IgdGhyZXNob2xkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXRJc0NoZWNraW5nKGZhbHNlKTtcbiAgICB9XG4gIH0sIFtxYV0pO1xuXG4gIC8vIEF1dG8tY2hlY2sgb24gbW91bnQgYW5kIHBlcmlvZGljYWxseVxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChhdXRvQ2hlY2spIHtcbiAgICAgIGNoZWNrRXJyb3JUaHJlc2hvbGQoKTtcbiAgICAgIFxuICAgICAgLy8gQ2hlY2sgZXZlcnkgMTAgbWludXRlc1xuICAgICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChjaGVja0Vycm9yVGhyZXNob2xkLCAxMCAqIDYwICogMTAwMCk7XG4gICAgICByZXR1cm4gKCkgPT4gY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgfVxuICB9LCBbYXV0b0NoZWNrLCBjaGVja0Vycm9yVGhyZXNob2xkXSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjYW1wYWlnblRyaWdnZXIsXG4gICAgaXNDaGVja2luZyxcbiAgICBjaGVja0Vycm9yVGhyZXNob2xkLFxuICAgIGlzVHJpZ2dlcmVkOiBjYW1wYWlnblRyaWdnZXI/LnRyaWdnZXJlZCA/PyBmYWxzZVxuICB9O1xufVxuXG4vKipcbiAqIEFnZW50IGhvb2sgZm9yIGJ1aWxkIHF1YWxpdHkgbW9uaXRvcmluZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlQnVpbGRRdWFsaXR5TW9uaXRvcmluZ0hvb2soKSB7XG4gIGNvbnN0IHFhID0gZ2V0QXV0b21hdGVkUXVhbGl0eUFzc3VyYW5jZSgpO1xuICBjb25zdCBbcXVhbGl0eVJlc3VsdCwgc2V0UXVhbGl0eVJlc3VsdF0gPSB1c2VTdGF0ZTxWYWxpZGF0aW9uUmVzdWx0IHwgbnVsbD4obnVsbCk7XG4gIGNvbnN0IFtpc01vbml0b3JpbmcsIHNldElzTW9uaXRvcmluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XG5cbiAgY29uc3QgbW9uaXRvckJ1aWxkUXVhbGl0eSA9IHVzZUNhbGxiYWNrKGFzeW5jIChidWlsZE1ldHJpY3M6IHtcbiAgICBidWlsZFRpbWU/OiBudW1iZXI7XG4gICAgYnVuZGxlU2l6ZT86IG51bWJlcjtcbiAgICBtZW1vcnlVc2FnZT86IG51bWJlcjtcbiAgICBlcnJvckNvdW50PzogbnVtYmVyO1xuICB9KSA9PiB7XG4gICAgc2V0SXNNb25pdG9yaW5nKHRydWUpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBxYS5tb25pdG9yQnVpbGRRdWFsaXR5KGJ1aWxkTWV0cmljcyk7XG4gICAgICBzZXRRdWFsaXR5UmVzdWx0KHJlc3VsdCk7XG4gICAgICBcbiAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ0J1aWxkIHF1YWxpdHkgbW9uaXRvcmluZyBkZXRlY3RlZCBpc3N1ZXM6JywgcmVzdWx0Lmlzc3Vlcyk7XG4gICAgICAgIFxuICAgICAgICAvLyBEaXNwYXRjaCBldmVudCBmb3IgZXh0ZXJuYWwgc3lzdGVtc1xuICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ2J1aWxkLXF1YWxpdHktaXNzdWVzJywge1xuICAgICAgICAgICAgZGV0YWlsOiB7IHJlc3VsdCwgYnVpbGRNZXRyaWNzIH1cbiAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBpbiBidWlsZCBxdWFsaXR5IG1vbml0b3Jpbmc6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNldElzTW9uaXRvcmluZyhmYWxzZSk7XG4gICAgfVxuICB9LCBbcWFdKTtcblxuICByZXR1cm4ge1xuICAgIHF1YWxpdHlSZXN1bHQsXG4gICAgaXNNb25pdG9yaW5nLFxuICAgIG1vbml0b3JCdWlsZFF1YWxpdHksXG4gICAgaXNRdWFsaXR5R29vZDogcXVhbGl0eVJlc3VsdD8uaXNWYWxpZCA/PyBudWxsXG4gIH07XG59XG5cbi8qKlxuICogQWdlbnQgaG9vayBmb3IgY29tcHJlaGVuc2l2ZSBxdWFsaXR5IG1ldHJpY3MgbW9uaXRvcmluZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlUXVhbGl0eU1ldHJpY3NIb29rKHVwZGF0ZUludGVydmFsOiBudW1iZXIgPSAzMDAwMCkgeyAvLyAzMCBzZWNvbmRzXG4gIGNvbnN0IHFhID0gZ2V0QXV0b21hdGVkUXVhbGl0eUFzc3VyYW5jZSgpO1xuICBjb25zdCBbbWV0cmljcywgc2V0TWV0cmljc10gPSB1c2VTdGF0ZTxRdWFsaXR5TWV0cmljcz4ocWEuZ2V0UXVhbGl0eU1ldHJpY3MoKSk7XG4gIGNvbnN0IFtsYXN0VXBkYXRlLCBzZXRMYXN0VXBkYXRlXSA9IHVzZVN0YXRlKERhdGUubm93KCkpO1xuXG4gIGNvbnN0IHVwZGF0ZU1ldHJpY3MgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgY29uc3QgbmV3TWV0cmljcyA9IHFhLmdldFF1YWxpdHlNZXRyaWNzKCk7XG4gICAgc2V0TWV0cmljcyhuZXdNZXRyaWNzKTtcbiAgICBzZXRMYXN0VXBkYXRlKERhdGUubm93KCkpO1xuICB9LCBbcWFdKTtcblxuICAvLyBVcGRhdGUgbWV0cmljcyBwZXJpb2RpY2FsbHlcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKHVwZGF0ZU1ldHJpY3MsIHVwZGF0ZUludGVydmFsKTtcbiAgICByZXR1cm4gKCkgPT4gY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gIH0sIFt1cGRhdGVNZXRyaWNzLCB1cGRhdGVJbnRlcnZhbF0pO1xuXG4gIHJldHVybiB7XG4gICAgbWV0cmljcyxcbiAgICBsYXN0VXBkYXRlLFxuICAgIHVwZGF0ZU1ldHJpY3NcbiAgfTtcbn1cblxuLyoqXG4gKiBBZ2VudCBob29rIGNvbmZpZ3VyYXRpb24gbWFuYWdlbWVudFxuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlQWdlbnRIb29rQ29uZmlndXJhdGlvbigpIHtcbiAgY29uc3QgcWEgPSBnZXRBdXRvbWF0ZWRRdWFsaXR5QXNzdXJhbmNlKCk7XG4gIFxuICBjb25zdCB1cGRhdGVDb25maWd1cmF0aW9uID0gdXNlQ2FsbGJhY2soKGNvbmZpZzogUGFydGlhbDxRdWFsaXR5QXNzdXJhbmNlQ29uZmlnPikgPT4ge1xuICAgIHFhLnVwZGF0ZUNvbmZpZyhjb25maWcpO1xuICAgIGxvZ2dlci5pbmZvKCdBZ2VudCBob29rIGNvbmZpZ3VyYXRpb24gdXBkYXRlZDonLCBjb25maWcpO1xuICB9LCBbcWFdKTtcblxuICBjb25zdCBnZXRBY3RpdmVUcmlnZ2VycyA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICByZXR1cm4gcWEuZ2V0QWN0aXZlQ2FtcGFpZ25UcmlnZ2VycygpO1xuICB9LCBbcWFdKTtcblxuICByZXR1cm4ge1xuICAgIHVwZGF0ZUNvbmZpZ3VyYXRpb24sXG4gICAgZ2V0QWN0aXZlVHJpZ2dlcnNcbiAgfTtcbn0iXSwidmVyc2lvbiI6M30=