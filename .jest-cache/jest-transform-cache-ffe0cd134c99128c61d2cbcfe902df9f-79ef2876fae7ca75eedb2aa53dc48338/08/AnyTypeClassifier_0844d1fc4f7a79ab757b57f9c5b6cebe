62c34174fdfa8d09709fa8dfe13b7b6a
"use strict";
/**
 * Any Type Classifier
 * Analyzes each `any` type usage to determine if it's intentional or unintentional
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.AnyTypeClassifier = void 0;
const types_1 = require("./types");
class AnyTypeClassifier {
    rules;
    constructor(rules) {
        this.rules = {
            errorHandlingPatterns: [
                /catch\s*\(\s*\w+\s*:\s*any\s*\)/,
                /error\s*:\s*any/,
                /exception\s*:\s*any/
            ],
            externalApiPatterns: [
                /response\s*:\s*any/,
                /data\s*:\s*any/,
                /payload\s*:\s*any/,
                /apiResponse\s*:\s*any/
            ],
            testMockPatterns: [
                /mock\w*\s*:\s*any/,
                /jest\.fn\(\)\s*as\s*any/,
                /\.mockReturnValue\s*\(\s*\w+\s*as\s*any\s*\)/
            ],
            dynamicConfigPatterns: [
                /config\s*:\s*any/,
                /options\s*:\s*any/,
                /settings\s*:\s*any/
            ],
            legacyCompatibilityPatterns: [
                /legacy\w*\s*:\s*any/,
                /deprecated\w*\s*:\s*any/
            ],
            ...rules
        };
    }
    /**
     * Classify a single any type usage
     */
    async classify(context) {
        try {
            // Check for existing documentation
            if (context.hasExistingComment && this.hasIntentionalDocumentation(context.existingComment)) {
                return {
                    isIntentional: true,
                    confidence: 0.95,
                    reasoning: 'Explicitly documented as intentional',
                    requiresDocumentation: false,
                    category: this.categorizeFromComment(context.existingComment)
                };
            }
            // Check for error handling patterns
            if (this.matchesErrorHandling(context)) {
                return {
                    isIntentional: true,
                    confidence: 0.9,
                    reasoning: 'Used in error handling context',
                    requiresDocumentation: true,
                    category: types_1.AnyTypeCategory.ERROR_HANDLING
                };
            }
            // Check for external API patterns
            if (this.matchesExternalApi(context)) {
                return {
                    isIntentional: true,
                    confidence: 0.8,
                    reasoning: 'Used for external API response',
                    requiresDocumentation: true,
                    category: types_1.AnyTypeCategory.EXTERNAL_API
                };
            }
            // Check for test mock patterns
            if (context.isInTestFile && this.matchesTestMock(context)) {
                return {
                    isIntentional: true,
                    confidence: 0.85,
                    reasoning: 'Used in test mocking',
                    requiresDocumentation: true,
                    category: types_1.AnyTypeCategory.TEST_MOCK
                };
            }
            // Check for simple array types (high confidence for replacement)
            if (this.isSimpleArrayType(context)) {
                return {
                    isIntentional: false,
                    confidence: 0.95,
                    reasoning: 'Simple array type can be replaced with unknown[]',
                    suggestedReplacement: 'unknown[]',
                    requiresDocumentation: false,
                    category: types_1.AnyTypeCategory.ARRAY_TYPE
                };
            }
            // Check for Record types
            if (this.isRecordType(context)) {
                return {
                    isIntentional: false,
                    confidence: 0.8,
                    reasoning: 'Record type can be replaced with unknown',
                    suggestedReplacement: this.suggestRecordReplacement(context),
                    requiresDocumentation: false,
                    category: types_1.AnyTypeCategory.RECORD_TYPE
                };
            }
            // Domain-specific analysis
            const domainClassification = this.analyzeDomainSpecific(context);
            if (domainClassification) {
                return domainClassification;
            }
            // Default to unintentional with low confidence
            return {
                isIntentional: false,
                confidence: 0.6,
                reasoning: 'No clear intentional pattern detected',
                suggestedReplacement: 'unknown',
                requiresDocumentation: false,
                category: types_1.AnyTypeCategory.TYPE_ASSERTION
            };
        }
        catch (error) {
            throw new types_1.ClassificationError(`Failed to classify any type at ${context.filePath}:${context.lineNumber}`, context, error);
        }
    }
    /**
     * Classify multiple any type usages in batch
     */
    async classifyBatch(contexts) {
        const results = [];
        for (const context of contexts) {
            try {
                const classification = await this.classify(context);
                results.push(classification);
            }
            catch (error) {
                // Log error but continue with other classifications
                console.warn(`Classification failed for ${context.filePath}:${context.lineNumber}`, error);
                // Provide safe fallback classification
                results.push({
                    isIntentional: true,
                    confidence: 0.1,
                    reasoning: 'Classification failed, marked as intentional for safety',
                    requiresDocumentation: true,
                    category: types_1.AnyTypeCategory.LEGACY_COMPATIBILITY
                });
            }
        }
        return results;
    }
    hasIntentionalDocumentation(comment) {
        if (!comment)
            return false;
        const intentionalKeywords = [
            'intentionally any',
            'deliberately any',
            'explicitly any',
            'must be any',
            'required any'
        ];
        const lowerComment = comment.toLowerCase();
        return intentionalKeywords.some(keyword => lowerComment.includes(keyword));
    }
    categorizeFromComment(comment) {
        if (!comment)
            return types_1.AnyTypeCategory.LEGACY_COMPATIBILITY;
        const lowerComment = comment.toLowerCase();
        if (lowerComment.includes('external') || lowerComment.includes('api')) {
            return types_1.AnyTypeCategory.EXTERNAL_API;
        }
        if (lowerComment.includes('error') || lowerComment.includes('catch')) {
            return types_1.AnyTypeCategory.ERROR_HANDLING;
        }
        if (lowerComment.includes('test') || lowerComment.includes('mock')) {
            return types_1.AnyTypeCategory.TEST_MOCK;
        }
        if (lowerComment.includes('config') || lowerComment.includes('dynamic')) {
            return types_1.AnyTypeCategory.DYNAMIC_CONFIG;
        }
        return types_1.AnyTypeCategory.LEGACY_COMPATIBILITY;
    }
    matchesErrorHandling(context) {
        const codeWithSurrounding = [
            ...context.surroundingLines,
            context.codeSnippet
        ].join('\n');
        return this.rules.errorHandlingPatterns.some(pattern => pattern.test(codeWithSurrounding));
    }
    matchesExternalApi(context) {
        const codeWithSurrounding = [
            ...context.surroundingLines,
            context.codeSnippet
        ].join('\n');
        return this.rules.externalApiPatterns.some(pattern => pattern.test(codeWithSurrounding));
    }
    matchesTestMock(context) {
        const codeWithSurrounding = [
            ...context.surroundingLines,
            context.codeSnippet
        ].join('\n');
        return this.rules.testMockPatterns.some(pattern => pattern.test(codeWithSurrounding));
    }
    isSimpleArrayType(context) {
        // Match patterns like: any[], Array<any>
        const arrayPatterns = [
            /:\s*any\[\]/,
            /:\s*Array<any>/,
            /=\s*\[\]\s*as\s*any\[\]/
        ];
        return arrayPatterns.some(pattern => pattern.test(context.codeSnippet));
    }
    isRecordType(context) {
        // Match patterns like: Record<string, any>, Record<number, any>
        const recordPatterns = [
            /:\s*Record<\s*string\s*,\s*any\s*>/,
            /:\s*Record<\s*number\s*,\s*any\s*>/,
            /:\s*\{\s*\[key:\s*string\]\s*:\s*any\s*\}/
        ];
        return recordPatterns.some(pattern => pattern.test(context.codeSnippet));
    }
    suggestRecordReplacement(context) {
        if (context.codeSnippet.includes('Record<string, any>')) {
            return 'Record<string, unknown>';
        }
        if (context.codeSnippet.includes('Record<number, any>')) {
            return 'Record<number, unknown>';
        }
        if (context.codeSnippet.includes('[key: string]: any')) {
            return '[key: string]: unknown';
        }
        return 'unknown';
    }
    analyzeDomainSpecific(context) {
        const domain = context.domainContext.domain;
        switch (domain) {
            case types_1.CodeDomain.ASTROLOGICAL:
                return this.analyzeAstrologicalDomain(context);
            case types_1.CodeDomain.RECIPE:
                return this.analyzeRecipeDomain(context);
            case types_1.CodeDomain.CAMPAIGN:
                return this.analyzeCampaignDomain(context);
            default:
                return null;
        }
    }
    analyzeAstrologicalDomain(context) {
        // Astrological code often needs flexible typing for planetary positions
        if (context.codeSnippet.includes('planetary') ||
            context.codeSnippet.includes('position') ||
            context.codeSnippet.includes('astro')) {
            return {
                isIntentional: true,
                confidence: 0.8,
                reasoning: 'Astrological calculations require flexible typing for planetary data',
                requiresDocumentation: true,
                category: types_1.AnyTypeCategory.EXTERNAL_API
            };
        }
        return null;
    }
    analyzeRecipeDomain(context) {
        // Recipe code might have specific ingredient types
        if (context.codeSnippet.includes('ingredient') ||
            context.codeSnippet.includes('recipe')) {
            return {
                isIntentional: false,
                confidence: 0.7,
                reasoning: 'Recipe/ingredient data can use specific types',
                suggestedReplacement: 'Ingredient | Recipe',
                requiresDocumentation: false,
                category: types_1.AnyTypeCategory.TYPE_ASSERTION
            };
        }
        return null;
    }
    analyzeCampaignDomain(context) {
        // Campaign system needs flexibility for dynamic configurations
        if (context.codeSnippet.includes('campaign') ||
            context.codeSnippet.includes('config') ||
            context.codeSnippet.includes('metrics')) {
            return {
                isIntentional: true,
                confidence: 0.85,
                reasoning: 'Campaign system requires flexible typing for dynamic behavior',
                requiresDocumentation: true,
                category: types_1.AnyTypeCategory.DYNAMIC_CONFIG
            };
        }
        return null;
    }
}
exports.AnyTypeClassifier = AnyTypeClassifier;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9zZXJ2aWNlcy9jYW1wYWlnbi91bmludGVudGlvbmFsLWFueS1lbGltaW5hdGlvbi9BbnlUeXBlQ2xhc3NpZmllci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCxtQ0FPaUI7QUFFakIsTUFBYSxpQkFBaUI7SUFDcEIsS0FBSyxDQUFzQjtJQUVuQyxZQUFZLEtBQW9DO1FBQzlDLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDWCxxQkFBcUIsRUFBRTtnQkFDckIsaUNBQWlDO2dCQUNqQyxpQkFBaUI7Z0JBQ2pCLHFCQUFxQjthQUN0QjtZQUNELG1CQUFtQixFQUFFO2dCQUNuQixvQkFBb0I7Z0JBQ3BCLGdCQUFnQjtnQkFDaEIsbUJBQW1CO2dCQUNuQix1QkFBdUI7YUFDeEI7WUFDRCxnQkFBZ0IsRUFBRTtnQkFDaEIsbUJBQW1CO2dCQUNuQix5QkFBeUI7Z0JBQ3pCLDhDQUE4QzthQUMvQztZQUNELHFCQUFxQixFQUFFO2dCQUNyQixrQkFBa0I7Z0JBQ2xCLG1CQUFtQjtnQkFDbkIsb0JBQW9CO2FBQ3JCO1lBQ0QsMkJBQTJCLEVBQUU7Z0JBQzNCLHFCQUFxQjtnQkFDckIseUJBQXlCO2FBQzFCO1lBQ0QsR0FBRyxLQUFLO1NBQ1QsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBOEI7UUFDM0MsSUFBSTtZQUNGLG1DQUFtQztZQUNuQyxJQUFJLE9BQU8sQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsMkJBQTJCLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxFQUFFO2dCQUMzRixPQUFPO29CQUNMLGFBQWEsRUFBRSxJQUFJO29CQUNuQixVQUFVLEVBQUUsSUFBSTtvQkFDaEIsU0FBUyxFQUFFLHNDQUFzQztvQkFDakQscUJBQXFCLEVBQUUsS0FBSztvQkFDNUIsUUFBUSxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsZUFB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TyxtQkFBbUIsQ0FBQyxPQUE4QjtRQUN4RCxtREFBbUQ7UUFDbkQsSUFBSSxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUM7WUFDMUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDMUMsT0FBTztnQkFDTCxhQUFhLEVBQUUsS0FBSztnQkFDcEIsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsU0FBUyxFQUFFLCtDQUErQztnQkFDMUQsb0JBQW9CLEVBQUUscUJBQXFCO2dCQUMzQyxxQkFBcUIsRUFBRSxLQUFLO2dCQUM1QixRQUFRLEVBQUUsdUJBQWUsQ0FBQyxjQUFjO2FBQ3pDLENBQUM7U0FDSDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLHFCQUFxQixDQUFDLE9BQThCO1FBQzFELCtEQUErRDtRQUMvRCxJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztZQUN4QyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7WUFDdEMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDM0MsT0FBTztnQkFDTCxhQUFhLEVBQUUsSUFBSTtnQkFDbkIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFNBQVMsRUFBRSwrREFBK0Q7Z0JBQzFFLHFCQUFxQixFQUFFLElBQUk7Z0JBQzNCLFFBQVEsRUFBRSx1QkFBZSxDQUFDLGNBQWM7YUFDekMsQ0FBQztTQUNIO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUExVUQsOENBMFVDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvc2VydmljZXMvY2FtcGFpZ24vdW5pbnRlbnRpb25hbC1hbnktZWxpbWluYXRpb24vQW55VHlwZUNsYXNzaWZpZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBbnkgVHlwZSBDbGFzc2lmaWVyXG4gKiBBbmFseXplcyBlYWNoIGBhbnlgIHR5cGUgdXNhZ2UgdG8gZGV0ZXJtaW5lIGlmIGl0J3MgaW50ZW50aW9uYWwgb3IgdW5pbnRlbnRpb25hbFxuICovXG5cbmltcG9ydCB7XG4gICAgQW55VHlwZUNhdGVnb3J5LFxuICAgIEFueVR5cGVDbGFzc2lmaWNhdGlvbixcbiAgICBDbGFzc2lmaWNhdGlvbkNvbnRleHQsXG4gICAgQ2xhc3NpZmljYXRpb25FcnJvcixcbiAgICBDbGFzc2lmaWNhdGlvblJ1bGVzLFxuICAgIENvZGVEb21haW5cbn0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBBbnlUeXBlQ2xhc3NpZmllciB7XG4gIHByaXZhdGUgcnVsZXM6IENsYXNzaWZpY2F0aW9uUnVsZXM7XG5cbiAgY29uc3RydWN0b3IocnVsZXM/OiBQYXJ0aWFsPENsYXNzaWZpY2F0aW9uUnVsZXM+KSB7XG4gICAgdGhpcy5ydWxlcyA9IHtcbiAgICAgIGVycm9ySGFuZGxpbmdQYXR0ZXJuczogW1xuICAgICAgICAvY2F0Y2hcXHMqXFwoXFxzKlxcdytcXHMqOlxccyphbnlcXHMqXFwpLyxcbiAgICAgICAgL2Vycm9yXFxzKjpcXHMqYW55LyxcbiAgICAgICAgL2V4Y2VwdGlvblxccyo6XFxzKmFueS9cbiAgICAgIF0sXG4gICAgICBleHRlcm5hbEFwaVBhdHRlcm5zOiBbXG4gICAgICAgIC9yZXNwb25zZVxccyo6XFxzKmFueS8sXG4gICAgICAgIC9kYXRhXFxzKjpcXHMqYW55LyxcbiAgICAgICAgL3BheWxvYWRcXHMqOlxccyphbnkvLFxuICAgICAgICAvYXBpUmVzcG9uc2VcXHMqOlxccyphbnkvXG4gICAgICBdLFxuICAgICAgdGVzdE1vY2tQYXR0ZXJuczogW1xuICAgICAgICAvbW9ja1xcdypcXHMqOlxccyphbnkvLFxuICAgICAgICAvamVzdFxcLmZuXFwoXFwpXFxzKmFzXFxzKmFueS8sXG4gICAgICAgIC9cXC5tb2NrUmV0dXJuVmFsdWVcXHMqXFwoXFxzKlxcdytcXHMqYXNcXHMqYW55XFxzKlxcKS9cbiAgICAgIF0sXG4gICAgICBkeW5hbWljQ29uZmlnUGF0dGVybnM6IFtcbiAgICAgICAgL2NvbmZpZ1xccyo6XFxzKmFueS8sXG4gICAgICAgIC9vcHRpb25zXFxzKjpcXHMqYW55LyxcbiAgICAgICAgL3NldHRpbmdzXFxzKjpcXHMqYW55L1xuICAgICAgXSxcbiAgICAgIGxlZ2FjeUNvbXBhdGliaWxpdHlQYXR0ZXJuczogW1xuICAgICAgICAvbGVnYWN5XFx3Klxccyo6XFxzKmFueS8sXG4gICAgICAgIC9kZXByZWNhdGVkXFx3Klxccyo6XFxzKmFueS9cbiAgICAgIF0sXG4gICAgICAuLi5ydWxlc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xhc3NpZnkgYSBzaW5nbGUgYW55IHR5cGUgdXNhZ2VcbiAgICovXG4gIGFzeW5jIGNsYXNzaWZ5KGNvbnRleHQ6IENsYXNzaWZpY2F0aW9uQ29udGV4dCk6IFByb21pc2U8QW55VHlwZUNsYXNzaWZpY2F0aW9uPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGZvciBleGlzdGluZyBkb2N1bWVudGF0aW9uXG4gICAgICBpZiAoY29udGV4dC5oYXNFeGlzdGluZ0NvbW1lbnQgJiYgdGhpcy5oYXNJbnRlbnRpb25hbERvY3VtZW50YXRpb24oY29udGV4dC5leGlzdGluZ0NvbW1lbnQpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaXNJbnRlbnRpb25hbDogdHJ1ZSxcbiAgICAgICAgICBjb25maWRlbmNlOiAwLjk1LFxuICAgICAgICAgIHJlYXNvbmluZzogJ0V4cGxpY2l0bHkgZG9jdW1lbnRlZCBhcyBpbnRlbnRpb25hbCcsXG4gICAgICAgICAgcmVxdWlyZXNEb2N1bWVudGF0aW9uOiBmYWxzZSxcbiAgICAgICAgICBjYXRlZ29yeTogdGhpcy5jYXRlZ29yaXplRnJvbUNvbW1lbnQoY29udGV4dC5leGlzdGluZ0NvbW1lbnQpXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBlcnJvciBoYW5kbGluZyBwYXR0ZXJuc1xuICAgICAgaWYgKHRoaXMubWF0Y2hlc0Vycm9ySGFuZGxpbmcoY29udGV4dCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc0ludGVudGlvbmFsOiB0cnVlLFxuICAgICAgICAgIGNvbmZpZGVuY2U6IDAuOSxcbiAgICAgICAgICByZWFzb25pbmc6ICdVc2VkIGluIGVycm9yIGhhbmRsaW5nIGNvbnRleHQnLFxuICAgICAgICAgIHJlcXVpcmVzRG9jdW1lbnRhdGlvbjogdHJ1ZSxcbiAgICAgICAgICBjYXRlZ29yeTogQW55VHlwZUNhdGVnb3J5LkVSUk9SX0hBTkRMSU5HXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBleHRlcm5hbCBBUEkgcGF0dGVybnNcbiAgICAgIGlmICh0aGlzLm1hdGNoZXNFeHRlcm5hbEFwaShjb250ZXh0KSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzSW50ZW50aW9uYWw6IHRydWUsXG4gICAgICAgICAgY29uZmlkZW5jZTogMC44LFxuICAgICAgICAgIHJlYXNvbmluZzogJ1VzZWQgZm9yIGV4dGVybmFsIEFQSSByZXNwb25zZScsXG4gICAgICAgICAgcmVxdWlyZXNEb2N1bWVudGF0aW9uOiB0cnVlLFxuICAgICAgICAgIGNhdGVnb3J5OiBBbnlUeXBlQ2F0ZWdvcnkuRVhURVJOQUxfQVBJXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciB0ZXN0IG1vY2sgcGF0dGVybnNcbiAgICAgIGlmIChjb250ZXh0LmlzSW5UZXN0RmlsZSAmJiB0aGlzLm1hdGNoZXNUZXN0TW9jayhjb250ZXh0KSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzSW50ZW50aW9uYWw6IHRydWUsXG4gICAgICAgICAgY29uZmlkZW5jZTogMC44NSxcbiAgICAgICAgICByZWFzb25pbmc6ICdVc2VkIGluIHRlc3QgbW9ja2luZycsXG4gICAgICAgICAgcmVxdWlyZXNEb2N1bWVudGF0aW9uOiB0cnVlLFxuICAgICAgICAgIGNhdGVnb3J5OiBBbnlUeXBlQ2F0ZWdvcnkuVEVTVF9NT0NLXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBzaW1wbGUgYXJyYXkgdHlwZXMgKGhpZ2ggY29uZmlkZW5jZSBmb3IgcmVwbGFjZW1lbnQpXG4gICAgICBpZiAodGhpcy5pc1NpbXBsZUFycmF5VHlwZShjb250ZXh0KSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzSW50ZW50aW9uYWw6IGZhbHNlLFxuICAgICAgICAgIGNvbmZpZGVuY2U6IDAuOTUsXG4gICAgICAgICAgcmVhc29uaW5nOiAnU2ltcGxlIGFycmF5IHR5cGUgY2FuIGJlIHJlcGxhY2VkIHdpdGggdW5rbm93bltdJyxcbiAgICAgICAgICBzdWdnZXN0ZWRSZXBsYWNlbWVudDogJ3Vua25vd25bXScsXG4gICAgICAgICAgcmVxdWlyZXNEb2N1bWVudGF0aW9uOiBmYWxzZSxcbiAgICAgICAgICBjYXRlZ29yeTogQW55VHlwZUNhdGVnb3J5LkFSUkFZX1RZUEVcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgZm9yIFJlY29yZCB0eXBlc1xuICAgICAgaWYgKHRoaXMuaXNSZWNvcmRUeXBlKGNvbnRleHQpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaXNJbnRlbnRpb25hbDogZmFsc2UsXG4gICAgICAgICAgY29uZmlkZW5jZTogMC44LFxuICAgICAgICAgIHJlYXNvbmluZzogJ1JlY29yZCB0eXBlIGNhbiBiZSByZXBsYWNlZCB3aXRoIHVua25vd24nLFxuICAgICAgICAgIHN1Z2dlc3RlZFJlcGxhY2VtZW50OiB0aGlzLnN1Z2dlc3RSZWNvcmRSZXBsYWNlbWVudChjb250ZXh0KSxcbiAgICAgICAgICByZXF1aXJlc0RvY3VtZW50YXRpb246IGZhbHNlLFxuICAgICAgICAgIGNhdGVnb3J5OiBBbnlUeXBlQ2F0ZWdvcnkuUkVDT1JEX1RZUEVcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gRG9tYWluLXNwZWNpZmljIGFuYWx5c2lzXG4gICAgICBjb25zdCBkb21haW5DbGFzc2lmaWNhdGlvbiA9IHRoaXMuYW5hbHl6ZURvbWFpblNwZWNpZmljKGNvbnRleHQpO1xuICAgICAgaWYgKGRvbWFpbkNsYXNzaWZpY2F0aW9uKSB7XG4gICAgICAgIHJldHVybiBkb21haW5DbGFzc2lmaWNhdGlvbjtcbiAgICAgIH1cblxuICAgICAgLy8gRGVmYXVsdCB0byB1bmludGVudGlvbmFsIHdpdGggbG93IGNvbmZpZGVuY2VcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzSW50ZW50aW9uYWw6IGZhbHNlLFxuICAgICAgICBjb25maWRlbmNlOiAwLjYsXG4gICAgICAgIHJlYXNvbmluZzogJ05vIGNsZWFyIGludGVudGlvbmFsIHBhdHRlcm4gZGV0ZWN0ZWQnLFxuICAgICAgICBzdWdnZXN0ZWRSZXBsYWNlbWVudDogJ3Vua25vd24nLFxuICAgICAgICByZXF1aXJlc0RvY3VtZW50YXRpb246IGZhbHNlLFxuICAgICAgICBjYXRlZ29yeTogQW55VHlwZUNhdGVnb3J5LlRZUEVfQVNTRVJUSU9OXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBDbGFzc2lmaWNhdGlvbkVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGNsYXNzaWZ5IGFueSB0eXBlIGF0ICR7Y29udGV4dC5maWxlUGF0aH06JHtjb250ZXh0LmxpbmVOdW1iZXJ9YCxcbiAgICAgICAgY29udGV4dCxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsYXNzaWZ5IG11bHRpcGxlIGFueSB0eXBlIHVzYWdlcyBpbiBiYXRjaFxuICAgKi9cbiAgYXN5bmMgY2xhc3NpZnlCYXRjaChjb250ZXh0czogQ2xhc3NpZmljYXRpb25Db250ZXh0W10pOiBQcm9taXNlPEFueVR5cGVDbGFzc2lmaWNhdGlvbltdPiB7XG4gICAgY29uc3QgcmVzdWx0czogQW55VHlwZUNsYXNzaWZpY2F0aW9uW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgY29udGV4dCBvZiBjb250ZXh0cykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY2xhc3NpZmljYXRpb24gPSBhd2FpdCB0aGlzLmNsYXNzaWZ5KGNvbnRleHQpO1xuICAgICAgICByZXN1bHRzLnB1c2goY2xhc3NpZmljYXRpb24pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gTG9nIGVycm9yIGJ1dCBjb250aW51ZSB3aXRoIG90aGVyIGNsYXNzaWZpY2F0aW9uc1xuICAgICAgICBjb25zb2xlLndhcm4oYENsYXNzaWZpY2F0aW9uIGZhaWxlZCBmb3IgJHtjb250ZXh0LmZpbGVQYXRofToke2NvbnRleHQubGluZU51bWJlcn1gLCBlcnJvcik7XG5cbiAgICAgICAgLy8gUHJvdmlkZSBzYWZlIGZhbGxiYWNrIGNsYXNzaWZpY2F0aW9uXG4gICAgICAgIHJlc3VsdHMucHVzaCh7XG4gICAgICAgICAgaXNJbnRlbnRpb25hbDogdHJ1ZSwgLy8gQ29uc2VydmF0aXZlIGZhbGxiYWNrIHRvIHByZXZlbnQgdW53YW50ZWQgY2hhbmdlc1xuICAgICAgICAgIGNvbmZpZGVuY2U6IDAuMSxcbiAgICAgICAgICByZWFzb25pbmc6ICdDbGFzc2lmaWNhdGlvbiBmYWlsZWQsIG1hcmtlZCBhcyBpbnRlbnRpb25hbCBmb3Igc2FmZXR5JyxcbiAgICAgICAgICByZXF1aXJlc0RvY3VtZW50YXRpb246IHRydWUsXG4gICAgICAgICAgY2F0ZWdvcnk6IEFueVR5cGVDYXRlZ29yeS5MRUdBQ1lfQ09NUEFUSUJJTElUWVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxuXG4gIHByaXZhdGUgaGFzSW50ZW50aW9uYWxEb2N1bWVudGF0aW9uKGNvbW1lbnQ/OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAoIWNvbW1lbnQpIHJldHVybiBmYWxzZTtcblxuICAgIGNvbnN0IGludGVudGlvbmFsS2V5d29yZHMgPSBbXG4gICAgICAnaW50ZW50aW9uYWxseSBhbnknLFxuICAgICAgJ2RlbGliZXJhdGVseSBhbnknLFxuICAgICAgJ2V4cGxpY2l0bHkgYW55JyxcbiAgICAgICdtdXN0IGJlIGFueScsXG4gICAgICAncmVxdWlyZWQgYW55J1xuICAgIF07XG5cbiAgICBjb25zdCBsb3dlckNvbW1lbnQgPSBjb21tZW50LnRvTG93ZXJDYXNlKCk7XG4gICAgcmV0dXJuIGludGVudGlvbmFsS2V5d29yZHMuc29tZShrZXl3b3JkID0+IGxvd2VyQ29tbWVudC5pbmNsdWRlcyhrZXl3b3JkKSk7XG4gIH1cblxuICBwcml2YXRlIGNhdGVnb3JpemVGcm9tQ29tbWVudChjb21tZW50Pzogc3RyaW5nKTogQW55VHlwZUNhdGVnb3J5IHtcbiAgICBpZiAoIWNvbW1lbnQpIHJldHVybiBBbnlUeXBlQ2F0ZWdvcnkuTEVHQUNZX0NPTVBBVElCSUxJVFk7XG5cbiAgICBjb25zdCBsb3dlckNvbW1lbnQgPSBjb21tZW50LnRvTG93ZXJDYXNlKCk7XG5cbiAgICBpZiAobG93ZXJDb21tZW50LmluY2x1ZGVzKCdleHRlcm5hbCcpIHx8IGxvd2VyQ29tbWVudC5pbmNsdWRlcygnYXBpJykpIHtcbiAgICAgIHJldHVybiBBbnlUeXBlQ2F0ZWdvcnkuRVhURVJOQUxfQVBJO1xuICAgIH1cbiAgICBpZiAobG93ZXJDb21tZW50LmluY2x1ZGVzKCdlcnJvcicpIHx8IGxvd2VyQ29tbWVudC5pbmNsdWRlcygnY2F0Y2gnKSkge1xuICAgICAgcmV0dXJuIEFueVR5cGVDYXRlZ29yeS5FUlJPUl9IQU5ETElORztcbiAgICB9XG4gICAgaWYgKGxvd2VyQ29tbWVudC5pbmNsdWRlcygndGVzdCcpIHx8IGxvd2VyQ29tbWVudC5pbmNsdWRlcygnbW9jaycpKSB7XG4gICAgICByZXR1cm4gQW55VHlwZUNhdGVnb3J5LlRFU1RfTU9DSztcbiAgICB9XG4gICAgaWYgKGxvd2VyQ29tbWVudC5pbmNsdWRlcygnY29uZmlnJykgfHwgbG93ZXJDb21tZW50LmluY2x1ZGVzKCdkeW5hbWljJykpIHtcbiAgICAgIHJldHVybiBBbnlUeXBlQ2F0ZWdvcnkuRFlOQU1JQ19DT05GSUc7XG4gICAgfVxuXG4gICAgcmV0dXJuIEFueVR5cGVDYXRlZ29yeS5MRUdBQ1lfQ09NUEFUSUJJTElUWTtcbiAgfVxuXG4gIHByaXZhdGUgbWF0Y2hlc0Vycm9ySGFuZGxpbmcoY29udGV4dDogQ2xhc3NpZmljYXRpb25Db250ZXh0KTogYm9vbGVhbiB7XG4gICAgY29uc3QgY29kZVdpdGhTdXJyb3VuZGluZyA9IFtcbiAgICAgIC4uLmNvbnRleHQuc3Vycm91bmRpbmdMaW5lcyxcbiAgICAgIGNvbnRleHQuY29kZVNuaXBwZXRcbiAgICBdLmpvaW4oJ1xcbicpO1xuXG4gICAgcmV0dXJuIHRoaXMucnVsZXMuZXJyb3JIYW5kbGluZ1BhdHRlcm5zLnNvbWUocGF0dGVybiA9PlxuICAgICAgcGF0dGVybi50ZXN0KGNvZGVXaXRoU3Vycm91bmRpbmcpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgbWF0Y2hlc0V4dGVybmFsQXBpKGNvbnRleHQ6IENsYXNzaWZpY2F0aW9uQ29udGV4dCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvZGVXaXRoU3Vycm91bmRpbmcgPSBbXG4gICAgICAuLi5jb250ZXh0LnN1cnJvdW5kaW5nTGluZXMsXG4gICAgICBjb250ZXh0LmNvZGVTbmlwcGV0XG4gICAgXS5qb2luKCdcXG4nKTtcblxuICAgIHJldHVybiB0aGlzLnJ1bGVzLmV4dGVybmFsQXBpUGF0dGVybnMuc29tZShwYXR0ZXJuID0+XG4gICAgICBwYXR0ZXJuLnRlc3QoY29kZVdpdGhTdXJyb3VuZGluZylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXRjaGVzVGVzdE1vY2soY29udGV4dDogQ2xhc3NpZmljYXRpb25Db250ZXh0KTogYm9vbGVhbiB7XG4gICAgY29uc3QgY29kZVdpdGhTdXJyb3VuZGluZyA9IFtcbiAgICAgIC4uLmNvbnRleHQuc3Vycm91bmRpbmdMaW5lcyxcbiAgICAgIGNvbnRleHQuY29kZVNuaXBwZXRcbiAgICBdLmpvaW4oJ1xcbicpO1xuXG4gICAgcmV0dXJuIHRoaXMucnVsZXMudGVzdE1vY2tQYXR0ZXJucy5zb21lKHBhdHRlcm4gPT5cbiAgICAgIHBhdHRlcm4udGVzdChjb2RlV2l0aFN1cnJvdW5kaW5nKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGlzU2ltcGxlQXJyYXlUeXBlKGNvbnRleHQ6IENsYXNzaWZpY2F0aW9uQ29udGV4dCk6IGJvb2xlYW4ge1xuICAgIC8vIE1hdGNoIHBhdHRlcm5zIGxpa2U6IGFueVtdLCBBcnJheTxhbnk+XG4gICAgY29uc3QgYXJyYXlQYXR0ZXJucyA9IFtcbiAgICAgIC86XFxzKmFueVxcW1xcXS8sXG4gICAgICAvOlxccypBcnJheTxhbnk+LyxcbiAgICAgIC89XFxzKlxcW1xcXVxccyphc1xccyphbnlcXFtcXF0vXG4gICAgXTtcblxuICAgIHJldHVybiBhcnJheVBhdHRlcm5zLnNvbWUocGF0dGVybiA9PiBwYXR0ZXJuLnRlc3QoY29udGV4dC5jb2RlU25pcHBldCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1JlY29yZFR5cGUoY29udGV4dDogQ2xhc3NpZmljYXRpb25Db250ZXh0KTogYm9vbGVhbiB7XG4gICAgLy8gTWF0Y2ggcGF0dGVybnMgbGlrZTogUmVjb3JkPHN0cmluZywgYW55PiwgUmVjb3JkPG51bWJlciwgYW55PlxuICAgIGNvbnN0IHJlY29yZFBhdHRlcm5zID0gW1xuICAgICAgLzpcXHMqUmVjb3JkPFxccypzdHJpbmdcXHMqLFxccyphbnlcXHMqPi8sXG4gICAgICAvOlxccypSZWNvcmQ8XFxzKm51bWJlclxccyosXFxzKmFueVxccyo+LyxcbiAgICAgIC86XFxzKlxce1xccypcXFtrZXk6XFxzKnN0cmluZ1xcXVxccyo6XFxzKmFueVxccypcXH0vXG4gICAgXTtcblxuICAgIHJldHVybiByZWNvcmRQYXR0ZXJucy5zb21lKHBhdHRlcm4gPT4gcGF0dGVybi50ZXN0KGNvbnRleHQuY29kZVNuaXBwZXQpKTtcbiAgfVxuXG4gIHByaXZhdGUgc3VnZ2VzdFJlY29yZFJlcGxhY2VtZW50KGNvbnRleHQ6IENsYXNzaWZpY2F0aW9uQ29udGV4dCk6IHN0cmluZyB7XG4gICAgaWYgKGNvbnRleHQuY29kZVNuaXBwZXQuaW5jbHVkZXMoJ1JlY29yZDxzdHJpbmcsIGFueT4nKSkge1xuICAgICAgcmV0dXJuICdSZWNvcmQ8c3RyaW5nLCB1bmtub3duPic7XG4gICAgfVxuICAgIGlmIChjb250ZXh0LmNvZGVTbmlwcGV0LmluY2x1ZGVzKCdSZWNvcmQ8bnVtYmVyLCBhbnk+JykpIHtcbiAgICAgIHJldHVybiAnUmVjb3JkPG51bWJlciwgdW5rbm93bj4nO1xuICAgIH1cbiAgICBpZiAoY29udGV4dC5jb2RlU25pcHBldC5pbmNsdWRlcygnW2tleTogc3RyaW5nXTogYW55JykpIHtcbiAgICAgIHJldHVybiAnW2tleTogc3RyaW5nXTogdW5rbm93bic7XG4gICAgfVxuXG4gICAgcmV0dXJuICd1bmtub3duJztcbiAgfVxuXG4gIHByaXZhdGUgYW5hbHl6ZURvbWFpblNwZWNpZmljKGNvbnRleHQ6IENsYXNzaWZpY2F0aW9uQ29udGV4dCk6IEFueVR5cGVDbGFzc2lmaWNhdGlvbiB8IG51bGwge1xuICAgIGNvbnN0IGRvbWFpbiA9IGNvbnRleHQuZG9tYWluQ29udGV4dC5kb21haW47XG5cbiAgICBzd2l0Y2ggKGRvbWFpbikge1xuICAgICAgY2FzZSBDb2RlRG9tYWluLkFTVFJPTE9HSUNBTDpcbiAgICAgICAgcmV0dXJuIHRoaXMuYW5hbHl6ZUFzdHJvbG9naWNhbERvbWFpbihjb250ZXh0KTtcbiAgICAgIGNhc2UgQ29kZURvbWFpbi5SRUNJUEU6XG4gICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVSZWNpcGVEb21haW4oY29udGV4dCk7XG4gICAgICBjYXNlIENvZGVEb21haW4uQ0FNUEFJR046XG4gICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVDYW1wYWlnbkRvbWFpbihjb250ZXh0KTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYW5hbHl6ZUFzdHJvbG9naWNhbERvbWFpbihjb250ZXh0OiBDbGFzc2lmaWNhdGlvbkNvbnRleHQpOiBBbnlUeXBlQ2xhc3NpZmljYXRpb24gfCBudWxsIHtcbiAgICAvLyBBc3Ryb2xvZ2ljYWwgY29kZSBvZnRlbiBuZWVkcyBmbGV4aWJsZSB0eXBpbmcgZm9yIHBsYW5ldGFyeSBwb3NpdGlvbnNcbiAgICBpZiAoY29udGV4dC5jb2RlU25pcHBldC5pbmNsdWRlcygncGxhbmV0YXJ5JykgfHxcbiAgICAgICAgY29udGV4dC5jb2RlU25pcHBldC5pbmNsdWRlcygncG9zaXRpb24nKSB8fFxuICAgICAgICBjb250ZXh0LmNvZGVTbmlwcGV0LmluY2x1ZGVzKCdhc3RybycpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0ludGVudGlvbmFsOiB0cnVlLFxuICAgICAgICBjb25maWRlbmNlOiAwLjgsXG4gICAgICAgIHJlYXNvbmluZzogJ0FzdHJvbG9naWNhbCBjYWxjdWxhdGlvbnMgcmVxdWlyZSBmbGV4aWJsZSB0eXBpbmcgZm9yIHBsYW5ldGFyeSBkYXRhJyxcbiAgICAgICAgcmVxdWlyZXNEb2N1bWVudGF0aW9uOiB0cnVlLFxuICAgICAgICBjYXRlZ29yeTogQW55VHlwZUNhdGVnb3J5LkVYVEVSTkFMX0FQSVxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgYW5hbHl6ZVJlY2lwZURvbWFpbihjb250ZXh0OiBDbGFzc2lmaWNhdGlvbkNvbnRleHQpOiBBbnlUeXBlQ2xhc3NpZmljYXRpb24gfCBudWxsIHtcbiAgICAvLyBSZWNpcGUgY29kZSBtaWdodCBoYXZlIHNwZWNpZmljIGluZ3JlZGllbnQgdHlwZXNcbiAgICBpZiAoY29udGV4dC5jb2RlU25pcHBldC5pbmNsdWRlcygnaW5ncmVkaWVudCcpIHx8XG4gICAgICAgIGNvbnRleHQuY29kZVNuaXBwZXQuaW5jbHVkZXMoJ3JlY2lwZScpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0ludGVudGlvbmFsOiBmYWxzZSxcbiAgICAgICAgY29uZmlkZW5jZTogMC43LFxuICAgICAgICByZWFzb25pbmc6ICdSZWNpcGUvaW5ncmVkaWVudCBkYXRhIGNhbiB1c2Ugc3BlY2lmaWMgdHlwZXMnLFxuICAgICAgICBzdWdnZXN0ZWRSZXBsYWNlbWVudDogJ0luZ3JlZGllbnQgfCBSZWNpcGUnLFxuICAgICAgICByZXF1aXJlc0RvY3VtZW50YXRpb246IGZhbHNlLFxuICAgICAgICBjYXRlZ29yeTogQW55VHlwZUNhdGVnb3J5LlRZUEVfQVNTRVJUSU9OXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBhbmFseXplQ2FtcGFpZ25Eb21haW4oY29udGV4dDogQ2xhc3NpZmljYXRpb25Db250ZXh0KTogQW55VHlwZUNsYXNzaWZpY2F0aW9uIHwgbnVsbCB7XG4gICAgLy8gQ2FtcGFpZ24gc3lzdGVtIG5lZWRzIGZsZXhpYmlsaXR5IGZvciBkeW5hbWljIGNvbmZpZ3VyYXRpb25zXG4gICAgaWYgKGNvbnRleHQuY29kZVNuaXBwZXQuaW5jbHVkZXMoJ2NhbXBhaWduJykgfHxcbiAgICAgICAgY29udGV4dC5jb2RlU25pcHBldC5pbmNsdWRlcygnY29uZmlnJykgfHxcbiAgICAgICAgY29udGV4dC5jb2RlU25pcHBldC5pbmNsdWRlcygnbWV0cmljcycpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0ludGVudGlvbmFsOiB0cnVlLFxuICAgICAgICBjb25maWRlbmNlOiAwLjg1LFxuICAgICAgICByZWFzb25pbmc6ICdDYW1wYWlnbiBzeXN0ZW0gcmVxdWlyZXMgZmxleGlibGUgdHlwaW5nIGZvciBkeW5hbWljIGJlaGF2aW9yJyxcbiAgICAgICAgcmVxdWlyZXNEb2N1bWVudGF0aW9uOiB0cnVlLFxuICAgICAgICBjYXRlZ29yeTogQW55VHlwZUNhdGVnb3J5LkRZTkFNSUNfQ09ORklHXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=