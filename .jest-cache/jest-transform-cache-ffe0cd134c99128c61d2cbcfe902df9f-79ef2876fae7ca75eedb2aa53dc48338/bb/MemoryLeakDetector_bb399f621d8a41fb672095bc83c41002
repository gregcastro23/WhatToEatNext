b3d9f7d7df71ff3aa85cca329714b14a
"use strict";
/**
 * Memory Leak Detector for Test Environment
 *
 * Detects common memory leak patterns in tests and provides
 * specific recommendations for fixing them.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryLeakDetector = void 0;
class MemoryLeakDetector {
    constructor() {
        this.baseline = process.memoryUsage().heapUsed;
        this.patterns = this.initializePatterns();
    }
    initializePatterns() {
        return [
            {
                name: 'Excessive Event Listeners',
                detector: () => {
                    if (typeof window !== 'undefined' && window._eventListeners) {
                        const totalListeners = Object.values(window._eventListeners)
                            .reduce((sum, listeners) => sum + ((listeners === null || listeners === void 0 ? void 0 : listeners.length) || 0), 0);
                        return totalListeners > 50;
                    }
                    return false;
                },
                description: 'Too many event listeners attached to DOM elements',
                fix: 'Remove event listeners in test cleanup or use cleanup utilities',
                severity: 'high'
            },
            {
                name: 'Unclosed Timers',
                detector: () => {
                    // Check for active timers (this is a simplified check)
                    const activeTimers = global._activeTimers || [];
                    return activeTimers.length > 10;
                },
                description: 'Active timers not cleared after tests',
                fix: 'Clear all timers in afterEach hooks using clearTimeout/clearInterval',
                severity: 'medium'
            },
            {
                name: 'Large Test Cache',
                detector: () => {
                    if (global.__TEST_CACHE__ && global.__TEST_CACHE__ instanceof Map) {
                        return global.__TEST_CACHE__.size > 100;
                    }
                    return false;
                },
                description: 'Test cache has grown too large',
                fix: 'Clear test cache regularly or implement cache size limits',
                severity: 'medium'
            },
            {
                name: 'Memory Growth Pattern',
                detector: () => {
                    const current = process.memoryUsage().heapUsed;
                    const growth = (current - this.baseline) / (1024 * 1024);
                    return growth > 200; // 200MB growth
                },
                description: 'Significant memory growth detected during test execution',
                fix: 'Review test setup/teardown and ensure proper cleanup',
                severity: 'critical'
            },
            {
                name: 'Jest Module Cache Bloat',
                detector: () => {
                    if (typeof require !== 'undefined' && require.cache) {
                        const cacheSize = Object.keys(require.cache).length;
                        return cacheSize > 500;
                    }
                    return false;
                },
                description: 'Jest module cache has grown excessively large',
                fix: 'Use jest.resetModules() in test cleanup',
                severity: 'medium'
            },
            {
                name: 'DOM Node Accumulation',
                detector: () => {
                    if (typeof document !== 'undefined') {
                        const nodeCount = document.querySelectorAll('*').length;
                        return nodeCount > 1000;
                    }
                    return false;
                },
                description: 'Too many DOM nodes accumulated during testing',
                fix: 'Clear document.body.innerHTML in afterEach hooks',
                severity: 'high'
            },
            {
                name: 'Global Reference Accumulation',
                detector: () => {
                    if (global.__TEST_REFS__) {
                        return global.__TEST_REFS__.length > 50;
                    }
                    return false;
                },
                description: 'Too many global test references accumulated',
                fix: 'Clear global.__TEST_REFS__ in test cleanup',
                severity: 'medium'
            }
        ];
    }
    /**
     * Scan for memory leaks and return detailed report
     */
    scanForLeaks() {
        const currentMemory = process.memoryUsage().heapUsed;
        const memoryIncrease = currentMemory - this.baseline;
        const leaksDetected = this.patterns.filter(pattern => {
            try {
                return pattern.detector();
            }
            catch (error) {
                console.warn(`Error checking pattern ${pattern.name}:`, error);
                return false;
            }
        });
        const recommendations = this.generateRecommendations(leaksDetected, memoryIncrease);
        return {
            leaksDetected,
            recommendations,
            memoryUsage: {
                current: currentMemory / (1024 * 1024),
                baseline: this.baseline / (1024 * 1024),
                increase: memoryIncrease / (1024 * 1024) // MB
            },
            timestamp: new Date().toISOString()
        };
    }
    generateRecommendations(leaks, memoryIncrease) {
        const recommendations = [];
        // Memory-specific recommendations
        const memoryIncreaseMB = memoryIncrease / (1024 * 1024);
        if (memoryIncreaseMB > 100) {
            recommendations.push('Consider reducing test complexity or splitting large test suites');
        }
        if (memoryIncreaseMB > 200) {
            recommendations.push('Implement more aggressive cleanup strategies');
        }
        // Pattern-specific recommendations
        const criticalLeaks = leaks.filter(leak => leak.severity === 'critical');
        const highLeaks = leaks.filter(leak => leak.severity === 'high');
        if (criticalLeaks.length > 0) {
            recommendations.push('CRITICAL: Address critical memory leaks immediately');
            criticalLeaks.forEach(leak => recommendations.push(`- ${leak.fix}`));
        }
        if (highLeaks.length > 0) {
            recommendations.push('HIGH PRIORITY: Fix high-severity memory leaks');
            highLeaks.forEach(leak => recommendations.push(`- ${leak.fix}`));
        }
        // General recommendations
        if (leaks.length > 3) {
            recommendations.push('Consider implementing a comprehensive test cleanup strategy');
        }
        if (recommendations.length === 0) {
            recommendations.push('No significant memory leaks detected');
        }
        return recommendations;
    }
    /**
     * Apply automatic fixes for detected leaks
     */
    applyAutomaticFixes() {
        const fixed = [];
        const failed = [];
        try {
            // Fix 1: Clear excessive event listeners
            if (typeof window !== 'undefined' && window._eventListeners) {
                Object.keys(window._eventListeners).forEach(eventType => {
                    const listeners = window._eventListeners[eventType] || [];
                    listeners.forEach((listener) => {
                        try {
                            window.removeEventListener(eventType, listener);
                        }
                        catch (error) {
                            // Ignore errors for already removed listeners
                        }
                    });
                });
                window._eventListeners = {};
                fixed.push('Cleared excessive event listeners');
            }
        }
        catch (error) {
            failed.push('Failed to clear event listeners');
        }
        try {
            // Fix 2: Clear test cache
            if (global.__TEST_CACHE__) {
                if (typeof global.__TEST_CACHE__.clear === 'function') {
                    global.__TEST_CACHE__.clear();
                }
                else {
                    global.__TEST_CACHE__ = new Map();
                }
                fixed.push('Cleared test cache');
            }
        }
        catch (error) {
            failed.push('Failed to clear test cache');
        }
        try {
            // Fix 3: Clear DOM nodes
            if (typeof document !== 'undefined') {
                document.body.innerHTML = '';
                fixed.push('Cleared DOM nodes');
            }
        }
        catch (error) {
            failed.push('Failed to clear DOM nodes');
        }
        try {
            // Fix 4: Clear global references
            if (global.__TEST_REFS__) {
                global.__TEST_REFS__.length = 0;
                fixed.push('Cleared global test references');
            }
        }
        catch (error) {
            failed.push('Failed to clear global references');
        }
        try {
            // Fix 5: Reset Jest modules
            if (jest && jest.resetModules) {
                jest.resetModules();
                fixed.push('Reset Jest modules');
            }
        }
        catch (error) {
            failed.push('Failed to reset Jest modules');
        }
        try {
            // Fix 6: Force garbage collection
            if (global.gc) {
                global.gc();
                fixed.push('Forced garbage collection');
            }
        }
        catch (error) {
            failed.push('Failed to force garbage collection');
        }
        return { fixed, failed };
    }
    /**
     * Generate detailed memory leak report
     */
    generateDetailedReport() {
        const report = this.scanForLeaks();
        let output = `
Memory Leak Detection Report
============================
Generated: ${report.timestamp}

Memory Usage:
- Current: ${report.memoryUsage.current.toFixed(2)}MB
- Baseline: ${report.memoryUsage.baseline.toFixed(2)}MB
- Increase: ${report.memoryUsage.increase.toFixed(2)}MB

`;
        if (report.leaksDetected.length > 0) {
            output += `Detected Memory Leaks (${report.leaksDetected.length}):\n`;
            report.leaksDetected.forEach((leak, index) => {
                output += `${index + 1}. ${leak.name} (${leak.severity.toUpperCase()})\n`;
                output += `   Description: ${leak.description}\n`;
                output += `   Fix: ${leak.fix}\n\n`;
            });
        }
        else {
            output += 'No memory leaks detected.\n\n';
        }
        output += 'Recommendations:\n';
        report.recommendations.forEach((rec, index) => {
            output += `${index + 1}. ${rec}\n`;
        });
        return output;
    }
    /**
     * Reset baseline for new test suite
     */
    resetBaseline() {
        this.baseline = process.memoryUsage().heapUsed;
    }
    /**
     * Static method to create detector and run quick scan
     */
    static quickScan() {
        const detector = new MemoryLeakDetector();
        return detector.scanForLeaks();
    }
    /**
     * Static method to apply emergency fixes
     */
    static emergencyCleanup() {
        const detector = new MemoryLeakDetector();
        return detector.applyAutomaticFixes();
    }
}
exports.MemoryLeakDetector = MemoryLeakDetector;
exports.default = MemoryLeakDetector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvTWVtb3J5TGVha0RldGVjdG9yLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBcUJILE1BQWEsa0JBQWtCO0lBSTdCO1FBQ0UsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDO1FBQy9DLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUMsQ0FBQztJQUVPLGtCQUFrQjtRQUN4QixPQUFPO1lBQ0w7Z0JBQ0UsSUFBSSxFQUFFLDJCQUEyQjtnQkFDakMsUUFBUSxFQUFFLEdBQUcsRUFBRTtvQkFDYixJQUFJLE9BQU8sTUFBTSxLQUFLLFdBQVcsSUFBSyxNQUFjLENBQUMsZUFBZSxFQUFFO3dCQUNwRSxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFLE1BQWMsQ0FBQyxlQUFlLENBQUM7NkJBQ2xFLE1BQU0sQ0FBQyxDQUFDLEdBQVcsRUFBRSxTQUFjLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUEsU0FBUyxhQUFULFNBQVMsdUJBQVQsU0FBUyxDQUFFLE1BQU0sS0FBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQzt3QkFDOUUsT0FBTyxjQUFjLEdBQUcsRUFBRSxDQUFDO3FCQUM1QjtvQkFDRCxPQUFPLEtBQUssQ0FBQztnQkFDZixDQUFDO2dCQUNELFdBQVcsRUFBRSxtREFBbUQ7Z0JBQ2hFLEdBQUcsRUFBRSxpRUFBaUU7Z0JBQ3RFLFFBQVEsRUFBRSxNQUFNO2FBQ2pCO1lBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLGlCQUFpQjtnQkFDdkIsUUFBUSxFQUFFLEdBQUcsRUFBRTtvQkFDYix1REFBdUQ7b0JBQ3ZELE1BQU0sWUFBWSxHQUFJLE1BQWMsQ0FBQyxhQUFhLElBQUksRUFBRSxDQUFDO29CQUN6RCxPQUFPLFlBQVksQ0FBQyxNQUFN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SUFBSSxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsYUFBYTtRQUNYLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQztJQUNqRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsU0FBUztRQUNkLE1BQU0sUUFBUSxHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUMxQyxPQUFPLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsZ0JBQWdCO1FBQ3JCLE1BQU0sUUFBUSxHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUMxQyxPQUFPLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQ3hDLENBQUM7Q0FDRjtBQXZURCxnREF1VEM7QUFFRCxrQkFBZSxrQkFBa0IsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL19fdGVzdHNfXy91dGlscy9NZW1vcnlMZWFrRGV0ZWN0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNZW1vcnkgTGVhayBEZXRlY3RvciBmb3IgVGVzdCBFbnZpcm9ubWVudFxuICogXG4gKiBEZXRlY3RzIGNvbW1vbiBtZW1vcnkgbGVhayBwYXR0ZXJucyBpbiB0ZXN0cyBhbmQgcHJvdmlkZXNcbiAqIHNwZWNpZmljIHJlY29tbWVuZGF0aW9ucyBmb3IgZml4aW5nIHRoZW0uXG4gKi9cblxuaW50ZXJmYWNlIE1lbW9yeUxlYWtQYXR0ZXJuIHtcbiAgbmFtZTogc3RyaW5nO1xuICBkZXRlY3RvcjogKCkgPT4gYm9vbGVhbjtcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgZml4OiBzdHJpbmc7XG4gIHNldmVyaXR5OiAnbG93JyB8ICdtZWRpdW0nIHwgJ2hpZ2gnIHwgJ2NyaXRpY2FsJztcbn1cblxuaW50ZXJmYWNlIE1lbW9yeUxlYWtSZXBvcnQge1xuICBsZWFrc0RldGVjdGVkOiBNZW1vcnlMZWFrUGF0dGVybltdO1xuICByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdO1xuICBtZW1vcnlVc2FnZToge1xuICAgIGN1cnJlbnQ6IG51bWJlcjtcbiAgICBiYXNlbGluZTogbnVtYmVyO1xuICAgIGluY3JlYXNlOiBudW1iZXI7XG4gIH07XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgTWVtb3J5TGVha0RldGVjdG9yIHtcbiAgcHJpdmF0ZSBiYXNlbGluZTogbnVtYmVyO1xuICBwcml2YXRlIHBhdHRlcm5zOiBNZW1vcnlMZWFrUGF0dGVybltdO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYmFzZWxpbmUgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG4gICAgdGhpcy5wYXR0ZXJucyA9IHRoaXMuaW5pdGlhbGl6ZVBhdHRlcm5zKCk7XG4gIH1cblxuICBwcml2YXRlIGluaXRpYWxpemVQYXR0ZXJucygpOiBNZW1vcnlMZWFrUGF0dGVybltdIHtcbiAgICByZXR1cm4gW1xuICAgICAge1xuICAgICAgICBuYW1lOiAnRXhjZXNzaXZlIEV2ZW50IExpc3RlbmVycycsXG4gICAgICAgIGRldGVjdG9yOiAoKSA9PiB7XG4gICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICh3aW5kb3cgYXMgYW55KS5fZXZlbnRMaXN0ZW5lcnMpIHtcbiAgICAgICAgICAgIGNvbnN0IHRvdGFsTGlzdGVuZXJzID0gT2JqZWN0LnZhbHVlcygod2luZG93IGFzIGFueSkuX2V2ZW50TGlzdGVuZXJzKVxuICAgICAgICAgICAgICAucmVkdWNlKChzdW06IG51bWJlciwgbGlzdGVuZXJzOiBhbnkpID0+IHN1bSArIChsaXN0ZW5lcnM/Lmxlbmd0aCB8fCAwKSwgMCk7XG4gICAgICAgICAgICByZXR1cm4gdG90YWxMaXN0ZW5lcnMgPiA1MDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9LFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RvbyBtYW55IGV2ZW50IGxpc3RlbmVycyBhdHRhY2hlZCB0byBET00gZWxlbWVudHMnLFxuICAgICAgICBmaXg6ICdSZW1vdmUgZXZlbnQgbGlzdGVuZXJzIGluIHRlc3QgY2xlYW51cCBvciB1c2UgY2xlYW51cCB1dGlsaXRpZXMnLFxuICAgICAgICBzZXZlcml0eTogJ2hpZ2gnXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBuYW1lOiAnVW5jbG9zZWQgVGltZXJzJyxcbiAgICAgICAgZGV0ZWN0b3I6ICgpID0+IHtcbiAgICAgICAgICAvLyBDaGVjayBmb3IgYWN0aXZlIHRpbWVycyAodGhpcyBpcyBhIHNpbXBsaWZpZWQgY2hlY2spXG4gICAgICAgICAgY29uc3QgYWN0aXZlVGltZXJzID0gKGdsb2JhbCBhcyBhbnkpLl9hY3RpdmVUaW1lcnMgfHwgW107XG4gICAgICAgICAgcmV0dXJuIGFjdGl2ZVRpbWVycy5sZW5ndGggPiAxMDtcbiAgICAgICAgfSxcbiAgICAgICAgZGVzY3JpcHRpb246ICdBY3RpdmUgdGltZXJzIG5vdCBjbGVhcmVkIGFmdGVyIHRlc3RzJyxcbiAgICAgICAgZml4OiAnQ2xlYXIgYWxsIHRpbWVycyBpbiBhZnRlckVhY2ggaG9va3MgdXNpbmcgY2xlYXJUaW1lb3V0L2NsZWFySW50ZXJ2YWwnLFxuICAgICAgICBzZXZlcml0eTogJ21lZGl1bSdcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdMYXJnZSBUZXN0IENhY2hlJyxcbiAgICAgICAgZGV0ZWN0b3I6ICgpID0+IHtcbiAgICAgICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9DQUNIRV9fICYmIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXyBpbnN0YW5jZW9mIE1hcCkge1xuICAgICAgICAgICAgcmV0dXJuIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXy5zaXplID4gMTAwO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0sXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGVzdCBjYWNoZSBoYXMgZ3Jvd24gdG9vIGxhcmdlJyxcbiAgICAgICAgZml4OiAnQ2xlYXIgdGVzdCBjYWNoZSByZWd1bGFybHkgb3IgaW1wbGVtZW50IGNhY2hlIHNpemUgbGltaXRzJyxcbiAgICAgICAgc2V2ZXJpdHk6ICdtZWRpdW0nXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBuYW1lOiAnTWVtb3J5IEdyb3d0aCBQYXR0ZXJuJyxcbiAgICAgICAgZGV0ZWN0b3I6ICgpID0+IHtcbiAgICAgICAgICBjb25zdCBjdXJyZW50ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgICAgICAgIGNvbnN0IGdyb3d0aCA9IChjdXJyZW50IC0gdGhpcy5iYXNlbGluZSkgLyAoMTAyNCAqIDEwMjQpO1xuICAgICAgICAgIHJldHVybiBncm93dGggPiAyMDA7IC8vIDIwME1CIGdyb3d0aFxuICAgICAgICB9LFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1NpZ25pZmljYW50IG1lbW9yeSBncm93dGggZGV0ZWN0ZWQgZHVyaW5nIHRlc3QgZXhlY3V0aW9uJyxcbiAgICAgICAgZml4OiAnUmV2aWV3IHRlc3Qgc2V0dXAvdGVhcmRvd24gYW5kIGVuc3VyZSBwcm9wZXIgY2xlYW51cCcsXG4gICAgICAgIHNldmVyaXR5OiAnY3JpdGljYWwnXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBuYW1lOiAnSmVzdCBNb2R1bGUgQ2FjaGUgQmxvYXQnLFxuICAgICAgICBkZXRlY3RvcjogKCkgPT4ge1xuICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcgJiYgcmVxdWlyZS5jYWNoZSkge1xuICAgICAgICAgICAgY29uc3QgY2FjaGVTaXplID0gT2JqZWN0LmtleXMocmVxdWlyZS5jYWNoZSkubGVuZ3RoO1xuICAgICAgICAgICAgcmV0dXJuIGNhY2hlU2l6ZSA+IDUwMDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9LFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0plc3QgbW9kdWxlIGNhY2hlIGhhcyBncm93biBleGNlc3NpdmVseSBsYXJnZScsXG4gICAgICAgIGZpeDogJ1VzZSBqZXN0LnJlc2V0TW9kdWxlcygpIGluIHRlc3QgY2xlYW51cCcsXG4gICAgICAgIHNldmVyaXR5OiAnbWVkaXVtJ1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbmFtZTogJ0RPTSBOb2RlIEFjY3VtdWxhdGlvbicsXG4gICAgICAgIGRldGVjdG9yOiAoKSA9PiB7XG4gICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVDb3VudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJyonKS5sZW5ndGg7XG4gICAgICAgICAgICByZXR1cm4gbm9kZUNvdW50ID4gMTAwMDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9LFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RvbyBtYW55IERPTSBub2RlcyBhY2N1bXVsYXRlZCBkdXJpbmcgdGVzdGluZycsXG4gICAgICAgIGZpeDogJ0NsZWFyIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MIGluIGFmdGVyRWFjaCBob29rcycsXG4gICAgICAgIHNldmVyaXR5OiAnaGlnaCdcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdHbG9iYWwgUmVmZXJlbmNlIEFjY3VtdWxhdGlvbicsXG4gICAgICAgIGRldGVjdG9yOiAoKSA9PiB7XG4gICAgICAgICAgaWYgKGdsb2JhbC5fX1RFU1RfUkVGU19fKSB7XG4gICAgICAgICAgICByZXR1cm4gZ2xvYmFsLl9fVEVTVF9SRUZTX18ubGVuZ3RoID4gNTA7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUb28gbWFueSBnbG9iYWwgdGVzdCByZWZlcmVuY2VzIGFjY3VtdWxhdGVkJyxcbiAgICAgICAgZml4OiAnQ2xlYXIgZ2xvYmFsLl9fVEVTVF9SRUZTX18gaW4gdGVzdCBjbGVhbnVwJyxcbiAgICAgICAgc2V2ZXJpdHk6ICdtZWRpdW0nXG4gICAgICB9XG4gICAgXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTY2FuIGZvciBtZW1vcnkgbGVha3MgYW5kIHJldHVybiBkZXRhaWxlZCByZXBvcnRcbiAgICovXG4gIHNjYW5Gb3JMZWFrcygpOiBNZW1vcnlMZWFrUmVwb3J0IHtcbiAgICBjb25zdCBjdXJyZW50TWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgIGNvbnN0IG1lbW9yeUluY3JlYXNlID0gY3VycmVudE1lbW9yeSAtIHRoaXMuYmFzZWxpbmU7XG5cbiAgICBjb25zdCBsZWFrc0RldGVjdGVkID0gdGhpcy5wYXR0ZXJucy5maWx0ZXIocGF0dGVybiA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gcGF0dGVybi5kZXRlY3RvcigpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBFcnJvciBjaGVja2luZyBwYXR0ZXJuICR7cGF0dGVybi5uYW1lfTpgLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHJlY29tbWVuZGF0aW9ucyA9IHRoaXMuZ2VuZXJhdGVSZWNvbW1lbmRhdGlvbnMobGVha3NEZXRlY3RlZCwgbWVtb3J5SW5jcmVhc2UpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGxlYWtzRGV0ZWN0ZWQsXG4gICAgICByZWNvbW1lbmRhdGlvbnMsXG4gICAgICBtZW1vcnlVc2FnZToge1xuICAgICAgICBjdXJyZW50OiBjdXJyZW50TWVtb3J5IC8gKDEwMjQgKiAxMDI0KSwgLy8gTUJcbiAgICAgICAgYmFzZWxpbmU6IHRoaXMuYmFzZWxpbmUgLyAoMTAyNCAqIDEwMjQpLCAvLyBNQlxuICAgICAgICBpbmNyZWFzZTogbWVtb3J5SW5jcmVhc2UgLyAoMTAyNCAqIDEwMjQpIC8vIE1CXG4gICAgICB9LFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZVJlY29tbWVuZGF0aW9ucyhsZWFrczogTWVtb3J5TGVha1BhdHRlcm5bXSwgbWVtb3J5SW5jcmVhc2U6IG51bWJlcik6IHN0cmluZ1tdIHtcbiAgICBjb25zdCByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBNZW1vcnktc3BlY2lmaWMgcmVjb21tZW5kYXRpb25zXG4gICAgY29uc3QgbWVtb3J5SW5jcmVhc2VNQiA9IG1lbW9yeUluY3JlYXNlIC8gKDEwMjQgKiAxMDI0KTtcbiAgICBpZiAobWVtb3J5SW5jcmVhc2VNQiA+IDEwMCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ0NvbnNpZGVyIHJlZHVjaW5nIHRlc3QgY29tcGxleGl0eSBvciBzcGxpdHRpbmcgbGFyZ2UgdGVzdCBzdWl0ZXMnKTtcbiAgICB9XG4gICAgaWYgKG1lbW9yeUluY3JlYXNlTUIgPiAyMDApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdJbXBsZW1lbnQgbW9yZSBhZ2dyZXNzaXZlIGNsZWFudXAgc3RyYXRlZ2llcycpO1xuICAgIH1cblxuICAgIC8vIFBhdHRlcm4tc3BlY2lmaWMgcmVjb21tZW5kYXRpb25zXG4gICAgY29uc3QgY3JpdGljYWxMZWFrcyA9IGxlYWtzLmZpbHRlcihsZWFrID0+IGxlYWsuc2V2ZXJpdHkgPT09ICdjcml0aWNhbCcpO1xuICAgIGNvbnN0IGhpZ2hMZWFrcyA9IGxlYWtzLmZpbHRlcihsZWFrID0+IGxlYWsuc2V2ZXJpdHkgPT09ICdoaWdoJyk7XG5cbiAgICBpZiAoY3JpdGljYWxMZWFrcy5sZW5ndGggPiAwKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnQ1JJVElDQUw6IEFkZHJlc3MgY3JpdGljYWwgbWVtb3J5IGxlYWtzIGltbWVkaWF0ZWx5Jyk7XG4gICAgICBjcml0aWNhbExlYWtzLmZvckVhY2gobGVhayA9PiByZWNvbW1lbmRhdGlvbnMucHVzaChgLSAke2xlYWsuZml4fWApKTtcbiAgICB9XG5cbiAgICBpZiAoaGlnaExlYWtzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdISUdIIFBSSU9SSVRZOiBGaXggaGlnaC1zZXZlcml0eSBtZW1vcnkgbGVha3MnKTtcbiAgICAgIGhpZ2hMZWFrcy5mb3JFYWNoKGxlYWsgPT4gcmVjb21tZW5kYXRpb25zLnB1c2goYC0gJHtsZWFrLmZpeH1gKSk7XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhbCByZWNvbW1lbmRhdGlvbnNcbiAgICBpZiAobGVha3MubGVuZ3RoID4gMykge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ0NvbnNpZGVyIGltcGxlbWVudGluZyBhIGNvbXByZWhlbnNpdmUgdGVzdCBjbGVhbnVwIHN0cmF0ZWd5Jyk7XG4gICAgfVxuXG4gICAgaWYgKHJlY29tbWVuZGF0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdObyBzaWduaWZpY2FudCBtZW1vcnkgbGVha3MgZGV0ZWN0ZWQnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVjb21tZW5kYXRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIEFwcGx5IGF1dG9tYXRpYyBmaXhlcyBmb3IgZGV0ZWN0ZWQgbGVha3NcbiAgICovXG4gIGFwcGx5QXV0b21hdGljRml4ZXMoKTogeyBmaXhlZDogc3RyaW5nW10sIGZhaWxlZDogc3RyaW5nW10gfSB7XG4gICAgY29uc3QgZml4ZWQ6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZmFpbGVkOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEZpeCAxOiBDbGVhciBleGNlc3NpdmUgZXZlbnQgbGlzdGVuZXJzXG4gICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHdpbmRvdyBhcyBhbnkpLl9ldmVudExpc3RlbmVycykge1xuICAgICAgICBPYmplY3Qua2V5cygod2luZG93IGFzIGFueSkuX2V2ZW50TGlzdGVuZXJzKS5mb3JFYWNoKGV2ZW50VHlwZSA9PiB7XG4gICAgICAgICAgY29uc3QgbGlzdGVuZXJzID0gKHdpbmRvdyBhcyBhbnkpLl9ldmVudExpc3RlbmVyc1tldmVudFR5cGVdIHx8IFtdO1xuICAgICAgICAgIGxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjogYW55KSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgZm9yIGFscmVhZHkgcmVtb3ZlZCBsaXN0ZW5lcnNcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgICh3aW5kb3cgYXMgYW55KS5fZXZlbnRMaXN0ZW5lcnMgPSB7fTtcbiAgICAgICAgZml4ZWQucHVzaCgnQ2xlYXJlZCBleGNlc3NpdmUgZXZlbnQgbGlzdGVuZXJzJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGZhaWxlZC5wdXNoKCdGYWlsZWQgdG8gY2xlYXIgZXZlbnQgbGlzdGVuZXJzJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEZpeCAyOiBDbGVhciB0ZXN0IGNhY2hlXG4gICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9DQUNIRV9fKSB7XG4gICAgICAgIGlmICh0eXBlb2YgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fID0gbmV3IE1hcCgpO1xuICAgICAgICB9XG4gICAgICAgIGZpeGVkLnB1c2goJ0NsZWFyZWQgdGVzdCBjYWNoZScpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBmYWlsZWQucHVzaCgnRmFpbGVkIHRvIGNsZWFyIHRlc3QgY2FjaGUnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gRml4IDM6IENsZWFyIERPTSBub2Rlc1xuICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgZml4ZWQucHVzaCgnQ2xlYXJlZCBET00gbm9kZXMnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZmFpbGVkLnB1c2goJ0ZhaWxlZCB0byBjbGVhciBET00gbm9kZXMnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gRml4IDQ6IENsZWFyIGdsb2JhbCByZWZlcmVuY2VzXG4gICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9SRUZTX18pIHtcbiAgICAgICAgZ2xvYmFsLl9fVEVTVF9SRUZTX18ubGVuZ3RoID0gMDtcbiAgICAgICAgZml4ZWQucHVzaCgnQ2xlYXJlZCBnbG9iYWwgdGVzdCByZWZlcmVuY2VzJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGZhaWxlZC5wdXNoKCdGYWlsZWQgdG8gY2xlYXIgZ2xvYmFsIHJlZmVyZW5jZXMnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gRml4IDU6IFJlc2V0IEplc3QgbW9kdWxlc1xuICAgICAgaWYgKGplc3QgJiYgamVzdC5yZXNldE1vZHVsZXMpIHtcbiAgICAgICAgamVzdC5yZXNldE1vZHVsZXMoKTtcbiAgICAgICAgZml4ZWQucHVzaCgnUmVzZXQgSmVzdCBtb2R1bGVzJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGZhaWxlZC5wdXNoKCdGYWlsZWQgdG8gcmVzZXQgSmVzdCBtb2R1bGVzJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEZpeCA2OiBGb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb25cbiAgICAgIGlmIChnbG9iYWwuZ2MpIHtcbiAgICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgICAgIGZpeGVkLnB1c2goJ0ZvcmNlZCBnYXJiYWdlIGNvbGxlY3Rpb24nKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZmFpbGVkLnB1c2goJ0ZhaWxlZCB0byBmb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb24nKTtcbiAgICB9XG5cbiAgICByZXR1cm4geyBmaXhlZCwgZmFpbGVkIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgZGV0YWlsZWQgbWVtb3J5IGxlYWsgcmVwb3J0XG4gICAqL1xuICBnZW5lcmF0ZURldGFpbGVkUmVwb3J0KCk6IHN0cmluZyB7XG4gICAgY29uc3QgcmVwb3J0ID0gdGhpcy5zY2FuRm9yTGVha3MoKTtcbiAgICBcbiAgICBsZXQgb3V0cHV0ID0gYFxuTWVtb3J5IExlYWsgRGV0ZWN0aW9uIFJlcG9ydFxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuR2VuZXJhdGVkOiAke3JlcG9ydC50aW1lc3RhbXB9XG5cbk1lbW9yeSBVc2FnZTpcbi0gQ3VycmVudDogJHtyZXBvcnQubWVtb3J5VXNhZ2UuY3VycmVudC50b0ZpeGVkKDIpfU1CXG4tIEJhc2VsaW5lOiAke3JlcG9ydC5tZW1vcnlVc2FnZS5iYXNlbGluZS50b0ZpeGVkKDIpfU1CXG4tIEluY3JlYXNlOiAke3JlcG9ydC5tZW1vcnlVc2FnZS5pbmNyZWFzZS50b0ZpeGVkKDIpfU1CXG5cbmA7XG5cbiAgICBpZiAocmVwb3J0LmxlYWtzRGV0ZWN0ZWQubGVuZ3RoID4gMCkge1xuICAgICAgb3V0cHV0ICs9IGBEZXRlY3RlZCBNZW1vcnkgTGVha3MgKCR7cmVwb3J0LmxlYWtzRGV0ZWN0ZWQubGVuZ3RofSk6XFxuYDtcbiAgICAgIHJlcG9ydC5sZWFrc0RldGVjdGVkLmZvckVhY2goKGxlYWssIGluZGV4KSA9PiB7XG4gICAgICAgIG91dHB1dCArPSBgJHtpbmRleCArIDF9LiAke2xlYWsubmFtZX0gKCR7bGVhay5zZXZlcml0eS50b1VwcGVyQ2FzZSgpfSlcXG5gO1xuICAgICAgICBvdXRwdXQgKz0gYCAgIERlc2NyaXB0aW9uOiAke2xlYWsuZGVzY3JpcHRpb259XFxuYDtcbiAgICAgICAgb3V0cHV0ICs9IGAgICBGaXg6ICR7bGVhay5maXh9XFxuXFxuYDtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXRwdXQgKz0gJ05vIG1lbW9yeSBsZWFrcyBkZXRlY3RlZC5cXG5cXG4nO1xuICAgIH1cblxuICAgIG91dHB1dCArPSAnUmVjb21tZW5kYXRpb25zOlxcbic7XG4gICAgcmVwb3J0LnJlY29tbWVuZGF0aW9ucy5mb3JFYWNoKChyZWMsIGluZGV4KSA9PiB7XG4gICAgICBvdXRwdXQgKz0gYCR7aW5kZXggKyAxfS4gJHtyZWN9XFxuYDtcbiAgICB9KTtcblxuICAgIHJldHVybiBvdXRwdXQ7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgYmFzZWxpbmUgZm9yIG5ldyB0ZXN0IHN1aXRlXG4gICAqL1xuICByZXNldEJhc2VsaW5lKCk6IHZvaWQge1xuICAgIHRoaXMuYmFzZWxpbmUgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG4gIH1cblxuICAvKipcbiAgICogU3RhdGljIG1ldGhvZCB0byBjcmVhdGUgZGV0ZWN0b3IgYW5kIHJ1biBxdWljayBzY2FuXG4gICAqL1xuICBzdGF0aWMgcXVpY2tTY2FuKCk6IE1lbW9yeUxlYWtSZXBvcnQge1xuICAgIGNvbnN0IGRldGVjdG9yID0gbmV3IE1lbW9yeUxlYWtEZXRlY3RvcigpO1xuICAgIHJldHVybiBkZXRlY3Rvci5zY2FuRm9yTGVha3MoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGF0aWMgbWV0aG9kIHRvIGFwcGx5IGVtZXJnZW5jeSBmaXhlc1xuICAgKi9cbiAgc3RhdGljIGVtZXJnZW5jeUNsZWFudXAoKTogeyBmaXhlZDogc3RyaW5nW10sIGZhaWxlZDogc3RyaW5nW10gfSB7XG4gICAgY29uc3QgZGV0ZWN0b3IgPSBuZXcgTWVtb3J5TGVha0RldGVjdG9yKCk7XG4gICAgcmV0dXJuIGRldGVjdG9yLmFwcGx5QXV0b21hdGljRml4ZXMoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBNZW1vcnlMZWFrRGV0ZWN0b3I7Il0sInZlcnNpb24iOjN9