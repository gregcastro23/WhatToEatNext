8143bc46488cceb497da431bc8db0c65
"use strict";
/**
 * Memory Management Setup for Jest Tests
 *
 * This file configures memory management, garbage collection hints,
 * and cleanup procedures for the test environment.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.MEMORY_CONFIG = exports.performEmergencyCleanup = exports.TestMemoryMonitor = void 0;
const TestMemoryMonitor_1 = require("./utils/TestMemoryMonitor");
Object.defineProperty(exports, "TestMemoryMonitor", { enumerable: true, get: function () { return TestMemoryMonitor_1.TestMemoryMonitor; } });
// Global memory monitor instance
let globalMemoryMonitor = null;
// Memory management configuration
const MEMORY_CONFIG = {
    // Enable garbage collection hints
    enableGC: true,
    // Memory check frequency (every N tests)
    checkFrequency: 5,
    // Force cleanup after memory-intensive tests
    forceCleanupThreshold: 100,
    // Global memory limit before emergency cleanup
    emergencyCleanupThreshold: 500, // MB
};
exports.MEMORY_CONFIG = MEMORY_CONFIG;
// Test counter for periodic memory checks
let testCounter = 0;
/**
 * Initialize global memory monitoring
 */
function initializeMemoryMonitoring() {
    // Create memory monitor with CI-appropriate settings
    globalMemoryMonitor = process.env.CI
        ? TestMemoryMonitor_1.TestMemoryMonitor.createForCI()
        : TestMemoryMonitor_1.TestMemoryMonitor.createDefault();
    // Set up global test cache if not exists
    if (!global.__TEST_CACHE__) {
        global.__TEST_CACHE__ = new Map();
    }
    // Set up global test references array
    if (!global.__TEST_REFS__) {
        global.__TEST_REFS__ = [];
    }
    console.log('Memory monitoring initialized');
}
/**
 * Perform periodic memory checks
 */
function performPeriodicMemoryCheck() {
    testCounter++;
    if (testCounter % MEMORY_CONFIG.checkFrequency === 0 && globalMemoryMonitor) {
        const memoryCheck = globalMemoryMonitor.checkMemoryUsage(`periodic-check-${testCounter}`);
        if (!memoryCheck.isWithinLimits) {
            console.warn(`Memory check failed at test ${testCounter}:`, memoryCheck.errors);
            // Force cleanup if memory usage is too high
            const currentMemoryMB = memoryCheck.currentUsage.heapUsed / (1024 * 1024);
            if (currentMemoryMB > MEMORY_CONFIG.emergencyCleanupThreshold) {
                console.warn('Emergency memory cleanup triggered');
                performEmergencyCleanup();
            }
        }
    }
}
/**
 * Emergency memory cleanup procedure
 */
function performEmergencyCleanup() {
    if (globalMemoryMonitor != null) {
        globalMemoryMonitor.cleanup('emergency-cleanup');
    }
    // Clear all global caches
    if (global.__TEST_CACHE__) {
        if (typeof global.__TEST_CACHE__.clear === 'function') {
            global.__TEST_CACHE__.clear();
        }
        else {
            global.__TEST_CACHE__ = new Map();
        }
    }
    // Clear test references
    if (global.__TEST_REFS__) {
        global.__TEST_REFS__.length = 0;
    }
    // Force garbage collection if available
    if (global.gc) {
        try {
            global.gc();
            console.log('Emergency garbage collection performed');
        }
        catch (error) {
            console.warn('Failed to perform emergency garbage collection:', error);
        }
    }
    // Reset Jest modules to free memory
    if (jest?.resetModules) {
        jest.resetModules();
    }
}
exports.performEmergencyCleanup = performEmergencyCleanup;
/**
 * Setup memory management hooks
 */
function setupMemoryHooks() {
    // Before each test suite
    beforeAll(() => {
        if (globalMemoryMonitor != null) {
            globalMemoryMonitor.takeSnapshot('suite-start');
        }
    });
    // Before each test
    beforeEach(() => {
        performPeriodicMemoryCheck();
        // Clear mocks and reset modules for memory efficiency
        jest.clearAllMocks();
        // Take memory snapshot for memory-intensive tests
        if (globalMemoryMonitor && expect.getState().currentTestName) {
            const testName = expect.getState().currentTestName;
            if (testName && (testName.toLowerCase().includes('memory') ||
                testName.toLowerCase().includes('performance') ||
                testName.toLowerCase().includes('integration'))) {
                globalMemoryMonitor.takeSnapshot(`before-${testName}`);
            }
        }
    });
    // After each test
    afterEach(() => {
        if (globalMemoryMonitor != null) {
            const testName = expect.getState().currentTestName || 'unknown-test';
            const memoryCheck = globalMemoryMonitor.checkMemoryUsage(`after-${testName}`);
            // Force cleanup for memory-intensive tests or if memory usage is high
            const currentMemoryMB = memoryCheck.currentUsage.heapUsed / (1024 * 1024);
            if (currentMemoryMB > MEMORY_CONFIG.forceCleanupThreshold ||
                testName.toLowerCase().includes('memory') ||
                testName.toLowerCase().includes('integration')) {
                globalMemoryMonitor.cleanup(testName);
            }
            // Log warnings if memory usage is concerning
            if (memoryCheck.warnings.length > 0) {
                console.warn(`Memory warnings for test "${testName}":`, memoryCheck.warnings);
            }
        }
        // Clear any test-specific global references
        if (global.__TEST_REFS__) {
            global.__TEST_REFS__.length = 0;
        }
    });
    // After each test suite
    afterAll(() => {
        if (globalMemoryMonitor != null) {
            globalMemoryMonitor.takeSnapshot('suite-end');
            // Generate memory report for the suite
            const summary = globalMemoryMonitor.getMemorySummary();
            if (summary.totalIncrease > 50) { // 50MB threshold for reporting
                console.log('Memory usage summary for test suite:', {
                    initialMemory: `${summary.initialMemory.toFixed(2)}MB`,
                    finalMemory: `${summary.currentMemory.toFixed(2)}MB`,
                    peakMemory: `${summary.peakMemory.toFixed(2)}MB`,
                    totalIncrease: `${summary.totalIncrease.toFixed(2)}MB`,
                    duration: `${(summary.testDuration / 1000).toFixed(2)}s`
                });
            }
            // Perform final cleanup
            globalMemoryMonitor.cleanup('suite-cleanup');
        }
    });
}
/**
 * Add garbage collection hints
 */
function addGarbageCollectionHints() {
    // Add global utility for manual garbage collection
    global.forceGC = () => {
        if (global.gc) {
            try {
                global.gc();
                return true;
            }
            catch (error) {
                console.warn('Failed to force garbage collection:', error);
                return false;
            }
        }
        return false;
    };
    // Add memory monitoring utilities to global scope
    global.getMemoryUsage = () => {
        const usage = process.memoryUsage();
        return {
            heapUsed: `${(usage.heapUsed / 1024 / 1024).toFixed(2)}MB`,
            heapTotal: `${(usage.heapTotal / 1024 / 1024).toFixed(2)}MB`,
            external: `${(usage.external / 1024 / 1024).toFixed(2)}MB`,
            arrayBuffers: `${(usage.arrayBuffers / 1024 / 1024).toFixed(2)}MB`
        };
    };
    // Add cleanup utility
    global.cleanupTestMemory = () => {
        if (globalMemoryMonitor != null) {
            return globalMemoryMonitor.cleanup('manual-cleanup');
        }
        return null;
    };
}
/**
 * Configure process-level memory management
 */
function configureProcessMemory() {
    // Set Node?.js memory limits if not already set
    if (!process.env.NODE_OPTIONS?.includes('--max-old-space-size')) {
        // Set reasonable memory limit for tests (2GB)
        process.env.NODE_OPTIONS = (process.env.NODE_OPTIONS || '') + ' --max-old-space-size=2048';
    }
    // Enable garbage collection exposure if not already enabled
    if (!process.env.NODE_OPTIONS.includes('--expose-gc')) {
        process.env.NODE_OPTIONS = (process.env.NODE_OPTIONS || '') + ' --expose-gc';
    }
    // Handle process memory warnings
    process.on('warning', (warning) => {
        if (warning.name === 'MaxListenersExceededWarning' ||
            warning.message.includes('memory')) {
            console.warn('Process memory warning:', warning.message);
            // Trigger emergency cleanup on memory warnings
            if (warning.message.includes('memory') || warning.message.includes('heap')) {
                performEmergencyCleanup();
            }
        }
    });
    // Handle uncaught exceptions that might be memory-related
    process.on('uncaughtException', (error) => {
        if (error.message.includes('out of memory') ||
            error.message.includes('heap') ||
            error.name === 'RangeError') {
            console.error('Memory-related uncaught exception:', error.message);
            performEmergencyCleanup();
        }
    });
}
// Initialize memory management
try {
    initializeMemoryMonitoring();
    setupMemoryHooks();
    addGarbageCollectionHints();
    configureProcessMemory();
    console.log('Memory management setup completed successfully');
}
catch (error) {
    console.error('Failed to initialize memory management:', error);
}
exports.default = {};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vc2V0dXBNZW1vcnlNYW5hZ2VtZW50LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBRUgsaUVBQThEO0FBZ1I1RCxrR0FoUk8scUNBQWlCLE9BZ1JQO0FBOVFuQixpQ0FBaUM7QUFDakMsSUFBSSxtQkFBbUIsR0FBNkIsSUFBSSxDQUFDO0FBRXpELGtDQUFrQztBQUNsQyxNQUFNLGFBQWEsR0FBRztJQUNwQixrQ0FBa0M7SUFDbEMsUUFBUSxFQUFFLElBQUk7SUFDZCx5Q0FBeUM7SUFDekMsY0FBYyxFQUFFLENBQUM7SUFDakIsNkNBQTZDO0lBQzdDLHFCQUFxQixFQUFFLEdBQUc7SUFDMUIsK0NBQStDO0lBQy9DLHlCQUF5QixFQUFFLEdBQUcsRUFBRSxLQUFLO0NBQ3RDLENBQUM7QUFtUUEsc0NBQWE7QUFqUWYsMENBQTBDO0FBQzFDLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztBQUVwQjs7R0FFRztBQUNILFNBQVMsMEJBQTBCO0lBQ2pDLHFEQUFxRDtJQUNyRCxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDbEMsQ0FBQyxDQUFDLHFDQUFpQixDQUFDLFdBQVcsRUFBRTtRQUNqQyxDQUFDLENBQUMscUNBQWlCLENBQUMsYUFBYSxFQUFFLENBQUM7SUFFdEMseUNBQXlDO0lBQ3pDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFO1FBQzFCLE1BQU0sQ0FBQyxjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztLQUNuQztJQUVELHNDQUFzQztJQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRTtRQUN6QixNQUFNLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztLQUMzQjtJQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMvQyxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLDBCQUEwQjtJQUNqQyxX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WSxFQUFFO1lBQy9CLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25FLHVCQUF1QixFQUFFLENBQUM7U0FDM0I7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCwrQkFBK0I7QUFDL0IsSUFBSTtJQUNGLDBCQUEwQixFQUFFLENBQUM7SUFDN0IsZ0JBQWdCLEVBQUUsQ0FBQztJQUNuQix5QkFBeUIsRUFBRSxDQUFDO0lBQzVCLHNCQUFzQixFQUFFLENBQUM7SUFFekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0NBQy9EO0FBQUMsT0FBTyxLQUFLLEVBQUU7SUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLEtBQUssQ0FBQyxDQUFDO0NBQ2pFO0FBdUJELGtCQUFlLEVBQUUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL19fdGVzdHNfXy9zZXR1cE1lbW9yeU1hbmFnZW1lbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNZW1vcnkgTWFuYWdlbWVudCBTZXR1cCBmb3IgSmVzdCBUZXN0c1xuICogXG4gKiBUaGlzIGZpbGUgY29uZmlndXJlcyBtZW1vcnkgbWFuYWdlbWVudCwgZ2FyYmFnZSBjb2xsZWN0aW9uIGhpbnRzLFxuICogYW5kIGNsZWFudXAgcHJvY2VkdXJlcyBmb3IgdGhlIHRlc3QgZW52aXJvbm1lbnQuXG4gKi9cblxuaW1wb3J0IHsgVGVzdE1lbW9yeU1vbml0b3IgfSBmcm9tICcuL3V0aWxzL1Rlc3RNZW1vcnlNb25pdG9yJztcblxuLy8gR2xvYmFsIG1lbW9yeSBtb25pdG9yIGluc3RhbmNlXG5sZXQgZ2xvYmFsTWVtb3J5TW9uaXRvcjogVGVzdE1lbW9yeU1vbml0b3IgfCBudWxsID0gbnVsbDtcblxuLy8gTWVtb3J5IG1hbmFnZW1lbnQgY29uZmlndXJhdGlvblxuY29uc3QgTUVNT1JZX0NPTkZJRyA9IHtcbiAgLy8gRW5hYmxlIGdhcmJhZ2UgY29sbGVjdGlvbiBoaW50c1xuICBlbmFibGVHQzogdHJ1ZSxcbiAgLy8gTWVtb3J5IGNoZWNrIGZyZXF1ZW5jeSAoZXZlcnkgTiB0ZXN0cylcbiAgY2hlY2tGcmVxdWVuY3k6IDUsXG4gIC8vIEZvcmNlIGNsZWFudXAgYWZ0ZXIgbWVtb3J5LWludGVuc2l2ZSB0ZXN0c1xuICBmb3JjZUNsZWFudXBUaHJlc2hvbGQ6IDEwMCwgLy8gTUJcbiAgLy8gR2xvYmFsIG1lbW9yeSBsaW1pdCBiZWZvcmUgZW1lcmdlbmN5IGNsZWFudXBcbiAgZW1lcmdlbmN5Q2xlYW51cFRocmVzaG9sZDogNTAwLCAvLyBNQlxufTtcblxuLy8gVGVzdCBjb3VudGVyIGZvciBwZXJpb2RpYyBtZW1vcnkgY2hlY2tzXG5sZXQgdGVzdENvdW50ZXIgPSAwO1xuXG4vKipcbiAqIEluaXRpYWxpemUgZ2xvYmFsIG1lbW9yeSBtb25pdG9yaW5nXG4gKi9cbmZ1bmN0aW9uIGluaXRpYWxpemVNZW1vcnlNb25pdG9yaW5nKCk6IHZvaWQge1xuICAvLyBDcmVhdGUgbWVtb3J5IG1vbml0b3Igd2l0aCBDSS1hcHByb3ByaWF0ZSBzZXR0aW5nc1xuICBnbG9iYWxNZW1vcnlNb25pdG9yID0gcHJvY2Vzcy5lbnYuQ0kgXG4gICAgPyBUZXN0TWVtb3J5TW9uaXRvci5jcmVhdGVGb3JDSSgpXG4gICAgOiBUZXN0TWVtb3J5TW9uaXRvci5jcmVhdGVEZWZhdWx0KCk7XG5cbiAgLy8gU2V0IHVwIGdsb2JhbCB0ZXN0IGNhY2hlIGlmIG5vdCBleGlzdHNcbiAgaWYgKCFnbG9iYWwuX19URVNUX0NBQ0hFX18pIHtcbiAgICBnbG9iYWwuX19URVNUX0NBQ0hFX18gPSBuZXcgTWFwKCk7XG4gIH1cblxuICAvLyBTZXQgdXAgZ2xvYmFsIHRlc3QgcmVmZXJlbmNlcyBhcnJheVxuICBpZiAoIWdsb2JhbC5fX1RFU1RfUkVGU19fKSB7XG4gICAgZ2xvYmFsLl9fVEVTVF9SRUZTX18gPSBbXTtcbiAgfVxuXG4gIGNvbnNvbGUubG9nKCdNZW1vcnkgbW9uaXRvcmluZyBpbml0aWFsaXplZCcpO1xufVxuXG4vKipcbiAqIFBlcmZvcm0gcGVyaW9kaWMgbWVtb3J5IGNoZWNrc1xuICovXG5mdW5jdGlvbiBwZXJmb3JtUGVyaW9kaWNNZW1vcnlDaGVjaygpOiB2b2lkIHtcbiAgdGVzdENvdW50ZXIrKztcbiAgXG4gIGlmICh0ZXN0Q291bnRlciAlIE1FTU9SWV9DT05GSUcuY2hlY2tGcmVxdWVuY3kgPT09IDAgJiYgZ2xvYmFsTWVtb3J5TW9uaXRvcikge1xuICAgIGNvbnN0IG1lbW9yeUNoZWNrID0gZ2xvYmFsTWVtb3J5TW9uaXRvci5jaGVja01lbW9yeVVzYWdlKGBwZXJpb2RpYy1jaGVjay0ke3Rlc3RDb3VudGVyfWApO1xuICAgIFxuICAgIGlmICghbWVtb3J5Q2hlY2suaXNXaXRoaW5MaW1pdHMpIHtcbiAgICAgIGNvbnNvbGUud2FybihgTWVtb3J5IGNoZWNrIGZhaWxlZCBhdCB0ZXN0ICR7dGVzdENvdW50ZXJ9OmAsIG1lbW9yeUNoZWNrLmVycm9ycyk7XG4gICAgICBcbiAgICAgIC8vIEZvcmNlIGNsZWFudXAgaWYgbWVtb3J5IHVzYWdlIGlzIHRvbyBoaWdoXG4gICAgICBjb25zdCBjdXJyZW50TWVtb3J5TUIgPSBtZW1vcnlDaGVjay5jdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAoMTAyNCAqIDEwMjQpO1xuICAgICAgaWYgKGN1cnJlbnRNZW1vcnlNQiA+IE1FTU9SWV9DT05GSUcuZW1lcmdlbmN5Q2xlYW51cFRocmVzaG9sZCkge1xuICAgICAgICBjb25zb2xlLndhcm4oJ0VtZXJnZW5jeSBtZW1vcnkgY2xlYW51cCB0cmlnZ2VyZWQnKTtcbiAgICAgICAgcGVyZm9ybUVtZXJnZW5jeUNsZWFudXAoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBFbWVyZ2VuY3kgbWVtb3J5IGNsZWFudXAgcHJvY2VkdXJlXG4gKi9cbmZ1bmN0aW9uIHBlcmZvcm1FbWVyZ2VuY3lDbGVhbnVwKCk6IHZvaWQge1xuICBpZiAoZ2xvYmFsTWVtb3J5TW9uaXRvciAhPSBudWxsKSB7XG4gICAgZ2xvYmFsTWVtb3J5TW9uaXRvci5jbGVhbnVwKCdlbWVyZ2VuY3ktY2xlYW51cCcpO1xuICB9XG4gIFxuICAvLyBDbGVhciBhbGwgZ2xvYmFsIGNhY2hlc1xuICBpZiAoZ2xvYmFsLl9fVEVTVF9DQUNIRV9fKSB7XG4gICAgaWYgKHR5cGVvZiBnbG9iYWwuX19URVNUX0NBQ0hFX18uY2xlYXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXy5jbGVhcigpO1xuICAgIH0gZWxzZSB7XG4gICAgICBnbG9iYWwuX19URVNUX0NBQ0hFX18gPSBuZXcgTWFwKCk7XG4gICAgfVxuICB9XG4gIFxuICAvLyBDbGVhciB0ZXN0IHJlZmVyZW5jZXNcbiAgaWYgKGdsb2JhbC5fX1RFU1RfUkVGU19fKSB7XG4gICAgZ2xvYmFsLl9fVEVTVF9SRUZTX18ubGVuZ3RoID0gMDtcbiAgfVxuICBcbiAgLy8gRm9yY2UgZ2FyYmFnZSBjb2xsZWN0aW9uIGlmIGF2YWlsYWJsZVxuICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgdHJ5IHtcbiAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgY29uc29sZS5sb2coJ0VtZXJnZW5jeSBnYXJiYWdlIGNvbGxlY3Rpb24gcGVyZm9ybWVkJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIHBlcmZvcm0gZW1lcmdlbmN5IGdhcmJhZ2UgY29sbGVjdGlvbjonLCBlcnJvcik7XG4gICAgfVxuICB9XG4gIFxuICAvLyBSZXNldCBKZXN0IG1vZHVsZXMgdG8gZnJlZSBtZW1vcnlcbiAgaWYgKGplc3Q/LnJlc2V0TW9kdWxlcykge1xuICAgIGplc3QucmVzZXRNb2R1bGVzKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBTZXR1cCBtZW1vcnkgbWFuYWdlbWVudCBob29rc1xuICovXG5mdW5jdGlvbiBzZXR1cE1lbW9yeUhvb2tzKCk6IHZvaWQge1xuICAvLyBCZWZvcmUgZWFjaCB0ZXN0IHN1aXRlXG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgaWYgKGdsb2JhbE1lbW9yeU1vbml0b3IgIT0gbnVsbCkge1xuICAgICAgZ2xvYmFsTWVtb3J5TW9uaXRvci50YWtlU25hcHNob3QoJ3N1aXRlLXN0YXJ0Jyk7XG4gICAgfVxuICB9KTtcblxuICAvLyBCZWZvcmUgZWFjaCB0ZXN0XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHBlcmZvcm1QZXJpb2RpY01lbW9yeUNoZWNrKCk7XG4gICAgXG4gICAgLy8gQ2xlYXIgbW9ja3MgYW5kIHJlc2V0IG1vZHVsZXMgZm9yIG1lbW9yeSBlZmZpY2llbmN5XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgXG4gICAgLy8gVGFrZSBtZW1vcnkgc25hcHNob3QgZm9yIG1lbW9yeS1pbnRlbnNpdmUgdGVzdHNcbiAgICBpZiAoZ2xvYmFsTWVtb3J5TW9uaXRvciAmJiBleHBlY3QuZ2V0U3RhdGUoKS5jdXJyZW50VGVzdE5hbWUpIHtcbiAgICAgIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCkuY3VycmVudFRlc3ROYW1lO1xuICAgICAgaWYgKHRlc3ROYW1lICYmICh0ZXN0TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdtZW1vcnknKSB8fCBcbiAgICAgICAgICB0ZXN0TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdwZXJmb3JtYW5jZScpIHx8XG4gICAgICAgICAgdGVzdE5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaW50ZWdyYXRpb24nKSkpIHtcbiAgICAgICAgZ2xvYmFsTWVtb3J5TW9uaXRvci50YWtlU25hcHNob3QoYGJlZm9yZS0ke3Rlc3ROYW1lfWApO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgLy8gQWZ0ZXIgZWFjaCB0ZXN0XG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgaWYgKGdsb2JhbE1lbW9yeU1vbml0b3IgIT0gbnVsbCkge1xuICAgICAgY29uc3QgdGVzdE5hbWUgPSBleHBlY3QuZ2V0U3RhdGUoKS5jdXJyZW50VGVzdE5hbWUgfHwgJ3Vua25vd24tdGVzdCc7XG4gICAgICBjb25zdCBtZW1vcnlDaGVjayA9IGdsb2JhbE1lbW9yeU1vbml0b3IuY2hlY2tNZW1vcnlVc2FnZShgYWZ0ZXItJHt0ZXN0TmFtZX1gKTtcbiAgICAgIFxuICAgICAgLy8gRm9yY2UgY2xlYW51cCBmb3IgbWVtb3J5LWludGVuc2l2ZSB0ZXN0cyBvciBpZiBtZW1vcnkgdXNhZ2UgaXMgaGlnaFxuICAgICAgY29uc3QgY3VycmVudE1lbW9yeU1CID0gbWVtb3J5Q2hlY2suY3VycmVudFVzYWdlLmhlYXBVc2VkIC8gKDEwMjQgKiAxMDI0KTtcbiAgICAgIGlmIChjdXJyZW50TWVtb3J5TUIgPiBNRU1PUllfQ09ORklHLmZvcmNlQ2xlYW51cFRocmVzaG9sZCB8fCBcbiAgICAgICAgICB0ZXN0TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdtZW1vcnknKSB8fFxuICAgICAgICAgIHRlc3ROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2ludGVncmF0aW9uJykpIHtcbiAgICAgICAgXG4gICAgICAgIGdsb2JhbE1lbW9yeU1vbml0b3IuY2xlYW51cCh0ZXN0TmFtZSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIExvZyB3YXJuaW5ncyBpZiBtZW1vcnkgdXNhZ2UgaXMgY29uY2VybmluZ1xuICAgICAgaWYgKG1lbW9yeUNoZWNrLndhcm5pbmdzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBNZW1vcnkgd2FybmluZ3MgZm9yIHRlc3QgXCIke3Rlc3ROYW1lfVwiOmAsIG1lbW9yeUNoZWNrLndhcm5pbmdzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLy8gQ2xlYXIgYW55IHRlc3Qtc3BlY2lmaWMgZ2xvYmFsIHJlZmVyZW5jZXNcbiAgICBpZiAoZ2xvYmFsLl9fVEVTVF9SRUZTX18pIHtcbiAgICAgIGdsb2JhbC5fX1RFU1RfUkVGU19fLmxlbmd0aCA9IDA7XG4gICAgfVxuICB9KTtcblxuICAvLyBBZnRlciBlYWNoIHRlc3Qgc3VpdGVcbiAgYWZ0ZXJBbGwoKCkgPT4ge1xuICAgIGlmIChnbG9iYWxNZW1vcnlNb25pdG9yICE9IG51bGwpIHtcbiAgICAgIGdsb2JhbE1lbW9yeU1vbml0b3IudGFrZVNuYXBzaG90KCdzdWl0ZS1lbmQnKTtcbiAgICAgIFxuICAgICAgLy8gR2VuZXJhdGUgbWVtb3J5IHJlcG9ydCBmb3IgdGhlIHN1aXRlXG4gICAgICBjb25zdCBzdW1tYXJ5ID0gZ2xvYmFsTWVtb3J5TW9uaXRvci5nZXRNZW1vcnlTdW1tYXJ5KCk7XG4gICAgICBpZiAoc3VtbWFyeS50b3RhbEluY3JlYXNlID4gNTApIHsgLy8gNTBNQiB0aHJlc2hvbGQgZm9yIHJlcG9ydGluZ1xuICAgICAgICBjb25zb2xlLmxvZygnTWVtb3J5IHVzYWdlIHN1bW1hcnkgZm9yIHRlc3Qgc3VpdGU6Jywge1xuICAgICAgICAgIGluaXRpYWxNZW1vcnk6IGAke3N1bW1hcnkuaW5pdGlhbE1lbW9yeS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICAgICBmaW5hbE1lbW9yeTogYCR7c3VtbWFyeS5jdXJyZW50TWVtb3J5LnRvRml4ZWQoMil9TUJgLFxuICAgICAgICAgIHBlYWtNZW1vcnk6IGAke3N1bW1hcnkucGVha01lbW9yeS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICAgICB0b3RhbEluY3JlYXNlOiBgJHtzdW1tYXJ5LnRvdGFsSW5jcmVhc2UudG9GaXhlZCgyKX1NQmAsXG4gICAgICAgICAgZHVyYXRpb246IGAkeyhzdW1tYXJ5LnRlc3REdXJhdGlvbiAvIDEwMDApLnRvRml4ZWQoMil9c2BcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIFBlcmZvcm0gZmluYWwgY2xlYW51cFxuICAgICAgZ2xvYmFsTWVtb3J5TW9uaXRvci5jbGVhbnVwKCdzdWl0ZS1jbGVhbnVwJyk7XG4gICAgfVxuICB9KTtcbn1cblxuLyoqXG4gKiBBZGQgZ2FyYmFnZSBjb2xsZWN0aW9uIGhpbnRzXG4gKi9cbmZ1bmN0aW9uIGFkZEdhcmJhZ2VDb2xsZWN0aW9uSGludHMoKTogdm9pZCB7XG4gIC8vIEFkZCBnbG9iYWwgdXRpbGl0eSBmb3IgbWFudWFsIGdhcmJhZ2UgY29sbGVjdGlvblxuICBnbG9iYWwuZm9yY2VHQyA9ICgpID0+IHtcbiAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICB0cnkge1xuICAgICAgICBnbG9iYWwuZ2MoKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBmb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb246JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbiAgXG4gIC8vIEFkZCBtZW1vcnkgbW9uaXRvcmluZyB1dGlsaXRpZXMgdG8gZ2xvYmFsIHNjb3BlXG4gIGdsb2JhbC5nZXRNZW1vcnlVc2FnZSA9ICgpID0+IHtcbiAgICBjb25zdCB1c2FnZSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcbiAgICByZXR1cm4ge1xuICAgICAgaGVhcFVzZWQ6IGAkeyh1c2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgIGhlYXBUb3RhbDogYCR7KHVzYWdlLmhlYXBUb3RhbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgIGV4dGVybmFsOiBgJHsodXNhZ2UuZXh0ZXJuYWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmAsXG4gICAgICBhcnJheUJ1ZmZlcnM6IGAkeyh1c2FnZS5hcnJheUJ1ZmZlcnMgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmBcbiAgICB9O1xuICB9O1xuICBcbiAgLy8gQWRkIGNsZWFudXAgdXRpbGl0eVxuICBnbG9iYWwuY2xlYW51cFRlc3RNZW1vcnkgPSAoKSA9PiB7XG4gICAgaWYgKGdsb2JhbE1lbW9yeU1vbml0b3IgIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGdsb2JhbE1lbW9yeU1vbml0b3IuY2xlYW51cCgnbWFudWFsLWNsZWFudXAnKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH07XG59XG5cbi8qKlxuICogQ29uZmlndXJlIHByb2Nlc3MtbGV2ZWwgbWVtb3J5IG1hbmFnZW1lbnRcbiAqL1xuZnVuY3Rpb24gY29uZmlndXJlUHJvY2Vzc01lbW9yeSgpOiB2b2lkIHtcbiAgLy8gU2V0IE5vZGU/LmpzIG1lbW9yeSBsaW1pdHMgaWYgbm90IGFscmVhZHkgc2V0XG4gIGlmICghcHJvY2Vzcy5lbnYuTk9ERV9PUFRJT05TPy5pbmNsdWRlcygnLS1tYXgtb2xkLXNwYWNlLXNpemUnKSkge1xuICAgIC8vIFNldCByZWFzb25hYmxlIG1lbW9yeSBsaW1pdCBmb3IgdGVzdHMgKDJHQilcbiAgICBwcm9jZXNzLmVudi5OT0RFX09QVElPTlMgPSAocHJvY2Vzcy5lbnYuTk9ERV9PUFRJT05TIHx8ICcnKSArICcgLS1tYXgtb2xkLXNwYWNlLXNpemU9MjA0OCc7XG4gIH1cbiAgXG4gIC8vIEVuYWJsZSBnYXJiYWdlIGNvbGxlY3Rpb24gZXhwb3N1cmUgaWYgbm90IGFscmVhZHkgZW5hYmxlZFxuICBpZiAoIXByb2Nlc3MuZW52Lk5PREVfT1BUSU9OUy5pbmNsdWRlcygnLS1leHBvc2UtZ2MnKSkge1xuICAgIHByb2Nlc3MuZW52Lk5PREVfT1BUSU9OUyA9IChwcm9jZXNzLmVudi5OT0RFX09QVElPTlMgfHwgJycpICsgJyAtLWV4cG9zZS1nYyc7XG4gIH1cbiAgXG4gIC8vIEhhbmRsZSBwcm9jZXNzIG1lbW9yeSB3YXJuaW5nc1xuICBwcm9jZXNzLm9uKCd3YXJuaW5nJywgKHdhcm5pbmcpID0+IHtcbiAgICBpZiAod2FybmluZy5uYW1lID09PSAnTWF4TGlzdGVuZXJzRXhjZWVkZWRXYXJuaW5nJyB8fCBcbiAgICAgICAgd2FybmluZy5tZXNzYWdlLmluY2x1ZGVzKCdtZW1vcnknKSkge1xuICAgICAgY29uc29sZS53YXJuKCdQcm9jZXNzIG1lbW9yeSB3YXJuaW5nOicsIHdhcm5pbmcubWVzc2FnZSk7XG4gICAgICBcbiAgICAgIC8vIFRyaWdnZXIgZW1lcmdlbmN5IGNsZWFudXAgb24gbWVtb3J5IHdhcm5pbmdzXG4gICAgICBpZiAod2FybmluZy5tZXNzYWdlLmluY2x1ZGVzKCdtZW1vcnknKSB8fCB3YXJuaW5nLm1lc3NhZ2UuaW5jbHVkZXMoJ2hlYXAnKSkge1xuICAgICAgICBwZXJmb3JtRW1lcmdlbmN5Q2xlYW51cCgpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIFxuICAvLyBIYW5kbGUgdW5jYXVnaHQgZXhjZXB0aW9ucyB0aGF0IG1pZ2h0IGJlIG1lbW9yeS1yZWxhdGVkXG4gIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycm9yKSA9PiB7XG4gICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ291dCBvZiBtZW1vcnknKSB8fCBcbiAgICAgICAgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnaGVhcCcpIHx8XG4gICAgICAgIGVycm9yLm5hbWUgPT09ICdSYW5nZUVycm9yJykge1xuICAgICAgY29uc29sZS5lcnJvcignTWVtb3J5LXJlbGF0ZWQgdW5jYXVnaHQgZXhjZXB0aW9uOicsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgcGVyZm9ybUVtZXJnZW5jeUNsZWFudXAoKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vLyBJbml0aWFsaXplIG1lbW9yeSBtYW5hZ2VtZW50XG50cnkge1xuICBpbml0aWFsaXplTWVtb3J5TW9uaXRvcmluZygpO1xuICBzZXR1cE1lbW9yeUhvb2tzKCk7XG4gIGFkZEdhcmJhZ2VDb2xsZWN0aW9uSGludHMoKTtcbiAgY29uZmlndXJlUHJvY2Vzc01lbW9yeSgpO1xuICBcbiAgY29uc29sZS5sb2coJ01lbW9yeSBtYW5hZ2VtZW50IHNldHVwIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHknKTtcbn0gY2F0Y2ggKGVycm9yKSB7XG4gIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBpbml0aWFsaXplIG1lbW9yeSBtYW5hZ2VtZW50OicsIGVycm9yKTtcbn1cblxuLy8gRXhwb3J0IHV0aWxpdGllcyBmb3IgdXNlIGluIHRlc3RzXG5leHBvcnQge1xuICBUZXN0TWVtb3J5TW9uaXRvcixcbiAgcGVyZm9ybUVtZXJnZW5jeUNsZWFudXAsXG4gIE1FTU9SWV9DT05GSUdcbn07XG5cbi8vIEdsb2JhbCB0eXBlIGRlY2xhcmF0aW9uc1xuZGVjbGFyZSBnbG9iYWwge1xuICB2YXIgZm9yY2VHQzogKCkgPT4gYm9vbGVhbjtcbiAgdmFyIGdldE1lbW9yeVVzYWdlOiAoKSA9PiB7XG4gICAgaGVhcFVzZWQ6IHN0cmluZztcbiAgICBoZWFwVG90YWw6IHN0cmluZztcbiAgICBleHRlcm5hbDogc3RyaW5nO1xuICAgIGFycmF5QnVmZmVyczogc3RyaW5nO1xuICB9O1xuICB2YXIgY2xlYW51cFRlc3RNZW1vcnk6ICgpID0+IGFueTtcbiAgdmFyIF9fVEVTVF9DQUNIRV9fOiBNYXA8c3RyaW5nLCBhbnk+IHwgeyBjbGVhcjogKCkgPT4gdm9pZDsgfSB8IHVuZGVmaW5lZDtcbiAgdmFyIF9fVEVTVF9SRUZTX186IGFueVtdIHwgdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7fTsiXSwidmVyc2lvbiI6M30=