eed01a0968f75ae411a75780bfb8b04e
"use strict";
/**
 * Test Memory Monitor Utility
 *
 * Provides memory monitoring and management capabilities for test environments.
 * Used in comprehensive validation testing to ensure memory usage stays within limits.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestMemoryMonitor = void 0;
class TestMemoryMonitor {
    snapshots = [];
    startTime;
    memoryLimits;
    constructor(limits) {
        this.startTime = Date.now();
        this.memoryLimits = {
            heapUsed: 200 * 1024 * 1024,
            heapTotal: 300 * 1024 * 1024,
            external: 50 * 1024 * 1024,
            rss: 400 * 1024 * 1024,
            ...limits,
        };
    }
    /**
     * Create a memory monitor with default settings
     */
    static createDefault() {
        return new TestMemoryMonitor();
    }
    /**
     * Create a memory monitor with CI-appropriate settings (more restrictive)
     */
    static createForCI() {
        return new TestMemoryMonitor({
            heapUsed: 150 * 1024 * 1024,
            heapTotal: 200 * 1024 * 1024,
            external: 30 * 1024 * 1024,
            rss: 250 * 1024 * 1024, // 250MB
        });
    }
    /**
     * Take a memory snapshot at a specific point in time
     */
    takeSnapshot(testName) {
        const usage = process.memoryUsage();
        const snapshot = {
            timestamp: new Date(),
            testName,
            heapUsed: usage.heapUsed,
            heapTotal: usage.heapTotal,
            external: usage.external,
            arrayBuffers: usage.arrayBuffers,
            rss: usage.rss,
        };
        this.snapshots.push(snapshot);
        return snapshot;
    }
    /**
     * Get current memory usage
     */
    getCurrentMemoryUsage() {
        return process.memoryUsage();
    }
    /**
     * Check if current memory usage is within limits
     */
    checkMemoryUsage(_testName) {
        const currentUsage = this.getCurrentMemoryUsage();
        const warnings = [];
        const errors = [];
        // Check against limits
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed * 0.8) {
            warnings.push(`Heap usage approaching limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed) {
            errors.push(`Heap usage exceeded limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapTotal > this.memoryLimits.heapTotal) {
            errors.push(`Heap total exceeded limit: ${(currentUsage.heapTotal / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapTotal / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.external > this.memoryLimits.external) {
            errors.push(`External memory exceeded limit: ${(currentUsage.external / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.external / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.rss > this.memoryLimits.rss) {
            errors.push(`RSS exceeded limit: ${(currentUsage.rss / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.rss / 1024 / 1024).toFixed(2)}MB`);
        }
        return {
            isWithinLimits: errors.length === 0,
            currentUsage,
            warnings,
            errors,
        };
    }
    /**
     * Get memory usage summary since monitoring started
     */
    getMemorySummary() {
        if (this.snapshots.length === 0) {
            const current = this.getCurrentMemoryUsage();
            return {
                initialMemory: current.heapUsed / 1024 / 1024,
                currentMemory: current.heapUsed / 1024 / 1024,
                peakMemory: current.heapUsed / 1024 / 1024,
                totalIncrease: 0,
                testDuration: Date.now() - this.startTime,
            };
        }
        const initialSnapshot = this.snapshots[0];
        const currentUsage = this.getCurrentMemoryUsage();
        const peakMemory = Math.max(...this.snapshots.map(s => s.heapUsed), currentUsage.heapUsed);
        return {
            initialMemory: initialSnapshot.heapUsed / 1024 / 1024,
            currentMemory: currentUsage.heapUsed / 1024 / 1024,
            peakMemory: peakMemory / 1024 / 1024,
            totalIncrease: (currentUsage.heapUsed - initialSnapshot.heapUsed) / 1024 / 1024,
            testDuration: Date.now() - this.startTime,
        };
    }
    /**
     * Get memory usage trend analysis
     */
    getMemoryTrend() {
        if (this.snapshots.length < 3) {
            return {
                isIncreasing: false,
                averageIncrease: 0,
                concerningTrend: false,
            };
        }
        const recentSnapshots = this.snapshots.slice(-5); // Last 5 snapshots
        const increases = [];
        for (let i = 1; i < recentSnapshots.length; i++) {
            const increase = recentSnapshots[i].heapUsed - recentSnapshots[i - 1].heapUsed;
            increases.push(increase);
        }
        const averageIncrease = increases.reduce((sum, inc) => sum + inc, 0) / increases.length;
        const isIncreasing = averageIncrease > 0;
        const concerningTrend = averageIncrease > 10 * 1024 * 1024; // More than 10MB average increase
        return {
            isIncreasing,
            averageIncrease: averageIncrease / 1024 / 1024,
            concerningTrend,
        };
    }
    /**
     * Perform memory cleanup and optimization
     */
    cleanup(testName) {
        const beforeCleanup = this.getCurrentMemoryUsage();
        const actions = [];
        try {
            // Clear any test-specific caches
            if (global.__TEST_CACHE__) {
                if (typeof global.__TEST_CACHE__.clear === 'function') {
                    global.__TEST_CACHE__.clear();
                    actions.push('Cleared test cache');
                }
            }
            // Clear test references
            if (global.__TEST_REFS__) {
                global.__TEST_REFS__.length = 0;
                actions.push('Cleared test references');
            }
            // Force garbage collection if available
            if (global.gc) {
                global.gc();
                actions.push('Forced garbage collection');
            }
            // Clear Jest mocks and modules
            if (jest) {
                jest.clearAllMocks();
                actions.push('Cleared Jest mocks');
                if (jest.resetModules) {
                    jest.resetModules();
                    actions.push('Reset Jest modules');
                }
            }
            const afterCleanup = this.getCurrentMemoryUsage();
            const freedMemory = (beforeCleanup.heapUsed - afterCleanup.heapUsed) / 1024 / 1024;
            // Take snapshot after cleanup
            this.takeSnapshot(`${testName}-cleanup`);
            return {
                success: true,
                freedMemory: `${freedMemory.toFixed(2)}MB`,
                actions,
            };
        }
        catch (error) {
            console.error('Memory cleanup failed:', error);
            return {
                success: false,
                freedMemory: '0MB',
                actions: [...actions, `Cleanup failed: ${error.message}`],
            };
        }
    }
    /**
     * Get detailed memory report
     */
    getDetailedReport() {
        const summary = this.getMemorySummary();
        const trend = this.getMemoryTrend();
        const recommendations = [];
        // Generate recommendations based on analysis
        if (summary.totalIncrease > 50) {
            recommendations.push('Consider reducing test complexity or adding more cleanup');
        }
        if (trend.concerningTrend) {
            recommendations.push('Memory usage is increasing rapidly - investigate memory leaks');
        }
        if (summary.peakMemory > 150) {
            recommendations.push('Peak memory usage is high - consider splitting tests');
        }
        if (this.snapshots.length > 100) {
            recommendations.push('Many snapshots taken - consider reducing monitoring frequency');
        }
        return {
            summary,
            trend,
            snapshots: this.snapshots,
            recommendations,
        };
    }
    /**
     * Reset monitoring state
     */
    reset() {
        this.snapshots = [];
        this.startTime = Date.now();
    }
    /**
     * Export memory data for analysis
     */
    exportData() {
        return {
            metadata: {
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Date.now() - this.startTime,
                snapshotCount: this.snapshots.length,
            },
            snapshots: this.snapshots,
            summary: this.getMemorySummary(),
        };
    }
}
exports.TestMemoryMonitor = TestMemoryMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L2JhY2t1cHMvZmlyc3Qtd2F2ZS0yMDI1LTA4LTExVDA1LTE5LTI2LTgxM1ovc3JjL19fdGVzdHNfXy91dGlscy9UZXN0TWVtb3J5TW9uaXRvci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQTJCSCxNQUFhLGlCQUFpQjtJQUNwQixTQUFTLEdBQXFCLEVBQUUsQ0FBQztJQUNqQyxTQUFTLENBQVM7SUFDbEIsWUFBWSxDQUtsQjtJQUVGLFlBQVksTUFBbUQ7UUFDN0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLFlBQVksR0FBRztZQUNsQixRQUFRLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzNCLFNBQVMsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDNUIsUUFBUSxFQUFFLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMxQixHQUFHLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQ3RCLEdBQUcsTUFBTTtTQUNWLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsYUFBYTtRQUNsQixPQUFPLElBQUksaUJBQWlCLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsV0FBVztRQUNoQixPQUFPLElBQUksaUJBQWlCLENBQUM7WUFDM0IsUUFBUSxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMzQixTQUFTLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzVCLFFBQVEsRUFBRSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDMUIsR0FBRyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSSxFQUFFLFFBQVE7U0FDakMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsWUFBWSxDQUFDLFFBQWdC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LENBQUMsQ0FBQztTQUN2RjtRQUVELElBQUksT0FBTyxDQUFDLFVBQVUsR0FBRyxHQUFHLEVBQUU7WUFDNUIsZUFBZSxDQUFDLElBQUksQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1NBQzlFO1FBRUQsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDL0IsZUFBZSxDQUFDLElBQUksQ0FBQywrREFBK0QsQ0FBQyxDQUFDO1NBQ3ZGO1FBRUQsT0FBTztZQUNMLE9BQU87WUFDUCxLQUFLO1lBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLGVBQWU7U0FDaEIsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUs7UUFDSCxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVO1FBVVIsT0FBTztZQUNMLFFBQVEsRUFBRTtnQkFDUixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3pCLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNuQixRQUFRLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTO2dCQUNyQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNO2FBQ3JDO1lBQ0QsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLE9BQU8sRUFBRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7U0FDakMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXRURCw4Q0FzVEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L2JhY2t1cHMvZmlyc3Qtd2F2ZS0yMDI1LTA4LTExVDA1LTE5LTI2LTgxM1ovc3JjL19fdGVzdHNfXy91dGlscy9UZXN0TWVtb3J5TW9uaXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlc3QgTWVtb3J5IE1vbml0b3IgVXRpbGl0eVxuICpcbiAqIFByb3ZpZGVzIG1lbW9yeSBtb25pdG9yaW5nIGFuZCBtYW5hZ2VtZW50IGNhcGFiaWxpdGllcyBmb3IgdGVzdCBlbnZpcm9ubWVudHMuXG4gKiBVc2VkIGluIGNvbXByZWhlbnNpdmUgdmFsaWRhdGlvbiB0ZXN0aW5nIHRvIGVuc3VyZSBtZW1vcnkgdXNhZ2Ugc3RheXMgd2l0aGluIGxpbWl0cy5cbiAqL1xuXG5pbnRlcmZhY2UgTWVtb3J5U25hcHNob3Qge1xuICB0aW1lc3RhbXA6IERhdGU7XG4gIHRlc3ROYW1lOiBzdHJpbmc7XG4gIGhlYXBVc2VkOiBudW1iZXI7XG4gIGhlYXBUb3RhbDogbnVtYmVyO1xuICBleHRlcm5hbDogbnVtYmVyO1xuICBhcnJheUJ1ZmZlcnM6IG51bWJlcjtcbiAgcnNzOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBNZW1vcnlDaGVjayB7XG4gIGlzV2l0aGluTGltaXRzOiBib29sZWFuO1xuICBjdXJyZW50VXNhZ2U6IE5vZGVKUy5NZW1vcnlVc2FnZTtcbiAgd2FybmluZ3M6IHN0cmluZ1tdO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgTWVtb3J5U3VtbWFyeSB7XG4gIGluaXRpYWxNZW1vcnk6IG51bWJlcjtcbiAgY3VycmVudE1lbW9yeTogbnVtYmVyO1xuICBwZWFrTWVtb3J5OiBudW1iZXI7XG4gIHRvdGFsSW5jcmVhc2U6IG51bWJlcjtcbiAgdGVzdER1cmF0aW9uOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBUZXN0TWVtb3J5TW9uaXRvciB7XG4gIHByaXZhdGUgc25hcHNob3RzOiBNZW1vcnlTbmFwc2hvdFtdID0gW107XG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XG4gIHByaXZhdGUgbWVtb3J5TGltaXRzOiB7XG4gICAgaGVhcFVzZWQ6IG51bWJlcjtcbiAgICBoZWFwVG90YWw6IG51bWJlcjtcbiAgICBleHRlcm5hbDogbnVtYmVyO1xuICAgIHJzczogbnVtYmVyO1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKGxpbWl0cz86IFBhcnRpYWw8VGVzdE1lbW9yeU1vbml0b3JbJ21lbW9yeUxpbWl0cyddPikge1xuICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1lbW9yeUxpbWl0cyA9IHtcbiAgICAgIGhlYXBVc2VkOiAyMDAgKiAxMDI0ICogMTAyNCwgLy8gMjAwTUJcbiAgICAgIGhlYXBUb3RhbDogMzAwICogMTAyNCAqIDEwMjQsIC8vIDMwME1CXG4gICAgICBleHRlcm5hbDogNTAgKiAxMDI0ICogMTAyNCwgLy8gNTBNQlxuICAgICAgcnNzOiA0MDAgKiAxMDI0ICogMTAyNCwgLy8gNDAwTUJcbiAgICAgIC4uLmxpbWl0cyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG1lbW9yeSBtb25pdG9yIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZURlZmF1bHQoKTogVGVzdE1lbW9yeU1vbml0b3Ige1xuICAgIHJldHVybiBuZXcgVGVzdE1lbW9yeU1vbml0b3IoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBtZW1vcnkgbW9uaXRvciB3aXRoIENJLWFwcHJvcHJpYXRlIHNldHRpbmdzIChtb3JlIHJlc3RyaWN0aXZlKVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZUZvckNJKCk6IFRlc3RNZW1vcnlNb25pdG9yIHtcbiAgICByZXR1cm4gbmV3IFRlc3RNZW1vcnlNb25pdG9yKHtcbiAgICAgIGhlYXBVc2VkOiAxNTAgKiAxMDI0ICogMTAyNCwgLy8gMTUwTUJcbiAgICAgIGhlYXBUb3RhbDogMjAwICogMTAyNCAqIDEwMjQsIC8vIDIwME1CXG4gICAgICBleHRlcm5hbDogMzAgKiAxMDI0ICogMTAyNCwgLy8gMzBNQlxuICAgICAgcnNzOiAyNTAgKiAxMDI0ICogMTAyNCwgLy8gMjUwTUJcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUYWtlIGEgbWVtb3J5IHNuYXBzaG90IGF0IGEgc3BlY2lmaWMgcG9pbnQgaW4gdGltZVxuICAgKi9cbiAgdGFrZVNuYXBzaG90KHRlc3ROYW1lOiBzdHJpbmcpOiBNZW1vcnlTbmFwc2hvdCB7XG4gICAgY29uc3QgdXNhZ2UgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gICAgY29uc3Qgc25hcHNob3Q6IE1lbW9yeVNuYXBzaG90ID0ge1xuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgdGVzdE5hbWUsXG4gICAgICBoZWFwVXNlZDogdXNhZ2UuaGVhcFVzZWQsXG4gICAgICBoZWFwVG90YWw6IHVzYWdlLmhlYXBUb3RhbCxcbiAgICAgIGV4dGVybmFsOiB1c2FnZS5leHRlcm5hbCxcbiAgICAgIGFycmF5QnVmZmVyczogdXNhZ2UuYXJyYXlCdWZmZXJzLFxuICAgICAgcnNzOiB1c2FnZS5yc3MsXG4gICAgfTtcblxuICAgIHRoaXMuc25hcHNob3RzLnB1c2goc25hcHNob3QpO1xuICAgIHJldHVybiBzbmFwc2hvdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBtZW1vcnkgdXNhZ2VcbiAgICovXG4gIGdldEN1cnJlbnRNZW1vcnlVc2FnZSgpOiBOb2RlSlMuTWVtb3J5VXNhZ2Uge1xuICAgIHJldHVybiBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgY3VycmVudCBtZW1vcnkgdXNhZ2UgaXMgd2l0aGluIGxpbWl0c1xuICAgKi9cbiAgY2hlY2tNZW1vcnlVc2FnZShfdGVzdE5hbWU6IHN0cmluZyk6IE1lbW9yeUNoZWNrIHtcbiAgICBjb25zdCBjdXJyZW50VXNhZ2UgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IHdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIENoZWNrIGFnYWluc3QgbGltaXRzXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5oZWFwVXNlZCA+IHRoaXMubWVtb3J5TGltaXRzLmhlYXBVc2VkICogMC44KSB7XG4gICAgICB3YXJuaW5ncy5wdXNoKFxuICAgICAgICBgSGVhcCB1c2FnZSBhcHByb2FjaGluZyBsaW1pdDogJHsoY3VycmVudFVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudFVzYWdlLmhlYXBVc2VkID4gdGhpcy5tZW1vcnlMaW1pdHMuaGVhcFVzZWQpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgSGVhcCB1c2FnZSBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5oZWFwVG90YWwgPiB0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVG90YWwpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgSGVhcCB0b3RhbCBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLmhlYXBUb3RhbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMuaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudFVzYWdlLmV4dGVybmFsID4gdGhpcy5tZW1vcnlMaW1pdHMuZXh0ZXJuYWwpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgRXh0ZXJuYWwgbWVtb3J5IGV4Y2VlZGVkIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UuZXh0ZXJuYWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQiA+ICR7KHRoaXMubWVtb3J5TGltaXRzLmV4dGVybmFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudFVzYWdlLnJzcyA+IHRoaXMubWVtb3J5TGltaXRzLnJzcykge1xuICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgIGBSU1MgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5yc3MgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQiA+ICR7KHRoaXMubWVtb3J5TGltaXRzLnJzcyAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzV2l0aGluTGltaXRzOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgICAgY3VycmVudFVzYWdlLFxuICAgICAgd2FybmluZ3MsXG4gICAgICBlcnJvcnMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbWVtb3J5IHVzYWdlIHN1bW1hcnkgc2luY2UgbW9uaXRvcmluZyBzdGFydGVkXG4gICAqL1xuICBnZXRNZW1vcnlTdW1tYXJ5KCk6IE1lbW9yeVN1bW1hcnkge1xuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaW5pdGlhbE1lbW9yeTogY3VycmVudC5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgICBjdXJyZW50TWVtb3J5OiBjdXJyZW50LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICAgIHBlYWtNZW1vcnk6IGN1cnJlbnQuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgICAgdG90YWxJbmNyZWFzZTogMCxcbiAgICAgICAgdGVzdER1cmF0aW9uOiBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWUsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IGluaXRpYWxTbmFwc2hvdCA9IHRoaXMuc25hcHNob3RzWzBdO1xuICAgIGNvbnN0IGN1cnJlbnRVc2FnZSA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgY29uc3QgcGVha01lbW9yeSA9IE1hdGgubWF4KC4uLnRoaXMuc25hcHNob3RzLm1hcChzID0+IHMuaGVhcFVzZWQpLCBjdXJyZW50VXNhZ2UuaGVhcFVzZWQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGluaXRpYWxNZW1vcnk6IGluaXRpYWxTbmFwc2hvdC5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgY3VycmVudE1lbW9yeTogY3VycmVudFVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICBwZWFrTWVtb3J5OiBwZWFrTWVtb3J5IC8gMTAyNCAvIDEwMjQsXG4gICAgICB0b3RhbEluY3JlYXNlOiAoY3VycmVudFVzYWdlLmhlYXBVc2VkIC0gaW5pdGlhbFNuYXBzaG90LmhlYXBVc2VkKSAvIDEwMjQgLyAxMDI0LFxuICAgICAgdGVzdER1cmF0aW9uOiBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWUsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbWVtb3J5IHVzYWdlIHRyZW5kIGFuYWx5c2lzXG4gICAqL1xuICBnZXRNZW1vcnlUcmVuZCgpOiB7XG4gICAgaXNJbmNyZWFzaW5nOiBib29sZWFuO1xuICAgIGF2ZXJhZ2VJbmNyZWFzZTogbnVtYmVyO1xuICAgIGNvbmNlcm5pbmdUcmVuZDogYm9vbGVhbjtcbiAgfSB7XG4gICAgaWYgKHRoaXMuc25hcHNob3RzLmxlbmd0aCA8IDMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzSW5jcmVhc2luZzogZmFsc2UsXG4gICAgICAgIGF2ZXJhZ2VJbmNyZWFzZTogMCxcbiAgICAgICAgY29uY2VybmluZ1RyZW5kOiBmYWxzZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcmVjZW50U25hcHNob3RzID0gdGhpcy5zbmFwc2hvdHMuc2xpY2UoLTUpOyAvLyBMYXN0IDUgc25hcHNob3RzXG4gICAgY29uc3QgaW5jcmVhc2VzOiBudW1iZXJbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCByZWNlbnRTbmFwc2hvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGluY3JlYXNlID0gcmVjZW50U25hcHNob3RzW2ldLmhlYXBVc2VkIC0gcmVjZW50U25hcHNob3RzW2kgLSAxXS5oZWFwVXNlZDtcbiAgICAgIGluY3JlYXNlcy5wdXNoKGluY3JlYXNlKTtcbiAgICB9XG5cbiAgICBjb25zdCBhdmVyYWdlSW5jcmVhc2UgPSBpbmNyZWFzZXMucmVkdWNlKChzdW0sIGluYykgPT4gc3VtICsgaW5jLCAwKSAvIGluY3JlYXNlcy5sZW5ndGg7XG4gICAgY29uc3QgaXNJbmNyZWFzaW5nID0gYXZlcmFnZUluY3JlYXNlID4gMDtcbiAgICBjb25zdCBjb25jZXJuaW5nVHJlbmQgPSBhdmVyYWdlSW5jcmVhc2UgPiAxMCAqIDEwMjQgKiAxMDI0OyAvLyBNb3JlIHRoYW4gMTBNQiBhdmVyYWdlIGluY3JlYXNlXG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNJbmNyZWFzaW5nLFxuICAgICAgYXZlcmFnZUluY3JlYXNlOiBhdmVyYWdlSW5jcmVhc2UgLyAxMDI0IC8gMTAyNCwgLy8gQ29udmVydCB0byBNQlxuICAgICAgY29uY2VybmluZ1RyZW5kLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBtZW1vcnkgY2xlYW51cCBhbmQgb3B0aW1pemF0aW9uXG4gICAqL1xuICBjbGVhbnVwKHRlc3ROYW1lOiBzdHJpbmcpOiB7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICBmcmVlZE1lbW9yeTogc3RyaW5nO1xuICAgIGFjdGlvbnM6IHN0cmluZ1tdO1xuICB9IHtcbiAgICBjb25zdCBiZWZvcmVDbGVhbnVwID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICBjb25zdCBhY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENsZWFyIGFueSB0ZXN0LXNwZWNpZmljIGNhY2hlc1xuICAgICAgaWYgKGdsb2JhbC5fX1RFU1RfQ0FDSEVfXykge1xuICAgICAgICBpZiAodHlwZW9mIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXy5jbGVhciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXy5jbGVhcigpO1xuICAgICAgICAgIGFjdGlvbnMucHVzaCgnQ2xlYXJlZCB0ZXN0IGNhY2hlJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYXIgdGVzdCByZWZlcmVuY2VzXG4gICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9SRUZTX18pIHtcbiAgICAgICAgZ2xvYmFsLl9fVEVTVF9SRUZTX18ubGVuZ3RoID0gMDtcbiAgICAgICAgYWN0aW9ucy5wdXNoKCdDbGVhcmVkIHRlc3QgcmVmZXJlbmNlcycpO1xuICAgICAgfVxuXG4gICAgICAvLyBGb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb24gaWYgYXZhaWxhYmxlXG4gICAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICBhY3Rpb25zLnB1c2goJ0ZvcmNlZCBnYXJiYWdlIGNvbGxlY3Rpb24nKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYXIgSmVzdCBtb2NrcyBhbmQgbW9kdWxlc1xuICAgICAgaWYgKGplc3QpIHtcbiAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgICAgIGFjdGlvbnMucHVzaCgnQ2xlYXJlZCBKZXN0IG1vY2tzJyk7XG5cbiAgICAgICAgaWYgKGplc3QucmVzZXRNb2R1bGVzKSB7XG4gICAgICAgICAgamVzdC5yZXNldE1vZHVsZXMoKTtcbiAgICAgICAgICBhY3Rpb25zLnB1c2goJ1Jlc2V0IEplc3QgbW9kdWxlcycpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFmdGVyQ2xlYW51cCA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgICBjb25zdCBmcmVlZE1lbW9yeSA9IChiZWZvcmVDbGVhbnVwLmhlYXBVc2VkIC0gYWZ0ZXJDbGVhbnVwLmhlYXBVc2VkKSAvIDEwMjQgLyAxMDI0O1xuXG4gICAgICAvLyBUYWtlIHNuYXBzaG90IGFmdGVyIGNsZWFudXBcbiAgICAgIHRoaXMudGFrZVNuYXBzaG90KGAke3Rlc3ROYW1lfS1jbGVhbnVwYCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGZyZWVkTWVtb3J5OiBgJHtmcmVlZE1lbW9yeS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICAgYWN0aW9ucyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ01lbW9yeSBjbGVhbnVwIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZnJlZWRNZW1vcnk6ICcwTUInLFxuICAgICAgICBhY3Rpb25zOiBbLi4uYWN0aW9ucywgYENsZWFudXAgZmFpbGVkOiAkeyhlcnJvciBhcyBFcnJvcikubWVzc2FnZX1gXSxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkZXRhaWxlZCBtZW1vcnkgcmVwb3J0XG4gICAqL1xuICBnZXREZXRhaWxlZFJlcG9ydCgpOiB7XG4gICAgc3VtbWFyeTogTWVtb3J5U3VtbWFyeTtcbiAgICB0cmVuZDogUmV0dXJuVHlwZTxUZXN0TWVtb3J5TW9uaXRvclsnZ2V0TWVtb3J5VHJlbmQnXT47XG4gICAgc25hcHNob3RzOiBNZW1vcnlTbmFwc2hvdFtdO1xuICAgIHJlY29tbWVuZGF0aW9uczogc3RyaW5nW107XG4gIH0ge1xuICAgIGNvbnN0IHN1bW1hcnkgPSB0aGlzLmdldE1lbW9yeVN1bW1hcnkoKTtcbiAgICBjb25zdCB0cmVuZCA9IHRoaXMuZ2V0TWVtb3J5VHJlbmQoKTtcbiAgICBjb25zdCByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBHZW5lcmF0ZSByZWNvbW1lbmRhdGlvbnMgYmFzZWQgb24gYW5hbHlzaXNcbiAgICBpZiAoc3VtbWFyeS50b3RhbEluY3JlYXNlID4gNTApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdDb25zaWRlciByZWR1Y2luZyB0ZXN0IGNvbXBsZXhpdHkgb3IgYWRkaW5nIG1vcmUgY2xlYW51cCcpO1xuICAgIH1cblxuICAgIGlmICh0cmVuZC5jb25jZXJuaW5nVHJlbmQpIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdNZW1vcnkgdXNhZ2UgaXMgaW5jcmVhc2luZyByYXBpZGx5IC0gaW52ZXN0aWdhdGUgbWVtb3J5IGxlYWtzJyk7XG4gICAgfVxuXG4gICAgaWYgKHN1bW1hcnkucGVha01lbW9yeSA+IDE1MCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ1BlYWsgbWVtb3J5IHVzYWdlIGlzIGhpZ2ggLSBjb25zaWRlciBzcGxpdHRpbmcgdGVzdHMnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zbmFwc2hvdHMubGVuZ3RoID4gMTAwKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnTWFueSBzbmFwc2hvdHMgdGFrZW4gLSBjb25zaWRlciByZWR1Y2luZyBtb25pdG9yaW5nIGZyZXF1ZW5jeScpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdW1tYXJ5LFxuICAgICAgdHJlbmQsXG4gICAgICBzbmFwc2hvdHM6IHRoaXMuc25hcHNob3RzLFxuICAgICAgcmVjb21tZW5kYXRpb25zLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgbW9uaXRvcmluZyBzdGF0ZVxuICAgKi9cbiAgcmVzZXQoKTogdm9pZCB7XG4gICAgdGhpcy5zbmFwc2hvdHMgPSBbXTtcbiAgICB0aGlzLnN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gIH1cblxuICAvKipcbiAgICogRXhwb3J0IG1lbW9yeSBkYXRhIGZvciBhbmFseXNpc1xuICAgKi9cbiAgZXhwb3J0RGF0YSgpOiB7XG4gICAgbWV0YWRhdGE6IHtcbiAgICAgIHN0YXJ0VGltZTogbnVtYmVyO1xuICAgICAgZW5kVGltZTogbnVtYmVyO1xuICAgICAgZHVyYXRpb246IG51bWJlcjtcbiAgICAgIHNuYXBzaG90Q291bnQ6IG51bWJlcjtcbiAgICB9O1xuICAgIHNuYXBzaG90czogTWVtb3J5U25hcHNob3RbXTtcbiAgICBzdW1tYXJ5OiBNZW1vcnlTdW1tYXJ5O1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgc3RhcnRUaW1lOiB0aGlzLnN0YXJ0VGltZSxcbiAgICAgICAgZW5kVGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZSxcbiAgICAgICAgc25hcHNob3RDb3VudDogdGhpcy5zbmFwc2hvdHMubGVuZ3RoLFxuICAgICAgfSxcbiAgICAgIHNuYXBzaG90czogdGhpcy5zbmFwc2hvdHMsXG4gICAgICBzdW1tYXJ5OiB0aGlzLmdldE1lbW9yeVN1bW1hcnkoKSxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=