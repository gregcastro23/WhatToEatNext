825df4127fed328443412c08774f66e0
"use strict";
/**
 * Test Memory Monitor Utility
 *
 * Provides memory monitoring and management capabilities for test environments.
 * Used in comprehensive validation testing to ensure memory usage stays within limits.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestMemoryMonitor = void 0;
class TestMemoryMonitor {
    snapshots = [];
    startTime;
    memoryLimits;
    constructor(limits) {
        this.startTime = Date.now();
        this.memoryLimits = {
            heapUsed: 200 * 1024 * 1024,
            heapTotal: 300 * 1024 * 1024,
            external: 50 * 1024 * 1024,
            rss: 400 * 1024 * 1024,
            ...limits
        };
    }
    /**
     * Create a memory monitor with default settings
     */
    static createDefault() {
        return new TestMemoryMonitor();
    }
    /**
     * Create a memory monitor with CI-appropriate settings (more restrictive)
     */
    static createForCI() {
        return new TestMemoryMonitor({
            heapUsed: 150 * 1024 * 1024,
            heapTotal: 200 * 1024 * 1024,
            external: 30 * 1024 * 1024,
            rss: 250 * 1024 * 1024, // 250MB
        });
    }
    /**
     * Take a memory snapshot at a specific point in time
     */
    takeSnapshot(testName) {
        const usage = process.memoryUsage();
        const snapshot = {
            timestamp: new Date(),
            testName,
            heapUsed: usage.heapUsed,
            heapTotal: usage.heapTotal,
            external: usage.external,
            arrayBuffers: usage.arrayBuffers,
            rss: usage.rss
        };
        this.snapshots.push(snapshot);
        return snapshot;
    }
    /**
     * Get current memory usage
     */
    getCurrentMemoryUsage() {
        return process.memoryUsage();
    }
    /**
     * Check if current memory usage is within limits
     */
    checkMemoryUsage(testName) {
        const currentUsage = this.getCurrentMemoryUsage();
        const warnings = [];
        const errors = [];
        // Check against limits
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed * 0.8) {
            warnings.push(`Heap usage approaching limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed) {
            errors.push(`Heap usage exceeded limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapTotal > this.memoryLimits.heapTotal) {
            errors.push(`Heap total exceeded limit: ${(currentUsage.heapTotal / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapTotal / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.external > this.memoryLimits.external) {
            errors.push(`External memory exceeded limit: ${(currentUsage.external / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.external / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.rss > this.memoryLimits.rss) {
            errors.push(`RSS exceeded limit: ${(currentUsage.rss / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.rss / 1024 / 1024).toFixed(2)}MB`);
        }
        return {
            isWithinLimits: errors.length === 0,
            currentUsage,
            warnings,
            errors
        };
    }
    /**
     * Get memory usage summary since monitoring started
     */
    getMemorySummary() {
        if (this.snapshots.length === 0) {
            const current = this.getCurrentMemoryUsage();
            return {
                initialMemory: current.heapUsed / 1024 / 1024,
                currentMemory: current.heapUsed / 1024 / 1024,
                peakMemory: current.heapUsed / 1024 / 1024,
                totalIncrease: 0,
                testDuration: Date.now() - this.startTime
            };
        }
        const initialSnapshot = this.snapshots[0];
        const currentUsage = this.getCurrentMemoryUsage();
        const peakMemory = Math.max(...this.snapshots.map(s => s.heapUsed), currentUsage.heapUsed);
        return {
            initialMemory: initialSnapshot.heapUsed / 1024 / 1024,
            currentMemory: currentUsage.heapUsed / 1024 / 1024,
            peakMemory: peakMemory / 1024 / 1024,
            totalIncrease: (currentUsage.heapUsed - initialSnapshot.heapUsed) / 1024 / 1024,
            testDuration: Date.now() - this.startTime
        };
    }
    /**
     * Get memory usage trend analysis
     */
    getMemoryTrend() {
        if (this.snapshots.length < 3) {
            return {
                isIncreasing: false,
                averageIncrease: 0,
                concerningTrend: false
            };
        }
        const recentSnapshots = this.snapshots.slice(-5); // Last 5 snapshots
        const increases = [];
        for (let i = 1; i < recentSnapshots.length; i++) {
            const increase = recentSnapshots[i].heapUsed - recentSnapshots[i - 1].heapUsed;
            increases.push(increase);
        }
        const averageIncrease = increases.reduce((sum, inc) => sum + inc, 0) / increases.length;
        const isIncreasing = averageIncrease > 0;
        const concerningTrend = averageIncrease > 10 * 1024 * 1024; // More than 10MB average increase
        return {
            isIncreasing,
            averageIncrease: averageIncrease / 1024 / 1024,
            concerningTrend
        };
    }
    /**
     * Perform memory cleanup and optimization
     */
    cleanup(testName) {
        const beforeCleanup = this.getCurrentMemoryUsage();
        const actions = [];
        try {
            // Clear any test-specific caches
            if (global.__TEST_CACHE__) {
                if (typeof global.__TEST_CACHE__.clear === 'function') {
                    global.__TEST_CACHE__.clear();
                    actions.push('Cleared test cache');
                }
            }
            // Clear test references
            if (global.__TEST_REFS__) {
                global.__TEST_REFS__.length = 0;
                actions.push('Cleared test references');
            }
            // Force garbage collection if available
            if (global.gc) {
                global.gc();
                actions.push('Forced garbage collection');
            }
            // Clear Jest mocks and modules
            if (jest) {
                jest.clearAllMocks();
                actions.push('Cleared Jest mocks');
                if (jest.resetModules) {
                    jest.resetModules();
                    actions.push('Reset Jest modules');
                }
            }
            const afterCleanup = this.getCurrentMemoryUsage();
            const freedMemory = (beforeCleanup.heapUsed - afterCleanup.heapUsed) / 1024 / 1024;
            // Take snapshot after cleanup
            this.takeSnapshot(`${testName}-cleanup`);
            return {
                success: true,
                freedMemory: `${freedMemory.toFixed(2)}MB`,
                actions
            };
        }
        catch (error) {
            console.error('Memory cleanup failed:', error);
            return {
                success: false,
                freedMemory: '0MB',
                actions: [...actions, `Cleanup failed: ${error.message}`]
            };
        }
    }
    /**
     * Get detailed memory report
     */
    getDetailedReport() {
        const summary = this.getMemorySummary();
        const trend = this.getMemoryTrend();
        const recommendations = [];
        // Generate recommendations based on analysis
        if (summary.totalIncrease > 50) {
            recommendations.push('Consider reducing test complexity or adding more cleanup');
        }
        if (trend.concerningTrend) {
            recommendations.push('Memory usage is increasing rapidly - investigate memory leaks');
        }
        if (summary.peakMemory > 150) {
            recommendations.push('Peak memory usage is high - consider splitting tests');
        }
        if (this.snapshots.length > 100) {
            recommendations.push('Many snapshots taken - consider reducing monitoring frequency');
        }
        return {
            summary,
            trend,
            snapshots: this.snapshots,
            recommendations
        };
    }
    /**
     * Reset monitoring state
     */
    reset() {
        this.snapshots = [];
        this.startTime = Date.now();
    }
    /**
     * Export memory data for analysis
     */
    exportData() {
        return {
            metadata: {
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Date.now() - this.startTime,
                snapshotCount: this.snapshots.length
            },
            snapshots: this.snapshots,
            summary: this.getMemorySummary()
        };
    }
}
exports.TestMemoryMonitor = TestMemoryMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvVGVzdE1lbW9yeU1vbml0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUEyQkgsTUFBYSxpQkFBaUI7SUFDcEIsU0FBUyxHQUFxQixFQUFFLENBQUM7SUFDakMsU0FBUyxDQUFTO0lBQ2xCLFlBQVksQ0FLbEI7SUFFRixZQUFZLE1BQW1EO1FBQzdELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsUUFBUSxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMzQixTQUFTLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzVCLFFBQVEsRUFBRSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDMUIsR0FBRyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUN0QixHQUFHLE1BQU07U0FDVixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGFBQWE7UUFDbEIsT0FBTyxJQUFJLGlCQUFpQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVc7UUFDaEIsT0FBTyxJQUFJLGlCQUFpQixDQUFDO1lBQzNCLFFBQVEsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDM0IsU0FBUyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUM1QixRQUFRLEVBQUUsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzFCLEdBQUcsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUksRUFBUyxRQUFRO1NBQ3hDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxRQUFnQjtRQUMzQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENB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QUcsR0FBRyxFQUFFO1lBQzVCLGVBQWUsQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztTQUM5RTtRQUVELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQy9CLGVBQWUsQ0FBQyxJQUFJLENBQUMsK0RBQStELENBQUMsQ0FBQztTQUN2RjtRQUVELE9BQU87WUFDTCxPQUFPO1lBQ1AsS0FBSztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixlQUFlO1NBQ2hCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsVUFBVTtRQVVSLE9BQU87WUFDTCxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUztnQkFDckMsYUFBYSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTTthQUNyQztZQUNELFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1NBQ2pDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1U0QsOENBNFNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvX190ZXN0c19fL3V0aWxzL1Rlc3RNZW1vcnlNb25pdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdCBNZW1vcnkgTW9uaXRvciBVdGlsaXR5XG4gKiBcbiAqIFByb3ZpZGVzIG1lbW9yeSBtb25pdG9yaW5nIGFuZCBtYW5hZ2VtZW50IGNhcGFiaWxpdGllcyBmb3IgdGVzdCBlbnZpcm9ubWVudHMuXG4gKiBVc2VkIGluIGNvbXByZWhlbnNpdmUgdmFsaWRhdGlvbiB0ZXN0aW5nIHRvIGVuc3VyZSBtZW1vcnkgdXNhZ2Ugc3RheXMgd2l0aGluIGxpbWl0cy5cbiAqL1xuXG5pbnRlcmZhY2UgTWVtb3J5U25hcHNob3Qge1xuICB0aW1lc3RhbXA6IERhdGU7XG4gIHRlc3ROYW1lOiBzdHJpbmc7XG4gIGhlYXBVc2VkOiBudW1iZXI7XG4gIGhlYXBUb3RhbDogbnVtYmVyO1xuICBleHRlcm5hbDogbnVtYmVyO1xuICBhcnJheUJ1ZmZlcnM6IG51bWJlcjtcbiAgcnNzOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBNZW1vcnlDaGVjayB7XG4gIGlzV2l0aGluTGltaXRzOiBib29sZWFuO1xuICBjdXJyZW50VXNhZ2U6IE5vZGVKUy5NZW1vcnlVc2FnZTtcbiAgd2FybmluZ3M6IHN0cmluZ1tdO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgTWVtb3J5U3VtbWFyeSB7XG4gIGluaXRpYWxNZW1vcnk6IG51bWJlcjtcbiAgY3VycmVudE1lbW9yeTogbnVtYmVyO1xuICBwZWFrTWVtb3J5OiBudW1iZXI7XG4gIHRvdGFsSW5jcmVhc2U6IG51bWJlcjtcbiAgdGVzdER1cmF0aW9uOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBUZXN0TWVtb3J5TW9uaXRvciB7XG4gIHByaXZhdGUgc25hcHNob3RzOiBNZW1vcnlTbmFwc2hvdFtdID0gW107XG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XG4gIHByaXZhdGUgbWVtb3J5TGltaXRzOiB7XG4gICAgaGVhcFVzZWQ6IG51bWJlcjtcbiAgICBoZWFwVG90YWw6IG51bWJlcjtcbiAgICBleHRlcm5hbDogbnVtYmVyO1xuICAgIHJzczogbnVtYmVyO1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKGxpbWl0cz86IFBhcnRpYWw8VGVzdE1lbW9yeU1vbml0b3JbJ21lbW9yeUxpbWl0cyddPikge1xuICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1lbW9yeUxpbWl0cyA9IHtcbiAgICAgIGhlYXBVc2VkOiAyMDAgKiAxMDI0ICogMTAyNCwgICAvLyAyMDBNQlxuICAgICAgaGVhcFRvdGFsOiAzMDAgKiAxMDI0ICogMTAyNCwgIC8vIDMwME1CXG4gICAgICBleHRlcm5hbDogNTAgKiAxMDI0ICogMTAyNCwgICAgLy8gNTBNQlxuICAgICAgcnNzOiA0MDAgKiAxMDI0ICogMTAyNCwgICAgICAgIC8vIDQwME1CXG4gICAgICAuLi5saW1pdHNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG1lbW9yeSBtb25pdG9yIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZURlZmF1bHQoKTogVGVzdE1lbW9yeU1vbml0b3Ige1xuICAgIHJldHVybiBuZXcgVGVzdE1lbW9yeU1vbml0b3IoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBtZW1vcnkgbW9uaXRvciB3aXRoIENJLWFwcHJvcHJpYXRlIHNldHRpbmdzIChtb3JlIHJlc3RyaWN0aXZlKVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZUZvckNJKCk6IFRlc3RNZW1vcnlNb25pdG9yIHtcbiAgICByZXR1cm4gbmV3IFRlc3RNZW1vcnlNb25pdG9yKHtcbiAgICAgIGhlYXBVc2VkOiAxNTAgKiAxMDI0ICogMTAyNCwgICAvLyAxNTBNQlxuICAgICAgaGVhcFRvdGFsOiAyMDAgKiAxMDI0ICogMTAyNCwgIC8vIDIwME1CXG4gICAgICBleHRlcm5hbDogMzAgKiAxMDI0ICogMTAyNCwgICAgLy8gMzBNQlxuICAgICAgcnNzOiAyNTAgKiAxMDI0ICogMTAyNCwgICAgICAgIC8vIDI1ME1CXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVGFrZSBhIG1lbW9yeSBzbmFwc2hvdCBhdCBhIHNwZWNpZmljIHBvaW50IGluIHRpbWVcbiAgICovXG4gIHRha2VTbmFwc2hvdCh0ZXN0TmFtZTogc3RyaW5nKTogTWVtb3J5U25hcHNob3Qge1xuICAgIGNvbnN0IHVzYWdlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IHNuYXBzaG90OiBNZW1vcnlTbmFwc2hvdCA9IHtcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHRlc3ROYW1lLFxuICAgICAgaGVhcFVzZWQ6IHVzYWdlLmhlYXBVc2VkLFxuICAgICAgaGVhcFRvdGFsOiB1c2FnZS5oZWFwVG90YWwsXG4gICAgICBleHRlcm5hbDogdXNhZ2UuZXh0ZXJuYWwsXG4gICAgICBhcnJheUJ1ZmZlcnM6IHVzYWdlLmFycmF5QnVmZmVycyxcbiAgICAgIHJzczogdXNhZ2UucnNzXG4gICAgfTtcblxuICAgIHRoaXMuc25hcHNob3RzLnB1c2goc25hcHNob3QpO1xuICAgIHJldHVybiBzbmFwc2hvdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBtZW1vcnkgdXNhZ2VcbiAgICovXG4gIGdldEN1cnJlbnRNZW1vcnlVc2FnZSgpOiBOb2RlSlMuTWVtb3J5VXNhZ2Uge1xuICAgIHJldHVybiBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgY3VycmVudCBtZW1vcnkgdXNhZ2UgaXMgd2l0aGluIGxpbWl0c1xuICAgKi9cbiAgY2hlY2tNZW1vcnlVc2FnZSh0ZXN0TmFtZTogc3RyaW5nKTogTWVtb3J5Q2hlY2sge1xuICAgIGNvbnN0IGN1cnJlbnRVc2FnZSA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgYWdhaW5zdCBsaW1pdHNcbiAgICBpZiAoY3VycmVudFVzYWdlLmhlYXBVc2VkID4gdGhpcy5tZW1vcnlMaW1pdHMuaGVhcFVzZWQgKiAwLjgpIHtcbiAgICAgIHdhcm5pbmdzLnB1c2goYEhlYXAgdXNhZ2UgYXBwcm9hY2hpbmcgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5oZWFwVXNlZCA+IHRoaXMubWVtb3J5TGltaXRzLmhlYXBVc2VkKSB7XG4gICAgICBlcnJvcnMucHVzaChgSGVhcCB1c2FnZSBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5oZWFwVG90YWwgPiB0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVG90YWwpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBIZWFwIHRvdGFsIGV4Y2VlZGVkIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UuaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVG90YWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UuZXh0ZXJuYWwgPiB0aGlzLm1lbW9yeUxpbWl0cy5leHRlcm5hbCkge1xuICAgICAgZXJyb3JzLnB1c2goYEV4dGVybmFsIG1lbW9yeSBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLmV4dGVybmFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5yc3MgPiB0aGlzLm1lbW9yeUxpbWl0cy5yc3MpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBSU1MgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5yc3MgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQiA+ICR7KHRoaXMubWVtb3J5TGltaXRzLnJzcyAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzV2l0aGluTGltaXRzOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgICAgY3VycmVudFVzYWdlLFxuICAgICAgd2FybmluZ3MsXG4gICAgICBlcnJvcnNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBtZW1vcnkgdXNhZ2Ugc3VtbWFyeSBzaW5jZSBtb25pdG9yaW5nIHN0YXJ0ZWRcbiAgICovXG4gIGdldE1lbW9yeVN1bW1hcnkoKTogTWVtb3J5U3VtbWFyeSB7XG4gICAgaWYgKHRoaXMuc25hcHNob3RzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbml0aWFsTWVtb3J5OiBjdXJyZW50LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICAgIGN1cnJlbnRNZW1vcnk6IGN1cnJlbnQuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgICAgcGVha01lbW9yeTogY3VycmVudC5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgICB0b3RhbEluY3JlYXNlOiAwLFxuICAgICAgICB0ZXN0RHVyYXRpb246IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBpbml0aWFsU25hcHNob3QgPSB0aGlzLnNuYXBzaG90c1swXTtcbiAgICBjb25zdCBjdXJyZW50VXNhZ2UgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IHBlYWtNZW1vcnkgPSBNYXRoLm1heCguLi50aGlzLnNuYXBzaG90cy5tYXAocyA9PiBzLmhlYXBVc2VkKSwgY3VycmVudFVzYWdlLmhlYXBVc2VkKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpbml0aWFsTWVtb3J5OiBpbml0aWFsU25hcHNob3QuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgIGN1cnJlbnRNZW1vcnk6IGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgcGVha01lbW9yeTogcGVha01lbW9yeSAvIDEwMjQgLyAxMDI0LFxuICAgICAgdG90YWxJbmNyZWFzZTogKGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAtIGluaXRpYWxTbmFwc2hvdC5oZWFwVXNlZCkgLyAxMDI0IC8gMTAyNCxcbiAgICAgIHRlc3REdXJhdGlvbjogRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbWVtb3J5IHVzYWdlIHRyZW5kIGFuYWx5c2lzXG4gICAqL1xuICBnZXRNZW1vcnlUcmVuZCgpOiB7XG4gICAgaXNJbmNyZWFzaW5nOiBib29sZWFuO1xuICAgIGF2ZXJhZ2VJbmNyZWFzZTogbnVtYmVyO1xuICAgIGNvbmNlcm5pbmdUcmVuZDogYm9vbGVhbjtcbiAgfSB7XG4gICAgaWYgKHRoaXMuc25hcHNob3RzLmxlbmd0aCA8IDMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzSW5jcmVhc2luZzogZmFsc2UsXG4gICAgICAgIGF2ZXJhZ2VJbmNyZWFzZTogMCxcbiAgICAgICAgY29uY2VybmluZ1RyZW5kOiBmYWxzZVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCByZWNlbnRTbmFwc2hvdHMgPSB0aGlzLnNuYXBzaG90cy5zbGljZSgtNSk7IC8vIExhc3QgNSBzbmFwc2hvdHNcbiAgICBjb25zdCBpbmNyZWFzZXMgPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcmVjZW50U25hcHNob3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpbmNyZWFzZSA9IHJlY2VudFNuYXBzaG90c1tpXS5oZWFwVXNlZCAtIHJlY2VudFNuYXBzaG90c1tpIC0gMV0uaGVhcFVzZWQ7XG4gICAgICBpbmNyZWFzZXMucHVzaChpbmNyZWFzZSk7XG4gICAgfVxuXG4gICAgY29uc3QgYXZlcmFnZUluY3JlYXNlID0gaW5jcmVhc2VzLnJlZHVjZSgoc3VtLCBpbmMpID0+IHN1bSArIGluYywgMCkgLyBpbmNyZWFzZXMubGVuZ3RoO1xuICAgIGNvbnN0IGlzSW5jcmVhc2luZyA9IGF2ZXJhZ2VJbmNyZWFzZSA+IDA7XG4gICAgY29uc3QgY29uY2VybmluZ1RyZW5kID0gYXZlcmFnZUluY3JlYXNlID4gMTAgKiAxMDI0ICogMTAyNDsgLy8gTW9yZSB0aGFuIDEwTUIgYXZlcmFnZSBpbmNyZWFzZVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzSW5jcmVhc2luZyxcbiAgICAgIGF2ZXJhZ2VJbmNyZWFzZTogYXZlcmFnZUluY3JlYXNlIC8gMTAyNCAvIDEwMjQsIC8vIENvbnZlcnQgdG8gTUJcbiAgICAgIGNvbmNlcm5pbmdUcmVuZFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBtZW1vcnkgY2xlYW51cCBhbmQgb3B0aW1pemF0aW9uXG4gICAqL1xuICBjbGVhbnVwKHRlc3ROYW1lOiBzdHJpbmcpOiB7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICBmcmVlZE1lbW9yeTogc3RyaW5nO1xuICAgIGFjdGlvbnM6IHN0cmluZ1tdO1xuICB9IHtcbiAgICBjb25zdCBiZWZvcmVDbGVhbnVwID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICBjb25zdCBhY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENsZWFyIGFueSB0ZXN0LXNwZWNpZmljIGNhY2hlc1xuICAgICAgaWYgKGdsb2JhbC5fX1RFU1RfQ0FDSEVfXykge1xuICAgICAgICBpZiAodHlwZW9mIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXy5jbGVhciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIGdsb2JhbC5fX1RFU1RfQ0FDSEVfXy5jbGVhcigpO1xuICAgICAgICAgIGFjdGlvbnMucHVzaCgnQ2xlYXJlZCB0ZXN0IGNhY2hlJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYXIgdGVzdCByZWZlcmVuY2VzXG4gICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9SRUZTX18pIHtcbiAgICAgICAgZ2xvYmFsLl9fVEVTVF9SRUZTX18ubGVuZ3RoID0gMDtcbiAgICAgICAgYWN0aW9ucy5wdXNoKCdDbGVhcmVkIHRlc3QgcmVmZXJlbmNlcycpO1xuICAgICAgfVxuXG4gICAgICAvLyBGb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb24gaWYgYXZhaWxhYmxlXG4gICAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICBhY3Rpb25zLnB1c2goJ0ZvcmNlZCBnYXJiYWdlIGNvbGxlY3Rpb24nKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYXIgSmVzdCBtb2NrcyBhbmQgbW9kdWxlc1xuICAgICAgaWYgKGplc3QpIHtcbiAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgICAgIGFjdGlvbnMucHVzaCgnQ2xlYXJlZCBKZXN0IG1vY2tzJyk7XG4gICAgICAgIFxuICAgICAgICBpZiAoamVzdC5yZXNldE1vZHVsZXMpIHtcbiAgICAgICAgICBqZXN0LnJlc2V0TW9kdWxlcygpO1xuICAgICAgICAgIGFjdGlvbnMucHVzaCgnUmVzZXQgSmVzdCBtb2R1bGVzJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgYWZ0ZXJDbGVhbnVwID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICAgIGNvbnN0IGZyZWVkTWVtb3J5ID0gKGJlZm9yZUNsZWFudXAuaGVhcFVzZWQgLSBhZnRlckNsZWFudXAuaGVhcFVzZWQpIC8gMTAyNCAvIDEwMjQ7XG5cbiAgICAgIC8vIFRha2Ugc25hcHNob3QgYWZ0ZXIgY2xlYW51cFxuICAgICAgdGhpcy50YWtlU25hcHNob3QoYCR7dGVzdE5hbWV9LWNsZWFudXBgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZnJlZWRNZW1vcnk6IGAke2ZyZWVkTWVtb3J5LnRvRml4ZWQoMil9TUJgLFxuICAgICAgICBhY3Rpb25zXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdNZW1vcnkgY2xlYW51cCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGZyZWVkTWVtb3J5OiAnME1CJyxcbiAgICAgICAgYWN0aW9uczogWy4uLmFjdGlvbnMsIGBDbGVhbnVwIGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfWBdXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZGV0YWlsZWQgbWVtb3J5IHJlcG9ydFxuICAgKi9cbiAgZ2V0RGV0YWlsZWRSZXBvcnQoKToge1xuICAgIHN1bW1hcnk6IE1lbW9yeVN1bW1hcnk7XG4gICAgdHJlbmQ6IFJldHVyblR5cGU8VGVzdE1lbW9yeU1vbml0b3JbJ2dldE1lbW9yeVRyZW5kJ10+O1xuICAgIHNuYXBzaG90czogTWVtb3J5U25hcHNob3RbXTtcbiAgICByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdO1xuICB9IHtcbiAgICBjb25zdCBzdW1tYXJ5ID0gdGhpcy5nZXRNZW1vcnlTdW1tYXJ5KCk7XG4gICAgY29uc3QgdHJlbmQgPSB0aGlzLmdldE1lbW9yeVRyZW5kKCk7XG4gICAgY29uc3QgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gR2VuZXJhdGUgcmVjb21tZW5kYXRpb25zIGJhc2VkIG9uIGFuYWx5c2lzXG4gICAgaWYgKHN1bW1hcnkudG90YWxJbmNyZWFzZSA+IDUwKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnQ29uc2lkZXIgcmVkdWNpbmcgdGVzdCBjb21wbGV4aXR5IG9yIGFkZGluZyBtb3JlIGNsZWFudXAnKTtcbiAgICB9XG5cbiAgICBpZiAodHJlbmQuY29uY2VybmluZ1RyZW5kKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnTWVtb3J5IHVzYWdlIGlzIGluY3JlYXNpbmcgcmFwaWRseSAtIGludmVzdGlnYXRlIG1lbW9yeSBsZWFrcycpO1xuICAgIH1cblxuICAgIGlmIChzdW1tYXJ5LnBlYWtNZW1vcnkgPiAxNTApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdQZWFrIG1lbW9yeSB1c2FnZSBpcyBoaWdoIC0gY29uc2lkZXIgc3BsaXR0aW5nIHRlc3RzJyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc25hcHNob3RzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ01hbnkgc25hcHNob3RzIHRha2VuIC0gY29uc2lkZXIgcmVkdWNpbmcgbW9uaXRvcmluZyBmcmVxdWVuY3knKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VtbWFyeSxcbiAgICAgIHRyZW5kLFxuICAgICAgc25hcHNob3RzOiB0aGlzLnNuYXBzaG90cyxcbiAgICAgIHJlY29tbWVuZGF0aW9uc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgbW9uaXRvcmluZyBzdGF0ZVxuICAgKi9cbiAgcmVzZXQoKTogdm9pZCB7XG4gICAgdGhpcy5zbmFwc2hvdHMgPSBbXTtcbiAgICB0aGlzLnN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gIH1cblxuICAvKipcbiAgICogRXhwb3J0IG1lbW9yeSBkYXRhIGZvciBhbmFseXNpc1xuICAgKi9cbiAgZXhwb3J0RGF0YSgpOiB7XG4gICAgbWV0YWRhdGE6IHtcbiAgICAgIHN0YXJ0VGltZTogbnVtYmVyO1xuICAgICAgZW5kVGltZTogbnVtYmVyO1xuICAgICAgZHVyYXRpb246IG51bWJlcjtcbiAgICAgIHNuYXBzaG90Q291bnQ6IG51bWJlcjtcbiAgICB9O1xuICAgIHNuYXBzaG90czogTWVtb3J5U25hcHNob3RbXTtcbiAgICBzdW1tYXJ5OiBNZW1vcnlTdW1tYXJ5O1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgc3RhcnRUaW1lOiB0aGlzLnN0YXJ0VGltZSxcbiAgICAgICAgZW5kVGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZSxcbiAgICAgICAgc25hcHNob3RDb3VudDogdGhpcy5zbmFwc2hvdHMubGVuZ3RoXG4gICAgICB9LFxuICAgICAgc25hcHNob3RzOiB0aGlzLnNuYXBzaG90cyxcbiAgICAgIHN1bW1hcnk6IHRoaXMuZ2V0TWVtb3J5U3VtbWFyeSgpXG4gICAgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==