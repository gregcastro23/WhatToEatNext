66e474f0514a22c32d308bcf2ffb511a
"use strict";
/**
 * Test Memory Monitor Utility
 *
 * Provides memory monitoring and management capabilities for test environments.
 * Used in comprehensive validation testing to ensure memory usage stays within limits.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestMemoryMonitor = void 0;
class TestMemoryMonitor {
    snapshots = [];
    startTime;
    memoryLimits;
    constructor(limits) {
        this.startTime = Date.now();
        this.memoryLimits = {
            heapUsed: 200 * 1024 * 1024,
            heapTotal: 300 * 1024 * 1024,
            external: 50 * 1024 * 1024,
            rss: 400 * 1024 * 1024,
            ...limits,
        };
    }
    /**
     * Create a memory monitor with default settings
     */
    static createDefault() {
        return new TestMemoryMonitor();
    }
    /**
     * Create a memory monitor with CI-appropriate settings (more restrictive)
     */
    static createForCI() {
        return new TestMemoryMonitor({
            heapUsed: 150 * 1024 * 1024,
            heapTotal: 200 * 1024 * 1024,
            external: 30 * 1024 * 1024,
            rss: 250 * 1024 * 1024, // 250MB
        });
    }
    /**
     * Take a memory snapshot at a specific point in time
     */
    takeSnapshot(testName) {
        const usage = process.memoryUsage();
        const snapshot = {
            timestamp: new Date(),
            testName,
            heapUsed: usage.heapUsed,
            heapTotal: usage.heapTotal,
            external: usage.external,
            arrayBuffers: usage.arrayBuffers,
            rss: usage.rss,
        };
        this.snapshots.push(snapshot);
        return snapshot;
    }
    /**
     * Get current memory usage
     */
    getCurrentMemoryUsage() {
        return process.memoryUsage();
    }
    /**
     * Check if current memory usage is within limits
     */
    checkMemoryUsage(_testName) {
        const currentUsage = this.getCurrentMemoryUsage();
        const warnings = [];
        const errors = [];
        // Check against limits
        if (currentUsage.heapUsed > (this.memoryLimits?.heapUsed || 0) * 0.2) {
            warnings.push(`Heap usage approaching limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed) {
            errors.push(`Heap usage exceeded limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapTotal > this.memoryLimits.heapTotal) {
            errors.push(`Heap total exceeded limit: ${(currentUsage.heapTotal / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapTotal / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.external > this.memoryLimits.external) {
            errors.push(`External memory exceeded limit: ${(currentUsage.external / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.external / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.rss > this.memoryLimits.rss) {
            errors.push(`RSS exceeded limit: ${(currentUsage.rss / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.rss / 1024 / 1024).toFixed(2)}MB`);
        }
        return {
            isWithinLimits: errors.length === 0,
            currentUsage,
            warnings,
            errors,
        };
    }
    /**
     * Get memory usage summary since monitoring started
     */
    getMemorySummary() {
        if (this.snapshots.length === 0) {
            const current = this.getCurrentMemoryUsage();
            return {
                initialMemory: current.heapUsed / 1024 / 1024,
                currentMemory: current.heapUsed / 1024 / 1024,
                peakMemory: current.heapUsed / 1024 / 1024,
                totalIncrease: 0,
                testDuration: Date.now() - this.startTime,
            };
        }
        const initialSnapshot = this.snapshots[0];
        const currentUsage = this.getCurrentMemoryUsage();
        const peakMemory = Math.max(...this.snapshots.map(s => s.heapUsed), currentUsage.heapUsed);
        return {
            initialMemory: initialSnapshot.heapUsed / 1024 / 1024,
            currentMemory: currentUsage.heapUsed / 1024 / 1024,
            peakMemory: peakMemory / 1024 / 1024,
            totalIncrease: (currentUsage.heapUsed - initialSnapshot.heapUsed) / 1024 / 1024,
            testDuration: Date.now() - this.startTime,
        };
    }
    /**
     * Get memory usage trend analysis
     */
    getMemoryTrend() {
        if (this.snapshots.length < 3) {
            return {
                isIncreasing: false,
                averageIncrease: 0,
                concerningTrend: false,
            };
        }
        const recentSnapshots = this.snapshots.slice(-5); // Last 5 snapshots
        const increases = [];
        for (let i = 1; i < recentSnapshots.length; i++) {
            const increase = recentSnapshots[i].heapUsed - recentSnapshots[i - 1].heapUsed;
            increases.push(increase);
        }
        const averageIncrease = increases.reduce((sum, inc) => sum + inc, 0) / increases.length;
        const isIncreasing = averageIncrease > 0;
        const concerningTrend = averageIncrease > 10 * 1024 * 1024; // More than 10MB average increase
        return {
            isIncreasing,
            averageIncrease: averageIncrease / 1024 / 1024,
            concerningTrend,
        };
    }
    /**
     * Perform memory cleanup and optimization
     */
    cleanup(testName) {
        const beforeCleanup = this.getCurrentMemoryUsage();
        const actions = [];
        try {
            // Clear any test-specific caches
            if (global.__TEST_CACHE__) {
                if (typeof global.__TEST_CACHE__.clear === 'function') {
                    global.__TEST_CACHE__.clear();
                    actions.push('Cleared test cache');
                }
            }
            // Clear test references
            if (global.__TEST_REFS__) {
                global.__TEST_REFS__.length = 0;
                actions.push('Cleared test references');
            }
            // Force garbage collection if available
            if (global.gc) {
                global.gc();
                actions.push('Forced garbage collection');
            }
            // Clear Jest mocks and modules
            if (jest) {
                jest.clearAllMocks();
                actions.push('Cleared Jest mocks');
                if (jest.resetModules) {
                    jest.resetModules();
                    actions.push('Reset Jest modules');
                }
            }
            const afterCleanup = this.getCurrentMemoryUsage();
            const freedMemory = (beforeCleanup.heapUsed - afterCleanup.heapUsed) / 1024 / 1024;
            // Take snapshot after cleanup
            this.takeSnapshot(`${testName}-cleanup`);
            return {
                success: true,
                freedMemory: `${freedMemory.toFixed(2)}MB`,
                actions,
            };
        }
        catch (error) {
            console.error('Memory cleanup failed:', error);
            return {
                success: false,
                freedMemory: '0MB',
                actions: [...actions, `Cleanup failed: ${error.message}`],
            };
        }
    }
    /**
     * Get detailed memory report
     */
    getDetailedReport() {
        const summary = this.getMemorySummary();
        const trend = this.getMemoryTrend();
        const recommendations = [];
        // Generate recommendations based on analysis
        if (summary.totalIncrease > 50) {
            recommendations.push('Consider reducing test complexity or adding more cleanup');
        }
        if (trend.concerningTrend) {
            recommendations.push('Memory usage is increasing rapidly - investigate memory leaks');
        }
        if (summary.peakMemory > 150) {
            recommendations.push('Peak memory usage is high - consider splitting tests');
        }
        if (this.snapshots.length > 100) {
            recommendations.push('Many snapshots taken - consider reducing monitoring frequency');
        }
        return {
            summary,
            trend,
            snapshots: this.snapshots,
            recommendations,
        };
    }
    /**
     * Reset monitoring state
     */
    reset() {
        this.snapshots = [];
        this.startTime = Date.now();
    }
    /**
     * Export memory data for analysis
     */
    exportData() {
        return {
            metadata: {
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Date.now() - this.startTime,
                snapshotCount: this.snapshots.length,
            },
            snapshots: this.snapshots,
            summary: this.getMemorySummary(),
        };
    }
}
exports.TestMemoryMonitor = TestMemoryMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9fX3Rlc3RzX18vdXRpbHMvVGVzdE1lbW9yeU1vbml0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUEyQkgsTUFBYSxpQkFBaUI7SUFDcEIsU0FBUyxHQUFxQixFQUFFLENBQUM7SUFDakMsU0FBUyxDQUFTO0lBQ2xCLFlBQVksQ0FLbEI7SUFFRixZQUFZLE1BQW1EO1FBQzdELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsUUFBUSxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMzQixTQUFTLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzVCLFFBQVEsRUFBRSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDMUIsR0FBRyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUN0QixHQUFHLE1BQU07U0FDVixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGFBQWE7UUFDbEIsT0FBTyxJQUFJLGlCQUFpQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVc7UUFDaEIsT0FBTyxJQUFJLGlCQUFpQixDQUFDO1lBQzNCLFFBQVEsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDM0IsU0FBUyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUM1QixRQUFRLEVBQUUsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzFCLEdBQUcsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUksRUFBRSxRQUFRO1NBQ2pDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxRQUFnQjtRQUMzQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDcEMsTUFBTSxRQUFRLEdBQW1CO1lBQy9CLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtZQUNyQixRQUFRO1lBQ1IsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRO1lBQ3hCLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztZQUMxQixRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVE7WUFDeEIsWUFBWSxFQUFFLEtBQUssQ0FBQyxZQUFZO1lBQ2hDLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztTQUNmLENBQUM7UUFFRixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM5QixPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxxQkFBcUI7UUFDbkIsT0FBTyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0JBQWdCLENBQUMsU0FBaUI7UUFDaEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDbEQsTUFBTSxRQUFRLEdBQWEsRUFBRSxDQUFDO1FBQzlCLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUU1Qix1QkFBdUI7UUFDdkIsSUFBSSxZQUFZLENBQUMsUUFBUSxHQUFHLENBQUUsSUFBSSxDQUFDLFlBQW9CLEVBQUUsUUFBUSxJQUFJLENBQUMsQ0FBQyxHQUFHLEdBQUcsRUFBRTtZQUM3RSxRQUFRLENBQUMsSUFBSSxDQUNYLGlDQUFpQyxDQUFDLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUN0RixDQUFDO1NBQ0g7UUFFRCxJQUFJLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUU7WUFDdEQsTUFBTSxDQUFDLElBQUksQ0FDVCw4QkFBOEIsQ0FBQyxZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ2hKLENBQUM7U0FDSDtRQUVELElBQUksWUFBWSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRTtZQUN4RCxNQUFNLENBQUMsSUFBSSxDQUNULDhCQUE4QixDQUFDLFlBQVksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDbEosQ0FBQztTQUNIO1FBRUQsSUFBSSxZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFO1lBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQ1QsbUNBQW1DLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNySixDQUFDO1NBQ0g7UUFFRCxJQUFJLFlBQVksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7WUFDNUMsTUFBTSxDQUFDLElBQUksQ0FDVCx1QkFBdUIsQ0FBQyxZQUFZLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQy9ILENBQUM7U0FDSDtRQUVELE9BQU87WUFDTCxjQUFjLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQ25DLFlBQVk7WUFDWixRQUFRO1lBQ1IsTUFBTTtTQUNQLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0I7UUFDZCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUM3QyxPQUFPO2dCQUNMLGFBQWEsRUFBRSxPQUFPLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJO2dCQUM3QyxhQUFhLEVBQUUsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSTtnQkFDN0MsVUFBVSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUk7Z0JBQzFDLGFBQWEsRUFBRSxDQUFDO2dCQUNoQixZQUFZLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTO2FBQzFDLENBQUM7U0FDSDtRQUVELE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDbEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUzRixPQUFPO1lBQ0wsYUFBYSxFQUFFLGVBQWUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDckQsYUFBYSxFQUFFLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDbEQsVUFBVSxFQUFFLFVBQVUsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUNwQyxhQUFhLEVBQUUsQ0FBQyxZQUFZLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMvRSxZQUFZLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTO1NBQzFDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjO1FBS1osSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0IsT0FBTztnQkFDTCxZQUFZLEVBQUUsS0FBSztnQkFDbkIsZUFBZSxFQUFFLENBQUM7Z0JBQ2xCLGVBQWUsRUFBRSxLQUFLO2FBQ3ZCLENBQUM7U0FDSDtRQUVELE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQkFBbUI7UUFDckUsTUFBTSxTQUFTLEdBQWEsRUFBRSxDQUFDO1FBRS9CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQy9DLE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsZUFBZSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFDL0UsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMxQjtRQUVELE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUM7UUFDeEYsTUFBTSxZQUFZLEdBQUcsZUFBZSxHQUFHLENBQUMsQ0FBQztRQUN6QyxNQUFNLGVBQWUsR0FBRyxlQUFlLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxrQ0FBa0M7UUFFOUYsT0FBTztZQUNMLFlBQVk7WUFDWixlQUFlLEVBQUUsZUFBZSxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzlDLGVBQWU7U0FDaEIsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU8sQ0FBQyxRQUFnQjtRQUt0QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUNuRCxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUM7UUFFN0IsSUFBSTtZQUNGLGlDQUFpQztZQUNqQyxJQUFJLE1BQU0sQ0FBQyxjQUFjLEVBQUU7Z0JBQ3pCLElBQUksT0FBTyxNQUFNLENBQUMsY0FBYyxDQUFDLEtBQUssS0FBSyxVQUFVLEVBQUU7b0JBQ3JELE1BQU0sQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQzlCLE9BQU8sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztpQkFDcEM7YUFDRjtZQUVELHdCQUF3QjtZQUN4QixJQUFJLE1BQU0sQ0FBQyxhQUFhLEVBQUU7Z0JBQ3hCLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztnQkFDaEMsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO2FBQ3pDO1lBRUQsd0NBQXdDO1lBQ3hDLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDYixNQUFNLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ1osT0FBTyxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO2FBQzNDO1lBRUQsK0JBQStCO1lBQy9CLElBQUksSUFBSSxFQUFFO2dCQUNSLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUVuQyxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7b0JBQ3JCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztvQkFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2lCQUNwQzthQUNGO1lBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDbEQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBRW5GLDhCQUE4QjtZQUM5QixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsUUFBUSxVQUFVLENBQUMsQ0FBQztZQUV6QyxPQUFPO2dCQUNMLE9BQU8sRUFBRSxJQUFJO2dCQUNiLFdBQVcsRUFBRSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUk7Z0JBQzFDLE9BQU87YUFDUixDQUFDO1NBQ0g7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDL0MsT0FBTztnQkFDTCxPQUFPLEVBQUUsS0FBSztnQkFDZCxXQUFXLEVBQUUsS0FBSztnQkFDbEIsT0FBTyxFQUFFLENBQUMsR0FBRyxPQUFPLEVBQUUsbUJBQW9CLEtBQWUsQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUNyRSxDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxpQkFBaUI7UUFNZixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDcEMsTUFBTSxlQUFlLEdBQWEsRUFBRSxDQUFDO1FBRXJDLDZDQUE2QztRQUM3QyxJQUFJLE9BQU8sQ0FBQyxhQUFhLEdBQUcsRUFBRSxFQUFFO1lBQzlCLGVBQWUsQ0FBQyxJQUFJLENBQUMsMERBQTBELENBQUMsQ0FBQztTQUNsRjtRQUVELElBQUksS0FBSyxDQUFDLGVBQWUsRUFBRTtZQUN6QixlQUFlLENBQUMsSUFBSSxDQUFDLCtEQUErRCxDQUFDLENBQUM7U0FDdkY7UUFFRCxJQUFJLE9BQU8sQ0FBQyxVQUFVLEdBQUcsR0FBRyxFQUFFO1lBQzVCLGVBQWUsQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztTQUM5RTtRQUVELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQy9CLGVBQWUsQ0FBQyxJQUFJLENBQUMsK0RBQStELENBQUMsQ0FBQztTQUN2RjtRQUVELE9BQU87WUFDTCxPQUFPO1lBQ1AsS0FBSztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixlQUFlO1NBQ2hCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsVUFBVTtRQVVSLE9BQU87WUFDTCxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUztnQkFDckMsYUFBYSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTTthQUNyQztZQUNELFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1NBQ2pDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUF0VEQsOENBc1RDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvX190ZXN0c19fL3V0aWxzL1Rlc3RNZW1vcnlNb25pdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdCBNZW1vcnkgTW9uaXRvciBVdGlsaXR5XG4gKlxuICogUHJvdmlkZXMgbWVtb3J5IG1vbml0b3JpbmcgYW5kIG1hbmFnZW1lbnQgY2FwYWJpbGl0aWVzIGZvciB0ZXN0IGVudmlyb25tZW50cy5cbiAqIFVzZWQgaW4gY29tcHJlaGVuc2l2ZSB2YWxpZGF0aW9uIHRlc3RpbmcgdG8gZW5zdXJlIG1lbW9yeSB1c2FnZSBzdGF5cyB3aXRoaW4gbGltaXRzLlxuICovXG5cbmludGVyZmFjZSBNZW1vcnlTbmFwc2hvdCB7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgdGVzdE5hbWU6IHN0cmluZztcbiAgaGVhcFVzZWQ6IG51bWJlcjtcbiAgaGVhcFRvdGFsOiBudW1iZXI7XG4gIGV4dGVybmFsOiBudW1iZXI7XG4gIGFycmF5QnVmZmVyczogbnVtYmVyO1xuICByc3M6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIE1lbW9yeUNoZWNrIHtcbiAgaXNXaXRoaW5MaW1pdHM6IGJvb2xlYW47XG4gIGN1cnJlbnRVc2FnZTogTm9kZUpTLk1lbW9yeVVzYWdlO1xuICB3YXJuaW5nczogc3RyaW5nW107XG4gIGVycm9yczogc3RyaW5nW107XG59XG5cbmludGVyZmFjZSBNZW1vcnlTdW1tYXJ5IHtcbiAgaW5pdGlhbE1lbW9yeTogbnVtYmVyO1xuICBjdXJyZW50TWVtb3J5OiBudW1iZXI7XG4gIHBlYWtNZW1vcnk6IG51bWJlcjtcbiAgdG90YWxJbmNyZWFzZTogbnVtYmVyO1xuICB0ZXN0RHVyYXRpb246IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFRlc3RNZW1vcnlNb25pdG9yIHtcbiAgcHJpdmF0ZSBzbmFwc2hvdHM6IE1lbW9yeVNuYXBzaG90W10gPSBbXTtcbiAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBtZW1vcnlMaW1pdHM6IHtcbiAgICBoZWFwVXNlZDogbnVtYmVyO1xuICAgIGhlYXBUb3RhbDogbnVtYmVyO1xuICAgIGV4dGVybmFsOiBudW1iZXI7XG4gICAgcnNzOiBudW1iZXI7XG4gIH07XG5cbiAgY29uc3RydWN0b3IobGltaXRzPzogUGFydGlhbDxUZXN0TWVtb3J5TW9uaXRvclsnbWVtb3J5TGltaXRzJ10+KSB7XG4gICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMubWVtb3J5TGltaXRzID0ge1xuICAgICAgaGVhcFVzZWQ6IDIwMCAqIDEwMjQgKiAxMDI0LCAvLyAyMDBNQlxuICAgICAgaGVhcFRvdGFsOiAzMDAgKiAxMDI0ICogMTAyNCwgLy8gMzAwTUJcbiAgICAgIGV4dGVybmFsOiA1MCAqIDEwMjQgKiAxMDI0LCAvLyA1ME1CXG4gICAgICByc3M6IDQwMCAqIDEwMjQgKiAxMDI0LCAvLyA0MDBNQlxuICAgICAgLi4ubGltaXRzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbWVtb3J5IG1vbml0b3Igd2l0aCBkZWZhdWx0IHNldHRpbmdzXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlRGVmYXVsdCgpOiBUZXN0TWVtb3J5TW9uaXRvciB7XG4gICAgcmV0dXJuIG5ldyBUZXN0TWVtb3J5TW9uaXRvcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG1lbW9yeSBtb25pdG9yIHdpdGggQ0ktYXBwcm9wcmlhdGUgc2V0dGluZ3MgKG1vcmUgcmVzdHJpY3RpdmUpXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlRm9yQ0koKTogVGVzdE1lbW9yeU1vbml0b3Ige1xuICAgIHJldHVybiBuZXcgVGVzdE1lbW9yeU1vbml0b3Ioe1xuICAgICAgaGVhcFVzZWQ6IDE1MCAqIDEwMjQgKiAxMDI0LCAvLyAxNTBNQlxuICAgICAgaGVhcFRvdGFsOiAyMDAgKiAxMDI0ICogMTAyNCwgLy8gMjAwTUJcbiAgICAgIGV4dGVybmFsOiAzMCAqIDEwMjQgKiAxMDI0LCAvLyAzME1CXG4gICAgICByc3M6IDI1MCAqIDEwMjQgKiAxMDI0LCAvLyAyNTBNQlxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRha2UgYSBtZW1vcnkgc25hcHNob3QgYXQgYSBzcGVjaWZpYyBwb2ludCBpbiB0aW1lXG4gICAqL1xuICB0YWtlU25hcHNob3QodGVzdE5hbWU6IHN0cmluZyk6IE1lbW9yeVNuYXBzaG90IHtcbiAgICBjb25zdCB1c2FnZSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcbiAgICBjb25zdCBzbmFwc2hvdDogTWVtb3J5U25hcHNob3QgPSB7XG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB0ZXN0TmFtZSxcbiAgICAgIGhlYXBVc2VkOiB1c2FnZS5oZWFwVXNlZCxcbiAgICAgIGhlYXBUb3RhbDogdXNhZ2UuaGVhcFRvdGFsLFxuICAgICAgZXh0ZXJuYWw6IHVzYWdlLmV4dGVybmFsLFxuICAgICAgYXJyYXlCdWZmZXJzOiB1c2FnZS5hcnJheUJ1ZmZlcnMsXG4gICAgICByc3M6IHVzYWdlLnJzcyxcbiAgICB9O1xuXG4gICAgdGhpcy5zbmFwc2hvdHMucHVzaChzbmFwc2hvdCk7XG4gICAgcmV0dXJuIHNuYXBzaG90O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IG1lbW9yeSB1c2FnZVxuICAgKi9cbiAgZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk6IE5vZGVKUy5NZW1vcnlVc2FnZSB7XG4gICAgcmV0dXJuIHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjdXJyZW50IG1lbW9yeSB1c2FnZSBpcyB3aXRoaW4gbGltaXRzXG4gICAqL1xuICBjaGVja01lbW9yeVVzYWdlKF90ZXN0TmFtZTogc3RyaW5nKTogTWVtb3J5Q2hlY2sge1xuICAgIGNvbnN0IGN1cnJlbnRVc2FnZSA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgYWdhaW5zdCBsaW1pdHNcbiAgICBpZiAoY3VycmVudFVzYWdlLmhlYXBVc2VkID4gKCh0aGlzLm1lbW9yeUxpbWl0cyBhcyBhbnkpPy5oZWFwVXNlZCB8fCAwKSAqIDAuMikge1xuICAgICAgd2FybmluZ3MucHVzaChcbiAgICAgICAgYEhlYXAgdXNhZ2UgYXBwcm9hY2hpbmcgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5oZWFwVXNlZCA+IHRoaXMubWVtb3J5TGltaXRzLmhlYXBVc2VkKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYEhlYXAgdXNhZ2UgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UuaGVhcFRvdGFsID4gdGhpcy5tZW1vcnlMaW1pdHMuaGVhcFRvdGFsKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYEhlYXAgdG90YWwgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5oZWFwVG90YWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQiA+ICR7KHRoaXMubWVtb3J5TGltaXRzLmhlYXBUb3RhbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5leHRlcm5hbCA+IHRoaXMubWVtb3J5TGltaXRzLmV4dGVybmFsKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYEV4dGVybmFsIG1lbW9yeSBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLmV4dGVybmFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRVc2FnZS5yc3MgPiB0aGlzLm1lbW9yeUxpbWl0cy5yc3MpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgUlNTIGV4Y2VlZGVkIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UucnNzIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5yc3MgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc1dpdGhpbkxpbWl0czogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIGN1cnJlbnRVc2FnZSxcbiAgICAgIHdhcm5pbmdzLFxuICAgICAgZXJyb3JzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1lbW9yeSB1c2FnZSBzdW1tYXJ5IHNpbmNlIG1vbml0b3Jpbmcgc3RhcnRlZFxuICAgKi9cbiAgZ2V0TWVtb3J5U3VtbWFyeSgpOiBNZW1vcnlTdW1tYXJ5IHtcbiAgICBpZiAodGhpcy5zbmFwc2hvdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGluaXRpYWxNZW1vcnk6IGN1cnJlbnQuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgICAgY3VycmVudE1lbW9yeTogY3VycmVudC5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgICBwZWFrTWVtb3J5OiBjdXJyZW50LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICAgIHRvdGFsSW5jcmVhc2U6IDAsXG4gICAgICAgIHRlc3REdXJhdGlvbjogRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBpbml0aWFsU25hcHNob3QgPSB0aGlzLnNuYXBzaG90c1swXTtcbiAgICBjb25zdCBjdXJyZW50VXNhZ2UgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IHBlYWtNZW1vcnkgPSBNYXRoLm1heCguLi50aGlzLnNuYXBzaG90cy5tYXAocyA9PiBzLmhlYXBVc2VkKSwgY3VycmVudFVzYWdlLmhlYXBVc2VkKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpbml0aWFsTWVtb3J5OiBpbml0aWFsU25hcHNob3QuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgIGN1cnJlbnRNZW1vcnk6IGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgcGVha01lbW9yeTogcGVha01lbW9yeSAvIDEwMjQgLyAxMDI0LFxuICAgICAgdG90YWxJbmNyZWFzZTogKGN1cnJlbnRVc2FnZS5oZWFwVXNlZCAtIGluaXRpYWxTbmFwc2hvdC5oZWFwVXNlZCkgLyAxMDI0IC8gMTAyNCxcbiAgICAgIHRlc3REdXJhdGlvbjogRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1lbW9yeSB1c2FnZSB0cmVuZCBhbmFseXNpc1xuICAgKi9cbiAgZ2V0TWVtb3J5VHJlbmQoKToge1xuICAgIGlzSW5jcmVhc2luZzogYm9vbGVhbjtcbiAgICBhdmVyYWdlSW5jcmVhc2U6IG51bWJlcjtcbiAgICBjb25jZXJuaW5nVHJlbmQ6IGJvb2xlYW47XG4gIH0ge1xuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPCAzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0luY3JlYXNpbmc6IGZhbHNlLFxuICAgICAgICBhdmVyYWdlSW5jcmVhc2U6IDAsXG4gICAgICAgIGNvbmNlcm5pbmdUcmVuZDogZmFsc2UsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IHJlY2VudFNuYXBzaG90cyA9IHRoaXMuc25hcHNob3RzLnNsaWNlKC01KTsgLy8gTGFzdCA1IHNuYXBzaG90c1xuICAgIGNvbnN0IGluY3JlYXNlczogbnVtYmVyW10gPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcmVjZW50U25hcHNob3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpbmNyZWFzZSA9IHJlY2VudFNuYXBzaG90c1tpXS5oZWFwVXNlZCAtIHJlY2VudFNuYXBzaG90c1tpIC0gMV0uaGVhcFVzZWQ7XG4gICAgICBpbmNyZWFzZXMucHVzaChpbmNyZWFzZSk7XG4gICAgfVxuXG4gICAgY29uc3QgYXZlcmFnZUluY3JlYXNlID0gaW5jcmVhc2VzLnJlZHVjZSgoc3VtLCBpbmMpID0+IHN1bSArIGluYywgMCkgLyBpbmNyZWFzZXMubGVuZ3RoO1xuICAgIGNvbnN0IGlzSW5jcmVhc2luZyA9IGF2ZXJhZ2VJbmNyZWFzZSA+IDA7XG4gICAgY29uc3QgY29uY2VybmluZ1RyZW5kID0gYXZlcmFnZUluY3JlYXNlID4gMTAgKiAxMDI0ICogMTAyNDsgLy8gTW9yZSB0aGFuIDEwTUIgYXZlcmFnZSBpbmNyZWFzZVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlzSW5jcmVhc2luZyxcbiAgICAgIGF2ZXJhZ2VJbmNyZWFzZTogYXZlcmFnZUluY3JlYXNlIC8gMTAyNCAvIDEwMjQsIC8vIENvbnZlcnQgdG8gTUJcbiAgICAgIGNvbmNlcm5pbmdUcmVuZCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gbWVtb3J5IGNsZWFudXAgYW5kIG9wdGltaXphdGlvblxuICAgKi9cbiAgY2xlYW51cCh0ZXN0TmFtZTogc3RyaW5nKToge1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgZnJlZWRNZW1vcnk6IHN0cmluZztcbiAgICBhY3Rpb25zOiBzdHJpbmdbXTtcbiAgfSB7XG4gICAgY29uc3QgYmVmb3JlQ2xlYW51cCA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgY29uc3QgYWN0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBDbGVhciBhbnkgdGVzdC1zcGVjaWZpYyBjYWNoZXNcbiAgICAgIGlmIChnbG9iYWwuX19URVNUX0NBQ0hFX18pIHtcbiAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWwuX19URVNUX0NBQ0hFX18uY2xlYXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICBnbG9iYWwuX19URVNUX0NBQ0hFX18uY2xlYXIoKTtcbiAgICAgICAgICBhY3Rpb25zLnB1c2goJ0NsZWFyZWQgdGVzdCBjYWNoZScpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENsZWFyIHRlc3QgcmVmZXJlbmNlc1xuICAgICAgaWYgKGdsb2JhbC5fX1RFU1RfUkVGU19fKSB7XG4gICAgICAgIGdsb2JhbC5fX1RFU1RfUkVGU19fLmxlbmd0aCA9IDA7XG4gICAgICAgIGFjdGlvbnMucHVzaCgnQ2xlYXJlZCB0ZXN0IHJlZmVyZW5jZXMnKTtcbiAgICAgIH1cblxuICAgICAgLy8gRm9yY2UgZ2FyYmFnZSBjb2xsZWN0aW9uIGlmIGF2YWlsYWJsZVxuICAgICAgaWYgKGdsb2JhbC5nYykge1xuICAgICAgICBnbG9iYWwuZ2MoKTtcbiAgICAgICAgYWN0aW9ucy5wdXNoKCdGb3JjZWQgZ2FyYmFnZSBjb2xsZWN0aW9uJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIENsZWFyIEplc3QgbW9ja3MgYW5kIG1vZHVsZXNcbiAgICAgIGlmIChqZXN0KSB7XG4gICAgICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgICAgICBhY3Rpb25zLnB1c2goJ0NsZWFyZWQgSmVzdCBtb2NrcycpO1xuXG4gICAgICAgIGlmIChqZXN0LnJlc2V0TW9kdWxlcykge1xuICAgICAgICAgIGplc3QucmVzZXRNb2R1bGVzKCk7XG4gICAgICAgICAgYWN0aW9ucy5wdXNoKCdSZXNldCBKZXN0IG1vZHVsZXMnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBhZnRlckNsZWFudXAgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgICAgY29uc3QgZnJlZWRNZW1vcnkgPSAoYmVmb3JlQ2xlYW51cC5oZWFwVXNlZCAtIGFmdGVyQ2xlYW51cC5oZWFwVXNlZCkgLyAxMDI0IC8gMTAyNDtcblxuICAgICAgLy8gVGFrZSBzbmFwc2hvdCBhZnRlciBjbGVhbnVwXG4gICAgICB0aGlzLnRha2VTbmFwc2hvdChgJHt0ZXN0TmFtZX0tY2xlYW51cGApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBmcmVlZE1lbW9yeTogYCR7ZnJlZWRNZW1vcnkudG9GaXhlZCgyKX1NQmAsXG4gICAgICAgIGFjdGlvbnMsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdNZW1vcnkgY2xlYW51cCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGZyZWVkTWVtb3J5OiAnME1CJyxcbiAgICAgICAgYWN0aW9uczogWy4uLmFjdGlvbnMsIGBDbGVhbnVwIGZhaWxlZDogJHsoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2V9YF0sXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZGV0YWlsZWQgbWVtb3J5IHJlcG9ydFxuICAgKi9cbiAgZ2V0RGV0YWlsZWRSZXBvcnQoKToge1xuICAgIHN1bW1hcnk6IE1lbW9yeVN1bW1hcnk7XG4gICAgdHJlbmQ6IFJldHVyblR5cGU8VGVzdE1lbW9yeU1vbml0b3JbJ2dldE1lbW9yeVRyZW5kJ10+O1xuICAgIHNuYXBzaG90czogTWVtb3J5U25hcHNob3RbXTtcbiAgICByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdO1xuICB9IHtcbiAgICBjb25zdCBzdW1tYXJ5ID0gdGhpcy5nZXRNZW1vcnlTdW1tYXJ5KCk7XG4gICAgY29uc3QgdHJlbmQgPSB0aGlzLmdldE1lbW9yeVRyZW5kKCk7XG4gICAgY29uc3QgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gR2VuZXJhdGUgcmVjb21tZW5kYXRpb25zIGJhc2VkIG9uIGFuYWx5c2lzXG4gICAgaWYgKHN1bW1hcnkudG90YWxJbmNyZWFzZSA+IDUwKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnQ29uc2lkZXIgcmVkdWNpbmcgdGVzdCBjb21wbGV4aXR5IG9yIGFkZGluZyBtb3JlIGNsZWFudXAnKTtcbiAgICB9XG5cbiAgICBpZiAodHJlbmQuY29uY2VybmluZ1RyZW5kKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnTWVtb3J5IHVzYWdlIGlzIGluY3JlYXNpbmcgcmFwaWRseSAtIGludmVzdGlnYXRlIG1lbW9yeSBsZWFrcycpO1xuICAgIH1cblxuICAgIGlmIChzdW1tYXJ5LnBlYWtNZW1vcnkgPiAxNTApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdQZWFrIG1lbW9yeSB1c2FnZSBpcyBoaWdoIC0gY29uc2lkZXIgc3BsaXR0aW5nIHRlc3RzJyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc25hcHNob3RzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ01hbnkgc25hcHNob3RzIHRha2VuIC0gY29uc2lkZXIgcmVkdWNpbmcgbW9uaXRvcmluZyBmcmVxdWVuY3knKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VtbWFyeSxcbiAgICAgIHRyZW5kLFxuICAgICAgc25hcHNob3RzOiB0aGlzLnNuYXBzaG90cyxcbiAgICAgIHJlY29tbWVuZGF0aW9ucyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IG1vbml0b3Jpbmcgc3RhdGVcbiAgICovXG4gIHJlc2V0KCk6IHZvaWQge1xuICAgIHRoaXMuc25hcHNob3RzID0gW107XG4gICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCBtZW1vcnkgZGF0YSBmb3IgYW5hbHlzaXNcbiAgICovXG4gIGV4cG9ydERhdGEoKToge1xuICAgIG1ldGFkYXRhOiB7XG4gICAgICBzdGFydFRpbWU6IG51bWJlcjtcbiAgICAgIGVuZFRpbWU6IG51bWJlcjtcbiAgICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gICAgICBzbmFwc2hvdENvdW50OiBudW1iZXI7XG4gICAgfTtcbiAgICBzbmFwc2hvdHM6IE1lbW9yeVNuYXBzaG90W107XG4gICAgc3VtbWFyeTogTWVtb3J5U3VtbWFyeTtcbiAgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHN0YXJ0VGltZTogdGhpcy5zdGFydFRpbWUsXG4gICAgICAgIGVuZFRpbWU6IERhdGUubm93KCksXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWUsXG4gICAgICAgIHNuYXBzaG90Q291bnQ6IHRoaXMuc25hcHNob3RzLmxlbmd0aCxcbiAgICAgIH0sXG4gICAgICBzbmFwc2hvdHM6IHRoaXMuc25hcHNob3RzLFxuICAgICAgc3VtbWFyeTogdGhpcy5nZXRNZW1vcnlTdW1tYXJ5KCksXG4gICAgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9