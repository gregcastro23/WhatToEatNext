769ad7e431b43d1acf161d6888668f52
"use strict";
/**
 * Test Memory Monitor Utility
 *
 * Provides memory monitoring and management capabilities for test environments.
 * Used in comprehensive validation testing to ensure memory usage stays within limits.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestMemoryMonitor = void 0;
class TestMemoryMonitor {
    snapshots = [];
    startTime;
    memoryLimits;
    constructor(limits) {
        this.startTime = Date.now();
        this.memoryLimits = {
            heapUsed: 200 * 1024 * 1024,
            heapTotal: 300 * 1024 * 1024,
            external: 50 * 1024 * 1024,
            rss: 400 * 1024 * 1024,
            ...limits,
        };
    }
    /**
     * Create a memory monitor with default settings
     */
    static createDefault() {
        return new TestMemoryMonitor();
    }
    /**
     * Create a memory monitor with CI-appropriate settings (more restrictive)
     */
    static createForCI() {
        return new TestMemoryMonitor({
            heapUsed: 150 * 1024 * 1024,
            heapTotal: 200 * 1024 * 1024,
            external: 30 * 1024 * 1024,
            rss: 250 * 1024 * 1024, // 250MB
        });
    }
    /**
     * Take a memory snapshot at a specific point in time
     */
    takeSnapshot(testName) {
        const usage = process.memoryUsage();
        const snapshot = {
            timestamp: new Date(),
            testName,
            heapUsed: usage.heapUsed,
            heapTotal: usage.heapTotal,
            external: usage.external,
            arrayBuffers: usage.arrayBuffers,
            rss: usage.rss,
        };
        this.snapshots.push(snapshot);
        return snapshot;
    }
    /**
     * Get current memory usage
     */
    getCurrentMemoryUsage() {
        return process.memoryUsage();
    }
    /**
     * Check if current memory usage is within limits
     */
    checkMemoryUsage(_testName) {
        const currentUsage = this.getCurrentMemoryUsage();
        const warnings = [];
        const errors = [];
        // Check against limits
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed * 0.8) {
            warnings.push(`Heap usage approaching limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapUsed > this.memoryLimits.heapUsed) {
            errors.push(`Heap usage exceeded limit: ${(currentUsage.heapUsed / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapUsed / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.heapTotal > this.memoryLimits.heapTotal) {
            errors.push(`Heap total exceeded limit: ${(currentUsage.heapTotal / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.heapTotal / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.external > this.memoryLimits.external) {
            errors.push(`External memory exceeded limit: ${(currentUsage.external / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.external / 1024 / 1024).toFixed(2)}MB`);
        }
        if (currentUsage.rss > this.memoryLimits.rss) {
            errors.push(`RSS exceeded limit: ${(currentUsage.rss / 1024 / 1024).toFixed(2)}MB > ${(this.memoryLimits.rss / 1024 / 1024).toFixed(2)}MB`);
        }
        return {
            isWithinLimits: errors.length === 0,
            currentUsage,
            warnings,
            errors,
        };
    }
    /**
     * Get memory usage summary since monitoring started
     */
    getMemorySummary() {
        if (this.snapshots.length === 0) {
            const current = this.getCurrentMemoryUsage();
            return {
                initialMemory: current.heapUsed / 1024 / 1024,
                currentMemory: current.heapUsed / 1024 / 1024,
                peakMemory: current.heapUsed / 1024 / 1024,
                totalIncrease: 0,
                testDuration: Date.now() - this.startTime,
            };
        }
        const initialSnapshot = this.snapshots[0];
        const currentUsage = this.getCurrentMemoryUsage();
        const peakMemory = Math.max(...this.snapshots.map(s => s.heapUsed), currentUsage.heapUsed);
        return {
            initialMemory: initialSnapshot.heapUsed / 1024 / 1024,
            currentMemory: currentUsage.heapUsed / 1024 / 1024,
            peakMemory: peakMemory / 1024 / 1024,
            totalIncrease: (currentUsage.heapUsed - initialSnapshot.heapUsed) / 1024 / 1024,
            testDuration: Date.now() - this.startTime,
        };
    }
    /**
     * Get memory usage trend analysis
     */
    getMemoryTrend() {
        if (this.snapshots.length < 3) {
            return {
                isIncreasing: false,
                averageIncrease: 0,
                concerningTrend: false,
            };
        }
        const recentSnapshots = this.snapshots.slice(-5); // Last 5 snapshots
        const increases = [];
        for (let i = 1; i < recentSnapshots.length; i++) {
            const increase = recentSnapshots[i].heapUsed - recentSnapshots[i - 1].heapUsed;
            increases.push(increase);
        }
        const averageIncrease = increases.reduce((sum, inc) => sum + inc, 0) / increases.length;
        const isIncreasing = averageIncrease > 0;
        const concerningTrend = averageIncrease > 10 * 1024 * 1024; // More than 10MB average increase
        return {
            isIncreasing,
            averageIncrease: averageIncrease / 1024 / 1024,
            concerningTrend,
        };
    }
    /**
     * Perform memory cleanup and optimization
     */
    cleanup(testName) {
        const beforeCleanup = this.getCurrentMemoryUsage();
        const actions = [];
        try {
            // Clear any test-specific caches
            if (global.__TEST_CACHE__) {
                if (typeof global.__TEST_CACHE__.clear === 'function') {
                    global.__TEST_CACHE__.clear();
                    actions.push('Cleared test cache');
                }
            }
            // Clear test references
            if (global.__TEST_REFS__) {
                global.__TEST_REFS__.length = 0;
                actions.push('Cleared test references');
            }
            // Force garbage collection if available
            if (global.gc) {
                global.gc();
                actions.push('Forced garbage collection');
            }
            // Clear Jest mocks and modules
            if (jest) {
                jest.clearAllMocks();
                actions.push('Cleared Jest mocks');
                if (jest.resetModules) {
                    jest.resetModules();
                    actions.push('Reset Jest modules');
                }
            }
            const afterCleanup = this.getCurrentMemoryUsage();
            const freedMemory = (beforeCleanup.heapUsed - afterCleanup.heapUsed) / 1024 / 1024;
            // Take snapshot after cleanup
            this.takeSnapshot(`${testName}-cleanup`);
            return {
                success: true,
                freedMemory: `${freedMemory.toFixed(2)}MB`,
                actions,
            };
        }
        catch (error) {
            console.error('Memory cleanup failed:', error);
            return {
                success: false,
                freedMemory: '0MB',
                actions: [...actions, `Cleanup failed: ${error.message}`],
            };
        }
    }
    /**
     * Get detailed memory report
     */
    getDetailedReport() {
        const summary = this.getMemorySummary();
        const trend = this.getMemoryTrend();
        const recommendations = [];
        // Generate recommendations based on analysis
        if (summary.totalIncrease > 50) {
            recommendations.push('Consider reducing test complexity or adding more cleanup');
        }
        if (trend.concerningTrend) {
            recommendations.push('Memory usage is increasing rapidly - investigate memory leaks');
        }
        if (summary.peakMemory > 150) {
            recommendations.push('Peak memory usage is high - consider splitting tests');
        }
        if (this.snapshots.length > 100) {
            recommendations.push('Many snapshots taken - consider reducing monitoring frequency');
        }
        return {
            summary,
            trend,
            snapshots: this.snapshots,
            recommendations,
        };
    }
    /**
     * Reset monitoring state
     */
    reset() {
        this.snapshots = [];
        this.startTime = Date.now();
    }
    /**
     * Export memory data for analysis
     */
    exportData() {
        return {
            metadata: {
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Date.now() - this.startTime,
                snapshotCount: this.snapshots.length,
            },
            snapshots: this.snapshots,
            summary: this.getMemorySummary(),
        };
    }
}
exports.TestMemoryMonitor = TestMemoryMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0Ly5jb25zb2xpZGF0aW9uLWJhY2t1cHMtMjAyNS0wOC0yM1QxNy01NC0xMC0wOTJaL3NyYy9fX3Rlc3RzX18vdXRpbHMvVGVzdE1lbW9yeU1vbml0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUEyQkgsTUFBYSxpQkFBaUI7SUFDcEIsU0FBUyxHQUFxQixFQUFFLENBQUM7SUFDakMsU0FBUyxDQUFTO0lBQ2xCLFlBQVksQ0FLbEI7SUFFRixZQUFZLE1BQW1EO1FBQzdELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsUUFBUSxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUMzQixTQUFTLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzVCLFFBQVEsRUFBRSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDMUIsR0FBRyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUN0QixHQUFHLE1BQU07U0FDVixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGFBQWE7UUFDbEIsT0FBTyxJQUFJLGlCQUFpQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVc7UUFDaEIsT0FBTyxJQUFJLGlCQUFpQixDQUFDO1lBQzNCLFFBQVEsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUk7WUFDM0IsU0FBUyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSTtZQUM1QixRQUFRLEVBQUUsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJO1lBQzFCLEdBQUcsRUFBRSxHQUFHLEdBQUcsSUFBSSxHQUFHLElBQUksRUFBRSxRQUFRO1NBQ2pDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxR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QUErRCxDQUFDLENBQUM7U0FDdkY7UUFFRCxJQUFJLE9BQU8sQ0FBQyxVQUFVLEdBQUcsR0FBRyxFQUFFO1lBQzVCLGVBQWUsQ0FBQyxJQUFJLENBQUMsc0RBQXNELENBQUMsQ0FBQztTQUM5RTtRQUVELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQy9CLGVBQWUsQ0FBQyxJQUFJLENBQUMsK0RBQStELENBQUMsQ0FBQztTQUN2RjtRQUVELE9BQU87WUFDTCxPQUFPO1lBQ1AsS0FBSztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixlQUFlO1NBQ2hCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsVUFBVTtRQVVSLE9BQU87WUFDTCxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUztnQkFDckMsYUFBYSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTTthQUNyQztZQUNELFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1NBQ2pDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUF0VEQsOENBc1RDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC8uY29uc29saWRhdGlvbi1iYWNrdXBzLTIwMjUtMDgtMjNUMTctNTQtMTAtMDkyWi9zcmMvX190ZXN0c19fL3V0aWxzL1Rlc3RNZW1vcnlNb25pdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdCBNZW1vcnkgTW9uaXRvciBVdGlsaXR5XG4gKlxuICogUHJvdmlkZXMgbWVtb3J5IG1vbml0b3JpbmcgYW5kIG1hbmFnZW1lbnQgY2FwYWJpbGl0aWVzIGZvciB0ZXN0IGVudmlyb25tZW50cy5cbiAqIFVzZWQgaW4gY29tcHJlaGVuc2l2ZSB2YWxpZGF0aW9uIHRlc3RpbmcgdG8gZW5zdXJlIG1lbW9yeSB1c2FnZSBzdGF5cyB3aXRoaW4gbGltaXRzLlxuICovXG5cbmludGVyZmFjZSBNZW1vcnlTbmFwc2hvdCB7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgdGVzdE5hbWU6IHN0cmluZztcbiAgaGVhcFVzZWQ6IG51bWJlcjtcbiAgaGVhcFRvdGFsOiBudW1iZXI7XG4gIGV4dGVybmFsOiBudW1iZXI7XG4gIGFycmF5QnVmZmVyczogbnVtYmVyO1xuICByc3M6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIE1lbW9yeUNoZWNrIHtcbiAgaXNXaXRoaW5MaW1pdHM6IGJvb2xlYW47XG4gIGN1cnJlbnRVc2FnZTogTm9kZUpTLk1lbW9yeVVzYWdlO1xuICB3YXJuaW5nczogc3RyaW5nW107XG4gIGVycm9yczogc3RyaW5nW107XG59XG5cbmludGVyZmFjZSBNZW1vcnlTdW1tYXJ5IHtcbiAgaW5pdGlhbE1lbW9yeTogbnVtYmVyO1xuICBjdXJyZW50TWVtb3J5OiBudW1iZXI7XG4gIHBlYWtNZW1vcnk6IG51bWJlcjtcbiAgdG90YWxJbmNyZWFzZTogbnVtYmVyO1xuICB0ZXN0RHVyYXRpb246IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFRlc3RNZW1vcnlNb25pdG9yIHtcbiAgcHJpdmF0ZSBzbmFwc2hvdHM6IE1lbW9yeVNuYXBzaG90W10gPSBbXTtcbiAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBtZW1vcnlMaW1pdHM6IHtcbiAgICBoZWFwVXNlZDogbnVtYmVyO1xuICAgIGhlYXBUb3RhbDogbnVtYmVyO1xuICAgIGV4dGVybmFsOiBudW1iZXI7XG4gICAgcnNzOiBudW1iZXI7XG4gIH07XG5cbiAgY29uc3RydWN0b3IobGltaXRzPzogUGFydGlhbDxUZXN0TWVtb3J5TW9uaXRvclsnbWVtb3J5TGltaXRzJ10+KSB7XG4gICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMubWVtb3J5TGltaXRzID0ge1xuICAgICAgaGVhcFVzZWQ6IDIwMCAqIDEwMjQgKiAxMDI0LCAvLyAyMDBNQlxuICAgICAgaGVhcFRvdGFsOiAzMDAgKiAxMDI0ICogMTAyNCwgLy8gMzAwTUJcbiAgICAgIGV4dGVybmFsOiA1MCAqIDEwMjQgKiAxMDI0LCAvLyA1ME1CXG4gICAgICByc3M6IDQwMCAqIDEwMjQgKiAxMDI0LCAvLyA0MDBNQlxuICAgICAgLi4ubGltaXRzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbWVtb3J5IG1vbml0b3Igd2l0aCBkZWZhdWx0IHNldHRpbmdzXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlRGVmYXVsdCgpOiBUZXN0TWVtb3J5TW9uaXRvciB7XG4gICAgcmV0dXJuIG5ldyBUZXN0TWVtb3J5TW9uaXRvcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG1lbW9yeSBtb25pdG9yIHdpdGggQ0ktYXBwcm9wcmlhdGUgc2V0dGluZ3MgKG1vcmUgcmVzdHJpY3RpdmUpXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlRm9yQ0koKTogVGVzdE1lbW9yeU1vbml0b3Ige1xuICAgIHJldHVybiBuZXcgVGVzdE1lbW9yeU1vbml0b3Ioe1xuICAgICAgaGVhcFVzZWQ6IDE1MCAqIDEwMjQgKiAxMDI0LCAvLyAxNTBNQlxuICAgICAgaGVhcFRvdGFsOiAyMDAgKiAxMDI0ICogMTAyNCwgLy8gMjAwTUJcbiAgICAgIGV4dGVybmFsOiAzMCAqIDEwMjQgKiAxMDI0LCAvLyAzME1CXG4gICAgICByc3M6IDI1MCAqIDEwMjQgKiAxMDI0LCAvLyAyNTBNQlxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRha2UgYSBtZW1vcnkgc25hcHNob3QgYXQgYSBzcGVjaWZpYyBwb2ludCBpbiB0aW1lXG4gICAqL1xuICB0YWtlU25hcHNob3QodGVzdE5hbWU6IHN0cmluZyk6IE1lbW9yeVNuYXBzaG90IHtcbiAgICBjb25zdCB1c2FnZSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcbiAgICBjb25zdCBzbmFwc2hvdDogTWVtb3J5U25hcHNob3QgPSB7XG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB0ZXN0TmFtZSxcbiAgICAgIGhlYXBVc2VkOiB1c2FnZS5oZWFwVXNlZCxcbiAgICAgIGhlYXBUb3RhbDogdXNhZ2UuaGVhcFRvdGFsLFxuICAgICAgZXh0ZXJuYWw6IHVzYWdlLmV4dGVybmFsLFxuICAgICAgYXJyYXlCdWZmZXJzOiB1c2FnZS5hcnJheUJ1ZmZlcnMsXG4gICAgICByc3M6IHVzYWdlLnJzcyxcbiAgICB9O1xuXG4gICAgdGhpcy5zbmFwc2hvdHMucHVzaChzbmFwc2hvdCk7XG4gICAgcmV0dXJuIHNuYXBzaG90O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IG1lbW9yeSB1c2FnZVxuICAgKi9cbiAgZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk6IE5vZGVKUy5NZW1vcnlVc2FnZSB7XG4gICAgcmV0dXJuIHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjdXJyZW50IG1lbW9yeSB1c2FnZSBpcyB3aXRoaW4gbGltaXRzXG4gICAqL1xuICBjaGVja01lbW9yeVVzYWdlKF90ZXN0TmFtZTogc3RyaW5nKTogTWVtb3J5Q2hlY2sge1xuICAgIGNvbnN0IGN1cnJlbnRVc2FnZSA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgYWdhaW5zdCBsaW1pdHNcbiAgICBpZiAoY3VycmVudFVzYWdlLmhlYXBVc2VkID4gdGhpcy5tZW1vcnlMaW1pdHMuaGVhcFVzZWQgKiAwLjgpIHtcbiAgICAgIHdhcm5pbmdzLnB1c2goXG4gICAgICAgIGBIZWFwIHVzYWdlIGFwcHJvYWNoaW5nIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UuaGVhcFVzZWQgPiB0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVXNlZCkge1xuICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgIGBIZWFwIHVzYWdlIGV4Y2VlZGVkIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQiA+ICR7KHRoaXMubWVtb3J5TGltaXRzLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudFVzYWdlLmhlYXBUb3RhbCA+IHRoaXMubWVtb3J5TGltaXRzLmhlYXBUb3RhbCkge1xuICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgIGBIZWFwIHRvdGFsIGV4Y2VlZGVkIGxpbWl0OiAkeyhjdXJyZW50VXNhZ2UuaGVhcFRvdGFsIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgPiAkeyh0aGlzLm1lbW9yeUxpbWl0cy5oZWFwVG90YWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UuZXh0ZXJuYWwgPiB0aGlzLm1lbW9yeUxpbWl0cy5leHRlcm5hbCkge1xuICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgIGBFeHRlcm5hbCBtZW1vcnkgZXhjZWVkZWQgbGltaXQ6ICR7KGN1cnJlbnRVc2FnZS5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMuZXh0ZXJuYWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQmAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50VXNhZ2UucnNzID4gdGhpcy5tZW1vcnlMaW1pdHMucnNzKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYFJTUyBleGNlZWRlZCBsaW1pdDogJHsoY3VycmVudFVzYWdlLnJzcyAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CID4gJHsodGhpcy5tZW1vcnlMaW1pdHMucnNzIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNXaXRoaW5MaW1pdHM6IGVycm9ycy5sZW5ndGggPT09IDAsXG4gICAgICBjdXJyZW50VXNhZ2UsXG4gICAgICB3YXJuaW5ncyxcbiAgICAgIGVycm9ycyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBtZW1vcnkgdXNhZ2Ugc3VtbWFyeSBzaW5jZSBtb25pdG9yaW5nIHN0YXJ0ZWRcbiAgICovXG4gIGdldE1lbW9yeVN1bW1hcnkoKTogTWVtb3J5U3VtbWFyeSB7XG4gICAgaWYgKHRoaXMuc25hcHNob3RzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuZ2V0Q3VycmVudE1lbW9yeVVzYWdlKCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbml0aWFsTWVtb3J5OiBjdXJyZW50LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICAgIGN1cnJlbnRNZW1vcnk6IGN1cnJlbnQuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgICAgcGVha01lbW9yeTogY3VycmVudC5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0LFxuICAgICAgICB0b3RhbEluY3JlYXNlOiAwLFxuICAgICAgICB0ZXN0RHVyYXRpb246IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgaW5pdGlhbFNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdHNbMF07XG4gICAgY29uc3QgY3VycmVudFVzYWdlID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICBjb25zdCBwZWFrTWVtb3J5ID0gTWF0aC5tYXgoLi4udGhpcy5zbmFwc2hvdHMubWFwKHMgPT4gcy5oZWFwVXNlZCksIGN1cnJlbnRVc2FnZS5oZWFwVXNlZCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaW5pdGlhbE1lbW9yeTogaW5pdGlhbFNuYXBzaG90LmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQsXG4gICAgICBjdXJyZW50TWVtb3J5OiBjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCxcbiAgICAgIHBlYWtNZW1vcnk6IHBlYWtNZW1vcnkgLyAxMDI0IC8gMTAyNCxcbiAgICAgIHRvdGFsSW5jcmVhc2U6IChjdXJyZW50VXNhZ2UuaGVhcFVzZWQgLSBpbml0aWFsU25hcHNob3QuaGVhcFVzZWQpIC8gMTAyNCAvIDEwMjQsXG4gICAgICB0ZXN0RHVyYXRpb246IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBtZW1vcnkgdXNhZ2UgdHJlbmQgYW5hbHlzaXNcbiAgICovXG4gIGdldE1lbW9yeVRyZW5kKCk6IHtcbiAgICBpc0luY3JlYXNpbmc6IGJvb2xlYW47XG4gICAgYXZlcmFnZUluY3JlYXNlOiBudW1iZXI7XG4gICAgY29uY2VybmluZ1RyZW5kOiBib29sZWFuO1xuICB9IHtcbiAgICBpZiAodGhpcy5zbmFwc2hvdHMubGVuZ3RoIDwgMykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNJbmNyZWFzaW5nOiBmYWxzZSxcbiAgICAgICAgYXZlcmFnZUluY3JlYXNlOiAwLFxuICAgICAgICBjb25jZXJuaW5nVHJlbmQ6IGZhbHNlLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCByZWNlbnRTbmFwc2hvdHMgPSB0aGlzLnNuYXBzaG90cy5zbGljZSgtNSk7IC8vIExhc3QgNSBzbmFwc2hvdHNcbiAgICBjb25zdCBpbmNyZWFzZXM6IG51bWJlcltdID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHJlY2VudFNuYXBzaG90cy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaW5jcmVhc2UgPSByZWNlbnRTbmFwc2hvdHNbaV0uaGVhcFVzZWQgLSByZWNlbnRTbmFwc2hvdHNbaSAtIDFdLmhlYXBVc2VkO1xuICAgICAgaW5jcmVhc2VzLnB1c2goaW5jcmVhc2UpO1xuICAgIH1cblxuICAgIGNvbnN0IGF2ZXJhZ2VJbmNyZWFzZSA9IGluY3JlYXNlcy5yZWR1Y2UoKHN1bSwgaW5jKSA9PiBzdW0gKyBpbmMsIDApIC8gaW5jcmVhc2VzLmxlbmd0aDtcbiAgICBjb25zdCBpc0luY3JlYXNpbmcgPSBhdmVyYWdlSW5jcmVhc2UgPiAwO1xuICAgIGNvbnN0IGNvbmNlcm5pbmdUcmVuZCA9IGF2ZXJhZ2VJbmNyZWFzZSA+IDEwICogMTAyNCAqIDEwMjQ7IC8vIE1vcmUgdGhhbiAxME1CIGF2ZXJhZ2UgaW5jcmVhc2VcblxuICAgIHJldHVybiB7XG4gICAgICBpc0luY3JlYXNpbmcsXG4gICAgICBhdmVyYWdlSW5jcmVhc2U6IGF2ZXJhZ2VJbmNyZWFzZSAvIDEwMjQgLyAxMDI0LCAvLyBDb252ZXJ0IHRvIE1CXG4gICAgICBjb25jZXJuaW5nVHJlbmQsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIG1lbW9yeSBjbGVhbnVwIGFuZCBvcHRpbWl6YXRpb25cbiAgICovXG4gIGNsZWFudXAodGVzdE5hbWU6IHN0cmluZyk6IHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIGZyZWVkTWVtb3J5OiBzdHJpbmc7XG4gICAgYWN0aW9uczogc3RyaW5nW107XG4gIH0ge1xuICAgIGNvbnN0IGJlZm9yZUNsZWFudXAgPSB0aGlzLmdldEN1cnJlbnRNZW1vcnlVc2FnZSgpO1xuICAgIGNvbnN0IGFjdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2xlYXIgYW55IHRlc3Qtc3BlY2lmaWMgY2FjaGVzXG4gICAgICBpZiAoZ2xvYmFsLl9fVEVTVF9DQUNIRV9fKSB7XG4gICAgICAgIGlmICh0eXBlb2YgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgZ2xvYmFsLl9fVEVTVF9DQUNIRV9fLmNsZWFyKCk7XG4gICAgICAgICAgYWN0aW9ucy5wdXNoKCdDbGVhcmVkIHRlc3QgY2FjaGUnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciB0ZXN0IHJlZmVyZW5jZXNcbiAgICAgIGlmIChnbG9iYWwuX19URVNUX1JFRlNfXykge1xuICAgICAgICBnbG9iYWwuX19URVNUX1JFRlNfXy5sZW5ndGggPSAwO1xuICAgICAgICBhY3Rpb25zLnB1c2goJ0NsZWFyZWQgdGVzdCByZWZlcmVuY2VzJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbiBpZiBhdmFpbGFibGVcbiAgICAgIGlmIChnbG9iYWwuZ2MpIHtcbiAgICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgICAgIGFjdGlvbnMucHVzaCgnRm9yY2VkIGdhcmJhZ2UgY29sbGVjdGlvbicpO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciBKZXN0IG1vY2tzIGFuZCBtb2R1bGVzXG4gICAgICBpZiAoamVzdCkge1xuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICAgICAgYWN0aW9ucy5wdXNoKCdDbGVhcmVkIEplc3QgbW9ja3MnKTtcblxuICAgICAgICBpZiAoamVzdC5yZXNldE1vZHVsZXMpIHtcbiAgICAgICAgICBqZXN0LnJlc2V0TW9kdWxlcygpO1xuICAgICAgICAgIGFjdGlvbnMucHVzaCgnUmVzZXQgSmVzdCBtb2R1bGVzJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgYWZ0ZXJDbGVhbnVwID0gdGhpcy5nZXRDdXJyZW50TWVtb3J5VXNhZ2UoKTtcbiAgICAgIGNvbnN0IGZyZWVkTWVtb3J5ID0gKGJlZm9yZUNsZWFudXAuaGVhcFVzZWQgLSBhZnRlckNsZWFudXAuaGVhcFVzZWQpIC8gMTAyNCAvIDEwMjQ7XG5cbiAgICAgIC8vIFRha2Ugc25hcHNob3QgYWZ0ZXIgY2xlYW51cFxuICAgICAgdGhpcy50YWtlU25hcHNob3QoYCR7dGVzdE5hbWV9LWNsZWFudXBgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZnJlZWRNZW1vcnk6IGAke2ZyZWVkTWVtb3J5LnRvRml4ZWQoMil9TUJgLFxuICAgICAgICBhY3Rpb25zLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignTWVtb3J5IGNsZWFudXAgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBmcmVlZE1lbW9yeTogJzBNQicsXG4gICAgICAgIGFjdGlvbnM6IFsuLi5hY3Rpb25zLCBgQ2xlYW51cCBmYWlsZWQ6ICR7KGVycm9yIGFzIEVycm9yKS5tZXNzYWdlfWBdLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRldGFpbGVkIG1lbW9yeSByZXBvcnRcbiAgICovXG4gIGdldERldGFpbGVkUmVwb3J0KCk6IHtcbiAgICBzdW1tYXJ5OiBNZW1vcnlTdW1tYXJ5O1xuICAgIHRyZW5kOiBSZXR1cm5UeXBlPFRlc3RNZW1vcnlNb25pdG9yWydnZXRNZW1vcnlUcmVuZCddPjtcbiAgICBzbmFwc2hvdHM6IE1lbW9yeVNuYXBzaG90W107XG4gICAgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXTtcbiAgfSB7XG4gICAgY29uc3Qgc3VtbWFyeSA9IHRoaXMuZ2V0TWVtb3J5U3VtbWFyeSgpO1xuICAgIGNvbnN0IHRyZW5kID0gdGhpcy5nZXRNZW1vcnlUcmVuZCgpO1xuICAgIGNvbnN0IHJlY29tbWVuZGF0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIEdlbmVyYXRlIHJlY29tbWVuZGF0aW9ucyBiYXNlZCBvbiBhbmFseXNpc1xuICAgIGlmIChzdW1tYXJ5LnRvdGFsSW5jcmVhc2UgPiA1MCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ0NvbnNpZGVyIHJlZHVjaW5nIHRlc3QgY29tcGxleGl0eSBvciBhZGRpbmcgbW9yZSBjbGVhbnVwJyk7XG4gICAgfVxuXG4gICAgaWYgKHRyZW5kLmNvbmNlcm5pbmdUcmVuZCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ01lbW9yeSB1c2FnZSBpcyBpbmNyZWFzaW5nIHJhcGlkbHkgLSBpbnZlc3RpZ2F0ZSBtZW1vcnkgbGVha3MnKTtcbiAgICB9XG5cbiAgICBpZiAoc3VtbWFyeS5wZWFrTWVtb3J5ID4gMTUwKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnUGVhayBtZW1vcnkgdXNhZ2UgaXMgaGlnaCAtIGNvbnNpZGVyIHNwbGl0dGluZyB0ZXN0cycpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPiAxMDApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdNYW55IHNuYXBzaG90cyB0YWtlbiAtIGNvbnNpZGVyIHJlZHVjaW5nIG1vbml0b3JpbmcgZnJlcXVlbmN5Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1bW1hcnksXG4gICAgICB0cmVuZCxcbiAgICAgIHNuYXBzaG90czogdGhpcy5zbmFwc2hvdHMsXG4gICAgICByZWNvbW1lbmRhdGlvbnMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCBtb25pdG9yaW5nIHN0YXRlXG4gICAqL1xuICByZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLnNuYXBzaG90cyA9IFtdO1xuICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBvcnQgbWVtb3J5IGRhdGEgZm9yIGFuYWx5c2lzXG4gICAqL1xuICBleHBvcnREYXRhKCk6IHtcbiAgICBtZXRhZGF0YToge1xuICAgICAgc3RhcnRUaW1lOiBudW1iZXI7XG4gICAgICBlbmRUaW1lOiBudW1iZXI7XG4gICAgICBkdXJhdGlvbjogbnVtYmVyO1xuICAgICAgc25hcHNob3RDb3VudDogbnVtYmVyO1xuICAgIH07XG4gICAgc25hcHNob3RzOiBNZW1vcnlTbmFwc2hvdFtdO1xuICAgIHN1bW1hcnk6IE1lbW9yeVN1bW1hcnk7XG4gIH0ge1xuICAgIHJldHVybiB7XG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICBzdGFydFRpbWU6IHRoaXMuc3RhcnRUaW1lLFxuICAgICAgICBlbmRUaW1lOiBEYXRlLm5vdygpLFxuICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lLFxuICAgICAgICBzbmFwc2hvdENvdW50OiB0aGlzLnNuYXBzaG90cy5sZW5ndGgsXG4gICAgICB9LFxuICAgICAgc25hcHNob3RzOiB0aGlzLnNuYXBzaG90cyxcbiAgICAgIHN1bW1hcnk6IHRoaXMuZ2V0TWVtb3J5U3VtbWFyeSgpLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==