3194c36688a026a87df90859c3c42ea3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.suggestComplementaryIngredients = exports.calculateCombinationEffects = void 0;
const ingredients_1 = require("@/utils/elementalMappings/ingredients");
const elements_1 = require("@/utils/constants/elements");
// Classic flavor combinations and their effects
const COMBINATION_RULES = [
    {
        ingredients: ['ginger', 'garlic'],
        effect: 'amplify',
        modifier: 1.3,
        elements: { Fire: 0.2 },
        notes: 'Classic warming combination'
    },
    {
        ingredients: ['cinnamon', 'cardamom', 'clove'],
        effect: 'amplify',
        modifier: 1.4,
        elements: { Fire: 0.3, Air: 0.1 },
        notes: 'Warming spice blend'
    },
    // ... other rules remain the same
];
// Create a normalization function at the top of the file
const normalizeLunarPhase = (phase) => {
    // Convert spaces to underscores for consistent lookup
    return phase.replace(/\s+/g, '_');
};
function calculateCombinationEffects({ ingredients, elementalProperties, cookingMethod, season, temperature, lunarPhase }) {
    const effects = [];
    try {
        // Apply lunar phase influences
        if (lunarPhase) {
            const lunarEffect = calculateLunarEffect(ingredients, lunarPhase);
            if (lunarEffect) {
                effects.push(lunarEffect);
            }
        }
        // Check for known combinations
        COMBINATION_RULES.forEach(rule => {
            if (hasIngredientCombination(ingredients, rule.ingredients)) {
                // Verify conditions if they exist
                if (rule.conditions) {
                    const meetsConditions = ((!rule.conditions.cookingMethod || !cookingMethod || rule.conditions.cookingMethod.includes(cookingMethod)) &&
                        (!rule.conditions.season || !season || rule.conditions.season.includes(season)) &&
                        (!rule.conditions.temperature || !temperature || rule.conditions.temperature === temperature));
                    if (!meetsConditions)
                        return;
                }
                const effect = {
                    type: rule.effect,
                    strength: rule.modifier,
                    description: rule.notes || '',
                    elements: rule.elements ? Object.keys(rule.elements) : []
                };
                effects.push(effect);
            }
        });
        // Check elemental interactions
        effects.push(...calculateElementalInteractions(ingredients));
        return effects.sort((a, b) => ((b === null || b === void 0 ? void 0 : b.modifier) || (b === null || b === void 0 ? void 0 : b.strength) || 0) - ((a === null || a === void 0 ? void 0 : a.modifier) || (a === null || a === void 0 ? void 0 : a.strength) || 0));
    }
    catch (error) {
        console.error('Error calculating combination effects:', error);
        return [];
    }
}
exports.calculateCombinationEffects = calculateCombinationEffects;
const hasIngredientCombination = (recipeIngredients, combinationIngredients) => {
    return combinationIngredients.every(ingredient => recipeIngredients.some(recipeIng => recipeIng.toLowerCase().includes(ingredient.toLowerCase())));
};
const calculateElementalInteractions = (ingredients) => {
    const effects = [];
    const ingredientPairs = getPairs(ingredients);
    ingredientPairs.forEach(([ing1, ing2]) => {
        var _a, _b;
        const elem1 = (_a = ingredients_1.ingredientMappings[ing1]) === null || _a === void 0 ? void 0 : _a.elementalProperties;
        const elem2 = (_b = ingredients_1.ingredientMappings[ing2]) === null || _b === void 0 ? void 0 : _b.elementalProperties;
        if (!elem1 || !elem2)
            return;
        if (isHarmoniousCombination(elem1, elem2)) {
            effects.push({
                ingredients: [ing1, ing2],
                type: 'synergy',
                strength: 1.2,
                elements: ['Fire'],
                description: 'Harmonious elemental combination'
            });
        }
        if (isAntagonisticCombination(elem1, elem2)) {
            effects.push({
                ingredients: [ing1, ing2],
                type: 'conflict',
                strength: 0.8,
                elements: ['Water'],
                description: 'Conflicting elemental combination'
            });
        }
    });
    return effects;
};
const getPairs = (array) => {
    const pairs = [];
    for (let i = 0; i < array.length; i++) {
        for (let j = i + 1; j < array.length; j++) {
            pairs.push([array[i], array[j]]);
        }
    }
    return pairs;
};
const isHarmoniousCombination = (elem1, elem2) => {
    return elements_1.ELEMENT_COMBINATIONS.harmonious.some(([e1, e2]) => (getDominantElement(elem1) === e1 && getDominantElement(elem2) === e2) ||
        (getDominantElement(elem1) === e2 && getDominantElement(elem2) === e1));
};
const isAntagonisticCombination = (elem1, elem2) => {
    const antagonistic = (elements_1.ELEMENT_COMBINATIONS === null || elements_1.ELEMENT_COMBINATIONS === void 0 ? void 0 : elements_1.ELEMENT_COMBINATIONS.antagonistic) || [];
    return antagonistic.some(([e1, e2]) => (getDominantElement(elem1) === e1 && getDominantElement(elem2) === e2) ||
        (getDominantElement(elem1) === e2 && getDominantElement(elem2) === e1));
};
const getDominantElement = (elements) => {
    return Object.entries(elements)
        .sort(([, a], [, b]) => b - a)[0][0];
};
const suggestComplementaryIngredients = (currentIngredients, season) => {
    const suggestions = [];
    const currentElements = calculateCombinedElements(currentIngredients);
    const dominantElement = getDominantElement(currentElements);
    Object.entries(ingredients_1.ingredientMappings).forEach(([ingredient, mapping]) => {
        if (currentIngredients.includes(ingredient))
            return;
        const ingElements = mapping.elementalProperties;
        const ingDominant = getDominantElement(ingElements);
        if (isHarmoniousWith(dominantElement, ingDominant)) {
            const seasonData = mapping.season;
            if (!season || (Array.isArray(seasonData) && seasonData.includes(season))) {
                suggestions.push(ingredient);
            }
        }
    });
    return suggestions.slice(0, 5);
};
exports.suggestComplementaryIngredients = suggestComplementaryIngredients;
const calculateCombinedElements = (ingredients) => {
    const combined = {
        Fire: 0,
        Water: 0,
        Air: 0,
        Earth: 0
    };
    ingredients.forEach(ing => {
        var _a;
        const elements = (_a = ingredients_1.ingredientMappings[ing]) === null || _a === void 0 ? void 0 : _a.elementalProperties;
        if (elements) {
            Object.entries(elements).forEach(([element, value]) => {
                // Pattern KK-1: Safe arithmetic with type validation
                const numericValue = typeof value === 'number' ? value : 0;
                combined[element] += numericValue;
            });
        }
    });
    // Normalize
    const total = Object.values(combined).reduce((a, b) => a + b, 0);
    if (total > 0) {
        Object.keys(combined).forEach(key => {
            combined[key] /= total;
        });
    }
    return combined;
};
const isHarmoniousWith = (element1, element2) => {
    return elements_1.ELEMENT_COMBINATIONS.harmonious.some(([e1, e2]) => (element1 === e1 && element2 === e2) ||
        (element1 === e2 && element2 === e1));
};
const calculateLunarEffect = (ingredients, lunarPhase) => {
    const lunarModifiers = {
        new_moon: { modifier: 0.9, effect: 'neutralize' },
        full_moon: { modifier: 1.2, effect: 'amplify' },
        first_quarter: { modifier: 1.1, effect: 'synergy' },
        last_quarter: { modifier: 1.1, effect: 'synergy' },
        waxing_crescent: { modifier: 1.05, effect: 'amplify' },
        waning_crescent: { modifier: 0.95, effect: 'neutralize' },
        waxing_gibbous: { modifier: 1.15, effect: 'amplify' },
        waning_gibbous: { modifier: 1.05, effect: 'synergy' }
    };
    // Use the normalized lunar phase for lookup
    const normalizedPhase = normalizeLunarPhase(lunarPhase);
    const modifier = lunarModifiers[normalizedPhase];
    if (!modifier)
        return null;
    return {
        type: 'amplify',
        strength: modifier.modifier,
        description: `Lunar phase (${lunarPhase}) influence`,
        elements: ['Water']
    };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9jYWxjdWxhdGlvbnMvY29tYmluYXRpb25FZmZlY3RzLnRzIiwibWFwcGluZ3MiOiI7OztBQU9BLHVFQUEyRTtBQUMzRSx5REFBa0U7QUE0QmxFLGdEQUFnRDtBQUNoRCxNQUFNLGlCQUFpQixHQUFzQjtJQUMzQztRQUNFLFdBQVcsRUFBRSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUM7UUFDakMsTUFBTSxFQUFFLFNBQXVCO1FBQy9CLFFBQVEsRUFBRSxHQUFHO1FBQ2IsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUN2QixLQUFLLEVBQUUsNkJBQTZCO0tBQ3JDO0lBQ0Q7UUFDRSxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQztRQUM5QyxNQUFNLEVBQUUsU0FBdUI7UUFDL0IsUUFBUSxFQUFFLEdBQUc7UUFDYixRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7UUFDakMsS0FBSyxFQUFFLHFCQUFxQjtLQUM3QjtJQUNELGtDQUFrQztDQUNuQyxDQUFDO0FBRUYseURBQXlEO0FBQ3pELE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxLQUFpQixFQUFVLEVBQUU7SUFDeEQsc0RBQXNEO0lBQ3RELE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDcEMsQ0FBQyxDQUFDO0FBRUYsU0FBZ0IsMkJBQTJCLENBQUMsRUFDMUMsV0FBVyxFQUNYLG1CQUFtQixFQUNuQixhQUFhLEVBQ2IsTUFBTSxFQUNOLFdBQVcsRUFDWCxVQUFVLEVBQ2E7SUFDdkIsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztJQUV4QyxJQUFJO1FBQ0YsK0JBQStCO1FBQy9CLElBQUksVUFBVSxFQUFFO1lBQ2QsTUFBTSxXQUFXLEdBQUcsb0JBQW9CLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFD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U0FBdUIsRUFBRTtRQUNwRSxlQUFlLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxZQUEwQixFQUFFO1FBQ3ZFLGNBQWMsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFNBQXVCLEVBQUU7UUFDbkUsY0FBYyxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBdUIsRUFBRTtLQUNwRSxDQUFDO0lBRUYsNENBQTRDO0lBQzVDLE1BQU0sZUFBZSxHQUFHLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hELE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxlQUE4QyxDQUFDLENBQUM7SUFFaEYsSUFBSSxDQUFDLFFBQVE7UUFBRSxPQUFPLElBQUksQ0FBQztJQUUzQixPQUFPO1FBQ0wsSUFBSSxFQUFFLFNBQXVCO1FBQzdCLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTtRQUMzQixXQUFXLEVBQUUsZ0JBQWdCLFVBQVUsYUFBYTtRQUNwRCxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQWM7S0FDakMsQ0FBQztBQUNKLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvR3JlZ0Nhc3Ryby9EZXNrdG9wL1doYXRUb0VhdE5leHQvc3JjL2NhbGN1bGF0aW9ucy9jb21iaW5hdGlvbkVmZmVjdHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBcbiAgRWxlbWVudGFsUHJvcGVydGllcywgXG4gIENvbWJpbmF0aW9uRWZmZWN0LCBcbiAgRWZmZWN0VHlwZSwgXG4gIEx1bmFyUGhhc2Vcbn0gZnJvbSAnQC90eXBlcy9hbGNoZW15JztcbmltcG9ydCB0eXBlIHsgRWxlbWVudCB9IGZyb20gJ0AvdHlwZXMvY2VsZXN0aWFsJztcbmltcG9ydCB7IGluZ3JlZGllbnRNYXBwaW5ncyB9IGZyb20gJ0AvdXRpbHMvZWxlbWVudGFsTWFwcGluZ3MvaW5ncmVkaWVudHMnO1xuaW1wb3J0IHsgRUxFTUVOVF9DT01CSU5BVElPTlMgfSBmcm9tICdAL3V0aWxzL2NvbnN0YW50cy9lbGVtZW50cyc7XG5cbnR5cGUgQ29va2luZ01ldGhvZCA9ICdzaW1tZXJlZCcgfCAnaW5mdXNlZCcgfCAncmF3JyB8ICdiYWtlZCcgfCAnZnJpZWQnIHwgJ2dyaWxsZWQnO1xudHlwZSBTZWFzb24gPSAnc3ByaW5nJyB8ICdzdW1tZXInIHwgJ2ZhbGwnIHwgJ3dpbnRlcicgfCAnYWxsJztcbnR5cGUgVGVtcGVyYXR1cmUgPSAnaG90JyB8ICdjb2xkJyB8ICduZXV0cmFsJztcblxuaW50ZXJmYWNlIENvbWJpbmF0aW9uUnVsZSB7XG4gIGluZ3JlZGllbnRzOiBzdHJpbmdbXTtcbiAgZWZmZWN0OiBFZmZlY3RUeXBlO1xuICBtb2RpZmllcjogbnVtYmVyO1xuICBlbGVtZW50cz86IFBhcnRpYWw8RWxlbWVudGFsUHJvcGVydGllcz47XG4gIGNvbmRpdGlvbnM/OiB7XG4gICAgY29va2luZ01ldGhvZD86IENvb2tpbmdNZXRob2RbXTtcbiAgICBzZWFzb24/OiBTZWFzb25bXTtcbiAgICB0ZW1wZXJhdHVyZT86IFRlbXBlcmF0dXJlO1xuICB9O1xuICBub3Rlcz86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIENhbGN1bGF0ZUVmZmVjdHNQYXJhbXMge1xuICBpbmdyZWRpZW50czogc3RyaW5nW107XG4gIGVsZW1lbnRhbFByb3BlcnRpZXM6IEVsZW1lbnRhbFByb3BlcnRpZXM7XG4gIGNvb2tpbmdNZXRob2Q/OiBDb29raW5nTWV0aG9kO1xuICBzZWFzb24/OiBTZWFzb247XG4gIHRlbXBlcmF0dXJlPzogVGVtcGVyYXR1cmU7XG4gIGx1bmFyUGhhc2U/OiBMdW5hclBoYXNlO1xufVxuXG4vLyBDbGFzc2ljIGZsYXZvciBjb21iaW5hdGlvbnMgYW5kIHRoZWlyIGVmZmVjdHNcbmNvbnN0IENPTUJJTkFUSU9OX1JVTEVTOiBDb21iaW5hdGlvblJ1bGVbXSA9IFtcbiAge1xuICAgIGluZ3JlZGllbnRzOiBbJ2dpbmdlcicsICdnYXJsaWMnXSxcbiAgICBlZmZlY3Q6ICdhbXBsaWZ5JyBhcyBFZmZlY3RUeXBlLFxuICAgIG1vZGlmaWVyOiAxLjMsXG4gICAgZWxlbWVudHM6IHsgRmlyZTogMC4yIH0sXG4gICAgbm90ZXM6ICdDbGFzc2ljIHdhcm1pbmcgY29tYmluYXRpb24nXG4gIH0sXG4gIHtcbiAgICBpbmdyZWRpZW50czogWydjaW5uYW1vbicsICdjYXJkYW1vbScsICdjbG92ZSddLFxuICAgIGVmZmVjdDogJ2FtcGxpZnknIGFzIEVmZmVjdFR5cGUsXG4gICAgbW9kaWZpZXI6IDEuNCxcbiAgICBlbGVtZW50czogeyBGaXJlOiAwLjMsIEFpcjogMC4xIH0sXG4gICAgbm90ZXM6ICdXYXJtaW5nIHNwaWNlIGJsZW5kJ1xuICB9LFxuICAvLyAuLi4gb3RoZXIgcnVsZXMgcmVtYWluIHRoZSBzYW1lXG5dO1xuXG4vLyBDcmVhdGUgYSBub3JtYWxpemF0aW9uIGZ1bmN0aW9uIGF0IHRoZSB0b3Agb2YgdGhlIGZpbGVcbmNvbnN0IG5vcm1hbGl6ZUx1bmFyUGhhc2UgPSAocGhhc2U6IEx1bmFyUGhhc2UpOiBzdHJpbmcgPT4ge1xuICAvLyBDb252ZXJ0IHNwYWNlcyB0byB1bmRlcnNjb3JlcyBmb3IgY29uc2lzdGVudCBsb29rdXBcbiAgcmV0dXJuIHBoYXNlLnJlcGxhY2UoL1xccysvZywgJ18nKTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVDb21iaW5hdGlvbkVmZmVjdHMoe1xuICBpbmdyZWRpZW50cyxcbiAgZWxlbWVudGFsUHJvcGVydGllcyxcbiAgY29va2luZ01ldGhvZCxcbiAgc2Vhc29uLFxuICB0ZW1wZXJhdHVyZSxcbiAgbHVuYXJQaGFzZVxufTogQ2FsY3VsYXRlRWZmZWN0c1BhcmFtcyk6IENvbWJpbmF0aW9uRWZmZWN0W10ge1xuICBjb25zdCBlZmZlY3RzOiBDb21iaW5hdGlvbkVmZmVjdFtdID0gW107XG5cbiAgdHJ5IHtcbiAgICAvLyBBcHBseSBsdW5hciBwaGFzZSBpbmZsdWVuY2VzXG4gICAgaWYgKGx1bmFyUGhhc2UpIHtcbiAgICAgIGNvbnN0IGx1bmFyRWZmZWN0ID0gY2FsY3VsYXRlTHVuYXJFZmZlY3QoaW5ncmVkaWVudHMsIGx1bmFyUGhhc2UpO1xuICAgICAgaWYgKGx1bmFyRWZmZWN0KSB7XG4gICAgICAgIGVmZmVjdHMucHVzaChsdW5hckVmZmVjdCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGtub3duIGNvbWJpbmF0aW9uc1xuICAgIENPTUJJTkFUSU9OX1JVTEVTLmZvckVhY2gocnVsZSA9PiB7XG4gICAgICBpZiAoaGFzSW5ncmVkaWVudENvbWJpbmF0aW9uKGluZ3JlZGllbnRzLCBydWxlLmluZ3JlZGllbnRzKSkge1xuICAgICAgICAvLyBWZXJpZnkgY29uZGl0aW9ucyBpZiB0aGV5IGV4aXN0XG4gICAgICAgIGlmIChydWxlLmNvbmRpdGlvbnMpIHtcbiAgICAgICAgICBjb25zdCBtZWV0c0NvbmRpdGlvbnMgPSAoXG4gICAgICAgICAgICAoIXJ1bGUuY29uZGl0aW9ucy5jb29raW5nTWV0aG9kIHx8ICFjb29raW5nTWV0aG9kIHx8IHJ1bGUuY29uZGl0aW9ucy5jb29raW5nTWV0aG9kLmluY2x1ZGVzKGNvb2tpbmdNZXRob2QpKSAmJlxuICAgICAgICAgICAgKCFydWxlLmNvbmRpdGlvbnMuc2Vhc29uIHx8ICFzZWFzb24gfHwgcnVsZS5jb25kaXRpb25zLnNlYXNvbi5pbmNsdWRlcyhzZWFzb24pKSAmJlxuICAgICAgICAgICAgKCFydWxlLmNvbmRpdGlvbnMudGVtcGVyYXR1cmUgfHwgIXRlbXBlcmF0dXJlIHx8IHJ1bGUuY29uZGl0aW9ucy50ZW1wZXJhdHVyZSA9PT0gdGVtcGVyYXR1cmUpXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmICghbWVldHNDb25kaXRpb25zKSByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBlZmZlY3Q6IENvbWJpbmF0aW9uRWZmZWN0ID0ge1xuICAgICAgICAgIHR5cGU6IHJ1bGUuZWZmZWN0LFxuICAgICAgICAgIHN0cmVuZ3RoOiBydWxlLm1vZGlmaWVyLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBydWxlLm5vdGVzIHx8ICcnLFxuICAgICAgICAgIGVsZW1lbnRzOiBydWxlLmVsZW1lbnRzID8gT2JqZWN0LmtleXMocnVsZS5lbGVtZW50cykgYXMgRWxlbWVudFtdIDogW11cbiAgICAgICAgfTtcblxuICAgICAgICBlZmZlY3RzLnB1c2goZWZmZWN0KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIENoZWNrIGVsZW1lbnRhbCBpbnRlcmFjdGlvbnNcbiAgICBlZmZlY3RzLnB1c2goLi4uY2FsY3VsYXRlRWxlbWVudGFsSW50ZXJhY3Rpb25zKGluZ3JlZGllbnRzKSk7XG5cbiAgICByZXR1cm4gZWZmZWN0cy5zb3J0KChhLCBiKSA9PiAoKGIgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pPy5tb2RpZmllciB8fCAoYiBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik/LnN0cmVuZ3RoIHx8IDApIC0gKChhIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KT8ubW9kaWZpZXIgfHwgKGEgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pPy5zdHJlbmd0aCB8fCAwKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgY2FsY3VsYXRpbmcgY29tYmluYXRpb24gZWZmZWN0czonLCBlcnJvcik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmNvbnN0IGhhc0luZ3JlZGllbnRDb21iaW5hdGlvbiA9IChcbiAgcmVjaXBlSW5ncmVkaWVudHM6IHN0cmluZ1tdLFxuICBjb21iaW5hdGlvbkluZ3JlZGllbnRzOiBzdHJpbmdbXVxuKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiBjb21iaW5hdGlvbkluZ3JlZGllbnRzLmV2ZXJ5KGluZ3JlZGllbnQgPT5cbiAgICByZWNpcGVJbmdyZWRpZW50cy5zb21lKHJlY2lwZUluZyA9PlxuICAgICAgcmVjaXBlSW5nLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoaW5ncmVkaWVudC50b0xvd2VyQ2FzZSgpKVxuICAgIClcbiAgKTtcbn07XG5cbmNvbnN0IGNhbGN1bGF0ZUVsZW1lbnRhbEludGVyYWN0aW9ucyA9IChcbiAgaW5ncmVkaWVudHM6IHN0cmluZ1tdXG4pOiBDb21iaW5hdGlvbkVmZmVjdFtdID0+IHtcbiAgY29uc3QgZWZmZWN0czogQ29tYmluYXRpb25FZmZlY3RbXSA9IFtdO1xuICBjb25zdCBpbmdyZWRpZW50UGFpcnMgPSBnZXRQYWlycyhpbmdyZWRpZW50cyk7XG5cbiAgaW5ncmVkaWVudFBhaXJzLmZvckVhY2goKFtpbmcxLCBpbmcyXSkgPT4ge1xuICAgIGNvbnN0IGVsZW0xID0gaW5ncmVkaWVudE1hcHBpbmdzW2luZzFdPy5lbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgIGNvbnN0IGVsZW0yID0gaW5ncmVkaWVudE1hcHBpbmdzW2luZzJdPy5lbGVtZW50YWxQcm9wZXJ0aWVzO1xuXG4gICAgaWYgKCFlbGVtMSB8fCAhZWxlbTIpIHJldHVybjtcblxuICAgIGlmIChpc0hhcm1vbmlvdXNDb21iaW5hdGlvbihlbGVtMSwgZWxlbTIpKSB7XG4gICAgICBlZmZlY3RzLnB1c2goe1xuICAgICAgICBpbmdyZWRpZW50czogW2luZzEsIGluZzJdLFxuICAgICAgICB0eXBlOiAnc3luZXJneScgYXMgRWZmZWN0VHlwZSxcbiAgICAgICAgc3RyZW5ndGg6IDEuMixcbiAgICAgICAgZWxlbWVudHM6IFsnRmlyZSddIGFzIEVsZW1lbnRbXSxcbiAgICAgICAgZGVzY3JpcHRpb246ICdIYXJtb25pb3VzIGVsZW1lbnRhbCBjb21iaW5hdGlvbidcbiAgICAgIH0gYXMgYW55KTtcbiAgICB9XG5cbiAgICBpZiAoaXNBbnRhZ29uaXN0aWNDb21iaW5hdGlvbihlbGVtMSwgZWxlbTIpKSB7XG4gICAgICBlZmZlY3RzLnB1c2goe1xuICAgICAgICBpbmdyZWRpZW50czogW2luZzEsIGluZzJdLFxuICAgICAgICB0eXBlOiAnY29uZmxpY3QnIGFzIEVmZmVjdFR5cGUsXG4gICAgICAgIHN0cmVuZ3RoOiAwLjgsXG4gICAgICAgIGVsZW1lbnRzOiBbJ1dhdGVyJ10gYXMgRWxlbWVudFtdLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0NvbmZsaWN0aW5nIGVsZW1lbnRhbCBjb21iaW5hdGlvbidcbiAgICAgIH0gYXMgYW55KTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBlZmZlY3RzO1xufTtcblxuY29uc3QgZ2V0UGFpcnMgPSA8VD4oYXJyYXk6IFRbXSk6IFtULCBUXVtdID0+IHtcbiAgY29uc3QgcGFpcnM6IFtULCBUXVtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBhcnJheS5sZW5ndGg7IGorKykge1xuICAgICAgcGFpcnMucHVzaChbYXJyYXlbaV0sIGFycmF5W2pdXSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBwYWlycztcbn07XG5cbmNvbnN0IGlzSGFybW9uaW91c0NvbWJpbmF0aW9uID0gKFxuICBlbGVtMTogRWxlbWVudGFsUHJvcGVydGllcyxcbiAgZWxlbTI6IEVsZW1lbnRhbFByb3BlcnRpZXNcbik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gRUxFTUVOVF9DT01CSU5BVElPTlMuaGFybW9uaW91cy5zb21lKChbZTEsIGUyXSkgPT5cbiAgICAoZ2V0RG9taW5hbnRFbGVtZW50KGVsZW0xKSA9PT0gZTEgJiYgZ2V0RG9taW5hbnRFbGVtZW50KGVsZW0yKSA9PT0gZTIpIHx8XG4gICAgKGdldERvbWluYW50RWxlbWVudChlbGVtMSkgPT09IGUyICYmIGdldERvbWluYW50RWxlbWVudChlbGVtMikgPT09IGUxKVxuICApO1xufTtcblxuY29uc3QgaXNBbnRhZ29uaXN0aWNDb21iaW5hdGlvbiA9IChcbiAgZWxlbTE6IEVsZW1lbnRhbFByb3BlcnRpZXMsXG4gIGVsZW0yOiBFbGVtZW50YWxQcm9wZXJ0aWVzXG4pOiBib29sZWFuID0+IHtcbiAgY29uc3QgYW50YWdvbmlzdGljID0gKEVMRU1FTlRfQ09NQklOQVRJT05TIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KT8uYW50YWdvbmlzdGljIHx8IFtdO1xuICByZXR1cm4gYW50YWdvbmlzdGljLnNvbWUoKFtlMSwgZTJdOiBbYW55LCBhbnldKSA9PlxuICAgIChnZXREb21pbmFudEVsZW1lbnQoZWxlbTEpID09PSBlMSAmJiBnZXREb21pbmFudEVsZW1lbnQoZWxlbTIpID09PSBlMikgfHxcbiAgICAoZ2V0RG9taW5hbnRFbGVtZW50KGVsZW0xKSA9PT0gZTIgJiYgZ2V0RG9taW5hbnRFbGVtZW50KGVsZW0yKSA9PT0gZTEpXG4gICk7XG59O1xuXG5jb25zdCBnZXREb21pbmFudEVsZW1lbnQgPSAoZWxlbWVudHM6IEVsZW1lbnRhbFByb3BlcnRpZXMpOiBFbGVtZW50ID0+IHtcbiAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGVsZW1lbnRzKVxuICAgIC5zb3J0KChbLCBhXSwgWywgYl0pID0+IGIgLSBhKVswXVswXSBhcyBFbGVtZW50O1xufTtcblxuZXhwb3J0IGNvbnN0IHN1Z2dlc3RDb21wbGVtZW50YXJ5SW5ncmVkaWVudHMgPSAoXG4gIGN1cnJlbnRJbmdyZWRpZW50czogc3RyaW5nW10sXG4gIHNlYXNvbj86IFNlYXNvblxuKTogc3RyaW5nW10gPT4ge1xuICBjb25zdCBzdWdnZXN0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgY3VycmVudEVsZW1lbnRzID0gY2FsY3VsYXRlQ29tYmluZWRFbGVtZW50cyhjdXJyZW50SW5ncmVkaWVudHMpO1xuICBjb25zdCBkb21pbmFudEVsZW1lbnQgPSBnZXREb21pbmFudEVsZW1lbnQoY3VycmVudEVsZW1lbnRzKTtcblxuICBPYmplY3QuZW50cmllcyhpbmdyZWRpZW50TWFwcGluZ3MpLmZvckVhY2goKFtpbmdyZWRpZW50LCBtYXBwaW5nXSkgPT4ge1xuICAgIGlmIChjdXJyZW50SW5ncmVkaWVudHMuaW5jbHVkZXMoaW5ncmVkaWVudCkpIHJldHVybjtcblxuICAgIGNvbnN0IGluZ0VsZW1lbnRzID0gbWFwcGluZy5lbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgIGNvbnN0IGluZ0RvbWluYW50ID0gZ2V0RG9taW5hbnRFbGVtZW50KGluZ0VsZW1lbnRzKTtcblxuICAgIGlmIChpc0hhcm1vbmlvdXNXaXRoKGRvbWluYW50RWxlbWVudCwgaW5nRG9taW5hbnQpKSB7XG4gICAgICBjb25zdCBzZWFzb25EYXRhID0gbWFwcGluZy5zZWFzb247XG4gICAgICBpZiAoIXNlYXNvbiB8fCAoQXJyYXkuaXNBcnJheShzZWFzb25EYXRhKSAmJiBzZWFzb25EYXRhLmluY2x1ZGVzKHNlYXNvbikpKSB7XG4gICAgICAgIHN1Z2dlc3Rpb25zLnB1c2goaW5ncmVkaWVudCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gc3VnZ2VzdGlvbnMuc2xpY2UoMCwgNSk7XG59O1xuXG5jb25zdCBjYWxjdWxhdGVDb21iaW5lZEVsZW1lbnRzID0gKFxuICBpbmdyZWRpZW50czogc3RyaW5nW11cbik6IEVsZW1lbnRhbFByb3BlcnRpZXMgPT4ge1xuICBjb25zdCBjb21iaW5lZDogRWxlbWVudGFsUHJvcGVydGllcyA9IHtcbiAgICBGaXJlOiAwLFxuICAgIFdhdGVyOiAwLFxuICAgIEFpcjogMCxcbiAgICBFYXJ0aDogMFxuICB9O1xuXG4gIGluZ3JlZGllbnRzLmZvckVhY2goaW5nID0+IHtcbiAgICBjb25zdCBlbGVtZW50cyA9IGluZ3JlZGllbnRNYXBwaW5nc1tpbmddPy5lbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgIGlmIChlbGVtZW50cykge1xuICAgICAgT2JqZWN0LmVudHJpZXMoZWxlbWVudHMpLmZvckVhY2goKFtlbGVtZW50LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgLy8gUGF0dGVybiBLSy0xOiBTYWZlIGFyaXRobWV0aWMgd2l0aCB0eXBlIHZhbGlkYXRpb25cbiAgICAgICAgY29uc3QgbnVtZXJpY1ZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHZhbHVlIDogMDtcbiAgICAgICAgY29tYmluZWRbZWxlbWVudCBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzXSArPSBudW1lcmljVmFsdWU7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIE5vcm1hbGl6ZVxuICBjb25zdCB0b3RhbCA9IE9iamVjdC52YWx1ZXMoY29tYmluZWQpLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICBpZiAodG90YWwgPiAwKSB7XG4gICAgT2JqZWN0LmtleXMoY29tYmluZWQpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGNvbWJpbmVkW2tleSBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzXSAvPSB0b3RhbDtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBjb21iaW5lZDtcbn07XG5cbmNvbnN0IGlzSGFybW9uaW91c1dpdGggPSAoZWxlbWVudDE6IEVsZW1lbnQsIGVsZW1lbnQyOiBFbGVtZW50KTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiBFTEVNRU5UX0NPTUJJTkFUSU9OUy5oYXJtb25pb3VzLnNvbWUoKFtlMSwgZTJdKSA9PlxuICAgIChlbGVtZW50MSA9PT0gZTEgJiYgZWxlbWVudDIgPT09IGUyKSB8fFxuICAgIChlbGVtZW50MSA9PT0gZTIgJiYgZWxlbWVudDIgPT09IGUxKVxuICApO1xufTtcblxuY29uc3QgY2FsY3VsYXRlTHVuYXJFZmZlY3QgPSAoXG4gIGluZ3JlZGllbnRzOiBzdHJpbmdbXSxcbiAgbHVuYXJQaGFzZTogTHVuYXJQaGFzZVxuKTogQ29tYmluYXRpb25FZmZlY3QgfCBudWxsID0+IHtcbiAgY29uc3QgbHVuYXJNb2RpZmllcnMgPSB7XG4gICAgbmV3X21vb246IHsgbW9kaWZpZXI6IDAuOSwgZWZmZWN0OiAnbmV1dHJhbGl6ZScgYXMgRWZmZWN0VHlwZSB9LFxuICAgIGZ1bGxfbW9vbjogeyBtb2RpZmllcjogMS4yLCBlZmZlY3Q6ICdhbXBsaWZ5JyBhcyBFZmZlY3RUeXBlIH0sXG4gICAgZmlyc3RfcXVhcnRlcjogeyBtb2RpZmllcjogMS4xLCBlZmZlY3Q6ICdzeW5lcmd5JyBhcyBFZmZlY3RUeXBlIH0sXG4gICAgbGFzdF9xdWFydGVyOiB7IG1vZGlmaWVyOiAxLjEsIGVmZmVjdDogJ3N5bmVyZ3knIGFzIEVmZmVjdFR5cGUgfSxcbiAgICB3YXhpbmdfY3Jlc2NlbnQ6IHsgbW9kaWZpZXI6IDEuMDUsIGVmZmVjdDogJ2FtcGxpZnknIGFzIEVmZmVjdFR5cGUgfSxcbiAgICB3YW5pbmdfY3Jlc2NlbnQ6IHsgbW9kaWZpZXI6IDAuOTUsIGVmZmVjdDogJ25ldXRyYWxpemUnIGFzIEVmZmVjdFR5cGUgfSxcbiAgICB3YXhpbmdfZ2liYm91czogeyBtb2RpZmllcjogMS4xNSwgZWZmZWN0OiAnYW1wbGlmeScgYXMgRWZmZWN0VHlwZSB9LFxuICAgIHdhbmluZ19naWJib3VzOiB7IG1vZGlmaWVyOiAxLjA1LCBlZmZlY3Q6ICdzeW5lcmd5JyBhcyBFZmZlY3RUeXBlIH1cbiAgfTtcblxuICAvLyBVc2UgdGhlIG5vcm1hbGl6ZWQgbHVuYXIgcGhhc2UgZm9yIGxvb2t1cFxuICBjb25zdCBub3JtYWxpemVkUGhhc2UgPSBub3JtYWxpemVMdW5hclBoYXNlKGx1bmFyUGhhc2UpO1xuICBjb25zdCBtb2RpZmllciA9IGx1bmFyTW9kaWZpZXJzW25vcm1hbGl6ZWRQaGFzZSBhcyBrZXlvZiB0eXBlb2YgbHVuYXJNb2RpZmllcnNdO1xuICBcbiAgaWYgKCFtb2RpZmllcikgcmV0dXJuIG51bGw7XG5cbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnYW1wbGlmeScgYXMgRWZmZWN0VHlwZSxcbiAgICBzdHJlbmd0aDogbW9kaWZpZXIubW9kaWZpZXIsXG4gICAgZGVzY3JpcHRpb246IGBMdW5hciBwaGFzZSAoJHtsdW5hclBoYXNlfSkgaW5mbHVlbmNlYCxcbiAgICBlbGVtZW50czogWydXYXRlciddIGFzIEVsZW1lbnRbXVxuICB9O1xufTsiXSwidmVyc2lvbiI6M30=