67df3eaab9a40ce1d20394d92cb069cc
"use strict";
/**
 * Safety Protocol System
 * Perfect Codebase Campaign - Comprehensive Safety Implementation
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SafetyProtocol = void 0;
const child_process_1 = require("child_process");
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const campaign_1 = require("../../types/campaign");
class SafetyProtocol {
    settings;
    stashes = new Map();
    safetyEvents = [];
    stashCounter = 0;
    constructor(settings) {
        this.settings = settings;
        this.initializeStashTracking();
    }
    /**
     * Create a git stash with descriptive naming conventions
     */
    async createStash(description, phase) {
        try {
            this.stashCounter++;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const phasePrefix = phase ? `${phase}-` : '';
            const stashName = `campaign-${phasePrefix}${this.stashCounter}-${timestamp}`;
            const fullDescription = `${stashName}: ${description}`;
            // Validate git state before creating stash
            const gitValidation = await this.validateGitState();
            if (!gitValidation.success) {
                throw new Error(`Git validation failed: ${gitValidation.errors.join(', ')}`);
            }
            // Create the git stash with all files including untracked
            (0, child_process_1.execSync)(`git stash push -u -m "${fullDescription}"`, {
                encoding: 'utf8',
                stdio: 'pipe'
            });
            // Get the actual stash reference
            const stashList = (0, child_process_1.execSync)('git stash list --oneline', { encoding: 'utf8' });
            const stashRef = stashList.split('\n')[0]?.split(':')[0] || 'stash@{0}';
            // Store stash information
            const stash = {
                id: stashName,
                description: fullDescription,
                timestamp: new Date(),
                branch: this.getCurrentBranch(),
                ref: stashRef
            };
            this.stashes.set(stashName, stash);
            this.saveStashTracking();
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.CHECKPOINT_CREATED,
                timestamp: new Date(),
                description: `Git stash created: ${stashName} (${stashRef})`,
                severity: campaign_1.SafetyEventSeverity.INFO,
                action: 'STASH_CREATE'
            });
            console.log(`📦 Created git stash: ${stashName}`);
            console.log(`   Reference: ${stashRef}`);
            console.log(`   Rollback with: git stash apply ${stashRef}`);
            return stashName;
        }
        catch (error) {
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.EMERGENCY_RECOVERY,
                timestamp: new Date(),
                description: `Failed to create git stash: ${error.message || 'Unknown error'}`,
                severity: campaign_1.SafetyEventSeverity.ERROR,
                action: 'STASH_FAILED'
            });
            throw new Error(`Failed to create git stash: ${error.message || 'Unknown error'}`);
        }
    }
    /**
     * Create a named checkpoint stash for specific operations
     */
    async createCheckpointStash(operation, phase) {
        const description = `Checkpoint before ${operation} in ${phase}`;
        return this.createStash(description, phase);
    }
    /**
     * Apply a specific git stash with automatic rollback scenarios
     */
    async applyStash(stashId, validateAfter = true) {
        try {
            const stash = this.stashes.get(stashId);
            if (!stash) {
                throw new Error(`Stash not found: ${stashId}`);
            }
            // Use the stored reference if available, otherwise try to find by message
            let stashRef = stash.ref;
            if (!stashRef) {
                stashRef = await this.findStashByMessage(stash.description);
            }
            // Apply the stash
            (0, child_process_1.execSync)(`git stash apply ${stashRef}`, {
                encoding: 'utf8',
                stdio: 'pipe'
            });
            // Validate after application if requested
            if (validateAfter) {
                const validation = await this.validateGitState();
                if (!validation.success) {
                    console.warn(`⚠️ Git state validation warnings after stash apply: ${validation.warnings.join(', ')}`);
                }
            }
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.ROLLBACK_TRIGGERED,
                timestamp: new Date(),
                description: `Git stash applied: ${stashId} (${stashRef})`,
                severity: campaign_1.SafetyEventSeverity.WARNING,
                action: 'STASH_APPLY'
            });
            console.log(`🔄 Applied git stash: ${stashId}`);
            console.log(`   Reference: ${stashRef}`);
        }
        catch (error) {
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.EMERGENCY_RECOVERY,
                timestamp: new Date(),
                description: `Failed to apply git stash ${stashId}: ${error.message || 'Unknown error'}`,
                severity: campaign_1.SafetyEventSeverity.ERROR,
                action: 'STASH_APPLY_FAILED'
            });
            throw new Error(`Failed to apply git stash ${stashId}: ${error.message || 'Unknown error'}`);
        }
    }
    /**
     * Automatically apply the most recent stash for rollback scenarios
     */
    async autoApplyLatestStash() {
        const stashes = Array.from(this.stashes.values())
            .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
        if (stashes.length === 0) {
            throw new Error('No stashes available for automatic rollback');
        }
        const latestStash = stashes[0];
        await this.applyStash(latestStash.id);
        return latestStash.id;
    }
    /**
     * Apply stash by phase for targeted rollbacks
     */
    async applyStashByPhase(phase) {
        const phaseStashes = Array.from(this.stashes.values())
            .filter(stash => stash.id.includes(`-${phase}-`))
            .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
        if (phaseStashes.length === 0) {
            throw new Error(`No stashes found for phase: ${phase}`);
        }
        const latestPhaseStash = phaseStashes[0];
        await this.applyStash(latestPhaseStash.id);
        return latestPhaseStash.id;
    }
    /**
     * List all campaign stashes
     */
    async listStashes() {
        return Array.from(this.stashes.values());
    }
    /**
     * Detect file corruption using comprehensive syntax validation patterns
     */
    async detectCorruption(files) {
        const detectedFiles = [];
        const corruptionPatterns = [];
        let maxSeverity = campaign_1.CorruptionSeverity.LOW;
        console.log(`🔍 Analyzing ${files.length} files for corruption patterns...`);
        for (const filePath of files) {
            if (!fs.existsSync(filePath)) {
                console.warn(`⚠️ File not found: ${filePath}`);
                continue;
            }
            try {
                const content = fs.readFileSync(filePath, 'utf8');
                const fileCorruption = this.analyzeFileCorruption(filePath, content);
                if (fileCorruption.patterns.length > 0) {
                    detectedFiles.push(filePath);
                    corruptionPatterns.push(...fileCorruption.patterns);
                    console.log(`🚨 Corruption detected in ${filePath}: ${fileCorruption.patterns.length} patterns`);
                    // Update max severity
                    if (fileCorruption.severity === campaign_1.CorruptionSeverity.CRITICAL) {
                        maxSeverity = campaign_1.CorruptionSeverity.CRITICAL;
                    }
                    else if (fileCorruption.severity === campaign_1.CorruptionSeverity.HIGH && maxSeverity !== campaign_1.CorruptionSeverity.CRITICAL) {
                        maxSeverity = campaign_1.CorruptionSeverity.HIGH;
                    }
                    else if (fileCorruption.severity === campaign_1.CorruptionSeverity.MEDIUM && maxSeverity === campaign_1.CorruptionSeverity.LOW) {
                        maxSeverity = campaign_1.CorruptionSeverity.MEDIUM;
                    }
                }
            }
            catch (error) {
                // File read error might indicate corruption
                detectedFiles.push(filePath);
                corruptionPatterns.push({
                    pattern: 'FILE_READ_ERROR',
                    description: `Cannot read file: ${error.message || 'Unknown error'}`,
                    files: [filePath]
                });
                maxSeverity = campaign_1.CorruptionSeverity.HIGH;
                console.error(`❌ File read error in ${filePath}: ${error.message || 'Unknown error'}`);
            }
        }
        const recommendedAction = this.determineRecoveryAction(maxSeverity, detectedFiles.length);
        const report = {
            detectedFiles,
            corruptionPatterns,
            severity: maxSeverity,
            recommendedAction
        };
        if (detectedFiles.length > 0) {
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.CORRUPTION_DETECTED,
                timestamp: new Date(),
                description: `Corruption detected in ${detectedFiles.length} files (${maxSeverity} severity)`,
                severity: this.mapCorruptionToEventSeverity(maxSeverity),
                action: 'CORRUPTION_DETECTED'
            });
            console.log(`📊 Corruption analysis complete: ${detectedFiles.length} files affected, severity: ${maxSeverity}`);
        }
        else {
            console.log(`✅ No corruption detected in ${files.length} files`);
        }
        return report;
    }
    /**
     * Detect import/export corruption based on existing script knowledge
     */
    async detectImportExportCorruption(files) {
        const detectedFiles = [];
        const corruptionPatterns = [];
        let maxSeverity = campaign_1.CorruptionSeverity.LOW;
        console.log(`🔍 Analyzing import/export corruption in ${files.length} files...`);
        for (const filePath of files) {
            if (!fs.existsSync(filePath) || !filePath.match(/\.(ts|tsx|js|jsx)$/)) {
                continue;
            }
            try {
                const content = fs.readFileSync(filePath, 'utf8');
                const importExportCorruption = this.analyzeImportExportCorruption(filePath, content);
                if (importExportCorruption.patterns.length > 0) {
                    detectedFiles.push(filePath);
                    corruptionPatterns.push(...importExportCorruption.patterns);
                    if (importExportCorruption.severity === campaign_1.CorruptionSeverity.CRITICAL) {
                        maxSeverity = campaign_1.CorruptionSeverity.CRITICAL;
                    }
                    else if (importExportCorruption.severity === campaign_1.CorruptionSeverity.HIGH && maxSeverity !== campaign_1.CorruptionSeverity.CRITICAL) {
                        maxSeverity = campaign_1.CorruptionSeverity.HIGH;
                    }
                    else if (importExportCorruption.severity === campaign_1.CorruptionSeverity.MEDIUM && maxSeverity === campaign_1.CorruptionSeverity.LOW) {
                        maxSeverity = campaign_1.CorruptionSeverity.MEDIUM;
                    }
                }
            }
            catch (error) {
                console.error(`❌ Error analyzing import/export corruption in ${filePath}: ${error.message || 'Unknown error'}`);
            }
        }
        const recommendedAction = this.determineRecoveryAction(maxSeverity, detectedFiles.length);
        return {
            detectedFiles,
            corruptionPatterns,
            severity: maxSeverity,
            recommendedAction
        };
    }
    /**
     * Real-time monitoring during script execution
     */
    async startRealTimeMonitoring(files, intervalMs = 5000) {
        console.log(`🔄 Starting real-time corruption monitoring for ${files.length} files...`);
        const monitoringInterval = setInterval(async () => {
            try {
                const report = await this.detectCorruption(files);
                if (report.detectedFiles.length > 0) {
                    console.warn(`⚠️ Real-time monitoring detected corruption in ${report.detectedFiles.length} files`);
                    this.addSafetyEvent({
                        type: campaign_1.SafetyEventType.CORRUPTION_DETECTED,
                        timestamp: new Date(),
                        description: `Real-time monitoring detected corruption: ${report.severity}`,
                        severity: this.mapCorruptionToEventSeverity(report.severity),
                        action: 'REALTIME_CORRUPTION_DETECTED'
                    });
                    // If critical corruption is detected, trigger emergency rollback
                    if (report.severity === campaign_1.CorruptionSeverity.CRITICAL && this.settings.automaticRollbackEnabled) {
                        console.error(`🚨 Critical corruption detected! Triggering emergency rollback...`);
                        clearInterval(monitoringInterval);
                        await this.emergencyRollback();
                        return;
                    }
                }
            }
            catch (error) {
                console.error(`❌ Error during real-time monitoring: ${error.message || 'Unknown error'}`);
            }
        }, intervalMs);
        // Store the interval ID for cleanup
        this.monitoringInterval = monitoringInterval;
    }
    /**
     * Stop real-time monitoring
     */
    stopRealTimeMonitoring() {
        if (this.monitoringInterval) {
            clearInterval(this.monitoringInterval);
            this.monitoringInterval = null;
            console.log(`⏹️ Real-time corruption monitoring stopped`);
        }
    }
    /**
     * Validate syntax using TypeScript compiler
     */
    async validateSyntaxWithTypeScript(files) {
        const detectedFiles = [];
        const corruptionPatterns = [];
        let maxSeverity = campaign_1.CorruptionSeverity.LOW;
        console.log(`🔍 Validating syntax with TypeScript compiler for ${files.length} files...`);
        try {
            // Run TypeScript compiler to check for syntax errors
            const tsFiles = files.filter(f => f.match(/\.(ts|tsx)$/));
            if (tsFiles.length === 0) {
                return { detectedFiles, corruptionPatterns, severity: maxSeverity, recommendedAction: campaign_1.RecoveryAction.CONTINUE };
            }
            const tscOutput = (0, child_process_1.execSync)('yarn tsc --noEmit --skipLibCheck 2>&1', {
                encoding: 'utf8',
                stdio: 'pipe'
            });
            // Parse TypeScript compiler output for syntax errors
            const lines = tscOutput.split('\n');
            for (const line of lines) {
                if (line.includes('error TS') && (line.includes('Unexpected token') || line.includes('Expression expected'))) {
                    const fileMatch = line.match(/^([^(]+)\(/);
                    if (fileMatch) {
                        const filePath = fileMatch[1];
                        if (files.includes(filePath) && !detectedFiles.includes(filePath)) {
                            detectedFiles.push(filePath);
                            corruptionPatterns.push({
                                pattern: 'TYPESCRIPT_SYNTAX_ERROR',
                                description: line.trim(),
                                files: [filePath]
                            });
                            maxSeverity = campaign_1.CorruptionSeverity.HIGH;
                        }
                    }
                }
            }
        }
        catch (error) {
            // TypeScript compiler errors might indicate syntax corruption
            const errorOutput = error.stdout || error.message;
            if (errorOutput.includes('Unexpected token') || errorOutput.includes('Expression expected')) {
                maxSeverity = campaign_1.CorruptionSeverity.HIGH;
                corruptionPatterns.push({
                    pattern: 'TYPESCRIPT_COMPILATION_ERROR',
                    description: `TypeScript compilation failed: ${errorOutput}`,
                    files: files.filter(f => f.match(/\.(ts|tsx)$/))
                });
            }
        }
        const recommendedAction = this.determineRecoveryAction(maxSeverity, detectedFiles.length);
        return {
            detectedFiles,
            corruptionPatterns,
            severity: maxSeverity,
            recommendedAction
        };
    }
    /**
     * Emergency rollback to clean state
     */
    async emergencyRollback() {
        try {
            // Get the most recent stash
            const stashes = Array.from(this.stashes.values())
                .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
            if (stashes.length === 0) {
                throw new Error('No stashes available for emergency rollback');
            }
            const latestStash = stashes[0];
            await this.applyStash(latestStash.id);
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.EMERGENCY_RECOVERY,
                timestamp: new Date(),
                description: `Emergency rollback completed using stash: ${latestStash.id}`,
                severity: campaign_1.SafetyEventSeverity.WARNING,
                action: 'EMERGENCY_ROLLBACK'
            });
            console.log(`🚨 Emergency rollback completed using stash: ${latestStash.id}`);
        }
        catch (error) {
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.EMERGENCY_RECOVERY,
                timestamp: new Date(),
                description: `Emergency rollback failed: ${error.message || 'Unknown error'}`,
                severity: campaign_1.SafetyEventSeverity.CRITICAL,
                action: 'EMERGENCY_ROLLBACK_FAILED'
            });
            throw new Error(`Emergency rollback failed: ${error.message || 'Unknown error'}`);
        }
    }
    /**
     * Validate git repository state
     */
    async validateGitState() {
        try {
            // Check if git repo exists
            if (!fs.existsSync('.git')) {
                return {
                    success: false,
                    errors: ['Not a git repository'],
                    warnings: []
                };
            }
            // Check for uncommitted changes
            const status = (0, child_process_1.execSync)('git status --porcelain', { encoding: 'utf8' });
            const hasUncommittedChanges = status.trim().length > 0;
            const warnings = [];
            if (hasUncommittedChanges && !this.settings.automaticRollbackEnabled) {
                warnings.push('Uncommitted changes detected - consider creating a stash');
            }
            return {
                success: true,
                errors: [],
                warnings
            };
        }
        catch (error) {
            return {
                success: false,
                errors: [`Git validation failed: ${error.message || 'Unknown error'}`],
                warnings: []
            };
        }
    }
    /**
     * Clean up old stashes based on configurable retention policy
     */
    async cleanupOldStashes() {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - this.settings.stashRetentionDays);
        const stashesToRemove = [];
        let cleanedCount = 0;
        for (const [stashId, stash] of this.stashes.entries()) {
            if (stash.timestamp < cutoffDate) {
                stashesToRemove.push(stashId);
            }
        }
        for (const stashId of stashesToRemove) {
            try {
                const stash = this.stashes.get(stashId);
                if (stash?.ref) {
                    // Try to drop the actual git stash if we have the reference
                    try {
                        (0, child_process_1.execSync)(`git stash drop ${stash.ref}`, {
                            encoding: 'utf8',
                            stdio: 'pipe'
                        });
                    }
                    catch (gitError) {
                        // Stash might already be gone, just log warning
                        console.warn(`⚠️ Could not drop git stash ${stash.ref}: ${gitError.message || 'Unknown error'}`);
                    }
                }
                // Remove from our tracking
                this.stashes.delete(stashId);
                cleanedCount++;
                console.log(`🧹 Cleaned up old stash: ${stashId}`);
            }
            catch (error) {
                console.warn(`⚠️ Failed to cleanup stash ${stashId}: ${error.message || 'Unknown error'}`);
            }
        }
        if (cleanedCount > 0) {
            this.saveStashTracking();
            this.addSafetyEvent({
                type: campaign_1.SafetyEventType.CHECKPOINT_CREATED,
                timestamp: new Date(),
                description: `Cleaned up ${cleanedCount} old stashes`,
                severity: campaign_1.SafetyEventSeverity.INFO,
                action: 'STASH_CLEANUP'
            });
        }
    }
    /**
     * Get stashes by phase for targeted operations
     */
    async getStashesByPhase(phase) {
        return Array.from(this.stashes.values())
            .filter(stash => stash.id.includes(`-${phase}-`))
            .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
    }
    /**
     * Get stash statistics for reporting
     */
    getStashStatistics() {
        const stashes = Array.from(this.stashes.values());
        const byPhase = {};
        // Count stashes by phase
        for (const stash of stashes) {
            const phaseMatch = stash.id.match(/campaign-([^-]+)-/);
            if (phaseMatch) {
                const phase = phaseMatch[1];
                byPhase[phase] = (byPhase[phase] || 0) + 1;
            }
        }
        const timestamps = stashes.map(s => s.timestamp);
        const oldestStash = timestamps.length > 0 ? new Date(Math.min(...timestamps.map(t => t.getTime()))) : undefined;
        const newestStash = timestamps.length > 0 ? new Date(Math.max(...timestamps.map(t => t.getTime()))) : undefined;
        return {
            total: stashes.length,
            byPhase,
            oldestStash,
            newestStash
        };
    }
    /**
     * Get safety events for reporting
     */
    getSafetyEvents() {
        return [...this.safetyEvents];
    }
    // Private helper methods
    analyzeFileCorruption(filePath, content) {
        const patterns = [];
        let severity = campaign_1.CorruptionSeverity.LOW;
        // Check for import corruption patterns (based on existing scripts)
        const importCorruptionPatterns = [
            {
                regex: /import @\/types\s+from '[^']*'\s*;/g,
                description: 'Corrupted type import statement',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import @\/services\s+from '[^']*'\s*;/g,
                description: 'Corrupted service import statement',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /<<<<<<|>>>>>>|======/g,
                description: 'Git merge conflict markers',
                severity: campaign_1.CorruptionSeverity.CRITICAL
            },
            {
                regex: /\bposit:\s*anyi:\s*anyo:\s*anyn:\s*anys:/g,
                description: 'Corrupted parameter names',
                severity: campaign_1.CorruptionSeverity.MEDIUM
            },
            {
                regex: /\bcate:\s*anyg:\s*anyo:\s*anyr:\s*anyy:/g,
                description: 'Corrupted parameter names',
                severity: campaign_1.CorruptionSeverity.MEDIUM
            }
        ];
        for (const corruptionPattern of importCorruptionPatterns) {
            const matches = content.match(corruptionPattern.regex);
            if (matches) {
                patterns.push({
                    pattern: corruptionPattern.regex.source,
                    description: corruptionPattern.description,
                    files: [filePath]
                });
                // Update severity to the highest found
                if (corruptionPattern.severity === campaign_1.CorruptionSeverity.CRITICAL) {
                    severity = campaign_1.CorruptionSeverity.CRITICAL;
                }
                else if (corruptionPattern.severity === campaign_1.CorruptionSeverity.HIGH && severity !== campaign_1.CorruptionSeverity.CRITICAL) {
                    severity = campaign_1.CorruptionSeverity.HIGH;
                }
                else if (corruptionPattern.severity === campaign_1.CorruptionSeverity.MEDIUM && severity === campaign_1.CorruptionSeverity.LOW) {
                    severity = campaign_1.CorruptionSeverity.MEDIUM;
                }
            }
        }
        // Check for syntax corruption
        if (this.hasSyntaxCorruption(content)) {
            patterns.push({
                pattern: 'SYNTAX_CORRUPTION',
                description: 'Syntax corruption detected',
                files: [filePath]
            });
            severity = campaign_1.CorruptionSeverity.HIGH;
        }
        return { patterns, severity };
    }
    hasSyntaxCorruption(content) {
        // Check for unbalanced brackets (more lenient threshold)
        const openBrackets = (content.match(/\{/g) || []).length;
        const closeBrackets = (content.match(/\}/g) || []).length;
        const openParens = (content.match(/\(/g) || []).length;
        const closeParens = (content.match(/\)/g) || []).length;
        if (Math.abs(openBrackets - closeBrackets) > 1 || Math.abs(openParens - closeParens) > 1) {
            return true;
        }
        // Check for incomplete statements
        const incompletePatterns = [
            /export\s*$/m,
            /import\s*$/m,
            /function\s*$/m,
            /const\s*$/m,
            /let\s*$/m,
            /var\s*$/m
        ];
        return incompletePatterns.some(pattern => pattern.test(content));
    }
    /**
     * Analyze import/export corruption patterns based on existing script knowledge
     */
    analyzeImportExportCorruption(filePath, content) {
        const patterns = [];
        let severity = campaign_1.CorruptionSeverity.LOW;
        // Import/Export corruption patterns based on existing script knowledge
        const importExportCorruptionPatterns = [
            {
                regex: /import\s+\{\s*\}\s+from\s+['"][^'"]*['"];?/g,
                description: 'Empty import statement',
                severity: campaign_1.CorruptionSeverity.MEDIUM
            },
            {
                regex: /import\s+[^{]*\s+from\s+['"]undefined['"];?/g,
                description: 'Import from undefined module',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s+[^{]*\s+from\s+['"]['"]\s*;?/g,
                description: 'Import from empty string',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /export\s+\{\s*\}\s*;?/g,
                description: 'Empty export statement',
                severity: campaign_1.CorruptionSeverity.MEDIUM
            },
            {
                regex: /import\s+[^{]*\s+from\s+['"][^'"]*['"]\s+from\s+['"][^'"]*['"];?/g,
                description: 'Duplicate from clause in import',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s*\{\s*[^}]*,\s*,\s*[^}]*\}\s*from/g,
                description: 'Double comma in import destructuring',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s*\{\s*[^}]*\s+as\s+as\s+[^}]*\}\s*from/g,
                description: 'Duplicate "as" keyword in import',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /export\s*\{\s*[^}]*,\s*,\s*[^}]*\}/g,
                description: 'Double comma in export destructuring',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s+[^{]*\s+from\s+['"]@\/[^'"]*\s+@\/[^'"]*['"];?/g,
                description: 'Corrupted path alias in import',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s+[^{]*\s+from\s+['"][^'"]*\.\.[^'"]*\.\.[^'"]*['"];?/g,
                description: 'Corrupted relative path with multiple ..',
                severity: campaign_1.CorruptionSeverity.MEDIUM
            },
            {
                regex: /import\s*\{\s*[^}]*\s*\}\s*\{\s*[^}]*\s*\}\s*from/g,
                description: 'Duplicate destructuring braces in import',
                severity: campaign_1.CorruptionSeverity.CRITICAL
            },
            {
                regex: /export\s+default\s+default\s+/g,
                description: 'Duplicate default keyword in export',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s+type\s+type\s+/g,
                description: 'Duplicate type keyword in import',
                severity: campaign_1.CorruptionSeverity.HIGH
            },
            {
                regex: /import\s*\*\s+as\s+\*\s+as\s+/g,
                description: 'Corrupted namespace import syntax',
                severity: campaign_1.CorruptionSeverity.CRITICAL
            }
        ];
        for (const corruptionPattern of importExportCorruptionPatterns) {
            const matches = content.match(corruptionPattern.regex);
            if (matches) {
                patterns.push({
                    pattern: corruptionPattern.regex.source,
                    description: `${corruptionPattern.description} (${matches.length} occurrences)`,
                    files: [filePath]
                });
                // Update severity to the highest found
                if (corruptionPattern.severity === campaign_1.CorruptionSeverity.CRITICAL) {
                    severity = campaign_1.CorruptionSeverity.CRITICAL;
                }
                else if (corruptionPattern.severity === campaign_1.CorruptionSeverity.HIGH && severity !== campaign_1.CorruptionSeverity.CRITICAL) {
                    severity = campaign_1.CorruptionSeverity.HIGH;
                }
                else if (corruptionPattern.severity === campaign_1.CorruptionSeverity.MEDIUM && severity === campaign_1.CorruptionSeverity.LOW) {
                    severity = campaign_1.CorruptionSeverity.MEDIUM;
                }
            }
        }
        // Check for malformed import/export statements
        const malformedPatterns = [
            /import\s+[^{]*\s+from(?!\s+['"])/g,
            /export\s+[^{]*\s+from(?!\s+['"])/g,
            /import\s*\{[^}]*\s+from\s+[^'"]/g,
            /export\s*\{[^}]*\s+from\s+[^'"]/g // export with missing quotes
        ];
        for (const pattern of malformedPatterns) {
            const matches = content.match(pattern);
            if (matches) {
                patterns.push({
                    pattern: pattern.source,
                    description: 'Malformed import/export statement syntax',
                    files: [filePath]
                });
                severity = campaign_1.CorruptionSeverity.HIGH;
            }
        }
        return { patterns, severity };
    }
    determineRecoveryAction(severity, fileCount) {
        if (severity === campaign_1.CorruptionSeverity.CRITICAL) {
            return campaign_1.RecoveryAction.EMERGENCY_RESTORE;
        }
        if (severity === campaign_1.CorruptionSeverity.HIGH || fileCount > 10) {
            return campaign_1.RecoveryAction.ROLLBACK;
        }
        if (severity === campaign_1.CorruptionSeverity.MEDIUM || fileCount > 5) {
            return campaign_1.RecoveryAction.RETRY;
        }
        return campaign_1.RecoveryAction.CONTINUE;
    }
    mapCorruptionToEventSeverity(corruption) {
        switch (corruption) {
            case campaign_1.CorruptionSeverity.CRITICAL:
                return campaign_1.SafetyEventSeverity.CRITICAL;
            case campaign_1.CorruptionSeverity.HIGH:
                return campaign_1.SafetyEventSeverity.ERROR;
            case campaign_1.CorruptionSeverity.MEDIUM:
                return campaign_1.SafetyEventSeverity.WARNING;
            case campaign_1.CorruptionSeverity.LOW:
            default:
                return campaign_1.SafetyEventSeverity.INFO;
        }
    }
    getCurrentBranch() {
        try {
            return (0, child_process_1.execSync)('git branch --show-current', { encoding: 'utf8' }).trim();
        }
        catch {
            return 'unknown';
        }
    }
    addSafetyEvent(event) {
        this.safetyEvents.push(event);
        // Keep only recent events to prevent memory issues
        if (this.safetyEvents.length > 1000) {
            this.safetyEvents = this.safetyEvents.slice(-500);
        }
    }
    /**
     * Initialize stash tracking from persistent storage
     */
    initializeStashTracking() {
        try {
            const stashTrackingPath = path.join('.kiro', 'campaign-stashes.json');
            if (fs.existsSync(stashTrackingPath)) {
                const data = fs.readFileSync(stashTrackingPath, 'utf8');
                const parsed = JSON.parse(data);
                // Restore stashes with proper Date objects
                for (const [id, stashData] of Object.entries(parsed.stashes || {})) {
                    const stash = stashData;
                    this.stashes.set(id, {
                        ...stash,
                        timestamp: new Date(stash.timestamp)
                    });
                }
                this.stashCounter = parsed.counter || 0;
            }
        }
        catch (error) {
            console.warn(`⚠️ Could not load stash tracking: ${error.message || 'Unknown error'}`);
            this.stashCounter = 0;
        }
    }
    /**
     * Save stash tracking to persistent storage
     */
    saveStashTracking() {
        try {
            const stashTrackingPath = path.join('.kiro', 'campaign-stashes.json');
            // Ensure .kiro directory exists
            const kiroDir = path.dirname(stashTrackingPath);
            if (!fs.existsSync(kiroDir)) {
                fs.mkdirSync(kiroDir, { recursive: true });
            }
            const data = {
                counter: this.stashCounter,
                stashes: Object.fromEntries(this.stashes.entries()),
                lastUpdated: new Date().toISOString()
            };
            fs.writeFileSync(stashTrackingPath, JSON.stringify(data, null, 2));
        }
        catch (error) {
            console.warn(`⚠️ Could not save stash tracking: ${error.message || 'Unknown error'}`);
        }
    }
    /**
     * Find stash by message when reference is not available
     */
    async findStashByMessage(message) {
        try {
            const stashList = (0, child_process_1.execSync)('git stash list', { encoding: 'utf8' });
            const lines = stashList.split('\n');
            for (const line of lines) {
                if (line.includes(message)) {
                    const match = line.match(/^(stash@\{\d+\})/);
                    if (match) {
                        return match[1];
                    }
                }
            }
            throw new Error(`Stash not found with message: ${message}`);
        }
        catch (error) {
            throw new Error(`Failed to find stash by message: ${error.message || 'Unknown error'}`);
        }
    }
}
exports.SafetyProtocol = SafetyProtocol;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9zZXJ2aWNlcy9jYW1wYWlnbi9TYWZldHlQcm90b2NvbC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILGlEQUF5QztBQUN6Qyx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBRTdCLG1EQVc4QjtBQUU5QixNQUFhLGNBQWM7SUFDakIsUUFBUSxDQUFpQjtJQUN6QixPQUFPLEdBQTBCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDM0MsWUFBWSxHQUFrQixFQUFFLENBQUM7SUFDakMsWUFBWSxHQUFXLENBQUMsQ0FBQztJQUVqQyxZQUFZLFFBQXdCO1FBQ2xDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxXQUFXLENBQUMsV0FBbUIsRUFBRSxLQUFjO1FBQ25ELElBQUk7WUFDRixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzdDLE1BQU0sU0FBUyxHQUFHLFlBQVksV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksU0FBUyxFQUFFLENBQUM7WUFDN0UsTUFBTSxlQUFlLEdBQUcsR0FBRyxTQUFTLEtBQUssV0FBVyxFQUFFLENBQUM7WUFFdkQsMkNBQTJDO1lBQzNDLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDcEQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUU7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cy9HcmVnQ2FzdHJvL0Rlc2t0b3AvV2hhdFRvRWF0TmV4dC9zcmMvc2VydmljZXMvY2FtcGFpZ24vU2FmZXR5UHJvdG9jb2wudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTYWZldHkgUHJvdG9jb2wgU3lzdGVtXG4gKiBQZXJmZWN0IENvZGViYXNlIENhbXBhaWduIC0gQ29tcHJlaGVuc2l2ZSBTYWZldHkgSW1wbGVtZW50YXRpb25cbiAqL1xuXG5pbXBvcnQgeyBleGVjU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHtcbiAgU2FmZXR5U2V0dGluZ3MsXG4gIENvcnJ1cHRpb25SZXBvcnQsXG4gIENvcnJ1cHRpb25QYXR0ZXJuLFxuICBDb3JydXB0aW9uU2V2ZXJpdHksXG4gIFJlY292ZXJ5QWN0aW9uLFxuICBHaXRTdGFzaCxcbiAgU2FmZXR5RXZlbnQsXG4gIFNhZmV0eUV2ZW50VHlwZSxcbiAgU2FmZXR5RXZlbnRTZXZlcml0eSxcbiAgVmFsaWRhdGlvblJlc3VsdFxufSBmcm9tICcuLi8uLi90eXBlcy9jYW1wYWlnbic7XG5cbmV4cG9ydCBjbGFzcyBTYWZldHlQcm90b2NvbCB7XG4gIHByaXZhdGUgc2V0dGluZ3M6IFNhZmV0eVNldHRpbmdzO1xuICBwcml2YXRlIHN0YXNoZXM6IE1hcDxzdHJpbmcsIEdpdFN0YXNoPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBzYWZldHlFdmVudHM6IFNhZmV0eUV2ZW50W10gPSBbXTtcbiAgcHJpdmF0ZSBzdGFzaENvdW50ZXI6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3Ioc2V0dGluZ3M6IFNhZmV0eVNldHRpbmdzKSB7XG4gICAgdGhpcy5zZXR0aW5ncyA9IHNldHRpbmdzO1xuICAgIHRoaXMuaW5pdGlhbGl6ZVN0YXNoVHJhY2tpbmcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBnaXQgc3Rhc2ggd2l0aCBkZXNjcmlwdGl2ZSBuYW1pbmcgY29udmVudGlvbnNcbiAgICovXG4gIGFzeW5jIGNyZWF0ZVN0YXNoKGRlc2NyaXB0aW9uOiBzdHJpbmcsIHBoYXNlPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5zdGFzaENvdW50ZXIrKztcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9bOi5dL2csICctJyk7XG4gICAgICBjb25zdCBwaGFzZVByZWZpeCA9IHBoYXNlID8gYCR7cGhhc2V9LWAgOiAnJztcbiAgICAgIGNvbnN0IHN0YXNoTmFtZSA9IGBjYW1wYWlnbi0ke3BoYXNlUHJlZml4fSR7dGhpcy5zdGFzaENvdW50ZXJ9LSR7dGltZXN0YW1wfWA7XG4gICAgICBjb25zdCBmdWxsRGVzY3JpcHRpb24gPSBgJHtzdGFzaE5hbWV9OiAke2Rlc2NyaXB0aW9ufWA7XG5cbiAgICAgIC8vIFZhbGlkYXRlIGdpdCBzdGF0ZSBiZWZvcmUgY3JlYXRpbmcgc3Rhc2hcbiAgICAgIGNvbnN0IGdpdFZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnZhbGlkYXRlR2l0U3RhdGUoKTtcbiAgICAgIGlmICghZ2l0VmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgR2l0IHZhbGlkYXRpb24gZmFpbGVkOiAke2dpdFZhbGlkYXRpb24uZXJyb3JzLmpvaW4oJywgJyl9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSB0aGUgZ2l0IHN0YXNoIHdpdGggYWxsIGZpbGVzIGluY2x1ZGluZyB1bnRyYWNrZWRcbiAgICAgIGV4ZWNTeW5jKGBnaXQgc3Rhc2ggcHVzaCAtdSAtbSBcIiR7ZnVsbERlc2NyaXB0aW9ufVwiYCwgeyBcbiAgICAgICAgZW5jb2Rpbmc6ICd1dGY4JyxcbiAgICAgICAgc3RkaW86ICdwaXBlJ1xuICAgICAgfSk7XG5cbiAgICAgIC8vIEdldCB0aGUgYWN0dWFsIHN0YXNoIHJlZmVyZW5jZVxuICAgICAgY29uc3Qgc3Rhc2hMaXN0ID0gZXhlY1N5bmMoJ2dpdCBzdGFzaCBsaXN0IC0tb25lbGluZScsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcbiAgICAgIGNvbnN0IHN0YXNoUmVmID0gc3Rhc2hMaXN0LnNwbGl0KCdcXG4nKVswXT8uc3BsaXQoJzonKVswXSB8fCAnc3Rhc2hAezB9JztcblxuICAgICAgLy8gU3RvcmUgc3Rhc2ggaW5mb3JtYXRpb25cbiAgICAgIGNvbnN0IHN0YXNoOiBHaXRTdGFzaCA9IHtcbiAgICAgICAgaWQ6IHN0YXNoTmFtZSxcbiAgICAgICAgZGVzY3JpcHRpb246IGZ1bGxEZXNjcmlwdGlvbixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBicmFuY2g6IHRoaXMuZ2V0Q3VycmVudEJyYW5jaCgpLFxuICAgICAgICByZWY6IHN0YXNoUmVmXG4gICAgICB9O1xuXG4gICAgICB0aGlzLnN0YXNoZXMuc2V0KHN0YXNoTmFtZSwgc3Rhc2gpO1xuICAgICAgdGhpcy5zYXZlU3Rhc2hUcmFja2luZygpO1xuXG4gICAgICB0aGlzLmFkZFNhZmV0eUV2ZW50KHtcbiAgICAgICAgdHlwZTogU2FmZXR5RXZlbnRUeXBlLkNIRUNLUE9JTlRfQ1JFQVRFRCxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBkZXNjcmlwdGlvbjogYEdpdCBzdGFzaCBjcmVhdGVkOiAke3N0YXNoTmFtZX0gKCR7c3Rhc2hSZWZ9KWAsXG4gICAgICAgIHNldmVyaXR5OiBTYWZldHlFdmVudFNldmVyaXR5LklORk8sXG4gICAgICAgIGFjdGlvbjogJ1NUQVNIX0NSRUFURSdcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmxvZyhg8J+TpiBDcmVhdGVkIGdpdCBzdGFzaDogJHtzdGFzaE5hbWV9YCk7XG4gICAgICBjb25zb2xlLmxvZyhgICAgUmVmZXJlbmNlOiAke3N0YXNoUmVmfWApO1xuICAgICAgY29uc29sZS5sb2coYCAgIFJvbGxiYWNrIHdpdGg6IGdpdCBzdGFzaCBhcHBseSAke3N0YXNoUmVmfWApO1xuXG4gICAgICByZXR1cm4gc3Rhc2hOYW1lO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuYWRkU2FmZXR5RXZlbnQoe1xuICAgICAgICB0eXBlOiBTYWZldHlFdmVudFR5cGUuRU1FUkdFTkNZX1JFQ09WRVJZLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgRmFpbGVkIHRvIGNyZWF0ZSBnaXQgc3Rhc2g6ICR7KGVycm9yIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5tZXNzYWdlIHx8ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICBzZXZlcml0eTogU2FmZXR5RXZlbnRTZXZlcml0eS5FUlJPUixcbiAgICAgICAgYWN0aW9uOiAnU1RBU0hfRkFJTEVEJ1xuICAgICAgfSk7XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNyZWF0ZSBnaXQgc3Rhc2g6ICR7KGVycm9yIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5tZXNzYWdlIHx8ICdVbmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmFtZWQgY2hlY2twb2ludCBzdGFzaCBmb3Igc3BlY2lmaWMgb3BlcmF0aW9uc1xuICAgKi9cbiAgYXN5bmMgY3JlYXRlQ2hlY2twb2ludFN0YXNoKG9wZXJhdGlvbjogc3RyaW5nLCBwaGFzZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBkZXNjcmlwdGlvbiA9IGBDaGVja3BvaW50IGJlZm9yZSAke29wZXJhdGlvbn0gaW4gJHtwaGFzZX1gO1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVN0YXNoKGRlc2NyaXB0aW9uLCBwaGFzZSk7XG4gIH1cblxuICAvKipcbiAgICogQXBwbHkgYSBzcGVjaWZpYyBnaXQgc3Rhc2ggd2l0aCBhdXRvbWF0aWMgcm9sbGJhY2sgc2NlbmFyaW9zXG4gICAqL1xuICBhc3luYyBhcHBseVN0YXNoKHN0YXNoSWQ6IHN0cmluZywgdmFsaWRhdGVBZnRlcjogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3Rhc2ggPSB0aGlzLnN0YXNoZXMuZ2V0KHN0YXNoSWQpO1xuICAgICAgaWYgKCFzdGFzaCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN0YXNoIG5vdCBmb3VuZDogJHtzdGFzaElkfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBVc2UgdGhlIHN0b3JlZCByZWZlcmVuY2UgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgdHJ5IHRvIGZpbmQgYnkgbWVzc2FnZVxuICAgICAgbGV0IHN0YXNoUmVmID0gc3Rhc2gucmVmO1xuICAgICAgaWYgKCFzdGFzaFJlZikge1xuICAgICAgICBzdGFzaFJlZiA9IGF3YWl0IHRoaXMuZmluZFN0YXNoQnlNZXNzYWdlKHN0YXNoLmRlc2NyaXB0aW9uKTtcbiAgICAgIH1cblxuICAgICAgLy8gQXBwbHkgdGhlIHN0YXNoXG4gICAgICBleGVjU3luYyhgZ2l0IHN0YXNoIGFwcGx5ICR7c3Rhc2hSZWZ9YCwge1xuICAgICAgICBlbmNvZGluZzogJ3V0ZjgnLFxuICAgICAgICBzdGRpbzogJ3BpcGUnXG4gICAgICB9KTtcblxuICAgICAgLy8gVmFsaWRhdGUgYWZ0ZXIgYXBwbGljYXRpb24gaWYgcmVxdWVzdGVkXG4gICAgICBpZiAodmFsaWRhdGVBZnRlcikge1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgdGhpcy52YWxpZGF0ZUdpdFN0YXRlKCk7XG4gICAgICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGDimqDvuI8gR2l0IHN0YXRlIHZhbGlkYXRpb24gd2FybmluZ3MgYWZ0ZXIgc3Rhc2ggYXBwbHk6ICR7dmFsaWRhdGlvbi53YXJuaW5ncy5qb2luKCcsICcpfWApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWRkU2FmZXR5RXZlbnQoe1xuICAgICAgICB0eXBlOiBTYWZldHlFdmVudFR5cGUuUk9MTEJBQ0tfVFJJR0dFUkVELFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgR2l0IHN0YXNoIGFwcGxpZWQ6ICR7c3Rhc2hJZH0gKCR7c3Rhc2hSZWZ9KWAsXG4gICAgICAgIHNldmVyaXR5OiBTYWZldHlFdmVudFNldmVyaXR5LldBUk5JTkcsXG4gICAgICAgIGFjdGlvbjogJ1NUQVNIX0FQUExZJ1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5SEIEFwcGxpZWQgZ2l0IHN0YXNoOiAke3N0YXNoSWR9YCk7XG4gICAgICBjb25zb2xlLmxvZyhgICAgUmVmZXJlbmNlOiAke3N0YXNoUmVmfWApO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuYWRkU2FmZXR5RXZlbnQoe1xuICAgICAgICB0eXBlOiBTYWZldHlFdmVudFR5cGUuRU1FUkdFTkNZX1JFQ09WRVJZLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgRmFpbGVkIHRvIGFwcGx5IGdpdCBzdGFzaCAke3N0YXNoSWR9OiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCxcbiAgICAgICAgc2V2ZXJpdHk6IFNhZmV0eUV2ZW50U2V2ZXJpdHkuRVJST1IsXG4gICAgICAgIGFjdGlvbjogJ1NUQVNIX0FQUExZX0ZBSUxFRCdcbiAgICAgIH0pO1xuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBhcHBseSBnaXQgc3Rhc2ggJHtzdGFzaElkfTogJHsoZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBdXRvbWF0aWNhbGx5IGFwcGx5IHRoZSBtb3N0IHJlY2VudCBzdGFzaCBmb3Igcm9sbGJhY2sgc2NlbmFyaW9zXG4gICAqL1xuICBhc3luYyBhdXRvQXBwbHlMYXRlc3RTdGFzaCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHN0YXNoZXMgPSBBcnJheS5mcm9tKHRoaXMuc3Rhc2hlcy52YWx1ZXMoKSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiLnRpbWVzdGFtcC5nZXRUaW1lKCkgLSBhLnRpbWVzdGFtcC5nZXRUaW1lKCkpO1xuXG4gICAgaWYgKHN0YXNoZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHN0YXNoZXMgYXZhaWxhYmxlIGZvciBhdXRvbWF0aWMgcm9sbGJhY2snKTtcbiAgICB9XG5cbiAgICBjb25zdCBsYXRlc3RTdGFzaCA9IHN0YXNoZXNbMF07XG4gICAgYXdhaXQgdGhpcy5hcHBseVN0YXNoKGxhdGVzdFN0YXNoLmlkKTtcbiAgICByZXR1cm4gbGF0ZXN0U3Rhc2guaWQ7XG4gIH1cblxuICAvKipcbiAgICogQXBwbHkgc3Rhc2ggYnkgcGhhc2UgZm9yIHRhcmdldGVkIHJvbGxiYWNrc1xuICAgKi9cbiAgYXN5bmMgYXBwbHlTdGFzaEJ5UGhhc2UocGhhc2U6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgcGhhc2VTdGFzaGVzID0gQXJyYXkuZnJvbSh0aGlzLnN0YXNoZXMudmFsdWVzKCkpXG4gICAgICAuZmlsdGVyKHN0YXNoID0+IHN0YXNoLmlkLmluY2x1ZGVzKGAtJHtwaGFzZX0tYCkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi50aW1lc3RhbXAuZ2V0VGltZSgpIC0gYS50aW1lc3RhbXAuZ2V0VGltZSgpKTtcblxuICAgIGlmIChwaGFzZVN0YXNoZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHN0YXNoZXMgZm91bmQgZm9yIHBoYXNlOiAke3BoYXNlfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGxhdGVzdFBoYXNlU3Rhc2ggPSBwaGFzZVN0YXNoZXNbMF07XG4gICAgYXdhaXQgdGhpcy5hcHBseVN0YXNoKGxhdGVzdFBoYXNlU3Rhc2guaWQpO1xuICAgIHJldHVybiBsYXRlc3RQaGFzZVN0YXNoLmlkO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3QgYWxsIGNhbXBhaWduIHN0YXNoZXNcbiAgICovXG4gIGFzeW5jIGxpc3RTdGFzaGVzKCk6IFByb21pc2U8R2l0U3Rhc2hbXT4ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuc3Rhc2hlcy52YWx1ZXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IGZpbGUgY29ycnVwdGlvbiB1c2luZyBjb21wcmVoZW5zaXZlIHN5bnRheCB2YWxpZGF0aW9uIHBhdHRlcm5zXG4gICAqL1xuICBhc3luYyBkZXRlY3RDb3JydXB0aW9uKGZpbGVzOiBzdHJpbmdbXSk6IFByb21pc2U8Q29ycnVwdGlvblJlcG9ydD4ge1xuICAgIGNvbnN0IGRldGVjdGVkRmlsZXM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgY29ycnVwdGlvblBhdHRlcm5zOiBDb3JydXB0aW9uUGF0dGVybltdID0gW107XG4gICAgbGV0IG1heFNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5LkxPVztcblxuICAgIGNvbnNvbGUubG9nKGDwn5SNIEFuYWx5emluZyAke2ZpbGVzLmxlbmd0aH0gZmlsZXMgZm9yIGNvcnJ1cHRpb24gcGF0dGVybnMuLi5gKTtcblxuICAgIGZvciAoY29uc3QgZmlsZVBhdGggb2YgZmlsZXMpIHtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGDimqDvuI8gRmlsZSBub3QgZm91bmQ6ICR7ZmlsZVBhdGh9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCAndXRmOCcpO1xuICAgICAgICBjb25zdCBmaWxlQ29ycnVwdGlvbiA9IHRoaXMuYW5hbHl6ZUZpbGVDb3JydXB0aW9uKGZpbGVQYXRoLCBjb250ZW50KTtcblxuICAgICAgICBpZiAoZmlsZUNvcnJ1cHRpb24ucGF0dGVybnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGRldGVjdGVkRmlsZXMucHVzaChmaWxlUGF0aCk7XG4gICAgICAgICAgY29ycnVwdGlvblBhdHRlcm5zLnB1c2goLi4uZmlsZUNvcnJ1cHRpb24ucGF0dGVybnMpO1xuICAgICAgICAgIFxuICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5qoIENvcnJ1cHRpb24gZGV0ZWN0ZWQgaW4gJHtmaWxlUGF0aH06ICR7ZmlsZUNvcnJ1cHRpb24ucGF0dGVybnMubGVuZ3RofSBwYXR0ZXJuc2ApO1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIFVwZGF0ZSBtYXggc2V2ZXJpdHlcbiAgICAgICAgICBpZiAoZmlsZUNvcnJ1cHRpb24uc2V2ZXJpdHkgPT09IENvcnJ1cHRpb25TZXZlcml0eS5DUklUSUNBTCkge1xuICAgICAgICAgICAgbWF4U2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuQ1JJVElDQUw7XG4gICAgICAgICAgfSBlbHNlIGlmIChmaWxlQ29ycnVwdGlvbi5zZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5LkhJR0ggJiYgbWF4U2V2ZXJpdHkgIT09IENvcnJ1cHRpb25TZXZlcml0eS5DUklUSUNBTCkge1xuICAgICAgICAgICAgbWF4U2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSDtcbiAgICAgICAgICB9IGVsc2UgaWYgKGZpbGVDb3JydXB0aW9uLnNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuTUVESVVNICYmIG1heFNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuTE9XKSB7XG4gICAgICAgICAgICBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5NRURJVU07XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIEZpbGUgcmVhZCBlcnJvciBtaWdodCBpbmRpY2F0ZSBjb3JydXB0aW9uXG4gICAgICAgIGRldGVjdGVkRmlsZXMucHVzaChmaWxlUGF0aCk7XG4gICAgICAgIGNvcnJ1cHRpb25QYXR0ZXJucy5wdXNoKHtcbiAgICAgICAgICBwYXR0ZXJuOiAnRklMRV9SRUFEX0VSUk9SJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYENhbm5vdCByZWFkIGZpbGU6ICR7KGVycm9yIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5tZXNzYWdlIHx8ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICAgIGZpbGVzOiBbZmlsZVBhdGhdXG4gICAgICAgIH0pO1xuICAgICAgICBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIO1xuICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRmlsZSByZWFkIGVycm9yIGluICR7ZmlsZVBhdGh9OiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgcmVjb21tZW5kZWRBY3Rpb24gPSB0aGlzLmRldGVybWluZVJlY292ZXJ5QWN0aW9uKG1heFNldmVyaXR5LCBkZXRlY3RlZEZpbGVzLmxlbmd0aCk7XG5cbiAgICBjb25zdCByZXBvcnQ6IENvcnJ1cHRpb25SZXBvcnQgPSB7XG4gICAgICBkZXRlY3RlZEZpbGVzLFxuICAgICAgY29ycnVwdGlvblBhdHRlcm5zLFxuICAgICAgc2V2ZXJpdHk6IG1heFNldmVyaXR5LFxuICAgICAgcmVjb21tZW5kZWRBY3Rpb25cbiAgICB9O1xuXG4gICAgaWYgKGRldGVjdGVkRmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5hZGRTYWZldHlFdmVudCh7XG4gICAgICAgIHR5cGU6IFNhZmV0eUV2ZW50VHlwZS5DT1JSVVBUSU9OX0RFVEVDVEVELFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgQ29ycnVwdGlvbiBkZXRlY3RlZCBpbiAke2RldGVjdGVkRmlsZXMubGVuZ3RofSBmaWxlcyAoJHttYXhTZXZlcml0eX0gc2V2ZXJpdHkpYCxcbiAgICAgICAgc2V2ZXJpdHk6IHRoaXMubWFwQ29ycnVwdGlvblRvRXZlbnRTZXZlcml0eShtYXhTZXZlcml0eSksXG4gICAgICAgIGFjdGlvbjogJ0NPUlJVUFRJT05fREVURUNURUQnXG4gICAgICB9KTtcblxuICAgICAgY29uc29sZS5sb2coYPCfk4ogQ29ycnVwdGlvbiBhbmFseXNpcyBjb21wbGV0ZTogJHtkZXRlY3RlZEZpbGVzLmxlbmd0aH0gZmlsZXMgYWZmZWN0ZWQsIHNldmVyaXR5OiAke21heFNldmVyaXR5fWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhg4pyFIE5vIGNvcnJ1cHRpb24gZGV0ZWN0ZWQgaW4gJHtmaWxlcy5sZW5ndGh9IGZpbGVzYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcG9ydDtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3QgaW1wb3J0L2V4cG9ydCBjb3JydXB0aW9uIGJhc2VkIG9uIGV4aXN0aW5nIHNjcmlwdCBrbm93bGVkZ2VcbiAgICovXG4gIGFzeW5jIGRldGVjdEltcG9ydEV4cG9ydENvcnJ1cHRpb24oZmlsZXM6IHN0cmluZ1tdKTogUHJvbWlzZTxDb3JydXB0aW9uUmVwb3J0PiB7XG4gICAgY29uc3QgZGV0ZWN0ZWRGaWxlczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBjb3JydXB0aW9uUGF0dGVybnM6IENvcnJ1cHRpb25QYXR0ZXJuW10gPSBbXTtcbiAgICBsZXQgbWF4U2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuTE9XO1xuXG4gICAgY29uc29sZS5sb2coYPCflI0gQW5hbHl6aW5nIGltcG9ydC9leHBvcnQgY29ycnVwdGlvbiBpbiAke2ZpbGVzLmxlbmd0aH0gZmlsZXMuLi5gKTtcblxuICAgIGZvciAoY29uc3QgZmlsZVBhdGggb2YgZmlsZXMpIHtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkgfHwgIWZpbGVQYXRoLm1hdGNoKC9cXC4odHN8dHN4fGpzfGpzeCkkLykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsICd1dGY4Jyk7XG4gICAgICAgIGNvbnN0IGltcG9ydEV4cG9ydENvcnJ1cHRpb24gPSB0aGlzLmFuYWx5emVJbXBvcnRFeHBvcnRDb3JydXB0aW9uKGZpbGVQYXRoLCBjb250ZW50KTtcblxuICAgICAgICBpZiAoaW1wb3J0RXhwb3J0Q29ycnVwdGlvbi5wYXR0ZXJucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgZGV0ZWN0ZWRGaWxlcy5wdXNoKGZpbGVQYXRoKTtcbiAgICAgICAgICBjb3JydXB0aW9uUGF0dGVybnMucHVzaCguLi5pbXBvcnRFeHBvcnRDb3JydXB0aW9uLnBhdHRlcm5zKTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoaW1wb3J0RXhwb3J0Q29ycnVwdGlvbi5zZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5LkNSSVRJQ0FMKSB7XG4gICAgICAgICAgICBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5DUklUSUNBTDtcbiAgICAgICAgICB9IGVsc2UgaWYgKGltcG9ydEV4cG9ydENvcnJ1cHRpb24uc2V2ZXJpdHkgPT09IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIICYmIG1heFNldmVyaXR5ICE9PSBDb3JydXB0aW9uU2V2ZXJpdHkuQ1JJVElDQUwpIHtcbiAgICAgICAgICAgIG1heFNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5LkhJR0g7XG4gICAgICAgICAgfSBlbHNlIGlmIChpbXBvcnRFeHBvcnRDb3JydXB0aW9uLnNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuTUVESVVNICYmIG1heFNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuTE9XKSB7XG4gICAgICAgICAgICBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5NRURJVU07XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBFcnJvciBhbmFseXppbmcgaW1wb3J0L2V4cG9ydCBjb3JydXB0aW9uIGluICR7ZmlsZVBhdGh9OiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgcmVjb21tZW5kZWRBY3Rpb24gPSB0aGlzLmRldGVybWluZVJlY292ZXJ5QWN0aW9uKG1heFNldmVyaXR5LCBkZXRlY3RlZEZpbGVzLmxlbmd0aCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGV0ZWN0ZWRGaWxlcyxcbiAgICAgIGNvcnJ1cHRpb25QYXR0ZXJucyxcbiAgICAgIHNldmVyaXR5OiBtYXhTZXZlcml0eSxcbiAgICAgIHJlY29tbWVuZGVkQWN0aW9uXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWFsLXRpbWUgbW9uaXRvcmluZyBkdXJpbmcgc2NyaXB0IGV4ZWN1dGlvblxuICAgKi9cbiAgYXN5bmMgc3RhcnRSZWFsVGltZU1vbml0b3JpbmcoZmlsZXM6IHN0cmluZ1tdLCBpbnRlcnZhbE1zOiBudW1iZXIgPSA1MDAwKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc29sZS5sb2coYPCflIQgU3RhcnRpbmcgcmVhbC10aW1lIGNvcnJ1cHRpb24gbW9uaXRvcmluZyBmb3IgJHtmaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7XG4gICAgXG4gICAgY29uc3QgbW9uaXRvcmluZ0ludGVydmFsID0gc2V0SW50ZXJ2YWwoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVwb3J0ID0gYXdhaXQgdGhpcy5kZXRlY3RDb3JydXB0aW9uKGZpbGVzKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXBvcnQuZGV0ZWN0ZWRGaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGDimqDvuI8gUmVhbC10aW1lIG1vbml0b3JpbmcgZGV0ZWN0ZWQgY29ycnVwdGlvbiBpbiAke3JlcG9ydC5kZXRlY3RlZEZpbGVzLmxlbmd0aH0gZmlsZXNgKTtcbiAgICAgICAgICBcbiAgICAgICAgICB0aGlzLmFkZFNhZmV0eUV2ZW50KHtcbiAgICAgICAgICAgIHR5cGU6IFNhZmV0eUV2ZW50VHlwZS5DT1JSVVBUSU9OX0RFVEVDVEVELFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBSZWFsLXRpbWUgbW9uaXRvcmluZyBkZXRlY3RlZCBjb3JydXB0aW9uOiAke3JlcG9ydC5zZXZlcml0eX1gLFxuICAgICAgICAgICAgc2V2ZXJpdHk6IHRoaXMubWFwQ29ycnVwdGlvblRvRXZlbnRTZXZlcml0eShyZXBvcnQuc2V2ZXJpdHkpLFxuICAgICAgICAgICAgYWN0aW9uOiAnUkVBTFRJTUVfQ09SUlVQVElPTl9ERVRFQ1RFRCdcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIC8vIElmIGNyaXRpY2FsIGNvcnJ1cHRpb24gaXMgZGV0ZWN0ZWQsIHRyaWdnZXIgZW1lcmdlbmN5IHJvbGxiYWNrXG4gICAgICAgICAgaWYgKHJlcG9ydC5zZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5LkNSSVRJQ0FMICYmIHRoaXMuc2V0dGluZ3MuYXV0b21hdGljUm9sbGJhY2tFbmFibGVkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGDwn5qoIENyaXRpY2FsIGNvcnJ1cHRpb24gZGV0ZWN0ZWQhIFRyaWdnZXJpbmcgZW1lcmdlbmN5IHJvbGxiYWNrLi4uYCk7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKG1vbml0b3JpbmdJbnRlcnZhbCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVtZXJnZW5jeVJvbGxiYWNrKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJyb3IgZHVyaW5nIHJlYWwtdGltZSBtb25pdG9yaW5nOiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgICB9XG4gICAgfSwgaW50ZXJ2YWxNcyk7XG5cbiAgICAvLyBTdG9yZSB0aGUgaW50ZXJ2YWwgSUQgZm9yIGNsZWFudXBcbiAgICAodGhpcyBhcyBhbnkpLm1vbml0b3JpbmdJbnRlcnZhbCA9IG1vbml0b3JpbmdJbnRlcnZhbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIHJlYWwtdGltZSBtb25pdG9yaW5nXG4gICAqL1xuICBzdG9wUmVhbFRpbWVNb25pdG9yaW5nKCk6IHZvaWQge1xuICAgIGlmICgodGhpcyBhcyBhbnkpLm1vbml0b3JpbmdJbnRlcnZhbCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCgodGhpcyBhcyBhbnkpLm1vbml0b3JpbmdJbnRlcnZhbCk7XG4gICAgICAodGhpcyBhcyBhbnkpLm1vbml0b3JpbmdJbnRlcnZhbCA9IG51bGw7XG4gICAgICBjb25zb2xlLmxvZyhg4o+577iPIFJlYWwtdGltZSBjb3JydXB0aW9uIG1vbml0b3Jpbmcgc3RvcHBlZGApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBzeW50YXggdXNpbmcgVHlwZVNjcmlwdCBjb21waWxlclxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVTeW50YXhXaXRoVHlwZVNjcmlwdChmaWxlczogc3RyaW5nW10pOiBQcm9taXNlPENvcnJ1cHRpb25SZXBvcnQ+IHtcbiAgICBjb25zdCBkZXRlY3RlZEZpbGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGNvcnJ1cHRpb25QYXR0ZXJuczogQ29ycnVwdGlvblBhdHRlcm5bXSA9IFtdO1xuICAgIGxldCBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5MT1c7XG5cbiAgICBjb25zb2xlLmxvZyhg8J+UjSBWYWxpZGF0aW5nIHN5bnRheCB3aXRoIFR5cGVTY3JpcHQgY29tcGlsZXIgZm9yICR7ZmlsZXMubGVuZ3RofSBmaWxlcy4uLmApO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFJ1biBUeXBlU2NyaXB0IGNvbXBpbGVyIHRvIGNoZWNrIGZvciBzeW50YXggZXJyb3JzXG4gICAgICBjb25zdCB0c0ZpbGVzID0gZmlsZXMuZmlsdGVyKGYgPT4gZi5tYXRjaCgvXFwuKHRzfHRzeCkkLykpO1xuICAgICAgaWYgKHRzRmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiB7IGRldGVjdGVkRmlsZXMsIGNvcnJ1cHRpb25QYXR0ZXJucywgc2V2ZXJpdHk6IG1heFNldmVyaXR5LCByZWNvbW1lbmRlZEFjdGlvbjogUmVjb3ZlcnlBY3Rpb24uQ09OVElOVUUgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdHNjT3V0cHV0ID0gZXhlY1N5bmMoJ3lhcm4gdHNjIC0tbm9FbWl0IC0tc2tpcExpYkNoZWNrIDI+JjEnLCB7IFxuICAgICAgICBlbmNvZGluZzogJ3V0ZjgnLFxuICAgICAgICBzdGRpbzogJ3BpcGUnXG4gICAgICB9KTtcblxuICAgICAgLy8gUGFyc2UgVHlwZVNjcmlwdCBjb21waWxlciBvdXRwdXQgZm9yIHN5bnRheCBlcnJvcnNcbiAgICAgIGNvbnN0IGxpbmVzID0gdHNjT3V0cHV0LnNwbGl0KCdcXG4nKTtcbiAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgICBpZiAobGluZS5pbmNsdWRlcygnZXJyb3IgVFMnKSAmJiAobGluZS5pbmNsdWRlcygnVW5leHBlY3RlZCB0b2tlbicpIHx8IGxpbmUuaW5jbHVkZXMoJ0V4cHJlc3Npb24gZXhwZWN0ZWQnKSkpIHtcbiAgICAgICAgICBjb25zdCBmaWxlTWF0Y2ggPSBsaW5lLm1hdGNoKC9eKFteKF0rKVxcKC8pO1xuICAgICAgICAgIGlmIChmaWxlTWF0Y2gpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gZmlsZU1hdGNoWzFdO1xuICAgICAgICAgICAgaWYgKGZpbGVzLmluY2x1ZGVzKGZpbGVQYXRoKSAmJiAhZGV0ZWN0ZWRGaWxlcy5pbmNsdWRlcyhmaWxlUGF0aCkpIHtcbiAgICAgICAgICAgICAgZGV0ZWN0ZWRGaWxlcy5wdXNoKGZpbGVQYXRoKTtcbiAgICAgICAgICAgICAgY29ycnVwdGlvblBhdHRlcm5zLnB1c2goe1xuICAgICAgICAgICAgICAgIHBhdHRlcm46ICdUWVBFU0NSSVBUX1NZTlRBWF9FUlJPUicsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGxpbmUudHJpbSgpLFxuICAgICAgICAgICAgICAgIGZpbGVzOiBbZmlsZVBhdGhdXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIFR5cGVTY3JpcHQgY29tcGlsZXIgZXJyb3JzIG1pZ2h0IGluZGljYXRlIHN5bnRheCBjb3JydXB0aW9uXG4gICAgICBjb25zdCBlcnJvck91dHB1dCA9IChlcnJvciBhcyBhbnkpLnN0ZG91dCB8fCAoZXJyb3IgYXMgYW55KS5tZXNzYWdlO1xuICAgICAgaWYgKGVycm9yT3V0cHV0LmluY2x1ZGVzKCdVbmV4cGVjdGVkIHRva2VuJykgfHwgZXJyb3JPdXRwdXQuaW5jbHVkZXMoJ0V4cHJlc3Npb24gZXhwZWN0ZWQnKSkge1xuICAgICAgICBtYXhTZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIO1xuICAgICAgICBjb3JydXB0aW9uUGF0dGVybnMucHVzaCh7XG4gICAgICAgICAgcGF0dGVybjogJ1RZUEVTQ1JJUFRfQ09NUElMQVRJT05fRVJST1InLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgVHlwZVNjcmlwdCBjb21waWxhdGlvbiBmYWlsZWQ6ICR7ZXJyb3JPdXRwdXR9YCxcbiAgICAgICAgICBmaWxlczogZmlsZXMuZmlsdGVyKGYgPT4gZi5tYXRjaCgvXFwuKHRzfHRzeCkkLykpXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJlY29tbWVuZGVkQWN0aW9uID0gdGhpcy5kZXRlcm1pbmVSZWNvdmVyeUFjdGlvbihtYXhTZXZlcml0eSwgZGV0ZWN0ZWRGaWxlcy5sZW5ndGgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRldGVjdGVkRmlsZXMsXG4gICAgICBjb3JydXB0aW9uUGF0dGVybnMsXG4gICAgICBzZXZlcml0eTogbWF4U2V2ZXJpdHksXG4gICAgICByZWNvbW1lbmRlZEFjdGlvblxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRW1lcmdlbmN5IHJvbGxiYWNrIHRvIGNsZWFuIHN0YXRlXG4gICAqL1xuICBhc3luYyBlbWVyZ2VuY3lSb2xsYmFjaygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IHRoZSBtb3N0IHJlY2VudCBzdGFzaFxuICAgICAgY29uc3Qgc3Rhc2hlcyA9IEFycmF5LmZyb20odGhpcy5zdGFzaGVzLnZhbHVlcygpKVxuICAgICAgICAuc29ydCgoYSwgYikgPT4gYi50aW1lc3RhbXAuZ2V0VGltZSgpIC0gYS50aW1lc3RhbXAuZ2V0VGltZSgpKTtcblxuICAgICAgaWYgKHN0YXNoZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc3Rhc2hlcyBhdmFpbGFibGUgZm9yIGVtZXJnZW5jeSByb2xsYmFjaycpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBsYXRlc3RTdGFzaCA9IHN0YXNoZXNbMF07XG4gICAgICBhd2FpdCB0aGlzLmFwcGx5U3Rhc2gobGF0ZXN0U3Rhc2guaWQpO1xuXG4gICAgICB0aGlzLmFkZFNhZmV0eUV2ZW50KHtcbiAgICAgICAgdHlwZTogU2FmZXR5RXZlbnRUeXBlLkVNRVJHRU5DWV9SRUNPVkVSWSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICBkZXNjcmlwdGlvbjogYEVtZXJnZW5jeSByb2xsYmFjayBjb21wbGV0ZWQgdXNpbmcgc3Rhc2g6ICR7bGF0ZXN0U3Rhc2guaWR9YCxcbiAgICAgICAgc2V2ZXJpdHk6IFNhZmV0eUV2ZW50U2V2ZXJpdHkuV0FSTklORyxcbiAgICAgICAgYWN0aW9uOiAnRU1FUkdFTkNZX1JPTExCQUNLJ1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5qoIEVtZXJnZW5jeSByb2xsYmFjayBjb21wbGV0ZWQgdXNpbmcgc3Rhc2g6ICR7bGF0ZXN0U3Rhc2guaWR9YCk7XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5hZGRTYWZldHlFdmVudCh7XG4gICAgICAgIHR5cGU6IFNhZmV0eUV2ZW50VHlwZS5FTUVSR0VOQ1lfUkVDT1ZFUlksXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgZGVzY3JpcHRpb246IGBFbWVyZ2VuY3kgcm9sbGJhY2sgZmFpbGVkOiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCxcbiAgICAgICAgc2V2ZXJpdHk6IFNhZmV0eUV2ZW50U2V2ZXJpdHkuQ1JJVElDQUwsXG4gICAgICAgIGFjdGlvbjogJ0VNRVJHRU5DWV9ST0xMQkFDS19GQUlMRUQnXG4gICAgICB9KTtcblxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFbWVyZ2VuY3kgcm9sbGJhY2sgZmFpbGVkOiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGdpdCByZXBvc2l0b3J5IHN0YXRlXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZUdpdFN0YXRlKCk6IFByb21pc2U8VmFsaWRhdGlvblJlc3VsdD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBpZiBnaXQgcmVwbyBleGlzdHNcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYygnLmdpdCcpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3JzOiBbJ05vdCBhIGdpdCByZXBvc2l0b3J5J10sXG4gICAgICAgICAgd2FybmluZ3M6IFtdXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciB1bmNvbW1pdHRlZCBjaGFuZ2VzXG4gICAgICBjb25zdCBzdGF0dXMgPSBleGVjU3luYygnZ2l0IHN0YXR1cyAtLXBvcmNlbGFpbicsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcbiAgICAgIGNvbnN0IGhhc1VuY29tbWl0dGVkQ2hhbmdlcyA9IHN0YXR1cy50cmltKCkubGVuZ3RoID4gMDtcblxuICAgICAgY29uc3Qgd2FybmluZ3M6IHN0cmluZ1tdID0gW107XG4gICAgICBpZiAoaGFzVW5jb21taXR0ZWRDaGFuZ2VzICYmICF0aGlzLnNldHRpbmdzLmF1dG9tYXRpY1JvbGxiYWNrRW5hYmxlZCkge1xuICAgICAgICB3YXJuaW5ncy5wdXNoKCdVbmNvbW1pdHRlZCBjaGFuZ2VzIGRldGVjdGVkIC0gY29uc2lkZXIgY3JlYXRpbmcgYSBzdGFzaCcpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBlcnJvcnM6IFtdLFxuICAgICAgICB3YXJuaW5nc1xuICAgICAgfTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3JzOiBbYEdpdCB2YWxpZGF0aW9uIGZhaWxlZDogJHsoZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3InfWBdLFxuICAgICAgICB3YXJuaW5nczogW11cbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuIHVwIG9sZCBzdGFzaGVzIGJhc2VkIG9uIGNvbmZpZ3VyYWJsZSByZXRlbnRpb24gcG9saWN5XG4gICAqL1xuICBhc3luYyBjbGVhbnVwT2xkU3Rhc2hlcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjdXRvZmZEYXRlID0gbmV3IERhdGUoKTtcbiAgICBjdXRvZmZEYXRlLnNldERhdGUoY3V0b2ZmRGF0ZS5nZXREYXRlKCkgLSB0aGlzLnNldHRpbmdzLnN0YXNoUmV0ZW50aW9uRGF5cyk7XG5cbiAgICBjb25zdCBzdGFzaGVzVG9SZW1vdmU6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IGNsZWFuZWRDb3VudCA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IFtzdGFzaElkLCBzdGFzaF0gb2YgdGhpcy5zdGFzaGVzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKHN0YXNoLnRpbWVzdGFtcCA8IGN1dG9mZkRhdGUpIHtcbiAgICAgICAgc3Rhc2hlc1RvUmVtb3ZlLnB1c2goc3Rhc2hJZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBzdGFzaElkIG9mIHN0YXNoZXNUb1JlbW92ZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qgc3Rhc2ggPSB0aGlzLnN0YXNoZXMuZ2V0KHN0YXNoSWQpO1xuICAgICAgICBpZiAoc3Rhc2g/LnJlZikge1xuICAgICAgICAgIC8vIFRyeSB0byBkcm9wIHRoZSBhY3R1YWwgZ2l0IHN0YXNoIGlmIHdlIGhhdmUgdGhlIHJlZmVyZW5jZVxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBleGVjU3luYyhgZ2l0IHN0YXNoIGRyb3AgJHtzdGFzaC5yZWZ9YCwgeyBcbiAgICAgICAgICAgICAgZW5jb2Rpbmc6ICd1dGY4JywgXG4gICAgICAgICAgICAgIHN0ZGlvOiAncGlwZScgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGNhdGNoIChnaXRFcnJvcikge1xuICAgICAgICAgICAgLy8gU3Rhc2ggbWlnaHQgYWxyZWFkeSBiZSBnb25lLCBqdXN0IGxvZyB3YXJuaW5nXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyBDb3VsZCBub3QgZHJvcCBnaXQgc3Rhc2ggJHtzdGFzaC5yZWZ9OiAkeyhnaXRFcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIGZyb20gb3VyIHRyYWNraW5nXG4gICAgICAgIHRoaXMuc3Rhc2hlcy5kZWxldGUoc3Rhc2hJZCk7XG4gICAgICAgIGNsZWFuZWRDb3VudCsrO1xuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coYPCfp7kgQ2xlYW5lZCB1cCBvbGQgc3Rhc2g6ICR7c3Rhc2hJZH1gKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIEZhaWxlZCB0byBjbGVhbnVwIHN0YXNoICR7c3Rhc2hJZH06ICR7KGVycm9yIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5tZXNzYWdlIHx8ICdVbmtub3duIGVycm9yJ31gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2xlYW5lZENvdW50ID4gMCkge1xuICAgICAgdGhpcy5zYXZlU3Rhc2hUcmFja2luZygpO1xuICAgICAgdGhpcy5hZGRTYWZldHlFdmVudCh7XG4gICAgICAgIHR5cGU6IFNhZmV0eUV2ZW50VHlwZS5DSEVDS1BPSU5UX0NSRUFURUQsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgZGVzY3JpcHRpb246IGBDbGVhbmVkIHVwICR7Y2xlYW5lZENvdW50fSBvbGQgc3Rhc2hlc2AsXG4gICAgICAgIHNldmVyaXR5OiBTYWZldHlFdmVudFNldmVyaXR5LklORk8sXG4gICAgICAgIGFjdGlvbjogJ1NUQVNIX0NMRUFOVVAnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN0YXNoZXMgYnkgcGhhc2UgZm9yIHRhcmdldGVkIG9wZXJhdGlvbnNcbiAgICovXG4gIGFzeW5jIGdldFN0YXNoZXNCeVBoYXNlKHBoYXNlOiBzdHJpbmcpOiBQcm9taXNlPEdpdFN0YXNoW10+IHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnN0YXNoZXMudmFsdWVzKCkpXG4gICAgICAuZmlsdGVyKHN0YXNoID0+IHN0YXNoLmlkLmluY2x1ZGVzKGAtJHtwaGFzZX0tYCkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi50aW1lc3RhbXAuZ2V0VGltZSgpIC0gYS50aW1lc3RhbXAuZ2V0VGltZSgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc3Rhc2ggc3RhdGlzdGljcyBmb3IgcmVwb3J0aW5nXG4gICAqL1xuICBnZXRTdGFzaFN0YXRpc3RpY3MoKToge1xuICAgIHRvdGFsOiBudW1iZXI7XG4gICAgYnlQaGFzZTogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBvbGRlc3RTdGFzaD86IERhdGU7XG4gICAgbmV3ZXN0U3Rhc2g/OiBEYXRlO1xuICB9IHtcbiAgICBjb25zdCBzdGFzaGVzID0gQXJyYXkuZnJvbSh0aGlzLnN0YXNoZXMudmFsdWVzKCkpO1xuICAgIGNvbnN0IGJ5UGhhc2U6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcblxuICAgIC8vIENvdW50IHN0YXNoZXMgYnkgcGhhc2VcbiAgICBmb3IgKGNvbnN0IHN0YXNoIG9mIHN0YXNoZXMpIHtcbiAgICAgIGNvbnN0IHBoYXNlTWF0Y2ggPSBzdGFzaC5pZC5tYXRjaCgvY2FtcGFpZ24tKFteLV0rKS0vKTtcbiAgICAgIGlmIChwaGFzZU1hdGNoKSB7XG4gICAgICAgIGNvbnN0IHBoYXNlID0gcGhhc2VNYXRjaFsxXTtcbiAgICAgICAgYnlQaGFzZVtwaGFzZV0gPSAoYnlQaGFzZVtwaGFzZV0gfHwgMCkgKyAxO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHRpbWVzdGFtcHMgPSBzdGFzaGVzLm1hcChzID0+IHMudGltZXN0YW1wKTtcbiAgICBjb25zdCBvbGRlc3RTdGFzaCA9IHRpbWVzdGFtcHMubGVuZ3RoID4gMCA/IG5ldyBEYXRlKE1hdGgubWluKC4uLnRpbWVzdGFtcHMubWFwKHQgPT4gdC5nZXRUaW1lKCkpKSkgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgbmV3ZXN0U3Rhc2ggPSB0aW1lc3RhbXBzLmxlbmd0aCA+IDAgPyBuZXcgRGF0ZShNYXRoLm1heCguLi50aW1lc3RhbXBzLm1hcCh0ID0+IHQuZ2V0VGltZSgpKSkpIDogdW5kZWZpbmVkO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsOiBzdGFzaGVzLmxlbmd0aCxcbiAgICAgIGJ5UGhhc2UsXG4gICAgICBvbGRlc3RTdGFzaCxcbiAgICAgIG5ld2VzdFN0YXNoXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc2FmZXR5IGV2ZW50cyBmb3IgcmVwb3J0aW5nXG4gICAqL1xuICBnZXRTYWZldHlFdmVudHMoKTogU2FmZXR5RXZlbnRbXSB7XG4gICAgcmV0dXJuIFsuLi50aGlzLnNhZmV0eUV2ZW50c107XG4gIH1cblxuICAvLyBQcml2YXRlIGhlbHBlciBtZXRob2RzXG5cbiAgcHJpdmF0ZSBhbmFseXplRmlsZUNvcnJ1cHRpb24oZmlsZVBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKToge1xuICAgIHBhdHRlcm5zOiBDb3JydXB0aW9uUGF0dGVybltdO1xuICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHk7XG4gIH0ge1xuICAgIGNvbnN0IHBhdHRlcm5zOiBDb3JydXB0aW9uUGF0dGVybltdID0gW107XG4gICAgbGV0IHNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5LkxPVztcblxuICAgIC8vIENoZWNrIGZvciBpbXBvcnQgY29ycnVwdGlvbiBwYXR0ZXJucyAoYmFzZWQgb24gZXhpc3Rpbmcgc2NyaXB0cylcbiAgICBjb25zdCBpbXBvcnRDb3JydXB0aW9uUGF0dGVybnMgPSBbXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvaW1wb3J0IEBcXC90eXBlc1xccytmcm9tICdbXiddKidcXHMqOy9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0NvcnJ1cHRlZCB0eXBlIGltcG9ydCBzdGF0ZW1lbnQnLFxuICAgICAgICBzZXZlcml0eTogQ29ycnVwdGlvblNldmVyaXR5LkhJR0hcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvaW1wb3J0IEBcXC9zZXJ2aWNlc1xccytmcm9tICdbXiddKidcXHMqOy9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0NvcnJ1cHRlZCBzZXJ2aWNlIGltcG9ydCBzdGF0ZW1lbnQnLFxuICAgICAgICBzZXZlcml0eTogQ29ycnVwdGlvblNldmVyaXR5LkhJR0hcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvPDw8PDw8fD4+Pj4+Pnw9PT09PT0vZyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdHaXQgbWVyZ2UgY29uZmxpY3QgbWFya2VycycsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuQ1JJVElDQUxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvXFxicG9zaXQ6XFxzKmFueWk6XFxzKmFueW86XFxzKmFueW46XFxzKmFueXM6L2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnQ29ycnVwdGVkIHBhcmFtZXRlciBuYW1lcycsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuTUVESVVNXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICByZWdleDogL1xcYmNhdGU6XFxzKmFueWc6XFxzKmFueW86XFxzKmFueXI6XFxzKmFueXk6L2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnQ29ycnVwdGVkIHBhcmFtZXRlciBuYW1lcycsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuTUVESVVNXG4gICAgICB9XG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgY29ycnVwdGlvblBhdHRlcm4gb2YgaW1wb3J0Q29ycnVwdGlvblBhdHRlcm5zKSB7XG4gICAgICBjb25zdCBtYXRjaGVzID0gY29udGVudC5tYXRjaChjb3JydXB0aW9uUGF0dGVybi5yZWdleCk7XG4gICAgICBpZiAobWF0Y2hlcykge1xuICAgICAgICBwYXR0ZXJucy5wdXNoKHtcbiAgICAgICAgICBwYXR0ZXJuOiBjb3JydXB0aW9uUGF0dGVybi5yZWdleC5zb3VyY2UsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGNvcnJ1cHRpb25QYXR0ZXJuLmRlc2NyaXB0aW9uLFxuICAgICAgICAgIGZpbGVzOiBbZmlsZVBhdGhdXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFVwZGF0ZSBzZXZlcml0eSB0byB0aGUgaGlnaGVzdCBmb3VuZFxuICAgICAgICBpZiAoY29ycnVwdGlvblBhdHRlcm4uc2V2ZXJpdHkgPT09IENvcnJ1cHRpb25TZXZlcml0eS5DUklUSUNBTCkge1xuICAgICAgICAgIHNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5LkNSSVRJQ0FMO1xuICAgICAgICB9IGVsc2UgaWYgKGNvcnJ1cHRpb25QYXR0ZXJuLnNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSCAmJiBzZXZlcml0eSAhPT0gQ29ycnVwdGlvblNldmVyaXR5LkNSSVRJQ0FMKSB7XG4gICAgICAgICAgc2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSDtcbiAgICAgICAgfSBlbHNlIGlmIChjb3JydXB0aW9uUGF0dGVybi5zZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5Lk1FRElVTSAmJiBzZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5LkxPVykge1xuICAgICAgICAgIHNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5Lk1FRElVTTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBzeW50YXggY29ycnVwdGlvblxuICAgIGlmICh0aGlzLmhhc1N5bnRheENvcnJ1cHRpb24oY29udGVudCkpIHtcbiAgICAgIHBhdHRlcm5zLnB1c2goe1xuICAgICAgICBwYXR0ZXJuOiAnU1lOVEFYX0NPUlJVUFRJT04nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1N5bnRheCBjb3JydXB0aW9uIGRldGVjdGVkJyxcbiAgICAgICAgZmlsZXM6IFtmaWxlUGF0aF1cbiAgICAgIH0pO1xuICAgICAgc2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSDtcbiAgICB9XG5cbiAgICByZXR1cm4geyBwYXR0ZXJucywgc2V2ZXJpdHkgfTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzU3ludGF4Q29ycnVwdGlvbihjb250ZW50OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBDaGVjayBmb3IgdW5iYWxhbmNlZCBicmFja2V0cyAobW9yZSBsZW5pZW50IHRocmVzaG9sZClcbiAgICBjb25zdCBvcGVuQnJhY2tldHMgPSAoY29udGVudC5tYXRjaCgvXFx7L2cpIHx8IFtdKS5sZW5ndGg7XG4gICAgY29uc3QgY2xvc2VCcmFja2V0cyA9IChjb250ZW50Lm1hdGNoKC9cXH0vZykgfHwgW10pLmxlbmd0aDtcbiAgICBjb25zdCBvcGVuUGFyZW5zID0gKGNvbnRlbnQubWF0Y2goL1xcKC9nKSB8fCBbXSkubGVuZ3RoO1xuICAgIGNvbnN0IGNsb3NlUGFyZW5zID0gKGNvbnRlbnQubWF0Y2goL1xcKS9nKSB8fCBbXSkubGVuZ3RoO1xuXG4gICAgaWYgKE1hdGguYWJzKG9wZW5CcmFja2V0cyAtIGNsb3NlQnJhY2tldHMpID4gMSB8fCBNYXRoLmFicyhvcGVuUGFyZW5zIC0gY2xvc2VQYXJlbnMpID4gMSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGluY29tcGxldGUgc3RhdGVtZW50c1xuICAgIGNvbnN0IGluY29tcGxldGVQYXR0ZXJucyA9IFtcbiAgICAgIC9leHBvcnRcXHMqJC9tLFxuICAgICAgL2ltcG9ydFxccyokL20sXG4gICAgICAvZnVuY3Rpb25cXHMqJC9tLFxuICAgICAgL2NvbnN0XFxzKiQvbSxcbiAgICAgIC9sZXRcXHMqJC9tLFxuICAgICAgL3ZhclxccyokL21cbiAgICBdO1xuXG4gICAgcmV0dXJuIGluY29tcGxldGVQYXR0ZXJucy5zb21lKHBhdHRlcm4gPT4gcGF0dGVybi50ZXN0KGNvbnRlbnQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbmFseXplIGltcG9ydC9leHBvcnQgY29ycnVwdGlvbiBwYXR0ZXJucyBiYXNlZCBvbiBleGlzdGluZyBzY3JpcHQga25vd2xlZGdlXG4gICAqL1xuICBwcml2YXRlIGFuYWx5emVJbXBvcnRFeHBvcnRDb3JydXB0aW9uKGZpbGVQYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IHtcbiAgICBwYXR0ZXJuczogQ29ycnVwdGlvblBhdHRlcm5bXTtcbiAgICBzZXZlcml0eTogQ29ycnVwdGlvblNldmVyaXR5O1xuICB9IHtcbiAgICBjb25zdCBwYXR0ZXJuczogQ29ycnVwdGlvblBhdHRlcm5bXSA9IFtdO1xuICAgIGxldCBzZXZlcml0eSA9IENvcnJ1cHRpb25TZXZlcml0eS5MT1c7XG5cbiAgICAvLyBJbXBvcnQvRXhwb3J0IGNvcnJ1cHRpb24gcGF0dGVybnMgYmFzZWQgb24gZXhpc3Rpbmcgc2NyaXB0IGtub3dsZWRnZVxuICAgIGNvbnN0IGltcG9ydEV4cG9ydENvcnJ1cHRpb25QYXR0ZXJucyA9IFtcbiAgICAgIHtcbiAgICAgICAgcmVnZXg6IC9pbXBvcnRcXHMrXFx7XFxzKlxcfVxccytmcm9tXFxzK1snXCJdW14nXCJdKlsnXCJdOz8vZyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdFbXB0eSBpbXBvcnQgc3RhdGVtZW50JyxcbiAgICAgICAgc2V2ZXJpdHk6IENvcnJ1cHRpb25TZXZlcml0eS5NRURJVU1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvaW1wb3J0XFxzK1tee10qXFxzK2Zyb21cXHMrWydcIl11bmRlZmluZWRbJ1wiXTs/L2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnSW1wb3J0IGZyb20gdW5kZWZpbmVkIG1vZHVsZScsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcmVnZXg6IC9pbXBvcnRcXHMrW157XSpcXHMrZnJvbVxccytbJ1wiXVsnXCJdXFxzKjs/L2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnSW1wb3J0IGZyb20gZW1wdHkgc3RyaW5nJyxcbiAgICAgICAgc2V2ZXJpdHk6IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICByZWdleDogL2V4cG9ydFxccytcXHtcXHMqXFx9XFxzKjs/L2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRW1wdHkgZXhwb3J0IHN0YXRlbWVudCcsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuTUVESVVNXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICByZWdleDogL2ltcG9ydFxccytbXntdKlxccytmcm9tXFxzK1snXCJdW14nXCJdKlsnXCJdXFxzK2Zyb21cXHMrWydcIl1bXidcIl0qWydcIl07Py9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSBmcm9tIGNsYXVzZSBpbiBpbXBvcnQnLFxuICAgICAgICBzZXZlcml0eTogQ29ycnVwdGlvblNldmVyaXR5LkhJR0hcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvaW1wb3J0XFxzKlxce1xccypbXn1dKixcXHMqLFxccypbXn1dKlxcfVxccypmcm9tL2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRG91YmxlIGNvbW1hIGluIGltcG9ydCBkZXN0cnVjdHVyaW5nJyxcbiAgICAgICAgc2V2ZXJpdHk6IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICByZWdleDogL2ltcG9ydFxccypcXHtcXHMqW159XSpcXHMrYXNcXHMrYXNcXHMrW159XSpcXH1cXHMqZnJvbS9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSBcImFzXCIga2V5d29yZCBpbiBpbXBvcnQnLFxuICAgICAgICBzZXZlcml0eTogQ29ycnVwdGlvblNldmVyaXR5LkhJR0hcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvZXhwb3J0XFxzKlxce1xccypbXn1dKixcXHMqLFxccypbXn1dKlxcfS9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0RvdWJsZSBjb21tYSBpbiBleHBvcnQgZGVzdHJ1Y3R1cmluZycsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcmVnZXg6IC9pbXBvcnRcXHMrW157XSpcXHMrZnJvbVxccytbJ1wiXUBcXC9bXidcIl0qXFxzK0BcXC9bXidcIl0qWydcIl07Py9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0NvcnJ1cHRlZCBwYXRoIGFsaWFzIGluIGltcG9ydCcsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcmVnZXg6IC9pbXBvcnRcXHMrW157XSpcXHMrZnJvbVxccytbJ1wiXVteJ1wiXSpcXC5cXC5bXidcIl0qXFwuXFwuW14nXCJdKlsnXCJdOz8vZyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdDb3JydXB0ZWQgcmVsYXRpdmUgcGF0aCB3aXRoIG11bHRpcGxlIC4uJyxcbiAgICAgICAgc2V2ZXJpdHk6IENvcnJ1cHRpb25TZXZlcml0eS5NRURJVU1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvaW1wb3J0XFxzKlxce1xccypbXn1dKlxccypcXH1cXHMqXFx7XFxzKltefV0qXFxzKlxcfVxccypmcm9tL2csXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGRlc3RydWN0dXJpbmcgYnJhY2VzIGluIGltcG9ydCcsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuQ1JJVElDQUxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHJlZ2V4OiAvZXhwb3J0XFxzK2RlZmF1bHRcXHMrZGVmYXVsdFxccysvZyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdEdXBsaWNhdGUgZGVmYXVsdCBrZXl3b3JkIGluIGV4cG9ydCcsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcmVnZXg6IC9pbXBvcnRcXHMrdHlwZVxccyt0eXBlXFxzKy9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSB0eXBlIGtleXdvcmQgaW4gaW1wb3J0JyxcbiAgICAgICAgc2V2ZXJpdHk6IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICByZWdleDogL2ltcG9ydFxccypcXCpcXHMrYXNcXHMrXFwqXFxzK2FzXFxzKy9nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0NvcnJ1cHRlZCBuYW1lc3BhY2UgaW1wb3J0IHN5bnRheCcsXG4gICAgICAgIHNldmVyaXR5OiBDb3JydXB0aW9uU2V2ZXJpdHkuQ1JJVElDQUxcbiAgICAgIH1cbiAgICBdO1xuXG4gICAgZm9yIChjb25zdCBjb3JydXB0aW9uUGF0dGVybiBvZiBpbXBvcnRFeHBvcnRDb3JydXB0aW9uUGF0dGVybnMpIHtcbiAgICAgIGNvbnN0IG1hdGNoZXMgPSBjb250ZW50Lm1hdGNoKGNvcnJ1cHRpb25QYXR0ZXJuLnJlZ2V4KTtcbiAgICAgIGlmIChtYXRjaGVzKSB7XG4gICAgICAgIHBhdHRlcm5zLnB1c2goe1xuICAgICAgICAgIHBhdHRlcm46IGNvcnJ1cHRpb25QYXR0ZXJuLnJlZ2V4LnNvdXJjZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYCR7Y29ycnVwdGlvblBhdHRlcm4uZGVzY3JpcHRpb259ICgke21hdGNoZXMubGVuZ3RofSBvY2N1cnJlbmNlcylgLFxuICAgICAgICAgIGZpbGVzOiBbZmlsZVBhdGhdXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFVwZGF0ZSBzZXZlcml0eSB0byB0aGUgaGlnaGVzdCBmb3VuZFxuICAgICAgICBpZiAoY29ycnVwdGlvblBhdHRlcm4uc2V2ZXJpdHkgPT09IENvcnJ1cHRpb25TZXZlcml0eS5DUklUSUNBTCkge1xuICAgICAgICAgIHNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5LkNSSVRJQ0FMO1xuICAgICAgICB9IGVsc2UgaWYgKGNvcnJ1cHRpb25QYXR0ZXJuLnNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSCAmJiBzZXZlcml0eSAhPT0gQ29ycnVwdGlvblNldmVyaXR5LkNSSVRJQ0FMKSB7XG4gICAgICAgICAgc2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSDtcbiAgICAgICAgfSBlbHNlIGlmIChjb3JydXB0aW9uUGF0dGVybi5zZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5Lk1FRElVTSAmJiBzZXZlcml0eSA9PT0gQ29ycnVwdGlvblNldmVyaXR5LkxPVykge1xuICAgICAgICAgIHNldmVyaXR5ID0gQ29ycnVwdGlvblNldmVyaXR5Lk1FRElVTTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBtYWxmb3JtZWQgaW1wb3J0L2V4cG9ydCBzdGF0ZW1lbnRzXG4gICAgY29uc3QgbWFsZm9ybWVkUGF0dGVybnMgPSBbXG4gICAgICAvaW1wb3J0XFxzK1tee10qXFxzK2Zyb20oPyFcXHMrWydcIl0pL2csIC8vIGltcG9ydCB3aXRob3V0IHByb3BlciBmcm9tIGNsYXVzZVxuICAgICAgL2V4cG9ydFxccytbXntdKlxccytmcm9tKD8hXFxzK1snXCJdKS9nLCAvLyBleHBvcnQgd2l0aG91dCBwcm9wZXIgZnJvbSBjbGF1c2VcbiAgICAgIC9pbXBvcnRcXHMqXFx7W159XSpcXHMrZnJvbVxccytbXidcIl0vZywgIC8vIGltcG9ydCB3aXRoIG1pc3NpbmcgcXVvdGVzXG4gICAgICAvZXhwb3J0XFxzKlxce1tefV0qXFxzK2Zyb21cXHMrW14nXCJdL2cgICAvLyBleHBvcnQgd2l0aCBtaXNzaW5nIHF1b3Rlc1xuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgbWFsZm9ybWVkUGF0dGVybnMpIHtcbiAgICAgIGNvbnN0IG1hdGNoZXMgPSBjb250ZW50Lm1hdGNoKHBhdHRlcm4pO1xuICAgICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgICAgcGF0dGVybnMucHVzaCh7XG4gICAgICAgICAgcGF0dGVybjogcGF0dGVybi5zb3VyY2UsXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdNYWxmb3JtZWQgaW1wb3J0L2V4cG9ydCBzdGF0ZW1lbnQgc3ludGF4JyxcbiAgICAgICAgICBmaWxlczogW2ZpbGVQYXRoXVxuICAgICAgICB9KTtcbiAgICAgICAgc2V2ZXJpdHkgPSBDb3JydXB0aW9uU2V2ZXJpdHkuSElHSDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBwYXR0ZXJucywgc2V2ZXJpdHkgfTtcbiAgfVxuXG4gIHByaXZhdGUgZGV0ZXJtaW5lUmVjb3ZlcnlBY3Rpb24oc2V2ZXJpdHk6IENvcnJ1cHRpb25TZXZlcml0eSwgZmlsZUNvdW50OiBudW1iZXIpOiBSZWNvdmVyeUFjdGlvbiB7XG4gICAgaWYgKHNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuQ1JJVElDQUwpIHtcbiAgICAgIHJldHVybiBSZWNvdmVyeUFjdGlvbi5FTUVSR0VOQ1lfUkVTVE9SRTtcbiAgICB9XG5cbiAgICBpZiAoc2V2ZXJpdHkgPT09IENvcnJ1cHRpb25TZXZlcml0eS5ISUdIIHx8IGZpbGVDb3VudCA+IDEwKSB7XG4gICAgICByZXR1cm4gUmVjb3ZlcnlBY3Rpb24uUk9MTEJBQ0s7XG4gICAgfVxuXG4gICAgaWYgKHNldmVyaXR5ID09PSBDb3JydXB0aW9uU2V2ZXJpdHkuTUVESVVNIHx8IGZpbGVDb3VudCA+IDUpIHtcbiAgICAgIHJldHVybiBSZWNvdmVyeUFjdGlvbi5SRVRSWTtcbiAgICB9XG5cbiAgICByZXR1cm4gUmVjb3ZlcnlBY3Rpb24uQ09OVElOVUU7XG4gIH1cblxuICBwcml2YXRlIG1hcENvcnJ1cHRpb25Ub0V2ZW50U2V2ZXJpdHkoY29ycnVwdGlvbjogQ29ycnVwdGlvblNldmVyaXR5KTogU2FmZXR5RXZlbnRTZXZlcml0eSB7XG4gICAgc3dpdGNoIChjb3JydXB0aW9uKSB7XG4gICAgICBjYXNlIENvcnJ1cHRpb25TZXZlcml0eS5DUklUSUNBTDpcbiAgICAgICAgcmV0dXJuIFNhZmV0eUV2ZW50U2V2ZXJpdHkuQ1JJVElDQUw7XG4gICAgICBjYXNlIENvcnJ1cHRpb25TZXZlcml0eS5ISUdIOlxuICAgICAgICByZXR1cm4gU2FmZXR5RXZlbnRTZXZlcml0eS5FUlJPUjtcbiAgICAgIGNhc2UgQ29ycnVwdGlvblNldmVyaXR5Lk1FRElVTTpcbiAgICAgICAgcmV0dXJuIFNhZmV0eUV2ZW50U2V2ZXJpdHkuV0FSTklORztcbiAgICAgIGNhc2UgQ29ycnVwdGlvblNldmVyaXR5LkxPVzpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBTYWZldHlFdmVudFNldmVyaXR5LklORk87XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50QnJhbmNoKCk6IHN0cmluZyB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBleGVjU3luYygnZ2l0IGJyYW5jaCAtLXNob3ctY3VycmVudCcsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KS50cmltKCk7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gJ3Vua25vd24nO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkU2FmZXR5RXZlbnQoZXZlbnQ6IFNhZmV0eUV2ZW50KTogdm9pZCB7XG4gICAgdGhpcy5zYWZldHlFdmVudHMucHVzaChldmVudCk7XG4gICAgXG4gICAgLy8gS2VlcCBvbmx5IHJlY2VudCBldmVudHMgdG8gcHJldmVudCBtZW1vcnkgaXNzdWVzXG4gICAgaWYgKHRoaXMuc2FmZXR5RXZlbnRzLmxlbmd0aCA+IDEwMDApIHtcbiAgICAgIHRoaXMuc2FmZXR5RXZlbnRzID0gdGhpcy5zYWZldHlFdmVudHMuc2xpY2UoLTUwMCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgc3Rhc2ggdHJhY2tpbmcgZnJvbSBwZXJzaXN0ZW50IHN0b3JhZ2VcbiAgICovXG4gIHByaXZhdGUgaW5pdGlhbGl6ZVN0YXNoVHJhY2tpbmcoKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXNoVHJhY2tpbmdQYXRoID0gcGF0aC5qb2luKCcua2lybycsICdjYW1wYWlnbi1zdGFzaGVzLmpzb24nKTtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKHN0YXNoVHJhY2tpbmdQYXRoKSkge1xuICAgICAgICBjb25zdCBkYXRhID0gZnMucmVhZEZpbGVTeW5jKHN0YXNoVHJhY2tpbmdQYXRoLCAndXRmOCcpO1xuICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICBcbiAgICAgICAgLy8gUmVzdG9yZSBzdGFzaGVzIHdpdGggcHJvcGVyIERhdGUgb2JqZWN0c1xuICAgICAgICBmb3IgKGNvbnN0IFtpZCwgc3Rhc2hEYXRhXSBvZiBPYmplY3QuZW50cmllcyhwYXJzZWQuc3Rhc2hlcyB8fCB7fSkpIHtcbiAgICAgICAgICBjb25zdCBzdGFzaCA9IHN0YXNoRGF0YSBhcyBhbnk7XG4gICAgICAgICAgdGhpcy5zdGFzaGVzLnNldChpZCwge1xuICAgICAgICAgICAgLi4uc3Rhc2gsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKHN0YXNoLnRpbWVzdGFtcClcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGhpcy5zdGFzaENvdW50ZXIgPSBwYXJzZWQuY291bnRlciB8fCAwO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyBDb3VsZCBub3QgbG9hZCBzdGFzaCB0cmFja2luZzogJHsoZXJyb3IgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3InfWApO1xuICAgICAgdGhpcy5zdGFzaENvdW50ZXIgPSAwO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlIHN0YXNoIHRyYWNraW5nIHRvIHBlcnNpc3RlbnQgc3RvcmFnZVxuICAgKi9cbiAgcHJpdmF0ZSBzYXZlU3Rhc2hUcmFja2luZygpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3Rhc2hUcmFja2luZ1BhdGggPSBwYXRoLmpvaW4oJy5raXJvJywgJ2NhbXBhaWduLXN0YXNoZXMuanNvbicpO1xuICAgICAgXG4gICAgICAvLyBFbnN1cmUgLmtpcm8gZGlyZWN0b3J5IGV4aXN0c1xuICAgICAgY29uc3Qga2lyb0RpciA9IHBhdGguZGlybmFtZShzdGFzaFRyYWNraW5nUGF0aCk7XG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoa2lyb0RpcikpIHtcbiAgICAgICAgZnMubWtkaXJTeW5jKGtpcm9EaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICBjb3VudGVyOiB0aGlzLnN0YXNoQ291bnRlcixcbiAgICAgICAgc3Rhc2hlczogT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuc3Rhc2hlcy5lbnRyaWVzKCkpLFxuICAgICAgICBsYXN0VXBkYXRlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9O1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKHN0YXNoVHJhY2tpbmdQYXRoLCBKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCAyKSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIENvdWxkIG5vdCBzYXZlIHN0YXNoIHRyYWNraW5nOiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZpbmQgc3Rhc2ggYnkgbWVzc2FnZSB3aGVuIHJlZmVyZW5jZSBpcyBub3QgYXZhaWxhYmxlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGZpbmRTdGFzaEJ5TWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGFzaExpc3QgPSBleGVjU3luYygnZ2l0IHN0YXNoIGxpc3QnLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgICBjb25zdCBsaW5lcyA9IHN0YXNoTGlzdC5zcGxpdCgnXFxuJyk7XG4gICAgICBcbiAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgICBpZiAobGluZS5pbmNsdWRlcyhtZXNzYWdlKSkge1xuICAgICAgICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCgvXihzdGFzaEBcXHtcXGQrXFx9KS8pO1xuICAgICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgICAgcmV0dXJuIG1hdGNoWzFdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFN0YXNoIG5vdCBmb3VuZCB3aXRoIG1lc3NhZ2U6ICR7bWVzc2FnZX1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZmluZCBzdGFzaCBieSBtZXNzYWdlOiAkeyhlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XG4gICAgfVxuICB9XG59Il0sInZlcnNpb24iOjN9