56b3dca5a3bea50f4bf959f873a88e00
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ElementalCalculator = void 0;
const elementalUtils_1 = require("../utils/elementalUtils");
const elementalConstants_1 = require("../constants/elementalConstants");
const logger_1 = require("@/utils/logger");
const astrology_1 = require("../data/astrology");
const logger = (0, logger_1.createLogger)('ElementalCalculator');
class ElementalCalculator {
    constructor(debugMode = false) {
        this.currentBalance = elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES;
        this.initialized = false;
        this.debugMode = debugMode;
        if (this.debugMode) {
            console.log("[ElementalCalculator] Instance created with debug mode");
        }
    }
    /**
     * Get the singleton instance
     */
    static getInstance() {
        if (!ElementalCalculator.instance) {
            ElementalCalculator.instance = new ElementalCalculator();
        }
        return ElementalCalculator.instance;
    }
    /**
     * Create a new instance (helper method for when singleton is not needed)
     */
    static createInstance(debugMode = false) {
        return new ElementalCalculator(debugMode);
    }
    static initialize(initialState) {
        const instance = ElementalCalculator.getInstance();
        instance.currentBalance = initialState || {
            ...elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES,
        };
        instance.initialized = true;
        logger.debug('ElementalCalculator initialized with', instance.currentBalance);
    }
    static updateElementalState(newState) {
        const instance = ElementalCalculator.getInstance();
        instance.currentBalance = { ...newState };
        logger.debug('ElementalCalculator state updated', instance.currentBalance);
    }
    static getCurrentElementalState() {
        const instance = ElementalCalculator.getInstance();
        if (!instance.initialized) {
            // Only use direct initialization without the dynamic import of useAlchemical
            // which causes "Invalid hook call" errors in tests
            ElementalCalculator.initialize();
            // In a browser, the AlchemicalContext provider will call updateElementalState
            // so we don't need to worry about initializing with the correct state here
        }
        return instance.currentBalance;
    }
    static calculateMatchScore(item) {
        if (!item.elementalProperties) {
            return 0;
        }
        const currentBalance = ElementalCalculator.getCurrentElementalState();
        // Use the more robust weighted calculation instead of simplified approach
        let matchScore = 0;
        let totalWeight = 0;
        Object.entries(currentBalance).forEach(([element, value]) => {
            const elementKey = element;
            // Use optional chaining with nullish coalescing to handle undefined values
            const itemValue = (item.elementalProperties && item.elementalProperties[elementKey]) || 0;
            // Calculate weighted difference (more important elements get higher weight)
            const weight = value * 2; // Emphasize elements that are strong in current state
            matchScore += (1 - Math.abs(value - itemValue)) * weight;
            totalWeight += weight;
        });
        // Normalize to 0-100 range
        return Math.round(totalWeight > 0 ? (matchScore / totalWeight) * 100 : 50);
    }
    static getSeasonalModifiers(season) {
        // Start with a balanced base
        const baseModifiers = {
            Fire: 0.25,
            Water: 0.25,
            Earth: 0.25,
            Air: 0.25,
        };
        // Normalize season to lowercase for consistency with type definition
        const seasonLower = season.toLowerCase();
        switch (seasonLower) {
            case 'spring':
                baseModifiers.Air = 0.4;
                baseModifiers.Fire = 0.3;
                baseModifiers.Water = 0.2;
                baseModifiers.Earth = 0.1;
                break;
            case 'summer':
                baseModifiers.Fire = 0.4;
                baseModifiers.Air = 0.3;
                baseModifiers.Earth = 0.2;
                baseModifiers.Water = 0.1;
                break;
            case 'autumn':
            case 'fall':
                baseModifiers.Earth = 0.4;
                baseModifiers.Air = 0.3;
                baseModifiers.Water = 0.2;
                baseModifiers.Fire = 0.1;
                break;
            case 'winter':
                baseModifiers.Water = 0.4;
                baseModifiers.Earth = 0.3;
                baseModifiers.Fire = 0.2;
                baseModifiers.Air = 0.1;
                break;
            case 'all':
                // Balanced for 'all' season
                baseModifiers.Fire = 0.25;
                baseModifiers.Water = 0.25;
                baseModifiers.Earth = 0.25;
                baseModifiers.Air = 0.25;
                break;
            default:
                // Balanced for unknown seasons
                baseModifiers.Fire = 0.25;
                baseModifiers.Water = 0.25;
                baseModifiers.Earth = 0.25;
                baseModifiers.Air = 0.25;
        }
        return baseModifiers;
    }
    calculateElementalState(positions) {
        if (this.debugMode) {
            console.log("[ElementalCalculator] Calculating elemental state from: ", positions);
        }
        // Initialize elemental values
        const elementalValues = {
            Fire: 0,
            Water: 0,
            Earth: 0,
            Air: 0,
        };
        // Handle empty or invalid positions
        if (!positions || typeof positions !== 'object') {
            if (this.debugMode) {
                console.log("[ElementalCalculator] No elemental data calculated, returning default values");
            }
            return { ...elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES };
        }
        // Try to extract planet positions directly if they exist
        try {
            if (this.debugMode) {
                console.log("[ElementalCalculator] Trying to extract planets from general structure");
            }
            // Handle different API response formats
            const hasPlanets = 'planets' in positions;
            const hasCelestialBodies = 'CelestialBodies' in positions;
            const hasTropical = 'tropical' in positions;
            // Process planets if available in various formats
            if (hasPlanets) {
                // Direct planets object
                this.processPlanetsObject(positions.planets, elementalValues);
            }
            else if (hasCelestialBodies) {
                // Celestial bodies from API
                const positionsData = positions;
                const celestialBodies = positionsData.CelestialBodies;
                if (celestialBodies) {
                    this.processCelestialBodies(celestialBodies, elementalValues);
                }
            }
            else if (hasTropical) {
                // Nested within tropical
                const positionsData = positions;
                const tropicalData = positionsData.tropical;
                const celestialBodies = tropicalData === null || tropicalData === void 0 ? void 0 : tropicalData.CelestialBodies;
                if (celestialBodies) {
                    this.processCelestialBodies(celestialBodies, elementalValues);
                }
            }
            else {
                // Try to process as generic structure
                this.processPlanetKeys(positions, elementalValues);
            }
            // Normalize values
            const total = Object.values(elementalValues).reduce((sum, val) => sum + val, 0);
            if (total > 0) {
                Object.keys(elementalValues).forEach((element) => {
                    const elementKey = element;
                    elementalValues[elementKey] = elementalValues[elementKey] / total;
                });
            }
            else {
                // Return default values if we couldn't calculate anything
                if (this.debugMode) {
                    console.log("[ElementalCalculator] No elemental data calculated, returning default values");
                }
                return { ...elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES };
            }
            return elementalValues;
        }
        catch (error) {
            console.error("[ElementalCalculator] Error calculating elemental state:", error);
            return { ...elementalConstants_1.DEFAULT_ELEMENTAL_PROPERTIES };
        }
    }
    // Fix method naming conflict - rename the second implementation to avoid duplicate method name
    calculatePlanetaryElementalState(positions) {
        return this.calculateElementalState(positions);
    }
    // Add methods to process different types of planetary position data
    processPlanetsObject(planets, elementalValues) {
        if (!planets)
            return;
        // Handle both array and object formats of planets
        if (Array.isArray(planets)) {
            planets.forEach(planet => {
                if (planet)
                    this.processPlanetData(planet, elementalValues);
            });
        }
        else if (typeof planets === 'object') {
            // Process object format where keys are planet names
            Object.entries(planets).forEach(([name, data]) => {
                if (data) {
                    const dataRecord = data;
                    const planetData = { ...dataRecord, name, label: name };
                    this.processPlanetData(planetData, elementalValues);
                }
            });
        }
    }
    processCelestialBodies(bodies, elementalValues) {
        if (!bodies)
            return;
        // Handle CelestialBodies format from API
        const bodiesData = bodies;
        if (Array.isArray(bodiesData.all)) {
            bodiesData.all.forEach((body) => {
                if (body)
                    this.processPlanetData(body, elementalValues);
            });
        }
        else {
            // Handle individual planet objects
            const planetNames = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter',
                'saturn', 'uranus', 'neptune', 'pluto'];
            planetNames.forEach(planetName => {
                if (bodiesData[planetName]) {
                    const planet = bodiesData[planetName];
                    // Add name and label if not present
                    const planetRecord = planet;
                    const enhancedPlanet = {
                        ...planetRecord,
                        name: planetName,
                        label: planetName
                    };
                    this.processPlanetData(enhancedPlanet, elementalValues);
                }
            });
            // Process ascendant if available
            if (bodiesData.ascendant || bodiesData.Ascendant) {
                const ascendant = bodiesData.ascendant || bodiesData.Ascendant;
                this.processAscendantData(ascendant, elementalValues);
            }
        }
    }
    processPlanetKeys(data, elementalValues) {
        if (!data)
            return;
        // Try to find planets in a generic object structure
        const planetNames = ['Sun', 'Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter',
            'Saturn', 'Uranus', 'Neptune', 'Pluto'];
        // Look for objects that might represent planets
        this.findPlanetsRecursively(data, planetNames, elementalValues);
        // Also look for ascendant
        if (data.Ascendant || data.ascendant) {
            this.processAscendantData(data.Ascendant || data.ascendant, elementalValues);
        }
    }
    findPlanetsRecursively(obj, planetNames, elementalValues, depth = 0) {
        if (!obj || typeof obj !== 'object' || depth > 5)
            return; // Limit recursion depth
        // Check if this object looks like a planet
        if (this.objectLooksPlanetLike(obj, planetNames)) {
            this.processPlanetData(obj, elementalValues);
            return;
        }
        // Search through all properties
        for (const key in obj) {
            if (obj[key] && typeof obj[key] === 'object') {
                // If key name matches a planet, augment with that name
                const isPlanetKey = planetNames.find(p => p.toLowerCase() === key.toLowerCase());
                if (isPlanetKey && obj[key]) {
                    // Add planet name to object if not already present
                    const objKey = obj[key];
                    const planetObj = {
                        ...objKey,
                        name: isPlanetKey,
                        label: isPlanetKey
                    };
                    this.processPlanetData(planetObj, elementalValues);
                }
                else {
                    this.findPlanetsRecursively(obj[key], planetNames, elementalValues, depth + 1);
                }
            }
        }
    }
    objectLooksPlanetLike(obj, planetNames) {
        // Check for typical planet properties
        if (!obj)
            return false;
        const objRecord = obj;
        // Has sign property directly
        if (objRecord.sign || objRecord.Sign)
            return true;
        // Has a name or label that matches a planet name
        if (objRecord.name && planetNames.includes(String(objRecord.name)))
            return true;
        if (objRecord.label && planetNames.includes(String(objRecord.label)))
            return true;
        return false;
    }
    processPlanetData(planet, elementalValues) {
        if (!planet)
            return;
        try {
            // Extract planet info
            const planetRecord = planet;
            const planetName = String(planetRecord.name || planetRecord.label || planetRecord.planet || '');
            const signData = planetRecord.Sign;
            const sign = String((signData === null || signData === void 0 ? void 0 : signData.label) || planetRecord.sign || '');
            if (!planetName || !sign)
                return;
            // Get element from sign
            const signElement = this.getSignElement(sign);
            if (signElement) {
                // Weight by planet importance
                const weight = this.getPlanetWeight(planetName);
                // Add to appropriate element
                switch (signElement) {
                    case 'Fire':
                        elementalValues.Fire += weight;
                        break;
                    case 'Water':
                        elementalValues.Water += weight;
                        break;
                    case 'Earth':
                        elementalValues.Earth += weight;
                        break;
                    case 'Air':
                        elementalValues.Air += weight;
                        break;
                }
            }
        }
        catch (error) {
            console.error("[ElementalCalculator] Error processing planet data:", error);
        }
    }
    processAscendantData(ascendant, elementalValues) {
        var _a;
        try {
            const ascendantData = ascendant;
            const ascendantSign = typeof ascendant === 'string'
                ? ascendant
                : String(((_a = ascendantData === null || ascendantData === void 0 ? void 0 : ascendantData.Sign) === null || _a === void 0 ? void 0 : _a.label) || (ascendantData === null || ascendantData === void 0 ? void 0 : ascendantData.sign) || '');
            if (ascendantSign) {
                const ascendantElement = this.getSignElement(ascendantSign);
                if (ascendantElement) {
                    const weight = 0.75; // Ascendant has significant influence
                    switch (ascendantElement) {
                        case 'Fire':
                            elementalValues.Fire += weight;
                            break;
                        case 'Water':
                            elementalValues.Water += weight;
                            break;
                        case 'Earth':
                            elementalValues.Earth += weight;
                            break;
                        case 'Air':
                            elementalValues.Air += weight;
                            break;
                    }
                }
            }
        }
        catch (error) {
            console.error("[ElementalCalculator] Error processing ascendant data:", error);
        }
    }
    /**
     * Get the elemental association of a zodiac sign
     */
    getSignElement(sign) {
        const lowerSign = sign.toLowerCase();
        // Fire signs
        if (lowerSign.includes('aries') || lowerSign.includes('leo') || lowerSign.includes('sagittarius')) {
            return 'Fire';
        }
        // Water signs
        if (lowerSign.includes('cancer') || lowerSign.includes('scorpio') || lowerSign.includes('pisces')) {
            return 'Water';
        }
        // Earth signs
        if (lowerSign.includes('taurus') || lowerSign.includes('virgo') || lowerSign.includes('capricorn')) {
            return 'Earth';
        }
        // Air signs
        if (lowerSign.includes('gemini') || lowerSign.includes('libra') || lowerSign.includes('aquarius')) {
            return 'Air';
        }
        console.warn(`[ElementalCalculator] Unknown sign: ${sign}`);
        return null;
    }
    /**
     * Get the weight of planetary influence
     */
    getPlanetWeight(planet) {
        const lowerPlanet = planet.toLowerCase();
        // Luminaries have strongest influence
        if (lowerPlanet.includes('sun') || lowerPlanet.includes('moon')) {
            return 1.0;
        }
        // Personal planets have significant influence
        if (lowerPlanet.includes('mercury') ||
            lowerPlanet.includes('venus') ||
            lowerPlanet.includes('mars')) {
            return 0.8;
        }
        // Social planets have moderate influence
        if (lowerPlanet.includes('jupiter') || lowerPlanet.includes('saturn')) {
            return 0.6;
        }
        // Outer planets have subtle influence
        if (lowerPlanet.includes('uranus') ||
            lowerPlanet.includes('neptune') ||
            lowerPlanet.includes('pluto')) {
            return 0.4;
        }
        // Default weight for unknown planets
        return 0.3;
    }
    static validateElementalProperties(properties) {
        if (!properties)
            return false;
        const requiredElements = ['Fire', 'Water', 'Earth', 'Air'];
        const hasAllElements = requiredElements.every((element) => typeof properties[element] === 'number');
        if (!hasAllElements)
            return false;
        const sum = Object.values(properties).reduce((acc, val) => acc + val, 0);
        return Math.abs(sum - 1) < 0.01;
    }
    static calculateIngredientMatch(ingredient) {
        // Apply surgical type casting with variable extraction
        const ingredientData = ingredient;
        const elementalProperties = ingredientData === null || ingredientData === void 0 ? void 0 : ingredientData.elementalProperties;
        // If the ingredient has elementalProperties, use those
        if (elementalProperties) {
            const currentState = this.getCurrentElementalState();
            // Calculate similarity between ingredient's elemental properties and current state
            let matchScore = 0;
            let totalWeight = 0;
            Object.entries(currentState).forEach(([element, value]) => {
                const elementKey = element;
                const ingredientValue = elementalProperties[elementKey] || 0;
                // Calculate weighted difference (more important elements get higher weight)
                const weight = value * 2; // Emphasize elements that are strong in current state
                matchScore += (1 - Math.abs(value - ingredientValue)) * weight;
                totalWeight += weight;
            });
            // Normalize score to 0-100 range
            return totalWeight > 0 ? (matchScore / totalWeight) * 100 : 50;
        }
        // Default score if no elemental properties
        return 50;
    }
    static calculateElementalBalance(elementalProperties) {
        // Use actual current elemental state for comparison
        const currentState = this.getCurrentElementalState();
        // Calculate similarity between ingredient and current state
        let totalSimilarity = 0;
        let count = 0;
        // Use all four elements for calculation
        ['Fire', 'Water', 'Earth', 'Air'].forEach((element) => {
            const elementKey = element;
            const currentValue = currentState[elementKey] || 0;
            const ingredientValue = elementalProperties[elementKey] || 0;
            // Calculate similarity (1 - difference)
            const similarity = 1 - Math.abs(currentValue - ingredientValue);
            totalSimilarity += similarity;
            count++;
        });
        // Return average similarity as percentage
        return count > 0 ? (totalSimilarity / count) * 100 : 50;
    }
    calculateElementalTotals(properties) {
        return {
            totalFire: properties.Fire,
            totalWater: properties.Water,
            totalEarth: properties.Earth,
            totalAir: properties.Air,
            dominantElement: this.getDominantElement(properties),
        };
    }
    static getSeasonFromZodiacSign(sign) {
        // Map zodiac signs to seasons
        const zodiacSeasons = {
            aries: 'spring',
            taurus: 'spring',
            gemini: 'spring',
            cancer: 'summer',
            leo: 'summer',
            virgo: 'summer',
            libra: 'autumn',
            scorpio: 'autumn',
            sagittarius: 'autumn',
            capricorn: 'winter',
            aquarius: 'winter',
            pisces: 'winter',
        };
        return zodiacSeasons[sign] || 'all';
    }
    // Method to get seasonal modifiers based on zodiac sign
    static getZodiacSeasonalModifiers(sign) {
        const season = this.getSeasonFromZodiacSign(sign);
        return this.getSeasonalModifiers(season);
    }
    static getZodiacElementalInfluence(sign) {
        // Base seasonal influence
        const seasonalModifiers = this.getZodiacSeasonalModifiers(sign);
        // Specific zodiac sign adjustments
        const zodiacModifiers = {
            aries: { Fire: 0.2 },
            taurus: { Earth: 0.2 },
            gemini: { Air: 0.2 },
            cancer: { Water: 0.2 },
            leo: { Fire: 0.2 },
            virgo: { Earth: 0.2 },
            libra: { Air: 0.2 },
            scorpio: { Water: 0.2 },
            sagittarius: { Fire: 0.2 },
            capricorn: { Earth: 0.2 },
            aquarius: { Air: 0.2 },
            pisces: { Water: 0.2 }, // Extra Water boost for pisces
        };
        // Apply specific zodiac adjustments
        const specificAdjustments = zodiacModifiers[sign] || {};
        // Combine seasonal modifiers with specific zodiac adjustments
        const result = { ...seasonalModifiers };
        Object.entries(specificAdjustments).forEach(([element, value]) => {
            // Use nullish coalescing to ensure value is never undefined
            result[element] += value || 0;
        });
        // Normalize to ensure values stay in valid range
        return (0, elementalUtils_1.normalizeProperties)(result);
    }
    static combineElementalProperties(properties) {
        const result = {
            Fire: 0,
            Water: 0,
            Earth: 0,
            Air: 0,
        };
        if (properties.length === 0) {
            return {
                Fire: 0.25,
                Water: 0.25,
                Earth: 0.25,
                Air: 0.25,
            };
        }
        // Sum up all properties
        properties.forEach((prop) => {
            Object.entries(prop).forEach(([element, value]) => {
                // Use nullish coalescing to handle undefined values
                const elementKey = element;
                result[elementKey] += value || 0;
            });
        });
        // Normalize to ensure they sum to 1
        const total = Object.values(result).reduce((sum, val) => sum + val, 0);
        if (total > 0) {
            Object.keys(result).forEach((element) => {
                const elementKey = element;
                result[elementKey] = result[elementKey] / total;
            });
        }
        else {
            // Default to equal distribution if total is 0
            Object.keys(result).forEach((element) => {
                const elementKey = element;
                result[elementKey] = 0.25;
            });
        }
        return result;
    }
    getDominantElement(elementalProperties) {
        let maxElement = 'Fire';
        let maxValue = elementalProperties.Fire;
        // Check each element to find the one with the highest value
        Object.entries(elementalProperties).forEach(([element, value]) => {
            const elementKey = element;
            if (value > maxValue) {
                maxValue = value;
                maxElement = elementKey;
            }
        });
        return maxElement;
    }
    // Method to process planet object and extract elemental properties
    processPlanetElementalEffect(planet, sign) {
        var _a;
        if (!planet || !sign) {
            return { Fire: 0, Water: 0, Earth: 0, Air: 0 };
        }
        const elementalEffect = { Fire: 0, Water: 0, Earth: 0, Air: 0 };
        // Process dignity effect
        const planetStr = String(planet);
        const planetInfoData = astrology_1.planetInfo[planetStr];
        const dignityEffectData = planetInfoData === null || planetInfoData === void 0 ? void 0 : planetInfoData["Dignity Effect"];
        if (dignityEffectData === null || dignityEffectData === void 0 ? void 0 : dignityEffectData[sign]) {
            const dignityEffectValue = Number(dignityEffectData[sign]);
            if (dignityEffectValue) {
                if (Math.abs(dignityEffectValue) === 1 || Math.abs(dignityEffectValue) === 3) {
                    const signElement = ((_a = astrology_1.signInfo[sign]) === null || _a === void 0 ? void 0 : _a.Element) || 'Fire';
                    elementalEffect[signElement] = 1 * (dignityEffectValue / Math.abs(dignityEffectValue));
                }
                if (Math.abs(dignityEffectValue) > 1) {
                    const diurnalElement = String(planetInfoData === null || planetInfoData === void 0 ? void 0 : planetInfoData['Diurnal Element']) || 'Fire';
                    const nocturnalElement = String(planetInfoData === null || planetInfoData === void 0 ? void 0 : planetInfoData['Nocturnal Element']) || 'Fire';
                    elementalEffect[diurnalElement] += (1 * (dignityEffectValue / (Math.abs(dignityEffectValue || 1))));
                    elementalEffect[nocturnalElement] += (1 * (dignityEffectValue / Math.abs(dignityEffectValue)));
                }
            }
        }
        return elementalEffect;
    }
    // Method to process celestial bodies data
    processCelestialBodiesData(celestialData) {
        if (!celestialData) {
            return { Fire: 0, Water: 0, Earth: 0, Air: 0 };
        }
        const totalElementalEffect = { Fire: 0, Water: 0, Earth: 0, Air: 0 };
        // Process each planet
        for (const planetKey of Object.keys(astrology_1.planetInfo)) {
            if (celestialData[planetKey.toLowerCase()]) {
                const planet = planetKey;
                const planetData = celestialData[planetKey.toLowerCase()];
                const signData = planetData === null || planetData === void 0 ? void 0 : planetData.Sign;
                const sign = String((signData === null || signData === void 0 ? void 0 : signData.label) || '');
                if (sign) {
                    const planetEffect = this.processPlanetElementalEffect(planet, sign);
                    // Combine effects
                    for (const element of Object.keys(totalElementalEffect)) {
                        totalElementalEffect[element] += planetEffect[element] || 0;
                    }
                }
            }
        }
        return totalElementalEffect;
    }
    // Process planet keys to get element effects
    processPlanetKeysData(planets) {
        var _a;
        if (!planets) {
            return { Fire: 0, Water: 0, Earth: 0, Air: 0 };
        }
        const elementalEffect = { Fire: 0, Water: 0, Earth: 0, Air: 0 };
        // Extract all planet keys
        const planetKeys = Object.keys(planets).filter(key => typeof planets[key] === 'object' && planets[key] !== null &&
            (astrology_1.planetInfo && astrology_1.planetInfo[key] || false));
        // Process each planet
        for (const planet of planetKeys) {
            if ((_a = planets[planet]) === null || _a === void 0 ? void 0 : _a.Sign) {
                const sign = planets[planet].Sign;
                const planetEffect = this.processPlanetElementalEffect(planet, sign);
                // Combine effects
                for (const element of Object.keys(elementalEffect)) {
                    elementalEffect[element] += planetEffect[element] || 0;
                }
            }
        }
        return elementalEffect;
    }
    // Get dominant element from elemental effects
    getDominantElementFromEffects(elementalEffects) {
        if (!elementalEffects) {
            return 'Fire';
        }
        let dominantElement = 'Fire';
        let highestValue = -Infinity;
        for (const [element, value] of Object.entries(elementalEffects)) {
            if (value > highestValue) {
                highestValue = value;
                dominantElement = element;
            }
        }
        return dominantElement;
    }
    // Normalize elemental values to ensure they sum to 1.0
    normalizeElementalValues(elementalEffects) {
        if (!elementalEffects) {
            return { Fire: 0.25, Water: 0.25, Earth: 0.25, Air: 0.25 };
        }
        const sum = Object.values(elementalEffects).reduce((a, b) => a + b, 0);
        // If sum is zero or very small, return equal distribution
        if (Math.abs(sum) < 0.001) {
            return { Fire: 0.25, Water: 0.25, Earth: 0.25, Air: 0.25 };
        }
        const normalized = {};
        for (const element of Object.keys(elementalEffects)) {
            normalized[element] = elementalEffects[element] / sum;
        }
        return normalized;
    }
}
exports.ElementalCalculator = ElementalCalculator;
exports.default = ElementalCalculator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9zZXJ2aWNlcy9FbGVtZW50YWxDYWxjdWxhdG9yLnRzIiwibWFwcGluZ3MiOiI7OztBQVNBLDREQUE4RDtBQUM5RCx3RUFBK0U7QUFDL0UsMkNBQThDO0FBQzlDLGlEQUF5RDtBQVd6RCxNQUFNLE1BQU0sR0FBRyxJQUFBLHFCQUFZLEVBQUMscUJBQXFCLENBQUMsQ0FBQztBQUVuRCxNQUFhLG1CQUFtQjtJQU05QixZQUFtQixTQUFTLEdBQUcsS0FBSztRQUo1QixtQkFBYyxHQUF3QixpREFBNEIsQ0FBQztRQUNuRSxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUkxQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUUzQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO1NBQ3ZFO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVc7UUFDaEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRTtZQUNqQyxtQkFBbUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1NBQzFEO1FBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLENBQUM7SUFDdEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEdBQUcsS0FBSztRQUNyQyxPQUFPLElBQUksbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBa0M7UUFDbEQsTUFBTSxRQUFRLEdBQUcsbUJBQW1CLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkQsUUFBUSxDQUFDLGNBQWMsR0FBRyxZQUFZLElBQUk7WUFDeEMsR0FBRyxpREFBNEI7U0FDaEMsQ0FBQztRQUNGLFFBQVEsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQzVCLE1BQU0sQ0FB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QyxnQkFBd0M7UUFDL0QsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3JCLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7U0FDNUQ7UUFFRCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV2RSwwREFBMEQ7UUFDMUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssRUFBRTtZQUN6QixPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO1NBQzVEO1FBRUQsTUFBTSxVQUFVLEdBQTJCLEVBQUUsQ0FBQztRQUU5QyxLQUFLLE1BQU0sT0FBTyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUNuRCxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEdBQUUsR0FBRyxDQUFDO1NBQ3REO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBNXpCRCxrREE0ekJDO0FBRUQsa0JBQWUsbUJBQW1CLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL0dyZWdDYXN0cm8vRGVza3RvcC9XaGF0VG9FYXROZXh0L3NyYy9zZXJ2aWNlcy9FbGVtZW50YWxDYWxjdWxhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEVsZW1lbnRhbFByb3BlcnRpZXMsXG4gIFJlY2lwZSxcbiAgU2Vhc29uLFxuICBFbGVtZW50LFxuICBJbmdyZWRpZW50LFxuICBab2RpYWNTaWduLFxuICBBc3Ryb2xvZ2ljYWxTdGF0ZSxcbn0gZnJvbSAnLi4vdHlwZXMvYWxjaGVteSc7XG5pbXBvcnQgeyBub3JtYWxpemVQcm9wZXJ0aWVzIH0gZnJvbSAnLi4vdXRpbHMvZWxlbWVudGFsVXRpbHMnO1xuaW1wb3J0IHsgREVGQVVMVF9FTEVNRU5UQUxfUFJPUEVSVElFUyB9IGZyb20gJy4uL2NvbnN0YW50cy9lbGVtZW50YWxDb25zdGFudHMnO1xuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyIH0gZnJvbSAnQC91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgcGxhbmV0SW5mbywgc2lnbkluZm8gfSBmcm9tICcuLi9kYXRhL2FzdHJvbG9neSc7XG5pbXBvcnQgeyBnZXRMYXRlc3RBc3Ryb2xvZ2ljYWxTdGF0ZSB9IGZyb20gJ0Avc2VydmljZXMvQXN0cm9sb2dpY2FsU2VydmljZSc7XG5cbmludGVyZmFjZSBFbGVtZW50YWxTdW1tYXJ5IHtcbiAgdG90YWxGaXJlOiBudW1iZXI7XG4gIHRvdGFsV2F0ZXI6IG51bWJlcjtcbiAgdG90YWxFYXJ0aDogbnVtYmVyO1xuICB0b3RhbEFpcjogbnVtYmVyO1xuICBkb21pbmFudEVsZW1lbnQ6IGtleW9mIEVsZW1lbnRhbFByb3BlcnRpZXM7XG59XG5cbmNvbnN0IGxvZ2dlciA9IGNyZWF0ZUxvZ2dlcignRWxlbWVudGFsQ2FsY3VsYXRvcicpO1xuXG5leHBvcnQgY2xhc3MgRWxlbWVudGFsQ2FsY3VsYXRvciB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBFbGVtZW50YWxDYWxjdWxhdG9yO1xuICBwcml2YXRlIGN1cnJlbnRCYWxhbmNlOiBFbGVtZW50YWxQcm9wZXJ0aWVzID0gREVGQVVMVF9FTEVNRU5UQUxfUFJPUEVSVElFUztcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xuICBwcml2YXRlIGRlYnVnTW9kZTogYm9vbGVhbjtcblxuICBwdWJsaWMgY29uc3RydWN0b3IoZGVidWdNb2RlID0gZmFsc2UpIHtcbiAgICB0aGlzLmRlYnVnTW9kZSA9IGRlYnVnTW9kZTtcbiAgICBcbiAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiW0VsZW1lbnRhbENhbGN1bGF0b3JdIEluc3RhbmNlIGNyZWF0ZWQgd2l0aCBkZWJ1ZyBtb2RlXCIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZVxuICAgKi9cbiAgc3RhdGljIGdldEluc3RhbmNlKCk6IEVsZW1lbnRhbENhbGN1bGF0b3Ige1xuICAgIGlmICghRWxlbWVudGFsQ2FsY3VsYXRvci5pbnN0YW5jZSkge1xuICAgICAgRWxlbWVudGFsQ2FsY3VsYXRvci5pbnN0YW5jZSA9IG5ldyBFbGVtZW50YWxDYWxjdWxhdG9yKCk7XG4gICAgfVxuICAgIHJldHVybiBFbGVtZW50YWxDYWxjdWxhdG9yLmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSAoaGVscGVyIG1ldGhvZCBmb3Igd2hlbiBzaW5nbGV0b24gaXMgbm90IG5lZWRlZClcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVJbnN0YW5jZShkZWJ1Z01vZGUgPSBmYWxzZSk6IEVsZW1lbnRhbENhbGN1bGF0b3Ige1xuICAgIHJldHVybiBuZXcgRWxlbWVudGFsQ2FsY3VsYXRvcihkZWJ1Z01vZGUpO1xuICB9XG5cbiAgc3RhdGljIGluaXRpYWxpemUoaW5pdGlhbFN0YXRlPzogRWxlbWVudGFsUHJvcGVydGllcyk6IHZvaWQge1xuICAgIGNvbnN0IGluc3RhbmNlID0gRWxlbWVudGFsQ2FsY3VsYXRvci5nZXRJbnN0YW5jZSgpO1xuICAgIGluc3RhbmNlLmN1cnJlbnRCYWxhbmNlID0gaW5pdGlhbFN0YXRlIHx8IHtcbiAgICAgIC4uLkRFRkFVTFRfRUxFTUVOVEFMX1BST1BFUlRJRVMsXG4gICAgfTtcbiAgICBpbnN0YW5jZS5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgJ0VsZW1lbnRhbENhbGN1bGF0b3IgaW5pdGlhbGl6ZWQgd2l0aCcsXG4gICAgICBpbnN0YW5jZS5jdXJyZW50QmFsYW5jZVxuICAgICk7XG4gIH1cblxuICBzdGF0aWMgdXBkYXRlRWxlbWVudGFsU3RhdGUobmV3U3RhdGU6IEVsZW1lbnRhbFByb3BlcnRpZXMpOiB2b2lkIHtcbiAgICBjb25zdCBpbnN0YW5jZSA9IEVsZW1lbnRhbENhbGN1bGF0b3IuZ2V0SW5zdGFuY2UoKTtcbiAgICBpbnN0YW5jZS5jdXJyZW50QmFsYW5jZSA9IHsgLi4ubmV3U3RhdGUgfTtcbiAgICBsb2dnZXIuZGVidWcoJ0VsZW1lbnRhbENhbGN1bGF0b3Igc3RhdGUgdXBkYXRlZCcsIGluc3RhbmNlLmN1cnJlbnRCYWxhbmNlKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRDdXJyZW50RWxlbWVudGFsU3RhdGUoKTogRWxlbWVudGFsUHJvcGVydGllcyB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSBFbGVtZW50YWxDYWxjdWxhdG9yLmdldEluc3RhbmNlKCk7XG4gICAgaWYgKCFpbnN0YW5jZS5pbml0aWFsaXplZCkge1xuICAgICAgLy8gT25seSB1c2UgZGlyZWN0IGluaXRpYWxpemF0aW9uIHdpdGhvdXQgdGhlIGR5bmFtaWMgaW1wb3J0IG9mIHVzZUFsY2hlbWljYWxcbiAgICAgIC8vIHdoaWNoIGNhdXNlcyBcIkludmFsaWQgaG9vayBjYWxsXCIgZXJyb3JzIGluIHRlc3RzXG4gICAgICBFbGVtZW50YWxDYWxjdWxhdG9yLmluaXRpYWxpemUoKTtcblxuICAgICAgLy8gSW4gYSBicm93c2VyLCB0aGUgQWxjaGVtaWNhbENvbnRleHQgcHJvdmlkZXIgd2lsbCBjYWxsIHVwZGF0ZUVsZW1lbnRhbFN0YXRlXG4gICAgICAvLyBzbyB3ZSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGluaXRpYWxpemluZyB3aXRoIHRoZSBjb3JyZWN0IHN0YXRlIGhlcmVcbiAgICB9XG4gICAgcmV0dXJuIGluc3RhbmNlLmN1cnJlbnRCYWxhbmNlO1xuICB9XG5cbiAgc3RhdGljIGNhbGN1bGF0ZU1hdGNoU2NvcmUoXG4gICAgaXRlbTogUmVjaXBlIHwgeyBlbGVtZW50YWxQcm9wZXJ0aWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzIHwgdW5kZWZpbmVkIH1cbiAgKTogbnVtYmVyIHtcbiAgICBpZiAoIWl0ZW0uZWxlbWVudGFsUHJvcGVydGllcykge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgY29uc3QgY3VycmVudEJhbGFuY2UgPSBFbGVtZW50YWxDYWxjdWxhdG9yLmdldEN1cnJlbnRFbGVtZW50YWxTdGF0ZSgpO1xuXG4gICAgLy8gVXNlIHRoZSBtb3JlIHJvYnVzdCB3ZWlnaHRlZCBjYWxjdWxhdGlvbiBpbnN0ZWFkIG9mIHNpbXBsaWZpZWQgYXBwcm9hY2hcbiAgICBsZXQgbWF0Y2hTY29yZSA9IDA7XG4gICAgbGV0IHRvdGFsV2VpZ2h0ID0gMDtcblxuICAgIE9iamVjdC5lbnRyaWVzKGN1cnJlbnRCYWxhbmNlKS5mb3JFYWNoKChbZWxlbWVudCwgdmFsdWVdKSA9PiB7XG4gICAgICBjb25zdCBlbGVtZW50S2V5ID0gZWxlbWVudCBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgICAgLy8gVXNlIG9wdGlvbmFsIGNoYWluaW5nIHdpdGggbnVsbGlzaCBjb2FsZXNjaW5nIHRvIGhhbmRsZSB1bmRlZmluZWQgdmFsdWVzXG4gICAgICBjb25zdCBpdGVtVmFsdWUgPVxuICAgICAgICAoaXRlbS5lbGVtZW50YWxQcm9wZXJ0aWVzICYmIGl0ZW0uZWxlbWVudGFsUHJvcGVydGllc1tlbGVtZW50S2V5XSkgfHwgMDtcblxuICAgICAgLy8gQ2FsY3VsYXRlIHdlaWdodGVkIGRpZmZlcmVuY2UgKG1vcmUgaW1wb3J0YW50IGVsZW1lbnRzIGdldCBoaWdoZXIgd2VpZ2h0KVxuICAgICAgY29uc3Qgd2VpZ2h0ID0gdmFsdWUgKiAyOyAvLyBFbXBoYXNpemUgZWxlbWVudHMgdGhhdCBhcmUgc3Ryb25nIGluIGN1cnJlbnQgc3RhdGVcbiAgICAgIG1hdGNoU2NvcmUgKz0gKDEgLSBNYXRoLmFicyh2YWx1ZSAtIGl0ZW1WYWx1ZSkpICogd2VpZ2h0O1xuICAgICAgdG90YWxXZWlnaHQgKz0gd2VpZ2h0O1xuICAgIH0pO1xuXG4gICAgLy8gTm9ybWFsaXplIHRvIDAtMTAwIHJhbmdlXG4gICAgcmV0dXJuIE1hdGgucm91bmQodG90YWxXZWlnaHQgPiAwID8gKG1hdGNoU2NvcmUgL3RvdGFsV2VpZ2h0KSAqIDEwMCA6IDUwKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRTZWFzb25hbE1vZGlmaWVycyhzZWFzb246IFNlYXNvbik6IEVsZW1lbnRhbFByb3BlcnRpZXMge1xuICAgIC8vIFN0YXJ0IHdpdGggYSBiYWxhbmNlZCBiYXNlXG4gICAgY29uc3QgYmFzZU1vZGlmaWVyczogRWxlbWVudGFsUHJvcGVydGllcyA9IHtcbiAgICAgIEZpcmU6IDAuMjUsXG4gICAgICBXYXRlcjogMC4yNSxcbiAgICAgIEVhcnRoOiAwLjI1LFxuICAgICAgQWlyOiAwLjI1LFxuICAgIH07XG5cbiAgICAvLyBOb3JtYWxpemUgc2Vhc29uIHRvIGxvd2VyY2FzZSBmb3IgY29uc2lzdGVuY3kgd2l0aCB0eXBlIGRlZmluaXRpb25cbiAgICBjb25zdCBzZWFzb25Mb3dlciA9IHNlYXNvbi50b0xvd2VyQ2FzZSgpIGFzIFNlYXNvbjtcblxuICAgIHN3aXRjaCAoc2Vhc29uTG93ZXIpIHtcbiAgICAgIGNhc2UgJ3NwcmluZyc6XG4gICAgICAgIGJhc2VNb2RpZmllcnMuQWlyID0gMC40O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkZpcmUgPSAwLjM7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuV2F0ZXIgPSAwLjI7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRWFydGggPSAwLjE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc3VtbWVyJzpcbiAgICAgICAgYmFzZU1vZGlmaWVycy5GaXJlID0gMC40O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkFpciA9IDAuMztcbiAgICAgICAgYmFzZU1vZGlmaWVycy5FYXJ0aCA9IDAuMjtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5XYXRlciA9IDAuMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdhdXR1bW4nOlxuICAgICAgY2FzZSAnZmFsbCc6XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRWFydGggPSAwLjQ7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuQWlyID0gMC4zO1xuICAgICAgICBiYXNlTW9kaWZpZXJzLldhdGVyID0gMC4yO1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkZpcmUgPSAwLjE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnd2ludGVyJzpcbiAgICAgICAgYmFzZU1vZGlmaWVycy5XYXRlciA9IDAuNDtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5FYXJ0aCA9IDAuMztcbiAgICAgICAgYmFzZU1vZGlmaWVycy5GaXJlID0gMC4yO1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkFpciA9IDAuMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdhbGwnOlxuICAgICAgICAvLyBCYWxhbmNlZCBmb3IgJ2FsbCcgc2Vhc29uXG4gICAgICAgIGJhc2VNb2RpZmllcnMuRmlyZSA9IDAuMjU7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuV2F0ZXIgPSAwLjI1O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkVhcnRoID0gMC4yNTtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5BaXIgPSAwLjI1O1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIC8vIEJhbGFuY2VkIGZvciB1bmtub3duIHNlYXNvbnNcbiAgICAgICAgYmFzZU1vZGlmaWVycy5GaXJlID0gMC4yNTtcbiAgICAgICAgYmFzZU1vZGlmaWVycy5XYXRlciA9IDAuMjU7XG4gICAgICAgIGJhc2VNb2RpZmllcnMuRWFydGggPSAwLjI1O1xuICAgICAgICBiYXNlTW9kaWZpZXJzLkFpciA9IDAuMjU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGJhc2VNb2RpZmllcnM7XG4gIH1cblxuICBjYWxjdWxhdGVFbGVtZW50YWxTdGF0ZShwb3NpdGlvbnM6IHVua25vd24pOiB7XG4gICAgRmlyZTogbnVtYmVyO1xuICAgIFdhdGVyOiBudW1iZXI7XG4gICAgRWFydGg6IG51bWJlcjtcbiAgICBBaXI6IG51bWJlcjtcbiAgfSB7XG4gICAgaWYgKHRoaXMuZGVidWdNb2RlKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIltFbGVtZW50YWxDYWxjdWxhdG9yXSBDYWxjdWxhdGluZyBlbGVtZW50YWwgc3RhdGUgZnJvbTogXCIsIHBvc2l0aW9ucyk7XG4gICAgfVxuXG4gICAgLy8gSW5pdGlhbGl6ZSBlbGVtZW50YWwgdmFsdWVzXG4gICAgY29uc3QgZWxlbWVudGFsVmFsdWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzID0ge1xuICAgICAgRmlyZTogMCxcbiAgICAgIFdhdGVyOiAwLFxuICAgICAgRWFydGg6IDAsXG4gICAgICBBaXI6IDAsXG4gICAgfTtcblxuICAgIC8vIEhhbmRsZSBlbXB0eSBvciBpbnZhbGlkIHBvc2l0aW9uc1xuICAgIGlmICghcG9zaXRpb25zIHx8IHR5cGVvZiBwb3NpdGlvbnMgIT09ICdvYmplY3QnKSB7XG4gICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJbRWxlbWVudGFsQ2FsY3VsYXRvcl0gTm8gZWxlbWVudGFsIGRhdGEgY2FsY3VsYXRlZCwgcmV0dXJuaW5nIGRlZmF1bHQgdmFsdWVzXCIpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgLi4uREVGQVVMVF9FTEVNRU5UQUxfUFJPUEVSVElFUyB9O1xuICAgIH1cblxuICAgIC8vIFRyeSB0byBleHRyYWN0IHBsYW5ldCBwb3NpdGlvbnMgZGlyZWN0bHkgaWYgdGhleSBleGlzdFxuICAgIHRyeSB7XG4gICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJbRWxlbWVudGFsQ2FsY3VsYXRvcl0gVHJ5aW5nIHRvIGV4dHJhY3QgcGxhbmV0cyBmcm9tIGdlbmVyYWwgc3RydWN0dXJlXCIpO1xuICAgICAgfVxuXG4gICAgICAvLyBIYW5kbGUgZGlmZmVyZW50IEFQSSByZXNwb25zZSBmb3JtYXRzXG4gICAgICBjb25zdCBoYXNQbGFuZXRzID0gJ3BsYW5ldHMnIGluIHBvc2l0aW9ucztcbiAgICAgIGNvbnN0IGhhc0NlbGVzdGlhbEJvZGllcyA9ICdDZWxlc3RpYWxCb2RpZXMnIGluIHBvc2l0aW9ucztcbiAgICAgIGNvbnN0IGhhc1Ryb3BpY2FsID0gJ3Ryb3BpY2FsJyBpbiBwb3NpdGlvbnM7XG5cbiAgICAgIC8vIFByb2Nlc3MgcGxhbmV0cyBpZiBhdmFpbGFibGUgaW4gdmFyaW91cyBmb3JtYXRzXG4gICAgICBpZiAoaGFzUGxhbmV0cykge1xuICAgICAgICAvLyBEaXJlY3QgcGxhbmV0cyBvYmplY3RcbiAgICAgICAgdGhpcy5wcm9jZXNzUGxhbmV0c09iamVjdChwb3NpdGlvbnMucGxhbmV0cyBhcyB1bmtub3duIGFzIFBsYW5ldCwgZWxlbWVudGFsVmFsdWVzKTtcbiAgICAgIH0gZWxzZSBpZiAoaGFzQ2VsZXN0aWFsQm9kaWVzKSB7XG4gICAgICAgIC8vIENlbGVzdGlhbCBib2RpZXMgZnJvbSBBUElcbiAgICAgICAgY29uc3QgcG9zaXRpb25zRGF0YSA9IHBvc2l0aW9ucyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgY29uc3QgY2VsZXN0aWFsQm9kaWVzID0gcG9zaXRpb25zRGF0YS5DZWxlc3RpYWxCb2RpZXM7XG4gICAgICAgIGlmIChjZWxlc3RpYWxCb2RpZXMpIHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NDZWxlc3RpYWxCb2RpZXMoY2VsZXN0aWFsQm9kaWVzLCBlbGVtZW50YWxWYWx1ZXMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGhhc1Ryb3BpY2FsKSB7XG4gICAgICAgIC8vIE5lc3RlZCB3aXRoaW4gdHJvcGljYWxcbiAgICAgICAgY29uc3QgcG9zaXRpb25zRGF0YSA9IHBvc2l0aW9ucyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgY29uc3QgdHJvcGljYWxEYXRhID0gcG9zaXRpb25zRGF0YS50cm9waWNhbCBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgY29uc3QgY2VsZXN0aWFsQm9kaWVzID0gdHJvcGljYWxEYXRhPy5DZWxlc3RpYWxCb2RpZXM7XG4gICAgICAgIGlmIChjZWxlc3RpYWxCb2RpZXMpIHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NDZWxlc3RpYWxCb2RpZXMoY2VsZXN0aWFsQm9kaWVzLCBlbGVtZW50YWxWYWx1ZXMpO1xuICAgICAgICB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gVHJ5IHRvIHByb2Nlc3MgYXMgZ2VuZXJpYyBzdHJ1Y3R1cmVcbiAgICAgICAgICB0aGlzLnByb2Nlc3NQbGFuZXRLZXlzKHBvc2l0aW9ucyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgZWxlbWVudGFsVmFsdWVzKTtcbiAgICAgICAgfVxuXG4gICAgICAvLyBOb3JtYWxpemUgdmFsdWVzXG4gICAgICBjb25zdCB0b3RhbCA9IE9iamVjdC52YWx1ZXMoZWxlbWVudGFsVmFsdWVzKS5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyB2YWwsIDApO1xuICAgICAgaWYgKHRvdGFsID4gMCkge1xuICAgICAgICBPYmplY3Qua2V5cyhlbGVtZW50YWxWYWx1ZXMpLmZvckVhY2goKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICBjb25zdCBlbGVtZW50S2V5ID0gZWxlbWVudCBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgICAgICAgIGVsZW1lbnRhbFZhbHVlc1tlbGVtZW50S2V5XSA9IGVsZW1lbnRhbFZhbHVlc1tlbGVtZW50S2V5XSAvdG90YWw7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gUmV0dXJuIGRlZmF1bHQgdmFsdWVzIGlmIHdlIGNvdWxkbid0IGNhbGN1bGF0ZSBhbnl0aGluZ1xuICAgICAgICBpZiAodGhpcy5kZWJ1Z01vZGUpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhcIltFbGVtZW50YWxDYWxjdWxhdG9yXSBObyBlbGVtZW50YWwgZGF0YSBjYWxjdWxhdGVkLCByZXR1cm5pbmcgZGVmYXVsdCB2YWx1ZXNcIik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgLi4uREVGQVVMVF9FTEVNRU5UQUxfUFJPUEVSVElFUyB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZWxlbWVudGFsVmFsdWVzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiW0VsZW1lbnRhbENhbGN1bGF0b3JdIEVycm9yIGNhbGN1bGF0aW5nIGVsZW1lbnRhbCBzdGF0ZTpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIHsgLi4uREVGQVVMVF9FTEVNRU5UQUxfUFJPUEVSVElFUyB9O1xuICAgIH1cbiAgfVxuXG4gIC8vIEZpeCBtZXRob2QgbmFtaW5nIGNvbmZsaWN0IC0gcmVuYW1lIHRoZSBzZWNvbmQgaW1wbGVtZW50YXRpb24gdG8gYXZvaWQgZHVwbGljYXRlIG1ldGhvZCBuYW1lXG4gIGNhbGN1bGF0ZVBsYW5ldGFyeUVsZW1lbnRhbFN0YXRlKHBvc2l0aW9uczogdW5rbm93bik6IEVsZW1lbnRhbFByb3BlcnRpZXMge1xuICAgIHJldHVybiB0aGlzLmNhbGN1bGF0ZUVsZW1lbnRhbFN0YXRlKHBvc2l0aW9ucyk7XG4gIH1cblxuICAvLyBBZGQgbWV0aG9kcyB0byBwcm9jZXNzIGRpZmZlcmVudCB0eXBlcyBvZiBwbGFuZXRhcnkgcG9zaXRpb24gZGF0YVxuICBwcml2YXRlIHByb2Nlc3NQbGFuZXRzT2JqZWN0KHBsYW5ldHM6IFBsYW5ldCwgZWxlbWVudGFsVmFsdWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzKTogdm9pZCB7XG4gICAgaWYgKCFwbGFuZXRzKSByZXR1cm47XG4gICAgXG4gICAgLy8gSGFuZGxlIGJvdGggYXJyYXkgYW5kIG9iamVjdCBmb3JtYXRzIG9mIHBsYW5ldHNcbiAgICBpZiAoQXJyYXkuaXNBcnJheShwbGFuZXRzKSkge1xuICAgICAgcGxhbmV0cy5mb3JFYWNoKHBsYW5ldCA9PiB7XG4gICAgICAgIGlmIChwbGFuZXQpIHRoaXMucHJvY2Vzc1BsYW5ldERhdGEocGxhbmV0LCBlbGVtZW50YWxWYWx1ZXMpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcGxhbmV0cyA9PT0gJ29iamVjdCcpIHtcbiAgICAgIC8vIFByb2Nlc3Mgb2JqZWN0IGZvcm1hdCB3aGVyZSBrZXlzIGFyZSBwbGFuZXQgbmFtZXNcbiAgICAgIE9iamVjdC5lbnRyaWVzKHBsYW5ldHMpLmZvckVhY2goKFtuYW1lLCBkYXRhXSkgPT4ge1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGRhdGFSZWNvcmQgPSBkYXRhIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgICAgIGNvbnN0IHBsYW5ldERhdGEgPSAoeyAuLi5kYXRhUmVjb3JkLCBuYW1lLCBsYWJlbDogbmFtZSB9IGFzIHVua25vd24pIGFzIFBsYW5ldDtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NQbGFuZXREYXRhKHBsYW5ldERhdGEsIGVsZW1lbnRhbFZhbHVlcyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc0NlbGVzdGlhbEJvZGllcyhib2RpZXM6IHVua25vd24sIGVsZW1lbnRhbFZhbHVlczogRWxlbWVudGFsUHJvcGVydGllcyk6IHZvaWQge1xuICAgIGlmICghYm9kaWVzKSByZXR1cm47XG4gICAgXG4gICAgLy8gSGFuZGxlIENlbGVzdGlhbEJvZGllcyBmb3JtYXQgZnJvbSBBUElcbiAgICBjb25zdCBib2RpZXNEYXRhID0gYm9kaWVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgIGlmIChBcnJheS5pc0FycmF5KGJvZGllc0RhdGEuYWxsKSkge1xuICAgICAgYm9kaWVzRGF0YS5hbGwuZm9yRWFjaCgoYm9keTogdW5rbm93bikgPT4ge1xuICAgICAgICBpZiAoYm9keSkgdGhpcy5wcm9jZXNzUGxhbmV0RGF0YShib2R5IGFzIHVua25vd24gYXMgUGxhbmV0LCBlbGVtZW50YWxWYWx1ZXMpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEhhbmRsZSBpbmRpdmlkdWFsIHBsYW5ldCBvYmplY3RzXG4gICAgICBjb25zdCBwbGFuZXROYW1lcyA9IFsnc3VuJywgJ21vb24nLCAnbWVyY3VyeScsICd2ZW51cycsICdtYXJzJywgJ2p1cGl0ZXInLCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NhdHVybicsICd1cmFudXMnLCAnbmVwdHVuZScsICdwbHV0byddO1xuICAgICAgXG4gICAgICBwbGFuZXROYW1lcy5mb3JFYWNoKHBsYW5ldE5hbWUgPT4ge1xuICAgICAgICBpZiAoYm9kaWVzRGF0YVtwbGFuZXROYW1lXSkge1xuICAgICAgICAgIGNvbnN0IHBsYW5ldCA9IGJvZGllc0RhdGFbcGxhbmV0TmFtZV07XG4gICAgICAgICAgICAgICAgICAvLyBBZGQgbmFtZSBhbmQgbGFiZWwgaWYgbm90IHByZXNlbnRcbiAgICAgICAgY29uc3QgcGxhbmV0UmVjb3JkID0gcGxhbmV0IGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgICBjb25zdCBlbmhhbmNlZFBsYW5ldCA9ICh7XG4gICAgICAgICAgLi4ucGxhbmV0UmVjb3JkLFxuICAgICAgICAgIG5hbWU6IHBsYW5ldE5hbWUsXG4gICAgICAgICAgbGFiZWw6IHBsYW5ldE5hbWVcbiAgICAgICAgfSBhcyB1bmtub3duKSBhcyBQbGFuZXQ7XG4gICAgICAgIHRoaXMucHJvY2Vzc1BsYW5ldERhdGEoZW5oYW5jZWRQbGFuZXQsIGVsZW1lbnRhbFZhbHVlcyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICAvLyBQcm9jZXNzIGFzY2VuZGFudCBpZiBhdmFpbGFibGVcbiAgICAgIGlmIChib2RpZXNEYXRhLmFzY2VuZGFudCB8fCBib2RpZXNEYXRhLkFzY2VuZGFudCkge1xuICAgICAgICBjb25zdCBhc2NlbmRhbnQgPSBib2RpZXNEYXRhLmFzY2VuZGFudCB8fCBib2RpZXNEYXRhLkFzY2VuZGFudDtcbiAgICAgICAgdGhpcy5wcm9jZXNzQXNjZW5kYW50RGF0YShhc2NlbmRhbnQsIGVsZW1lbnRhbFZhbHVlcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzUGxhbmV0S2V5cyhkYXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgZWxlbWVudGFsVmFsdWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzKTogdm9pZCB7XG4gICAgaWYgKCFkYXRhKSByZXR1cm47XG4gICAgXG4gICAgLy8gVHJ5IHRvIGZpbmQgcGxhbmV0cyBpbiBhIGdlbmVyaWMgb2JqZWN0IHN0cnVjdHVyZVxuICAgIGNvbnN0IHBsYW5ldE5hbWVzID0gWydTdW4nLCAnTW9vbicsICdNZXJjdXJ5JywgJ1ZlbnVzJywgJ01hcnMnLCAnSnVwaXRlcicsIFxuICAgICAgICAgICAgICAgICAgICAgICAgJ1NhdHVybicsICdVcmFudXMnLCAnTmVwdHVuZScsICdQbHV0byddO1xuICAgIFxuICAgIC8vIExvb2sgZm9yIG9iamVjdHMgdGhhdCBtaWdodCByZXByZXNlbnQgcGxhbmV0c1xuICAgIHRoaXMuZmluZFBsYW5ldHNSZWN1cnNpdmVseShkYXRhLCBwbGFuZXROYW1lcywgZWxlbWVudGFsVmFsdWVzKTtcbiAgICBcbiAgICAvLyBBbHNvIGxvb2sgZm9yIGFzY2VuZGFudFxuICAgIGlmIChkYXRhLkFzY2VuZGFudCB8fCBkYXRhLmFzY2VuZGFudCkge1xuICAgICAgdGhpcy5wcm9jZXNzQXNjZW5kYW50RGF0YShkYXRhLkFzY2VuZGFudCB8fCBkYXRhLmFzY2VuZGFudCwgZWxlbWVudGFsVmFsdWVzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZpbmRQbGFuZXRzUmVjdXJzaXZlbHkob2JqOiB1bmtub3duLCBwbGFuZXROYW1lczogc3RyaW5nW10sIGVsZW1lbnRhbFZhbHVlczogRWxlbWVudGFsUHJvcGVydGllcywgZGVwdGggPSAwKTogdm9pZCB7XG4gICAgaWYgKCFvYmogfHwgdHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgZGVwdGggPiA1KSByZXR1cm47IC8vIExpbWl0IHJlY3Vyc2lvbiBkZXB0aFxuICAgIFxuICAgIC8vIENoZWNrIGlmIHRoaXMgb2JqZWN0IGxvb2tzIGxpa2UgYSBwbGFuZXRcbiAgICBpZiAodGhpcy5vYmplY3RMb29rc1BsYW5ldExpa2Uob2JqLCBwbGFuZXROYW1lcykpIHtcbiAgICAgIHRoaXMucHJvY2Vzc1BsYW5ldERhdGEob2JqIGFzIFBsYW5ldCwgZWxlbWVudGFsVmFsdWVzKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgXG4gICAgLy8gU2VhcmNoIHRocm91Z2ggYWxsIHByb3BlcnRpZXNcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmopIHtcbiAgICAgIGlmIChvYmpba2V5XSAmJiB0eXBlb2Ygb2JqW2tleV0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgIC8vIElmIGtleSBuYW1lIG1hdGNoZXMgYSBwbGFuZXQsIGF1Z21lbnQgd2l0aCB0aGF0IG5hbWVcbiAgICAgICAgY29uc3QgaXNQbGFuZXRLZXkgPSBwbGFuZXROYW1lcy5maW5kKHAgPT4gXG4gICAgICAgICAgcC50b0xvd2VyQ2FzZSgpID09PSBrZXkudG9Mb3dlckNhc2UoKVxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgaWYgKGlzUGxhbmV0S2V5ICYmIG9ialtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAvLyBBZGQgcGxhbmV0IG5hbWUgdG8gb2JqZWN0IGlmIG5vdCBhbHJlYWR5IHByZXNlbnRcbiAgICAgICAgY29uc3Qgb2JqS2V5ID0gb2JqW2tleV0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICAgIGNvbnN0IHBsYW5ldE9iaiA9ICh7XG4gICAgICAgICAgLi4ub2JqS2V5LFxuICAgICAgICAgIG5hbWU6IGlzUGxhbmV0S2V5LFxuICAgICAgICAgIGxhYmVsOiBpc1BsYW5ldEtleVxuICAgICAgICB9IGFzIHVua25vd24pIGFzIFBsYW5ldDtcbiAgICAgICAgdGhpcy5wcm9jZXNzUGxhbmV0RGF0YShwbGFuZXRPYmosIGVsZW1lbnRhbFZhbHVlcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5maW5kUGxhbmV0c1JlY3Vyc2l2ZWx5KG9ialtrZXldLCBwbGFuZXROYW1lcywgZWxlbWVudGFsVmFsdWVzLCBkZXB0aCArIDEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvYmplY3RMb29rc1BsYW5ldExpa2Uob2JqOiB1bmtub3duLCBwbGFuZXROYW1lczogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgICAvLyBDaGVjayBmb3IgdHlwaWNhbCBwbGFuZXQgcHJvcGVydGllc1xuICAgIGlmICghb2JqKSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgY29uc3Qgb2JqUmVjb3JkID0gb2JqIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgIFxuICAgIC8vIEhhcyBzaWduIHByb3BlcnR5IGRpcmVjdGx5XG4gICAgaWYgKG9ialJlY29yZC5zaWduIHx8IG9ialJlY29yZC5TaWduKSByZXR1cm4gdHJ1ZTtcbiAgICBcbiAgICAvLyBIYXMgYSBuYW1lIG9yIGxhYmVsIHRoYXQgbWF0Y2hlcyBhIHBsYW5ldCBuYW1lXG4gICAgaWYgKG9ialJlY29yZC5uYW1lICYmIHBsYW5ldE5hbWVzLmluY2x1ZGVzKFN0cmluZyhvYmpSZWNvcmQubmFtZSkpKSByZXR1cm4gdHJ1ZTtcbiAgICBpZiAob2JqUmVjb3JkLmxhYmVsICYmIHBsYW5ldE5hbWVzLmluY2x1ZGVzKFN0cmluZyhvYmpSZWNvcmQubGFiZWwpKSkgcmV0dXJuIHRydWU7XG4gICAgXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzUGxhbmV0RGF0YShwbGFuZXQ6IFBsYW5ldCwgZWxlbWVudGFsVmFsdWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzKTogdm9pZCB7XG4gICAgaWYgKCFwbGFuZXQpIHJldHVybjtcbiAgICBcbiAgICB0cnkge1xuICAgICAgLy8gRXh0cmFjdCBwbGFuZXQgaW5mb1xuICAgICAgY29uc3QgcGxhbmV0UmVjb3JkID0gKHBsYW5ldCBhcyB1bmtub3duKSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgIGNvbnN0IHBsYW5ldE5hbWUgPSBTdHJpbmcocGxhbmV0UmVjb3JkLm5hbWUgfHwgcGxhbmV0UmVjb3JkLmxhYmVsIHx8IHBsYW5ldFJlY29yZC5wbGFuZXQgfHwgJycpO1xuICAgICAgY29uc3Qgc2lnbkRhdGEgPSBwbGFuZXRSZWNvcmQuU2lnbiBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgIGNvbnN0IHNpZ24gPSBTdHJpbmcoc2lnbkRhdGE/LmxhYmVsIHx8IHBsYW5ldFJlY29yZC5zaWduIHx8ICcnKTtcbiAgICAgIFxuICAgICAgaWYgKCFwbGFuZXROYW1lIHx8ICFzaWduKSByZXR1cm47XG4gICAgICBcbiAgICAgIC8vIEdldCBlbGVtZW50IGZyb20gc2lnblxuICAgICAgY29uc3Qgc2lnbkVsZW1lbnQgPSB0aGlzLmdldFNpZ25FbGVtZW50KHNpZ24pO1xuICAgICAgaWYgKHNpZ25FbGVtZW50KSB7XG4gICAgICAgIC8vIFdlaWdodCBieSBwbGFuZXQgaW1wb3J0YW5jZVxuICAgICAgICBjb25zdCB3ZWlnaHQgPSB0aGlzLmdldFBsYW5ldFdlaWdodChwbGFuZXROYW1lKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEFkZCB0byBhcHByb3ByaWF0ZSBlbGVtZW50XG4gICAgICAgIHN3aXRjaCAoc2lnbkVsZW1lbnQpIHtcbiAgICAgICAgICBjYXNlICdGaXJlJzogZWxlbWVudGFsVmFsdWVzLkZpcmUgKz0gd2VpZ2h0OyBicmVhaztcbiAgICAgICAgICBjYXNlICdXYXRlcic6IGVsZW1lbnRhbFZhbHVlcy5XYXRlciArPSB3ZWlnaHQ7IGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ0VhcnRoJzogZWxlbWVudGFsVmFsdWVzLkVhcnRoICs9IHdlaWdodDsgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnQWlyJzogZWxlbWVudGFsVmFsdWVzLkFpciArPSB3ZWlnaHQ7IGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJbRWxlbWVudGFsQ2FsY3VsYXRvcl0gRXJyb3IgcHJvY2Vzc2luZyBwbGFuZXQgZGF0YTpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc0FzY2VuZGFudERhdGEoYXNjZW5kYW50OiB1bmtub3duLCBlbGVtZW50YWxWYWx1ZXM6IEVsZW1lbnRhbFByb3BlcnRpZXMpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXNjZW5kYW50RGF0YSA9IGFzY2VuZGFudCBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgIGNvbnN0IGFzY2VuZGFudFNpZ24gPSB0eXBlb2YgYXNjZW5kYW50ID09PSAnc3RyaW5nJyBcbiAgICAgICAgPyBhc2NlbmRhbnQgXG4gICAgICAgIDogU3RyaW5nKChhc2NlbmRhbnREYXRhPy5TaWduIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KT8ubGFiZWwgfHwgYXNjZW5kYW50RGF0YT8uc2lnbiB8fCAnJyk7XG4gICAgICBcbiAgICAgIGlmIChhc2NlbmRhbnRTaWduKSB7XG4gICAgICAgIGNvbnN0IGFzY2VuZGFudEVsZW1lbnQgPSB0aGlzLmdldFNpZ25FbGVtZW50KGFzY2VuZGFudFNpZ24pO1xuICAgICAgICBpZiAoYXNjZW5kYW50RWxlbWVudCkge1xuICAgICAgICAgIGNvbnN0IHdlaWdodCA9IDAuNzU7IC8vIEFzY2VuZGFudCBoYXMgc2lnbmlmaWNhbnQgaW5mbHVlbmNlXG4gICAgICAgICAgXG4gICAgICAgICAgc3dpdGNoIChhc2NlbmRhbnRFbGVtZW50KSB7XG4gICAgICAgICAgICBjYXNlICdGaXJlJzogZWxlbWVudGFsVmFsdWVzLkZpcmUgKz0gd2VpZ2h0OyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ1dhdGVyJzogZWxlbWVudGFsVmFsdWVzLldhdGVyICs9IHdlaWdodDsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdFYXJ0aCc6IGVsZW1lbnRhbFZhbHVlcy5FYXJ0aCArPSB3ZWlnaHQ7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnQWlyJzogZWxlbWVudGFsVmFsdWVzLkFpciArPSB3ZWlnaHQ7IGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiW0VsZW1lbnRhbENhbGN1bGF0b3JdIEVycm9yIHByb2Nlc3NpbmcgYXNjZW5kYW50IGRhdGE6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBlbGVtZW50YWwgYXNzb2NpYXRpb24gb2YgYSB6b2RpYWMgc2lnblxuICAgKi9cbiAgcHJpdmF0ZSBnZXRTaWduRWxlbWVudChzaWduOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBjb25zdCBsb3dlclNpZ24gPSBzaWduLnRvTG93ZXJDYXNlKCk7XG4gICAgXG4gICAgLy8gRmlyZSBzaWduc1xuICAgIGlmIChsb3dlclNpZ24uaW5jbHVkZXMoJ2FyaWVzJykgfHwgbG93ZXJTaWduLmluY2x1ZGVzKCdsZW8nKSB8fCBsb3dlclNpZ24uaW5jbHVkZXMoJ3NhZ2l0dGFyaXVzJykpIHtcbiAgICAgIHJldHVybiAnRmlyZSc7XG4gICAgfVxuICAgIFxuICAgIC8vIFdhdGVyIHNpZ25zXG4gICAgaWYgKGxvd2VyU2lnbi5pbmNsdWRlcygnY2FuY2VyJykgfHwgbG93ZXJTaWduLmluY2x1ZGVzKCdzY29ycGlvJykgfHwgbG93ZXJTaWduLmluY2x1ZGVzKCdwaXNjZXMnKSkge1xuICAgICAgcmV0dXJuICdXYXRlcic7XG4gICAgfVxuICAgIFxuICAgIC8vIEVhcnRoIHNpZ25zXG4gICAgaWYgKGxvd2VyU2lnbi5pbmNsdWRlcygndGF1cnVzJykgfHwgbG93ZXJTaWduLmluY2x1ZGVzKCd2aXJnbycpIHx8IGxvd2VyU2lnbi5pbmNsdWRlcygnY2Fwcmljb3JuJykpIHtcbiAgICAgIHJldHVybiAnRWFydGgnO1xuICAgIH1cbiAgICBcbiAgICAvLyBBaXIgc2lnbnNcbiAgICBpZiAobG93ZXJTaWduLmluY2x1ZGVzKCdnZW1pbmknKSB8fCBsb3dlclNpZ24uaW5jbHVkZXMoJ2xpYnJhJykgfHwgbG93ZXJTaWduLmluY2x1ZGVzKCdhcXVhcml1cycpKSB7XG4gICAgICByZXR1cm4gJ0Fpcic7XG4gICAgfVxuICAgIFxuICAgIGNvbnNvbGUud2FybihgW0VsZW1lbnRhbENhbGN1bGF0b3JdIFVua25vd24gc2lnbjogJHtzaWdufWApO1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIFxuICAvKipcbiAgICogR2V0IHRoZSB3ZWlnaHQgb2YgcGxhbmV0YXJ5IGluZmx1ZW5jZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRQbGFuZXRXZWlnaHQocGxhbmV0OiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGNvbnN0IGxvd2VyUGxhbmV0ID0gcGxhbmV0LnRvTG93ZXJDYXNlKCk7XG4gICAgXG4gICAgLy8gTHVtaW5hcmllcyBoYXZlIHN0cm9uZ2VzdCBpbmZsdWVuY2VcbiAgICBpZiAobG93ZXJQbGFuZXQuaW5jbHVkZXMoJ3N1bicpIHx8IGxvd2VyUGxhbmV0LmluY2x1ZGVzKCdtb29uJykpIHtcbiAgICAgIHJldHVybiAxLjA7XG4gICAgfVxuICAgIFxuICAgIC8vIFBlcnNvbmFsIHBsYW5ldHMgaGF2ZSBzaWduaWZpY2FudCBpbmZsdWVuY2VcbiAgICBpZiAoXG4gICAgICBsb3dlclBsYW5ldC5pbmNsdWRlcygnbWVyY3VyeScpIHx8IFxuICAgICAgbG93ZXJQbGFuZXQuaW5jbHVkZXMoJ3ZlbnVzJykgfHwgXG4gICAgICBsb3dlclBsYW5ldC5pbmNsdWRlcygnbWFycycpXG4gICAgKSB7XG4gICAgICByZXR1cm4gMC44O1xuICAgIH1cbiAgICBcbiAgICAvLyBTb2NpYWwgcGxhbmV0cyBoYXZlIG1vZGVyYXRlIGluZmx1ZW5jZVxuICAgIGlmIChsb3dlclBsYW5ldC5pbmNsdWRlcygnanVwaXRlcicpIHx8IGxvd2VyUGxhbmV0LmluY2x1ZGVzKCdzYXR1cm4nKSkge1xuICAgICAgcmV0dXJuIDAuNjtcbiAgICB9XG4gICAgXG4gICAgLy8gT3V0ZXIgcGxhbmV0cyBoYXZlIHN1YnRsZSBpbmZsdWVuY2VcbiAgICBpZiAoXG4gICAgICBsb3dlclBsYW5ldC5pbmNsdWRlcygndXJhbnVzJykgfHwgXG4gICAgICBsb3dlclBsYW5ldC5pbmNsdWRlcygnbmVwdHVuZScpIHx8IFxuICAgICAgbG93ZXJQbGFuZXQuaW5jbHVkZXMoJ3BsdXRvJylcbiAgICApIHtcbiAgICAgIHJldHVybiAwLjQ7XG4gICAgfVxuICAgIFxuICAgIC8vIERlZmF1bHQgd2VpZ2h0IGZvciB1bmtub3duIHBsYW5ldHNcbiAgICByZXR1cm4gMC4zO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgdmFsaWRhdGVFbGVtZW50YWxQcm9wZXJ0aWVzKFxuICAgIHByb3BlcnRpZXM6IEVsZW1lbnRhbFByb3BlcnRpZXNcbiAgKTogYm9vbGVhbiB7XG4gICAgaWYgKCFwcm9wZXJ0aWVzKSByZXR1cm4gZmFsc2U7XG5cbiAgICBjb25zdCByZXF1aXJlZEVsZW1lbnRzID0gWydGaXJlJywgJ1dhdGVyJywgJ0VhcnRoJywgJ0FpciddO1xuICAgIGNvbnN0IGhhc0FsbEVsZW1lbnRzID0gcmVxdWlyZWRFbGVtZW50cy5ldmVyeShcbiAgICAgIChlbGVtZW50KSA9PlxuICAgICAgICB0eXBlb2YgcHJvcGVydGllc1tlbGVtZW50IGFzIGtleW9mIEVsZW1lbnRhbFByb3BlcnRpZXNdID09PSAnbnVtYmVyJ1xuICAgICk7XG5cbiAgICBpZiAoIWhhc0FsbEVsZW1lbnRzKSByZXR1cm4gZmFsc2U7XG5cbiAgICBjb25zdCBzdW0gPSBPYmplY3QudmFsdWVzKHByb3BlcnRpZXMpLnJlZHVjZSgoYWNjLCB2YWwpID0+IGFjYyArIHZhbCwgMCk7XG4gICAgcmV0dXJuIE1hdGguYWJzKHN1bSAtIDEpIDwgMC4wMTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY2FsY3VsYXRlSW5ncmVkaWVudE1hdGNoKGluZ3JlZGllbnQ6IHVua25vd24pOiBudW1iZXIge1xuICAgIC8vIEFwcGx5IHN1cmdpY2FsIHR5cGUgY2FzdGluZyB3aXRoIHZhcmlhYmxlIGV4dHJhY3Rpb25cbiAgICBjb25zdCBpbmdyZWRpZW50RGF0YSA9IGluZ3JlZGllbnQgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgY29uc3QgZWxlbWVudGFsUHJvcGVydGllcyA9IGluZ3JlZGllbnREYXRhPy5lbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgIFxuICAgIC8vIElmIHRoZSBpbmdyZWRpZW50IGhhcyBlbGVtZW50YWxQcm9wZXJ0aWVzLCB1c2UgdGhvc2VcbiAgICBpZiAoZWxlbWVudGFsUHJvcGVydGllcykge1xuICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gdGhpcy5nZXRDdXJyZW50RWxlbWVudGFsU3RhdGUoKTtcblxuICAgICAgLy8gQ2FsY3VsYXRlIHNpbWlsYXJpdHkgYmV0d2VlbiBpbmdyZWRpZW50J3MgZWxlbWVudGFsIHByb3BlcnRpZXMgYW5kIGN1cnJlbnQgc3RhdGVcbiAgICAgIGxldCBtYXRjaFNjb3JlID0gMDtcbiAgICAgIGxldCB0b3RhbFdlaWdodCA9IDA7XG5cbiAgICAgIE9iamVjdC5lbnRyaWVzKGN1cnJlbnRTdGF0ZSkuZm9yRWFjaCgoW2VsZW1lbnQsIHZhbHVlXSkgPT4ge1xuICAgICAgICBjb25zdCBlbGVtZW50S2V5ID0gZWxlbWVudCBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgICAgICBjb25zdCBpbmdyZWRpZW50VmFsdWUgPSBlbGVtZW50YWxQcm9wZXJ0aWVzW2VsZW1lbnRLZXldIHx8IDA7XG5cbiAgICAgICAgLy8gQ2FsY3VsYXRlIHdlaWdodGVkIGRpZmZlcmVuY2UgKG1vcmUgaW1wb3J0YW50IGVsZW1lbnRzIGdldCBoaWdoZXIgd2VpZ2h0KVxuICAgICAgICBjb25zdCB3ZWlnaHQgPSB2YWx1ZSAqIDI7IC8vIEVtcGhhc2l6ZSBlbGVtZW50cyB0aGF0IGFyZSBzdHJvbmcgaW4gY3VycmVudCBzdGF0ZVxuICAgICAgICBtYXRjaFNjb3JlICs9ICgxIC0gTWF0aC5hYnModmFsdWUgLSBpbmdyZWRpZW50VmFsdWUpKSAqIHdlaWdodDtcbiAgICAgICAgdG90YWxXZWlnaHQgKz0gd2VpZ2h0O1xuICAgICAgfSk7XG5cbiAgICAgIC8vIE5vcm1hbGl6ZSBzY29yZSB0byAwLTEwMCByYW5nZVxuICAgICAgcmV0dXJuIHRvdGFsV2VpZ2h0ID4gMCA/IChtYXRjaFNjb3JlIC90b3RhbFdlaWdodCkgKiAxMDAgOiA1MDtcbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IHNjb3JlIGlmIG5vIGVsZW1lbnRhbCBwcm9wZXJ0aWVzXG4gICAgcmV0dXJuIDUwO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjYWxjdWxhdGVFbGVtZW50YWxCYWxhbmNlKFxuICAgIGVsZW1lbnRhbFByb3BlcnRpZXM6IEVsZW1lbnRhbFByb3BlcnRpZXNcbiAgKTogbnVtYmVyIHtcbiAgICAvLyBVc2UgYWN0dWFsIGN1cnJlbnQgZWxlbWVudGFsIHN0YXRlIGZvciBjb21wYXJpc29uXG4gICAgY29uc3QgY3VycmVudFN0YXRlID0gdGhpcy5nZXRDdXJyZW50RWxlbWVudGFsU3RhdGUoKTtcblxuICAgIC8vIENhbGN1bGF0ZSBzaW1pbGFyaXR5IGJldHdlZW4gaW5ncmVkaWVudCBhbmQgY3VycmVudCBzdGF0ZVxuICAgIGxldCB0b3RhbFNpbWlsYXJpdHkgPSAwO1xuICAgIGxldCBjb3VudCA9IDA7XG5cbiAgICAvLyBVc2UgYWxsIGZvdXIgZWxlbWVudHMgZm9yIGNhbGN1bGF0aW9uXG4gICAgWydGaXJlJywgJ1dhdGVyJywgJ0VhcnRoJywgJ0FpciddLmZvckVhY2goKGVsZW1lbnQpID0+IHtcbiAgICAgIGNvbnN0IGVsZW1lbnRLZXkgPSBlbGVtZW50IGFzIGtleW9mIEVsZW1lbnRhbFByb3BlcnRpZXM7XG4gICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSBjdXJyZW50U3RhdGVbZWxlbWVudEtleV0gfHwgMDtcbiAgICAgIGNvbnN0IGluZ3JlZGllbnRWYWx1ZSA9IGVsZW1lbnRhbFByb3BlcnRpZXNbZWxlbWVudEtleV0gfHwgMDtcblxuICAgICAgLy8gQ2FsY3VsYXRlIHNpbWlsYXJpdHkgKDEgLSBkaWZmZXJlbmNlKVxuICAgICAgY29uc3Qgc2ltaWxhcml0eSA9IDEgLSBNYXRoLmFicyhjdXJyZW50VmFsdWUgLSBpbmdyZWRpZW50VmFsdWUpO1xuICAgICAgdG90YWxTaW1pbGFyaXR5ICs9IHNpbWlsYXJpdHk7XG4gICAgICBjb3VudCsrO1xuICAgIH0pO1xuXG4gICAgLy8gUmV0dXJuIGF2ZXJhZ2Ugc2ltaWxhcml0eSBhcyBwZXJjZW50YWdlXG4gICAgcmV0dXJuIGNvdW50ID4gMCA/ICh0b3RhbFNpbWlsYXJpdHkgL2NvdW50KSAqIDEwMCA6IDUwO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVFbGVtZW50YWxUb3RhbHMoXG4gICAgcHJvcGVydGllczogRWxlbWVudGFsUHJvcGVydGllc1xuICApOiBFbGVtZW50YWxTdW1tYXJ5IHtcbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxGaXJlOiBwcm9wZXJ0aWVzLkZpcmUsXG4gICAgICB0b3RhbFdhdGVyOiBwcm9wZXJ0aWVzLldhdGVyLFxuICAgICAgdG90YWxFYXJ0aDogcHJvcGVydGllcy5FYXJ0aCxcbiAgICAgIHRvdGFsQWlyOiBwcm9wZXJ0aWVzLkFpcixcbiAgICAgIGRvbWluYW50RWxlbWVudDogdGhpcy5nZXREb21pbmFudEVsZW1lbnQocHJvcGVydGllcyksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldFNlYXNvbkZyb21ab2RpYWNTaWduKHNpZ246IFpvZGlhY1NpZ24pOiBTZWFzb24ge1xuICAgIC8vIE1hcCB6b2RpYWMgc2lnbnMgdG8gc2Vhc29uc1xuICAgIGNvbnN0IHpvZGlhY1NlYXNvbnM6IFJlY29yZDxab2RpYWNTaWduLCBTZWFzb24+ID0ge1xuICAgICAgYXJpZXM6ICdzcHJpbmcnLFxuICAgICAgdGF1cnVzOiAnc3ByaW5nJyxcbiAgICAgIGdlbWluaTogJ3NwcmluZycsXG4gICAgICBjYW5jZXI6ICdzdW1tZXInLFxuICAgICAgbGVvOiAnc3VtbWVyJyxcbiAgICAgIHZpcmdvOiAnc3VtbWVyJyxcbiAgICAgIGxpYnJhOiAnYXV0dW1uJyxcbiAgICAgIHNjb3JwaW86ICdhdXR1bW4nLFxuICAgICAgc2FnaXR0YXJpdXM6ICdhdXR1bW4nLFxuICAgICAgY2Fwcmljb3JuOiAnd2ludGVyJyxcbiAgICAgIGFxdWFyaXVzOiAnd2ludGVyJyxcbiAgICAgIHBpc2NlczogJ3dpbnRlcicsXG4gICAgfTtcblxuICAgIHJldHVybiB6b2RpYWNTZWFzb25zW3NpZ25dIHx8ICdhbGwnO1xuICB9XG5cbiAgLy8gTWV0aG9kIHRvIGdldCBzZWFzb25hbCBtb2RpZmllcnMgYmFzZWQgb24gem9kaWFjIHNpZ25cbiAgcHVibGljIHN0YXRpYyBnZXRab2RpYWNTZWFzb25hbE1vZGlmaWVycyhcbiAgICBzaWduOiBab2RpYWNTaWduXG4gICk6IEVsZW1lbnRhbFByb3BlcnRpZXMge1xuICAgIGNvbnN0IHNlYXNvbiA9IHRoaXMuZ2V0U2Vhc29uRnJvbVpvZGlhY1NpZ24oc2lnbik7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2Vhc29uYWxNb2RpZmllcnMoc2Vhc29uKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0Wm9kaWFjRWxlbWVudGFsSW5mbHVlbmNlKFxuICAgIHNpZ246IFpvZGlhY1NpZ25cbiAgKTogRWxlbWVudGFsUHJvcGVydGllcyB7XG4gICAgLy8gQmFzZSBzZWFzb25hbCBpbmZsdWVuY2VcbiAgICBjb25zdCBzZWFzb25hbE1vZGlmaWVycyA9IHRoaXMuZ2V0Wm9kaWFjU2Vhc29uYWxNb2RpZmllcnMoc2lnbik7XG5cbiAgICAvLyBTcGVjaWZpYyB6b2RpYWMgc2lnbiBhZGp1c3RtZW50c1xuICAgIGNvbnN0IHpvZGlhY01vZGlmaWVyczogUmVjb3JkPFpvZGlhY1NpZ24sIFBhcnRpYWw8RWxlbWVudGFsUHJvcGVydGllcz4+ID0ge1xuICAgICAgYXJpZXM6IHsgRmlyZTogMC4yIH0sIC8vIEV4dHJhIEZpcmUgYm9vc3QgZm9yIGFyaWVzXG4gICAgICB0YXVydXM6IHsgRWFydGg6IDAuMiB9LCAvLyBFeHRyYSBFYXJ0aCBib29zdCBmb3IgdGF1cnVzXG4gICAgICBnZW1pbmk6IHsgQWlyOiAwLjIgfSwgLy8gRXh0cmEgQWlyIGJvb3N0IGZvciBnZW1pbmlcbiAgICAgIGNhbmNlcjogeyBXYXRlcjogMC4yIH0sIC8vIEV4dHJhIFdhdGVyIGJvb3N0IGZvciBjYW5jZXJcbiAgICAgIGxlbzogeyBGaXJlOiAwLjIgfSwgLy8gRXh0cmEgRmlyZSBib29zdCBmb3IgbGVvXG4gICAgICB2aXJnbzogeyBFYXJ0aDogMC4yIH0sIC8vIEV4dHJhIEVhcnRoIGJvb3N0IGZvciB2aXJnb1xuICAgICAgbGlicmE6IHsgQWlyOiAwLjIgfSwgLy8gRXh0cmEgQWlyIGJvb3N0IGZvciBMaWJyYVxuICAgICAgc2NvcnBpbzogeyBXYXRlcjogMC4yIH0sIC8vIEV4dHJhIFdhdGVyIGJvb3N0IGZvciBTY29ycGlvXG4gICAgICBzYWdpdHRhcml1czogeyBGaXJlOiAwLjIgfSwgLy8gRXh0cmEgRmlyZSBib29zdCBmb3Igc2FnaXR0YXJpdXNcbiAgICAgIGNhcHJpY29ybjogeyBFYXJ0aDogMC4yIH0sIC8vIEV4dHJhIEVhcnRoIGJvb3N0IGZvciBjYXByaWNvcm5cbiAgICAgIGFxdWFyaXVzOiB7IEFpcjogMC4yIH0sIC8vIEV4dHJhIEFpciBib29zdCBmb3IgYXF1YXJpdXNcbiAgICAgIHBpc2NlczogeyBXYXRlcjogMC4yIH0sIC8vIEV4dHJhIFdhdGVyIGJvb3N0IGZvciBwaXNjZXNcbiAgICB9O1xuXG4gICAgLy8gQXBwbHkgc3BlY2lmaWMgem9kaWFjIGFkanVzdG1lbnRzXG4gICAgY29uc3Qgc3BlY2lmaWNBZGp1c3RtZW50cyA9IHpvZGlhY01vZGlmaWVyc1tzaWduXSB8fCB7fTtcblxuICAgIC8vIENvbWJpbmUgc2Vhc29uYWwgbW9kaWZpZXJzIHdpdGggc3BlY2lmaWMgem9kaWFjIGFkanVzdG1lbnRzXG4gICAgY29uc3QgcmVzdWx0ID0geyAuLi5zZWFzb25hbE1vZGlmaWVycyB9O1xuICAgIE9iamVjdC5lbnRyaWVzKHNwZWNpZmljQWRqdXN0bWVudHMpLmZvckVhY2goKFtlbGVtZW50LCB2YWx1ZV0pID0+IHtcbiAgICAgIC8vIFVzZSBudWxsaXNoIGNvYWxlc2NpbmcgdG8gZW5zdXJlIHZhbHVlIGlzIG5ldmVyIHVuZGVmaW5lZFxuICAgICAgcmVzdWx0W2VsZW1lbnQgYXMga2V5b2YgRWxlbWVudGFsUHJvcGVydGllc10gKz0gdmFsdWUgfHwgMDtcbiAgICB9KTtcblxuICAgIC8vIE5vcm1hbGl6ZSB0byBlbnN1cmUgdmFsdWVzIHN0YXkgaW4gdmFsaWQgcmFuZ2VcbiAgICByZXR1cm4gbm9ybWFsaXplUHJvcGVydGllcyhyZXN1bHQpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjb21iaW5lRWxlbWVudGFsUHJvcGVydGllcyhcbiAgICBwcm9wZXJ0aWVzOiBFbGVtZW50YWxQcm9wZXJ0aWVzW11cbiAgKTogRWxlbWVudGFsUHJvcGVydGllcyB7XG4gICAgY29uc3QgcmVzdWx0OiBFbGVtZW50YWxQcm9wZXJ0aWVzID0ge1xuICAgICAgRmlyZTogMCxcbiAgICAgIFdhdGVyOiAwLFxuICAgICAgRWFydGg6IDAsXG4gICAgICBBaXI6IDAsXG4gICAgfTtcblxuICAgIGlmIChwcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgRmlyZTogMC4yNSxcbiAgICAgICAgV2F0ZXI6IDAuMjUsXG4gICAgICAgIEVhcnRoOiAwLjI1LFxuICAgICAgICBBaXI6IDAuMjUsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFN1bSB1cCBhbGwgcHJvcGVydGllc1xuICAgIHByb3BlcnRpZXMuZm9yRWFjaCgocHJvcCkgPT4ge1xuICAgICAgT2JqZWN0LmVudHJpZXMocHJvcCkuZm9yRWFjaCgoW2VsZW1lbnQsIHZhbHVlXSkgPT4ge1xuICAgICAgICAvLyBVc2UgbnVsbGlzaCBjb2FsZXNjaW5nIHRvIGhhbmRsZSB1bmRlZmluZWQgdmFsdWVzXG4gICAgICAgIGNvbnN0IGVsZW1lbnRLZXkgPSBlbGVtZW50IGFzIGtleW9mIEVsZW1lbnRhbFByb3BlcnRpZXM7XG4gICAgICAgIHJlc3VsdFtlbGVtZW50S2V5XSArPSB2YWx1ZSB8fCAwO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBOb3JtYWxpemUgdG8gZW5zdXJlIHRoZXkgc3VtIHRvIDFcbiAgICBjb25zdCB0b3RhbCA9IE9iamVjdC52YWx1ZXMocmVzdWx0KS5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyB2YWwsIDApO1xuICAgIGlmICh0b3RhbCA+IDApIHtcbiAgICAgIE9iamVjdC5rZXlzKHJlc3VsdCkuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgICAgICBjb25zdCBlbGVtZW50S2V5ID0gZWxlbWVudCBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgICAgICByZXN1bHRbZWxlbWVudEtleV0gPSByZXN1bHRbZWxlbWVudEtleV0gL3RvdGFsO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIERlZmF1bHQgdG8gZXF1YWwgZGlzdHJpYnV0aW9uIGlmIHRvdGFsIGlzIDBcbiAgICAgIE9iamVjdC5rZXlzKHJlc3VsdCkuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgICAgICBjb25zdCBlbGVtZW50S2V5ID0gZWxlbWVudCBhcyBrZXlvZiBFbGVtZW50YWxQcm9wZXJ0aWVzO1xuICAgICAgICByZXN1bHRbZWxlbWVudEtleV0gPSAwLjI1O1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RG9taW5hbnRFbGVtZW50KFxuICAgIGVsZW1lbnRhbFByb3BlcnRpZXM6IEVsZW1lbnRhbFByb3BlcnRpZXNcbiAgKToga2V5b2YgRWxlbWVudGFsUHJvcGVydGllcyB7XG4gICAgbGV0IG1heEVsZW1lbnQ6IGtleW9mIEVsZW1lbnRhbFByb3BlcnRpZXMgPSAnRmlyZSc7XG4gICAgbGV0IG1heFZhbHVlID0gZWxlbWVudGFsUHJvcGVydGllcy5GaXJlO1xuXG4gICAgLy8gQ2hlY2sgZWFjaCBlbGVtZW50IHRvIGZpbmQgdGhlIG9uZSB3aXRoIHRoZSBoaWdoZXN0IHZhbHVlXG4gICAgT2JqZWN0LmVudHJpZXMoZWxlbWVudGFsUHJvcGVydGllcykuZm9yRWFjaCgoW2VsZW1lbnQsIHZhbHVlXSkgPT4ge1xuICAgICAgY29uc3QgZWxlbWVudEtleSA9IGVsZW1lbnQgYXMga2V5b2YgRWxlbWVudGFsUHJvcGVydGllcztcbiAgICAgIGlmICh2YWx1ZSA+IG1heFZhbHVlKSB7XG4gICAgICAgIG1heFZhbHVlID0gdmFsdWU7XG4gICAgICAgIG1heEVsZW1lbnQgPSBlbGVtZW50S2V5O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1heEVsZW1lbnQ7XG4gIH1cblxuICAvLyBNZXRob2QgdG8gcHJvY2VzcyBwbGFuZXQgb2JqZWN0IGFuZCBleHRyYWN0IGVsZW1lbnRhbCBwcm9wZXJ0aWVzXG4gIHByb2Nlc3NQbGFuZXRFbGVtZW50YWxFZmZlY3QocGxhbmV0OiBQbGFuZXQsIHNpZ246IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICAgIGlmICghcGxhbmV0IHx8ICFzaWduKSB7XG4gICAgICByZXR1cm4geyBGaXJlOiAwLCBXYXRlcjogMCwgRWFydGg6IDAsIEFpcjogMCB9O1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBlbGVtZW50YWxFZmZlY3Q6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7IEZpcmU6IDAsIFdhdGVyOiAwLCBFYXJ0aDogMCwgQWlyOiAwIH07XG4gICAgXG4gICAgLy8gUHJvY2VzcyBkaWduaXR5IGVmZmVjdFxuICAgIGNvbnN0IHBsYW5ldFN0ciA9IFN0cmluZyhwbGFuZXQpO1xuICAgIGNvbnN0IHBsYW5ldEluZm9EYXRhID0gcGxhbmV0SW5mb1twbGFuZXRTdHJdIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgIGNvbnN0IGRpZ25pdHlFZmZlY3REYXRhID0gcGxhbmV0SW5mb0RhdGE/LltcIkRpZ25pdHkgRWZmZWN0XCJdIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgIGlmIChkaWduaXR5RWZmZWN0RGF0YT8uW3NpZ25dKSB7XG4gICAgICBjb25zdCBkaWduaXR5RWZmZWN0VmFsdWUgPSBOdW1iZXIoZGlnbml0eUVmZmVjdERhdGFbc2lnbl0pO1xuICAgICAgaWYgKGRpZ25pdHlFZmZlY3RWYWx1ZSkge1xuICAgICAgICBpZiAoTWF0aC5hYnMoZGlnbml0eUVmZmVjdFZhbHVlKSA9PT0gMSB8fCBNYXRoLmFicyhkaWduaXR5RWZmZWN0VmFsdWUpID09PSAzKSB7XG4gICAgICAgICAgY29uc3Qgc2lnbkVsZW1lbnQgPSBzaWduSW5mb1tzaWduXT8uRWxlbWVudCB8fCAnRmlyZSc7XG4gICAgICAgICAgZWxlbWVudGFsRWZmZWN0W3NpZ25FbGVtZW50XSA9IDEgKiAoZGlnbml0eUVmZmVjdFZhbHVlIC8gTWF0aC5hYnMoZGlnbml0eUVmZmVjdFZhbHVlKSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChNYXRoLmFicyhkaWduaXR5RWZmZWN0VmFsdWUpID4gMSkge1xuICAgICAgICAgIGNvbnN0IGRpdXJuYWxFbGVtZW50ID0gU3RyaW5nKHBsYW5ldEluZm9EYXRhPy5bJ0RpdXJuYWwgRWxlbWVudCddKSB8fCAnRmlyZSc7XG4gICAgICAgICAgY29uc3Qgbm9jdHVybmFsRWxlbWVudCA9IFN0cmluZyhwbGFuZXRJbmZvRGF0YT8uWydOb2N0dXJuYWwgRWxlbWVudCddKSB8fCAnRmlyZSc7XG4gICAgICAgICAgXG4gICAgICAgICAgZWxlbWVudGFsRWZmZWN0W2RpdXJuYWxFbGVtZW50XSArPSAoMSAqIChkaWduaXR5RWZmZWN0VmFsdWUgLyAoTWF0aC5hYnMoZGlnbml0eUVmZmVjdFZhbHVlIHx8IDEpKSkpO1xuICAgICAgICAgIGVsZW1lbnRhbEVmZmVjdFtub2N0dXJuYWxFbGVtZW50XSArPSAoMSAqIChkaWduaXR5RWZmZWN0VmFsdWUgLyBNYXRoLmFicyhkaWduaXR5RWZmZWN0VmFsdWUpKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGVsZW1lbnRhbEVmZmVjdDtcbiAgfVxuXG4gIC8vIE1ldGhvZCB0byBwcm9jZXNzIGNlbGVzdGlhbCBib2RpZXMgZGF0YVxuICBwcm9jZXNzQ2VsZXN0aWFsQm9kaWVzRGF0YShjZWxlc3RpYWxEYXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICAgIGlmICghY2VsZXN0aWFsRGF0YSkge1xuICAgICAgcmV0dXJuIHsgRmlyZTogMCwgV2F0ZXI6IDAsIEVhcnRoOiAwLCBBaXI6IDAgfTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgdG90YWxFbGVtZW50YWxFZmZlY3Q6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7IEZpcmU6IDAsIFdhdGVyOiAwLCBFYXJ0aDogMCwgQWlyOiAwIH07XG4gICAgXG4gICAgLy8gUHJvY2VzcyBlYWNoIHBsYW5ldFxuICAgIGZvciAoY29uc3QgcGxhbmV0S2V5IG9mIE9iamVjdC5rZXlzKHBsYW5ldEluZm8pKSB7XG4gICAgICBpZiAoY2VsZXN0aWFsRGF0YVtwbGFuZXRLZXkudG9Mb3dlckNhc2UoKV0pIHtcbiAgICAgICAgY29uc3QgcGxhbmV0ID0gcGxhbmV0S2V5O1xuICAgICAgICBjb25zdCBwbGFuZXREYXRhID0gY2VsZXN0aWFsRGF0YVtwbGFuZXRLZXkudG9Mb3dlckNhc2UoKV0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICAgIGNvbnN0IHNpZ25EYXRhID0gcGxhbmV0RGF0YT8uU2lnbiBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgY29uc3Qgc2lnbiA9IFN0cmluZyhzaWduRGF0YT8ubGFiZWwgfHwgJycpO1xuICAgICAgICBcbiAgICAgICAgaWYgKHNpZ24pIHtcbiAgICAgICAgICBjb25zdCBwbGFuZXRFZmZlY3QgPSB0aGlzLnByb2Nlc3NQbGFuZXRFbGVtZW50YWxFZmZlY3QoKHBsYW5ldCBhcyB1bmtub3duKSBhcyBQbGFuZXQsIHNpZ24pO1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIENvbWJpbmUgZWZmZWN0c1xuICAgICAgICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBPYmplY3Qua2V5cyh0b3RhbEVsZW1lbnRhbEVmZmVjdCkpIHtcbiAgICAgICAgICAgIHRvdGFsRWxlbWVudGFsRWZmZWN0W2VsZW1lbnRdICs9IHBsYW5ldEVmZmVjdFtlbGVtZW50XSB8fCAwO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdG90YWxFbGVtZW50YWxFZmZlY3Q7XG4gIH1cblxuICAvLyBQcm9jZXNzIHBsYW5ldCBrZXlzIHRvIGdldCBlbGVtZW50IGVmZmVjdHNcbiAgcHJvY2Vzc1BsYW5ldEtleXNEYXRhKHBsYW5ldHM6IFBsYW5ldCk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICAgIGlmICghcGxhbmV0cykge1xuICAgICAgcmV0dXJuIHsgRmlyZTogMCwgV2F0ZXI6IDAsIEVhcnRoOiAwLCBBaXI6IDAgfTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgZWxlbWVudGFsRWZmZWN0OiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0geyBGaXJlOiAwLCBXYXRlcjogMCwgRWFydGg6IDAsIEFpcjogMCB9O1xuICAgIFxuICAgIC8vIEV4dHJhY3QgYWxsIHBsYW5ldCBrZXlzXG4gICAgY29uc3QgcGxhbmV0S2V5cyA9IE9iamVjdC5rZXlzKHBsYW5ldHMpLmZpbHRlcihrZXkgPT4gXG4gICAgICB0eXBlb2YgcGxhbmV0c1trZXldID09PSAnb2JqZWN0JyAmJiBwbGFuZXRzW2tleV0gIT09IG51bGwgJiYgXG4gICAgICAocGxhbmV0SW5mbyAmJiBwbGFuZXRJbmZvW2tleV0gfHwgZmFsc2UpXG4gICAgKTtcbiAgICBcbiAgICAvLyBQcm9jZXNzIGVhY2ggcGxhbmV0XG4gICAgZm9yIChjb25zdCBwbGFuZXQgb2YgcGxhbmV0S2V5cykge1xuICAgICAgaWYgKHBsYW5ldHNbcGxhbmV0XT8uU2lnbikge1xuICAgICAgICBjb25zdCBzaWduID0gcGxhbmV0c1twbGFuZXRdLlNpZ247XG4gICAgICAgIGNvbnN0IHBsYW5ldEVmZmVjdCA9IHRoaXMucHJvY2Vzc1BsYW5ldEVsZW1lbnRhbEVmZmVjdCgocGxhbmV0IGFzIHVua25vd24pIGFzIFBsYW5ldCwgc2lnbik7XG4gICAgICAgIFxuICAgICAgICAvLyBDb21iaW5lIGVmZmVjdHNcbiAgICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIE9iamVjdC5rZXlzKGVsZW1lbnRhbEVmZmVjdCkpIHtcbiAgICAgICAgICBlbGVtZW50YWxFZmZlY3RbZWxlbWVudF0gKz0gcGxhbmV0RWZmZWN0W2VsZW1lbnRdIHx8IDA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGVsZW1lbnRhbEVmZmVjdDtcbiAgfVxuXG4gIC8vIEdldCBkb21pbmFudCBlbGVtZW50IGZyb20gZWxlbWVudGFsIGVmZmVjdHNcbiAgZ2V0RG9taW5hbnRFbGVtZW50RnJvbUVmZmVjdHMoZWxlbWVudGFsRWZmZWN0czogUmVjb3JkPHN0cmluZywgbnVtYmVyPik6IHN0cmluZyB7XG4gICAgaWYgKCFlbGVtZW50YWxFZmZlY3RzKSB7XG4gICAgICByZXR1cm4gJ0ZpcmUnO1xuICAgIH1cbiAgICBcbiAgICBsZXQgZG9taW5hbnRFbGVtZW50ID0gJ0ZpcmUnO1xuICAgIGxldCBoaWdoZXN0VmFsdWUgPSAtSW5maW5pdHk7XG4gICAgXG4gICAgZm9yIChjb25zdCBbZWxlbWVudCwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGVsZW1lbnRhbEVmZmVjdHMpKSB7XG4gICAgICBpZiAodmFsdWUgPiBoaWdoZXN0VmFsdWUpIHtcbiAgICAgICAgaGlnaGVzdFZhbHVlID0gdmFsdWU7XG4gICAgICAgIGRvbWluYW50RWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBkb21pbmFudEVsZW1lbnQ7XG4gIH1cblxuICAvLyBOb3JtYWxpemUgZWxlbWVudGFsIHZhbHVlcyB0byBlbnN1cmUgdGhleSBzdW0gdG8gMS4wXG4gIG5vcm1hbGl6ZUVsZW1lbnRhbFZhbHVlcyhlbGVtZW50YWxFZmZlY3RzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiB7XG4gICAgaWYgKCFlbGVtZW50YWxFZmZlY3RzKSB7XG4gICAgICByZXR1cm4geyBGaXJlOiAwLjI1LCBXYXRlcjogMC4yNSwgRWFydGg6IDAuMjUsIEFpcjogMC4yNSB9O1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBzdW0gPSBPYmplY3QudmFsdWVzKGVsZW1lbnRhbEVmZmVjdHMpLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICAgIFxuICAgIC8vIElmIHN1bSBpcyB6ZXJvIG9yIHZlcnkgc21hbGwsIHJldHVybiBlcXVhbCBkaXN0cmlidXRpb25cbiAgICBpZiAoTWF0aC5hYnMoc3VtKSA8IDAuMDAxKSB7XG4gICAgICByZXR1cm4geyBGaXJlOiAwLjI1LCBXYXRlcjogMC4yNSwgRWFydGg6IDAuMjUsIEFpcjogMC4yNSB9O1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBub3JtYWxpemVkOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG4gICAgXG4gICAgZm9yIChjb25zdCBlbGVtZW50IG9mIE9iamVjdC5rZXlzKGVsZW1lbnRhbEVmZmVjdHMpKSB7XG4gICAgICBub3JtYWxpemVkW2VsZW1lbnRdID0gZWxlbWVudGFsRWZmZWN0c1tlbGVtZW50XSAvc3VtO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbm9ybWFsaXplZDtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFbGVtZW50YWxDYWxjdWxhdG9yO1xuIl0sInZlcnNpb24iOjN9