# Test stage - Docker images validation
test:docker:images:
  stage: test
  image: docker:24-cli
  services:
    - docker:24-dind
  needs:
    - build:docker:frontend
    - build:docker:backend
  before_script:
    - echo "üîê Logging into GitLab Container Registry..."
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - echo "üß™ Testing Docker images..."
    - echo "Pulling frontend image: $FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG"
    - docker pull "$FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG"
    - echo "Pulling backend image: $BACKEND_IMAGE:$CI_COMMIT_REF_SLUG"
    - docker pull "$BACKEND_IMAGE:$CI_COMMIT_REF_SLUG"
    - echo "Testing frontend image..."
    - docker run --rm "$FRONTEND_IMAGE:$CI_COMMIT_REF_SLUG" node --version
    - echo "Testing backend image..."
    - docker run --rm "$BACKEND_IMAGE:$CI_COMMIT_REF_SLUG" python --version
    - echo "üìä Image sizes:"
    - docker images | grep "$CI_COMMIT_REF_SLUG"
    - echo "‚úÖ Docker images validated successfully"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - Dockerfile